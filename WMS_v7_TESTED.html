<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WMS å…¨åŠŸèƒ½æ——è‰¦ç‰ˆ (V50.0 Live Preview)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        (function() {
            var w = console.warn;
            console.warn = function() {
                var a = Array.from(arguments);
                if (a[0] && typeof a[0] === 'string' && a[0].indexOf('cdn.tailwindcss.com') > -1) return;
                w.apply(console, a);
            };
        })();
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    
    <style>
        body { font-family: 'Inter', 'Microsoft JhengHei', sans-serif; background-color: #0f172a; color: #cbd5e1; font-size: 13px; user-select: none; }
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 2px; }
        
        /* å°èˆª */
        .nav-item { display: flex; align-items: center; padding: 12px 16px; color: #94a3b8; cursor: pointer; transition: 0.2s; border-left: 3px solid transparent; font-size: 14px; }
        .nav-item:hover { background-color: #1e293b; color: white; }
        .nav-item.active { background-color: #1e293b; color: #38bdf8; border-left-color: #38bdf8; background: linear-gradient(90deg, rgba(56,189,248,0.1) 0%, rgba(30,41,59,0) 100%); font-weight: bold; }
        .nav-group { font-size: 12px; font-weight: bold; color: #64748b; padding: 18px 16px 6px; text-transform: uppercase; letter-spacing: 0.05em; }
        
        .glass-panel { background: #1e293b; border: 1px solid #334155; border-radius: 8px; }
        .scan-input { background: #0f172a; border: 1px solid #475569; color: white; border-radius: 6px; padding: 0 12px; font-family: monospace; width: 100%; transition: 0.3s; height: 36px; font-size: 14px; }
        .scan-input:focus { border-color: #3b82f6; box-shadow: 0 0 0 1px #3b82f6; outline: none; }
        .scan-input[readonly] { background: #1e293b; color: #64748b; cursor: not-allowed; }

        /* Badge */
        .badge { padding: 1px 5px; border-radius: 3px; font-size: 10px; font-weight: bold; display: inline-block; white-space: nowrap; }
        .badge-green { background: rgba(16, 185, 129, 0.2); color: #34d399; border: 1px solid rgba(16, 185, 129, 0.3); }
        .badge-purple { background: rgba(168, 85, 247, 0.2); color: #c084fc; border: 1px solid rgba(168, 85, 247, 0.3); }
        .badge-yellow { background: rgba(234, 179, 8, 0.2); color: #facc15; border: 1px solid rgba(234, 179, 8, 0.3); }
        .badge-orange { background: rgba(249, 115, 22, 0.2); color: #fb923c; border: 1px solid rgba(249, 115, 22, 0.3); }
        .badge-blue { background: rgba(59, 130, 246, 0.2); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.3); }
        .badge-red { background: rgba(239, 68, 68, 0.2); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.3); }

        .dense-table th { position: sticky; top: 0; background: #0f172a; z-index: 10; padding: 8px 12px; border-bottom: 1px solid #334155; text-align: left; font-size: 12px; color: #94a3b8; }
        .dense-table td { padding: 6px 12px; border-bottom: 1px solid #1e293b; white-space: nowrap; font-size: 12px; }
        .dense-table tr:hover { background-color: #334155; cursor: pointer; }

        /* åœ°åœ–æ¨£å¼ */
        .warehouse-container { display: grid; grid-template-columns: 1fr 1fr 600px; gap: 15px; height: 100%; background-color: #0f172a; padding: 15px; overflow: hidden; }
        .warehouse-container-new { display: grid; grid-template-columns: 1fr 1fr 1fr 500px; gap: 12px; height: 100%; background-color: #0f172a; padding: 15px; overflow: hidden; }
        .map-overview-col { overflow-y: auto; overflow-x: visible; display: flex; flex-direction: column; gap: 20px; padding-right: 5px; padding-top: 20px; }
        .warehouse-building { background: #1e293b; border: 2px solid #475569; border-radius: 12px; padding: 35px 15px 15px 15px; position: relative; margin-top: 15px; }
        .zone-header { font-size: 14px; font-weight: 900; color: #fff; background: #3b82f6; padding: 2px 8px; border-radius: 4px 4px 0 0; display: inline-block; margin-bottom: 0; border: 1px solid #60a5fa; }
        .zone-block { margin-bottom: 20px; border: 2px solid #334155; padding: 10px; border-radius: 0 8px 8px 8px; background: rgba(15, 23, 42, 0.5); position: relative; top: -1px; }
        .rack-lanes-grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 6px; }
        .rack-lane { height: 60px; background: #0f172a; border: 1px solid #475569; border-radius: 4px; cursor: pointer; position: relative; transition: all 0.2s; overflow: hidden; display:flex; flex-direction:column; justify-content:flex-end; }
        .rack-lane:hover { border-color: #60a5fa; z-index: 10; transform: scale(1.05); box-shadow: 0 4px 6px rgba(0,0,0,0.5); }
        .rack-lane.active { border-color: #facc15; box-shadow: 0 0 0 2px rgba(250, 204, 21, 0.4); background: #334155; }
        .lane-id-tag { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 16px; font-weight: 900; color: #475569; z-index: 1; pointer-events: none; }
        .rack-lane:hover .lane-id-tag { color: #94a3b8; }
        .lane-fill-bar { position: absolute; bottom: 0; left: 0; right: 0; transition: height 0.3s; opacity: 0.6; z-index: 0; }
        .lane-full-locked { background: repeating-linear-gradient(45deg, #1f2937, #1f2937 10px, #374151 10px, #374151 20px); border-color: #ef4444; opacity: 0.7; cursor: not-allowed !important; }
        .lane-suggest-gold { background: rgba(234, 179, 8, 0.15); border: 2px solid #eab308; box-shadow: 0 0 10px rgba(234, 179, 8, 0.5); animation: pulse-gold 1.5s infinite; }
        @keyframes pulse-gold { 0% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0.4); } 70% { box-shadow: 0 0 0 8px rgba(234, 179, 8, 0); } 100% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0); } }

        /* è©³æƒ…é¢æ¿ */
        .rack-detail-panel { background: #1e293b; border-left: 1px solid #334155; padding: 0; display: flex; flex-direction: column; border-radius: 12px; height: 100%; overflow: hidden; box-shadow: -5px 0 20px rgba(0,0,0,0.5); }
        .levels-container { padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; flex: 1; }
        .level-card { background: #0f172a; border: 1px solid #334155; border-radius: 8px; padding: 10px; }
        .level-header { display: flex; justify-content: space-between; font-size: 12px; color: #cbd5e1; margin-bottom: 8px; font-weight: 800; border-bottom: 1px dashed #334155; padding-bottom: 4px; }
        .level-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }
        
        .pallet-box { width: 100%; height: 60px; border-radius: 4px; display: flex; flex-direction: column; justify-content: space-between; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.4); overflow: hidden; padding: 4px 6px; color: rgba(255,255,255,0.9); border: 1px solid rgba(255,255,255,0.1); transition: 0.2s; }
        .pallet-box:hover { transform: scale(1.05); z-index: 20; border-color: white; }
        .pallet-box .row-1 { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .pallet-box .row-1 .name { font-weight: bold; font-size: 11px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 70%; }
        .pallet-box .row-1 .qty { background: rgba(0,0,0,0.4); padding: 1px 4px; border-radius: 3px; font-size: 10px; font-weight: bold; color: white; }
        .pallet-box .row-2 { font-size: 10px; color: #fde047; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: left; width: 100%; }
        .pallet-box .row-3 { font-size: 9px; color: #cbd5e1; font-family: monospace; text-align: left; width: 100%; opacity: 0.8; }
        .bg-fg { background: linear-gradient(135deg, #7c3aed, #6d28d9); } .bg-raw { background: linear-gradient(135deg, #059669, #047857); } .bg-wip { background: linear-gradient(135deg, #ca8a04, #b45309); color: white; }
        .pallet-empty { background: transparent; border: 2px dashed #334155; color: #475569; display: flex; align-items: center; justify-content: center; font-size: 11px; height: 60px; }

        /* UI Components */
        .tab-btn { padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: bold; color: #64748b; background: #1e293b; border: 1px solid #334155; transition: 0.2s; font-size: 13px; }
        .tab-btn.active { background: #2563eb; color: white; border-color: #3b82f6; }
        .virtual-card { background: #334155; padding: 10px; border-radius: 6px; cursor: pointer; border: 1px solid transparent; text-align: center; }
        .virtual-card:hover { border-color: #38bdf8; background: #475569; }
        .move-box { width: 45%; height: 300px; background: #1e293b; border: 3px dashed #475569; border-radius: 16px; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: 0.3s; }
        .move-box.active { border-color: #38bdf8; background: #0f172a; border-style: solid; box-shadow: 0 0 20px rgba(56, 189, 248, 0.2); }
        .type-radio:checked + div { background-color: #1e40af; border-color: #3b82f6; color: white; }
        .mode-btn { padding: 10px; border-radius: 8px; border: 1px solid #475569; text-align: center; cursor: pointer; transition: 0.2s; color: #94a3b8; background: #1e293b; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 60px; }
        .mode-btn:hover { background: #334155; color: white; }
        .mode-btn.active-raw { background: #064e3b; border-color: #10b981; color: #34d399; font-weight: bold; box-shadow: 0 0 15px rgba(16, 185, 129, 0.4); }
        .mode-btn.active-fg { background: #4c1d95; border-color: #a855f7; color: #d8b4fe; font-weight: bold; box-shadow: 0 0 15px rgba(168, 85, 247, 0.4); }
        .mode-btn.active-wip { background: #451a03; border-color: #eab308; color: #fde047; font-weight: bold; box-shadow: 0 0 15px rgba(234, 179, 8, 0.4); }
        .mode-btn.active-ret { background: #431407; border-color: #fb923c; color: #fdba74; font-weight: bold; box-shadow: 0 0 10px rgba(251, 146, 60, 0.4); }
        .level-btn { width: 100%; padding: 12px; border-radius: 6px; font-weight: bold; text-align: center; transition: 0.2s; border: 1px solid; }
        .level-btn-active { background: #1e40af; border-color: #3b82f6; color: white; cursor: pointer; }
        .level-btn-active:hover { background: #2563eb; }
        .level-btn-full { background: #334155; border-color: #475569; color: #64748b; cursor: not-allowed; position: relative; }
        .level-btn-full::after { content: 'å·²æ»¿'; position: absolute; right: 10px; font-size: 10px; color: #ef4444; }
        .field-group.hidden { display: none; }
        .kpi-card { cursor: pointer; transition: all 0.2s; }
        .kpi-card:hover { transform: translateY(-3px); box-shadow: 0 4px 12px rgba(0,0,0,0.5); border-color: white; }

        /* V50 é è¦½æ¨™ç±¤å°ˆç”¨æ¨£å¼ (æ¨¡æ“¬ç´™å¼µ) */
        .preview-label-card {
            background: white; color: black; padding: 10px; border-radius: 4px; font-family: sans-serif;
            border: 2px solid #ccc; width: 100%; box-shadow: 0 4px 6px rgba(0,0,0,0.3); margin-top: 10px;
        }
        .preview-header { text-align: center; font-weight: 900; border-bottom: 2px solid black; padding-bottom: 5px; margin-bottom: 5px; font-size: 14px; }
        .preview-row { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 4px; border-bottom: 1px dashed #eee; }
        .preview-val { font-weight: bold; }
        .preview-big { font-size: 24px; font-weight: 900; text-align: center; display: block; margin: 10px 0; }

        @media print { body * { visibility: hidden; } #print-area, #print-area * { visibility: visible; } #print-area { position: absolute; left: 0; top: 0; width: 100%; } .print-page { page-break-after: always; width: 100mm; height: 148mm; border: 3px solid black; padding: 15px; margin: 0 auto; color: black !important; background: white !important; display: flex; flex-direction: column; } .print-header { text-align: center; font-size: 24px; font-weight: 900; border-bottom: 2px solid black; padding-bottom: 10px; margin-bottom: 20px; } .print-row { display: flex; justify-content: space-between; margin-bottom: 15px; border-bottom: 1px dashed #ccc; padding-bottom: 5px; } .print-label { font-size: 14px; color: #333; font-weight: bold; } .print-val { font-size: 18px; font-weight: bold; text-align: right; } .print-big { font-size: 32px; font-weight: 900; } .print-footer { margin-top: auto; text-align: center; } }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <div id="view-login" class="fixed inset-0 z-50 bg-slate-900 flex flex-col items-center justify-center p-6">
        <div class="w-full max-w-sm space-y-4 text-center">
            <h1 class="text-3xl font-bold text-white mb-6">Terry <span class="text-blue-500">WMS V50</span></h1>
            <input type="email" id="login-email" value="admin@bafang.com" class="scan-input text-center text-lg" placeholder="Email">
            <input type="password" id="login-pwd" value="123456" class="scan-input text-center text-lg" placeholder="å¯†ç¢¼">
            <button onclick="loginSystem()" id="btn-login" class="w-full py-4 bg-blue-600 hover:bg-blue-500 text-white rounded font-bold shadow-lg text-lg">ç™»å…¥ç³»çµ±</button>
        </div>
    </div>

    <div id="modal-level-select" class="fixed inset-0 z-40 bg-black/80 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-slate-900 border border-slate-700 p-8 rounded-2xl w-96 shadow-2xl">
            <div id="loc-select-physical" class="hidden">
                <h3 class="text-xl font-bold text-white mb-2 text-center">é¸æ“‡å…¥åº«å±¤æ•¸</h3>
                <p class="text-sm text-slate-400 mb-6 text-center font-mono" id="modal-lane-title">I-A ç¬¬ 1 è¡Œ</p>
                <div class="space-y-3">
                    <button id="btn-level-3f" onclick="selectLevel('3F')" class="level-btn">3F (æ¨™æº– 4æ¿)</button>
                    <button id="btn-level-2f" onclick="selectLevel('2F')" class="level-btn">2F (æ¨™æº– 4æ¿)</button>
                    <button id="btn-level-1f" onclick="selectLevel('1F')" class="level-btn level-btn-active relative">1F (æŒ‘é«˜ 12æ¿) <span class="absolute top-2 right-3 text-xs text-yellow-400 bg-yellow-900/50 px-1 rounded">æ•£è²¨</span></button>
                </div>
            </div>
            <div id="loc-select-virtual" class="hidden">
                <h3 class="text-xl font-bold text-white mb-4 text-center">é¸æ“‡è™›æ“¬å€‰åº«</h3>
                <div class="grid grid-cols-2 gap-3 mb-4" id="virtual-grid"></div>
                <div class="border-t border-slate-700 pt-4"><input type="text" id="new-virtual-name" class="scan-input text-sm mb-2" placeholder="æ–°è™›æ“¬åº«åç¨±..."><button onclick="addNewVirtualLoc()" class="w-full py-2 bg-emerald-600 hover:bg-emerald-500 rounded text-white text-sm font-bold">æ–°å¢è‡ªè¨‚åº«</button></div>
            </div>
            <button onclick="closeLocModal()" class="mt-6 w-full text-slate-500 text-sm hover:text-white">å–æ¶ˆ</button>
        </div>
    </div>

    <div id="modal-analytics" class="fixed inset-0 z-40 bg-black/90 hidden flex flex-col p-6 backdrop-blur-sm"><div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold text-white" id="analytics-title">è©³ç´°åˆ†æ</h2><button onclick="closeAnalytics()" class="text-slate-400 hover:text-white"><i class="fa-solid fa-xmark text-2xl"></i></button></div><div class="flex gap-4 mb-4 bg-slate-800 p-4 rounded border border-slate-700"><input type="text" class="scan-input w-48" placeholder="ğŸ” ç”¢å“/æ‰¹è™Ÿ"><input type="text" class="scan-input w-48" placeholder="ğŸ¢ å®¢æˆ¶åç¨±"><input type="text" class="scan-input w-48" placeholder="ğŸš› ç‰©æµå•†"><div class="flex items-center gap-2 text-slate-400 text-sm"><span>å‡ºè²¨æ—¥:</span><input type="date" class="scan-input w-32"><span>è‡³</span><input type="date" class="scan-input w-32"></div><button class="bg-blue-600 hover:bg-blue-500 text-white px-4 rounded font-bold ml-auto">æœå°‹</button></div><div class="flex-1 glass-panel overflow-auto"><table class="w-full dense-table text-left"><thead><tr><th>å–®è™Ÿ</th><th>å“åè¦æ ¼</th><th>æ‰¹è™Ÿ</th><th>æ•¸é‡</th><th>å®¢æˆ¶</th><th>ç‰©æµ</th><th>ç‹€æ…‹</th><th>å‚™è²¨æ—¥</th></tr></thead><tbody id="analytics-tbody"></tbody></table></div></div>

    <aside class="w-60 bg-slate-900 border-r border-slate-800 flex flex-col shrink-0 z-20">
        <div class="h-16 flex items-center px-6 border-b border-slate-800">
            <i class="fa-solid fa-cube text-blue-500 text-2xl mr-3"></i><span class="font-black text-xl text-white tracking-wide">TERRY WMS</span>
        </div>
        <nav class="flex-1 overflow-y-auto py-2">
            <div class="nav-group">æ ¸å¿ƒç›£æ§</div>
            <div class="nav-item active" onclick="switchTab('visual-map', event)"><i class="fa-solid fa-map-location-dot w-5 text-center mr-2"></i> æ•¸ä½å€‰åº«</div>
            <div class="nav-item" onclick="switchTab('dashboard', event)"><i class="fa-solid fa-chart-pie w-5 text-center mr-2"></i> æˆ°æƒ…åˆ†æ</div>

            <div class="nav-group">å…¥åº«èˆ‡ç”Ÿç”¢</div>
            <div class="nav-item" onclick="switchTab('unified-inbound', event)"><i class="fa-solid fa-bolt w-5 text-center mr-2"></i> æ™ºèƒ½å…¥åº«ä¸­å¿ƒ</div>
            <!-- <div class="nav-item" onclick="switchTab('pre-inbound', event)"><i class="fa-solid fa-print w-5 text-center mr-2"></i> é ç´„å…¥åº«/æ¨™ç±¤</div> -->

            <div class="nav-group">åº«å…§ä½œæ¥­</div>
            <div class="nav-item" onclick="switchTab('inventory-query', event)"><i class="fa-solid fa-magnifying-glass w-5 text-center mr-2"></i> åº«å­˜ç¶œåˆæŸ¥è©¢</div>
            <div class="nav-item" onclick="switchTab('move', event)"><i class="fa-solid fa-layer-group w-5 text-center mr-2"></i> æ™ºèƒ½èª¿åº¦ä¸­å¿ƒ</div>
            <div class="nav-item" onclick="switchTab('merge', event)"><i class="fa-solid fa-layer-group w-5 text-center mr-2"></i> æ¿è™Ÿåˆä½µ</div>
            <div class="nav-item" onclick="switchTab('stocktake', event)"><i class="fa-solid fa-clipboard-check w-5 text-center mr-2"></i> åº«å­˜ç›¤é»</div>

            <div class="nav-group">å‡ºåº«ç‰©æµ</div>
            <div class="nav-item" onclick="switchTab('shipping', event)"><i class="fa-solid fa-truck-ramp-box w-5 text-center mr-2"></i> è¨‚å–®ç†è²¨</div>
        </nav>
    </aside>

    <main class="flex-1 flex flex-col min-w-0 bg-slate-900">
        <header class="h-16 border-b border-slate-800 flex items-center justify-between px-6 bg-slate-900 shrink-0">
            <h2 class="text-xl font-bold text-white" id="page-title">æ•¸ä½å€‰åº«ç›£æ§</h2>
            <div class="flex gap-3 items-center">
                <span class="px-3 py-1 bg-slate-800 rounded text-xs text-slate-400 border border-slate-700">Admin</span>
                <button onclick="logoutSystem()" class="hover:text-white text-sm"><i class="fa-solid fa-power-off"></i></button>
            </div>
        </header>

        <div class="flex-1 overflow-hidden relative">
            
            <div id="view-visual-map" class="view-panel h-full flex flex-col">
                <div class="h-10 bg-slate-800/50 border-b border-slate-800 flex items-center px-4 gap-6 text-xs text-slate-400 shrink-0">
                    <span class="text-emerald-400"><i class="fa-solid fa-info-circle mr-1"></i>å®¹ç©èªªæ˜ï¼š</span>
                    <div class="flex items-center gap-1"><div class="w-3 h-3 bg-[#10b981] rounded-sm"></div> ä½ (<50%)</div>
                    <div class="flex items-center gap-1"><div class="w-3 h-3 bg-[#3b82f6] rounded-sm"></div> ä¸­ (50-99%)</div>
                    <div class="flex items-center gap-1"><div class="w-3 h-3 bg-[#ef4444] rounded-sm"></div> é«˜ (100%/æ»¿)</div>
                    <span class="ml-auto text-blue-400">é»æ“Šè»Œé“æŸ¥çœ‹è©³æƒ…</span>
                </div>
                <div class="warehouse-container-new">
                    <!-- å·¦å´ï¼šI å€ -->
                    <div class="map-overview-col">
                        <div class="warehouse-building">
                            <div class="absolute -top-3 left-4 bg-blue-600 text-white px-3 py-1 text-xs font-bold rounded shadow-lg">I å€ (åŸæ–™/é¤˜æ–™)</div>
                            <div class="mt-4">
                                <div class="zone-header">A å€</div>
                                <div class="zone-block border-blue-500/50">
                                    <div class="rack-lanes-grid" id="grid-I-A"></div>
                                </div>
                            </div>
                            <div class="mt-2">
                                <div class="zone-header bg-slate-600 border-slate-500">B å€</div>
                                <div class="zone-block border-indigo-500/50">
                                    <div class="rack-lanes-grid" id="grid-I-B"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ä¸­é–“ï¼šJ å€ -->
                    <div class="map-overview-col">
                        <div class="warehouse-building">
                            <div class="absolute -top-3 left-4 bg-purple-600 text-white px-3 py-1 text-xs font-bold rounded shadow-lg">J å€ (æˆå“/åŠæˆå“)</div>
                            <div class="mt-4">
                                <div class="zone-header bg-purple-600 border-purple-500">C å€</div>
                                <div class="zone-block border-purple-500/50">
                                    <div class="rack-lanes-grid" id="grid-J-C"></div>
                                </div>
                            </div>
                            <div class="mt-2">
                                <div class="zone-header bg-pink-600 border-pink-500">D å€</div>
                                <div class="zone-block border-pink-500/50">
                                    <div class="rack-lanes-grid" id="grid-J-D"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- å³å´ï¼šK å€ + O å€ -->
                    <div class="map-overview-col">
                        <!-- K å€ -->
                        <div class="warehouse-building mb-4">
                            <div class="absolute -top-3 left-4 bg-emerald-600 text-white px-3 py-1 text-xs font-bold rounded shadow-lg">K å€</div>
                            <div class="mt-4">
                                <div class="zone-header bg-emerald-600 border-emerald-500">E å€</div>
                                <div class="zone-block border-emerald-500/50">
                                    <div class="rack-lanes-grid" id="grid-K-E"></div>
                                </div>
                            </div>
                            <div class="mt-2">
                                <div class="zone-header bg-teal-600 border-teal-500">F å€</div>
                                <div class="zone-block border-teal-500/50">
                                    <div class="rack-lanes-grid" id="grid-K-F"></div>
                                </div>
                            </div>
                            <div class="mt-2">
                                <div class="zone-header bg-cyan-600 border-cyan-500">G å€</div>
                                <div class="zone-block border-cyan-500/50">
                                    <div class="rack-lanes-grid" id="grid-K-G"></div>
                                </div>
                            </div>
                            <div class="mt-2">
                                <div class="zone-header bg-sky-600 border-sky-500">H å€</div>
                                <div class="zone-block border-sky-500/50">
                                    <div class="rack-lanes-grid" id="grid-K-H"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- O å€ (å¤–éƒ¨ç§Ÿè³ƒ) -->
                        <div class="warehouse-building bg-orange-900/30 border-orange-600">
                            <div class="absolute -top-3 left-4 bg-orange-600 text-white px-3 py-1 text-xs font-bold rounded shadow-lg">O å€ (å¤–éƒ¨ç§Ÿè³ƒ)</div>
                            <div class="mt-4 text-center py-8">
                                <i class="fa-solid fa-warehouse text-4xl text-orange-400 mb-3"></i>
                                <div class="text-orange-300 font-bold text-sm mb-2">ç®¡é‡ä¸ç®¡å„²ä½</div>
                                <div class="text-slate-400 text-xs mb-4">ç¸½é‡çµ±è¨ˆ</div>
                                <div class="grid grid-cols-2 gap-3 px-4">
                                    <div class="bg-slate-800/50 rounded p-3 border border-orange-600/30">
                                        <div class="text-xs text-slate-400">ç¸½æ¿æ•¸</div>
                                        <div class="text-2xl font-bold text-white" id="o-zone-count">0</div>
                                    </div>
                                    <div class="bg-slate-800/50 rounded p-3 border border-orange-600/30">
                                        <div class="text-xs text-slate-400">ç¸½æ•¸é‡</div>
                                        <div class="text-2xl font-bold text-white" id="o-zone-qty">0</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- è©³æƒ…é¢æ¿ -->
                    <div class="rack-detail-panel" id="detail-panel">
                        <div class="h-full flex flex-col items-center justify-center text-slate-500 opacity-50">
                            <i class="fa-solid fa-layer-group text-6xl mb-4"></i>
                            <p>é»æ“Šå·¦å´è»Œé“</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-dashboard" class="view-panel h-full hidden flex flex-col p-6 overflow-y-auto"><div class="grid grid-cols-4 gap-4 mb-4"><div class="glass-panel kpi-card p-5 border-l-4 border-blue-500" onclick="openAnalytics('Total')"><div class="text-slate-400 text-xs">ç¸½åº«å­˜ (æ¿)</div><div class="text-3xl font-bold text-white mt-1" id="kpi-total-pallets">0</div></div><div class="glass-panel kpi-card p-5 border-l-4 border-purple-500" onclick="openAnalytics('FG')"><div class="text-slate-400 text-xs">æˆå“åº«å­˜ (æ¿)</div><div class="text-3xl font-bold text-white mt-1" id="kpi-fg-count">0</div></div><div class="glass-panel kpi-card p-5 border-l-4 border-orange-500" onclick="openAnalytics('WIP')"><div class="text-slate-400 text-xs">åŠæˆå“/é¤˜æ–™</div><div class="text-3xl font-bold text-white mt-1" id="kpi-return-count">0</div></div><div class="glass-panel kpi-card p-5 border-l-4 border-red-500" onclick="openAnalytics('Alert')"><div class="text-slate-400 text-xs">æ•ˆæœŸè­¦ç¤º</div><div class="text-3xl font-bold text-white mt-1">0</div></div></div><div class="glass-panel p-5 h-64 w-1/2"><canvas id="stockChart"></canvas></div></div>

            <div id="view-unified-inbound" class="view-panel h-full hidden flex flex-col p-6">
                <div class="w-full flex h-full gap-6">
                    <div class="w-1/3 flex flex-col overflow-y-auto pr-2">
                        <div class="grid grid-cols-4 gap-2 mb-6">
                            <div onclick="setInboundMode('Raw')" id="btn-mode-raw" class="mode-btn active-raw"><i class="fa-solid fa-truck-field"></i><span class="text-[10px]">æ¡è³¼é€²è²¨</span></div>
                            <div onclick="setInboundMode('FG')" id="btn-mode-fg" class="mode-btn"><i class="fa-solid fa-boxes-packing"></i><span class="text-[10px]">ç”¢ç·šæˆå“</span></div>
                            <div onclick="setInboundMode('WIP')" id="btn-mode-wip" class="mode-btn"><i class="fa-solid fa-basket-shopping"></i><span class="text-[10px]">ç”¢ç·šåŠæˆå“</span></div>
                            <div onclick="setInboundMode('Return')" id="btn-mode-ret" class="mode-btn"><i class="fa-solid fa-rotate-left"></i><span class="text-[10px]">é¤˜æ–™é€€åº«</span></div>
                            <input type="hidden" id="in-category" value="Raw">
                        </div>
                        <div class="glass-panel p-4 mb-4 border border-emerald-500" id="scan-panel">
                            <div class="flex justify-between text-xs text-blue-400 font-bold mb-1"><span id="step1-label">STEP 1. ç¶å®šè¼‰å…·</span><span id="return-hint" class="hidden text-orange-400">è«‹æƒæèˆŠæ¨™ç±¤</span></div>
                            <div class="flex gap-2 mb-2"><input type="text" id="in-pallet-id" class="scan-input text-lg font-bold w-full bg-slate-800" placeholder="1. æƒå¯¦é«”æ£§æ¿ (PLT-xxx)" autofocus onkeydown="focusNext(event, 'in-sheet-id')"></div>
                            <div class="flex gap-2"><input type="text" id="in-sheet-id" class="scan-input text-lg font-bold w-full" placeholder="2. æƒæ’å–®/å•†å“ (PRE-xxx)" onkeydown="handleUnifiedScan(event)"><button onclick="autoFillBarcode()" id="btn-auto-code" class="bg-slate-700 text-white px-3 rounded text-xs border border-slate-600 whitespace-nowrap"><i class="fa-solid fa-magic mr-1"></i>è³¦ç¢¼</button></div>
                        </div>
                        <div class="flex items-center justify-between bg-slate-800 p-2 rounded border border-slate-700 mb-4"><span class="text-xs text-white font-bold"><i class="fa-solid fa-lock text-blue-400 mr-2"></i>é€£çºŒå…¥åº« (é–å®š)</span><input type="checkbox" id="lock-mode" class="w-4 h-4"></div>
                        <div class="space-y-2 flex-1">
                            <div id="field-wo" class="field-group hidden"><label class="text-xs text-slate-400">å·¥å–®è™Ÿ</label><input type="text" id="in-wo" class="scan-input border-purple-500/50"></div>
                            <div id="field-parent-info" class="field-group hidden bg-orange-900/20 p-2 rounded border border-orange-500/30"><label class="text-xs text-orange-400">ç¹¼æ‰¿è‡ª</label><input type="text" id="in-parent-id" class="scan-input bg-transparent border-none text-xs" readonly></div>
                            <div><label class="text-xs text-slate-400">å» å•† (Vendor)</label><input type="text" id="in-vendor" class="scan-input bg-slate-900" oninput="updateLivePreview()"></div>
                            <div><label class="text-xs text-slate-400">å“å (Product)</label><input type="text" id="in-name" class="scan-input bg-slate-900" oninput="updateLivePreview()"></div>
                            <div class="grid grid-cols-2 gap-2"><div><label class="text-xs text-slate-400">è¦æ ¼</label><input type="text" id="in-spec" class="scan-input text-yellow-400 font-bold" oninput="updateLivePreview()"></div><div><label class="text-xs text-slate-400" id="lbl-qty">æ•¸é‡</label><input type="number" id="in-qty" class="scan-input text-white font-bold" oninput="updateLivePreview()"></div></div>
                            <div id="field-weight" class="field-group hidden"><label class="text-xs text-yellow-500 font-bold">å¯¦é‡</label><input type="number" id="in-weight" class="scan-input text-xl font-bold text-center"></div>
                            <div class="grid grid-cols-2 gap-2"><div><label class="text-xs text-slate-400">æ‰¹è™Ÿ</label><input type="text" id="in-batch" class="scan-input" oninput="updateLivePreview()"></div><div><label class="text-xs text-slate-400">æ•ˆæœŸ</label><input type="date" id="in-exp" class="scan-input" oninput="updateLivePreview()"></div></div>
                            <div class="pt-2 border-t border-slate-700"><div class="flex justify-between items-center mb-1"><label class="text-xs text-blue-400 font-bold">STEP 2. é¸æ“‡å„²ä½</label><button onclick="openVirtualSelector()" class="text-[10px] bg-slate-700 px-2 py-0.5 rounded text-white border border-slate-600">åˆ‡æ›è™›æ“¬</button></div><input type="text" id="in-loc" class="scan-input pl-10 text-xl font-bold text-emerald-400 bg-slate-900 border-emerald-500/50 text-center" placeholder="é»æ“Šå³å´åœ°åœ–" readonly></div>
                        </div>
                        <div class="flex items-center gap-2 mt-3 px-2">
                            <input type="checkbox" id="preview-pallet-tag" class="w-4 h-4" checked>
                            <label for="preview-pallet-tag" class="text-sm text-slate-300 cursor-pointer">å…¥åº«å¾Œé è¦½æ£§æ¿æ’å–®</label>
                        </div>
                        <div class="flex gap-2 mt-2">
                            <button onclick="confirmUnifiedInbound()" id="btn-submit" class="flex-1 py-3 bg-emerald-600 hover:bg-emerald-500 text-white rounded font-bold shadow-lg text-lg transition">
                                <i class="fa-solid fa-check-circle mr-2"></i>ç¢ºèªå…¥åº«
                            </button>
                            <button onclick="showBatchInboundDialog()" class="py-3 px-6 bg-orange-600 hover:bg-orange-500 text-white rounded font-bold shadow-lg text-lg transition" title="æ‰¹æ¬¡å…¥åº«å¤šæ¿">
                                <i class="fa-solid fa-layer-group mr-2"></i>æ‰¹æ¬¡å…¥åº«
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex-1 flex flex-col gap-4">
                         <div class="bg-slate-900 p-4 relative rounded border border-slate-800" style="flex:2; overflow:hidden;">
                             <div class="absolute top-2 right-4 bg-slate-800/80 p-1 px-2 rounded border border-slate-700 text-xs text-slate-300 flex gap-2 backdrop-blur z-10"><div class="flex items-center gap-1"><i class="fa-solid fa-star text-yellow-400"></i> æ¨è–¦</div><div class="flex items-center gap-1"><div class="w-3 h-3 border border-emerald-500"></div> ç©ºä½</div></div>
                             <div class="map-overview-col h-full" id="inbound-map-area"><div class="warehouse-building"><div class="text-blue-400 font-bold mb-2">I åº«</div><div class="zone-block border-blue-500/50"><div class="rack-lanes-grid" id="grid-I-A-map"></div></div><div class="zone-block border-indigo-500/50"><div class="rack-lanes-grid" id="grid-I-B-map"></div></div></div><div class="warehouse-building"><div class="text-purple-400 font-bold mb-2">J åº«</div><div class="zone-block border-purple-500/50"><div class="rack-lanes-grid" id="grid-J-C-map"></div></div><div class="zone-block border-pink-500/50"><div class="rack-lanes-grid" id="grid-J-D-map"></div></div></div></div>
                        </div>
                        <div class="bg-slate-800 p-4 rounded border border-slate-700 flex flex-col" style="flex:1;">
                            <div class="text-xs text-slate-400 font-bold mb-2"><i class="fa-solid fa-eye mr-1"></i>å³æ™‚æ¨™ç±¤é è¦½ (Live Preview)</div>
                            <div id="live-preview-box" class="preview-label-card flex-1 flex flex-col justify-center">
                                <div class="preview-header">å…¥åº«æ¨™ç±¤</div>
                                <div class="preview-row"><span class="print-label">å» å•†</span><span class="print-val" id="prev-vendor">-</span></div>
                                <div class="preview-row"><span class="print-label">å“å</span><span class="print-val text-xl" id="prev-name">-</span></div>
                                <div class="preview-row"><span class="print-label">è¦æ ¼</span><span class="print-val" id="prev-spec">-</span></div>
                                <div class="preview-row"><span class="print-label">æ‰¹è™Ÿ</span><span class="print-val" id="prev-batch">-</span></div>
                                <div class="preview-big" id="prev-qty">0</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-pre-inbound" class="view-panel h-full hidden flex p-4 gap-4"><div class="w-1/3 glass-panel p-4 flex flex-col overflow-y-auto"><h3 class="text-white font-bold mb-3 border-b border-slate-700 pb-2 text-sm">1. æ‰¹æ¬¡é ç´„</h3><div class="mb-3 bg-slate-800 p-2 rounded border border-slate-700"><div class="flex justify-between items-center mb-1"><span class="text-xs text-blue-400 font-bold">Excel åŒ¯å…¥</span><button onclick="downloadTemplate('pre')" class="text-[10px] text-slate-400 underline">ä¸‹è¼‰ç¯„æœ¬</button></div><input type="file" id="preInboundExcel" accept=".xlsx" class="hidden" onchange="handlePreInboundImport(event)"><button onclick="document.getElementById('preInboundExcel').click()" class="w-full py-1.5 bg-emerald-600 hover:bg-emerald-500 text-white rounded text-xs font-bold">ä¸Šå‚³ Excel</button></div><h3 class="text-white font-bold mb-3 border-b border-slate-700 pb-2 text-sm pt-2">2. æ‰‹å‹•é ç´„</h3><div class="space-y-2"><input type="text" id="pre-vendor" class="scan-input" placeholder="å» å•†"><input type="text" id="pre-name" class="scan-input" placeholder="å“å"><input type="text" id="pre-spec" class="scan-input" placeholder="è¦æ ¼"><input type="text" id="pre-batch" class="scan-input" placeholder="æ‰¹è™Ÿ"><input type="date" id="pre-exp" class="scan-input"><div class="grid grid-cols-2 gap-2"><input type="number" id="pre-per-pallet" class="scan-input text-center" value="50" placeholder="æ¯æ¿æ•¸"><input type="number" id="pre-count" class="scan-input text-center font-bold text-white" value="1" placeholder="ç¸½æ¿æ•¸"></div><button onclick="generatePlan()" class="w-full py-2 bg-blue-600 hover:bg-blue-500 text-white rounded font-bold shadow-lg mt-2 text-xs">ç”Ÿæˆ</button></div></div><div class="flex-1 glass-panel p-4 flex flex-col"><div class="flex justify-between items-center mb-3"><h3 class="text-white font-bold text-sm">æ¨™ç±¤é è¦½</h3><button onclick="printLabels()" id="btn-print" class="bg-slate-700 text-slate-500 px-3 py-1 rounded text-xs font-bold cursor-not-allowed" disabled>åˆ—å°æ’å–®</button></div><div id="preview-area" class="flex-1 overflow-y-auto grid grid-cols-2 gap-2 content-start"></div></div></div>
            
            <div id="view-inventory-query" class="view-panel h-full hidden flex flex-col p-4"><div class="flex gap-2 mb-3 items-center"><input type="text" id="global-search" class="scan-input pl-9" placeholder="è¬ç”¨æœå°‹..." oninput="filterInventory()"><button onclick="document.getElementById('stockImportInput').click()" class="bg-orange-600 text-white px-3 py-1.5 rounded text-xs font-bold hover:bg-orange-500 ml-auto flex items-center gap-2"><i class="fa-solid fa-file-import"></i> æœŸåˆåŒ¯å…¥</button><button onclick="downloadTemplate('stock')" class="text-slate-400 text-xs hover:text-white underline">ç¯„æœ¬</button><input type="file" id="stockImportInput" accept=".xlsx" class="hidden" onchange="handleStockImport(event)"></div><div class="glass-panel flex-1 overflow-auto"><table class="w-full dense-table"><thead><tr><th>ID</th><th>å“å</th><th>è¦æ ¼</th><th>æ‰¹è™Ÿ</th><th>æ•¸é‡</th><th>ä½ç½®</th><th>æ“ä½œ</th></tr></thead><tbody id="inventory-list-body"></tbody></table></div></div>
            
            <div id="view-shipping" class="view-panel h-full hidden flex flex-col"><div class="h-14 border-b border-slate-800 flex items-center px-4 gap-4 bg-slate-900/50"><input type="file" id="excelInput" accept=".xlsx" class="hidden" onchange="handleExcelImport(event)"><button onclick="document.getElementById('excelInput').click()" class="bg-emerald-600 text-white px-3 py-1.5 rounded text-xs font-bold hover:bg-emerald-500 shadow-lg flex items-center"><i class="fa-solid fa-file-excel mr-2"></i>åŒ¯å…¥è¨‚å–®</button><button onclick="downloadTemplate('order')" class="text-slate-400 text-xs hover:text-white underline">ç¯„æœ¬</button><button onclick="exportShippingResult()" class="bg-blue-600 text-white px-3 py-1.5 rounded text-xs font-bold ml-2">ğŸ“¤ åŒ¯å‡ºERP</button><div class="flex items-center gap-2 border-l border-slate-700 pl-4"><label class="text-xs text-slate-400">ç‰©æµ:</label><select id="filter-carrier" class="bg-slate-800 border border-slate-700 text-white text-xs rounded px-2 py-1.5" onchange="filterShippingList()"><option value="ALL">å…¨éƒ¨</option></select></div><div class="text-xs text-slate-400 ml-auto">å¾…å‡ºè²¨: <span class="text-white font-bold" id="order-count">0</span> å–®</div></div><div class="flex-1 overflow-auto p-4"><table class="w-full dense-table text-left"><thead><tr><th>ç‰©æµ</th><th>å–®è™Ÿ</th><th>å®¢æˆ¶</th><th>å“é …(è¦æ ¼)</th><th>ç‹€æ…‹</th><th class="text-right">æ“ä½œ</th></tr></thead><tbody id="shipping-list-body"></tbody></table></div></div>
            
            <div id="view-move" class="view-panel h-full hidden flex flex-col p-4 gap-3">
                <!-- é ‚éƒ¨æ¨™é¡Œ -->
                <div class="bg-gradient-to-r from-blue-900 to-blue-800 border border-blue-600 p-4 rounded-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-white font-bold text-xl"><i class="fa-solid fa-brain mr-2 text-blue-400"></i>æ™ºèƒ½èª¿åº¦ä¸­å¿ƒ</h2>
                            <p class="text-blue-200 text-sm mt-1">è¾¦å…¬å®¤é‹ç±Œï¼Œç¾å ´å‚»ç“œåŸ·è¡Œ</p>
                        </div>
                        <button onclick="viewDispatchHistory()" class="bg-blue-700 hover:bg-blue-600 text-white px-4 py-2 rounded text-sm">
                            <i class="fa-solid fa-history mr-2"></i>èª¿åº¦æ­·å²
                        </button>
                    </div>
                </div>
                
                <!-- ä¸»è¦å…§å®¹ï¼šå·¦å³åˆ†æ¬„ -->
                <div class="flex gap-3 flex-1 overflow-hidden">
                    <!-- å·¦å´ï¼šæ™ºèƒ½åˆ†æ -->
                    <div class="w-80 flex flex-col gap-3 overflow-y-auto">
                        <!-- æ•£äº‚åº¦æ’è¡Œ -->
                        <div class="bg-slate-900/50 border border-slate-700 rounded p-3">
                            <h3 class="text-white font-bold mb-3">
                                <i class="fa-solid fa-fire text-red-400 mr-2"></i>æ•£äº‚åº¦æ’è¡Œ
                            </h3>
                            <div id="dispersion-ranking">
                                <div class="text-slate-400 text-sm">åˆ†æä¸­...</div>
                            </div>
                        </div>
                        
                        <!-- å“åçµ±è¨ˆ -->
                        <div id="product-stats"></div>
                    </div>
                    
                    <!-- å³å´ï¼šè¦–è¦ºåŒ–åœ°åœ– -->
                    <div class="flex-1 bg-slate-900/50 border border-slate-700 rounded p-4 overflow-y-auto">
                        <div id="visual-map">
                            <div class="text-center text-slate-400 py-12">
                                <i class="fa-solid fa-hand-pointer text-6xl mb-4 opacity-30"></i>
                                <p>è«‹å¾å·¦å´é¸æ“‡å“åæŸ¥çœ‹èª¿åº¦å»ºè­°</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="view-merge" class="view-panel h-full hidden p-6"><div class="move-container"><div class="move-box active"><div class="text-blue-400 font-bold mb-4 text-xl">ä¿ç•™æ£§æ¿</div><i class="fa-solid fa-layer-group text-6xl mb-4 text-purple-500/50"></i><input type="text" class="scan-input w-2/3 text-center" placeholder="æƒæ"></div><i class="fa-solid fa-plus arrow-icon"></i><div class="move-box"><div class="text-slate-400 font-bold mb-4 text-xl">ç§»å…¥æ£§æ¿</div><input type="text" class="scan-input w-2/3 text-center" placeholder="æƒæ"></div></div></div>
            <div id="view-stocktake" class="view-panel h-full hidden p-6"><div class="flex justify-between items-center mb-6"><h3 class="text-white font-bold">ç›¤é»ä»»å‹™</h3><button class="px-4 py-2 bg-blue-600 text-white rounded text-sm font-bold shadow-lg">å»ºç«‹ç›¤é»å–®</button></div><div class="glass-panel p-5 border border-slate-600 relative opacity-50"><div class="text-center py-10 text-slate-500">å°šç„¡ä»»å‹™</div></div></div>

        </div>
    </main>

    <div id="print-area" class="hidden"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, query, where, onSnapshot, writeBatch, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = { apiKey: "AIzaSyBEWzyRMJQirGbh28ANkE6aN42GzUBuw2s", authDomain: "terrywms-2345f.firebaseapp.com", projectId: "terrywms-2345f", storageBucket: "terrywms-2345f.firebasestorage.app", messagingSenderId: "75589714942", appId: "1:75589714942:web:3a7f723c3d1449df78f6af" };
        const app = initializeApp(firebaseConfig); const db = getFirestore(app); const auth = getAuth(app);
        window.db = db; window.collection = collection; window.addDoc = addDoc; window.doc = doc; window.updateDoc = updateDoc; window.deleteDoc = deleteDoc; window.writeBatch = writeBatch; window.getDocs = getDocs; window.query = query; window.where = where; window.onSnapshot = onSnapshot;

        onAuthStateChanged(auth, (user) => { if (user) { document.getElementById('view-login').classList.add('hidden'); initAllListeners(); } else { document.getElementById('view-login').classList.remove('hidden'); } });
        window.loginSystem = async () => { await signInWithEmailAndPassword(auth, document.getElementById('login-email').value, document.getElementById('login-pwd').value); }
        window.logoutSystem = () => { signOut(auth); location.reload(); }

        let currentInventory = []; let currentOrders = [];
        function initAllListeners() {
            onSnapshot(collection(db, "pallets"), (snapshot) => {
                currentInventory = [];
                const tbody = document.getElementById('inventory-list-body');
                if(tbody) tbody.innerHTML = '';
                let stats = { total:0, fg:0, ret:0, virt:0, chart:{raw:0, fg:0, wip:0} };
                
                snapshot.forEach(d => {
                    const data = d.data();
                    if(data.quantity > 0 || data.totalWeight > 0) {
                        currentInventory.push(data);
                        stats.total++;
                        if(data.category === 'FG') { stats.fg++; stats.chart.fg++; } else if(data.category === 'WIP') { stats.chart.wip++; } else { stats.chart.raw++; }
                        if(data.source === 'Factory_Return') stats.ret++;
                        if(data.locationId && data.locationId.startsWith('V-')) stats.virt++;
                        let badge = '<span class="badge badge-green">åŸæ–™</span>';
                        if(data.category === 'FG') badge = '<span class="badge badge-purple">æˆå“</span>';
                        if(data.category === 'WIP') badge = '<span class="badge badge-yellow">åŠæˆå“</span>';
                        if(data.source === 'Factory_Return') badge = '<span class="badge badge-orange">é¤˜æ–™</span>';
                        if(tbody) tbody.innerHTML += `<tr class="border-b border-slate-700 hover:bg-slate-800"><td class="font-mono text-blue-400 p-2">${d.id}</td><td class="text-white p-2">${data.productName}</td><td class="text-yellow-400 p-2">${data.spec||'-'}</td><td class="text-slate-400 font-mono p-2">${data.batchNo}</td><td class="text-right text-white p-2">${data.quantity||'-'}</td><td class="p-2">${data.locationId}</td><td class="p-2 text-right"><button onclick="deletePallet('${d.id}')" class="text-red-500 hover:bg-red-500/20 rounded px-2"><i class="fa-solid fa-trash"></i></button></td></tr>`;
                    }
                });
                if(document.getElementById('kpi-total-pallets')) { document.getElementById('kpi-total-pallets').innerText = stats.total; document.getElementById('kpi-fg-count').innerText = stats.fg; document.getElementById('kpi-return-count').innerText = stats.ret; updateChart(stats.chart); }
                renderAllMaps();
            });
            onSnapshot(collection(db, "shippingOrders"), (snapshot) => { currentOrders = []; snapshot.forEach(d => currentOrders.push(d.data())); renderShippingList(); });
        }
        let myChart = null;
        function updateChart(data) {
            const ctx = document.getElementById('stockChart'); if(!ctx) return;
            if(myChart) { myChart.data.datasets[0].data = [data.raw, data.fg, data.wip]; myChart.update(); }
            else { myChart = new Chart(ctx, { type: 'doughnut', data: { labels: ['åŸæ–™', 'æˆå“', 'åŠæˆå“'], datasets: [{ data: [data.raw, data.fg, data.wip], backgroundColor: ['#10b981', '#a855f7', '#facc15'], borderWidth: 0 }] }, options: { responsive: true, plugins: { legend: { position: 'right', labels: { color: 'white' } } } } }); }
        }
        window.currentInventory = () => currentInventory; window.currentOrders = () => currentOrders;
    </script>

    <script>
        function switchTab(viewId, evt) {
            document.querySelectorAll('.view-panel').forEach(function(el) { el.classList.add('hidden'); });
            document.getElementById('view-' + viewId).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(function(el) { el.classList.remove('active'); });
            
            if(evt && evt.currentTarget) {
                evt.currentTarget.classList.add('active');
                document.getElementById('page-title').innerText = evt.currentTarget.innerText;
            }
            
            if(viewId === 'visual-map') { renderAllMaps(); window.currentViewingLane = null; }
            if(viewId === 'move') { initSmartDispatch(); }
        }
        function renderAllMaps() { 
            renderMapUI('grid-I-A'); renderMapUI('grid-I-B'); 
            renderMapUI('grid-J-C'); renderMapUI('grid-J-D'); 
            renderMapUI('grid-K-E'); renderMapUI('grid-K-F'); renderMapUI('grid-K-G'); renderMapUI('grid-K-H');
            renderMapUI('grid-I-A-map'); renderMapUI('grid-I-B-map'); 
            renderMapUI('grid-J-C-map'); renderMapUI('grid-J-D-map'); 
            renderMapUI('grid-K-E-map'); renderMapUI('grid-K-F-map'); renderMapUI('grid-K-G-map'); renderMapUI('grid-K-H-map');
            if(window.currentViewingLane) showLaneDetail(window.currentViewingLane.zone, window.currentViewingLane.row);
            updateOZoneStats();
        }

        const mapConfig = { 
            'grid-I-A':8, 'grid-I-B':8, 
            'grid-J-C':8, 'grid-J-D':8, 
            'grid-K-E':8, 'grid-K-F':8, 'grid-K-G':8, 'grid-K-H':8,
            'grid-I-A-map':8, 'grid-I-B-map':8, 
            'grid-J-C-map':8, 'grid-J-D-map':8,
            'grid-K-E-map':8, 'grid-K-F-map':8, 'grid-K-G-map':8, 'grid-K-H-map':8
        };
        let lockedLane = null;
        
        // O å€çµ±è¨ˆï¼ˆç®¡é‡ä¸ç®¡å„²ä½ï¼‰
        function updateOZoneStats() {
            var inventory = window.currentInventory ? window.currentInventory() : [];
            var oZoneItems = inventory.filter(function(item) {
                return item.locationId && item.locationId.startsWith('O-');
            });
            
            var totalCount = oZoneItems.length;
            var totalQty = oZoneItems.reduce(function(sum, item) {
                return sum + (parseInt(item.quantity) || 0);
            }, 0);
            
            var countEl = document.getElementById('o-zone-count');
            var qtyEl = document.getElementById('o-zone-qty');
            
            if (countEl) countEl.textContent = totalCount;
            if (qtyEl) qtyEl.textContent = totalQty;
        }
        const LANE_CAPACITY = 20;

        function renderMapUI(gridId) {
            const container = document.getElementById(gridId); if(!container) return; container.innerHTML = '';
            const parts = gridId.replace('grid-', '').replace('-map', '').split('-'); const zoneKey = `${parts[0]}-${parts[1]}`;
            const zoneChar = parts[1]; 
            const inventory = window.currentInventory ? window.currentInventory() : [];
            const laneStatus = {};
            inventory.forEach(item => { if(item.locationId.startsWith('V-')) return; const p = item.locationId.split('-'); if(p.length >= 3 && `${p[0]}-${p[1]}` === zoneKey) { const lane = parseInt(p[2]); if(!laneStatus[lane]) laneStatus[lane] = { count: 0, products: new Set() }; laneStatus[lane].count++; laneStatus[lane].products.add(item.productName); } });
            
            for(let i=1; i<=8; i++) {
                const status = laneStatus[i] || { count: 0 };
                const fillPercent = Math.min((status.count / LANE_CAPACITY) * 100, 100);
                
                let fillColor = '#10b981'; if(fillPercent>=50) fillColor='#3b82f6'; if(fillPercent>=100) fillColor='#ef4444';
                let cls = '';
                if (status.count >= LANE_CAPACITY) cls += ' lane-full-locked'; 
                if (lockedLane && lockedLane.zone === zoneKey && lockedLane.row === i) cls += ' border-yellow-400 shadow-[0_0_10px_rgba(250,204,21,0.5)] z-20';
                const targetName = document.getElementById('in-name') ? document.getElementById('in-name').value : '';
                if(targetName && status.products && status.products.has(targetName) && fillPercent < 100) cls += ' lane-suggest-gold';
                
                const div = document.createElement('div'); div.className = `rack-lane ${cls}`; 
                div.innerHTML = `<span class="lane-id-tag">${zoneChar}${i}</span><div class="lane-fill-bar" style="height:${fillPercent}%; background:${fillColor}"></div>${cls.includes('gold')?'<i class="fa-solid fa-star text-yellow-400 absolute top-1/2 left-1/2 -translate-x-1/2"></i>':''}`;
                
                const isInbound = !document.getElementById('view-unified-inbound').classList.contains('hidden');
                if(isInbound) {
                    div.onclick = () => { openLevelSelector(zoneKey, i); };
                } else { 
                    div.onmouseenter = () => { if(!lockedLane) showLaneDetail(zoneKey, i); }; 
                    div.onclick = () => { if(lockedLane && lockedLane.zone === zoneKey && lockedLane.row === i) { lockedLane = null; div.classList.remove('locked'); } else { lockedLane = {zone: zoneKey, row: i}; showLaneDetail(zoneKey, i); renderAllMaps(); } }; 
                }
                container.appendChild(div);
            }
        }

        window.currentViewingLane = null;
        function showLaneDetail(zone, row) {
            window.currentViewingLane = { zone, row };
            const inventory = window.currentInventory(); const lanePrefix = `${zone}-${row < 10 ? '0'+row : row}`; const items = inventory.filter(d => d.locationId.startsWith(lanePrefix));
            const levels = { '3F': [], '2F': [], '1F': [] }; items.forEach(d => { const layer = d.locationId.split('-').pop(); if(levels[layer]) levels[layer].push(d); });
            const cap3F = 4 - levels['3F'].length; const cap2F = 4 - levels['2F'].length;
            const panel = document.getElementById('detail-panel'); if(!panel) return;
            
            panel.innerHTML = `
                <div class="p-4 border-b border-slate-700 bg-slate-800/50 flex justify-between items-center"><h3 class="text-lg font-bold text-white">${zone} ç¬¬ ${row} è¡Œ</h3><div class="flex gap-2"><span class="badge ${cap2F+cap3F > 0 ? 'badge-green' : 'badge-red'}">ç©ºä½: ${Math.max(0, 8-(levels['2F'].length+levels['3F'].length))}</span><button onclick="clearLane('${zone}', ${row})" class="text-[10px] bg-red-900/50 text-red-300 px-2 rounded border border-red-800">æ¸…ç©º</button></div></div>
                <div class="levels-container p-4 overflow-y-auto">
                    ${renderVisualLevel('3F', levels['3F'], 4)}
                    ${renderVisualLevel('2F', levels['2F'], 4)}
                    ${renderVisualLevel('1F', levels['1F'], 12, true)}
                </div>
            `;
        }
        function renderVisualLevel(layer, items, cap, isHigh) {
            let boxes = ''; 
            items.forEach(item => { 
                let bg = 'bg-raw'; if(item.category==='FG') bg='bg-fg'; if(item.category==='WIP') bg='bg-wip'; 
                boxes += `
                    <div class="pallet-box ${bg} ${isHigh?'loose':''}" title="${item.productName}">
                        <div class="row-1"><span class="name">${item.productName}</span><span class="qty">${item.quantity}ä»¶</span></div>
                        <div class="row-2">${item.spec||'ç„¡è¦æ ¼'}</div>
                        <div class="row-3">${item.batchNo}</div>
                    </div>
                `; 
            });
            for(let i=0; i<(cap-items.length); i++) boxes += `<div class="pallet-box pallet-empty">ç©º</div>`;
            return `
                <div class="level-card">
                    <div class="level-header"><span class="${isHigh?'text-yellow-500':'text-slate-300'}">${layer} ${isHigh?'(æŒ‘é«˜)':''}</span><span>${items.length}/${cap}</span></div>
                    <div class="level-grid ${isHigh?'grid-cols-4 gap-2':'grid-cols-4 gap-2'}">${boxes}</div>
                </div>
            `;
        }

        // V41: ERP åŒ¯å‡º
        function exportShippingResult() {
            if(!window.currentOrders || window.currentOrders().length === 0) { alert("ç„¡å‡ºè²¨è³‡æ–™å¯åŒ¯å‡º"); return; }
            const data = window.currentOrders().map(o => ({
                'å–®è™Ÿ': o.orderId, 'å®¢æˆ¶': o.customer, 'ç‰©æµ': o.carrier, 
                'ç‹€æ…‹': o.status, 'å“é …æ•¸': o.items.length
            }));
            const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Shipping_Result"); XLSX.writeFile(wb, `WMS_Shipping_Result_${new Date().toISOString().slice(0,10)}.xlsx`);
        }

        // V39: æ·±é‘½åˆ†æ
        function openAnalytics(type) { document.getElementById('analytics-title').innerText = type==='Total'?'åº«å­˜ç¸½è¦½':type; document.getElementById('modal-analytics').classList.remove('hidden'); }
        function closeAnalytics() { document.getElementById('modal-analytics').classList.add('hidden'); }

        let currentLane = null;
        function openLevelSelector(zone, row) { 
            currentLane = { zone, row }; 
            document.getElementById('modal-lane-title').innerText = zone + ' ç¬¬ ' + row + ' è¡Œ'; 
            var inventory = window.currentInventory(); 
            var lanePrefix = zone + '-' + (row < 10 ? '0'+row : row); 
            var items = inventory.filter(function(d) { return d.locationId.startsWith(lanePrefix); });
            
            // è¨ˆç®—å„å±¤ä½¿ç”¨æƒ…æ³
            var c3 = items.filter(function(d) { return d.locationId.endsWith('3F'); }).length;
            var c2 = items.filter(function(d) { return d.locationId.endsWith('2F'); }).length;
            var c1 = items.filter(function(d) { return d.locationId.endsWith('1F'); }).length;
            
            // 3F æŒ‰éˆ•
            var btn3F = document.getElementById('btn-level-3f'); 
            var avail3F = 4 - c3;
            if(c3 >= 4) { 
                btn3F.classList.add('level-btn-full'); 
                btn3F.disabled = true; 
                btn3F.innerHTML = '<div class="font-bold text-red-400">3F (æ»¿)</div><div class="text-xs text-red-300 mt-1">4/4 æ¿ | 4.0 mÂ³</div><div class="text-xs text-red-500">âš ï¸ å·²æ»¿è¼‰</div>';
            } else { 
                btn3F.classList.remove('level-btn-full'); 
                btn3F.disabled = false; 
                btn3F.innerHTML = '<div class="font-bold text-white">3F</div><div class="text-xs text-slate-300 mt-1">' + c3 + '/4 æ¿ | 4.0 mÂ³</div><div class="text-xs text-green-400">âœ“ å¯æ”¾ ' + avail3F + ' æ¿</div>';
            }
            
            // 2F æŒ‰éˆ•
            var btn2F = document.getElementById('btn-level-2f'); 
            var avail2F = 4 - c2;
            if(c2 >= 4) { 
                btn2F.classList.add('level-btn-full'); 
                btn2F.disabled = true; 
                btn2F.innerHTML = '<div class="font-bold text-red-400">2F (æ»¿)</div><div class="text-xs text-red-300 mt-1">4/4 æ¿ | 4.0 mÂ³</div><div class="text-xs text-red-500">âš ï¸ å·²æ»¿è¼‰</div>';
            } else { 
                btn2F.classList.remove('level-btn-full'); 
                btn2F.disabled = false; 
                btn2F.innerHTML = '<div class="font-bold text-white">2F</div><div class="text-xs text-slate-300 mt-1">' + c2 + '/4 æ¿ | 4.0 mÂ³</div><div class="text-xs text-green-400">âœ“ å¯æ”¾ ' + avail2F + ' æ¿</div>';
            }
            
            // 1F æŒ‰éˆ•ï¼ˆæŒ‘é«˜ï¼‰
            var btn1F = document.getElementById('btn-level-1f');
            var avail1F = 12 - c1;
            if(c1 >= 12) {
                btn1F.classList.add('level-btn-full');
                btn1F.disabled = true;
                btn1F.innerHTML = '<div class="font-bold text-red-400">1F æŒ‘é«˜ (æ»¿)</div><div class="text-xs text-red-300 mt-1">12/12 æ¿ | 12.0 mÂ³</div><div class="text-xs text-red-500">âš ï¸ å·²æ»¿è¼‰</div>';
            } else {
                btn1F.classList.remove('level-btn-full');
                btn1F.disabled = false;
                btn1F.innerHTML = '<div class="font-bold text-yellow-400">1F æŒ‘é«˜</div><div class="text-xs text-slate-300 mt-1">' + c1 + '/12 æ¿ | 12.0 mÂ³</div><div class="text-xs text-green-400">âœ“ å¯æ”¾ ' + avail1F + ' æ¿</div>';
            }
            
            document.getElementById('loc-select-physical').classList.remove('hidden'); 
            document.getElementById('loc-select-virtual').classList.add('hidden'); 
            document.getElementById('modal-level-select').classList.remove('hidden'); 
        }
        function closeLocModal() { document.getElementById('modal-level-select').classList.add('hidden'); }
        function selectLevel(level) { if(!currentLane) return; const rowStr = currentLane.row < 10 ? '0'+currentLane.row : currentLane.row; document.getElementById('in-loc').value = `${currentLane.zone}-${rowStr}-${level}`; closeLocModal(); }

        const virtualLocations = [{id:'V-SALES',name:'æ¥­å‹™ä¿ç•™'},{id:'V-TEMP',name:'è‡¨æ™‚æš«å­˜'},{id:'V-QC',name:'å“ç®¡ç•™ç½®'}];
        function openVirtualSelector() { document.getElementById('virtual-grid').innerHTML = virtualLocations.map(v=>`<div class="virtual-card" onclick="selectVirtualLoc('${v.id}')"><div class="font-bold text-white text-sm">${v.name}</div><div class="text-[10px] text-slate-400 mt-1">${v.id}</div></div>`).join(''); document.getElementById('loc-select-physical').classList.add('hidden'); document.getElementById('loc-select-virtual').classList.remove('hidden'); document.getElementById('modal-level-select').classList.remove('hidden'); }
        function addNewVirtualLoc() { const name = document.getElementById('new-virtual-name').value; if(name) { virtualLocations.push({id:`V-CUSTOM-${Date.now().toString().slice(-4)}`, name}); openVirtualSelector(); } }
        function selectVirtualLoc(id) { document.getElementById('in-loc').value = id; closeLocModal(); }
        function setCategory(cat) { 
            document.querySelectorAll('.border-emerald-600, .border-slate-600').forEach(el => { if(el.id.startsWith('cat-')) el.className = "border border-slate-600 text-slate-400 text-center rounded text-[10px] py-1"; });
            const activeEl = document.getElementById('cat-'+cat);
            if(cat==='Raw') activeEl.className = "border border-emerald-600 bg-emerald-900/30 text-emerald-400 text-center rounded text-[10px] py-1 font-bold";
            if(cat==='FG') activeEl.className = "border border-purple-600 bg-purple-900/30 text-purple-400 text-center rounded text-[10px] py-1 font-bold";
            if(cat==='WIP') activeEl.className = "border border-yellow-600 bg-yellow-900/30 text-yellow-400 text-center rounded text-[10px] py-1 font-bold";
            document.getElementById('in-category').value = cat; 
        }

        function focusNext(e, nextId) { if(e.key === 'Enter') { if(nextId==='confirm-btn') confirmUnifiedInbound(); else document.getElementById(nextId).focus(); } }
        
        window.showBatchInboundDialog = function() {
            var name = document.getElementById('in-name').value;
            var qty = document.getElementById('in-qty').value;
            var loc = document.getElementById('in-loc').value;
            if(!name) { alert("è«‹å…ˆå¡«å¯«å“å"); return; }
            if(!qty) { alert("è«‹å…ˆå¡«å¯«æ•¸é‡"); return; }
            if(!loc) { alert("è«‹å…ˆé¸æ“‡å„²ä½"); return; }
            var count = prompt("è¦æ‰¹æ¬¡å…¥åº«å¹¾æ¿ï¼Ÿ", "10");
            if(!count || count < 1) return;
            executeBatchInbound(parseInt(count));
        };
        
        async function executeBatchInbound(count) {
            if(!confirm('ç¢ºå®šè¦æ‰¹æ¬¡å…¥åº« ' + count + ' æ¿ï¼Ÿ')) return;
            try {
                var batch = window.writeBatch(window.db);
                var now = new Date();
                var name = document.getElementById('in-name').value;
                var spec = document.getElementById('in-spec').value || '';
                var batchNo = document.getElementById('in-batch') ? document.getElementById('in-batch').value : '';
                var qty = parseInt(document.getElementById('in-qty').value);
                var loc = document.getElementById('in-loc').value;
                var category = document.getElementById('in-category').value;
                var vendor = document.getElementById('in-vendor') ? document.getElementById('in-vendor').value : '';
                for(var i = 0; i < count; i++) {
                    var sheetId = window.generateSheetId();
                    var ref = window.doc(window.collection(window.db, "pallets"));
                    batch.set(ref, {
                        palletId: sheetId,
                        sheetId: sheetId,
                        productName: name,
                        spec: spec,
                        batchNo: batchNo,
                        quantity: qty,
                        locationId: loc,
                        category: category,
                        vendor: vendor,
                        status: "Available",
                        inboundDate: now,
                        source: "BatchInbound"
                    });
                }
                await batch.commit();
                alert('æ‰¹æ¬¡å…¥åº«æˆåŠŸï¼\n\nå·²ç”¢ç”Ÿ ' + count + ' å€‹æ£§æ¿\nç¸½æ•¸é‡ï¼š' + (qty * count) + ' ä»¶');
                if(!document.getElementById('lock-mode').checked) {
                    document.getElementById('in-name').value = '';
                    document.getElementById('in-spec').value = '';
                    document.getElementById('in-qty').value = '';
                    document.getElementById('in-loc').value = '';
                }
            } catch(e) {
                alert('æ‰¹æ¬¡å…¥åº«å¤±æ•—ï¼š' + e.message);
            }
        }

        async function handleUnifiedScan(e) {
            if(e.key === 'Enter') {
                const barcode = e.target.value.trim();
                const mode = document.getElementById('in-category').value;
                if (mode === 'Return') {
                    try {
                        const q = window.query(window.collection(window.db, "pallets"), window.where("palletId", "==", barcode));
                        const snap = await window.getDocs(q);
                        if(!snap.empty) {
                            const data = snap.docs[0].data();
                            document.getElementById('in-parent-id').value = data.palletId;
                            document.getElementById('in-name').value = data.productName + " (é¤˜æ–™)";
                            document.getElementById('in-spec').value = data.spec;
                            document.getElementById('in-batch').value = data.batchNo; document.getElementById('in-batch').readOnly = true;
                            document.getElementById('in-exp').value = data.expiryDate; document.getElementById('in-exp').readOnly = true;
                            document.getElementById('in-barcode').value = "RET-" + Date.now();
                            document.getElementById('in-qty').focus();
                            alert("ğŸ“¦ è®€å–åŸæ–™æˆåŠŸï¼");
                        } else { alert("âŒ æŸ¥ç„¡æ­¤æ¨™ç±¤"); }
                    } catch(err) { console.error(err); }
                } else {
                    try {
                        // V47 ç¶å®šé‚è¼¯
                        const palletID = document.getElementById('in-pallet-id').value;
                        const snap = await window.getDocs(window.query(window.collection(window.db, "pallets"), window.where("palletId", "==", barcode)));
                        if(!snap.empty) {
                            const data = snap.docs[0].data();
                            document.getElementById('in-name').value = data.productName;
                            document.getElementById('in-spec').value = data.spec||"";
                            document.getElementById('in-batch').value = data.batchNo;
                            document.getElementById('in-qty').value = data.quantity;
                            document.getElementById('in-exp').value = data.expiryDate;
                            alert("ğŸ“¦ æƒæåˆ°èˆŠè²¨ï¼");
                        } else { document.getElementById('in-name').focus(); if(!document.getElementById('in-batch').value) document.getElementById('in-batch').value = "B"+new Date().toISOString().slice(0,10).replace(/-/g,""); }
                        renderMapUI('grid-I-A-map'); 
                    } catch(err) { console.error(err); }
                }
            }
        }
        
        function generateInternalBarcode() { document.getElementById('in-barcode').value = "INT-"+Date.now(); document.getElementById('in-name').focus(); }
        
        // V50 å³æ™‚é è¦½æ›´æ–°
        function updateLivePreview() {
            document.getElementById('prev-name').innerText = document.getElementById('in-name').value || '-';
            document.getElementById('prev-spec').innerText = document.getElementById('in-spec').value || '-';
            document.getElementById('prev-batch').innerText = document.getElementById('in-batch').value || '-';
            document.getElementById('prev-qty').innerText = document.getElementById('in-qty').value || '0';
            document.getElementById('prev-vendor').innerText = document.getElementById('in-vendor') ? document.getElementById('in-vendor').value : '-';
        }

        async function confirmUnifiedInbound() {
             var loc = document.getElementById('in-loc').value;
             var sheetId = document.getElementById('in-sheet-id').value;
             var palletId = document.getElementById('in-pallet-id') ? document.getElementById('in-pallet-id').value : '';
             var finalID = sheetId || palletId;

             if(!loc) { alert("âŒ è«‹å…ˆé¸å„²ä½"); return; }
             if(!finalID) { alert("âŒ è«‹è¼¸å…¥æ’å–®ç·¨è™Ÿ"); return; }
             if(!document.getElementById('in-name').value) { alert("âŒ è«‹å¡«å¯«å“å"); return; }
             if(!document.getElementById('in-qty').value) { alert("âŒ è«‹å¡«å¯«æ•¸é‡"); return; }

             try {
                await window.addDoc(window.collection(window.db, "pallets"), {
                    palletId: finalID,
                    sheetId: sheetId,
                    contentId: sheetId,
                    productName: document.getElementById('in-name').value,
                    spec: document.getElementById('in-spec').value || '',
                    batchNo: document.getElementById('in-batch') ? document.getElementById('in-batch').value : '',
                    expiryDate: document.getElementById('in-exp') ? document.getElementById('in-exp').value : '',
                    quantity: parseInt(document.getElementById('in-qty').value) || 0,
                    locationId: loc,
                    category: document.getElementById('in-category').value,
                    inboundDate: new Date(), 
                    status: "Available",
                    vendor: document.getElementById('in-vendor') ? document.getElementById('in-vendor').value : '',
                    workOrder: document.getElementById('in-wo') ? document.getElementById('in-wo').value : '',
                    totalWeight: 0,
                    source: 'Inbound'
                });
                alert("âœ… å…¥åº«æˆåŠŸï¼");
                
                setTimeout(function() {
                    var shouldPreview = document.getElementById('preview-pallet-tag') && document.getElementById('preview-pallet-tag').checked;
                    if(shouldPreview) {
                        var data = {
                            vendor: document.getElementById('in-vendor') ? document.getElementById('in-vendor').value : '',
                            productName: document.getElementById('in-name').value,
                            spec: document.getElementById('in-spec').value || '',
                            batchNo: document.getElementById('in-batch') ? document.getElementById('in-batch').value : '',
                            qty: document.getElementById('in-qty').value,
                            loc: loc,
                            barcode: finalID
                        };
                        printAutoLabel(data);
                    }
                }, 500);

                if(!document.getElementById('lock-mode').checked) { 
                    document.getElementById('in-sheet-id').value = ''; 
                    document.getElementById('in-loc').value = '';
                    document.getElementById('in-name').value = '';
                    document.getElementById('in-spec').value = '';
                    document.getElementById('in-qty').value = '';
                }
             } catch(e) { 
                 console.error('å…¥åº«éŒ¯èª¤:', e);
                 alert("éŒ¯èª¤: " + e.message); 
             }
        }

        // V49/50 è‡ªå‹•åˆ—å°å‡½å¼
        function printAutoLabel(d) {
            var area = document.getElementById('print-area');
            area.innerHTML = '<div class="print-page">' +
                '<div class="print-header" style="font-size:28px; text-align:center; border-bottom:3px solid #000; padding-bottom:10px; margin-bottom:20px;">å…¥åº«æ¨™ç±¤</div>' +
                '<div style="text-align:center; margin:20px 0; padding:20px; background:#0066cc; border-radius:10px;">' +
                '<div style="font-size:18px; color:#fff; margin-bottom:5px;">å„²ä½</div>' +
                '<div style="font-size:48px; font-weight:900; color:#fff; letter-spacing:3px;">' + d.loc + '</div>' +
                '</div>' +
                '<div class="print-row" style="text-align:center; margin:15px 0;"><span class="print-label" style="font-size:16px;">å“åï¼š</span><span class="print-val" style="font-size:26px; font-weight:900;">' + d.productName + '</span></div>' +
                (d.spec ? '<div class="print-row" style="text-align:center; margin:10px 0;"><span class="print-label" style="font-size:14px;">è¦æ ¼ï¼š</span><span class="print-val" style="font-size:18px;">' + d.spec + '</span></div>' : '') +
                (d.batchNo ? '<div class="print-row" style="text-align:center; margin:10px 0;"><span class="print-label" style="font-size:14px;">æ‰¹è™Ÿï¼š</span><span class="print-val" style="font-size:18px;">' + d.batchNo + '</span></div>' : '') +
                (d.vendor ? '<div class="print-row" style="text-align:center; margin:10px 0;"><span class="print-label" style="font-size:14px;">å» å•†ï¼š</span><span class="print-val" style="font-size:18px;">' + d.vendor + '</span></div>' : '') +
                '<div style="text-align:center; margin:25px 0; padding:20px; background:#f8f8f8; border:3px solid #333; border-radius:10px;">' +
                '<div style="font-size:64px; font-weight:900; color:#000; line-height:1;">' + d.qty + '</div>' +
                '<div style="font-size:24px; font-weight:700; color:#333; margin-top:8px;">ä»¶æ•¸ (PCS)</div>' +
                '</div>' +
                '<div class="print-footer" style="text-align:center; margin-top:15px;"><svg id="bc-print"></svg></div>' +
                '</div>';
            JsBarcode("#bc-print", d.barcode, {format: "CODE128", height:60, displayValue:true, fontSize:20, fontOptions:"bold"});
            area.classList.remove('hidden');
            setTimeout(function() { 
                window.print(); 
                setTimeout(function() { area.classList.add('hidden'); }, 500);
            }, 300);
        }

        function handleExcelImport(e) { const file = e.target.files[0]; const reader = new FileReader(); reader.onload = function(evt) { const wb = XLSX.read(evt.target.result, {type:'array'}); const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]); processOrders(json); }; reader.readAsArrayBuffer(file); e.target.value = ''; }
        async function processOrders(json) { const batch = window.writeBatch(window.db); const orders = {}; json.forEach(row => { const oid = row['å–®è™Ÿ']||row['OrderNo']; if(!oid) return; if(!orders[oid]) orders[oid] = { orderId:oid, customer:row['å®¢æˆ¶']||'Unknown', carrier:row['ç‰©æµ']||'è‡ªå–', status:'Pending', items:[] }; orders[oid].items.push({ productId:row['å“è™Ÿ'], productName:row['å“å'], qty:row['æ•¸é‡'], spec:row['è¦æ ¼']||'' }); }); Object.values(orders).forEach(o => batch.set(window.doc(window.db, "shippingOrders", o.orderId), o)); await batch.commit(); alert("è¨‚å–®åŒ¯å…¥æˆåŠŸï¼"); }
        function renderShippingList() { const tbody = document.getElementById('shipping-list-body'); const filter = document.getElementById('filter-carrier').value; const carriers = new Set(); tbody.innerHTML = ''; window.currentOrders().forEach(o => { carriers.add(o.carrier); if(filter !== 'ALL' && o.carrier !== filter) return; let badge = 'bg-slate-700 text-slate-300'; if(o.carrier.includes('é»‘è²“')) badge = 'bg-black text-white border border-slate-600'; tbody.innerHTML += `<tr class="border-b border-slate-700 hover:bg-slate-800"><td class="p-3"><span class="px-2 py-1 rounded text-[10px] ${badge}">${o.carrier}</span></td><td class="font-mono text-white p-3 font-bold">${o.orderId}</td><td class="p-3">${o.customer}</td><td class="p-3 text-slate-400 text-xs">${o.items.map(i=>i.productName+'('+i.spec+')').join(', ').substring(0,30)}...</td><td class="p-3"><span class="badge ${o.status==='Shipped'?'badge-green':'badge-blue'}">${o.status}</span></td><td class="p-3 text-right"><button class="text-slate-400 hover:text-white"><i class="fa-solid fa-box-open"></i></button></td></tr>`; }); const select = document.getElementById('filter-carrier'); if(select.options.length <= 1) carriers.forEach(c => { const opt = document.createElement('option'); opt.value = c; opt.innerText = c; select.appendChild(opt); }); }
        function filterShippingList() { renderShippingList(); }
        function handleStockImport(e) { const file = e.target.files[0]; const reader = new FileReader(); reader.onload = function(evt) { const wb = XLSX.read(evt.target.result, {type:'array'}); const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]); if(confirm(`åŒ¯å…¥ ${json.length} ç­†ï¼Ÿ`)) { const batch = window.writeBatch(window.db); json.forEach((r,i) => { const ref = window.doc(window.collection(window.db, "pallets")); batch.set(ref, { palletId:r['æ¢ç¢¼']||`OLD-${i}`, productName:r['å“å'], spec:r['è¦æ ¼']||'', quantity:r['æ•¸é‡'], locationId:"INIT-STAGE", status:"Available", inboundDate:new Date(), source:"Opening" }); }); batch.commit().then(() => alert("é–‹å¸³æˆåŠŸ")); } }; reader.readAsArrayBuffer(file); e.target.value = ''; }
        function handlePreInboundImport(e) { const file = e.target.files[0]; const reader = new FileReader(); reader.onload = function(evt) { const wb = XLSX.read(evt.target.result, {type:'array'}); const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]); if(confirm(`åŒ¯å…¥ ${json.length} ç­†ï¼Ÿ`)) { const batch = window.writeBatch(window.db); json.forEach((r,i) => { const pid = `PRE-${Date.now()}-${i}`; batch.set(window.doc(window.collection(window.db, "pallets"), pid), { palletId:pid, vendor:r['å» å•†']||'', productName:r['å“å'], spec:r['è¦æ ¼']||'', batchNo:r['æ‰¹è™Ÿ']||'', quantity:r['æ•¸é‡'], locationId:"VIRTUAL-DOCK", status:"Planned", inboundDate:new Date() }); }); batch.commit().then(() => alert("åŒ¯å…¥æˆåŠŸ")); } }; reader.readAsArrayBuffer(file); }
        function generatePlan() { 
            const count = document.getElementById('pre-count').value; const name = document.getElementById('pre-name').value; const spec = document.getElementById('pre-spec').value; const batch = document.getElementById('pre-batch').value; const vendor = document.getElementById('pre-vendor').value;
            const area = document.getElementById('preview-area'); area.innerHTML = '';
            document.getElementById('btn-print').disabled = false; document.getElementById('btn-print').classList.remove('cursor-not-allowed', 'bg-slate-700'); document.getElementById('btn-print').classList.add('bg-blue-600', 'text-white');
            for(let i=1; i<=count; i++) { const code = `PRE-${batch}-${i}`; area.innerHTML += `<div class="bg-white p-3 rounded text-black text-xs border border-slate-300"><div class="font-bold text-sm">${name}</div><div>è¦æ ¼: ${spec}</div><div>æ‰¹è™Ÿ: ${batch}</div><div>${vendor}</div><svg id="bc-${i}" class="w-full h-10 mt-1"></svg></div>`; setTimeout(() => JsBarcode(`#bc-${i}`, code, {format:"CODE128", height:30, displayValue:true}), 100); }
        }
        function printLabels() { window.print(); }
        
        window.deletePallet = async function(id) { if(confirm("ç¢ºå®šåˆªé™¤æ­¤åº«å­˜ï¼Ÿ")) await window.deleteDoc(window.doc(window.db, "pallets", id)); }
        window.clearLane = async function(zone, row) { if(!confirm(`âš ï¸ è­¦å‘Šï¼šç¢ºå®šæ¸…ç©º [${zone} ç¬¬ ${row} è¡Œ]ï¼Ÿ`)) return; const q = window.query(window.collection(window.db, "pallets"), window.where("locationId", ">=", `${zone}-${row < 10 ? '0'+row : row}`), window.where("locationId", "<=", `${zone}-${row < 10 ? '0'+row : row}\uf8ff`)); const snap = await window.getDocs(q); const batch = window.writeBatch(window.db); snap.forEach(doc => batch.delete(doc.ref)); await batch.commit(); alert("å··é“å·²æ¸…ç©º"); }

        function filterInventory() {
            const term = document.getElementById('global-search').value.toLowerCase();
            document.querySelectorAll('#inventory-list-body tr').forEach(row => { row.style.display = row.innerText.toLowerCase().includes(term) ? '' : 'none'; });
        }
        function downloadTemplate(type) {
            let data = [];
            if(type==='stock') data = [{å“å:'é­·é­š', æ•¸é‡:50, è¦æ ¼:'300/400', æ‰¹è™Ÿ:'B123', æœ‰æ•ˆæ—¥æœŸ:'2025-12-01'}];
            if(type==='pre') data = [{å» å•†:'æµ·ç¥', å“å:'é®­é­š', æ•¸é‡:20, è¦æ ¼:'åˆ‡ç‰‡', æ‰¹è™Ÿ:'B456', æœ‰æ•ˆæ—¥æœŸ:'2025-11-01', é è¨ˆæ¿æ•¸:5, æ¯æ¿æ•¸é‡:50}];
            if(type==='order') data = [{å–®è™Ÿ:'DO-001', å®¢æˆ¶:'æµ·éœ¸ç‹', å“å:'é­·é­š', è¦æ ¼:'300/400', æ•¸é‡:10, æ‰¹è™Ÿ:'B20241209-001', å‚™è¨»:'æ€¥ä»¶', ç‰©æµ:'é»‘è²“'}];
            const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Template"); XLSX.writeFile(wb, `${type}_template.xlsx`);
        }


        window.setInboundMode = function(mode) {
            const elem = document.getElementById('in-category');
            if (elem) elem.value = mode;
            ['raw', 'fg', 'wip', 'ret'].forEach(m => {
                const btn = document.getElementById('btn-mode-' + m);
                if (btn) btn.classList.remove('active-raw', 'active-fg', 'active-wip', 'active-ret');
            });
            const activeBtn = document.getElementById('btn-mode-' + mode.toLowerCase());
            if (activeBtn) activeBtn.classList.add('active-' + mode.toLowerCase());
        };
        // åˆå§‹åŒ–

        // è‡ªå‹•è³¦ç¢¼åŠŸèƒ½
        window.generateSheetId = function() {
            const date = new Date();
            const year = date.getFullYear().toString().slice(-2);
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            const random = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
            return 'PRE-' + year + month + day + '-' + random;
        };
        
        window.autoFillBarcode = function() {
            const sheetInput = document.getElementById('in-sheet-id');
            
            if (sheetInput && !sheetInput.value) {
                sheetInput.value = window.generateSheetId();
                alert('âœ… å·²ç”Ÿæˆæ’å–®ç·¨è™Ÿï¼š' + sheetInput.value + '\n\nè«‹å°‡æ­¤ç·¨è™Ÿåˆ—å°è²¼åœ¨æ£§æ¿ä¸Š');
            } else if (sheetInput && sheetInput.value) {
                alert('âš ï¸ æ’å–®ç·¨è™Ÿå·²å­˜åœ¨ï¼š' + sheetInput.value);
            }
        };


        // ===== ç°¡åŒ–ç‰ˆæ¿è™Ÿç§»å‹•åŠŸèƒ½ =====
        
        // å…¨å±€è®Šé‡
        window.selectedPallet = null;
        window.currentFilter = '';
        
        // æ¸²æŸ“å„²ä½åˆ—è¡¨
        window.renderPalletList = function() {
            var container = document.getElementById('pallet-list');
            if (!container) return;
            
            var inventory = window.currentInventory ? window.currentInventory() : [];
            var filtered = window.currentFilter 
                ? inventory.filter(function(item) { return item.productName === window.currentFilter; })
                : inventory;
            
            if (filtered.length === 0) {
                container.innerHTML = '<div class="text-center text-slate-400 py-8">ç„¡å„²ä½è³‡æ–™</div>';
                return;
            }
            
            // æŒ‰å€åŸŸåˆ†çµ„
            var zones = { 'I-A': [], 'I-B': [], 'J-C': [], 'J-D': [] };
            filtered.forEach(function(item) {
                var parts = item.locationId.split('-');
                if (parts.length >= 2) {
                    var zone = parts[0] + '-' + parts[1];
                    if (zones[zone]) zones[zone].push(item);
                }
            });
            
            var zoneNames = { 'I-A': 'Aå€', 'I-B': 'Bå€', 'J-C': 'Cå€', 'J-D': 'Då€' };
            var html = '';
            
            for (var zoneKey in zones) {
                var items = zones[zoneKey];
                if (items.length === 0 && window.currentFilter) continue;
                
                html += '<div class="mb-3 border border-slate-600 rounded">';
                html += '<div class="bg-slate-800 px-3 py-2 font-bold text-white">' + zoneNames[zoneKey] + '</div>';
                
                if (items.length === 0) {
                    html += '<div class="p-3 text-slate-500 text-sm">æ­¤å€ç„¡å„²ä½</div>';
                } else {
                    items.forEach(function(item) {
                        var bg = 'bg-blue-900/30 border-blue-500';
                        if (item.category === 'FG') bg = 'bg-green-900/30 border-green-500';
                        if (item.category === 'WIP') bg = 'bg-yellow-900/30 border-yellow-500';
                        
                        html += '<div class="' + bg + ' border m-2 p-2 rounded cursor-pointer hover:bg-opacity-70" ';
                        html += 'onclick="selectPallet(\'' + item.id + '\', \'' + item.locationId + '\', \'' + item.productName + '\', ' + (item.quantity || 0) + ')">';
                        html += '<div class="flex justify-between items-start">';
                        html += '<div><div class="text-white font-bold">' + item.locationId + '</div>';
                        html += '<div class="text-slate-300 text-sm">' + item.productName + '</div></div>';
                        html += '<div class="text-white font-bold text-lg">' + (item.quantity || 0) + ' ä»¶</div>';
                        html += '</div>';
                        html += '<div class="text-xs text-slate-400 mt-1">æ¿è™Ÿ: ' + item.palletId + '</div>';
                        html += '</div>';
                    });
                }
                html += '</div>';
            }
            
            container.innerHTML = html;
        };
        
        // é¸æ“‡æ£§æ¿
        window.selectPallet = function(id, location, product, quantity) {
            window.selectedPallet = { id: id, location: location, product: product, quantity: quantity };
            
            var panel = document.getElementById('operation-panel');
            if (!panel) return;
            
            var inventory = window.currentInventory ? window.currentInventory() : [];
            var sameProduct = inventory.filter(function(item) {
                return item.productName === product && item.id !== id;
            });
            
            var html = '<div class="space-y-3">';
            html += '<div class="bg-slate-900 border border-slate-700 rounded p-3">';
            html += '<div class="text-xs text-slate-400 mb-2">å·²é¸æ“‡ï¼š</div>';
            html += '<div class="text-white font-bold">' + location + '</div>';
            html += '<div class="text-slate-300">' + product + '</div>';
            html += '<div class="text-white font-bold text-lg">' + quantity + ' ä»¶</div>';
            html += '</div>';
            
            html += '<div><div class="text-white font-bold text-sm mb-2">è«‹é¸æ“‡æ“ä½œï¼š</div>';
            html += '<button onclick="showMoveOptions()" class="w-full p-3 bg-emerald-700 text-white rounded mb-2 hover:bg-emerald-600">';
            html += '<i class="fa-solid fa-arrow-right mr-2"></i>ç§»å‹•åˆ°å…¶ä»–å„²ä½</button>';
            
            if (sameProduct.length > 0) {
                html += '<button onclick="showMergeOptions()" class="w-full p-3 bg-yellow-700 text-white rounded hover:bg-yellow-600">';
                html += '<i class="fa-solid fa-layer-group mr-2"></i>åˆä½µï¼ˆæ‰¾åˆ° ' + sameProduct.length + ' å€‹ç›¸åŒå“åï¼‰</button>';
            }
            html += '</div></div>';
            
            panel.innerHTML = html;
        };
        
        // é¡¯ç¤ºç§»å‹•é¸é …
        window.showMoveOptions = function() {
            var panel = document.getElementById('operation-panel');
            if (!panel) return;
            
            var html = '<div class="space-y-2">';
            html += '<button onclick="selectPallet(null)" class="text-sm text-blue-400 hover:text-blue-300">';
            html += '<i class="fa-solid fa-arrow-left mr-1"></i>è¿”å›</button>';
            html += '<div class="text-white font-bold mb-2">è¼¸å…¥ç›®æ¨™å„²ä½ï¼š</div>';
            html += '<input type="text" id="target-location" class="w-full p-2 bg-slate-800 text-white rounded border border-slate-600" ';
            html += 'placeholder="ä¾‹å¦‚: I-A-05-2F">';
            html += '<button onclick="executeMove()" class="w-full p-3 bg-blue-600 text-white rounded hover:bg-blue-500 mt-3">';
            html += 'ç¢ºèªç§»å‹•</button>';
            html += '</div>';
            
            panel.innerHTML = html;
        };
        
        // é¡¯ç¤ºåˆä½µé¸é …
        window.showMergeOptions = function() {
            var panel = document.getElementById('operation-panel');
            if (!panel) return;
            
            var source = window.selectedPallet;
            var inventory = window.currentInventory ? window.currentInventory() : [];
            var targets = inventory.filter(function(item) {
                return item.productName === source.product && item.id !== source.id;
            });
            
            var html = '<div class="space-y-2">';
            html += '<button onclick="selectPallet(null)" class="text-sm text-blue-400 hover:text-blue-300">';
            html += '<i class="fa-solid fa-arrow-left mr-1"></i>è¿”å›</button>';
            html += '<div class="text-white font-bold mb-2">é¸æ“‡åˆä½µç›®æ¨™ï¼š</div>';
            
            targets.forEach(function(target) {
                html += '<div class="p-2 bg-slate-800 border border-slate-600 rounded cursor-pointer hover:border-yellow-500" ';
                html += 'onclick="executeMerge(\'' + target.id + '\', ' + (target.quantity || 0) + ')">';
                html += '<div class="flex justify-between">';
                html += '<div class="text-white">' + target.locationId + '</div>';
                html += '<div class="text-white font-bold">' + (target.quantity || 0) + ' ä»¶</div>';
                html += '</div>';
                html += '<div class="text-xs text-green-400 mt-1">åˆä½µå¾Œ: ' + (source.quantity + (target.quantity || 0)) + ' ä»¶</div>';
                html += '</div>';
            });
            
            html += '</div>';
            panel.innerHTML = html;
        };
        
        // åŸ·è¡Œç§»å‹•
        window.executeMove = async function() {
            var source = window.selectedPallet;
            var targetLoc = document.getElementById('target-location');
            if (!source || !targetLoc || !targetLoc.value) {
                alert('è«‹è¼¸å…¥ç›®æ¨™å„²ä½');
                return;
            }
            
            var newLoc = targetLoc.value.trim();
            if (!confirm('ç¢ºå®šå°‡ ' + source.location + ' ç§»å‹•åˆ° ' + newLoc + 'ï¼Ÿ')) return;
            
            try {
                await window.updateDoc(window.doc(window.db, "pallets", source.id), { locationId: newLoc });
                alert('âœ… ç§»å‹•æˆåŠŸï¼');
                window.selectedPallet = null;
                renderPalletList();
                document.getElementById('operation-panel').innerHTML = '<div class="text-center text-slate-400 py-8">è«‹é¸æ“‡æ£§æ¿</div>';
            } catch (err) {
                console.error(err);
                alert('âŒ ç§»å‹•å¤±æ•—: ' + err.message);
            }
        };
        
        // åŸ·è¡Œåˆä½µ
        window.executeMerge = async function(targetId, targetQty) {
            var source = window.selectedPallet;
            if (!source) return;
            
            var totalQty = source.quantity + targetQty;
            if (!confirm('ç¢ºå®šåˆä½µï¼Ÿ\nåˆä½µå¾Œç¸½æ•¸: ' + totalQty + ' ä»¶')) return;
            
            try {
                var batch = window.writeBatch(window.db);
                batch.update(window.doc(window.db, "pallets", targetId), { quantity: totalQty });
                batch.delete(window.doc(window.db, "pallets", source.id));
                await batch.commit();
                alert('âœ… åˆä½µæˆåŠŸï¼');
                window.selectedPallet = null;
                renderPalletList();
                document.getElementById('operation-panel').innerHTML = '<div class="text-center text-slate-400 py-8">è«‹é¸æ“‡æ£§æ¿</div>';
            } catch (err) {
                console.error(err);
                alert('âŒ åˆä½µå¤±æ•—: ' + err.message);
            }
        };
        
        // æ›´æ–°å“åé¸æ“‡å™¨
        window.updateProductFilter = function() {
            var select = document.getElementById('product-filter');
            if (!select) return;
            
            var inventory = window.currentInventory ? window.currentInventory() : [];
            var products = {};
            inventory.forEach(function(item) {
                if (item.productName) products[item.productName] = true;
            });
            
            var html = '<option value="">-- å…¨éƒ¨é¡¯ç¤º --</option>';
            Object.keys(products).sort().forEach(function(name) {
                html += '<option value="' + name + '">' + name + '</option>';
            });
            select.innerHTML = html;
        };
        
        // å“åç¯©é¸
        window.filterByProduct = function() {
            var select = document.getElementById('product-filter');
            window.currentFilter = select ? select.value : '';
            renderPalletList();
        };

        // ===== æ™ºèƒ½èª¿åº¦ç³»çµ± v4 =====
        
        // å…¨å±€è®Šé‡
        window.dispatchTasks = [];
        window.selectedProduct = null;
        window.analysisData = null;
        
        // 1ï¸âƒ£ æ™ºèƒ½åˆ†æå¼•æ“
        window.analyzeDispersion = function() {
            var inventory = window.currentInventory ? window.currentInventory() : [];
            
            // æŒ‰å“ååˆ†çµ„
            var productGroups = {};
            inventory.forEach(function(item) {
                var name = item.productName;
                if (!productGroups[name]) {
                    productGroups[name] = [];
                }
                productGroups[name].push(item);
            });
            
            // è¨ˆç®—æ•£äº‚åº¦
            var analysis = [];
            for (var name in productGroups) {
                var items = productGroups[name];
                if (items.length < 2) continue; // åªåˆ†ææœ‰å¤šå€‹å„²ä½çš„
                
                var totalQty = 0;
                items.forEach(function(item) {
                    totalQty += (item.quantity || 0);
                });
                
                var avgQty = totalQty / items.length;
                var dispersionScore = items.length * 100 / avgQty; // æ•£äº‚åº¦åˆ†æ•¸
                
                analysis.push({
                    productName: name,
                    locationCount: items.length,
                    totalQty: totalQty,
                    avgQty: Math.round(avgQty),
                    dispersionScore: dispersionScore,
                    items: items
                });
            }
            
            // æŒ‰æ•£äº‚åº¦æ’åºï¼ˆè¶Šæ•£è¶Šå‰é¢ï¼‰
            analysis.sort(function(a, b) {
                return b.locationCount - a.locationCount;
            });
            
            window.analysisData = analysis;
            return analysis;
        };
        
        // 2ï¸âƒ£ æ¸²æŸ“æ•£äº‚åº¦æ’è¡Œ
        window.renderDispersionRanking = function() {
            var container = document.getElementById('dispersion-ranking');
            if (!container) return;
            
            var analysis = window.analyzeDispersion();
            
            if (analysis.length === 0) {
                container.innerHTML = '<div class="text-slate-400 text-sm p-3">ç„¡éœ€èª¿åº¦çš„å“å</div>';
                return;
            }
            
            var html = '';
            analysis.forEach(function(item, index) {
                var priority = 'ğŸ”´';
                var bgColor = 'bg-red-900/20 border-red-600';
                if (item.locationCount === 3) {
                    priority = 'ğŸŸ¡';
                    bgColor = 'bg-yellow-900/20 border-yellow-600';
                } else if (item.locationCount === 2) {
                    priority = 'ğŸŸ¢';
                    bgColor = 'bg-green-900/20 border-green-600';
                }
                
                html += '<div class="' + bgColor + ' border rounded p-3 mb-2 cursor-pointer hover:bg-opacity-40" ';
                html += 'onclick="selectProductForDispatch(\'' + item.productName + '\')">';
                html += '<div class="flex justify-between items-start mb-1">';
                html += '<div class="text-white font-bold">' + priority + ' ' + item.productName + '</div>';
                html += '<div class="text-xs text-slate-400">#' + (index + 1) + '</div>';
                html += '</div>';
                html += '<div class="text-sm text-slate-300">åˆ†æ•£åœ¨ <span class="text-yellow-400 font-bold">' + item.locationCount + '</span> å€‹å„²ä½</div>';
                html += '<div class="text-sm text-slate-300">ç¸½è¨ˆ <span class="text-white font-bold">' + item.totalQty + '</span> ä»¶</div>';
                html += '<div class="text-xs text-slate-400 mt-1">å¹³å‡ ' + item.avgQty + ' ä»¶/ä½</div>';
                html += '</div>';
            });
            
            container.innerHTML = html;
        };
        
        // 3ï¸âƒ£ é¸æ“‡å“åä¸¦ç”Ÿæˆå»ºè­°
        window.selectProductForDispatch = function(productName) {
            window.selectedProduct = productName;
            
            // æ‰¾åˆ°åˆ†ææ•¸æ“š
            var data = window.analysisData.find(function(item) {
                return item.productName === productName;
            });
            
            if (!data) return;
            
            // æ›´æ–°çµ±è¨ˆé¢æ¿
            renderProductStats(data);
            
            // ç”Ÿæˆæ™ºèƒ½å»ºè­°
            var suggestion = generateSmartSuggestion(data);
            
            // æ¸²æŸ“è¦–è¦ºåŒ–åœ°åœ–
            renderVisualMap(data, suggestion);
        };
        
        // 4ï¸âƒ£ æ¸²æŸ“å“åçµ±è¨ˆ
        window.renderProductStats = function(data) {
            var container = document.getElementById('product-stats');
            if (!container) return;
            
            // çµ±è¨ˆåˆ†ä½ˆ
            var distribution = {};
            data.items.forEach(function(item) {
                var zone = item.locationId.split('-')[1]; // A, B, C, D
                if (!distribution[zone]) distribution[zone] = 0;
                distribution[zone]++;
            });
            
            var distText = '';
            for (var zone in distribution) {
                distText += zone + 'å€:' + distribution[zone] + ' ';
            }
            
            var html = '<div class="bg-slate-800 border border-slate-600 rounded p-3">';
            html += '<div class="text-white font-bold mb-2">ğŸ“Š ' + data.productName + ' çµ±è¨ˆ</div>';
            html += '<div class="text-sm text-slate-300 space-y-1">';
            html += '<div>â€¢ ç¸½æ•¸é‡: <span class="text-white font-bold">' + data.totalQty + '</span> ä»¶</div>';
            html += '<div>â€¢ å„²ä½æ•¸: <span class="text-yellow-400 font-bold">' + data.locationCount + '</span> å€‹</div>';
            html += '<div>â€¢ å¹³å‡: <span class="text-white font-bold">' + data.avgQty + '</span> ä»¶/ä½</div>';
            html += '<div>â€¢ åˆ†ä½ˆ: <span class="text-blue-400">' + distText + '</span></div>';
            html += '</div></div>';
            
            container.innerHTML = html;
        };
        
        // 5ï¸âƒ£ ç”Ÿæˆæ™ºèƒ½å»ºè­°
        window.generateSmartSuggestion = function(data) {
            // æŒ‰æ•¸é‡æ’åºï¼ˆå¤šçš„ä¿ç•™ï¼Œå°‘çš„ç§»èµ°ï¼‰
            var sorted = data.items.slice().sort(function(a, b) {
                return (b.quantity || 0) - (a.quantity || 0);
            });
            
            // ä¿ç•™å‰ 2 å€‹ï¼ˆæ•¸é‡æœ€å¤šçš„ï¼‰
            var keepItems = sorted.slice(0, 2);
            var moveItems = sorted.slice(2);
            
            // æ±ºå®šç§»å‹•ç›®æ¨™
            var suggestions = [];
            moveItems.forEach(function(moveItem) {
                // æ‰¾æœ€è¿‘çš„ä¿ç•™ä½
                var target = keepItems[0]; // ç°¡åŒ–ï¼šç§»åˆ°æ•¸é‡æœ€å¤šçš„é‚£å€‹
                
                suggestions.push({
                    from: moveItem,
                    to: target,
                    quantity: moveItem.quantity || 0
                });
            });
            
            return {
                keep: keepItems,
                move: moveItems,
                suggestions: suggestions,
                freedSpaces: moveItems.length
            };
        };
        
        // 6ï¸âƒ£ æ¸²æŸ“è¦–è¦ºåŒ–åœ°åœ–
        window.renderVisualMap = function(data, suggestion) {
            var container = document.getElementById('visual-map');
            if (!container) return;
            
            var html = '<div class="space-y-3">';
            
            // æ¨™é¡Œ
            html += '<div class="text-white font-bold mb-3">ğŸ“ èª¿åº¦æ–¹æ¡ˆé è¦½</div>';
            
            // ä¿ç•™çš„å„²ä½ï¼ˆç¶ è‰²ï¼‰
            html += '<div class="mb-3"><div class="text-green-400 text-sm font-bold mb-2">âœ… å»ºè­°ä¿ç•™ï¼ˆ' + suggestion.keep.length + 'ï¼‰</div>';
            suggestion.keep.forEach(function(item) {
                html += '<div class="bg-green-900/30 border border-green-600 rounded p-2 mb-1">';
                html += '<div class="flex justify-between">';
                html += '<div class="text-white font-bold">' + item.locationId + '</div>';
                html += '<div class="text-white">' + (item.quantity || 0) + ' ä»¶</div>';
                html += '</div>';
                html += '<div class="text-xs text-green-300">ğŸŸ© ä¿ç•™æ­¤å„²ä½</div>';
                html += '</div>';
            });
            html += '</div>';
            
            // ç§»å‹•çš„å„²ä½ï¼ˆé»ƒè‰²ï¼‰
            html += '<div class="mb-3"><div class="text-yellow-400 text-sm font-bold mb-2">ğŸ“¦ å»ºè­°ç§»å‹•ï¼ˆ' + suggestion.move.length + 'ï¼‰</div>';
            suggestion.suggestions.forEach(function(sug) {
                html += '<div class="bg-yellow-900/30 border border-yellow-600 rounded p-2 mb-1">';
                html += '<div class="flex justify-between items-start">';
                html += '<div>';
                html += '<div class="text-white font-bold">' + sug.from.locationId + '</div>';
                html += '<div class="text-xs text-yellow-300">ğŸŸ¨ ç§»å‹• ' + sug.quantity + ' ä»¶</div>';
                html += '</div>';
                html += '<div class="text-slate-300">â†’</div>';
                html += '<div class="text-right">';
                html += '<div class="text-white font-bold">' + sug.to.locationId + '</div>';
                html += '<div class="text-xs text-green-300">ğŸŸ© åˆä½µåˆ°æ­¤</div>';
                html += '</div>';
                html += '</div>';
                html += '</div>';
            });
            html += '</div>';
            
            // æ•ˆæœé è¦½
            html += '<div class="bg-blue-900/30 border border-blue-600 rounded p-3">';
            html += '<div class="text-blue-400 font-bold mb-2">ğŸ“ˆ é æœŸæ•ˆæœ</div>';
            html += '<div class="text-sm text-slate-300 space-y-1">';
            html += '<div>âœ… é‡‹æ”¾ <span class="text-yellow-400 font-bold">' + suggestion.freedSpaces + '</span> å€‹ç©ºä½</div>';
            html += '<div>âœ… æ¸›å°‘ <span class="text-green-400 font-bold">' + Math.round(suggestion.freedSpaces / data.locationCount * 100) + '%</span> å„²ä½ä½¿ç”¨</div>';
            html += '<div>âœ… éœ€è¦åŸ·è¡Œ <span class="text-white font-bold">' + suggestion.suggestions.length + '</span> æ¬¡ç§»å‹•</div>';
            html += '</div></div>';
            
            // æ“ä½œæŒ‰éˆ•
            html += '<div class="mt-4 flex gap-2">';
            html += '<button onclick="generateDispatchOrder()" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white py-2 px-4 rounded font-bold">';
            html += '<i class="fa-solid fa-file-lines mr-2"></i>ç”Ÿæˆèª¿åº¦å–®';
            html += '</button>';
            html += '<button onclick="cancelDispatch()" class="bg-slate-700 hover:bg-slate-600 text-white py-2 px-4 rounded">';
            html += 'å–æ¶ˆ';
            html += '</button>';
            html += '</div>';
            
            html += '</div>';
            
            container.innerHTML = html;
            
            // ä¿å­˜å»ºè­°ä¾›å¾ŒçºŒä½¿ç”¨
            window.currentSuggestion = suggestion;
        };
        

        // é è¦½èª¿åº¦å–®ï¼ˆæ›¿æ›åŸæœ¬çš„ç›´æ¥ç”Ÿæˆï¼‰
        window.generateDispatchOrder = function() {
            if (!window.currentSuggestion || !window.selectedProduct) {
                alert('è«‹å…ˆé¸æ“‡å“åä¸¦æŸ¥çœ‹å»ºè­°');
                return;
            }
            
            var suggestion = window.currentSuggestion;
            var product = window.selectedProduct;
            
            // ç”Ÿæˆé è¦½æ•¸æ“š
            var orderNo = 'DSP-' + Date.now().toString().slice(-6);
            var timestamp = new Date().toLocaleString('zh-TW');
            
            var tasks = [];
            suggestion.suggestions.forEach(function(sug, index) {
                tasks.push({
                    taskNo: index + 1,
                    fromLocation: sug.from.locationId,
                    fromPalletId: sug.from.palletId,
                    toLocation: sug.to.locationId,
                    quantity: sug.quantity,
                    status: 'pending'
                });
            });
            
            var previewData = {
                orderNo: orderNo,
                productName: product,
                createdAt: timestamp,
                tasks: tasks,
                totalTasks: tasks.length
            };
            
            // é¡¯ç¤ºé è¦½
            showDispatchPreview(previewData);
        };
        
        // é¡¯ç¤ºèª¿åº¦å–®é è¦½
        window.showDispatchPreview = function(previewData) {
            var modal = document.getElementById('dispatch-preview-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'dispatch-preview-modal';
                modal.className = 'fixed inset-0 bg-black/70 flex items-center justify-center z-50';
                document.body.appendChild(modal);
            }
            
            var html = '<div class="bg-slate-800 rounded-lg p-6 max-w-3xl w-full mx-4 max-h-[85vh] overflow-y-auto">';
            
            // æ¨™é¡Œ
            html += '<div class="flex justify-between items-start mb-4">';
            html += '<div>';
            html += '<h2 class="text-2xl font-bold text-white">ğŸ“‹ èª¿åº¦å–®é è¦½</h2>';
            html += '<div class="text-slate-400 text-sm mt-1">è«‹ç¢ºèªç„¡èª¤å¾Œå†ç”Ÿæˆæ­£å¼èª¿åº¦å–®</div>';
            html += '</div>';
            html += '<button onclick="closePreviewModal()" class="text-slate-400 hover:text-white text-2xl">&times;</button>';
            html += '</div>';
            
            // èª¿åº¦å–®è³‡è¨Š
            html += '<div class="bg-gradient-to-r from-blue-900 to-blue-800 border border-blue-600 rounded-lg p-4 mb-4">';
            html += '<div class="grid grid-cols-3 gap-4 text-sm">';
            html += '<div><div class="text-blue-300 mb-1">èª¿åº¦å–®ç·¨è™Ÿ</div><div class="text-white font-bold">' + previewData.orderNo + '</div></div>';
            html += '<div><div class="text-blue-300 mb-1">å“å</div><div class="text-white font-bold">' + previewData.productName + '</div></div>';
            html += '<div><div class="text-blue-300 mb-1">ç”Ÿæˆæ™‚é–“</div><div class="text-white font-bold">' + previewData.createdAt + '</div></div>';
            html += '</div></div>';
            
            // ä»»å‹™åˆ—è¡¨ï¼ˆå¯ç·¨è¼¯é è¦½ï¼‰
            html += '<div class="mb-4">';
            html += '<div class="flex justify-between items-center mb-3">';
            html += '<h3 class="text-white font-bold">ğŸ“¦ ä»»å‹™æ¸…å–®ï¼ˆå…± ' + previewData.totalTasks + ' é …ï¼‰</h3>';
            html += '<div class="text-xs text-slate-400">ğŸ’¡ æç¤ºï¼šå¯ä»¥èª¿æ•´åŸ·è¡Œé †åº</div>';
            html += '</div>';
            
            html += '<div class="space-y-2">';
            previewData.tasks.forEach(function(task, index) {
                html += '<div class="bg-slate-900 border border-slate-700 rounded-lg p-4 hover:border-blue-500 transition-all">';
                
                // ä»»å‹™ç·¨è™Ÿèˆ‡å„ªå…ˆç´š
                html += '<div class="flex justify-between items-start mb-3">';
                html += '<div class="flex items-center gap-3">';
                html += '<div class="bg-blue-900 text-blue-300 px-3 py-1 rounded font-bold text-sm">ä»»å‹™ ' + task.taskNo + '</div>';
                
                // èª¿æ•´é †åºæŒ‰éˆ•
                if (index > 0) {
                    html += '<button onclick="moveTaskUp(' + index + ')" class="text-slate-400 hover:text-white text-xs px-2 py-1 bg-slate-800 rounded" title="ä¸Šç§»">';
                    html += '<i class="fa-solid fa-arrow-up"></i></button>';
                }
                if (index < previewData.totalTasks - 1) {
                    html += '<button onclick="moveTaskDown(' + index + ')" class="text-slate-400 hover:text-white text-xs px-2 py-1 bg-slate-800 rounded" title="ä¸‹ç§»">';
                    html += '<i class="fa-solid fa-arrow-down"></i></button>';
                }
                html += '</div>';
                
                // åˆªé™¤æŒ‰éˆ•
                html += '<button onclick="removeTask(' + index + ')" class="text-red-400 hover:text-red-300 text-xs px-2 py-1 bg-slate-800 rounded" title="ç§»é™¤æ­¤ä»»å‹™">';
                html += '<i class="fa-solid fa-trash mr-1"></i>ç§»é™¤</button>';
                html += '</div>';
                
                // ä»»å‹™è©³æƒ…
                html += '<div class="grid grid-cols-4 gap-3">';
                
                // ä¾†æº
                html += '<div class="col-span-1">';
                html += '<div class="text-xs text-slate-400 mb-1">ğŸ“ ä¾†æºå„²ä½</div>';
                html += '<div class="text-white font-bold text-sm">' + task.fromLocation + '</div>';
                html += '<div class="text-xs text-slate-500 mt-1">æ¿è™Ÿï¼š' + task.fromPalletId + '</div>';
                html += '</div>';
                
                // ç®­é ­
                html += '<div class="col-span-1 flex items-center justify-center">';
                html += '<div class="text-slate-500">';
                html += '<i class="fa-solid fa-arrow-right text-2xl"></i>';
                html += '<div class="text-xs mt-1">' + task.quantity + ' ä»¶</div>';
                html += '</div>';
                html += '</div>';
                
                // ç›®æ¨™
                html += '<div class="col-span-1">';
                html += '<div class="text-xs text-slate-400 mb-1">ğŸ¯ ç›®æ¨™å„²ä½</div>';
                html += '<div class="text-green-400 font-bold text-sm">' + task.toLocation + '</div>';
                html += '<div class="text-xs text-green-600 mt-1">åˆä½µåˆ°æ­¤</div>';
                html += '</div>';
                
                // é ä¼°æ™‚é–“
                html += '<div class="col-span-1">';
                html += '<div class="text-xs text-slate-400 mb-1">â±ï¸ é ä¼°æ™‚é–“</div>';
                html += '<div class="text-yellow-400 font-bold text-sm">~5 åˆ†é˜</div>';
                html += '<div class="text-xs text-slate-500 mt-1">å«ç§»å‹•æ™‚é–“</div>';
                html += '</div>';
                
                html += '</div>';
                html += '</div>';
            });
            html += '</div>';
            html += '</div>';
            
            // åŸ·è¡Œæ‘˜è¦
            html += '<div class="bg-gradient-to-r from-purple-900/30 to-blue-900/30 border border-purple-600/50 rounded-lg p-4 mb-4">';
            html += '<div class="text-purple-300 font-bold mb-2">ğŸ“Š åŸ·è¡Œæ‘˜è¦</div>';
            html += '<div class="grid grid-cols-3 gap-4 text-sm">';
            html += '<div>';
            html += '<div class="text-slate-400">ç¸½ä»»å‹™æ•¸</div>';
            html += '<div class="text-white font-bold text-xl">' + previewData.totalTasks + ' é …</div>';
            html += '</div>';
            html += '<div>';
            html += '<div class="text-slate-400">é ä¼°ç¸½æ™‚é•·</div>';
            html += '<div class="text-yellow-400 font-bold text-xl">~' + (previewData.totalTasks * 5) + ' åˆ†é˜</div>';
            html += '</div>';
            html += '<div>';
            html += '<div class="text-slate-400">é‡‹æ”¾ç©ºä½</div>';
            html += '<div class="text-green-400 font-bold text-xl">' + previewData.totalTasks + ' å€‹</div>';
            html += '</div>';
            html += '</div>';
            html += '</div>';
            
            // PDA åŸ·è¡Œèªªæ˜
            html += '<div class="bg-blue-900/20 border border-blue-600/50 rounded-lg p-4 mb-4">';
            html += '<div class="text-blue-400 font-bold mb-2">ğŸ“± PDA ç«¯åŸ·è¡Œæµç¨‹</div>';
            html += '<div class="space-y-2 text-sm text-slate-300">';
            html += '<div class="flex items-start gap-2">';
            html += '<div class="bg-blue-600 text-white w-5 h-5 rounded-full flex items-center justify-center text-xs flex-shrink-0 mt-0.5">1</div>';
            html += '<div>å †é«˜æ©Ÿå¸æ©Ÿçš„ PDA æœƒæ”¶åˆ°æ¨é€é€šçŸ¥</div>';
            html += '</div>';
            html += '<div class="flex items-start gap-2">';
            html += '<div class="bg-blue-600 text-white w-5 h-5 rounded-full flex items-center justify-center text-xs flex-shrink-0 mt-0.5">2</div>';
            html += '<div>PDA é¡¯ç¤ºç¬¬ä¸€å€‹ä»»å‹™ï¼šã€Œè«‹å‰å¾€ ' + previewData.tasks[0].fromLocation + 'ã€</div>';
            html += '</div>';
            html += '<div class="flex items-start gap-2">';
            html += '<div class="bg-blue-600 text-white w-5 h-5 rounded-full flex items-center justify-center text-xs flex-shrink-0 mt-0.5">3</div>';
            html += '<div>å¸æ©Ÿåˆ°é”å¾Œæƒææ£§æ¿æ¢ç¢¼ â†’ <span class="text-green-400 font-bold">å—¶ï¼ç¢ºèªæ­£ç¢º</span></div>';
            html += '</div>';
            html += '<div class="flex items-start gap-2">';
            html += '<div class="bg-blue-600 text-white w-5 h-5 rounded-full flex items-center justify-center text-xs flex-shrink-0 mt-0.5">4</div>';
            html += '<div>è¼‰è²¨ç§»å‹•åˆ° ' + previewData.tasks[0].toLocation + 'ï¼Œæƒæå„²ä½ â†’ <span class="text-green-400 font-bold">å—¶ï¼ä»»å‹™å®Œæˆ</span></div>';
            html += '</div>';
            html += '<div class="flex items-start gap-2">';
            html += '<div class="bg-blue-600 text-white w-5 h-5 rounded-full flex items-center justify-center text-xs flex-shrink-0 mt-0.5">5</div>';
            html += '<div>è‡ªå‹•é¡¯ç¤ºä¸‹ä¸€å€‹ä»»å‹™ï¼Œé‡è¤‡æ­¥é©Ÿ 3-4</div>';
            html += '</div>';
            html += '<div class="flex items-start gap-2">';
            html += '<div class="bg-blue-600 text-white w-5 h-5 rounded-full flex items-center justify-center text-xs flex-shrink-0 mt-0.5">6</div>';
            html += '<div>æ‰€æœ‰ä»»å‹™å®Œæˆå¾Œï¼ŒPDA é¡¯ç¤ºã€ŒğŸ‰ èª¿åº¦å–®å®Œæˆï¼ã€</div>';
            html += '</div>';
            html += '</div>';
            html += '</div>';
            
            // æ“ä½œæŒ‰éˆ•
            html += '<div class="flex gap-3">';
            html += '<button onclick="confirmAndGenerate()" class="flex-1 bg-gradient-to-r from-green-600 to-green-500 hover:from-green-500 hover:to-green-400 text-white py-3 px-6 rounded-lg font-bold text-lg shadow-lg">';
            html += '<i class="fa-solid fa-check-circle mr-2"></i>ç¢ºèªç„¡èª¤ï¼Œæ­£å¼ç”Ÿæˆ';
            html += '</button>';
            html += '<button onclick="closePreviewModal()" class="bg-slate-700 hover:bg-slate-600 text-white py-3 px-6 rounded-lg">';
            html += '<i class="fa-solid fa-times mr-2"></i>å–æ¶ˆ';
            html += '</button>';
            html += '</div>';
            
            html += '</div>';
            
            modal.innerHTML = html;
            modal.classList.remove('hidden');
            
            // ä¿å­˜é è¦½æ•¸æ“šä¾›ç¢ºèªä½¿ç”¨
            window.currentPreviewData = previewData;
        };
        
        // ç¢ºèªä¸¦ç”Ÿæˆæ­£å¼èª¿åº¦å–®
        window.confirmAndGenerate = function() {
            if (!window.currentPreviewData) return;
            
            var previewData = window.currentPreviewData;
            
            // å‰µå»ºæ­£å¼èª¿åº¦å–®
            var order = {
                orderNo: previewData.orderNo,
                productName: previewData.productName,
                createdAt: previewData.createdAt,
                tasks: previewData.tasks,
                totalTasks: previewData.tasks.length,
                completedTasks: 0,
                status: 'active'
            };
            
            // ä¿å­˜åˆ°å…¨å±€
            if (!window.dispatchOrders) window.dispatchOrders = [];
            window.dispatchOrders.push(order);
            
            // é—œé–‰é è¦½
            closePreviewModal();
            
            // é¡¯ç¤ºæˆåŠŸè¨Šæ¯ä¸¦å±•ç¤ºèª¿åº¦å–®
            setTimeout(function() {
                alert('âœ… èª¿åº¦å–®å·²ç”Ÿæˆï¼\n\nç·¨è™Ÿï¼š' + order.orderNo + '\nä»»å‹™æ•¸ï¼š' + order.totalTasks + ' é …\n\nå¸æ©Ÿ PDA å°‡æ”¶åˆ°é€šçŸ¥');
                showDispatchOrder(order);
            }, 300);
        };
        
        // é—œé–‰é è¦½ modal
        window.closePreviewModal = function() {
            var modal = document.getElementById('dispatch-preview-modal');
            if (modal) modal.classList.add('hidden');
        };
        
        // ä»»å‹™é †åºèª¿æ•´ï¼ˆé ç•™åŠŸèƒ½ï¼‰
        window.moveTaskUp = function(index) {
            if (!window.currentPreviewData || index === 0) return;
            var tasks = window.currentPreviewData.tasks;
            var temp = tasks[index];
            tasks[index] = tasks[index - 1];
            tasks[index - 1] = temp;
            // é‡æ–°ç·¨è™Ÿ
            tasks.forEach(function(task, i) {
                task.taskNo = i + 1;
            });
            showDispatchPreview(window.currentPreviewData);
        };
        
        window.moveTaskDown = function(index) {
            if (!window.currentPreviewData || index === window.currentPreviewData.tasks.length - 1) return;
            var tasks = window.currentPreviewData.tasks;
            var temp = tasks[index];
            tasks[index] = tasks[index + 1];
            tasks[index + 1] = temp;
            // é‡æ–°ç·¨è™Ÿ
            tasks.forEach(function(task, i) {
                task.taskNo = i + 1;
            });
            showDispatchPreview(window.currentPreviewData);
        };
        
        window.removeTask = function(index) {
            if (!window.currentPreviewData) return;
            if (!confirm('ç¢ºå®šè¦ç§»é™¤æ­¤ä»»å‹™å—ï¼Ÿ')) return;
            window.currentPreviewData.tasks.splice(index, 1);
            window.currentPreviewData.totalTasks = window.currentPreviewData.tasks.length;
            // é‡æ–°ç·¨è™Ÿ
            window.currentPreviewData.tasks.forEach(function(task, i) {
                task.taskNo = i + 1;
            });
            if (window.currentPreviewData.tasks.length === 0) {
                alert('æ‰€æœ‰ä»»å‹™å·²ç§»é™¤');
                closePreviewModal();
                return;
            }
            showDispatchPreview(window.currentPreviewData);
        };
        
        // 8ï¸âƒ£ é¡¯ç¤ºèª¿åº¦å–®
        window.showDispatchOrder = function(order) {
            var modal = document.getElementById('dispatch-order-modal');
            if (!modal) {
                // å‰µå»º modal
                modal = document.createElement('div');
                modal.id = 'dispatch-order-modal';
                modal.className = 'fixed inset-0 bg-black/70 flex items-center justify-center z-50';
                document.body.appendChild(modal);
            }
            
            var html = '<div class="bg-slate-800 rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">';
            html += '<div class="flex justify-between items-start mb-4">';
            html += '<div>';
            html += '<h2 class="text-2xl font-bold text-white">ğŸ“‹ èª¿åº¦å–® ' + order.orderNo + '</h2>';
            html += '<div class="text-slate-400 text-sm mt-1">å“åï¼š' + order.productName + ' | ç”Ÿæˆæ™‚é–“ï¼š' + order.createdAt + '</div>';
            html += '</div>';
            html += '<button onclick="closeDispatchOrderModal()" class="text-slate-400 hover:text-white text-2xl">&times;</button>';
            html += '</div>';
            
            html += '<div class="space-y-3 mb-4">';
            order.tasks.forEach(function(task) {
                var statusIcon = 'â±ï¸';
                var statusText = 'å¾…åŸ·è¡Œ';
                var statusColor = 'text-yellow-400';
                
                if (task.status === 'completed') {
                    statusIcon = 'âœ…';
                    statusText = 'å·²å®Œæˆ';
                    statusColor = 'text-green-400';
                }
                
                html += '<div class="bg-slate-900 border border-slate-700 rounded p-3">';
                html += '<div class="flex justify-between items-start mb-2">';
                html += '<div class="text-white font-bold">ä»»å‹™ ' + task.taskNo + '</div>';
                html += '<div class="' + statusColor + ' text-sm">' + statusIcon + ' ' + statusText + '</div>';
                html += '</div>';
                html += '<div class="grid grid-cols-3 gap-2 text-sm">';
                html += '<div><div class="text-slate-400">å¾</div><div class="text-white font-bold">' + task.fromLocation + '</div></div>';
                html += '<div class="text-center"><div class="text-slate-400">æ•¸é‡</div><div class="text-yellow-400 font-bold">' + task.quantity + ' ä»¶</div></div>';
                html += '<div class="text-right"><div class="text-slate-400">åˆ°</div><div class="text-white font-bold">' + task.toLocation + '</div></div>';
                html += '</div>';
                html += '<div class="text-xs text-slate-500 mt-2">æ¿è™Ÿï¼š' + task.fromPalletId + '</div>';
                html += '</div>';
            });
            html += '</div>';
            
            html += '<div class="bg-blue-900/30 border border-blue-600 rounded p-3 mb-4">';
            html += '<div class="text-blue-400 font-bold mb-1">ğŸ“± PDA ç«¯æ“ä½œæµç¨‹</div>';
            html += '<div class="text-sm text-slate-300 space-y-1">';
            html += '<div>1ï¸âƒ£ å †é«˜æ©Ÿå¸æ©Ÿ PDA æœƒæ”¶åˆ°æ­¤èª¿åº¦å–®</div>';
            html += '<div>2ï¸âƒ£ å¸æ©ŸæŒ‰é †åºåŸ·è¡Œæ¯å€‹ä»»å‹™</div>';
            html += '<div>3ï¸âƒ£ åˆ°é”ä¾†æºä½ â†’ æƒææ£§æ¿ (å—¶ï¼ç¢ºèª)</div>';
            html += '<div>4ï¸âƒ£ åˆ°é”ç›®æ¨™ä½ â†’ æƒæå„²ä½ (å—¶ï¼å®Œæˆ)</div>';
            html += '<div>5ï¸âƒ£ ç³»çµ±è‡ªå‹•æ›´æ–°å®Œæˆç‹€æ…‹</div>';
            html += '</div></div>';
            
            html += '<div class="flex gap-2">';
            html += '<button onclick="printDispatchOrder(\'' + order.orderNo + '\')" class="flex-1 bg-green-600 hover:bg-green-500 text-white py-2 px-4 rounded">';
            html += '<i class="fa-solid fa-print mr-2"></i>åˆ—å°èª¿åº¦å–®</button>';
            html += '<button onclick="closeDispatchOrderModal()" class="bg-slate-700 hover:bg-slate-600 text-white py-2 px-4 rounded">é—œé–‰</button>';
            html += '</div>';
            
            html += '</div>';
            
            modal.innerHTML = html;
            modal.classList.remove('hidden');
        };
        
        window.closeDispatchOrderModal = function() {
            var modal = document.getElementById('dispatch-order-modal');
            if (modal) modal.classList.add('hidden');
        };
        
        window.printDispatchOrder = function(orderNo) {
            alert('åˆ—å°èª¿åº¦å–®: ' + orderNo + '\n\nï¼ˆå¯¦éš›ç³»çµ±æœƒé€£æ¥å°è¡¨æ©Ÿï¼‰');
        };
        
        window.cancelDispatch = function() {
            window.selectedProduct = null;
            window.currentSuggestion = null;
            document.getElementById('visual-map').innerHTML = '<div class="text-center text-slate-400 py-8">è«‹å¾å·¦å´é¸æ“‡å“å</div>';
            document.getElementById('product-stats').innerHTML = '';
        };
        
        // åˆå§‹åŒ–æ™ºèƒ½èª¿åº¦
        window.initSmartDispatch = function() {
            renderDispersionRanking();
            document.getElementById('visual-map').innerHTML = '<div class="text-center text-slate-400 py-8">ğŸ‘ˆ è«‹å¾å·¦å´é¸æ“‡å“åæŸ¥çœ‹èª¿åº¦å»ºè­°</div>';
        };
        setInboundMode('Raw');
        switchTab('dashboard', null);
    </script>
</body>
</html>