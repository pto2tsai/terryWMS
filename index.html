<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Terry WMS V56.1 - 倉儲管理系統</title>
    <script>tailwind.config = { theme: { extend: { colors: { primary: '#3b82f6', secondary: '#1e293b' } } } };</script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    
    <!-- Firebase compat -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
</head>
<body class="flex h-screen overflow-hidden">

    <div id="view-login" class="fixed inset-0 z-50 bg-gradient-to-br from-slate-900 via-slate-800 to-blue-900 flex flex-col items-center justify-center p-6">
        <div class="w-full max-w-md space-y-6 text-center">
            <div class="mb-8">
                <i class="fa-solid fa-warehouse text-blue-500 text-6xl mb-4"></i>
                <h1 class="text-4xl font-black text-white">TERRY <span class="text-blue-400">WMS</span></h1>
                <p class="text-slate-400 mt-2">倉儲管理系統 V56.1</p>
            </div>
            <div class="bg-slate-800/50 border border-slate-700 rounded-2xl p-6 space-y-4">
                <div class="text-left">
                    <label class="text-slate-400 text-sm mb-1 block">帳號 (Email)</label>
                    <input type="email" id="login-email" value="admin@bafang.com" class="scan-input text-lg w-full" placeholder="your@email.com">
                </div>
                <div class="text-left">
                    <label class="text-slate-400 text-sm mb-1 block">密碼</label>
                    <input type="password" id="login-pwd" value="123456" class="scan-input text-lg w-full" placeholder="••••••••">
                </div>
                <div id="login-error" class="text-red-400 text-sm hidden"></div>
                <button onclick="loginSystem()" id="btn-login" class="w-full py-4 bg-blue-600 hover:bg-blue-500 text-white rounded-xl font-bold shadow-lg text-lg transition-all hover:scale-[1.02]">
                    <i class="fa-solid fa-right-to-bracket mr-2"></i>登入系統
                </button>
            </div>
            <p class="text-slate-500 text-xs">© 2024-2025 Terry WMS. All rights reserved.</p>
        </div>
    </div>

    <div id="modal-level-select" class="fixed inset-0 z-40 bg-black/80 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-slate-900 border border-slate-700 p-8 rounded-2xl w-96 shadow-2xl">
            <div id="loc-select-physical" class="hidden">
                <h3 class="text-xl font-bold text-white mb-2 text-center">選擇入庫層數</h3>
                <p class="text-sm text-slate-400 mb-6 text-center font-mono" id="modal-lane-title">I-A 第 1 行</p>
                <div class="space-y-3">
                    <button id="btn-level-3f" onclick="selectLevel('3F')" class="level-btn">3F (8板)</button>
                    <button id="btn-level-2f" onclick="selectLevel('2F')" class="level-btn">2F (5板)</button>
                    <button id="btn-level-1f" onclick="selectLevel('1F')" class="level-btn level-btn-active relative">1F (挑高 16板) <span class="absolute top-2 right-3 text-xs text-yellow-400 bg-yellow-900/50 px-1 rounded">散貨</span></button>
                </div>
            </div>
            <div id="loc-select-virtual" class="hidden">
                <h3 class="text-xl font-bold text-white mb-4 text-center">選擇虛擬倉庫</h3>
                <div class="grid grid-cols-2 gap-3 mb-4" id="virtual-grid"></div>
                <div class="border-t border-slate-700 pt-4"><input type="text" id="new-virtual-name" class="scan-input text-sm mb-2" placeholder="新虛擬庫名稱..."><button onclick="addNewVirtualLoc()" class="w-full py-2 bg-emerald-600 hover:bg-emerald-500 rounded text-white text-sm font-bold">新增自訂庫</button></div>
            </div>
            <button onclick="closeLocModal()" class="mt-6 w-full text-slate-500 text-sm hover:text-white">取消</button>
        </div>
    </div>

    <div id="modal-analytics" class="fixed inset-0 z-40 bg-black/90 hidden flex flex-col p-6 backdrop-blur-sm"><div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold text-white" id="analytics-title">詳細分析</h2><button onclick="closeAnalytics()" class="text-slate-400 hover:text-white"><i class="fa-solid fa-xmark text-2xl"></i></button></div><div class="flex gap-4 mb-4 bg-slate-800 p-4 rounded border border-slate-700"><input type="text" class="scan-input w-48" placeholder="🔍 產品/批號"><input type="text" class="scan-input w-48" placeholder="🏢 客戶名稱"><input type="text" class="scan-input w-48" placeholder="🚛 物流商"><div class="flex items-center gap-2 text-slate-400 text-sm"><span>出貨日:</span><input type="date" class="scan-input w-32"><span>至</span><input type="date" class="scan-input w-32"></div><button class="bg-blue-600 hover:bg-blue-500 text-white px-4 rounded font-bold ml-auto">搜尋</button></div><div class="flex-1 glass-panel overflow-auto"><table class="w-full dense-table text-left"><thead><tr><th>單號</th><th>品名規格</th><th>批號</th><th>數量</th><th>客戶</th><th>物流</th><th>狀態</th><th>備貨日</th></tr></thead><tbody id="analytics-tbody"></tbody></table></div></div>

    <!-- 常用功能設定彈窗 -->
    <div id="modal-favorites-settings" class="fixed inset-0 z-50 bg-black/80 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-slate-800 rounded-xl w-[700px] max-h-[85vh] flex flex-col border border-slate-600 shadow-2xl">
            <div class="flex items-center justify-between p-4 border-b border-slate-700">
                <h3 class="text-white font-bold text-lg"><i class="fa-solid fa-star text-yellow-400 mr-2"></i>設定常用功能</h3>
                <button onclick="closeFavoritesSettings()" class="text-slate-400 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="flex-1 overflow-hidden flex">
                <!-- 左側：可選功能 -->
                <div class="w-1/2 border-r border-slate-700 flex flex-col">
                    <div class="p-3 border-b border-slate-700 bg-slate-700/30">
                        <div class="text-white font-bold text-sm mb-2"><i class="fa-solid fa-list mr-1"></i>可選功能</div>
                        <input type="text" id="fav-search" class="w-full p-2 bg-slate-900 border border-slate-600 rounded text-white text-sm" placeholder="搜尋功能..." oninput="filterAvailableFunctions()">
                    </div>
                    <div class="flex-1 overflow-y-auto p-2" id="available-functions-list">
                        <!-- 動態產生 -->
                    </div>
                </div>
                <!-- 右側：已選功能（可拖曳排序）-->
                <div class="w-1/2 flex flex-col">
                    <div class="p-3 border-b border-slate-700 bg-slate-700/30">
                        <div class="text-white font-bold text-sm"><i class="fa-solid fa-star text-yellow-400 mr-1"></i>已選功能 <span id="selected-count" class="text-slate-400 font-normal">(0)</span></div>
                        <div class="text-slate-400 text-xs mt-1">拖曳可調整順序</div>
                    </div>
                    <div class="flex-1 overflow-y-auto p-2" id="selected-functions-list">
                        <!-- 動態產生 -->
                    </div>
                </div>
            </div>
            <div class="p-4 border-t border-slate-700 flex justify-between items-center">
                <button onclick="clearAllFavorites()" class="text-red-400 hover:text-red-300 text-sm"><i class="fa-solid fa-trash mr-1"></i>清除全部</button>
                <div class="flex gap-2">
                    <button onclick="closeFavoritesSettings()" class="px-4 py-2 bg-slate-600 hover:bg-slate-500 text-white rounded-lg">取消</button>
                    <button onclick="saveFavoritesSettings()" class="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-bold"><i class="fa-solid fa-check mr-1"></i>儲存</button>
                </div>
            </div>
        </div>
    </div>

    <aside class="w-56 bg-slate-900 border-r border-slate-800 flex flex-col shrink-0 z-20">
        <div class="h-14 flex items-center px-4 border-b border-slate-800">
            <i class="fa-solid fa-cube text-blue-500 text-xl mr-2"></i>
            <div>
                <span class="font-black text-lg text-white tracking-wide">TERRY WMS</span>
                <span class="text-[10px] text-slate-500 ml-1">V56.1</span>
            </div>
        </div>
        <nav class="flex-1 overflow-y-auto py-1" id="main-nav">
            <!-- 常用功能區塊 -->
            <div id="favorites-section" class="border-b border-slate-700 mb-2 pb-2">
                <div class="flex items-center justify-between px-3 py-1.5 text-slate-400 text-sm">
                    <span class="font-bold"><i class="fa-solid fa-star text-yellow-400 mr-1"></i>常用功能</span>
                    <button onclick="openFavoritesSettings()" class="hover:text-white" title="設定常用功能">
                        <i class="fa-solid fa-gear"></i>
                    </button>
                </div>
                <div id="favorites-list" class="space-y-0.5 px-1">
                    <!-- 動態產生的常用功能項目 -->
                </div>
                <div id="favorites-empty" class="text-center py-3 text-slate-500 text-sm hidden">
                    <i class="fa-solid fa-star mb-1"></i>
                    <div>點擊 <i class="fa-solid fa-gear"></i> 新增常用功能</div>
                </div>
            </div>

            <!-- 數位倉庫 -->
            <div class="nav-group-header" onclick="toggleNavGroup('grp-warehouse-view')">
                <span><i class="fa-solid fa-map-location-dot w-4 text-center mr-1 text-cyan-400"></i>數位倉庫</span>
                <i class="fa-solid fa-chevron-down nav-chevron"></i>
            </div>
            <div class="nav-group-items" id="grp-warehouse-view">
                <div class="nav-item active" onclick="switchTab('visual-map', event)"><i class="fa-solid fa-map w-4 text-center mr-2"></i>倉庫地圖</div>
                <div class="nav-item" onclick="switchTab('inventory-query', event)"><i class="fa-solid fa-magnifying-glass w-4 text-center mr-2"></i>庫存查詢</div>
            </div>

            <div class="nav-item" onclick="switchTab('dashboard', event)"><i class="fa-solid fa-chart-pie w-5 text-center mr-2"></i> 戰情分析</div>
            <div class="nav-item" onclick="switchTab('work-board', event)"><i class="fa-solid fa-tv w-5 text-center mr-2 text-yellow-400"></i> 工單看板</div>

            <!-- 入庫管理 -->
            <div class="nav-group-header" onclick="toggleNavGroup('grp-inbound')">
                <span><i class="fa-solid fa-arrow-down w-4 text-center mr-1 text-emerald-400"></i>入庫管理</span>
                <i class="fa-solid fa-chevron-down nav-chevron"></i>
            </div>
            <div class="nav-group-items" id="grp-inbound">
                <div class="nav-item" onclick="switchTab('unified-inbound', event)"><i class="fa-solid fa-bolt w-4 text-center mr-2"></i>智能入庫中心</div>
                <div class="nav-item" onclick="switchTab('pre-inbound', event)"><i class="fa-solid fa-ship w-4 text-center mr-2 text-cyan-400"></i>貨櫃入庫作業</div>
                <div class="nav-item" onclick="switchTab('approval', event)" id="nav-approval"><i class="fa-solid fa-clipboard-check w-4 text-center mr-2 text-yellow-400"></i>待財務核准 <span id="approval-count" class="ml-auto bg-yellow-500 text-black text-xs px-1.5 rounded-full">0</span></div>
            </div>

            <!-- 出庫管理 -->
            <div class="nav-group-header" onclick="toggleNavGroup('grp-outbound')">
                <span><i class="fa-solid fa-arrow-up w-4 text-center mr-1 text-red-400"></i>出庫管理</span>
                <i class="fa-solid fa-chevron-down nav-chevron"></i>
            </div>
            <div class="nav-group-items" id="grp-outbound">
                <div class="nav-item" onclick="switchTab('wave-picking', event)"><i class="fa-solid fa-layer-group w-4 text-center mr-2 text-orange-400"></i>波次揀貨</div>
                <div class="nav-item" onclick="switchTab('picking-rm', event)"><i class="fa-solid fa-fish w-4 text-center mr-2"></i>原料領用</div>
                <!-- 訂單出貨模組已移除 -->
            </div>

            <!-- 庫存異動作業 -->
            <div class="nav-group-header" onclick="toggleNavGroup('grp-warehouse')">
                <span><i class="fa-solid fa-warehouse w-4 text-center mr-1 text-blue-400"></i>庫存異動作業</span>
                <i class="fa-solid fa-chevron-down nav-chevron"></i>
            </div>
            <div class="nav-group-items" id="grp-warehouse">
                <div class="nav-item" onclick="switchTab('move', event)"><i class="fa-solid fa-layer-group w-4 text-center mr-2"></i>智能調度</div>
                <div class="nav-item" onclick="switchTab('merge', event)"><i class="fa-solid fa-arrows-turn-to-dots w-4 text-center mr-2"></i>板號異動</div>
                <div class="nav-item" onclick="switchTab('transfer', event)"><i class="fa-solid fa-right-left w-4 text-center mr-2"></i>倉庫調撥</div>
                <div class="nav-item" onclick="switchTab('stocktake', event)"><i class="fa-solid fa-clipboard-check w-4 text-center mr-2"></i>庫存盤點</div>
            </div>

            <!-- 外部倉庫 -->
            <div class="nav-group-header" onclick="toggleNavGroup('grp-external')">
                <span><i class="fa-solid fa-building w-4 text-center mr-1 text-purple-400"></i>外部倉庫</span>
                <i class="fa-solid fa-chevron-down nav-chevron"></i>
            </div>
            <div class="nav-group-items collapsed" id="grp-external">
                <div class="nav-item" onclick="switchTab('external-warehouse', event)"><i class="fa-solid fa-building w-4 text-center mr-2"></i>外倉管理</div>
            </div>

            <!-- 理貨報表 -->
            <div class="nav-group-header" onclick="toggleNavGroup('grp-reports')">
                <span><i class="fa-solid fa-chart-line w-4 text-center mr-1 text-orange-400"></i>理貨報表</span>
                <i class="fa-solid fa-chevron-down nav-chevron"></i>
            </div>
            <div class="nav-group-items collapsed" id="grp-reports">
                <div class="nav-item" onclick="switchTab('picking-reports', event)"><i class="fa-solid fa-chart-pie w-4 text-center mr-2 text-green-400"></i>報表中心</div>
                <div class="nav-item" onclick="switchTab('expiry-management', event)"><i class="fa-solid fa-calendar-xmark w-4 text-center mr-2 text-red-400"></i>效期管理</div>
                <div class="nav-item" onclick="switchTab('inventory-log', event)"><i class="fa-solid fa-clock-rotate-left w-4 text-center mr-2"></i>異動查詢</div>
                <div class="nav-item" onclick="switchTab('product-analysis', event)"><i class="fa-solid fa-chart-bar w-4 text-center mr-2"></i>出貨分析</div>
                <div class="nav-item" onclick="switchTab('warehouse-heatmap', event)"><i class="fa-solid fa-fire w-4 text-center mr-2"></i>熱力圖</div>
            </div>

            <!-- 倉租管理 -->
            <div class="nav-group-header" onclick="toggleNavGroup('grp-rental')">
                <span><i class="fa-solid fa-dollar-sign w-4 text-center mr-1 text-yellow-400"></i>倉租管理</span>
                <i class="fa-solid fa-chevron-down nav-chevron"></i>
            </div>
            <div class="nav-group-items" id="grp-rental">
                <div class="nav-item" onclick="switchTab('consignment', event)"><i class="fa-solid fa-box-archive w-4 text-center mr-2 text-amber-400"></i>寄倉管理</div>
                <div class="nav-item" onclick="switchTab('rental-report', event)"><i class="fa-solid fa-file-invoice-dollar w-4 text-center mr-2 text-emerald-400"></i>倉租報表</div>
                <div class="nav-item" onclick="switchTab('rental-settings', event)"><i class="fa-solid fa-sliders w-4 text-center mr-2 text-blue-400"></i>費率設定</div>
            </div>

            <!-- 系統設定 -->
            <div class="nav-group-header" onclick="toggleNavGroup('grp-settings')">
                <span><i class="fa-solid fa-gear w-4 text-center mr-1 text-slate-400"></i>系統設定</span>
                <i class="fa-solid fa-chevron-down nav-chevron"></i>
            </div>
            <div class="nav-group-items" id="grp-settings">
                <div class="nav-item" onclick="switchTab('user-management', event)"><i class="fa-solid fa-users-gear w-4 text-center mr-2 text-blue-400"></i>使用者管理</div>
                <div class="nav-item" onclick="switchTab('product-master', event)"><i class="fa-solid fa-box w-4 text-center mr-2"></i>品項主檔</div>
                <div class="nav-item" onclick="switchTab('label-print', event)"><i class="fa-solid fa-print w-4 text-center mr-2 text-purple-400"></i>標籤列印</div>
                <div class="nav-item" onclick="switchTab('data-import', event)"><i class="fa-solid fa-file-import w-4 text-center mr-2 text-amber-400"></i>資料匯入</div>
                <div class="nav-item" onclick="switchTab('dev-tools', event)"><i class="fa-solid fa-wrench w-4 text-center mr-2 text-orange-400"></i>備份與維護</div>
            </div>
        </nav>
        <!-- 版本資訊 -->
        <div class="p-3 border-t border-slate-800 text-center">
            <div class="text-[10px] text-slate-600">Version 56.1 | 2024-12-26</div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col min-w-0 bg-slate-900">
        <header class="h-16 border-b border-slate-800 flex items-center justify-between px-6 bg-slate-900 shrink-0">
            <h2 class="text-xl font-bold text-white" id="page-title">數位倉庫監控</h2>
            <div class="flex gap-3 items-center">
                <div class="flex items-center gap-2 px-3 py-1.5 bg-slate-800 rounded-lg border border-slate-700">
                    <i class="fa-solid fa-user-circle text-blue-400"></i>
                    <span class="text-sm text-white font-medium" id="current-user-name">載入中...</span>
                    <span class="text-xs px-2 py-0.5 rounded-full" id="current-user-role-badge">-</span>
                </div>
                <button onclick="logoutSystem()" class="px-3 py-1.5 bg-red-600/20 hover:bg-red-600/40 text-red-400 hover:text-red-300 rounded-lg text-sm transition-colors" title="登出">
                    <i class="fa-solid fa-power-off mr-1"></i>登出
                </button>
            </div>
        </header>

        <div class="flex-1 overflow-hidden relative">

            <div id="view-visual-map" class="view-panel h-full flex flex-col">
                <div class="h-10 bg-slate-800/50 border-b border-slate-800 flex items-center px-4 gap-6 text-xs text-slate-400 shrink-0">
                    <span class="text-emerald-400"><i class="fa-solid fa-info-circle mr-1"></i>容積說明：</span>
                    <div class="flex items-center gap-1"><div class="w-3 h-3 bg-[#10b981] rounded-sm"></div> 低 (<50%)</div>
                    <div class="flex items-center gap-1"><div class="w-3 h-3 bg-[#3b82f6] rounded-sm"></div> 中 (50-99%)</div>
                    <div class="flex items-center gap-1"><div class="w-3 h-3 bg-[#ef4444] rounded-sm"></div> 高 (100%/滿)</div>
                    <span class="ml-auto text-blue-400">點擊軌道查看詳情</span>
                </div>
                <div class="warehouse-new-layout">
                    <!-- 左側區域：I庫 + J庫 (上層) + K庫 (下層) -->
                    <div class="warehouse-left-area">
                        <!-- 上層：I庫 + J庫 並排 -->
                        <div class="warehouse-ij-row">
                            <!-- I 庫 (A/B 上下排列) -->
                            <div class="warehouse-building-ij">
                                <div class="building-label bg-blue-600">I 庫 (原料/餘料)</div>
                                <div class="zones-stack">
                                    <div class="zone-row-item">
                                        <div class="zone-label">A</div>
                                        <div class="rack-lanes-8" id="grid-I-A"></div>
                                    </div>
                                    <div class="zone-row-item">
                                        <div class="zone-label bg-indigo-600">B</div>
                                        <div class="rack-lanes-8" id="grid-I-B"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- J 庫 (C/D 上下排列) -->
                            <div class="warehouse-building-ij">
                                <div class="building-label bg-purple-600">J 庫 (成品/半成品)</div>
                                <div class="zones-stack">
                                    <div class="zone-row-item">
                                        <div class="zone-label bg-purple-600">C</div>
                                        <div class="rack-lanes-8" id="grid-J-C"></div>
                                    </div>
                                    <div class="zone-row-item">
                                        <div class="zone-label bg-pink-600">D</div>
                                        <div class="rack-lanes-8" id="grid-J-D"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 下層：K庫 (E/F/G/H 上下排列，每列22巷道) -->
                        <div class="warehouse-k-area">
                            <div class="warehouse-building-k">
                                <div class="building-label bg-emerald-600">K 庫</div>
                                <div class="zones-stack-k">
                                    <div class="zone-row-item-k">
                                        <div class="zone-label bg-emerald-600">E</div>
                                        <div class="rack-lanes-22" id="grid-K-E"></div>
                                    </div>
                                    <div class="zone-row-item-k">
                                        <div class="zone-label bg-teal-600">F</div>
                                        <div class="rack-lanes-22" id="grid-K-F"></div>
                                    </div>
                                    <div class="zone-row-item-k">
                                        <div class="zone-label bg-cyan-600">G</div>
                                        <div class="rack-lanes-22" id="grid-K-G"></div>
                                    </div>
                                    <div class="zone-row-item-k">
                                        <div class="zone-label bg-sky-600">H</div>
                                        <div class="rack-lanes-22" id="grid-K-H"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 暫存區監控區塊 -->
                <div class="shrink-0 border-t border-slate-700 bg-slate-900/50 p-3">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-white font-bold text-sm">
                            <i class="fa-solid fa-boxes-stacked mr-2 text-amber-400"></i>暫存區監控
                        </h3>
                        <span class="text-xs text-slate-500">滑鼠懸停查看詳情</span>
                    </div>
                    <div class="grid grid-cols-11 gap-2" id="virtual-locations-grid">
                        <!-- 進貨暫存區 -->
                        <div class="virtual-loc-card bg-emerald-900/40 border border-emerald-600/50 hover:border-emerald-400"
                             onmouseenter="showVirtualLocTooltip(event, 'TEMP-IN')" onmousemove="moveHoverTooltip(event)" onmouseleave="hideHoverTooltip()" title="進貨暫存區">
                            <div class="text-emerald-400 text-[10px] font-bold">TEMP-IN</div>
                            <div class="text-xl font-black text-white" id="vl-count-TEMP-IN">0</div>
                            <div class="text-[10px] text-emerald-300">進貨暫存</div>
                        </div>
                        <!-- 出貨暫存區 -->
                        <div class="virtual-loc-card bg-orange-900/40 border border-orange-600/50 hover:border-orange-400"
                             onmouseenter="showVirtualLocTooltip(event, 'TEMP-OUT')" onmousemove="moveHoverTooltip(event)" onmouseleave="hideHoverTooltip()" title="出貨暫存區">
                            <div class="text-orange-400 text-[10px] font-bold">TEMP-OUT</div>
                            <div class="text-xl font-black text-white" id="vl-count-TEMP-OUT">0</div>
                            <div class="text-[10px] text-orange-300">出貨暫存</div>
                        </div>
                        <!-- A區前端 -->
                        <div class="virtual-loc-card bg-blue-900/40 border border-blue-600/50 hover:border-blue-400"
                             onmouseenter="showVirtualLocTooltip(event, 'A00')" onmousemove="moveHoverTooltip(event)" onmouseleave="hideHoverTooltip()" title="A區貨架前端">
                            <div class="text-blue-400 text-[10px] font-bold">A00</div>
                            <div class="text-xl font-black text-white" id="vl-count-A00">0</div>
                            <div class="text-[10px] text-blue-300">A區前端</div>
                        </div>
                        <!-- A區末端 -->
                        <div class="virtual-loc-card bg-blue-900/40 border border-blue-600/50 hover:border-blue-400"
                             onmouseenter="showVirtualLocTooltip(event, 'A99')" onmousemove="moveHoverTooltip(event)" onmouseleave="hideHoverTooltip()" title="A區貨架末端">
                            <div class="text-blue-400 text-[10px] font-bold">A99</div>
                            <div class="text-xl font-black text-white" id="vl-count-A99">0</div>
                            <div class="text-[10px] text-blue-300">A區末端</div>
                        </div>
                        <!-- B區前端 -->
                        <div class="virtual-loc-card bg-indigo-900/40 border border-indigo-600/50 hover:border-indigo-400"
                             onmouseenter="showVirtualLocTooltip(event, 'B00')" onmousemove="moveHoverTooltip(event)" onmouseleave="hideHoverTooltip()" title="B區貨架前端">
                            <div class="text-indigo-400 text-[10px] font-bold">B00</div>
                            <div class="text-xl font-black text-white" id="vl-count-B00">0</div>
                            <div class="text-[10px] text-indigo-300">B區前端</div>
                        </div>
                        <!-- B區末端 -->
                        <div class="virtual-loc-card bg-indigo-900/40 border border-indigo-600/50 hover:border-indigo-400"
                             onmouseenter="showVirtualLocTooltip(event, 'B99')" onmousemove="moveHoverTooltip(event)" onmouseleave="hideHoverTooltip()" title="B區貨架末端">
                            <div class="text-indigo-400 text-[10px] font-bold">B99</div>
                            <div class="text-xl font-black text-white" id="vl-count-B99">0</div>
                            <div class="text-[10px] text-indigo-300">B區末端</div>
                        </div>
                        <!-- C區前端 -->
                        <div class="virtual-loc-card bg-purple-900/40 border border-purple-600/50 hover:border-purple-400"
                             onmouseenter="showVirtualLocTooltip(event, 'C00')" onmousemove="moveHoverTooltip(event)" onmouseleave="hideHoverTooltip()" title="C區貨架前端">
                            <div class="text-purple-400 text-[10px] font-bold">C00</div>
                            <div class="text-xl font-black text-white" id="vl-count-C00">0</div>
                            <div class="text-[10px] text-purple-300">C區前端</div>
                        </div>
                        <!-- C區末端 -->
                        <div class="virtual-loc-card bg-purple-900/40 border border-purple-600/50 hover:border-purple-400"
                             onmouseenter="showVirtualLocTooltip(event, 'C99')" onmousemove="moveHoverTooltip(event)" onmouseleave="hideHoverTooltip()" title="C區貨架末端">
                            <div class="text-purple-400 text-[10px] font-bold">C99</div>
                            <div class="text-xl font-black text-white" id="vl-count-C99">0</div>
                            <div class="text-[10px] text-purple-300">C區末端</div>
                        </div>
                        <!-- D區前端 -->
                        <div class="virtual-loc-card bg-pink-900/40 border border-pink-600/50 hover:border-pink-400"
                             onmouseenter="showVirtualLocTooltip(event, 'D00')" onmousemove="moveHoverTooltip(event)" onmouseleave="hideHoverTooltip()" title="D區貨架前端">
                            <div class="text-pink-400 text-[10px] font-bold">D00</div>
                            <div class="text-xl font-black text-white" id="vl-count-D00">0</div>
                            <div class="text-[10px] text-pink-300">D區前端</div>
                        </div>
                        <!-- D區末端 -->
                        <div class="virtual-loc-card bg-pink-900/40 border border-pink-600/50 hover:border-pink-400"
                             onmouseenter="showVirtualLocTooltip(event, 'D99')" onmousemove="moveHoverTooltip(event)" onmouseleave="hideHoverTooltip()" title="D區貨架末端">
                            <div class="text-pink-400 text-[10px] font-bold">D99</div>
                            <div class="text-xl font-black text-white" id="vl-count-D99">0</div>
                            <div class="text-[10px] text-pink-300">D區末端</div>
                        </div>
                        <!-- 其他 -->
                        <div class="virtual-loc-card bg-slate-800/60 border border-slate-600/50 hover:border-slate-400"
                             onmouseenter="showVirtualLocTooltip(event, 'OTHER')" onmousemove="moveHoverTooltip(event)" onmouseleave="hideHoverTooltip()" title="其他位置">
                            <div class="text-slate-400 text-[10px] font-bold">OTHER</div>
                            <div class="text-xl font-black text-white" id="vl-count-OTHER">0</div>
                            <div class="text-[10px] text-slate-400">其他位置</div>
                        </div>
                    </div>
                </div>

                <!-- Hover 浮動提示卡片 -->
                <div id="hover-tooltip" class="hover-tooltip hidden">
                    <div class="tooltip-header">
                        <span class="tooltip-title" id="tooltip-title">I-A 第 1 巷</span>
                        <span class="tooltip-badge" id="tooltip-badge">空位: 12</span>
                    </div>
                    <div class="tooltip-body" id="tooltip-body"></div>
                </div>
            </div>

            <div id="view-dashboard" class="view-panel h-full hidden flex flex-col p-4 overflow-y-auto">
                <!-- 頂部 KPI 卡片 -->
                <div class="grid grid-cols-5 gap-3 mb-4">
                    <div class="glass-panel kpi-card p-4 border-l-4 border-blue-500" onclick="openAnalytics('Total')">
                        <div class="text-slate-400 text-xs">總庫存 (板)</div>
                        <div class="text-2xl font-bold text-white mt-1" id="kpi-total-pallets">0</div>
                    </div>
                    <div class="glass-panel kpi-card p-4 border-l-4 border-emerald-500">
                        <div class="text-slate-400 text-xs">崇文庫存</div>
                        <div class="text-2xl font-bold text-emerald-400 mt-1" id="kpi-cw-count">0</div>
                    </div>
                    <div class="glass-panel kpi-card p-4 border-l-4 border-cyan-500">
                        <div class="text-slate-400 text-xs">八方庫存</div>
                        <div class="text-2xl font-bold text-cyan-400 mt-1" id="kpi-bf-count">0</div>
                    </div>
                    <div class="glass-panel kpi-card p-4 border-l-4 border-amber-500">
                        <div class="text-slate-400 text-xs">暫存區</div>
                        <div class="text-2xl font-bold text-amber-400 mt-1" id="kpi-virtual-count">0</div>
                    </div>
                    <div class="glass-panel kpi-card p-4 border-l-4 border-red-500" onclick="switchTab('expiry-management', event)">
                        <div class="text-slate-400 text-xs">效期警示</div>
                        <div class="text-2xl font-bold text-red-400 mt-1" id="kpi-expiry-alert">0</div>
                    </div>
                </div>

                <!-- 中間圖表區 -->
                <div class="grid grid-cols-3 gap-4 mb-4">
                    <!-- 倉庫分布圓餅圖 -->
                    <div class="glass-panel p-4">
                        <h3 class="text-white font-bold text-sm mb-3"><i class="fa-solid fa-warehouse mr-2 text-blue-400"></i>倉庫分布</h3>
                        <div class="h-48 flex items-center justify-center">
                            <canvas id="stockChart" style="max-height: 180px; max-width: 180px;"></canvas>
                        </div>
                    </div>

                    <!-- 公司分布圓餅圖 -->
                    <div class="glass-panel p-4">
                        <h3 class="text-white font-bold text-sm mb-3"><i class="fa-solid fa-building mr-2 text-emerald-400"></i>公司分布</h3>
                        <div class="h-48 flex items-center justify-center">
                            <canvas id="companyChart" style="max-height: 180px; max-width: 180px;"></canvas>
                        </div>
                    </div>

                    <!-- 效期分布 -->
                    <div class="glass-panel p-4">
                        <h3 class="text-white font-bold text-sm mb-3"><i class="fa-solid fa-clock mr-2 text-orange-400"></i>效期分布</h3>
                        <div class="h-48 flex items-center justify-center">
                            <canvas id="expiryChart" style="max-height: 180px; max-width: 180px;"></canvas>
                        </div>
                    </div>
                </div>

                <!-- 底部詳情區 -->
                <div class="grid grid-cols-2 gap-4 flex-1 min-h-0">
                    <!-- 各倉庫庫存明細 -->
                    <div class="glass-panel p-4 flex flex-col overflow-hidden">
                        <h3 class="text-white font-bold text-sm mb-3"><i class="fa-solid fa-boxes-stacked mr-2 text-purple-400"></i>各區庫存統計</h3>
                        <div class="flex-1 overflow-y-auto">
                            <table class="w-full text-sm">
                                <thead>
                                    <tr class="text-slate-400 border-b border-slate-700">
                                        <th class="text-left p-2">區域</th>
                                        <th class="text-right p-2">棧板數</th>
                                        <th class="text-right p-2">使用率</th>
                                    </tr>
                                </thead>
                                <tbody id="zone-stats-body">
                                    <tr><td colspan="3" class="text-center text-slate-500 py-4">載入中...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- 近期效期品項 -->
                    <div class="glass-panel p-4 flex flex-col overflow-hidden">
                        <h3 class="text-white font-bold text-sm mb-3"><i class="fa-solid fa-triangle-exclamation mr-2 text-red-400"></i>效期警示品項 (30天內)</h3>
                        <div class="flex-1 overflow-y-auto">
                            <table class="w-full text-sm">
                                <thead>
                                    <tr class="text-slate-400 border-b border-slate-700">
                                        <th class="text-left p-2">品名</th>
                                        <th class="text-left p-2">儲位</th>
                                        <th class="text-right p-2">數量</th>
                                        <th class="text-left p-2">效期</th>
                                    </tr>
                                </thead>
                                <tbody id="expiry-alert-body">
                                    <tr><td colspan="4" class="text-center text-slate-500 py-4">載入中...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 工單看板（電視螢幕投放用）-->
            <div id="view-work-board" class="view-panel h-full hidden flex flex-col p-4 bg-slate-950">
                <!-- 頂部控制列 -->
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center gap-4">
                        <h1 class="text-3xl font-bold text-white"><i class="fa-solid fa-clipboard-list mr-3 text-yellow-400"></i>工單看板</h1>
                        <span id="board-update-time" class="text-slate-400 text-lg"></span>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="openTVBoard()" class="px-4 py-2 bg-red-600 hover:bg-red-500 text-white rounded-lg font-bold">
                            <i class="fa-solid fa-tv mr-2"></i>電視投放
                        </button>
                        <button onclick="loadWorkBoardData().then(refreshWorkBoard)" class="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-bold">
                            <i class="fa-solid fa-sync mr-2"></i>刷新
                        </button>
                        <button onclick="toggleBoardFullscreen()" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg font-bold">
                            <i class="fa-solid fa-expand mr-2"></i>全螢幕
                        </button>
                        <select id="board-refresh-interval" class="px-3 py-2 bg-slate-800 border border-slate-600 rounded-lg text-white" onchange="setBoardRefreshInterval()">
                            <option value="0">手動刷新</option>
                            <option value="10">10 秒</option>
                            <option value="30" selected>30 秒</option>
                            <option value="60">1 分鐘</option>
                            <option value="300">5 分鐘</option>
                        </select>
                    </div>
                </div>
                
                <!-- 工單統計摘要 -->
                <div class="grid grid-cols-5 gap-4 mb-4">
                    <div class="bg-gradient-to-br from-green-600 to-green-700 rounded-xl p-4 text-center">
                        <div class="text-5xl font-bold text-white" id="board-pending-count">0</div>
                        <div class="text-green-200 text-lg mt-1">待領料</div>
                    </div>
                    <div class="bg-gradient-to-br from-orange-600 to-orange-700 rounded-xl p-4 text-center">
                        <div class="text-5xl font-bold text-white" id="board-wave-count">0</div>
                        <div class="text-orange-200 text-lg mt-1">揀貨中</div>
                    </div>
                    <div class="bg-gradient-to-br from-purple-600 to-purple-700 rounded-xl p-4 text-center">
                        <div class="text-5xl font-bold text-white" id="board-transfer-count">0</div>
                        <div class="text-purple-200 text-lg mt-1">待調撥</div>
                    </div>
                    <div class="bg-gradient-to-br from-cyan-600 to-cyan-700 rounded-xl p-4 text-center">
                        <div class="text-5xl font-bold text-white" id="board-move-count">0</div>
                        <div class="text-cyan-200 text-lg mt-1">待移位</div>
                    </div>
                    <div class="bg-gradient-to-br from-red-600 to-red-700 rounded-xl p-4 text-center">
                        <div class="text-5xl font-bold text-white" id="board-urgent-count">0</div>
                        <div class="text-red-200 text-lg mt-1">緊急</div>
                    </div>
                </div>
                
                <!-- 工單列表區域 -->
                <div class="flex-1 grid grid-cols-3 gap-4 overflow-hidden">
                    <!-- 領料工單 -->
                    <div class="bg-slate-900 rounded-xl border-2 border-green-600 flex flex-col overflow-hidden">
                        <div class="bg-green-600 px-4 py-3 flex items-center justify-between">
                            <span class="text-xl font-bold text-white"><i class="fa-solid fa-hand mr-2"></i>待領料</span>
                            <span class="bg-green-800 px-3 py-1 rounded-full text-white font-bold" id="board-pending-badge">0</span>
                        </div>
                        <div class="flex-1 overflow-y-auto p-3 space-y-2" id="board-pending-list">
                        </div>
                    </div>
                    
                    <!-- 揀貨工單 -->
                    <div class="bg-slate-900 rounded-xl border-2 border-orange-600 flex flex-col overflow-hidden">
                        <div class="bg-orange-600 px-4 py-3 flex items-center justify-between">
                            <span class="text-xl font-bold text-white"><i class="fa-solid fa-dolly mr-2"></i>揀貨中</span>
                            <span class="bg-orange-800 px-3 py-1 rounded-full text-white font-bold" id="board-wave-badge">0</span>
                        </div>
                        <div class="flex-1 overflow-y-auto p-3 space-y-2" id="board-wave-list">
                        </div>
                    </div>
                    
                    <!-- 調撥/移位工單 -->
                    <div class="bg-slate-900 rounded-xl border-2 border-purple-600 flex flex-col overflow-hidden">
                        <div class="bg-purple-600 px-4 py-3 flex items-center justify-between">
                            <span class="text-xl font-bold text-white"><i class="fa-solid fa-right-left mr-2"></i>調撥/移位</span>
                            <span class="bg-purple-800 px-3 py-1 rounded-full text-white font-bold" id="board-transfer-badge">0</span>
                        </div>
                        <div class="flex-1 overflow-y-auto p-3 space-y-2" id="board-transfer-list">
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-unified-inbound" class="view-panel h-full hidden flex flex-col p-2">
                <input type="hidden" id="in-category" value="Raw">

                <!-- 頂部步驟進度指示器（精簡版）-->
                <div class="flex items-center justify-center gap-1 mb-2 bg-slate-800/80 rounded-lg py-1.5 px-3">
                    <div id="inbound-step-1" class="flex items-center gap-1.5 px-3 py-1 rounded bg-blue-600 text-white text-sm">
                        <span class="w-5 h-5 rounded-full bg-white text-blue-600 flex items-center justify-center font-bold text-xs">1</span>
                        <span class="font-bold">填寫資料</span>
                    </div>
                    <i class="fa-solid fa-chevron-right text-slate-600 text-[10px]"></i>
                    <div id="inbound-step-2" class="flex items-center gap-1.5 px-3 py-1 rounded bg-slate-700 text-slate-400 text-sm">
                        <span class="w-5 h-5 rounded-full bg-slate-600 text-slate-400 flex items-center justify-center font-bold text-xs">2</span>
                        <span>選擇儲位</span>
                    </div>
                    <i class="fa-solid fa-chevron-right text-slate-600 text-[10px]"></i>
                    <div id="inbound-step-3" class="flex items-center gap-1.5 px-3 py-1 rounded bg-slate-700 text-slate-400 text-sm">
                        <span class="w-5 h-5 rounded-full bg-slate-600 text-slate-400 flex items-center justify-center font-bold text-xs">3</span>
                        <span>確認入庫</span>
                    </div>
                    <div class="ml-auto">
                        <button onclick="showPendingInbounds()" class="px-2 py-1 bg-yellow-600 hover:bg-yellow-500 text-white rounded text-xs font-bold">
                            <i class="fa-solid fa-clock mr-1"></i>待執行 <span id="pending-inbound-count" class="bg-yellow-800 px-1 rounded">0</span>
                        </button>
                    </div>
                </div>

                <!-- 三步驟主區域 -->
                <div class="flex gap-2 flex-1 min-h-0">

                    <!-- STEP 1: 產品資訊（優化版）-->
                    <div class="w-80 flex flex-col">
                        <div class="bg-slate-900 border border-slate-600 rounded-lg p-3 flex flex-col h-full overflow-y-auto">

                            <!-- 區塊1: 公司別 -->
                            <div class="mb-3">
                                <div class="text-xs text-slate-500 mb-1.5 flex items-center">
                                    <i class="fa-solid fa-building w-4 text-center mr-1"></i>公司別
                                </div>
                                <div class="flex gap-1 bg-slate-800 rounded-lg p-1">
                                    <label class="flex-1 cursor-pointer">
                                        <input type="radio" name="in-company" value="崇文" class="hidden peer" checked>
                                        <div class="text-center py-2 rounded-md text-sm font-bold peer-checked:bg-blue-600 peer-checked:text-white text-slate-400 transition-all flex items-center justify-center gap-1">
                                            <span class="w-2 h-2 rounded-full bg-blue-400 peer-checked:bg-white"></span>
                                            崇文
                                        </div>
                                    </label>
                                    <label class="flex-1 cursor-pointer">
                                        <input type="radio" name="in-company" value="八方" class="hidden peer">
                                        <div class="text-center py-2 rounded-md text-sm font-bold peer-checked:bg-purple-600 peer-checked:text-white text-slate-400 transition-all flex items-center justify-center gap-1">
                                            <span class="w-2 h-2 rounded-full bg-purple-400"></span>
                                            八方
                                        </div>
                                    </label>
                                </div>
                            </div>

                            <!-- 區塊2: 產品資訊 -->
                            <div class="mb-3">
                                <div class="text-xs text-slate-500 mb-1.5 flex items-center">
                                    <i class="fa-solid fa-box w-4 text-center mr-1"></i>產品資訊
                                </div>
                                <div class="space-y-2">
                                    <!-- 品名 -->
                                    <div class="relative">
                                        <input type="text" id="in-name" class="w-full p-2.5 pr-16 bg-slate-800 border-2 border-emerald-500 rounded-lg text-white font-bold" placeholder="點擊選擇品項..." oninput="updateLivePreview(); updateInboundProgress();" readonly>
                                        <button onclick="openProductSelectModal('inbound')" class="absolute right-1 top-1/2 -translate-y-1/2 px-3 py-1.5 bg-emerald-600 hover:bg-emerald-500 text-white rounded text-xs font-bold">
                                            <i class="fa-solid fa-search mr-1"></i>選擇
                                        </button>
                                    </div>
                                    <input type="hidden" id="in-product-code" value="">
                                    
                                    <!-- 規格 -->
                                    <div class="relative">
                                        <span class="absolute left-2 top-1/2 -translate-y-1/2 text-yellow-400 text-[10px]">規格</span>
                                        <input type="text" id="in-spec" class="w-full p-2 pl-10 bg-slate-800 border border-yellow-500/30 rounded text-yellow-400 text-sm" placeholder="自動帶入" oninput="updateLivePreview();">
                                    </div>
                                </div>
                            </div>

                            <!-- 分隔線 -->
                            <div class="border-t border-slate-700 my-2"></div>

                            <!-- 區塊3: 入庫資料 -->
                            <div class="flex-1">
                                <div class="text-xs text-slate-500 mb-1.5 flex items-center">
                                    <i class="fa-solid fa-clipboard-list w-4 text-center mr-1"></i>入庫資料
                                </div>
                                <div class="space-y-2">
                                    <!-- 批號 + 效期 -->
                                    <div class="grid grid-cols-2 gap-2">
                                        <div class="relative">
                                            <span class="absolute left-2 top-1/2 -translate-y-1/2 text-slate-500 text-[10px]">批號</span>
                                            <input type="text" id="in-batch" class="w-full p-2 pl-9 bg-slate-800 border border-slate-600 rounded text-white text-sm" oninput="updateLivePreview()">
                                        </div>
                                        <div class="relative">
                                            <span class="absolute left-2 top-1/2 -translate-y-1/2 text-orange-400 text-[10px] font-bold">效期*</span>
                                            <div class="flex items-center pl-9 pr-2 bg-slate-800 border border-orange-500/50 rounded h-[38px]">
                                                <input type="text" id="in-exp-year" maxlength="4" placeholder="年" class="w-11 bg-transparent text-white text-sm text-center outline-none" oninput="autoJumpInExp(this, 'year')" onkeydown="handleInExpKeydown(event, 'year')">
                                                <span class="text-slate-500 text-sm">/</span>
                                                <input type="text" id="in-exp-month" maxlength="2" placeholder="月" class="w-7 bg-transparent text-white text-sm text-center outline-none" oninput="autoJumpInExp(this, 'month')" onkeydown="handleInExpKeydown(event, 'month')">
                                                <span class="text-slate-500 text-sm">/</span>
                                                <input type="text" id="in-exp-day" maxlength="2" placeholder="日" class="w-7 bg-transparent text-white text-sm text-center outline-none" oninput="autoJumpInExp(this, 'day')" onkeydown="handleInExpKeydown(event, 'day')">
                                            </div>
                                            <input type="hidden" id="in-exp">
                                        </div>
                                    </div>

                                    <!-- 品項類型標籤（自動判斷）-->
                                    <div id="product-type-badge" class="hidden">
                                        <span id="type-badge-label" class="px-2 py-1 rounded text-xs font-bold bg-blue-600/20 text-blue-400 border border-blue-500/30">
                                            📦 定重品
                                        </span>
                                        <input type="radio" name="in-product-type" value="fixed" class="hidden" checked>
                                        <input type="radio" name="in-product-type" value="variable" class="hidden">
                                    </div>

                                    <!-- 定重品：數量 -->
                                    <div id="fixed-weight-fields">
                                        <div class="relative">
                                            <span class="absolute left-2 top-1/2 -translate-y-1/2 text-cyan-400 text-xs font-bold">數量*</span>
                                            <input type="number" id="in-qty" class="w-full p-2.5 pl-12 pr-10 bg-slate-800 border-2 border-cyan-500/50 rounded-lg text-white text-lg font-bold text-center" placeholder="0" oninput="updateLivePreview(); updateInboundProgress();">
                                            <span class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm">件</span>
                                        </div>
                                    </div>

                                    <!-- 不定重品：數量 + 總重量 -->
                                    <div id="variable-weight-fields" class="hidden space-y-2">
                                        <div class="grid grid-cols-2 gap-2">
                                            <div class="relative">
                                                <span class="absolute left-2 top-1/2 -translate-y-1/2 text-amber-400 text-[10px] font-bold">數量*</span>
                                                <input type="number" id="in-qty-var" class="w-full p-2 pl-10 pr-6 bg-slate-800 border border-amber-500/50 rounded text-white text-sm font-bold text-center" oninput="updateLivePreview(); updateInboundProgress(); calcAvgWeight();">
                                                <span class="absolute right-2 top-1/2 -translate-y-1/2 text-amber-500 text-[10px]">件</span>
                                            </div>
                                            <div class="relative">
                                                <span class="absolute left-2 top-1/2 -translate-y-1/2 text-amber-400 text-[10px] font-bold">總重*</span>
                                                <input type="number" id="in-weight" class="w-full p-2 pl-10 pr-6 bg-slate-800 border border-amber-500/50 rounded text-white text-sm font-bold text-center" step="0.1" oninput="updateLivePreview(); calcAvgWeight(); updateInboundProgress();">
                                                <span class="absolute right-2 top-1/2 -translate-y-1/2 text-amber-500 text-[10px]">kg</span>
                                            </div>
                                        </div>
                                        <div id="avg-weight-hint" class="text-[10px] text-amber-400 bg-amber-900/20 rounded px-2 py-1 hidden">
                                            <i class="fa-solid fa-calculator mr-1"></i>均重：<span id="avg-weight-value">-</span> kg/件
                                        </div>
                                    </div>

                                    <!-- 更多選項 -->
                                    <div class="border-t border-dashed border-slate-700 pt-2 mt-2">
                                        <button onclick="toggleInboundMoreOptions()" id="btn-more-options" class="w-full py-1 text-slate-500 hover:text-slate-300 text-xs flex items-center justify-center gap-1">
                                            <i class="fa-solid fa-chevron-down" id="more-options-icon"></i>
                                            <span id="more-options-text">更多選項</span>
                                        </button>
                                        <div id="more-options-panel" class="hidden mt-2 space-y-2">
                                            <div class="relative">
                                                <span class="absolute left-2 top-1/2 -translate-y-1/2 text-slate-500 text-[10px]">廠商</span>
                                                <input type="text" id="in-vendor" class="w-full p-1.5 pl-10 bg-slate-800 border border-slate-600 rounded text-white text-sm" oninput="updateLivePreview()">
                                            </div>
                                            <div id="unit-weight-option" class="relative">
                                                <span class="absolute left-2 top-1/2 -translate-y-1/2 text-slate-500 text-[10px]">箱容</span>
                                                <input type="number" id="in-unit-weight" class="w-full p-1.5 pl-10 pr-8 bg-slate-800 border border-slate-600 rounded text-white text-sm" step="0.1" oninput="updateLivePreview();">
                                                <span class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-500 text-[10px]">kg</span>
                                            </div>
                                            <div>
                                                <div class="text-[10px] text-slate-500 mb-1">入庫類型</div>
                                                <div class="grid grid-cols-4 gap-1">
                                                    <button type="button" onclick="selectInboundType('Raw')" id="btn-type-Raw" class="inbound-type-btn active py-1 rounded border border-emerald-500 bg-emerald-900/50 text-white text-[10px] font-bold">採購</button>
                                                    <button type="button" onclick="selectInboundType('FG')" id="btn-type-FG" class="inbound-type-btn py-1 rounded border border-slate-600 bg-slate-800 text-slate-400 text-[10px]">成品</button>
                                                    <button type="button" onclick="selectInboundType('WIP')" id="btn-type-WIP" class="inbound-type-btn py-1 rounded border border-slate-600 bg-slate-800 text-slate-400 text-[10px]">半成品</button>
                                                    <button type="button" onclick="selectInboundType('RM')" id="btn-type-RM" class="inbound-type-btn py-1 rounded border border-slate-600 bg-slate-800 text-slate-400 text-[10px]">原料</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 中間區塊: 目標倉庫 + 儲位選擇 -->
                    <div class="flex-1 flex flex-col min-w-0">
                        
                        <!-- 目標倉庫選擇 -->
                        <div class="bg-slate-900 border border-slate-600 rounded-lg p-3 mb-2">
                            <div class="text-xs text-slate-500 mb-1.5 flex items-center">
                                <i class="fa-solid fa-warehouse w-4 text-center mr-1"></i>目標倉庫
                            </div>
                            <select id="in-warehouse" class="w-full p-2 bg-slate-800 border border-slate-600 rounded-md text-white text-sm font-bold" onchange="onWarehouseChange()">
                                <optgroup label="本倉"><option value="MAIN">🏭 一般庫存</option><option value="MAIN-CONSIGN">📦 客戶寄倉</option></optgroup>
                                <optgroup label="崇文外倉" id="optgroup-cw"></optgroup>
                                <optgroup label="八方外倉" id="optgroup-bf"></optgroup>
                                <optgroup label="──"><option value="MANAGE">⚙️ 管理倉庫</option></optgroup>
                            </select>
                        </div>
                        
                        <!-- 外倉提示區域 -->
                        <div id="external-wh-section" class="bg-teal-900/40 border border-teal-500 rounded-lg p-4 flex-1 hidden">
                            <div class="text-teal-400 font-bold text-sm mb-2" id="inbound-wh-title">
                                <i class="fa-solid fa-building mr-1"></i>外倉入庫
                            </div>
                            <div class="flex-1 flex items-center justify-center h-full">
                                <div class="text-center">
                                    <i class="fa-solid fa-building text-5xl text-teal-400 mb-3"></i>
                                    <p class="text-slate-300 text-sm mb-1">外倉入庫不需指定儲位</p>
                                    <p class="text-slate-500 text-xs">系統將自動記錄到外倉庫存</p>
                                </div>
                            </div>
                        </div>

                        <!-- 本倉儲位選擇區域 -->
                        <div id="location-section" class="bg-emerald-900/40 border border-emerald-500 rounded-lg p-3 flex flex-col flex-1">
                            <div class="flex justify-between items-center mb-2">
                                <div class="text-emerald-400 font-bold text-sm"><i class="fa-solid fa-map-marker-alt mr-1"></i>選擇儲位</div>
                                <input type="text" id="in-loc" class="w-32 p-1.5 bg-slate-800 border-2 border-emerald-500 rounded text-sm font-bold text-emerald-400 text-center" placeholder="儲位" oninput="validateLocationInput(); updateInboundProgress();" onchange="validateLocationInput()">
                            </div>

                            <!-- 快速選擇暫存區（精簡版）-->
                            <div class="mb-2 p-2 bg-slate-800/70 rounded border border-amber-500/30">
                                <div class="flex flex-wrap gap-1">
                                    <button onclick="selectVirtualLocation('TEMP-IN')" class="px-3 py-1.5 bg-emerald-700 hover:bg-emerald-600 text-white rounded text-xs font-bold">
                                        <i class="fa-solid fa-truck-loading mr-1"></i>進貨暫存
                                    </button>
                                    <button onclick="selectVirtualLocation('TEMP-OUT')" class="px-3 py-1.5 bg-orange-700 hover:bg-orange-600 text-white rounded text-xs font-bold">
                                        <i class="fa-solid fa-truck mr-1"></i>出貨暫存
                                    </button>
                                    <button onclick="selectVirtualLocation('A00')" class="px-2 py-1 bg-blue-800 hover:bg-blue-700 text-white rounded text-[10px]">A00</button>
                                    <button onclick="selectVirtualLocation('B00')" class="px-2 py-1 bg-indigo-800 hover:bg-indigo-700 text-white rounded text-[10px]">B00</button>
                                    <button onclick="selectVirtualLocation('C00')" class="px-2 py-1 bg-purple-800 hover:bg-purple-700 text-white rounded text-[10px]">C00</button>
                                    <button onclick="selectVirtualLocation('D00')" class="px-2 py-1 bg-pink-800 hover:bg-pink-700 text-white rounded text-[10px]">D00</button>
                                    <button onclick="selectVirtualLocation('OTHER')" class="px-2 py-1 bg-slate-700 hover:bg-slate-600 text-white rounded text-[10px]">其他</button>
                                </div>
                            </div>

                            <!-- 智能建議列表（自動顯示）-->
                            <div id="smart-suggest-panel" class="mb-2">
                                <div class="flex items-center justify-between mb-1">
                                    <span class="text-xs text-yellow-400 font-bold"><i class="fa-solid fa-wand-magic-sparkles mr-1"></i>智能建議</span>
                                    <span id="suggest-loading" class="text-[10px] text-slate-500 hidden"><i class="fa-solid fa-spinner fa-spin mr-1"></i>分析中...</span>
                                </div>
                                <div id="smart-suggest-list">
                                    <div class="text-slate-500 text-xs text-center py-2">請先選擇品項</div>
                                </div>
                            </div>

                            <!-- 倉庫地圖 -->
                            <div class="flex-1 bg-slate-900/80 rounded border border-slate-700 p-2 overflow-auto relative">
                                <div class="absolute top-1 right-1 bg-slate-800/90 p-1 px-2 rounded text-[10px] text-slate-400 flex gap-2 z-10">
                                    <span><i class="fa-solid fa-star text-yellow-400 mr-1"></i>推薦</span>
                                    <span class="text-emerald-400">□ 空位</span>
                                </div>
                                <div class="inbound-map-container">
                                    <div class="inbound-map-row">
                                        <div class="inbound-warehouse"><div class="text-blue-400 font-bold text-xs mb-1">I 庫</div><div class="inbound-zone"><span class="text-[10px] text-slate-400">A</span><div class="rack-lanes-grid-inbound" id="grid-I-A-map"></div></div><div class="inbound-zone"><span class="text-[10px] text-slate-400">B</span><div class="rack-lanes-grid-inbound" id="grid-I-B-map"></div></div></div>
                                        <div class="inbound-warehouse"><div class="text-purple-400 font-bold text-xs mb-1">J 庫</div><div class="inbound-zone"><span class="text-[10px] text-slate-400">C</span><div class="rack-lanes-grid-inbound" id="grid-J-C-map"></div></div><div class="inbound-zone"><span class="text-[10px] text-slate-400">D</span><div class="rack-lanes-grid-inbound" id="grid-J-D-map"></div></div></div>
                                    </div>
                                    <div class="inbound-warehouse-k"><div class="text-emerald-400 font-bold text-xs mb-1">K 庫</div><div class="inbound-k-zones"><div class="inbound-zone-k"><span class="text-[10px] text-slate-400">E</span><div class="rack-lanes-grid-k" id="grid-K-E-map"></div></div><div class="inbound-zone-k"><span class="text-[10px] text-slate-400">F</span><div class="rack-lanes-grid-k" id="grid-K-F-map"></div></div><div class="inbound-zone-k"><span class="text-[10px] text-slate-400">G</span><div class="rack-lanes-grid-k" id="grid-K-G-map"></div></div><div class="inbound-zone-k"><span class="text-[10px] text-slate-400">H</span><div class="rack-lanes-grid-k" id="grid-K-H-map"></div></div></div></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- STEP 3: 預覽確認（精簡版）-->
                    <div class="w-48 flex flex-col">
                        <div class="bg-purple-900/40 border border-purple-500 rounded-lg p-3 flex flex-col h-full">
                            <div class="text-purple-400 font-bold text-sm mb-2"><i class="fa-solid fa-check-circle mr-1"></i>確認入庫</div>

                            <!-- 待確認清單（公司、品名、數量、效期、儲位）-->
                            <div id="inbound-checklist" class="bg-slate-800/70 rounded p-2 mb-2 text-xs space-y-1">
                                <div class="flex items-center gap-1" id="check-company"><i class="fa-solid fa-circle text-slate-600 text-[8px]"></i><span class="text-slate-500">公司</span></div>
                                <div class="flex items-center gap-1" id="check-name"><i class="fa-solid fa-circle text-slate-600 text-[8px]"></i><span class="text-slate-500">品名</span></div>
                                <div class="flex items-center gap-1" id="check-qty"><i class="fa-solid fa-circle text-slate-600 text-[8px]"></i><span class="text-slate-500">數量</span></div>
                                <div class="flex items-center gap-1" id="check-exp"><i class="fa-solid fa-circle text-slate-600 text-[8px]"></i><span class="text-slate-500">效期</span></div>
                                <div class="flex items-center gap-1" id="check-loc"><i class="fa-solid fa-circle text-slate-600 text-[8px]"></i><span class="text-slate-500">儲位</span></div>
                            </div>

                            <!-- 入庫指令單預覽（精簡版）-->
                            <div id="live-preview-box" class="bg-white rounded p-2 text-center mb-2">
                                <div class="text-sm font-black text-black truncate" id="prev-name">-</div>
                                <div class="text-xs font-bold text-gray-600" id="prev-spec">-</div>
                                <div class="flex justify-between text-[9px] text-gray-500 mt-1 pt-1 border-t">
                                    <span id="prev-batch">批: -</span>
                                    <span id="prev-exp">效: -</span>
                                </div>
                                <div class="flex items-center justify-between mt-1 pt-1 border-t border-black">
                                    <span class="text-xs font-bold text-black" id="prev-loc">-</span>
                                    <span class="text-lg font-black text-red-600" id="prev-qty">0</span>
                                </div>
                            </div>

                            <!-- 操作按鈕（智能判斷版）-->
                            <div class="space-y-1.5 flex-1 flex flex-col justify-end">
                                <!-- 本倉模式按鈕 -->
                                <div id="main-wh-buttons">
                                    <button onclick="smartInbound('print')" id="btn-inbound-print" class="w-full py-3 bg-emerald-600 hover:bg-emerald-500 disabled:bg-slate-700 disabled:cursor-not-allowed text-white rounded font-bold text-sm mb-1.5" disabled>
                                        <i class="fa-solid fa-print mr-1"></i>🖨️ 列印並入庫
                                    </button>
                                    <button onclick="smartInbound('direct')" id="btn-inbound-direct" class="w-full py-2 bg-blue-600 hover:bg-blue-500 disabled:bg-slate-700 disabled:cursor-not-allowed text-white rounded text-sm" disabled>
                                        <i class="fa-solid fa-bolt mr-1"></i>📦 確認入庫
                                    </button>
                                </div>
                                <!-- 外倉模式按鈕 -->
                                <div id="external-wh-buttons" class="hidden">
                                    <button onclick="smartInbound('external')" id="btn-inbound-external" class="w-full py-3 bg-teal-600 hover:bg-teal-500 disabled:bg-slate-700 disabled:cursor-not-allowed text-white rounded font-bold text-sm" disabled>
                                        <i class="fa-solid fa-building mr-1"></i>📦 確認入庫（外倉）
                                    </button>
                                </div>
                                <!-- 進階選項 -->
                                <div class="pt-1 border-t border-slate-700">
                                    <button onclick="toggleAdvancedOptions()" class="w-full py-1 text-slate-500 hover:text-slate-300 text-xs">
                                        <i class="fa-solid fa-chevron-down mr-1" id="advanced-icon"></i>進階選項
                                    </button>
                                    <div id="advanced-options" class="hidden mt-1 space-y-1">
                                        <button onclick="createInboundOrder()" class="w-full py-1.5 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded text-xs border border-slate-600">
                                            <i class="fa-solid fa-clock mr-1"></i>加入待執行入庫單（排程）
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 待財務核准頁面 -->
            <div id="view-approval" class="view-panel h-full hidden flex flex-col p-4">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h2 class="text-white font-bold text-lg"><i class="fa-solid fa-clipboard-check text-yellow-400 mr-2"></i>待財務核准入庫單</h2>
                        <p class="text-slate-400 text-sm">採購進貨需經財務審核後才能入庫</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="refreshApprovalList()" class="px-3 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded text-sm">
                            <i class="fa-solid fa-refresh mr-1"></i>重新整理
                        </button>
                    </div>
                </div>

                <!-- 篩選 -->
                <div class="flex gap-4 mb-4">
                    <select id="approval-status-filter" class="scan-input w-40" onchange="filterApprovalList()">
                        <option value="pending">待審核</option>
                        <option value="rejected">已駁回</option>
                        <option value="approved">已審核</option>
                        <option value="all">全部</option>
                    </select>
                    <input type="text" id="approval-search" class="scan-input flex-1" placeholder="搜尋品名、單號..." oninput="filterApprovalList()">
                </div>

                <!-- 列表 -->
                <div class="glass-panel flex-1 overflow-auto">
                    <table class="w-full text-sm">
                        <thead class="sticky top-0 bg-slate-800">
                            <tr class="text-slate-400 text-xs">
                                <th class="p-3 text-left">單號</th>
                                <th class="p-3 text-left">品名</th>
                                <th class="p-3 text-left">規格</th>
                                <th class="p-3 text-left">批號</th>
                                <th class="p-3 text-left">效期</th>
                                <th class="p-3 text-right">數量</th>
                                <th class="p-3 text-left">儲位</th>
                                <th class="p-3 text-left">廠商</th>
                                <th class="p-3 text-left">建單人</th>
                                <th class="p-3 text-left">建單時間</th>
                                <th class="p-3 text-center">狀態</th>
                                <th class="p-3 text-center">操作</th>
                            </tr>
                        </thead>
                        <tbody id="approval-list-body">
                            <tr><td colspan="12" class="text-center text-slate-500 py-10">載入中...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="view-pre-inbound" class="view-panel h-full hidden flex flex-col p-2">
                <!-- 頂部步驟進度指示器（與智能入庫中心一致）-->
                <div class="flex items-center justify-center gap-1 mb-2 bg-slate-800/80 rounded-lg py-1.5 px-3">
                    <div id="container-step-1" class="flex items-center gap-1.5 px-3 py-1 rounded bg-blue-600 text-white text-sm">
                        <span class="w-5 h-5 rounded-full bg-white text-blue-600 flex items-center justify-center font-bold text-xs">1</span>
                        <span class="font-bold">填寫資料</span>
                    </div>
                    <i class="fa-solid fa-chevron-right text-slate-600 text-[10px]"></i>
                    <div id="container-step-2" class="flex items-center gap-1.5 px-3 py-1 rounded bg-slate-700 text-slate-400 text-sm">
                        <span class="w-5 h-5 rounded-full bg-slate-600 text-slate-400 flex items-center justify-center font-bold text-xs">2</span>
                        <span>選擇儲位</span>
                    </div>
                    <i class="fa-solid fa-chevron-right text-slate-600 text-[10px]"></i>
                    <div id="container-step-3" class="flex items-center gap-1.5 px-3 py-1 rounded bg-slate-700 text-slate-400 text-sm">
                        <span class="w-5 h-5 rounded-full bg-slate-600 text-slate-400 flex items-center justify-center font-bold text-xs">3</span>
                        <span>確認入庫</span>
                    </div>
                    <div class="ml-auto flex items-center gap-2">
                        <span class="text-xs text-slate-400">待入庫：<span id="container-pending-count" class="text-yellow-400 font-bold">0</span> 品項 / <span id="container-pending-pallets" class="text-emerald-400 font-bold">0</span> 板</span>
                    </div>
                </div>

                <!-- 三步驟主區域（與智能入庫中心寬度一致）-->
                <div class="flex gap-2 flex-1 min-h-0">

                    <!-- STEP 1: 產品資訊（w-80）-->
                    <div class="w-80 flex flex-col">
                        <div class="bg-slate-900 border border-slate-600 rounded-lg p-3 flex flex-col h-full overflow-y-auto">

                            <!-- 區塊1: 公司別 -->
                            <div class="mb-3">
                                <div class="text-xs text-slate-500 mb-1.5 flex items-center">
                                    <i class="fa-solid fa-building w-4 text-center mr-1"></i>公司別
                                </div>
                                <div class="flex gap-1 bg-slate-800 rounded-lg p-1">
                                    <label class="flex-1 cursor-pointer">
                                        <input type="radio" name="pre-company" value="崇文" class="hidden peer" checked onchange="updateContainerChecklist()">
                                        <div class="text-center py-2 rounded-md text-sm font-bold peer-checked:bg-blue-600 peer-checked:text-white text-slate-400 transition-all flex items-center justify-center gap-1">
                                            <span class="w-2 h-2 rounded-full bg-blue-400 peer-checked:bg-white"></span>
                                            崇文
                                        </div>
                                    </label>
                                    <label class="flex-1 cursor-pointer">
                                        <input type="radio" name="pre-company" value="八方" class="hidden peer" onchange="updateContainerChecklist()">
                                        <div class="text-center py-2 rounded-md text-sm font-bold peer-checked:bg-purple-600 peer-checked:text-white text-slate-400 transition-all flex items-center justify-center gap-1">
                                            <span class="w-2 h-2 rounded-full bg-purple-400"></span>
                                            八方
                                        </div>
                                    </label>
                                </div>
                            </div>

                            <!-- 區塊2: 匯入方式切換 -->
                            <div class="mb-3">
                                <div class="text-xs text-slate-500 mb-1.5 flex items-center">
                                    <i class="fa-solid fa-file-import w-4 text-center mr-1"></i>匯入方式
                                </div>
                                <div class="flex gap-1 bg-slate-800 rounded-lg p-1">
                                    <button onclick="switchContainerInputMode('manual')" id="btn-mode-manual" class="flex-1 py-1.5 rounded text-xs font-bold bg-cyan-600 text-white transition-all">
                                        <i class="fa-solid fa-keyboard mr-1"></i>手動新增
                                    </button>
                                    <button onclick="switchContainerInputMode('excel')" id="btn-mode-excel" class="flex-1 py-1.5 rounded text-xs font-bold bg-slate-700 text-slate-400 hover:bg-slate-600 transition-all">
                                        <i class="fa-solid fa-file-excel mr-1"></i>Excel匯入
                                    </button>
                                </div>
                            </div>

                            <!-- Excel 匯入區（預設隱藏）-->
                            <div id="container-excel-panel" class="hidden mb-3">
                                <input type="file" id="containerExcel" accept=".xlsx" class="hidden" onchange="handleContainerImport(event)">
                                <button onclick="document.getElementById('containerExcel').click()" class="w-full py-3 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg text-sm font-bold mb-2">
                                    <i class="fa-solid fa-upload mr-1"></i>上傳 Excel 檔案
                                </button>
                                <div class="flex justify-between items-center">
                                    <span class="text-[10px] text-slate-500">支援 .xlsx 格式</span>
                                    <button onclick="downloadTemplate('container')" class="text-[10px] text-blue-400 hover:text-blue-300 underline">下載範本</button>
                                </div>
                            </div>

                            <!-- 手動新增區（預設顯示）-->
                            <div id="container-manual-panel">
                                <!-- 產品資訊 -->
                                <div class="mb-3">
                                    <div class="text-xs text-slate-500 mb-1.5 flex items-center">
                                        <i class="fa-solid fa-box w-4 text-center mr-1"></i>產品資訊
                                    </div>
                                    <div class="space-y-2">
                                        <div class="relative">
                                            <input type="text" id="pre-name" class="w-full p-2.5 pr-16 bg-slate-800 border-2 border-emerald-500 rounded-lg text-white font-bold" placeholder="點擊選擇品項..." readonly>
                                            <button onclick="openProductSelectModal('container')" class="absolute right-1 top-1/2 -translate-y-1/2 px-3 py-1.5 bg-emerald-600 hover:bg-emerald-500 text-white rounded text-xs font-bold">
                                                <i class="fa-solid fa-search mr-1"></i>選擇
                                            </button>
                                        </div>
                                        <input type="hidden" id="pre-product-code" value="">
                                        <div class="relative">
                                            <span class="absolute left-2 top-1/2 -translate-y-1/2 text-yellow-400 text-[10px]">規格</span>
                                            <input type="text" id="pre-spec" class="w-full p-2 pl-10 bg-slate-800 border border-yellow-500/30 rounded text-yellow-400 text-sm" placeholder="自動帶入">
                                        </div>
                                    </div>
                                </div>

                                <!-- 分隔線 -->
                                <div class="border-t border-slate-700 my-2"></div>

                                <!-- 入庫資料 -->
                                <div class="mb-3">
                                    <div class="text-xs text-slate-500 mb-1.5 flex items-center">
                                        <i class="fa-solid fa-clipboard-list w-4 text-center mr-1"></i>入庫資料
                                    </div>
                                    <div class="grid grid-cols-2 gap-2 mb-2">
                                        <div class="relative">
                                            <span class="absolute left-2 top-1/2 -translate-y-1/2 text-slate-500 text-[10px]">批號</span>
                                            <input type="text" id="pre-batch" class="w-full p-2 pl-9 bg-slate-800 border border-slate-600 rounded text-white text-sm" oninput="updateContainerChecklist()" onkeydown="if(event.key==='Enter'){event.preventDefault();document.getElementById('pre-exp').focus();}">
                                        </div>
                                        <div class="relative">
                                            <span class="absolute left-2 top-1/2 -translate-y-1/2 text-orange-400 text-[10px]">效期*</span>
                                            <div class="flex items-center pl-9 pr-2 bg-slate-800 border border-orange-500/50 rounded h-[38px]">
                                                <input type="text" id="pre-exp-year" maxlength="4" placeholder="年" class="w-11 bg-transparent text-white text-sm text-center outline-none" oninput="autoJumpPreExp(this, 'year')" onkeydown="handlePreExpKeydown(event, 'year')">
                                                <span class="text-slate-500 text-sm">/</span>
                                                <input type="text" id="pre-exp-month" maxlength="2" placeholder="月" class="w-7 bg-transparent text-white text-sm text-center outline-none" oninput="autoJumpPreExp(this, 'month')" onkeydown="handlePreExpKeydown(event, 'month')">
                                                <span class="text-slate-500 text-sm">/</span>
                                                <input type="text" id="pre-exp-day" maxlength="2" placeholder="日" class="w-7 bg-transparent text-white text-sm text-center outline-none" oninput="autoJumpPreExp(this, 'day')" onkeydown="handlePreExpKeydown(event, 'day')">
                                            </div>
                                            <input type="hidden" id="pre-exp">
                                        </div>
                                    </div>

                                    <!-- 品項類型標籤 -->
                                    <div id="pre-product-type-badge" class="mb-2 hidden">
                                        <span id="pre-type-badge-label" class="px-2 py-1 rounded text-xs font-bold bg-blue-600/20 text-blue-400 border border-blue-500/30">
                                            📦 定重品
                                        </span>
                                        <input type="radio" name="pre-product-type" value="fixed" class="hidden" checked>
                                        <input type="radio" name="pre-product-type" value="variable" class="hidden">
                                    </div>

                                    <!-- 定重品欄位 -->
                                    <div id="pre-fixed-fields">
                                        <div class="relative">
                                            <span class="absolute left-2 top-1/2 -translate-y-1/2 text-cyan-400 text-xs font-bold">數量*</span>
                                            <input type="number" id="pre-qty" class="w-full p-2.5 pl-12 pr-8 bg-slate-800 border-2 border-cyan-500/50 rounded-lg text-white text-lg font-bold text-center" placeholder="0" oninput="updateContainerChecklist()" onkeydown="if(event.key==='Enter'){event.preventDefault();addContainerItemAndGenerate();}">
                                            <span class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 text-sm">件</span>
                                        </div>
                                    </div>

                                    <!-- 不定重品欄位 -->
                                    <div id="pre-variable-fields" class="hidden space-y-2">
                                        <div class="grid grid-cols-2 gap-2">
                                            <div class="relative">
                                                <span class="absolute left-2 top-1/2 -translate-y-1/2 text-amber-400 text-[10px]">數量*</span>
                                                <input type="number" id="pre-qty-var" class="w-full p-2 pl-10 pr-6 bg-slate-800 border border-amber-500/50 rounded text-white text-sm font-bold text-center" oninput="updateContainerChecklist()" onkeydown="if(event.key==='Enter'){event.preventDefault();document.getElementById('pre-total-weight').focus();}">
                                                <span class="absolute right-2 top-1/2 -translate-y-1/2 text-amber-500 text-[10px]">件</span>
                                            </div>
                                            <div class="relative">
                                                <span class="absolute left-2 top-1/2 -translate-y-1/2 text-amber-400 text-[10px]">總重*</span>
                                                <input type="number" id="pre-total-weight" class="w-full p-2 pl-10 pr-6 bg-slate-800 border border-amber-500/50 rounded text-white text-sm font-bold text-center" step="0.1" onkeydown="if(event.key==='Enter'){event.preventDefault();addContainerItemAndGenerate();}">
                                                <span class="absolute right-2 top-1/2 -translate-y-1/2 text-amber-500 text-[10px]">kg</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 更多選項 -->
                                <div class="border-t border-dashed border-slate-700 pt-2">
                                    <button onclick="toggleContainerMoreOptions()" id="btn-container-more" class="w-full py-1 text-slate-500 hover:text-slate-300 text-xs flex items-center justify-center gap-1">
                                        <i class="fa-solid fa-chevron-down" id="container-more-icon"></i>
                                        <span id="container-more-text">更多選項</span>
                                    </button>
                                    <div id="container-more-panel" class="hidden mt-2 space-y-2">
                                        <div class="relative">
                                            <span class="absolute left-2 top-1/2 -translate-y-1/2 text-slate-500 text-[10px]">廠商</span>
                                            <input type="text" id="pre-vendor" class="w-full p-2 pl-10 bg-slate-800 border border-slate-600 rounded text-white text-sm">
                                        </div>
                                        <div class="grid grid-cols-2 gap-2">
                                            <div class="relative">
                                                <span class="absolute left-2 top-1/2 -translate-y-1/2 text-slate-500 text-[10px]">每板數</span>
                                                <input type="number" id="pre-per-pallet" class="w-full p-2 pl-14 bg-slate-800 border border-slate-600 rounded text-white text-sm text-center" value="40">
                                            </div>
                                            <div class="relative" id="pre-unit-weight-row">
                                                <span class="absolute left-2 top-1/2 -translate-y-1/2 text-slate-500 text-[10px]">箱容</span>
                                                <input type="number" id="pre-unit-weight" class="w-full p-2 pl-10 pr-6 bg-slate-800 border border-slate-600 rounded text-white text-sm text-center" step="0.1">
                                                <span class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-500 text-[10px]">kg</span>
                                            </div>
                                        </div>
                                        <div id="pre-per-pallet-var-row" class="hidden relative">
                                            <span class="absolute left-2 top-1/2 -translate-y-1/2 text-slate-500 text-[10px]">每板數</span>
                                            <input type="number" id="pre-per-pallet-var" class="w-full p-2 pl-14 bg-slate-800 border border-slate-600 rounded text-white text-sm text-center" value="40">
                                        </div>
                                    </div>
                                </div>

                                <!-- 新增按鈕 -->
                                <button onclick="addContainerItemAndGenerate()" class="w-full py-2.5 bg-blue-600 hover:bg-blue-500 text-white rounded-lg text-sm font-bold mt-3">
                                    <i class="fa-solid fa-plus mr-1"></i>新增到清單
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- STEP 2: 儲位選擇（flex-1）-->
                    <div class="flex-1 flex flex-col">
                        <div class="bg-emerald-900/40 border border-emerald-500 rounded-lg p-3 flex flex-col h-full">
                            <div class="flex justify-between items-center mb-2">
                                <div class="text-emerald-400 font-bold text-sm"><i class="fa-solid fa-map-marker-alt mr-1"></i>選擇儲位</div>
                                <button onclick="showAvailableLocations()" class="text-[10px] text-blue-400 hover:text-blue-300 underline">查看空位詳情</button>
                            </div>

                            <!-- 智能建議區域 -->
                            <div class="mb-2 p-2 bg-slate-800/70 rounded border border-yellow-500/30">
                                <div class="flex items-center justify-between mb-1">
                                    <span class="text-xs text-yellow-400 font-bold"><i class="fa-solid fa-wand-magic-sparkles mr-1"></i>智能建議</span>
                                    <span class="text-[10px] text-slate-500">依據現有庫存位置推薦</span>
                                </div>
                                <div id="container-smart-suggest-list">
                                    <div class="text-slate-500 text-xs text-center py-2">請先選擇品項</div>
                                </div>
                            </div>

                            <!-- 儲位策略設定 -->
                            <div class="mb-2 p-2 bg-slate-800/70 rounded">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="text-xs text-slate-400">區域：</span>
                                    <div class="flex gap-1 flex-1">
                                        <label class="zone-check-btn"><input type="checkbox" value="A" checked class="container-zone-cb hidden" onchange="onContainerZoneChange()"><span class="block text-center px-2 py-1 rounded text-xs font-bold cursor-pointer bg-blue-600 text-white">A</span></label>
                                        <label class="zone-check-btn"><input type="checkbox" value="B" checked class="container-zone-cb hidden" onchange="onContainerZoneChange()"><span class="block text-center px-2 py-1 rounded text-xs font-bold cursor-pointer bg-blue-600 text-white">B</span></label>
                                        <label class="zone-check-btn"><input type="checkbox" value="C" class="container-zone-cb hidden" onchange="onContainerZoneChange()"><span class="block text-center px-2 py-1 rounded text-xs font-bold cursor-pointer bg-slate-700 text-slate-400">C</span></label>
                                        <label class="zone-check-btn"><input type="checkbox" value="D" class="container-zone-cb hidden" onchange="onContainerZoneChange()"><span class="block text-center px-2 py-1 rounded text-xs font-bold cursor-pointer bg-slate-700 text-slate-400">D</span></label>
                                        <label class="zone-check-btn"><input type="checkbox" value="E" class="container-zone-cb hidden" onchange="onContainerZoneChange()"><span class="block text-center px-2 py-1 rounded text-xs font-bold cursor-pointer bg-slate-700 text-slate-400">E</span></label>
                                        <label class="zone-check-btn"><input type="checkbox" value="F" class="container-zone-cb hidden" onchange="onContainerZoneChange()"><span class="block text-center px-2 py-1 rounded text-xs font-bold cursor-pointer bg-slate-700 text-slate-400">F</span></label>
                                        <label class="zone-check-btn"><input type="checkbox" value="G" class="container-zone-cb hidden" onchange="onContainerZoneChange()"><span class="block text-center px-2 py-1 rounded text-xs font-bold cursor-pointer bg-slate-700 text-slate-400">G</span></label>
                                        <label class="zone-check-btn"><input type="checkbox" value="H" class="container-zone-cb hidden" onchange="onContainerZoneChange()"><span class="block text-center px-2 py-1 rounded text-xs font-bold cursor-pointer bg-slate-700 text-slate-400">H</span></label>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <select id="container-strategy" class="flex-1 p-1.5 bg-slate-700 border border-slate-600 rounded text-white text-xs" onchange="autoGenerateLabels()">
                                        <option value="clustered" selected>同品項集中</option>
                                        <option value="sequential">順序分配</option>
                                    </select>
                                    <label class="flex items-center gap-1 text-xs text-slate-400 whitespace-nowrap">
                                        <input type="checkbox" id="container-skip-occupied" checked class="w-3 h-3">跳過佔用
                                    </label>
                                    <span id="available-count" class="text-xs text-emerald-400"></span>
                                </div>
                            </div>
                            <select id="container-zones" class="hidden"></select>

                            <!-- 待入庫清單 -->
                            <div class="flex-1 flex flex-col min-h-0">
                                <div class="flex justify-between items-center mb-1">
                                    <span class="text-xs text-slate-400">📋 待入庫清單</span>
                                    <button onclick="clearContainerItems()" class="text-[10px] text-red-400 hover:text-red-300">清除全部</button>
                                </div>
                                <div id="container-items-list" class="flex-1 overflow-y-auto bg-slate-800/50 rounded p-2 space-y-2">
                                    <div class="text-center text-slate-500 py-6">
                                        <i class="fa-solid fa-box-open text-2xl mb-2"></i>
                                        <div class="text-xs">尚無品項</div>
                                        <div class="text-[10px] text-slate-600">請匯入 Excel 或手動新增</div>
                                    </div>
                                </div>
                                <div id="container-summary" class="mt-2 pt-2 border-t border-slate-700 hidden">
                                    <div class="grid grid-cols-3 gap-2 text-center text-xs">
                                        <div><span class="text-slate-400">品項</span> <span class="text-white font-bold" id="container-item-count">0</span></div>
                                        <div><span class="text-slate-400">板數</span> <span class="text-yellow-400 font-bold" id="container-pallet-count">0</span></div>
                                        <div><span class="text-slate-400">數量</span> <span class="text-emerald-400 font-bold" id="container-total-qty">0</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- STEP 3: 預覽確認（w-48）-->
                    <div class="w-48 flex flex-col">
                        <div class="bg-purple-900/40 border border-purple-500 rounded-lg p-3 flex flex-col h-full">
                            <div class="text-purple-400 font-bold text-sm mb-2"><i class="fa-solid fa-check-circle mr-1"></i>確認入庫</div>

                            <!-- 待確認清單 -->
                            <div id="container-checklist" class="bg-slate-800/70 rounded p-2 mb-2 text-xs space-y-1">
                                <div class="flex items-center gap-1" id="container-check-company"><i class="fa-solid fa-circle text-slate-600 text-[8px]"></i><span class="text-slate-500">公司</span></div>
                                <div class="flex items-center gap-1" id="container-check-name"><i class="fa-solid fa-circle text-slate-600 text-[8px]"></i><span class="text-slate-500">品名</span></div>
                                <div class="flex items-center gap-1" id="container-check-qty"><i class="fa-solid fa-circle text-slate-600 text-[8px]"></i><span class="text-slate-500">數量</span></div>
                                <div class="flex items-center gap-1" id="container-check-exp"><i class="fa-solid fa-circle text-slate-600 text-[8px]"></i><span class="text-slate-500">效期</span></div>
                                <div class="flex items-center gap-1" id="container-check-loc"><i class="fa-solid fa-circle text-slate-600 text-[8px]"></i><span class="text-slate-500">儲位</span></div>
                            </div>

                            <!-- 插單預覽 -->
                            <div class="flex-1 overflow-y-auto mb-2">
                                <div class="text-xs text-slate-400 mb-1">🏷️ 棧板插單 <span id="container-label-count" class="text-yellow-400">0</span> 張</div>
                                <div id="container-labels-preview" class="grid grid-cols-2 gap-1 content-start">
                                    <div class="col-span-2 text-center text-slate-500 py-4">
                                        <i class="fa-solid fa-tags text-xl mb-1"></i>
                                        <div class="text-[10px]">請先新增品項</div>
                                    </div>
                                </div>
                            </div>

                            <!-- 操作按鈕 -->
                            <div class="space-y-1.5">
                                <button onclick="printContainerLabels()" id="btn-print-labels" class="w-full py-3 bg-emerald-600 hover:bg-emerald-500 disabled:bg-slate-700 disabled:cursor-not-allowed text-white rounded font-bold text-sm" disabled>
                                    <i class="fa-solid fa-print mr-1"></i>🖨️ 列印插單
                                </button>
                                <button onclick="confirmContainerInbound()" id="btn-confirm-inbound" class="w-full py-2 bg-blue-600 hover:bg-blue-500 disabled:bg-slate-700 disabled:cursor-not-allowed text-white rounded text-sm" disabled>
                                    <i class="fa-solid fa-check mr-1"></i>📦 確認入庫
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-inventory-query" class="view-panel h-full hidden flex flex-col p-4"><div class="flex gap-2 mb-3 items-center"><div class="flex gap-1 bg-slate-800 rounded p-1 mr-2"><button onclick="setInventoryCompany('all')" id="btn-inv-all" class="px-3 py-1.5 rounded text-xs font-bold bg-slate-600 text-white">全部</button><button onclick="setInventoryCompany('崇文')" id="btn-inv-cw" class="px-3 py-1.5 rounded text-xs font-bold bg-slate-700 text-slate-300 hover:bg-slate-600">崇文</button><button onclick="setInventoryCompany('八方')" id="btn-inv-bf" class="px-3 py-1.5 rounded text-xs font-bold bg-slate-700 text-slate-300 hover:bg-slate-600">八方</button></div><input type="text" id="global-search" class="scan-input pl-9 flex-1" placeholder="萬用搜尋..." oninput="filterInventory()"><button onclick="exportInventoryToExcel()" class="bg-emerald-600 text-white px-3 py-1.5 rounded text-xs font-bold hover:bg-emerald-500 flex items-center gap-2"><i class="fa-solid fa-file-excel"></i> 匯出庫存</button><button onclick="document.getElementById('stockImportInput').click()" class="bg-orange-600 text-white px-3 py-1.5 rounded text-xs font-bold hover:bg-orange-500 ml-auto flex items-center gap-2"><i class="fa-solid fa-file-import"></i> 期初匯入</button><button onclick="downloadTemplate('stock')" class="text-slate-400 text-xs hover:text-white underline">範本</button><input type="file" id="stockImportInput" accept=".xlsx" class="hidden" onchange="handleStockImport(event)"></div><div class="glass-panel flex-1 overflow-auto"><table class="w-full dense-table"><thead><tr><th class="text-left">公司</th><th class="text-left">品名</th><th class="text-left">規格</th><th class="text-left">批號</th><th class="text-right">數量</th><th class="text-right">重量</th><th class="text-left">位置</th><th class="text-left">效期</th><th class="text-left">寄庫客戶</th><th class="text-right">操作</th></tr></thead><tbody id="inventory-list-body"></tbody></table></div></div>

            <!-- 成品出貨（自動揀貨） -->

            <!-- 波次揀貨 -->
            <div id="view-wave-picking" class="view-panel h-full hidden flex flex-col p-4">
                <!-- 頂部標題 -->
                <div class="flex items-center justify-between bg-gradient-to-r from-orange-900 to-red-900 border border-orange-600 p-4 rounded-xl mb-4">
                    <div>
                        <h2 class="text-white font-bold text-2xl"><i class="fa-solid fa-layer-group mr-2 text-orange-400"></i>波次揀貨</h2>
                        <p class="text-orange-200 text-sm mt-1">依物流商分波次，產生揀貨單與分貨標籤</p>
                    </div>
                    <div class="flex gap-2 items-center">
                        <!-- 公司選擇 -->
                        <div class="flex gap-1 bg-slate-900/50 rounded p-1 mr-2">
                            <button onclick="setWaveCompany('崇文')" id="btn-wave-cw" class="px-3 py-1.5 rounded text-xs font-bold bg-blue-600 text-white">崇文</button>
                            <button onclick="setWaveCompany('八方')" id="btn-wave-bf" class="px-3 py-1.5 rounded text-xs font-bold bg-slate-700 text-slate-300 hover:bg-slate-600">八方</button>
                        </div>
                        <input type="file" id="order-excel-import" accept=".xlsx,.xls" class="hidden" onchange="importERPExcel(event)">
                        <button onclick="document.getElementById('order-excel-import').click()" class="bg-purple-600 hover:bg-purple-500 text-white px-4 py-2 rounded-lg font-bold mr-2">
                            <i class="fa-solid fa-file-excel mr-1"></i>匯入訂單
                        </button>
                        <button onclick="autoCreateWavesByLogistics()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg font-bold mr-2">
                            <i class="fa-solid fa-wand-magic-sparkles mr-1"></i>自動建立
                        </button>
                        <button onclick="openCreateWaveModal()" class="bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded-lg font-bold mr-2">
                            <i class="fa-solid fa-plus mr-1"></i>手動建立
                        </button>
                        <button onclick="openClearDataModal()" class="bg-slate-600 hover:bg-slate-500 text-white px-4 py-2 rounded-lg font-bold">
                            <i class="fa-solid fa-broom mr-1"></i>清除資料
                        </button>
                        <button onclick="refreshWaveList()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg font-bold">
                            <i class="fa-solid fa-sync mr-1"></i>重新整理
                        </button>
                    </div>
                </div>

                <!-- 波次統計 -->
                <div class="grid grid-cols-5 gap-3 mb-4">
                    <div class="bg-gradient-to-br from-blue-900/50 to-blue-800/30 border border-blue-600/50 rounded-lg p-3 text-center">
                        <div class="text-blue-400 text-xs">今日波次</div>
                        <div class="text-2xl font-black text-white" id="wave-stat-today">0</div>
                    </div>
                    <div class="bg-gradient-to-br from-yellow-900/50 to-yellow-800/30 border border-yellow-600/50 rounded-lg p-3 text-center">
                        <div class="text-yellow-400 text-xs">待揀貨</div>
                        <div class="text-2xl font-black text-white" id="wave-stat-pending">0</div>
                    </div>
                    <div class="bg-gradient-to-br from-orange-900/50 to-orange-800/30 border border-orange-600/50 rounded-lg p-3 text-center">
                        <div class="text-orange-400 text-xs">揀貨中</div>
                        <div class="text-2xl font-black text-white" id="wave-stat-picking">0</div>
                    </div>
                    <div class="bg-gradient-to-br from-emerald-900/50 to-emerald-800/30 border border-emerald-600/50 rounded-lg p-3 text-center">
                        <div class="text-emerald-400 text-xs">已完成</div>
                        <div class="text-2xl font-black text-white" id="wave-stat-done">0</div>
                    </div>
                    <div class="bg-gradient-to-br from-purple-900/50 to-purple-800/30 border border-purple-600/50 rounded-lg p-3 text-center">
                        <div class="text-purple-400 text-xs">待出貨訂單</div>
                        <div class="text-2xl font-black text-white" id="wave-stat-orders">0</div>
                    </div>
                </div>

                <!-- 波次清單 -->
                <div class="flex-1 bg-slate-800/50 border border-slate-700 rounded-xl overflow-hidden">
                    <div class="overflow-auto h-full">
                        <table class="w-full dense-table">
                            <thead class="bg-slate-900 sticky top-0">
                                <tr>
                                    <th class="p-3 text-left">波次編號</th>
                                    <th class="p-3 text-left">物流商</th>
                                    <th class="p-3 text-left">狀態</th>
                                    <th class="p-3 text-right">訂單數</th>
                                    <th class="p-3 text-right">品項數</th>
                                    <th class="p-3 text-right">總件數</th>
                                    <th class="p-3 text-left">建立時間</th>
                                    <th class="p-3 text-center">操作</th>
                                </tr>
                            </thead>
                            <tbody id="wave-list-body">
                                <tr><td colspan="8" class="text-center text-slate-500 py-8">載入中...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 建立波次 Modal -->
            <div id="modal-create-wave" class="fixed inset-0 z-50 bg-black/80 hidden flex items-center justify-center backdrop-blur-sm">
                <div class="bg-slate-900 border border-slate-700 rounded-2xl w-[800px] max-h-[90vh] shadow-2xl flex flex-col">
                    <div class="bg-gradient-to-r from-orange-900 to-red-900 p-4 rounded-t-2xl border-b border-slate-700">
                        <h3 class="text-white font-bold text-lg"><i class="fa-solid fa-plus-circle mr-2 text-orange-400"></i>建立揀貨波次</h3>
                    </div>
                    <div class="p-4 border-b border-slate-700">
                        <div class="grid grid-cols-3 gap-4">
                            <div>
                                <label class="text-slate-400 text-xs mb-1 block">物流商篩選</label>
                                <select id="wave-filter-logistics" class="scan-input w-full" onchange="filterWaveOrders()">
                                    <option value="">全部物流</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-slate-400 text-xs mb-1 block">出貨日期</label>
                                <input type="date" id="wave-filter-date" class="scan-input w-full" onchange="filterWaveOrders()">
                            </div>
                            <div class="flex items-end">
                                <button onclick="selectAllWaveOrders()" class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-2 rounded text-sm mr-2">全選</button>
                                <button onclick="deselectAllWaveOrders()" class="bg-slate-600 hover:bg-slate-500 text-white px-3 py-2 rounded text-sm">取消全選</button>
                            </div>
                        </div>
                    </div>
                    <div class="flex-1 overflow-auto p-4">
                        <table class="w-full text-sm">
                            <thead class="bg-slate-800 sticky top-0">
                                <tr>
                                    <th class="p-2 text-left w-10"><input type="checkbox" id="wave-check-all" onchange="toggleWaveCheckAll()"></th>
                                    <th class="p-2 text-left">批號</th>
                                    <th class="p-2 text-left">訂單歸屬</th>
                                    <th class="p-2 text-left">物流商</th>
                                    <th class="p-2 text-left">品名/規格</th>
                                    <th class="p-2 text-right">數量</th>
                                    <th class="p-2 text-left">銷貨日期</th>
                                </tr>
                            </thead>
                            <tbody id="wave-orders-body">
                                <tr><td colspan="7" class="text-center text-slate-500 py-8">載入中...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="p-4 border-t border-slate-700">
                        <div class="flex items-center justify-between">
                            <div class="text-sm">
                                <span class="text-slate-400">已選擇：</span>
                                <span class="text-orange-400 font-bold" id="wave-selected-count">0</span>
                                <span class="text-slate-400 ml-2">筆訂單</span>
                            </div>
                            <div class="flex gap-3">
                                <button onclick="createWave()" class="px-6 py-2 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg font-bold">
                                    <i class="fa-solid fa-check mr-2"></i>建立波次
                                </button>
                                <button onclick="closeCreateWaveModal()" class="px-6 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg">取消</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 波次執行 Modal -->
            <div id="modal-wave-execute" class="fixed inset-0 z-50 bg-black/80 hidden flex items-center justify-center backdrop-blur-sm">
                <div class="bg-slate-900 border border-slate-700 rounded-2xl w-[1000px] max-h-[90vh] shadow-2xl flex flex-col">
                    <div class="bg-gradient-to-r from-blue-900 to-indigo-900 p-4 rounded-t-2xl border-b border-slate-700 flex justify-between items-center">
                        <div>
                            <h3 class="text-white font-bold text-lg"><i class="fa-solid fa-clipboard-list mr-2 text-blue-400"></i>執行揀貨 - <span id="wave-exec-no">W001</span></h3>
                            <p class="text-blue-200 text-xs mt-1" id="wave-exec-logistics">物流商：黑貓宅急便</p>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="text-sm">
                                <span class="text-slate-400">進度：</span>
                                <span class="text-emerald-400 font-bold" id="wave-exec-progress">0/0</span>
                            </div>
                            <button onclick="printPickingList()" class="bg-emerald-600 hover:bg-emerald-500 text-white px-3 py-2 rounded-lg text-sm">
                                <i class="fa-solid fa-print mr-1"></i>列印揀貨單
                            </button>
                        </div>
                    </div>

                    <!-- 掃描區 -->
                    <div class="p-4 border-b border-slate-700 bg-slate-800/30">
                        <div class="flex items-center gap-3">
                            <i class="fa-solid fa-barcode text-blue-400 text-xl"></i>
                            <input type="text" id="wave-scan-input" class="scan-input flex-1 text-lg" placeholder="掃描板號或儲位確認揀貨..." onkeypress="if(event.key==='Enter') confirmWaveScan()">
                            <button onclick="confirmWaveScan()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg font-bold">
                                <i class="fa-solid fa-check mr-1"></i>確認
                            </button>
                        </div>
                        <div id="wave-scan-result" class="mt-2 text-sm hidden"></div>
                    </div>

                    <!-- 揀貨清單 -->
                    <div class="flex-1 overflow-auto p-4">
                        <table class="w-full text-sm">
                            <thead class="bg-slate-800 sticky top-0">
                                <tr>
                                    <th class="p-2 text-left w-16">狀態</th>
                                    <th class="p-2 text-left">儲位</th>
                                    <th class="p-2 text-left">板號</th>
                                    <th class="p-2 text-left">品名/規格</th>
                                    <th class="p-2 text-left">規格</th>
                                    <th class="p-2 text-right">揀貨數</th>
                                    <th class="p-2 text-left">批號</th>
                                    <th class="p-2 text-left">訂單歸屬</th>
                                </tr>
                            </thead>
                            <tbody id="wave-picking-list">
                                <tr><td colspan="8" class="text-center text-slate-500 py-8">載入中...</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- 底部按鈕 -->
                    <div class="p-4 border-t border-slate-700 flex gap-3">
                        <button onclick="printSortingLabels()" class="flex-1 py-3 bg-purple-600 hover:bg-purple-500 text-white rounded-lg font-bold">
                            <i class="fa-solid fa-tags mr-2"></i>列印分貨標籤
                        </button>
                        <button onclick="completeWave()" class="flex-1 py-3 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg font-bold">
                            <i class="fa-solid fa-flag-checkered mr-2"></i>完成波次
                        </button>
                        <button onclick="closeWaveExecuteModal()" class="px-6 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-lg">關閉</button>
                    </div>
                </div>
            </div>

            <!-- 原料領用（彈窗式 UI） -->
            <div id="view-picking-rm" class="view-panel h-full hidden flex flex-col p-4">
                <!-- 頂部標題列 -->
                <div class="flex items-center justify-between mb-3">
                    <h2 class="text-lg font-bold text-white flex items-center gap-2">
                        <i class="fa-solid fa-fish text-cyan-400"></i>原料領用
                    </h2>
                    <div class="flex items-center gap-2">
                        <div class="flex gap-1 bg-slate-800 rounded p-1">
                            <button onclick="setRmCompany('all')" id="btn-rm-all" class="px-3 py-1 rounded text-xs font-bold bg-cyan-600 text-white">全部</button>
                            <button onclick="setRmCompany('崇文')" id="btn-rm-cw" class="px-3 py-1 rounded text-xs font-bold bg-slate-700 text-slate-300 hover:bg-slate-600">崇文</button>
                            <button onclick="setRmCompany('八方')" id="btn-rm-bf" class="px-3 py-1 rounded text-xs font-bold bg-slate-700 text-slate-300 hover:bg-slate-600">八方</button>
                        </div>
                        <span class="text-slate-500 text-sm" id="rm-mode-desc">
                            <i class="fa-solid fa-info-circle mr-1"></i>從庫存選擇品項進行領用出庫
                        </span>
                    </div>
                </div>

                <!-- 主內容區 -->
                <div class="flex gap-3 flex-1 min-h-0">
                    <!-- 左側：領用設定 -->
                    <div class="w-80 glass-panel p-3 flex flex-col">
                        <h3 class="text-white font-bold mb-3 border-b border-slate-700 pb-2 text-sm">
                            <i class="fa-solid fa-hand mr-2 text-cyan-400"></i>領用設定
                        </h3>

                        <div class="space-y-3 flex-1">
                            <!-- Step 1: 領用資訊 -->
                            <div class="bg-gradient-to-r from-slate-800 to-slate-900 rounded-lg p-3 border border-slate-600" id="rm-step1-panel">
                                <div class="flex items-center mb-2">
                                    <span class="text-xs text-slate-400 font-bold">
                                        <i class="fa-solid fa-1 w-4 h-4 rounded-full bg-blue-600 text-white text-center mr-1 inline-flex items-center justify-center text-[10px]"></i>
                                        領用資訊
                                    </span>
                                </div>
                                <div class="space-y-2">
                                    <div>
                                        <label class="text-xs text-slate-400">領用人 *</label>
                                        <input type="text" id="rm-pick-user" class="scan-input text-sm w-full" placeholder="輸入領用人" oninput="updateRmStepStatus()">
                                    </div>
                                    <div>
                                        <label class="text-xs text-slate-400">領用單位</label>
                                        <input type="text" id="rm-pick-dept" class="scan-input text-sm w-full" placeholder="如：加工課">
                                    </div>
                                    <div>
                                        <label class="text-xs text-slate-400">用途/備註</label>
                                        <input type="text" id="rm-pick-note" class="scan-input text-sm w-full" placeholder="選填">
                                    </div>
                                </div>
                            </div>

                            <!-- Step 2: 選擇品項按鈕 -->
                            <div class="bg-gradient-to-r from-slate-800 to-slate-900 rounded-lg p-3 border border-slate-600 transition-opacity" id="rm-step2-panel">
                                <div class="flex items-center mb-2">
                                    <span class="text-xs text-slate-400 font-bold">
                                        <i class="fa-solid fa-2 w-4 h-4 rounded-full bg-purple-600 text-white text-center mr-1 inline-flex items-center justify-center text-[10px]"></i>
                                        選擇領用品項
                                    </span>
                                </div>
                                <button onclick="openRmProductModal()" id="btn-open-rm-modal" class="w-full bg-purple-600 hover:bg-purple-500 text-white px-4 py-3 rounded-lg font-bold text-sm transition disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-purple-600" disabled>
                                    <i class="fa-solid fa-boxes-stacked mr-2"></i>選擇品項（可複選）
                                </button>
                                <p class="text-xs text-slate-500 mt-2 text-center" id="rm-step2-hint">
                                    <i class="fa-solid fa-lock mr-1"></i>請先填寫領用人
                                </p>
                            </div>

                            <!-- Step 3: 確認領用 -->
                            <div class="bg-gradient-to-r from-slate-800 to-slate-900 rounded-lg p-3 border border-slate-600" id="rm-step3-panel">
                                <div class="flex items-center mb-2">
                                    <span class="text-xs text-slate-400 font-bold">
                                        <i class="fa-solid fa-3 w-4 h-4 rounded-full bg-emerald-600 text-white text-center mr-1 inline-flex items-center justify-center text-[10px]"></i>
                                        確認領用
                                    </span>
                                </div>
                                <button onclick="confirmRmPickingFromCart()" id="btn-rm-confirm-cart" class="w-full py-3 bg-gradient-to-r from-emerald-600 to-emerald-500 hover:from-emerald-500 hover:to-emerald-400 text-white rounded-lg font-bold text-sm transition shadow-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                    <i class="fa-solid fa-check mr-2"></i>確認領料出庫
                                </button>
                            </div>

                            <!-- 列印按鈕 -->
                            <button onclick="printRmPickingListFromCart()" class="w-full py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg text-sm">
                                <i class="fa-solid fa-print mr-2"></i>列印領料單
                            </button>
                        </div>
                    </div>

                    <!-- 右側：已選領用清單 -->
                    <div class="flex-1 glass-panel flex flex-col">
                        <div class="px-4 py-2 border-b border-slate-700 flex items-center justify-between">
                            <h3 class="text-white font-bold text-sm">
                                <i class="fa-solid fa-clipboard-list mr-2 text-yellow-400"></i>領用清單
                            </h3>
                            <div class="flex items-center gap-3">
                                <span class="text-slate-400 text-xs">已選</span>
                                <span class="text-cyan-400 font-bold" id="rm-cart-count-display">0</span>
                                <span class="text-slate-400 text-xs">筆</span>
                                <span class="text-slate-600">|</span>
                                <span class="text-yellow-400 font-bold" id="rm-cart-qty-display">0</span>
                                <span class="text-slate-400 text-xs">件</span>
                                <button onclick="clearRmCart()" class="ml-2 text-slate-400 hover:text-red-400 text-xs">
                                    <i class="fa-solid fa-trash mr-1"></i>清空
                                </button>
                            </div>
                        </div>
                        <div class="flex-1 overflow-auto p-3" id="rm-cart-display">
                            <div class="text-center text-slate-500 py-10">
                                <i class="fa-solid fa-inbox text-4xl mb-3 opacity-50"></i>
                                <div>尚未選擇品項</div>
                                <div class="text-xs mt-1">點擊「選擇品項」開始添加</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-shipping" class="view-panel h-full hidden flex flex-col">
                <!-- 頂部工具列 -->
                <div class="h-14 border-b border-slate-800 flex items-center px-4 gap-4 bg-slate-900/50">
                    <input type="file" id="excelInput" accept=".xlsx" class="hidden" onchange="handleExcelImport(event)">
                    <button onclick="document.getElementById('excelInput').click()" class="bg-emerald-600 text-white px-3 py-1.5 rounded text-xs font-bold hover:bg-emerald-500 shadow-lg flex items-center">
                        <i class="fa-solid fa-file-excel mr-2"></i>匯入訂單
                    </button>
                    <button onclick="downloadTemplate('order')" class="text-slate-400 text-xs hover:text-white underline">範本</button>
                    <button onclick="openManualOrderModal()" class="bg-blue-600 text-white px-3 py-1.5 rounded text-xs font-bold flex items-center">
                        <i class="fa-solid fa-plus mr-2"></i>手動新增
                    </button>
                    <button onclick="exportShippingResult()" class="bg-slate-600 text-white px-3 py-1.5 rounded text-xs font-bold ml-2">
                        📤 匯出ERP
                    </button>
                    <div class="flex items-center gap-2 border-l border-slate-700 pl-4">
                        <label class="text-xs text-slate-400">物流:</label>
                        <select id="filter-carrier" class="bg-slate-800 border border-slate-700 text-white text-xs rounded px-2 py-1.5" onchange="filterShippingList()">
                            <option value="ALL">全部</option>
                        </select>
                    </div>
                    <div class="text-xs text-slate-400 ml-auto">
                        待出貨: <span class="text-white font-bold" id="order-count">0</span> 單
                    </div>
                </div>

                <!-- 主要內容區 -->
                <div class="flex-1 flex overflow-hidden">
                    <!-- 左側：訂單列表 -->
                    <div class="w-1/2 border-r border-slate-700 flex flex-col">
                        <div class="p-2 bg-slate-800 border-b border-slate-700">
                            <div class="text-sm font-bold text-white"><i class="fa-solid fa-list-check mr-2"></i>訂單列表</div>
                        </div>
                        <div class="flex-1 overflow-auto p-2">
                            <table class="w-full dense-table text-left">
                                <thead>
                                    <tr>
                                        <th>物流</th>
                                        <th>單號</th>
                                        <th>客戶</th>
                                        <th>品項</th>
                                        <th>數量</th>
                                        <th>狀態</th>
                                        <th class="text-right">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="shipping-list-body"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- 右側：揀貨明細 -->
                    <div class="w-1/2 flex flex-col bg-slate-900/50">
                        <div class="p-2 bg-slate-800 border-b border-slate-700 flex justify-between items-center">
                            <div class="text-sm font-bold text-white"><i class="fa-solid fa-route mr-2 text-green-400"></i>揀貨明細</div>
                            <button onclick="printOrderPickingSlip()" class="bg-green-600 hover:bg-green-500 text-white px-3 py-1 rounded text-xs font-bold">
                                <i class="fa-solid fa-print mr-1"></i>列印揀貨單
                            </button>
                        </div>
                        <div id="order-picking-detail" class="flex-1 overflow-auto p-3">
                            <div class="text-center text-slate-500 py-20">
                                <i class="fa-solid fa-hand-pointer text-4xl mb-4"></i>
                                <div>請從左側選擇訂單查看揀貨明細</div>
                            </div>
                        </div>
                        <div id="order-picking-actions" class="p-3 border-t border-slate-700 hidden">
                            <button onclick="confirmOrderPicking()" class="w-full py-3 bg-green-600 hover:bg-green-500 text-white rounded font-bold">
                                <i class="fa-solid fa-check mr-2"></i>確認出貨完成
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 手動新增訂單 Modal -->
            <div id="modal-manual-order" class="fixed inset-0 z-50 bg-black/80 hidden flex items-center justify-center">
                <div class="bg-slate-800 border border-slate-600 rounded-lg p-6 w-96">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-white font-bold"><i class="fa-solid fa-plus mr-2"></i>手動新增出貨單</h3>
                        <button onclick="closeManualOrderModal()" class="text-slate-400 hover:text-white">&times;</button>
                    </div>
                    <div class="space-y-3">
                        <div>
                            <label class="text-xs text-slate-400">客戶名稱</label>
                            <input type="text" id="manual-order-customer" class="scan-input" placeholder="客戶名稱">
                        </div>
                        <div>
                            <label class="text-xs text-slate-400">品名</label>
                            <input type="text" id="manual-order-product" class="scan-input" placeholder="品名" oninput="searchProductForOrder()">
                            <div id="order-product-suggestions" class="max-h-24 overflow-y-auto mt-1"></div>
                        </div>
                        <div>
                            <label class="text-xs text-slate-400">規格</label>
                            <input type="text" id="manual-order-spec" class="scan-input" placeholder="規格" readonly>
                        </div>
                        <div>
                            <label class="text-xs text-slate-400">出貨數量</label>
                            <input type="number" id="manual-order-qty" class="scan-input text-center text-xl font-bold text-yellow-400" placeholder="0">
                        </div>
                        <div>
                            <label class="text-xs text-slate-400">物流商</label>
                            <input type="text" id="manual-order-carrier" class="scan-input" placeholder="如：黑貓、新竹物流">
                        </div>
                        <button onclick="createManualOrder()" class="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white rounded font-bold mt-4">
                            <i class="fa-solid fa-plus mr-2"></i>建立出貨單
                        </button>
                    </div>
                </div>
            </div>

            <div id="view-move" class="view-panel h-full hidden flex flex-col p-2 gap-2">
                <!-- 頂部標題列 -->
                <div class="flex items-center justify-between bg-gradient-to-r from-blue-900 to-indigo-900 border border-blue-600 px-3 py-2 rounded-lg">
                    <div class="flex items-center gap-3">
                        <h2 class="text-white font-bold"><i class="fa-solid fa-clipboard-list mr-2 text-blue-400"></i>智能調度中心</h2>
                        <!-- 統計資訊 -->
                        <div class="flex items-center gap-2 text-sm" id="dispatch-stats-bar">
                            <span class="bg-orange-900/50 border border-orange-600/50 rounded px-2 py-0.5 text-orange-400">合併 <b class="text-white" id="stat-bar-merge">0</b></span>
                            <span class="bg-blue-900/50 border border-blue-600/50 rounded px-2 py-0.5 text-blue-400">移位 <b class="text-white" id="stat-bar-move">0</b></span>
                            <span class="bg-emerald-900/50 border border-emerald-600/50 rounded px-2 py-0.5 text-emerald-400">釋放 <b class="text-white" id="stat-bar-free">0</b></span>
                        </div>
                    </div>
                    <!-- 操作按鈕 -->
                    <div class="flex items-center gap-2">
                        <button onclick="startDispatchAnalysis()" class="px-3 py-1.5 bg-yellow-600 hover:bg-yellow-500 text-white rounded text-sm font-bold">
                            <i class="fa-solid fa-refresh mr-1"></i>重新分析
                        </button>
                        <button onclick="publishSelectedToMobile()" id="btn-publish-mobile" class="px-3 py-1.5 bg-purple-600 hover:bg-purple-500 text-white rounded text-sm font-bold disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            <i class="fa-solid fa-paper-plane mr-1"></i>發布 (<span id="publish-count">0</span>)
                        </button>
                        <button onclick="printSelectedDispatchOrders()" id="btn-print-selected" class="px-3 py-1.5 bg-emerald-600 hover:bg-emerald-500 text-white rounded text-sm font-bold disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            <i class="fa-solid fa-print mr-1"></i>列印
                        </button>
                    </div>
                </div>

                <!-- 工單選擇區 -->
                <div class="flex items-center gap-3 bg-slate-800/50 rounded px-3 py-2">
                    <label class="flex items-center gap-2 text-sm text-slate-300 cursor-pointer hover:text-white">
                        <input type="checkbox" id="dispatch-select-all" onchange="toggleAllDispatchOrders()" class="w-4 h-4 rounded accent-blue-500">
                        全選
                    </label>
                    <span class="text-sm text-slate-400">已選 <span id="dispatch-selected-count" class="text-blue-400 font-bold">0</span> 個工單</span>
                    <div class="flex-1"></div>
                    <span id="analysis-loading" class="hidden text-yellow-400 text-sm"><i class="fa-solid fa-spinner fa-spin mr-1"></i>分析中...</span>
                </div>

                <!-- 調度工單列表（主要區域）-->
                <div class="flex-1 overflow-y-auto bg-slate-900/50 rounded-lg border border-slate-700 p-2" id="dispatch-orders-container">
                    <div class="text-center text-slate-500 py-10">
                        <i class="fa-solid fa-spinner fa-spin text-3xl mb-3"></i>
                        <div>正在自動分析庫存...</div>
                    </div>
                </div>
            </div>
            <div id="view-merge" class="view-panel h-full hidden flex flex-col p-4">
                <!-- 標題列 -->
                <div class="flex gap-2 mb-3">
                    <button onclick="setMergeMode('move')" id="btn-mode-move" class="flex-1 py-3 bg-blue-600 text-white rounded-lg font-bold text-lg border-2 border-blue-400">
                        <i class="fa-solid fa-dolly mr-2"></i>移動儲位
                    </button>
                    <button onclick="setMergeMode('merge')" id="btn-mode-merge" class="flex-1 py-3 bg-slate-800 text-slate-400 rounded-lg font-bold text-lg border-2 border-slate-600">
                        <i class="fa-solid fa-compress mr-2"></i>合併庫存
                    </button>
                </div>

                <!-- 移動模式 -->
                <div id="panel-move" class="flex-1 flex flex-col max-w-2xl mx-auto w-full">
                    <!-- Step 1: 選擇貨物 -->
                    <div class="bg-slate-800 border border-slate-600 rounded-lg p-4 mb-3">
                        <div class="flex items-center gap-2 mb-3">
                            <div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center text-white font-bold">1</div>
                            <span class="text-white font-bold">選擇要移動的貨物</span>
                        </div>
                        <div class="flex gap-2 mb-2">
                            <input type="text" id="move-pallet-id" class="scan-input flex-1 text-lg" placeholder="掃描或輸入入庫單號" onchange="lookupPalletByDocNo(this.value, 'move')">
                            <button onclick="openMoveFallback()" class="px-3 bg-yellow-600 hover:bg-yellow-500 text-white rounded font-bold text-sm">
                                <i class="fa-solid fa-search mr-1"></i>查詢
                            </button>
                        </div>
                        <div id="move-pallet-info" class="bg-slate-900 rounded p-2 min-h-[50px] text-sm">
                            <div class="text-slate-500 text-center py-2"><i class="fa-solid fa-barcode mr-2"></i>等待掃描...</div>
                        </div>
                    </div>

                    <!-- Step 2: 目標儲位 -->
                    <div class="bg-slate-800 border border-slate-600 rounded-lg p-4 mb-3">
                        <div class="flex items-center gap-2 mb-3">
                            <div class="w-8 h-8 rounded-full bg-emerald-600 flex items-center justify-center text-white font-bold">2</div>
                            <span class="text-white font-bold">輸入目標儲位</span>
                        </div>
                        <input type="text" id="move-target-loc" class="scan-input text-xl text-center font-bold tracking-wider" placeholder="I-A-05-2F">
                    </div>

                    <!-- 確認按鈕 -->
                    <button onclick="executePalletMove()" class="py-4 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-bold text-xl">
                        <i class="fa-solid fa-check mr-2"></i>確認移動
                    </button>
                </div>

                <!-- 移動備案面板 -->
                <div id="panel-move-fallback" class="fixed inset-0 z-50 bg-black/80 hidden flex items-center justify-center p-4">
                    <div class="bg-slate-800 rounded-xl w-full max-w-lg max-h-[70vh] flex flex-col">
                        <div class="flex justify-between items-center p-3 border-b border-slate-700">
                            <div class="text-white font-bold"><i class="fa-solid fa-search mr-2 text-yellow-400"></i>查詢庫存</div>
                            <button onclick="closeMoveFallback()" class="text-slate-400 hover:text-white text-xl"><i class="fa-solid fa-xmark"></i></button>
                        </div>
                        <div class="p-3 border-b border-slate-700">
                            <div class="flex gap-2">
                                <input type="text" id="fallback-move-loc" class="scan-input flex-1" placeholder="儲位 I-A-03-2F" onchange="searchPalletsByLocation(this.value, 'move')">
                                <input type="text" id="fallback-move-search" class="scan-input flex-1" placeholder="品名" oninput="searchPalletsByName(this.value, 'move')">
                            </div>
                        </div>
                        <div id="fallback-move-list" class="flex-1 overflow-y-auto p-2">
                            <div class="text-slate-500 text-center py-6">輸入儲位或品名搜尋</div>
                        </div>
                    </div>
                </div>

                <!-- 合併模式 -->
                <div id="panel-merge" class="flex-1 flex-col hidden max-w-2xl mx-auto w-full">
                    <!-- 來源A -->
                    <div class="bg-slate-800 border border-purple-600 rounded-lg p-4 mb-2">
                        <div class="flex items-center gap-2 mb-2">
                            <div class="w-8 h-8 rounded-full bg-purple-600 flex items-center justify-center text-white font-bold">A</div>
                            <span class="text-white font-bold">保留的庫存 <span class="text-purple-400 text-sm">（數量會增加）</span></span>
                        </div>
                        <div class="flex gap-2 mb-2">
                            <input type="text" id="merge-keep-id" class="scan-input flex-1" placeholder="掃描入庫單號" onchange="lookupPalletByDocNo(this.value, 'keep')">
                            <button onclick="openMergeFallback('keep')" class="px-3 bg-yellow-600 hover:bg-yellow-500 text-white rounded text-sm">
                                <i class="fa-solid fa-search"></i>
                            </button>
                        </div>
                        <div id="merge-keep-info" class="bg-slate-900 rounded p-2 min-h-[40px] text-sm">
                            <div class="text-slate-500 text-center py-1"><i class="fa-solid fa-barcode mr-1"></i>等待掃描...</div>
                        </div>
                    </div>

                    <!-- 加號 -->
                    <div class="text-center text-2xl text-slate-600 py-1"><i class="fa-solid fa-plus"></i></div>

                    <!-- 來源B -->
                    <div class="bg-slate-800 border border-orange-600 rounded-lg p-4 mb-3">
                        <div class="flex items-center gap-2 mb-2">
                            <div class="w-8 h-8 rounded-full bg-orange-600 flex items-center justify-center text-white font-bold">B</div>
                            <span class="text-white font-bold">移入的庫存 <span class="text-orange-400 text-sm">（將被刪除）</span></span>
                        </div>
                        <div class="flex gap-2 mb-2">
                            <input type="text" id="merge-remove-id" class="scan-input flex-1" placeholder="掃描入庫單號" onchange="lookupPalletByDocNo(this.value, 'remove')">
                            <button onclick="openMergeFallback('remove')" class="px-3 bg-yellow-600 hover:bg-yellow-500 text-white rounded text-sm">
                                <i class="fa-solid fa-search"></i>
                            </button>
                        </div>
                        <div id="merge-remove-info" class="bg-slate-900 rounded p-2 min-h-[40px] text-sm">
                            <div class="text-slate-500 text-center py-1"><i class="fa-solid fa-barcode mr-1"></i>等待掃描...</div>
                        </div>
                    </div>

                    <!-- 確認按鈕 -->
                    <button onclick="executePalletMerge()" class="py-4 bg-purple-600 hover:bg-purple-500 text-white rounded-lg font-bold text-xl">
                        <i class="fa-solid fa-compress mr-2"></i>確認合併
                    </button>
                </div>

                <!-- 合併備案面板 -->
                <div id="panel-merge-fallback" class="fixed inset-0 z-50 bg-black/80 hidden flex items-center justify-center p-4">
                    <div class="bg-slate-800 rounded-xl w-full max-w-lg max-h-[70vh] flex flex-col">
                        <div class="flex justify-between items-center p-3 border-b border-slate-700">
                            <div class="text-white font-bold"><i class="fa-solid fa-search mr-2 text-yellow-400"></i>查詢庫存 <span id="merge-fallback-target" class="text-slate-400 text-sm"></span></div>
                            <button onclick="closeMergeFallback()" class="text-slate-400 hover:text-white text-xl"><i class="fa-solid fa-xmark"></i></button>
                        </div>
                        <div class="p-3 border-b border-slate-700">
                            <div class="flex gap-2">
                                <input type="text" id="fallback-merge-loc" class="scan-input flex-1" placeholder="儲位" onchange="searchPalletsByLocation(this.value, 'merge')">
                                <input type="text" id="fallback-merge-search" class="scan-input flex-1" placeholder="品名" oninput="searchPalletsByName(this.value, 'merge')">
                            </div>
                        </div>
                        <div id="fallback-merge-list" class="flex-1 overflow-y-auto p-2">
                            <div class="text-slate-500 text-center py-6">輸入儲位或品名搜尋</div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="view-stocktake" class="view-panel h-full hidden p-6"><div class="flex justify-between items-center mb-6"><h3 class="text-white font-bold">盤點任務</h3><button class="px-4 py-2 bg-blue-600 text-white rounded text-sm font-bold shadow-lg">建立盤點單</button></div><div class="glass-panel p-5 border border-slate-600 relative opacity-50"><div class="text-center py-10 text-slate-500">尚無任務</div></div></div>

            <!-- 外部倉庫管理 -->

            <!-- 報表中心 -->
            <!-- 報表中心 - 極簡單行式 UI -->
            <div id="view-picking-reports" class="view-panel h-full hidden flex flex-col p-4">
                <!-- 操作列：報表選擇 + 日期區間 + 產生按鈕 -->
                <div class="bg-gradient-to-r from-slate-800 to-slate-900 border border-slate-700 p-4 rounded-xl mb-3">
                    <div class="flex items-center gap-4 flex-wrap">
                        <!-- 報表選擇 -->
                        <div class="flex items-center gap-2">
                            <span class="text-slate-400 text-sm font-bold whitespace-nowrap">
                                <i class="fa-solid fa-chart-pie mr-1 text-emerald-400"></i>報表：
                            </span>
                            <select id="report-type-select" class="bg-slate-700 text-white px-4 py-2.5 rounded-lg border border-slate-500 min-w-[220px] text-sm focus:border-emerald-500 focus:outline-none">
                                <option value="">-- 選擇報表 --</option>
                                <optgroup label="📦 出貨報表">
                                    <option value="shipping-logistics">依物流商</option>
                                    <option value="shipping-customer">依客戶</option>
                                    <option value="shipping-product">依產品</option>
                                    <option value="today-report">今日總覽</option>
                                </optgroup>
                                <optgroup label="📥 入庫報表">
                                    <option value="inbound-summary">入庫統計</option>
                                    <option value="inbound-detail">入庫明細</option>
                                    <option value="inbound-by-product">依品項</option>
                                    <option value="inbound-by-vendor">依廠商</option>
                                </optgroup>
                                <optgroup label="🏭 庫存報表">
                                    <option value="inventory-summary">庫存彙總</option>
                                    <option value="inventory-expiry">效期預警</option>
                                    <option value="low-stock">低庫存</option>
                                    <option value="inventory-location">儲位分布</option>
                                </optgroup>
                                <optgroup label="📋 波次報表">
                                    <option value="wave-summary">波次統計</option>
                                    <option value="wave-efficiency">揀貨效率</option>
                                </optgroup>
                                <optgroup label="📄 訂單報表">
                                    <option value="order-status">訂單狀態</option>
                                    <option value="pending-orders">待處理訂單</option>
                                </optgroup>
                                <optgroup label="✋ 領料報表">
                                    <option value="picking-summary">領料統計</option>
                                    <option value="picking-detail">領料明細</option>
                                    <option value="picking-by-user">依領用人</option>
                                    <option value="picking-by-product">依品項</option>
                                </optgroup>
                            </select>
                        </div>
                        
                        <!-- 日期區間 -->
                        <div class="flex items-center gap-2">
                            <span class="text-slate-400 text-sm font-bold whitespace-nowrap">
                                <i class="fa-solid fa-calendar mr-1"></i>日期：
                            </span>
                            <input type="date" id="report-date-from" class="bg-slate-700 text-white px-3 py-2 rounded-lg border border-slate-500 text-sm focus:border-emerald-500 focus:outline-none">
                            <span class="text-slate-500 font-bold">～</span>
                            <input type="date" id="report-date-to" class="bg-slate-700 text-white px-3 py-2 rounded-lg border border-slate-500 text-sm focus:border-emerald-500 focus:outline-none">
                        </div>
                        
                        <!-- 快速日期按鈕 -->
                        <div class="flex bg-slate-700/50 rounded-lg p-1 gap-1">
                            <button onclick="setReportQuickDate('today')" class="report-date-btn px-2.5 py-1.5 rounded text-xs font-bold text-slate-400 hover:bg-slate-600" data-range="today">今天</button>
                            <button onclick="setReportQuickDate('week')" class="report-date-btn px-2.5 py-1.5 rounded text-xs font-bold text-slate-400 hover:bg-slate-600" data-range="week">本週</button>
                            <button onclick="setReportQuickDate('month')" class="report-date-btn px-2.5 py-1.5 rounded text-xs font-bold bg-emerald-600 text-white" data-range="month">本月</button>
                            <button onclick="setReportQuickDate('lastmonth')" class="report-date-btn px-2.5 py-1.5 rounded text-xs font-bold text-slate-400 hover:bg-slate-600" data-range="lastmonth">上月</button>
                        </div>
                        
                        <!-- 產生報表按鈕 -->
                        <button onclick="generateReportFromSelect()" class="bg-emerald-600 hover:bg-emerald-500 text-white px-6 py-2.5 rounded-lg font-bold text-sm transition flex items-center gap-2 ml-auto">
                            <i class="fa-solid fa-play"></i>產生報表
                        </button>
                    </div>
                </div>

                <!-- 報表結果區（最大化空間） -->
                <div class="flex-1 bg-slate-800/50 border border-slate-700 rounded-xl overflow-hidden flex flex-col min-h-0">
                    <!-- 結果區標題列 -->
                    <div class="bg-slate-900 px-4 py-2 border-b border-slate-700 flex justify-between items-center flex-shrink-0">
                        <div class="flex items-center gap-3 text-sm">
                            <span class="text-white font-bold flex items-center" id="report-preview-title">
                                <i class="fa-solid fa-table mr-2 text-slate-400"></i>報表結果
                            </span>
                            <span class="text-slate-500 hidden" id="report-date-info"></span>
                            <span class="text-slate-500 hidden" id="report-count-info"></span>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="exportReportExcel()" class="bg-emerald-600 hover:bg-emerald-500 text-white px-3 py-1.5 rounded-lg text-xs font-bold transition flex items-center gap-1.5">
                                <i class="fa-solid fa-file-excel"></i>匯出
                            </button>
                            <button onclick="printReport()" class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-1.5 rounded-lg text-xs font-bold transition flex items-center gap-1.5">
                                <i class="fa-solid fa-print"></i>列印
                            </button>
                        </div>
                    </div>
                    <!-- 結果內容區 -->
                    <div class="flex-1 overflow-auto" id="report-preview-area">
                        <div class="h-full flex flex-col items-center justify-center text-slate-500">
                            <i class="fa-solid fa-chart-simple text-6xl mb-4 opacity-30"></i>
                            <div class="text-lg mb-1">選擇報表類型並點擊「產生報表」</div>
                            <div class="text-xs text-slate-600">支援 Excel 匯出及列印功能</div>
                        </div>
                    </div>
                </div>
            </div>


            <div id="view-external-warehouse" class="view-panel h-full hidden flex flex-col p-4">
                <!-- 頂部控制區 -->
                <div class="glass-panel p-3 mb-3">
                    <div class="flex items-center gap-4 flex-wrap">
                        <div class="flex items-center gap-2">
                            <i class="fa-solid fa-building text-cyan-400"></i>
                            <span class="text-white font-bold">外部倉庫管理</span>
                        </div>
                        <div class="w-px h-6 bg-slate-600"></div>
                        <!-- 公司選擇 -->
                        <div class="flex items-center gap-2">
                            <span class="text-slate-400 text-xs">公司：</span>
                            <button onclick="setExtCompany('all')" id="btn-ext-all" class="px-3 py-1.5 rounded text-xs font-bold bg-slate-600 text-white">全部</button>
                            <button onclick="setExtCompany('崇文')" id="btn-ext-cw" class="px-3 py-1.5 rounded text-xs font-bold bg-slate-700 text-slate-300 hover:bg-slate-600">崇文</button>
                            <button onclick="setExtCompany('八方')" id="btn-ext-bf" class="px-3 py-1.5 rounded text-xs font-bold bg-slate-700 text-slate-300 hover:bg-slate-600">八方</button>
                        </div>
                        <div class="w-px h-6 bg-slate-600"></div>
                        <!-- 倉庫篩選 -->
                        <select id="ext-wh-filter" class="scan-input text-xs w-40" onchange="filterExternalWarehouse(this.value)">
                            <option value="">全部外倉</option>
                        </select>
                        <button onclick="exportExternalStock()" class="bg-emerald-600 hover:bg-emerald-500 text-white px-3 py-1.5 rounded text-xs font-bold ml-auto">
                            <i class="fa-solid fa-file-excel mr-1"></i>匯出
                        </button>
                    </div>
                </div>

                <div class="flex gap-3 flex-1 min-h-0">
                    <!-- 左側：外倉庫存列表 -->
                    <div class="flex-1 glass-panel p-3 flex flex-col">
                        <div class="flex justify-between items-center mb-2 border-b border-slate-700 pb-2">
                            <h3 class="text-white font-bold text-sm"><i class="fa-solid fa-boxes-stacked mr-2 text-cyan-400"></i>外倉庫存明細</h3>
                            <span class="text-xs text-slate-400" id="ext-stock-count">0 筆</span>
                        </div>
                        <div class="flex-1 overflow-auto">
                            <table class="w-full text-xs">
                                <thead class="sticky top-0 bg-slate-800">
                                    <tr class="text-slate-400">
                                        <th class="text-left p-2">公司</th>
                                        <th class="text-left p-2">倉庫</th>
                                        <th class="text-left p-2">品名</th>
                                        <th class="text-left p-2">規格</th>
                                        <th class="text-left p-2">批號</th>
                                        <th class="text-right p-2">數量</th>
                                        <th class="text-left p-2">效期</th>
                                        <th class="text-center p-2">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="external-stock-list">
                                    <tr><td colspan="8" class="text-center text-slate-500 py-10">載入中...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- 右側：手動調整/對帳 -->
                    <div class="w-72 glass-panel p-3 flex flex-col">
                        <h3 class="text-white font-bold text-sm mb-2 border-b border-slate-700 pb-2">
                            <i class="fa-solid fa-pen-to-square mr-2 text-yellow-400"></i>庫存調整/對帳
                        </h3>
                        <div class="space-y-2">
                            <!-- 公司選擇 -->
                            <div>
                                <label class="text-xs text-slate-400">公司 *</label>
                                <div class="flex gap-1 bg-slate-900 rounded p-1">
                                    <label class="flex-1 cursor-pointer">
                                        <input type="radio" name="ext-adj-company" value="崇文" class="hidden peer" checked>
                                        <div class="text-center py-1 rounded text-xs font-bold peer-checked:bg-blue-600 peer-checked:text-white text-slate-400">崇文</div>
                                    </label>
                                    <label class="flex-1 cursor-pointer">
                                        <input type="radio" name="ext-adj-company" value="八方" class="hidden peer">
                                        <div class="text-center py-1 rounded text-xs font-bold peer-checked:bg-purple-600 peer-checked:text-white text-slate-400">八方</div>
                                    </label>
                                </div>
                            </div>
                            <div>
                                <label class="text-xs text-slate-400">外倉 *</label>
                                <select id="ext-adj-wh" class="scan-input text-sm">
                                    <option value="">選擇倉庫</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs text-slate-400">品名 *</label>
                                <input type="text" id="ext-adj-name" class="scan-input text-sm" placeholder="品名">
                            </div>
                            <div>
                                <label class="text-xs text-slate-400">規格</label>
                                <input type="text" id="ext-adj-spec" class="scan-input" placeholder="規格">
                            </div>
                            <div>
                                <label class="text-xs text-slate-400">批號 *（自產/進口/大宗必填）</label>
                                <input type="text" id="ext-adj-batch" class="scan-input" placeholder="批號">
                            </div>
                            <div>
                                <label class="text-xs text-red-400">效期 *（必填）</label>
                                <input type="date" id="ext-adj-exp" class="scan-input border-red-500/50">
                            </div>
                            <div>
                                <label class="text-xs text-slate-400">調整數量 *</label>
                                <input type="number" id="ext-adj-qty" class="scan-input text-center font-bold" placeholder="正數增加/負數減少">
                            </div>
                            <div>
                                <label class="text-xs text-slate-400">調整原因</label>
                                <select id="ext-adj-reason" class="scan-input">
                                    <option value="盤點調整">盤點調整</option>
                                    <option value="外倉出貨">外倉出貨（扣庫存）</option>
                                    <option value="外倉收貨">外倉收貨（加庫存）</option>
                                    <option value="損耗報廢">損耗報廢</option>
                                    <option value="其他">其他</option>
                                </select>
                            </div>
                            <button onclick="submitExternalAdjust()" class="w-full py-3 bg-yellow-600 hover:bg-yellow-500 text-white rounded font-bold mt-2">
                                <i class="fa-solid fa-check mr-2"></i>確認調整
                            </button>
                        </div>

                        <div class="mt-4 pt-4 border-t border-slate-700">
                            <h4 class="text-white font-bold text-sm mb-2"><i class="fa-solid fa-file-import mr-2 text-emerald-400"></i>批次匯入對帳</h4>
                            <p class="text-xs text-slate-500 mb-2">匯入外倉提供的庫存表進行對帳</p>
                            <input type="file" id="ext-import-file" accept=".xlsx,.csv" class="hidden" onchange="handleExternalImport(event)">
                            <button onclick="document.getElementById('ext-import-file').click()" class="w-full py-2 bg-emerald-600 hover:bg-emerald-500 text-white rounded text-sm font-bold">
                                <i class="fa-solid fa-upload mr-2"></i>上傳外倉庫存表
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 倉庫調撥 -->
            <div id="view-transfer" class="view-panel h-full hidden flex flex-col p-4">
                <!-- 頂部控制列：公司選擇和調撥方向 -->
                <div class="glass-panel p-3 mb-3">
                    <div class="flex items-center gap-4 flex-wrap">
                        <!-- 標題 -->
                        <div class="flex items-center gap-2">
                            <i class="fa-solid fa-right-left text-purple-400"></i>
                            <span class="text-white font-bold">倉庫調撥</span>
                        </div>

                        <div class="w-px h-6 bg-slate-600"></div>

                        <!-- 公司選擇 -->
                        <div class="flex items-center gap-2">
                            <span class="text-slate-400 text-xs">公司：</span>
                            <button onclick="setTransferCompany('崇文')" id="btn-transfer-cw" class="px-3 py-1.5 rounded font-bold text-xs bg-blue-600 text-white">崇文</button>
                            <button onclick="setTransferCompany('八方')" id="btn-transfer-bf" class="px-3 py-1.5 rounded font-bold text-xs bg-slate-700 text-slate-300 hover:bg-slate-600">八方</button>
                        </div>

                        <div class="w-px h-6 bg-slate-600"></div>

                        <!-- 調撥方向 -->
                        <div class="flex items-center gap-2">
                            <span class="text-slate-400 text-xs">調撥方向：</span>
                            <button onclick="setTransferMode('in')" id="btn-mode-in" class="px-3 py-1.5 rounded font-bold text-xs bg-emerald-600 text-white">
                                <i class="fa-solid fa-arrow-right mr-1"></i>調撥入庫
                            </button>
                            <button onclick="setTransferMode('out')" id="btn-mode-out" class="px-3 py-1.5 rounded font-bold text-xs bg-slate-700 text-slate-300 hover:bg-slate-600">
                                <i class="fa-solid fa-arrow-left mr-1"></i>調撥出庫
                            </button>
                            <button onclick="setTransferMode('ext')" id="btn-mode-ext" class="px-3 py-1.5 rounded font-bold text-xs bg-slate-700 text-slate-300 hover:bg-slate-600">
                                <i class="fa-solid fa-arrows-left-right mr-1"></i>外庫調撥
                            </button>
                        </div>

                        <!-- 說明文字 -->
                        <div class="ml-auto text-xs" id="transfer-mode-desc">
                            <span class="text-emerald-400"><i class="fa-solid fa-info-circle mr-1"></i>外倉 → 進貨暫存區（之後移板上架）</span>
                        </div>
                    </div>
                </div>

                <div class="flex gap-3 flex-1 min-h-0">
                    <!-- 左側：調撥設定（簡化版 + 防呆） -->
                    <div class="w-80 glass-panel p-3 flex flex-col">
                        <h3 class="text-white font-bold mb-3 border-b border-slate-700 pb-2 text-sm" id="transfer-form-title">
                            <i class="fa-solid fa-truck-arrow-right mr-2 text-emerald-400"></i>調撥入庫（外倉→本倉）
                        </h3>

                        <div class="space-y-3 flex-1">
                            <!-- Step 1: 選擇倉庫 -->
                            <div class="bg-gradient-to-r from-slate-800 to-slate-900 rounded-lg p-3 border border-slate-600" id="transfer-step1-panel">
                                <div class="flex items-center mb-2">
                                    <span class="text-xs text-slate-400 font-bold">
                                        <i class="fa-solid fa-1 w-4 h-4 rounded-full bg-blue-600 text-white text-center mr-1 inline-flex items-center justify-center text-[10px]"></i>
                                        <span id="transfer-wh-step-label">選擇倉庫</span>
                                    </span>
                                    <span class="ml-auto text-xs text-red-400 hidden" id="transfer-step1-hint">* 必填</span>
                                </div>
                                <div class="space-y-2" id="transfer-warehouse-row">
                                    <div id="transfer-source-div">
                                        <label class="text-xs text-slate-400" id="transfer-source-label">來源外倉 *</label>
                                        <select id="transfer-source" class="scan-input text-sm" onchange="onTransferSourceChange(); updateTransferStepStatus();">
                                            <option value="">選擇外倉</option>
                                        </select>
                                    </div>
                                    <div id="transfer-target-div" style="display:none;">
                                        <label class="text-xs text-slate-400">目標外倉 *</label>
                                        <select id="transfer-target" class="scan-input text-sm" onchange="updateTransferStepStatus();">
                                            <option value="">選擇外倉</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Step 2: 選擇品項按鈕 -->
                            <div class="bg-gradient-to-r from-slate-800 to-slate-900 rounded-lg p-3 border border-slate-600 transition-opacity" id="transfer-step2-panel">
                                <div class="flex items-center mb-2">
                                    <span class="text-xs text-slate-400 font-bold">
                                        <i class="fa-solid fa-2 w-4 h-4 rounded-full bg-purple-600 text-white text-center mr-1 inline-flex items-center justify-center text-[10px]"></i>
                                        選擇品項與數量
                                    </span>
                                </div>
                                <button onclick="openTransferProductModal()" id="btn-open-transfer-modal" class="w-full bg-purple-600 hover:bg-purple-500 text-white px-4 py-3 rounded-lg font-bold text-sm transition disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-purple-600" disabled>
                                    <i class="fa-solid fa-boxes-stacked mr-2"></i>選擇品項（可複選）
                                </button>
                                <p class="text-xs text-slate-500 mt-2 text-center" id="transfer-step2-hint">
                                    <i class="fa-solid fa-lock mr-1"></i>請先完成步驟 1
                                </p>
                            </div>

                            <!-- 調撥入庫處理方式（僅調撥入庫模式顯示） -->
                            <div id="transfer-in-options" class="bg-slate-800 rounded-lg p-2.5 border border-slate-600">
                                <label class="text-xs text-slate-400 mb-1.5 block font-bold">
                                    <i class="fa-solid fa-3 w-4 h-4 rounded-full bg-emerald-600 text-white text-center mr-1 inline-flex items-center justify-center text-[10px]"></i>
                                    入庫後處理方式
                                </label>
                                <div class="space-y-1.5">
                                    <label class="flex items-center gap-2 cursor-pointer p-1.5 rounded hover:bg-slate-700">
                                        <input type="radio" name="transfer-in-method" value="pending" class="text-emerald-500" checked>
                                        <div class="flex-1">
                                            <span class="text-white text-sm font-bold">產生待執行工單</span>
                                            <div class="text-slate-400 text-xs">推送到智能入庫中心</div>
                                        </div>
                                        <span class="text-emerald-400 text-xs px-1.5 py-0.5 bg-emerald-900/50 rounded">建議</span>
                                    </label>
                                    <label class="flex items-center gap-2 cursor-pointer p-1.5 rounded hover:bg-slate-700">
                                        <input type="radio" name="transfer-in-method" value="temp" class="text-yellow-500">
                                        <div class="flex-1">
                                            <span class="text-white text-sm">入暫存區</span>
                                            <div class="text-slate-400 text-xs">直接入進貨暫存區（TEMP-IN）</div>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 隱藏欄位（保留相容性） -->
                        <input type="hidden" id="transfer-product">
                        <input type="hidden" id="transfer-spec">
                        <input type="hidden" id="transfer-batch">
                        <input type="hidden" id="transfer-exp">
                        <input type="hidden" id="transfer-location">
                        <input type="hidden" id="transfer-qty">
                        <div id="transfer-selected-product" class="hidden"></div>
                        <span id="transfer-available" class="hidden">0</span>
                    </div>

                    <!-- 右側：調撥清單 -->
                    <div class="flex-1 glass-panel p-3 flex flex-col">
                        <div class="flex justify-between items-center mb-2 border-b border-slate-700 pb-2">
                            <h3 class="text-white font-bold text-sm"><i class="fa-solid fa-list-check mr-2 text-yellow-400"></i>調撥清單</h3>
                            <button onclick="clearTransferList()" class="bg-slate-700 hover:bg-slate-600 text-white px-2 py-1 rounded text-xs">
                                <i class="fa-solid fa-trash mr-1"></i>清空
                            </button>
                        </div>
                        <div class="flex-1 overflow-auto">
                            <table class="w-full text-xs">
                                <thead class="sticky top-0 bg-slate-800">
                                    <tr class="text-slate-400">
                                        <th class="text-left p-1.5">品名</th>
                                        <th class="text-left p-1.5">規格</th>
                                        <th class="text-left p-1.5">批號</th>
                                        <th class="text-left p-1.5">效期</th>
                                        <th class="text-left p-1.5">來源</th>
                                        <th class="text-left p-1.5">目標</th>
                                        <th class="text-right p-1.5">數量</th>
                                        <th class="text-center p-1.5">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="transfer-list">
                                    <tr><td colspan="8" class="text-center text-slate-500 py-8">尚未加入調撥品項</td></tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="border-t border-slate-700 pt-2 mt-2">
                            <button onclick="executeTransfer()" class="w-full py-2.5 bg-purple-600 hover:bg-purple-500 text-white rounded-lg font-bold" id="btn-execute-transfer" disabled>
                                <i class="fa-solid fa-check-double mr-2"></i>確認執行調撥
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 使用者管理頁面 -->
            <div id="view-user-management" class="view-panel h-full hidden flex flex-col p-4">
                <!-- 頂部標題 -->
                <div class="flex items-center justify-between bg-gradient-to-r from-blue-900 to-indigo-900 border border-blue-600 p-4 rounded-xl mb-4">
                    <div>
                        <h2 class="text-white font-bold text-2xl"><i class="fa-solid fa-users-gear mr-2 text-blue-400"></i>使用者管理</h2>
                        <p class="text-blue-200 text-sm mt-1">管理系統使用者帳號與權限角色 <span class="text-cyan-400">(Firebase 雲端同步)</span></p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="loadUserList()" class="bg-slate-700 hover:bg-slate-600 text-white px-3 py-2 rounded-lg">
                            <i class="fa-solid fa-rotate"></i>
                        </button>
                        <button onclick="exportUserList()" class="bg-slate-700 hover:bg-slate-600 text-white px-3 py-2 rounded-lg">
                            <i class="fa-solid fa-download mr-1"></i>匯出
                        </button>
                        <button onclick="openAddUserModal()" class="bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded-lg font-bold">
                            <i class="fa-solid fa-user-plus mr-2"></i>新增使用者
                        </button>
                    </div>
                </div>

                <!-- 角色權限說明 + 統計（整合） -->
                <div class="bg-slate-800/50 border border-slate-700 rounded-xl p-4 mb-4">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-white font-bold"><i class="fa-solid fa-shield-halved mr-2 text-purple-400"></i>角色權限總覽</h3>
                        <span id="user-count" class="text-slate-400 text-sm bg-slate-700/50 px-3 py-1 rounded-full">共 0 位使用者</span>
                    </div>
                    <div class="grid grid-cols-7 gap-2 text-sm">
                        <div class="bg-red-900/30 border border-red-600/50 rounded-lg p-3 hover:bg-red-900/50 transition cursor-pointer" onclick="document.getElementById('user-role-filter').value='admin';filterUserList();">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-red-400 font-bold text-xs"><i class="fa-solid fa-crown mr-1"></i>管理員</span>
                                <span class="text-red-400 font-black text-lg" id="stat-admin">0</span>
                            </div>
                            <div class="text-slate-400 text-[10px] leading-relaxed">全部功能<br>使用者管理</div>
                        </div>
                        <div class="bg-emerald-900/30 border border-emerald-600/50 rounded-lg p-3 hover:bg-emerald-900/50 transition cursor-pointer" onclick="document.getElementById('user-role-filter').value='finance';filterUserList();">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-emerald-400 font-bold text-xs"><i class="fa-solid fa-calculator mr-1"></i>財務</span>
                                <span class="text-emerald-400 font-black text-lg" id="stat-finance">0</span>
                            </div>
                            <div class="text-slate-400 text-[10px] leading-relaxed">入庫核准<br>倉租報表</div>
                        </div>
                        <div class="bg-purple-900/30 border border-purple-600/50 rounded-lg p-3 hover:bg-purple-900/50 transition cursor-pointer" onclick="document.getElementById('user-role-filter').value='supervisor';filterUserList();">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-purple-400 font-bold text-xs"><i class="fa-solid fa-user-tie mr-1"></i>主管</span>
                                <span class="text-purple-400 font-black text-lg" id="stat-supervisor">0</span>
                            </div>
                            <div class="text-slate-400 text-[10px] leading-relaxed">全部操作<br>報表核准</div>
                        </div>
                        <div class="bg-cyan-900/30 border border-cyan-600/50 rounded-lg p-3 hover:bg-cyan-900/50 transition cursor-pointer" onclick="document.getElementById('user-role-filter').value='sales';filterUserList();">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-cyan-400 font-bold text-xs"><i class="fa-solid fa-briefcase mr-1"></i>業務</span>
                                <span class="text-cyan-400 font-black text-lg" id="stat-sales">0</span>
                            </div>
                            <div class="text-slate-400 text-[10px] leading-relaxed">庫存查詢<br>寄倉報表</div>
                        </div>
                        <div class="bg-blue-900/30 border border-blue-600/50 rounded-lg p-3 hover:bg-blue-900/50 transition cursor-pointer" onclick="document.getElementById('user-role-filter').value='operator';filterUserList();">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-blue-400 font-bold text-xs"><i class="fa-solid fa-user mr-1"></i>倉管</span>
                                <span class="text-blue-400 font-black text-lg" id="stat-operator">0</span>
                            </div>
                            <div class="text-slate-400 text-[10px] leading-relaxed">入庫出庫<br>開立工單</div>
                        </div>
                        <div class="bg-orange-900/30 border border-orange-600/50 rounded-lg p-3 hover:bg-orange-900/50 transition cursor-pointer" onclick="document.getElementById('user-role-filter').value='forklift';filterUserList();">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-orange-400 font-bold text-xs"><i class="fa-solid fa-truck mr-1"></i>堆高機</span>
                                <span class="text-orange-400 font-black text-lg" id="stat-forklift">0</span>
                            </div>
                            <div class="text-slate-400 text-[10px] leading-relaxed">執行工單<br>移位上架</div>
                        </div>
                        <div class="bg-slate-700/30 border border-slate-600/50 rounded-lg p-3 hover:bg-slate-700/50 transition cursor-pointer" onclick="document.getElementById('user-role-filter').value='readonly';filterUserList();">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-slate-300 font-bold text-xs"><i class="fa-solid fa-eye mr-1"></i>只讀</span>
                                <span class="text-slate-300 font-black text-lg" id="stat-readonly">0</span>
                            </div>
                            <div class="text-slate-400 text-[10px] leading-relaxed">僅能查詢<br>無操作權</div>
                        </div>
                    </div>
                </div>

                <!-- 搜尋篩選 -->
                <div class="bg-slate-800/50 border border-slate-700 rounded-xl p-3 mb-4">
                    <div class="flex gap-3 items-center">
                        <input type="text" id="user-search" class="scan-input flex-1" placeholder="🔍 搜尋 Email 或姓名..." oninput="filterUserList()">
                        <select id="user-role-filter" class="scan-input w-40" onchange="filterUserList()">
                            <option value="">全部角色</option>
                            <option value="admin">管理員</option>
                            <option value="finance">財務人員</option>
                            <option value="supervisor">倉管主管</option>
                            <option value="sales">業務人員</option>
                            <option value="operator">倉管人員</option>
                            <option value="forklift">堆高機手</option>
                            <option value="readonly">只讀</option>
                        </select>
                        <select id="user-status-filter" class="scan-input w-32" onchange="filterUserList()">
                            <option value="">全部狀態</option>
                            <option value="active">啟用</option>
                            <option value="inactive">停用</option>
                        </select>
                        <button onclick="document.getElementById('user-role-filter').value='';document.getElementById('user-status-filter').value='';document.getElementById('user-search').value='';filterUserList();" class="bg-slate-700 hover:bg-slate-600 text-slate-300 px-3 py-2 rounded-lg text-sm" title="清除篩選">
                            <i class="fa-solid fa-filter-circle-xmark"></i>
                        </button>
                    </div>
                </div>

                <!-- 使用者清單 -->
                <div class="flex-1 bg-slate-800/50 border border-slate-700 rounded-xl overflow-hidden">
                    <div class="overflow-auto h-full">
                        <table class="w-full dense-table">
                            <thead>
                                <tr class="bg-slate-900">
                                    <th class="p-3 text-left">Email</th>
                                    <th class="p-3 text-left">姓名</th>
                                    <th class="p-3 text-left">角色</th>
                                    <th class="p-3 text-left">部門</th>
                                    <th class="p-3 text-center">狀態</th>
                                    <th class="p-3 text-left">最後登入</th>
                                    <th class="p-3 text-left">建立時間</th>
                                    <th class="p-3 text-center">操作</th>
                                </tr>
                            </thead>
                            <tbody id="user-list-body">
                                <tr><td colspan="8" class="text-center text-slate-500 py-8"><i class="fa-solid fa-spinner fa-spin mr-2"></i>載入中...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 新增/編輯使用者 Modal -->
            <div id="modal-user-edit" class="fixed inset-0 z-50 bg-black/80 hidden flex items-center justify-center backdrop-blur-sm">
                <div class="bg-slate-900 border border-slate-700 rounded-2xl w-[600px] shadow-2xl max-h-[90vh] overflow-hidden flex flex-col">
                    <div class="bg-gradient-to-r from-blue-900 to-indigo-900 p-4 rounded-t-2xl border-b border-slate-700">
                        <h3 class="text-white font-bold text-lg" id="modal-user-title"><i class="fa-solid fa-user-plus mr-2"></i>新增使用者</h3>
                    </div>
                    <div class="p-6 space-y-4 overflow-y-auto flex-1">
                        <input type="hidden" id="edit-user-id">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-slate-400 text-xs mb-1 block">Email <span class="text-red-400">*</span></label>
                                <input type="email" id="edit-user-email" class="scan-input w-full" placeholder="user@company.com">
                            </div>
                            <div>
                                <label class="text-slate-400 text-xs mb-1 block">姓名 <span class="text-red-400">*</span></label>
                                <input type="text" id="edit-user-name" class="scan-input w-full" placeholder="王小明">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-slate-400 text-xs mb-1 block">角色範本 <span class="text-red-400">*</span></label>
                                <select id="edit-user-role" class="scan-input w-full" onchange="applyRoleTemplate()">
                                    <option value="admin">管理員（全部權限）</option>
                                    <option value="finance">財務人員</option>
                                    <option value="supervisor">倉管主管</option>
                                    <option value="sales">業務人員</option>
                                    <option value="operator" selected>倉管人員</option>
                                    <option value="forklift">堆高機手</option>
                                    <option value="readonly">只讀</option>
                                    <option value="custom">🔧 自訂權限</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-slate-400 text-xs mb-1 block">部門</label>
                                <input type="text" id="edit-user-dept" class="scan-input w-full" placeholder="倉儲部">
                            </div>
                        </div>

                        <!-- 自訂權限區塊 -->
                        <div id="custom-permissions-section" class="bg-slate-800/50 border border-slate-700 rounded-xl p-4">
                            <div class="flex items-center justify-between mb-3">
                                <label class="text-slate-300 text-sm font-bold"><i class="fa-solid fa-key mr-2 text-amber-400"></i>功能權限</label>
                                <div class="flex gap-2">
                                    <button type="button" onclick="selectAllPermissions()" class="text-xs bg-slate-700 hover:bg-slate-600 text-slate-300 px-2 py-1 rounded">全選</button>
                                    <button type="button" onclick="clearAllPermissions()" class="text-xs bg-slate-700 hover:bg-slate-600 text-slate-300 px-2 py-1 rounded">清除</button>
                                </div>
                            </div>
                            <div class="grid grid-cols-3 gap-2 text-sm">
                                <!-- 入庫管理 -->
                                <div class="bg-emerald-900/20 border border-emerald-700/30 rounded-lg p-2">
                                    <div class="text-emerald-400 text-xs font-bold mb-2"><i class="fa-solid fa-arrow-down mr-1"></i>入庫管理</div>
                                    <label class="flex items-center gap-2 text-slate-300 text-xs cursor-pointer hover:text-white">
                                        <input type="checkbox" id="perm-inbound" class="perm-checkbox w-3 h-3"> 入庫作業
                                    </label>
                                    <label class="flex items-center gap-2 text-slate-300 text-xs cursor-pointer hover:text-white mt-1">
                                        <input type="checkbox" id="perm-approve" class="perm-checkbox w-3 h-3"> 入庫核准
                                    </label>
                                </div>
                                <!-- 庫存異動作業 -->
                                <div class="bg-blue-900/20 border border-blue-700/30 rounded-lg p-2">
                                    <div class="text-blue-400 text-xs font-bold mb-2"><i class="fa-solid fa-warehouse mr-1"></i>庫存異動作業</div>
                                    <label class="flex items-center gap-2 text-slate-300 text-xs cursor-pointer hover:text-white">
                                        <input type="checkbox" id="perm-inventory" class="perm-checkbox w-3 h-3"> 庫存查詢
                                    </label>
                                    <label class="flex items-center gap-2 text-slate-300 text-xs cursor-pointer hover:text-white mt-1">
                                        <input type="checkbox" id="perm-move" class="perm-checkbox w-3 h-3"> 庫存調度
                                    </label>
                                    <label class="flex items-center gap-2 text-slate-300 text-xs cursor-pointer hover:text-white mt-1">
                                        <input type="checkbox" id="perm-merge" class="perm-checkbox w-3 h-3"> 板號異動
                                    </label>
                                    <label class="flex items-center gap-2 text-slate-300 text-xs cursor-pointer hover:text-white mt-1">
                                        <input type="checkbox" id="perm-stocktake" class="perm-checkbox w-3 h-3"> 庫存盤點
                                    </label>
                                </div>
                                <!-- 出庫管理 -->
                                <div class="bg-red-900/20 border border-red-700/30 rounded-lg p-2">
                                    <div class="text-red-400 text-xs font-bold mb-2"><i class="fa-solid fa-arrow-up mr-1"></i>出庫管理</div>
                                    <label class="flex items-center gap-2 text-slate-300 text-xs cursor-pointer hover:text-white">
                                        <input type="checkbox" id="perm-outbound" class="perm-checkbox w-3 h-3"> 波次揀貨
                                    </label>
                                    <label class="flex items-center gap-2 text-slate-300 text-xs cursor-pointer hover:text-white mt-1">
                                        <input type="checkbox" id="perm-dispatch" class="perm-checkbox w-3 h-3"> 執行調度
                                    </label>
                                </div>
                                <!-- 倉租管理 -->
                                <div class="bg-amber-900/20 border border-amber-700/30 rounded-lg p-2">
                                    <div class="text-amber-400 text-xs font-bold mb-2"><i class="fa-solid fa-dollar-sign mr-1"></i>倉租管理</div>
                                    <label class="flex items-center gap-2 text-slate-300 text-xs cursor-pointer hover:text-white">
                                        <input type="checkbox" id="perm-consignment" class="perm-checkbox w-3 h-3"> 寄倉管理
                                    </label>
                                    <label class="flex items-center gap-2 text-slate-300 text-xs cursor-pointer hover:text-white mt-1">
                                        <input type="checkbox" id="perm-rental" class="perm-checkbox w-3 h-3"> 倉租報表
                                    </label>
                                </div>
                                <!-- 報表分析 -->
                                <div class="bg-purple-900/20 border border-purple-700/30 rounded-lg p-2">
                                    <div class="text-purple-400 text-xs font-bold mb-2"><i class="fa-solid fa-chart-line mr-1"></i>報表分析</div>
                                    <label class="flex items-center gap-2 text-slate-300 text-xs cursor-pointer hover:text-white">
                                        <input type="checkbox" id="perm-report" class="perm-checkbox w-3 h-3"> 報表匯出
                                    </label>
                                    <label class="flex items-center gap-2 text-slate-300 text-xs cursor-pointer hover:text-white mt-1">
                                        <input type="checkbox" id="perm-analysis" class="perm-checkbox w-3 h-3"> 出貨分析
                                    </label>
                                </div>
                                <!-- 系統管理 -->
                                <div class="bg-slate-700/30 border border-slate-600/30 rounded-lg p-2">
                                    <div class="text-slate-300 text-xs font-bold mb-2"><i class="fa-solid fa-gear mr-1"></i>系統管理</div>
                                    <label class="flex items-center gap-2 text-slate-300 text-xs cursor-pointer hover:text-white">
                                        <input type="checkbox" id="perm-users" class="perm-checkbox w-3 h-3"> 使用者管理
                                    </label>
                                    <label class="flex items-center gap-2 text-slate-300 text-xs cursor-pointer hover:text-white mt-1">
                                        <input type="checkbox" id="perm-settings" class="perm-checkbox w-3 h-3"> 系統設定
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div id="password-fields">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-slate-400 text-xs mb-1 block">密碼 <span class="text-red-400">*</span></label>
                                    <input type="password" id="edit-user-password" class="scan-input w-full" placeholder="至少6位">
                                </div>
                                <div>
                                    <label class="text-slate-400 text-xs mb-1 block">確認密碼 <span class="text-red-400">*</span></label>
                                    <input type="password" id="edit-user-password2" class="scan-input w-full" placeholder="再次輸入">
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="edit-user-active" checked class="w-4 h-4">
                            <label for="edit-user-active" class="text-slate-300 text-sm">帳號啟用</label>
                        </div>
                    </div>
                    <div class="p-4 border-t border-slate-700 flex gap-3">
                        <button onclick="saveUser()" class="flex-1 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-bold">
                            <i class="fa-solid fa-save mr-2"></i>儲存
                        </button>
                        <button onclick="closeUserModal()" class="flex-1 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg">取消</button>
                    </div>
                </div>
            </div>

            <!-- 執行調度工單 Modal -->
            <div id="modal-dispatch-execute" class="fixed inset-0 z-50 bg-black/80 hidden flex items-center justify-center backdrop-blur-sm">
                <div class="bg-slate-900 border border-slate-700 rounded-2xl w-[900px] max-h-[90vh] shadow-2xl flex flex-col">
                    <!-- 標題 -->
                    <div class="bg-gradient-to-r from-orange-900 to-red-900 p-4 rounded-t-2xl border-b border-slate-700 flex items-center justify-between">
                        <div>
                            <h3 class="text-white font-bold text-lg"><i class="fa-solid fa-play-circle mr-2 text-orange-400"></i>執行調度工單</h3>
                            <p class="text-orange-200 text-xs mt-1" id="dispatch-exec-subtitle">掃描板號確認執行</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <label class="flex items-center gap-2 text-sm">
                                <input type="checkbox" id="dispatch-batch-mode" class="w-4 h-4" onchange="toggleDispatchBatchMode()">
                                <span class="text-orange-200">批次勾選模式</span>
                            </label>
                        </div>
                    </div>

                    <!-- 工單選擇 -->
                    <div class="p-4 border-b border-slate-700 bg-slate-800/50">
                        <div class="flex items-center gap-4">
                            <label class="text-slate-400 text-sm">選擇工單：</label>
                            <select id="dispatch-exec-order-select" class="scan-input flex-1" onchange="loadDispatchExecOrder()">
                                <option value="">-- 請選擇 --</option>
                            </select>
                            <div class="text-sm">
                                <span class="text-slate-400">進度：</span>
                                <span class="text-emerald-400 font-bold" id="dispatch-exec-progress">0/0</span>
                            </div>
                        </div>
                    </div>

                    <!-- 掃描區 -->
                    <div id="dispatch-scan-area" class="p-4 border-b border-slate-700 bg-slate-800/30">
                        <div class="flex items-center gap-3">
                            <i class="fa-solid fa-barcode text-blue-400 text-xl"></i>
                            <input type="text" id="dispatch-scan-input" class="scan-input flex-1 text-lg" placeholder="掃描板號確認..." onkeypress="if(event.key==='Enter') confirmDispatchScan()">
                            <button onclick="confirmDispatchScan()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg font-bold">
                                <i class="fa-solid fa-check mr-1"></i>確認
                            </button>
                        </div>
                        <div id="dispatch-scan-result" class="mt-2 text-sm hidden"></div>
                    </div>

                    <!-- 操作清單 -->
                    <div class="flex-1 overflow-auto p-4">
                        <table class="w-full text-sm">
                            <thead class="bg-slate-800 sticky top-0">
                                <tr>
                                    <th class="text-left p-2 w-10" id="dispatch-batch-header" style="display:none"><input type="checkbox" id="dispatch-check-all" onchange="toggleAllDispatchChecks()"></th>
                                    <th class="text-left p-2 w-16">狀態</th>
                                    <th class="text-left p-2">類型</th>
                                    <th class="text-left p-2">來源儲位</th>
                                    <th class="text-left p-2">板號</th>
                                    <th class="text-right p-2">數量</th>
                                    <th class="text-center p-2 w-12">→</th>
                                    <th class="text-left p-2">目標儲位</th>
                                    <th class="text-left p-2">說明</th>
                                </tr>
                            </thead>
                            <tbody id="dispatch-exec-list">
                                <tr><td colspan="9" class="text-center text-slate-500 py-8">請選擇工單</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- 底部按鈕 -->
                    <div class="p-4 border-t border-slate-700 flex gap-3">
                        <button onclick="executeDispatchBatch()" id="btn-dispatch-batch-exec" class="flex-1 py-3 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg font-bold hidden">
                            <i class="fa-solid fa-check-double mr-2"></i>執行勾選項目
                        </button>
                        <button onclick="completeDispatchOrder()" id="btn-dispatch-complete" class="flex-1 py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-bold">
                            <i class="fa-solid fa-flag-checkered mr-2"></i>完成工單
                        </button>
                        <button onclick="closeDispatchExecuteModal()" class="px-6 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-lg">關閉</button>
                    </div>
                </div>
            </div>

            <!-- 品項主檔 -->
            <div id="view-product-master" class="view-panel h-full hidden flex flex-col p-4">
                <div class="bg-gradient-to-r from-cyan-900 to-cyan-800 border border-cyan-600 p-3 rounded-lg mb-3 flex justify-between items-center">
                    <h2 class="text-white font-bold text-lg"><i class="fa-solid fa-box mr-2 text-cyan-400"></i>品項主檔</h2>
                    <div class="flex gap-2">
                        <button onclick="showProductMasterImport()" class="px-3 py-1.5 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg text-sm font-bold">
                            <i class="fa-solid fa-file-excel mr-1"></i>Excel 匯入
                        </button>
                        <button onclick="downloadProductMasterTemplate()" class="px-3 py-1.5 bg-blue-600 hover:bg-blue-500 text-white rounded-lg text-sm font-bold">
                            <i class="fa-solid fa-download mr-1"></i>下載範本
                        </button>
                        <button onclick="exportProductMaster()" class="px-3 py-1.5 bg-slate-600 hover:bg-slate-500 text-white rounded-lg text-sm font-bold">
                            <i class="fa-solid fa-file-export mr-1"></i>匯出
                        </button>
                        <button onclick="clearAllProductMaster()" class="px-3 py-1.5 bg-red-600 hover:bg-red-500 text-white rounded-lg text-sm font-bold">
                            <i class="fa-solid fa-trash mr-1"></i>清空全部
                        </button>
                    </div>
                </div>

                <div class="flex gap-3 flex-1 overflow-hidden">
                    <!-- 左側：新增/編輯（新增欄位）-->
                    <div class="w-80 glass-panel p-3 flex flex-col overflow-y-auto">
                        <h3 class="text-white font-bold mb-2 text-sm border-b border-slate-700 pb-2">
                            <i class="fa-solid fa-plus-circle mr-1 text-cyan-400"></i>新增/編輯品項
                        </h3>
                        <div class="space-y-2 text-sm">
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="text-xs text-slate-400">品號</label>
                                    <input type="text" id="pm-code" class="scan-input py-1" placeholder="A001">
                                </div>
                                <div>
                                    <label class="text-xs text-slate-400">類別</label>
                                    <select id="pm-category" class="scan-input py-1">
                                        <option value="成品">成品</option>
                                        <option value="原料">原料</option>
                                        <option value="半成品">半成品</option>
                                        <option value="包材">包材</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="text-xs text-slate-400">品名 *</label>
                                <input type="text" id="pm-name" class="scan-input py-1" placeholder="例：鮭魚切片">
                            </div>
                            <div>
                                <label class="text-xs text-slate-400">規格</label>
                                <input type="text" id="pm-spec" class="scan-input py-1" placeholder="300/400">
                            </div>
                            
                            <!-- 新增：計重方式 -->
                            <div class="bg-slate-800/50 rounded p-2 border border-slate-700">
                                <label class="text-xs text-cyan-400 font-bold mb-1 block">計重方式</label>
                                <div class="flex gap-2">
                                    <label class="flex-1 cursor-pointer">
                                        <input type="radio" name="pm-weight-type" value="fixed" class="hidden peer" checked>
                                        <div class="text-center py-1.5 rounded text-xs font-bold peer-checked:bg-blue-600 peer-checked:text-white bg-slate-700 text-slate-400 transition-all">
                                            📦 定重品
                                        </div>
                                    </label>
                                    <label class="flex-1 cursor-pointer">
                                        <input type="radio" name="pm-weight-type" value="variable" class="hidden peer">
                                        <div class="text-center py-1.5 rounded text-xs font-bold peer-checked:bg-amber-600 peer-checked:text-white bg-slate-700 text-slate-400 transition-all">
                                            ⚖️ 不定重
                                        </div>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- 新增：入庫類型 -->
                            <div class="bg-slate-800/50 rounded p-2 border border-slate-700">
                                <label class="text-xs text-cyan-400 font-bold mb-1 block">入庫類型</label>
                                <div class="grid grid-cols-4 gap-1">
                                    <label class="cursor-pointer">
                                        <input type="radio" name="pm-inbound-type" value="Raw" class="hidden peer" checked>
                                        <div class="text-center py-1 rounded text-[10px] font-bold peer-checked:bg-emerald-600 peer-checked:text-white bg-slate-700 text-slate-400">採購</div>
                                    </label>
                                    <label class="cursor-pointer">
                                        <input type="radio" name="pm-inbound-type" value="FG" class="hidden peer">
                                        <div class="text-center py-1 rounded text-[10px] font-bold peer-checked:bg-blue-600 peer-checked:text-white bg-slate-700 text-slate-400">成品</div>
                                    </label>
                                    <label class="cursor-pointer">
                                        <input type="radio" name="pm-inbound-type" value="WIP" class="hidden peer">
                                        <div class="text-center py-1 rounded text-[10px] font-bold peer-checked:bg-yellow-600 peer-checked:text-white bg-slate-700 text-slate-400">半成品</div>
                                    </label>
                                    <label class="cursor-pointer">
                                        <input type="radio" name="pm-inbound-type" value="RM" class="hidden peer">
                                        <div class="text-center py-1 rounded text-[10px] font-bold peer-checked:bg-orange-600 peer-checked:text-white bg-slate-700 text-slate-400">原料</div>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-3 gap-2">
                                <div>
                                    <label class="text-xs text-slate-400">板容量(件)</label>
                                    <input type="number" id="pm-pallet-capacity" class="scan-input py-1" placeholder="40" min="1">
                                </div>
                                <div>
                                    <label class="text-xs text-cyan-400 font-bold">箱容(kg)</label>
                                    <input type="number" id="pm-unit-weight" class="scan-input py-1 border-cyan-500/50" placeholder="10" step="0.1" min="0" onchange="updateBoxSizePreview()">
                                </div>
                                <div>
                                    <label class="text-xs text-slate-400">保存期(月)</label>
                                    <input type="number" id="pm-shelf-life" class="scan-input py-1" value="24" min="1" max="60">
                                </div>
                            </div>
                            
                            <!-- 容積預覽（自動計算）-->
                            <div class="bg-slate-800/50 rounded p-2 border border-slate-700">
                                <div class="flex justify-between items-center">
                                    <label class="text-xs text-slate-400">
                                        <i class="fa-solid fa-cube mr-1"></i>箱子尺寸（依箱容自動判斷）
                                    </label>
                                    <span id="pm-box-size-badge" class="text-[10px] px-2 py-0.5 rounded bg-blue-600 text-white">標準箱</span>
                                </div>
                                <div class="text-[10px] text-slate-500 mt-1">
                                    ≤5kg=小箱 | 6~15kg=標準箱 | >15kg=大箱
                                </div>
                                <div class="text-[10px] text-cyan-400 mt-1">
                                    <i class="fa-solid fa-layer-group mr-1"></i>
                                    3F: 只放整板(8板) | 2F: 整板4/不足板5 | 1F: 整板8/不足板16
                                </div>
                            </div>
                            
                            <div>
                                <label class="text-xs text-slate-400">備註</label>
                                <input type="text" id="pm-note" class="scan-input py-1" placeholder="說明">
                            </div>
                            <input type="hidden" id="pm-edit-id" value="">
                            <div class="flex gap-2">
                                <button onclick="saveProductMaster()" class="flex-1 py-1.5 bg-cyan-600 hover:bg-cyan-500 text-white rounded font-bold text-sm">
                                    <i class="fa-solid fa-save mr-1"></i>儲存
                                </button>
                                <button onclick="clearProductMasterForm()" class="px-3 py-1.5 bg-slate-700 hover:bg-slate-600 text-white rounded text-sm">
                                    清除
                                </button>
                            </div>
                        </div>

                        <div class="mt-3 pt-2 border-t border-slate-700">
                            <div class="text-xs text-slate-400 mb-1">快速設定：</div>
                            <div class="flex flex-wrap gap-1 mb-1">
                                <span class="text-[10px] text-slate-500">板容量:</span>
                                <button onclick="document.getElementById('pm-pallet-capacity').value=30" class="px-1.5 py-0.5 bg-slate-700 hover:bg-slate-600 text-white rounded text-[10px]">30</button>
                                <button onclick="document.getElementById('pm-pallet-capacity').value=40" class="px-1.5 py-0.5 bg-yellow-600 hover:bg-yellow-500 text-white rounded text-[10px] font-bold">40</button>
                                <button onclick="document.getElementById('pm-pallet-capacity').value=50" class="px-1.5 py-0.5 bg-slate-700 hover:bg-slate-600 text-white rounded text-[10px]">50</button>
                                <button onclick="document.getElementById('pm-pallet-capacity').value=60" class="px-1.5 py-0.5 bg-slate-700 hover:bg-slate-600 text-white rounded text-[10px]">60</button>
                            </div>
                            <div class="flex flex-wrap gap-1 mb-1">
                                <span class="text-[10px] text-slate-500">箱容kg:</span>
                                <button onclick="document.getElementById('pm-unit-weight').value=5" class="px-1.5 py-0.5 bg-slate-700 hover:bg-slate-600 text-white rounded text-[10px]">5</button>
                                <button onclick="document.getElementById('pm-unit-weight').value=10" class="px-1.5 py-0.5 bg-cyan-600 hover:bg-cyan-500 text-white rounded text-[10px] font-bold">10</button>
                                <button onclick="document.getElementById('pm-unit-weight').value=15" class="px-1.5 py-0.5 bg-slate-700 hover:bg-slate-600 text-white rounded text-[10px]">15</button>
                                <button onclick="document.getElementById('pm-unit-weight').value=20" class="px-1.5 py-0.5 bg-slate-700 hover:bg-slate-600 text-white rounded text-[10px]">20</button>
                            </div>
                            <div class="flex flex-wrap gap-1">
                                <span class="text-[10px] text-slate-500">保存期:</span>
                                <button onclick="document.getElementById('pm-shelf-life').value=12" class="px-1.5 py-0.5 bg-slate-700 hover:bg-slate-600 text-white rounded text-[10px]">12月</button>
                                <button onclick="document.getElementById('pm-shelf-life').value=18" class="px-1.5 py-0.5 bg-slate-700 hover:bg-slate-600 text-white rounded text-[10px]">18月</button>
                                <button onclick="document.getElementById('pm-shelf-life').value=24" class="px-1.5 py-0.5 bg-slate-700 hover:bg-slate-600 text-white rounded text-[10px]">24月</button>
                                <button onclick="document.getElementById('pm-shelf-life').value=36" class="px-1.5 py-0.5 bg-slate-700 hover:bg-slate-600 text-white rounded text-[10px]">36月</button>
                            </div>
                        </div>
                    </div>

                    <!-- 右側：品項清單（更新表頭）-->
                    <div class="flex-1 glass-panel flex flex-col overflow-hidden">
                        <div class="p-2 border-b border-slate-700 flex justify-between items-center">
                            <h3 class="text-white font-bold text-sm">
                                <i class="fa-solid fa-list mr-1 text-cyan-400"></i>品項清單
                            </h3>
                            <div class="flex gap-2 items-center">
                                <input type="text" id="pm-search" class="scan-input w-40 py-1" placeholder="搜尋品名..." oninput="filterProductMaster()">
                                <button onclick="autoImportFromInventory()" class="bg-emerald-600 hover:bg-emerald-500 text-white px-2 py-1 rounded text-xs font-bold">
                                    <i class="fa-solid fa-magic mr-1"></i>自動匯入
                                </button>
                            </div>
                        </div>
                        <div class="flex-1 overflow-auto">
                            <table class="w-full dense-table">
                                <thead>
                                    <tr>
                                        <th class="text-left">品號</th>
                                        <th class="text-left">品名</th>
                                        <th class="text-left">規格</th>
                                        <th class="text-center">計重</th>
                                        <th class="text-right">箱容</th>
                                        <th class="text-right">板容</th>
                                        <th class="text-right">保存期</th>
                                        <th class="text-center">入庫類型</th>
                                        <th class="text-center">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="product-master-list">
                                    <tr><td colspan="9" class="text-center text-slate-500 py-10">載入中...</td></tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="p-2 border-t border-slate-700 flex justify-between items-center text-xs">
                            <span class="text-slate-400">共 <span id="pm-total-count" class="text-white font-bold">0</span> 筆</span>
                            <span class="text-slate-500">排序：同品項集中、板容量降羃</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 標籤列印頁面 -->
            <div id="view-label-print" class="view-panel h-full hidden flex flex-col p-4">
                <div class="bg-gradient-to-r from-purple-900 to-purple-800 border border-purple-600 p-3 rounded-lg mb-4">
                    <h2 class="text-white font-bold text-xl"><i class="fa-solid fa-print mr-2 text-purple-400"></i>標籤列印</h2>
                    <p class="text-purple-200 text-sm mt-1">列印儲位條碼、重印棧板單</p>
                </div>

                <div class="grid grid-cols-2 gap-6 flex-1 min-h-0">
                    <!-- 左側：儲位條碼列印 -->
                    <div class="glass-panel p-4 flex flex-col overflow-hidden">
                        <div class="flex items-center justify-between mb-3 pb-2 border-b border-slate-700">
                            <h3 class="text-white font-bold text-lg">
                                <i class="fa-solid fa-location-dot mr-2 text-blue-400"></i>儲位條碼列印
                            </h3>
                            <button onclick="printLocationLabels()" class="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-bold text-sm">
                                <i class="fa-solid fa-print mr-1"></i>列印儲位條碼
                            </button>
                        </div>

                        <div class="flex-1 overflow-y-auto space-y-3">
                            <!-- Step 1: 倉庫選擇 -->
                            <div class="bg-slate-800/50 rounded-lg p-3">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="bg-blue-600 text-white text-xs px-2 py-0.5 rounded font-bold">1</span>
                                    <span class="text-sm text-slate-300 font-bold">選擇倉庫區域</span>
                                </div>
                                <div class="grid grid-cols-4 gap-2">
                                    <button onclick="selectLocZone('I-A')" class="loc-zone-btn px-2 py-1.5 bg-blue-900/50 border border-blue-700 rounded text-blue-400 font-bold text-xs hover:bg-blue-800/50 transition-colors" data-zone="I-A">I-A</button>
                                    <button onclick="selectLocZone('I-B')" class="loc-zone-btn px-2 py-1.5 bg-blue-900/50 border border-blue-700 rounded text-blue-400 font-bold text-xs hover:bg-blue-800/50 transition-colors" data-zone="I-B">I-B</button>
                                    <button onclick="selectLocZone('J-C')" class="loc-zone-btn px-2 py-1.5 bg-purple-900/50 border border-purple-700 rounded text-purple-400 font-bold text-xs hover:bg-purple-800/50 transition-colors" data-zone="J-C">J-C</button>
                                    <button onclick="selectLocZone('J-D')" class="loc-zone-btn px-2 py-1.5 bg-purple-900/50 border border-purple-700 rounded text-purple-400 font-bold text-xs hover:bg-purple-800/50 transition-colors" data-zone="J-D">J-D</button>
                                    <button onclick="selectLocZone('K-E')" class="loc-zone-btn px-2 py-1.5 bg-emerald-900/50 border border-emerald-700 rounded text-emerald-400 font-bold text-xs hover:bg-emerald-800/50 transition-colors" data-zone="K-E">K-E</button>
                                    <button onclick="selectLocZone('K-F')" class="loc-zone-btn px-2 py-1.5 bg-emerald-900/50 border border-emerald-700 rounded text-emerald-400 font-bold text-xs hover:bg-emerald-800/50 transition-colors" data-zone="K-F">K-F</button>
                                    <button onclick="selectLocZone('K-G')" class="loc-zone-btn px-2 py-1.5 bg-emerald-900/50 border border-emerald-700 rounded text-emerald-400 font-bold text-xs hover:bg-emerald-800/50 transition-colors" data-zone="K-G">K-G</button>
                                    <button onclick="selectLocZone('K-H')" class="loc-zone-btn px-2 py-1.5 bg-emerald-900/50 border border-emerald-700 rounded text-emerald-400 font-bold text-xs hover:bg-emerald-800/50 transition-colors" data-zone="K-H">K-H</button>
                                </div>
                            </div>

                            <!-- Step 2: 排號範圍 + 樓層 -->
                            <div class="bg-slate-800/50 rounded-lg p-3">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="bg-blue-600 text-white text-xs px-2 py-0.5 rounded font-bold">2</span>
                                    <span class="text-sm text-slate-300 font-bold">設定範圍</span>
                                </div>
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="text-xs text-slate-500 mb-1 block">排號範圍</label>
                                        <div class="flex items-center gap-1">
                                            <input type="number" id="loc-row-start" class="scan-input w-16 text-center py-1" value="1" min="1" max="22">
                                            <span class="text-slate-500">~</span>
                                            <input type="number" id="loc-row-end" class="scan-input w-16 text-center py-1" value="22" min="1" max="22">
                                        </div>
                                    </div>
                                    <div>
                                        <label class="text-xs text-slate-500 mb-1 block">樓層</label>
                                        <div class="flex gap-1">
                                            <label class="flex items-center gap-1 px-2 py-1 bg-slate-700 rounded cursor-pointer text-xs">
                                                <input type="checkbox" id="loc-floor-1f" checked class="w-3 h-3">
                                                <span class="text-white">1F</span>
                                            </label>
                                            <label class="flex items-center gap-1 px-2 py-1 bg-slate-700 rounded cursor-pointer text-xs">
                                                <input type="checkbox" id="loc-floor-2f" checked class="w-3 h-3">
                                                <span class="text-white">2F</span>
                                            </label>
                                            <label class="flex items-center gap-1 px-2 py-1 bg-slate-700 rounded cursor-pointer text-xs">
                                                <input type="checkbox" id="loc-floor-3f" checked class="w-3 h-3">
                                                <span class="text-white">3F</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 預覽 -->
                            <div class="bg-slate-900 rounded-lg p-3">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-xs text-slate-400"><i class="fa-solid fa-eye mr-1"></i>預覽</span>
                                    <span class="text-xs text-blue-400 font-bold" id="loc-print-count">0 張</span>
                                </div>
                                <div class="text-white text-sm" id="loc-print-preview">
                                    <span class="text-slate-500">請選擇倉庫區域</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 右側：棧板單重印 -->
                    <div class="glass-panel p-4 flex flex-col overflow-hidden">
                        <div class="flex items-center justify-between mb-3 pb-2 border-b border-slate-700">
                            <h3 class="text-white font-bold text-lg">
                                <i class="fa-solid fa-qrcode mr-2 text-emerald-400"></i>棧板單重印
                            </h3>
                            <button onclick="reprintPalletLabel()" id="btn-reprint-pallet" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg font-bold text-sm disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                <i class="fa-solid fa-print mr-1"></i>重印棧板單
                            </button>
                        </div>

                        <div class="flex-1 overflow-y-auto space-y-3">
                            <!-- 搜尋 -->
                            <div class="bg-slate-800/50 rounded-lg p-3">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="bg-emerald-600 text-white text-xs px-2 py-0.5 rounded font-bold">1</span>
                                    <span class="text-sm text-slate-300 font-bold">輸入棧板編號</span>
                                </div>
                                <div class="flex gap-2">
                                    <input type="text" id="reprint-pallet-id" class="scan-input flex-1" placeholder="P20241220001 或掃描 QR Code" onkeyup="if(event.keyCode===13) searchPalletForReprint()">
                                    <button onclick="searchPalletForReprint()" class="px-3 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg">
                                        <i class="fa-solid fa-search"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- 搜尋結果 / 棧板資訊 -->
                            <div class="bg-slate-900 rounded-lg p-3 flex-1 min-h-[150px]" id="reprint-pallet-info">
                                <div class="text-slate-500 text-center py-6">
                                    <i class="fa-solid fa-qrcode text-3xl mb-2 opacity-30"></i>
                                    <div class="text-sm">輸入棧板編號進行搜尋</div>
                                </div>
                            </div>

                            <!-- 最近重印記錄 -->
                            <div class="bg-slate-800/50 rounded-lg p-3">
                                <div class="text-xs text-slate-400 mb-2"><i class="fa-solid fa-history mr-1"></i>最近重印記錄</div>
                                <div id="reprint-history" class="space-y-1 max-h-24 overflow-y-auto text-xs">
                                    <div class="text-slate-600">尚無重印記錄</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 資料匯入頁面 -->
            <div id="view-data-import" class="view-panel h-full hidden flex flex-col p-4">
                <div class="bg-gradient-to-r from-amber-900 to-amber-800 border border-amber-600 p-3 rounded-lg mb-3">
                    <h2 class="text-white font-bold text-lg"><i class="fa-solid fa-file-import mr-2 text-amber-400"></i>資料匯入</h2>
                    <p class="text-amber-200 text-sm mt-1">從 Excel 批次匯入庫存資料</p>
                </div>

                <div class="flex gap-4 flex-1 overflow-hidden">
                    <!-- 左側：上傳區域 -->
                    <div class="w-80 glass-panel p-4 flex flex-col">
                        <h3 class="text-white font-bold mb-3 text-sm border-b border-slate-700 pb-2">
                            <i class="fa-solid fa-upload mr-1 text-amber-400"></i>步驟一：上傳 Excel
                        </h3>

                        <!-- 上傳區 -->
                        <div id="import-dropzone" class="border-2 border-dashed border-slate-600 rounded-lg p-6 text-center mb-4 hover:border-amber-500 transition-colors cursor-pointer"
                             onclick="document.getElementById('import-excel-file').click()"
                             ondrop="handleImportDrop(event)" ondragover="handleImportDragOver(event)" ondragleave="handleImportDragLeave(event)">
                            <i class="fa-solid fa-cloud-upload-alt text-4xl text-slate-500 mb-3"></i>
                            <p class="text-slate-400 text-sm">拖曳 Excel 檔案到這裡</p>
                            <p class="text-slate-500 text-xs mt-1">或點擊選擇檔案</p>
                            <input type="file" id="import-excel-file" accept=".xlsx,.xls" class="hidden" onchange="handleImportFileSelect(event)">
                        </div>

                        <!-- 下載範本 -->
                        <div class="bg-slate-800/50 rounded-lg p-3 mb-4">
                            <div class="text-xs text-slate-400 mb-2">📥 下載範本：</div>
                            <button onclick="downloadImportTemplate()" class="w-full py-2 bg-emerald-600 hover:bg-emerald-500 text-white rounded text-sm font-bold">
                                <i class="fa-solid fa-download mr-1"></i>庫存匯入範本.xlsx
                            </button>
                        </div>

                        <!-- 匯入選項 -->
                        <div class="bg-slate-800/50 rounded-lg p-3 mb-4">
                            <div class="text-xs text-slate-400 mb-2">⚙️ 匯入選項：</div>
                            <label class="flex items-center gap-2 text-sm text-white mb-2 cursor-pointer">
                                <input type="checkbox" id="import-opt-create-location" checked class="rounded">
                                <span>自動建立新儲位</span>
                            </label>
                            <label class="flex items-center gap-2 text-sm text-white mb-2 cursor-pointer">
                                <input type="checkbox" id="import-opt-create-product" checked class="rounded">
                                <span>自動建立新品項</span>
                            </label>
                            <label class="flex items-center gap-2 text-sm text-white cursor-pointer">
                                <input type="checkbox" id="import-opt-skip-duplicate" checked class="rounded">
                                <span>跳過重複資料</span>
                            </label>
                        </div>

                        <!-- 虛擬儲位說明 -->
                        <div class="bg-slate-800/50 rounded-lg p-3 text-xs">
                            <div class="text-slate-400 mb-2">📍 虛擬儲位：</div>
                            <div class="grid grid-cols-2 gap-1 text-slate-500">
                                <span>A00~D00 貨架前端</span>
                                <span>A99~D99 貨架末端</span>
                                <span>TEMP-IN 進貨暫存</span>
                                <span>TEMP-OUT 出貨暫存</span>
                            </div>
                        </div>
                    </div>

                    <!-- 右側：預覽與結果 -->
                    <div class="flex-1 glass-panel flex flex-col overflow-hidden">
                        <div class="p-3 border-b border-slate-700 flex justify-between items-center">
                            <h3 class="text-white font-bold text-sm">
                                <i class="fa-solid fa-table mr-1 text-amber-400"></i>步驟二：預覽資料
                            </h3>
                            <div class="flex gap-2 items-center">
                                <span id="import-stats" class="text-xs text-slate-400">尚未上傳檔案</span>
                                <button id="btn-execute-import" onclick="executeImport()"
                                        class="bg-amber-600 hover:bg-amber-500 text-white px-4 py-1.5 rounded text-sm font-bold disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                    <i class="fa-solid fa-database mr-1"></i>執行匯入
                                </button>
                            </div>
                        </div>

                        <!-- 預覽表格 -->
                        <div class="flex-1 overflow-auto">
                            <table class="w-full dense-table" id="import-preview-table">
                                <thead>
                                    <tr>
                                        <th class="w-8">#</th>
                                        <th class="text-center w-12">狀態</th>
                                        <th>儲位</th>
                                        <th>公司</th>
                                        <th>品號</th>
                                        <th>品名</th>
                                        <th>規格</th>
                                        <th class="text-right">數量</th>
                                        <th>單位</th>
                                        <th>批號</th>
                                        <th>效期</th>
                                    </tr>
                                </thead>
                                <tbody id="import-preview-body">
                                    <tr><td colspan="11" class="text-center text-slate-500 py-10">
                                        <i class="fa-solid fa-file-excel text-4xl text-slate-600 mb-3 block"></i>
                                        <p>請上傳 Excel 檔案</p>
                                    </td></tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- 底部統計 -->
                        <div class="p-3 border-t border-slate-700 flex justify-between items-center text-xs">
                            <div class="flex gap-4">
                                <span class="text-slate-400">總筆數：<span id="import-total" class="text-white font-bold">0</span></span>
                                <span class="text-emerald-400">✓ 有效：<span id="import-valid" class="font-bold">0</span></span>
                                <span class="text-red-400">✗ 錯誤：<span id="import-invalid" class="font-bold">0</span></span>
                                <span class="text-yellow-400">⚠ 重複：<span id="import-duplicate" class="font-bold">0</span></span>
                            </div>
                            <span class="text-slate-500">匯入後資料將新增到 Firebase</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 開發者工具頁面 -->
            <div id="view-dev-tools" class="view-panel h-full hidden flex flex-col p-4 overflow-auto">
                <div class="bg-gradient-to-r from-slate-800 to-slate-700 border border-slate-600 p-3 rounded-lg mb-4">
                    <h2 class="text-white font-bold text-lg"><i class="fa-solid fa-wrench mr-2 text-orange-400"></i>系統維護</h2>
                    <p class="text-slate-300 text-sm mt-1">備份還原與資料清除</p>
                </div>

                <!-- 左右兩欄主區塊 -->
                <div class="grid grid-cols-2 gap-4 flex-1">
                    
                    <!-- 左欄：備份與還原 -->
                    <div class="glass-panel p-4 flex flex-col">
                        <h3 class="text-white font-bold mb-4 text-base border-b border-orange-500/50 pb-2">
                            <i class="fa-solid fa-database mr-2 text-orange-400"></i>備份與還原
                        </h3>
                        
                        <!-- 狀態資訊 -->
                        <div class="grid grid-cols-2 gap-3 mb-4">
                            <div class="bg-slate-800/70 border border-slate-600 rounded-lg p-3">
                                <div class="text-slate-400 text-xs mb-1">上次備份時間</div>
                                <div class="text-white font-bold text-sm" id="dev-last-backup">從未備份</div>
                            </div>
                            <div class="bg-slate-800/70 border border-slate-600 rounded-lg p-3">
                                <div class="text-slate-400 text-xs mb-1">備份狀態</div>
                                <div class="text-emerald-400 font-bold text-sm" id="dev-backup-status">就緒</div>
                            </div>
                        </div>

                        <!-- 本地備份 -->
                        <div class="bg-slate-800/50 rounded-lg p-3 mb-3">
                            <div class="flex items-center gap-2 mb-3">
                                <i class="fa-solid fa-hard-drive text-blue-400"></i>
                                <span class="text-white font-bold text-sm">本地備份 (JSON)</span>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="performBackup()" class="py-2.5 bg-orange-600 hover:bg-orange-500 text-white rounded-lg font-bold text-sm">
                                    <i class="fa-solid fa-download mr-1"></i>備份
                                </button>
                                <div class="relative">
                                    <input type="file" id="restore-file-input" accept=".json" class="hidden" onchange="handleRestoreFile(event)">
                                    <button onclick="document.getElementById('restore-file-input').click()" class="w-full py-2.5 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-bold text-sm">
                                        <i class="fa-solid fa-upload mr-1"></i>還原
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Excel 備份 -->
                        <div class="bg-slate-800/50 rounded-lg p-3 mb-3">
                            <div class="flex items-center gap-2 mb-3">
                                <i class="fa-solid fa-file-excel text-emerald-400"></i>
                                <span class="text-white font-bold text-sm">Excel 備份</span>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="exportBackupExcel()" class="py-2.5 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg font-bold text-sm">
                                    <i class="fa-solid fa-download mr-1"></i>匯出
                                </button>
                                <div class="relative">
                                    <input type="file" id="restore-excel-input" accept=".xlsx" class="hidden" onchange="restoreFromExcel(event)">
                                    <button onclick="document.getElementById('restore-excel-input').click()" class="w-full py-2.5 bg-teal-600 hover:bg-teal-500 text-white rounded-lg font-bold text-sm">
                                        <i class="fa-solid fa-upload mr-1"></i>匯入
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- 雲端備份 -->
                        <div class="bg-slate-800/50 rounded-lg p-3">
                            <div class="flex items-center gap-2 mb-3">
                                <i class="fa-solid fa-cloud text-cyan-400"></i>
                                <span class="text-white font-bold text-sm">雲端備份 (Firebase)</span>
                            </div>
                            <div class="grid grid-cols-2 gap-2 mb-2">
                                <button onclick="exportBackupToFirebase()" class="py-2.5 bg-cyan-600 hover:bg-cyan-500 text-white rounded-lg font-bold text-sm">
                                    <i class="fa-solid fa-cloud-arrow-up mr-1"></i>上傳
                                </button>
                                <button onclick="showCloudBackupList()" class="py-2.5 bg-slate-600 hover:bg-slate-500 text-white rounded-lg font-bold text-sm">
                                    <i class="fa-solid fa-list mr-1"></i>列表
                                </button>
                            </div>
                            <div id="cloud-backup-list" class="hidden"></div>
                        </div>

                        <!-- 彈性填充 -->
                        <div class="flex-1"></div>

                        <!-- 系統資訊 -->
                        <div class="bg-slate-800/30 rounded-lg p-3 mt-3 border border-slate-700">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-slate-400 text-xs"><i class="fa-solid fa-info-circle mr-1"></i>系統資訊</span>
                                <button onclick="refreshDevToolsStats()" class="text-cyan-400 hover:text-cyan-300 text-xs">
                                    <i class="fa-solid fa-refresh mr-1"></i>重整
                                </button>
                            </div>
                            <div class="grid grid-cols-2 gap-2 text-xs">
                                <div class="flex justify-between"><span class="text-slate-500">雲端庫存</span><span class="text-white font-bold" id="dev-cloud-inv-count">-</span></div>
                                <div class="flex justify-between"><span class="text-slate-500">雲端任務</span><span class="text-white font-bold" id="dev-cloud-task-count">-</span></div>
                            </div>
                        </div>
                    </div>

                    <!-- 右欄：資料清除 -->
                    <div class="glass-panel p-4 flex flex-col border border-red-900/50">
                        <h3 class="text-white font-bold mb-4 text-base border-b border-red-500/50 pb-2">
                            <i class="fa-solid fa-triangle-exclamation mr-2 text-red-400"></i>資料清除
                        </h3>
                        <p class="text-red-300/70 text-xs mb-4">⚠️ 以下操作將永久刪除資料，無法復原！</p>

                        <!-- 雲端資料清除 -->
                        <div class="bg-red-900/20 rounded-lg p-3 mb-3 border border-red-800/50">
                            <div class="flex items-center gap-2 mb-3">
                                <i class="fa-solid fa-cloud text-red-400"></i>
                                <span class="text-white font-bold text-sm">雲端資料 (Firebase)</span>
                            </div>
                            <div class="space-y-2">
                                <button onclick="clearFirebaseCollection('inboundTasks')" class="w-full py-2 bg-slate-700 hover:bg-red-600 text-white rounded text-sm transition-colors">
                                    <i class="fa-solid fa-arrow-down mr-1"></i>清除入庫任務
                                </button>
                                <button onclick="clearFirebaseCollection('dispatchOrders')" class="w-full py-2 bg-slate-700 hover:bg-red-600 text-white rounded text-sm transition-colors">
                                    <i class="fa-solid fa-clipboard-list mr-1"></i>清除調度工單
                                </button>
                                <button onclick="clearFirebaseCollection('waves')" class="w-full py-2 bg-slate-700 hover:bg-red-600 text-white rounded text-sm transition-colors">
                                    <i class="fa-solid fa-layer-group mr-1"></i>清除波次資料
                                </button>
                                <button onclick="clearFirebaseCollection('pendingInbound')" class="w-full py-2 bg-slate-700 hover:bg-red-600 text-white rounded text-sm transition-colors">
                                    <i class="fa-solid fa-inbox mr-1"></i>清除待入庫工單
                                </button>
                                <button onclick="clearFirebaseCollection('inventoryLogs')" class="w-full py-2 bg-slate-700 hover:bg-red-600 text-white rounded text-sm transition-colors">
                                    <i class="fa-solid fa-clock-rotate-left mr-1"></i>清除庫存異動紀錄
                                </button>
                            </div>
                            <div class="border-t border-red-700/50 pt-3 mt-3">
                                <button onclick="clearFirebaseCollection('pallets')" class="w-full py-2.5 bg-red-700 hover:bg-red-600 text-white rounded font-bold text-sm">
                                    <i class="fa-solid fa-pallet mr-1"></i>清除所有庫存資料
                                </button>
                            </div>
                        </div>

                        <!-- 本地資料清除 -->
                        <div class="bg-slate-800/50 rounded-lg p-3">
                            <div class="flex items-center gap-2 mb-3">
                                <i class="fa-solid fa-hard-drive text-slate-400"></i>
                                <span class="text-white font-bold text-sm">本地資料 (localStorage)</span>
                            </div>
                            <div class="space-y-2">
                                <button onclick="clearLocalStorageItem('wms_dispatch_orders')" class="w-full py-2 bg-slate-700 hover:bg-slate-600 text-white rounded text-sm">
                                    <i class="fa-solid fa-clipboard-list mr-1"></i>清除任務清單
                                </button>
                                <button onclick="clearLocalStorageItem('wms_waves')" class="w-full py-2 bg-slate-700 hover:bg-slate-600 text-white rounded text-sm">
                                    <i class="fa-solid fa-layer-group mr-1"></i>清除波次資料
                                </button>
                                <button onclick="clearLocalStorageItem('wms_shipping_orders')" class="w-full py-2 bg-slate-700 hover:bg-slate-600 text-white rounded text-sm">
                                    <i class="fa-solid fa-truck mr-1"></i>清除出貨訂單
                                </button>
                            </div>
                            <div class="border-t border-slate-600 pt-3 mt-3">
                                <button onclick="clearAllLocalStorage()" class="w-full py-2.5 bg-slate-600 hover:bg-red-600 text-white rounded font-bold text-sm transition-colors">
                                    <i class="fa-solid fa-trash mr-1"></i>清除所有本地資料
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 寄倉管理頁面 -->
            <div id="view-consignment" class="view-panel h-full hidden flex flex-col p-4">
                <div class="bg-gradient-to-r from-amber-900 to-orange-900 border border-amber-600 p-3 rounded-lg mb-3">
                    <div class="flex justify-between items-center">
                        <!-- 左側：標題 -->
                        <div>
                            <h2 class="text-white font-bold text-lg"><i class="fa-solid fa-box-archive mr-2 text-amber-400"></i>寄倉管理</h2>
                        </div>
                        <!-- 右側：統計資訊 -->
                        <div class="flex items-center gap-2 text-sm">
                            <div class="flex items-center gap-1.5 px-3 py-1.5 bg-slate-900/80 rounded-lg border border-emerald-500/50">
                                <span class="text-emerald-300 text-xs">免費期</span>
                                <span class="text-emerald-400 font-bold text-lg" id="consign-free-count">0</span>
                            </div>
                            <div class="flex items-center gap-1.5 px-3 py-1.5 bg-slate-900/80 rounded-lg border border-blue-500/50">
                                <span class="text-blue-300 text-xs">計費中</span>
                                <span class="text-blue-400 font-bold text-lg" id="consign-charging-count">0</span>
                            </div>
                            <div class="flex items-center gap-1.5 px-3 py-1.5 bg-slate-900/80 rounded-lg border border-orange-500/50">
                                <span class="text-orange-300 text-xs">本月到期</span>
                                <span class="text-orange-400 font-bold text-lg" id="consign-expiring-count">0</span>
                            </div>
                            <div class="flex items-center gap-1.5 px-3 py-1.5 bg-slate-900/80 rounded-lg border border-purple-500/50">
                                <span class="text-purple-300 text-xs">寄倉</span>
                                <span class="text-purple-400 font-bold text-lg" id="consign-total-units">0</span>
                                <span class="text-purple-300 text-xs">件</span>
                            </div>
                            <div class="flex items-center gap-1.5 px-3 py-1.5 bg-slate-900/80 rounded-lg border border-yellow-500/50">
                                <span class="text-yellow-300 text-xs">累計</span>
                                <span class="text-yellow-400 font-bold text-lg" id="consign-total-rent">$0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 篩選列 -->
                <div class="flex gap-2 mb-3 items-center">
                    <select id="consign-status-filter" class="scan-input w-32" onchange="filterConsignments()">
                        <option value="all">全部狀態</option>
                        <option value="free">免費期內</option>
                        <option value="charging">計費中</option>
                        <option value="completed">已結清</option>
                    </select>
                    <select id="consign-source-filter" class="scan-input w-28" onchange="filterConsignments()">
                        <option value="all">全部來源</option>
                        <option value="internal">內倉</option>
                        <option value="external">外倉</option>
                    </select>
                    <input type="text" id="consign-search" class="scan-input w-48" placeholder="搜尋客戶/品名..." oninput="filterConsignments()">
                    <div class="flex-1"></div>
                    <button onclick="if(typeof window.openNewConsignmentModal === 'function') window.openNewConsignmentModal(); else alert('功能載入中，請稍後再試');" class="px-4 py-1.5 bg-amber-600 hover:bg-amber-500 text-white rounded text-sm font-bold">
                        <i class="fa-solid fa-plus mr-1"></i>新增寄倉
                    </button>
                    <button onclick="if(typeof window.exportConsignments === 'function') window.exportConsignments(); else alert('功能載入中');" class="px-3 py-1.5 bg-emerald-600 hover:bg-emerald-500 text-white rounded text-sm">
                        <i class="fa-solid fa-file-excel mr-1"></i>匯出
                    </button>
                </div>

                <!-- 寄倉清單 -->
                <div class="glass-panel flex-1 overflow-auto">
                    <table class="w-full dense-table">
                        <thead>
                            <tr>
                                <th>來源倉庫</th>
                                <th>寄庫倉</th>
                                <th>客戶</th>
                                <th>品名</th>
                                <th>批號</th>
                                <th class="text-right">原始</th>
                                <th class="text-right">剩餘</th>
                                <th>免費截止</th>
                                <th class="text-right">天數</th>
                                <th class="text-right">租金</th>
                                <th>狀態</th>
                                <th class="text-center">操作</th>
                            </tr>
                        </thead>
                        <tbody id="consignment-list">
                            <tr><td colspan="12" class="text-center text-slate-500 py-10">尚無寄倉資料</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 倉租報表頁面 -->
            <div id="view-rental-report" class="view-panel h-full hidden flex flex-col p-4">
                <div class="bg-gradient-to-r from-emerald-900 to-teal-900 border border-emerald-600 p-3 rounded-lg mb-3">
                    <div class="flex justify-between items-center">
                        <div>
                            <h2 class="text-white font-bold text-lg"><i class="fa-solid fa-file-invoice-dollar mr-2 text-emerald-400"></i>倉租報表</h2>
                            <p class="text-emerald-200 text-sm">自有庫存成本、客戶寄倉帳單</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-slate-300 text-sm">計費月份：</span>
                            <input type="month" id="rental-month" class="scan-input w-40" onchange="loadRentalReport()">
                            <button onclick="generateMonthlyBill()" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg font-bold">
                                <i class="fa-solid fa-file-invoice mr-1"></i>產生帳單
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 報表內容 -->
                <div class="grid grid-cols-2 gap-4 flex-1 min-h-0">
                    <!-- 左側：自有庫存 -->
                    <div class="glass-panel p-4 flex flex-col overflow-hidden">
                        <div class="flex items-center justify-between mb-3 pb-2 border-b border-slate-700">
                            <h3 class="text-white font-bold">
                                <i class="fa-solid fa-warehouse mr-2 text-blue-400"></i>自有庫存倉租（帳面）
                            </h3>
                            <span class="text-xs text-slate-400">不收費，僅供成本參考</span>
                        </div>
                        <div class="flex-1 overflow-y-auto">
                            <table class="w-full text-sm">
                                <thead>
                                    <tr class="text-slate-400 border-b border-slate-700">
                                        <th class="text-left p-2">公司</th>
                                        <th class="text-right p-2">平均板數</th>
                                        <th class="text-right p-2">板天數</th>
                                        <th class="text-right p-2">倉租金額</th>
                                    </tr>
                                </thead>
                                <tbody id="own-stock-rental-body">
                                    <tr><td colspan="4" class="text-center text-slate-500 py-6">選擇月份後載入</td></tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-3 pt-3 border-t border-slate-700 flex justify-between items-center">
                            <span class="text-slate-400 text-sm">自有庫存合計</span>
                            <span class="text-xl font-bold text-blue-400" id="own-stock-total">$0</span>
                        </div>
                    </div>

                    <!-- 右側：客戶寄倉 -->
                    <div class="glass-panel p-4 flex flex-col overflow-hidden">
                        <div class="flex items-center justify-between mb-3 pb-2 border-b border-slate-700">
                            <h3 class="text-white font-bold">
                                <i class="fa-solid fa-users mr-2 text-amber-400"></i>客戶寄倉帳單（應收）
                            </h3>
                            <span class="text-xs text-emerald-400 font-bold">點擊展開明細</span>
                        </div>
                        <div class="flex-1 overflow-y-auto" id="consign-rental-detail">
                            <div class="text-center text-slate-500 py-6">載入中...</div>
                        </div>
                        <div class="mt-3 pt-3 border-t border-slate-700 flex justify-between items-center">
                            <span class="text-slate-400 text-sm">客戶寄倉合計</span>
                            <span class="text-xl font-bold text-amber-400" id="consign-total">$0</span>
                        </div>
                    </div>
                </div>

                <!-- 底部：理貨費用 + 總計 -->
                <div class="grid grid-cols-3 gap-4 mt-3">
                    <div class="glass-panel p-4">
                        <h4 class="text-white font-bold text-sm mb-2"><i class="fa-solid fa-dolly mr-1 text-purple-400"></i>理貨費用</h4>
                        <div class="flex justify-between text-sm">
                            <span class="text-slate-400">本月入庫</span>
                            <span class="text-white"><span id="handling-inbound-count">0</span> 板 × 200 = <span class="text-purple-400 font-bold" id="handling-inbound-fee">$0</span></span>
                        </div>
                    </div>
                    <div class="glass-panel p-4">
                        <h4 class="text-white font-bold text-sm mb-2"><i class="fa-solid fa-clock mr-1 text-orange-400"></i>暫存區超時</h4>
                        <div class="flex justify-between text-sm">
                            <span class="text-slate-400">超時費用</span>
                            <span class="text-orange-400 font-bold" id="temp-overtime-fee">$0</span>
                        </div>
                    </div>
                    <div class="glass-panel p-4 bg-gradient-to-r from-emerald-900/50 to-teal-900/50">
                        <h4 class="text-white font-bold text-sm mb-2"><i class="fa-solid fa-calculator mr-1 text-emerald-400"></i>本月應收總計</h4>
                        <div class="text-2xl font-bold text-emerald-400" id="monthly-total">$0</div>
                    </div>
                </div>
            </div>

            <!-- 費率設定頁面 -->
            <div id="view-rental-settings" class="view-panel h-full hidden flex flex-col p-4">
                <div class="bg-gradient-to-r from-blue-900 to-indigo-900 border border-blue-600 p-3 rounded-lg mb-4">
                    <h2 class="text-white font-bold text-lg"><i class="fa-solid fa-sliders mr-2 text-blue-400"></i>費率設定</h2>
                    <p class="text-blue-200 text-sm">倉租費率、理貨費用、收費開關設定</p>
                </div>

                <div class="grid grid-cols-2 gap-4 flex-1 min-h-0 overflow-y-auto">
                    <!-- 左側：收費開關 + 倉租費率 -->
                    <div class="space-y-4">
                        <!-- 收費開關 -->
                        <div class="glass-panel p-4">
                            <h3 class="text-white font-bold text-sm mb-3 pb-2 border-b border-slate-700">
                                <i class="fa-solid fa-toggle-on mr-2 text-emerald-400"></i>自有庫存收費開關
                            </h3>
                            <div class="space-y-3">
                                <div class="flex items-center justify-between">
                                    <span class="text-white">崇文自有庫存</span>
                                    <div class="flex items-center gap-2">
                                        <label class="flex items-center gap-1 cursor-pointer">
                                            <input type="radio" name="charge-cw" value="no" checked class="w-4 h-4" onchange="updateRentalSettings()">
                                            <span class="text-slate-400 text-sm">不收費</span>
                                        </label>
                                        <label class="flex items-center gap-1 cursor-pointer">
                                            <input type="radio" name="charge-cw" value="yes" class="w-4 h-4" onchange="updateRentalSettings()">
                                            <span class="text-emerald-400 text-sm">收費</span>
                                        </label>
                                    </div>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-white">八方自有庫存</span>
                                    <div class="flex items-center gap-2">
                                        <label class="flex items-center gap-1 cursor-pointer">
                                            <input type="radio" name="charge-bf" value="no" checked class="w-4 h-4" onchange="updateRentalSettings()">
                                            <span class="text-slate-400 text-sm">不收費</span>
                                        </label>
                                        <label class="flex items-center gap-1 cursor-pointer">
                                            <input type="radio" name="charge-bf" value="yes" class="w-4 h-4" onchange="updateRentalSettings()">
                                            <span class="text-emerald-400 text-sm">收費</span>
                                        </label>
                                    </div>
                                </div>
                                <div class="pt-2 border-t border-slate-700">
                                    <div class="flex items-center justify-between">
                                        <span class="text-slate-400 text-sm">收費生效日期</span>
                                        <input type="date" id="charge-effective-date" class="scan-input w-40 py-1" onchange="updateRentalSettings()">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 倉租費率 -->
                        <div class="glass-panel p-4">
                            <h3 class="text-white font-bold text-sm mb-3 pb-2 border-b border-slate-700">
                                <i class="fa-solid fa-warehouse mr-2 text-blue-400"></i>倉租費率（板/天）
                            </h3>
                            <div class="space-y-3">
                                <div class="bg-slate-800 p-3 rounded-lg">
                                    <div class="text-cyan-400 font-bold text-sm mb-2">八方費率</div>
                                    <div class="flex items-center gap-2">
                                        <span class="text-slate-400 text-sm">一般費率：</span>
                                        <input type="number" id="rate-bf-normal" class="scan-input w-20 py-1 text-center" value="22" onchange="updateRentalSettings()">
                                        <span class="text-slate-400 text-sm">元/板/天</span>
                                    </div>
                                </div>
                                <div class="bg-slate-800 p-3 rounded-lg">
                                    <div class="text-emerald-400 font-bold text-sm mb-2">崇文費率（階梯/全額制）</div>
                                    <div class="space-y-2">
                                        <div class="flex items-center gap-2">
                                            <span class="text-slate-400 text-sm">1 ~</span>
                                            <input type="number" id="rate-cw-tier1-max" class="scan-input w-16 py-1 text-center" value="300" onchange="updateRentalSettings()">
                                            <span class="text-slate-400 text-sm">板：</span>
                                            <input type="number" id="rate-cw-tier1" class="scan-input w-16 py-1 text-center" value="22" onchange="updateRentalSettings()">
                                            <span class="text-slate-400 text-sm">元</span>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <span class="text-slate-400 text-sm">超過以上：</span>
                                            <input type="number" id="rate-cw-tier2" class="scan-input w-16 py-1 text-center" value="20" onchange="updateRentalSettings()">
                                            <span class="text-slate-400 text-sm">元（全額適用）</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 右側：理貨費用 + 暫存區 + 結算 -->
                    <div class="space-y-4">
                        <!-- 理貨費用 -->
                        <div class="glass-panel p-4">
                            <h3 class="text-white font-bold text-sm mb-3 pb-2 border-b border-slate-700">
                                <i class="fa-solid fa-dolly mr-2 text-purple-400"></i>理貨費用
                            </h3>
                            <div class="space-y-3">
                                <div class="flex items-center justify-between">
                                    <span class="text-white">入庫費</span>
                                    <div class="flex items-center gap-2">
                                        <input type="number" id="fee-inbound" class="scan-input w-20 py-1 text-center" value="200" onchange="updateRentalSettings()">
                                        <span class="text-slate-400 text-sm">元/板</span>
                                    </div>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-white">出庫費</span>
                                    <div class="flex items-center gap-2">
                                        <input type="number" id="fee-outbound" class="scan-input w-20 py-1 text-center" value="0" onchange="updateRentalSettings()">
                                        <span class="text-slate-400 text-sm">元/板</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 暫存區設定 -->
                        <div class="glass-panel p-4">
                            <h3 class="text-white font-bold text-sm mb-3 pb-2 border-b border-slate-700">
                                <i class="fa-solid fa-clock mr-2 text-orange-400"></i>暫存區設定
                            </h3>
                            <div class="flex items-center justify-between">
                                <span class="text-white">免費時數</span>
                                <div class="flex items-center gap-2">
                                    <input type="number" id="temp-free-hours" class="scan-input w-20 py-1 text-center" value="4" onchange="updateRentalSettings()">
                                    <span class="text-slate-400 text-sm">小時</span>
                                </div>
                            </div>
                            <div class="mt-2 text-xs text-slate-500">
                                超過免費時數後，按一般倉租費率計算
                            </div>
                        </div>

                        <!-- 結算設定 -->
                        <div class="glass-panel p-4">
                            <h3 class="text-white font-bold text-sm mb-3 pb-2 border-b border-slate-700">
                                <i class="fa-solid fa-calendar-check mr-2 text-emerald-400"></i>結算設定
                            </h3>
                            <div class="space-y-3">
                                <div class="flex items-center justify-between">
                                    <span class="text-white">每月結算日</span>
                                    <div class="flex items-center gap-2">
                                        <input type="number" id="settle-day" class="scan-input w-16 py-1 text-center" value="25" min="1" max="28" onchange="updateRentalSettings()">
                                        <span class="text-slate-400 text-sm">號</span>
                                    </div>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-white">寄倉免費截止</span>
                                    <div class="flex items-center gap-2">
                                        <span class="text-slate-400 text-sm">預設至當月</span>
                                        <input type="number" id="free-until-day" class="scan-input w-16 py-1 text-center" value="25" min="1" max="28" onchange="updateRentalSettings()">
                                        <span class="text-slate-400 text-sm">號</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 儲存按鈕 -->
                        <button onclick="saveRentalSettings()" class="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-bold">
                            <i class="fa-solid fa-save mr-2"></i>儲存設定
                        </button>
                    </div>
                </div>
            </div>

            <!-- 效期管理頁面 -->
            <div id="view-expiry-management" class="view-panel h-full hidden flex flex-col p-4">
                <!-- 頂部標題 -->
                <div class="flex items-center justify-between bg-gradient-to-r from-red-900 to-orange-900 border border-red-600 p-4 rounded-xl mb-4">
                    <div>
                        <h2 class="text-white font-bold text-2xl"><i class="fa-solid fa-calendar-xmark mr-2 text-red-400"></i>效期管理</h2>
                        <p class="text-red-200 text-sm mt-1">監控庫存效期狀態，管理即期品與過期品</p>
                    </div>
                    <div class="flex gap-2 items-center">
                        <span class="text-slate-300 text-sm">即期天數：</span>
                        <select id="expiry-days-setting" class="scan-input w-24" onchange="saveExpirySettings(); refreshExpiryReport();">
                            <option value="30">30天</option>
                            <option value="60">60天</option>
                            <option value="90" selected>90天</option>
                            <option value="120">120天</option>
                            <option value="180">180天</option>
                        </select>
                        <button onclick="refreshExpiryReport()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg font-bold">
                            <i class="fa-solid fa-sync mr-2"></i>重新整理
                        </button>
                        <button onclick="printExpiryReport()" class="bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded-lg font-bold">
                            <i class="fa-solid fa-print mr-2"></i>列印報表
                        </button>
                    </div>
                </div>

                <!-- 效期統計卡片 -->
                <div class="grid grid-cols-5 gap-3 mb-4">
                    <div class="bg-gradient-to-br from-red-900/50 to-red-800/30 border border-red-600/50 rounded-xl p-4 text-center">
                        <div class="text-red-400 text-sm mb-1"><i class="fa-solid fa-skull-crossbones mr-1"></i>已過期</div>
                        <div class="text-3xl font-black text-red-400" id="expiry-stat-expired">0</div>
                        <div class="text-xs text-red-300 mt-1" id="expiry-stat-expired-qty">0 件</div>
                    </div>
                    <div class="bg-gradient-to-br from-orange-900/50 to-orange-800/30 border border-orange-600/50 rounded-xl p-4 text-center">
                        <div class="text-orange-400 text-sm mb-1"><i class="fa-solid fa-triangle-exclamation mr-1"></i>7天內到期</div>
                        <div class="text-3xl font-black text-orange-400" id="expiry-stat-7days">0</div>
                        <div class="text-xs text-orange-300 mt-1" id="expiry-stat-7days-qty">0 件</div>
                    </div>
                    <div class="bg-gradient-to-br from-yellow-900/50 to-yellow-800/30 border border-yellow-600/50 rounded-xl p-4 text-center">
                        <div class="text-yellow-400 text-sm mb-1"><i class="fa-solid fa-clock mr-1"></i>30天內到期</div>
                        <div class="text-3xl font-black text-yellow-400" id="expiry-stat-30days">0</div>
                        <div class="text-xs text-yellow-300 mt-1" id="expiry-stat-30days-qty">0 件</div>
                    </div>
                    <div class="bg-gradient-to-br from-cyan-900/50 to-cyan-800/30 border border-cyan-600/50 rounded-xl p-4 text-center">
                        <div class="text-cyan-400 text-sm mb-1"><i class="fa-solid fa-hourglass-half mr-1"></i>即期品</div>
                        <div class="text-3xl font-black text-cyan-400" id="expiry-stat-soon">0</div>
                        <div class="text-xs text-cyan-300 mt-1" id="expiry-stat-soon-qty">0 件</div>
                    </div>
                    <div class="bg-gradient-to-br from-emerald-900/50 to-emerald-800/30 border border-emerald-600/50 rounded-xl p-4 text-center">
                        <div class="text-emerald-400 text-sm mb-1"><i class="fa-solid fa-check-circle mr-1"></i>效期正常</div>
                        <div class="text-3xl font-black text-emerald-400" id="expiry-stat-normal">0</div>
                        <div class="text-xs text-emerald-300 mt-1" id="expiry-stat-normal-qty">0 件</div>
                    </div>
                </div>

                <!-- 篩選條件 -->
                <div class="flex gap-2 mb-3">
                    <button onclick="filterExpiryReport('all')" class="expiry-filter-btn active bg-slate-700 text-white px-4 py-2 rounded-lg text-sm font-bold" data-filter="all">
                        <i class="fa-solid fa-list mr-1"></i>全部
                    </button>
                    <button onclick="filterExpiryReport('expired')" class="expiry-filter-btn bg-slate-800 text-slate-400 px-4 py-2 rounded-lg text-sm font-bold" data-filter="expired">
                        <i class="fa-solid fa-skull-crossbones mr-1"></i>已過期
                    </button>
                    <button onclick="filterExpiryReport('7days')" class="expiry-filter-btn bg-slate-800 text-slate-400 px-4 py-2 rounded-lg text-sm font-bold" data-filter="7days">
                        <i class="fa-solid fa-triangle-exclamation mr-1"></i>7天內
                    </button>
                    <button onclick="filterExpiryReport('30days')" class="expiry-filter-btn bg-slate-800 text-slate-400 px-4 py-2 rounded-lg text-sm font-bold" data-filter="30days">
                        <i class="fa-solid fa-clock mr-1"></i>30天內
                    </button>
                    <button onclick="filterExpiryReport('soon')" class="expiry-filter-btn bg-slate-800 text-slate-400 px-4 py-2 rounded-lg text-sm font-bold" data-filter="soon">
                        <i class="fa-solid fa-hourglass-half mr-1"></i>即期品
                    </button>
                    <div class="flex-1"></div>
                    <input type="text" id="expiry-search" class="scan-input w-64" placeholder="搜尋品名..." oninput="filterExpiryBySearch()">
                </div>

                <!-- 效期清單 -->
                <div class="flex-1 bg-slate-800/50 border border-slate-700 rounded-xl overflow-hidden">
                    <div class="overflow-auto h-full">
                        <table class="w-full dense-table">
                            <thead>
                                <tr class="bg-slate-900">
                                    <th class="p-3 text-left w-24">狀態</th>
                                    <th class="p-3 text-left">品名</th>
                                    <th class="p-3 text-left">規格</th>
                                    <th class="p-3 text-left">批號</th>
                                    <th class="p-3 text-left">儲位</th>
                                    <th class="p-3 text-right">數量</th>
                                    <th class="p-3 text-left">效期</th>
                                    <th class="p-3 text-left">剩餘天數</th>
                                    <th class="p-3 text-center">操作</th>
                                </tr>
                            </thead>
                            <tbody id="expiry-table-body">
                                <tr><td colspan="9" class="text-center text-slate-500 py-8">載入中...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 庫存異動查詢頁面 -->
            <div id="view-inventory-log" class="view-panel h-full hidden flex flex-col p-4">
                <!-- 頂部標題（整合統計） -->
                <div class="bg-gradient-to-r from-purple-900 to-indigo-900 border border-purple-600 p-4 rounded-xl mb-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-6">
                            <div>
                                <h2 class="text-white font-bold text-xl"><i class="fa-solid fa-clock-rotate-left mr-2 text-purple-400"></i>庫存異動查詢</h2>
                                <p class="text-purple-200 text-xs mt-1">查詢品項的入庫、出庫、移位等歷史記錄</p>
                            </div>
                            <!-- 統計數據整合在標題列 -->
                            <div class="flex gap-4 ml-4 pl-4 border-l border-purple-500/50" id="log-summary">
                                <div class="text-center">
                                    <div class="text-lg font-bold text-white" id="log-stat-total">0</div>
                                    <div class="text-[10px] text-purple-300">總筆數</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-lg font-bold text-emerald-400" id="log-stat-inbound">0</div>
                                    <div class="text-[10px] text-purple-300">入庫</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-lg font-bold text-red-400" id="log-stat-outbound">0</div>
                                    <div class="text-[10px] text-purple-300">出庫</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-lg font-bold text-blue-400" id="log-stat-move">0</div>
                                    <div class="text-[10px] text-purple-300">移位</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-lg font-bold text-yellow-400" id="log-stat-other">0</div>
                                    <div class="text-[10px] text-purple-300">其他</div>
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="rebuildHistoryLogs()" class="bg-orange-600 hover:bg-orange-500 text-white px-3 py-2 rounded-lg font-bold text-sm">
                                <i class="fa-solid fa-database mr-1"></i>補建記錄
                            </button>
                            <button onclick="exportInventoryLog()" class="bg-emerald-600 hover:bg-emerald-500 text-white px-3 py-2 rounded-lg font-bold text-sm">
                                <i class="fa-solid fa-file-excel mr-1"></i>匯出
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 查詢條件（精簡版） -->
                <div class="bg-slate-800 border border-slate-700 rounded-xl p-3 mb-3">
                    <div class="flex gap-3 items-end">
                        <!-- 日期範圍 -->
                        <div class="flex-1">
                            <label class="text-slate-400 text-xs mb-1 block">日期範圍</label>
                            <div class="flex gap-2 items-center">
                                <input type="date" id="log-date-from" class="scan-input flex-1 text-sm py-1.5" />
                                <span class="text-slate-500">~</span>
                                <input type="date" id="log-date-to" class="scan-input flex-1 text-sm py-1.5" />
                            </div>
                        </div>

                        <!-- 品項名稱 -->
                        <div class="w-36">
                            <label class="text-slate-400 text-xs mb-1 block">品項名稱</label>
                            <input type="text" id="log-product-name" class="scan-input w-full text-sm py-1.5" placeholder="品名..." />
                        </div>

                        <!-- 儲位 -->
                        <div class="w-28">
                            <label class="text-slate-400 text-xs mb-1 block">儲位</label>
                            <input type="text" id="log-location" class="scan-input w-full text-sm py-1.5" placeholder="I-A-01" />
                        </div>

                        <!-- 異動類型 -->
                        <div class="w-28">
                            <label class="text-slate-400 text-xs mb-1 block">類型</label>
                            <select id="log-type" class="scan-input w-full text-sm py-1.5">
                                <option value="">全部</option>
                                <option value="inbound">入庫</option>
                                <option value="outbound">出庫</option>
                                <option value="picking">領用</option>
                                <option value="move">移位</option>
                                <option value="merge">合併</option>
                                <option value="transfer">調撥</option>
                                <option value="adjust">盤點調整</option>
                            </select>
                        </div>

                        <!-- 查詢按鈕 -->
                        <button onclick="searchInventoryLog()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-1.5 rounded-lg font-bold text-sm">
                            <i class="fa-solid fa-search mr-1"></i>查詢
                        </button>

                        <!-- 快速篩選 -->
                        <div class="flex gap-1 border-l border-slate-600 pl-3">
                            <button onclick="setLogDateRange('today')" class="text-xs px-2 py-1.5 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded">今天</button>
                            <button onclick="setLogDateRange('week')" class="text-xs px-2 py-1.5 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded">7天</button>
                            <button onclick="setLogDateRange('month')" class="text-xs px-2 py-1.5 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded">30天</button>
                            <button onclick="setLogDateRange('all')" class="text-xs px-2 py-1.5 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded">全部</button>
                        </div>
                    </div>
                </div>

                <!-- 查詢結果表格 -->
                <div class="flex-1 bg-slate-800 border border-slate-700 rounded-xl overflow-hidden flex flex-col">
                    <div class="flex-1 overflow-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-slate-700 sticky top-0">
                                <tr>
                                    <th class="text-left p-3 text-slate-300 font-medium">日期時間</th>
                                    <th class="text-left p-3 text-slate-300 font-medium">公司</th>
                                    <th class="text-left p-3 text-slate-300 font-medium">類型</th>
                                    <th class="text-left p-3 text-slate-300 font-medium">品項</th>
                                    <th class="text-left p-3 text-slate-300 font-medium">規格</th>
                                    <th class="text-right p-3 text-slate-300 font-medium">數量</th>
                                    <th class="text-right p-3 text-slate-300 font-medium">重量</th>
                                    <th class="text-left p-3 text-slate-300 font-medium">儲位</th>
                                    <th class="text-left p-3 text-slate-300 font-medium">批號</th>
                                    <th class="text-left p-3 text-slate-300 font-medium">備註</th>
                                </tr>
                            </thead>
                            <tbody id="inventory-log-list">
                                <tr><td colspan="10" class="text-center text-slate-500 py-16">
                                    <i class="fa-solid fa-search text-4xl mb-3 opacity-30"></i>
                                    <p>請設定查詢條件後點擊「查詢」</p>
                                </td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="p-3 border-t border-slate-700 flex justify-between items-center text-sm bg-slate-800">
                        <span class="text-slate-400">查詢結果：<span id="log-result-count" class="text-white font-bold">0</span> 筆</span>
                        <div class="flex gap-2" id="log-pagination"></div>
                    </div>
                </div>
            </div>

            <!-- 品項出貨分析頁面 -->
            <div id="view-product-analysis" class="view-panel h-full hidden flex flex-col p-4">
                <!-- 頂部標題 -->
                <div class="flex items-center justify-between bg-gradient-to-r from-orange-900 to-red-900 border border-orange-600 p-4 rounded-xl mb-4">
                    <div>
                        <h2 class="text-white font-bold text-2xl"><i class="fa-solid fa-chart-bar mr-2 text-orange-400"></i>品項出貨分析</h2>
                        <p class="text-orange-200 text-sm mt-1">分析各品項的出貨頻率與數量排行</p>
                    </div>
                    <button onclick="refreshProductAnalysis()" class="bg-orange-600 hover:bg-orange-500 text-white px-5 py-3 rounded-lg font-bold">
                        <i class="fa-solid fa-sync mr-2"></i>重新分析
                    </button>
                </div>

                <!-- 查詢條件 -->
                <div class="bg-slate-800 border border-slate-700 rounded-xl p-4 mb-4">
                    <div class="flex gap-4 items-end">
                        <div>
                            <label class="text-slate-400 text-xs mb-1 block">分析期間</label>
                            <div class="flex gap-2 items-center">
                                <input type="date" id="analysis-date-from" class="scan-input" />
                                <span class="text-slate-500">~</span>
                                <input type="date" id="analysis-date-to" class="scan-input" />
                            </div>
                        </div>
                        <div>
                            <label class="text-slate-400 text-xs mb-1 block">排序依據</label>
                            <select id="analysis-sort" class="scan-input">
                                <option value="count">出貨次數</option>
                                <option value="qty">出貨數量</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-slate-400 text-xs mb-1 block">顯示筆數</label>
                            <select id="analysis-limit" class="scan-input">
                                <option value="10">Top 10</option>
                                <option value="20">Top 20</option>
                                <option value="50">Top 50</option>
                                <option value="100">全部</option>
                            </select>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="setAnalysisDateRange('week')" class="text-xs px-3 py-2 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded">近7天</button>
                            <button onclick="setAnalysisDateRange('month')" class="text-xs px-3 py-2 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded">近30天</button>
                            <button onclick="setAnalysisDateRange('quarter')" class="text-xs px-3 py-2 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded">近3個月</button>
                        </div>
                    </div>
                </div>

                <!-- 統計摘要 -->
                <div class="grid grid-cols-4 gap-3 mb-4">
                    <div class="bg-slate-800 border border-slate-700 rounded-lg p-4 text-center">
                        <div class="text-3xl font-bold text-white" id="pa-stat-products">0</div>
                        <div class="text-xs text-slate-400 mt-1">出貨品項數</div>
                    </div>
                    <div class="bg-emerald-900/30 border border-emerald-600/50 rounded-lg p-4 text-center">
                        <div class="text-3xl font-bold text-emerald-400" id="pa-stat-total-count">0</div>
                        <div class="text-xs text-slate-400 mt-1">總出貨次數</div>
                    </div>
                    <div class="bg-blue-900/30 border border-blue-600/50 rounded-lg p-4 text-center">
                        <div class="text-3xl font-bold text-blue-400" id="pa-stat-total-qty">0</div>
                        <div class="text-xs text-slate-400 mt-1">總出貨數量</div>
                    </div>
                    <div class="bg-purple-900/30 border border-purple-600/50 rounded-lg p-4 text-center">
                        <div class="text-3xl font-bold text-purple-400" id="pa-stat-avg">0</div>
                        <div class="text-xs text-slate-400 mt-1">平均每次出貨</div>
                    </div>
                </div>

                <!-- 圖表與排行榜 -->
                <div class="flex-1 flex gap-4 overflow-hidden">
                    <!-- 左側：長條圖 -->
                    <div class="w-1/2 bg-slate-800 border border-slate-700 rounded-xl p-4 flex flex-col">
                        <h3 class="text-white font-bold mb-3"><i class="fa-solid fa-chart-bar text-orange-400 mr-2"></i>出貨排行榜</h3>
                        <div class="flex-1 overflow-auto" id="pa-bar-chart">
                            <div class="text-center text-slate-500 py-16">
                                <i class="fa-solid fa-chart-bar text-4xl mb-3 opacity-30"></i>
                                <p>點擊「重新分析」載入資料</p>
                            </div>
                        </div>
                    </div>

                    <!-- 右側：詳細列表 -->
                    <div class="w-1/2 bg-slate-800 border border-slate-700 rounded-xl overflow-hidden flex flex-col">
                        <div class="p-3 border-b border-slate-700">
                            <h3 class="text-white font-bold"><i class="fa-solid fa-list-ol text-blue-400 mr-2"></i>詳細排行</h3>
                        </div>
                        <div class="flex-1 overflow-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-slate-700 sticky top-0">
                                    <tr>
                                        <th class="text-center p-2 text-slate-300 w-12">#</th>
                                        <th class="text-left p-2 text-slate-300">品項</th>
                                        <th class="text-left p-2 text-slate-300">規格</th>
                                        <th class="text-right p-2 text-slate-300">次數</th>
                                        <th class="text-right p-2 text-slate-300">數量</th>
                                        <th class="text-right p-2 text-slate-300">佔比</th>
                                    </tr>
                                </thead>
                                <tbody id="pa-ranking-list">
                                    <tr><td colspan="6" class="text-center text-slate-500 py-8">尚無資料</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 倉庫熱力圖頁面 -->
            <div id="view-warehouse-heatmap" class="view-panel h-full hidden flex flex-col p-4">
                <!-- 頂部標題 -->
                <div class="flex items-center justify-between bg-gradient-to-r from-red-900 to-orange-900 border border-red-600 p-4 rounded-xl mb-4">
                    <div>
                        <h2 class="text-white font-bold text-2xl"><i class="fa-solid fa-fire mr-2 text-red-400"></i>倉庫熱力圖</h2>
                        <p class="text-red-200 text-sm mt-1">視覺化各儲位的使用頻率與週轉狀況</p>
                    </div>
                    <button onclick="refreshWarehouseHeatmap()" class="bg-red-600 hover:bg-red-500 text-white px-5 py-3 rounded-lg font-bold">
                        <i class="fa-solid fa-sync mr-2"></i>重新分析
                    </button>
                </div>

                <!-- 查詢條件與圖例 -->
                <div class="flex gap-4 mb-4">
                    <div class="bg-slate-800 border border-slate-700 rounded-xl p-4 flex gap-4 items-end">
                        <div>
                            <label class="text-slate-400 text-xs mb-1 block">分析期間</label>
                            <div class="flex gap-2 items-center">
                                <input type="date" id="heatmap-date-from" class="scan-input" />
                                <span class="text-slate-500">~</span>
                                <input type="date" id="heatmap-date-to" class="scan-input" />
                            </div>
                        </div>
                        <div>
                            <label class="text-slate-400 text-xs mb-1 block">熱力指標</label>
                            <select id="heatmap-metric" class="scan-input" onchange="refreshWarehouseHeatmap()">
                                <option value="frequency">使用頻率（出入庫次數）</option>
                                <option value="turnover">週轉率</option>
                                <option value="duration">平均停留天數</option>
                            </select>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="setHeatmapDateRange('month')" class="text-xs px-3 py-2 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded">近30天</button>
                            <button onclick="setHeatmapDateRange('quarter')" class="text-xs px-3 py-2 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded">近3個月</button>
                        </div>
                    </div>

                    <!-- 熱力圖例 -->
                    <div class="bg-slate-800 border border-slate-700 rounded-xl p-4 flex items-center gap-4">
                        <span class="text-slate-400 text-xs">熱度：</span>
                        <div class="flex items-center gap-1">
                            <div class="w-6 h-6 rounded bg-red-600"></div>
                            <span class="text-xs text-slate-300">高頻（熱區）</span>
                        </div>
                        <div class="flex items-center gap-1">
                            <div class="w-6 h-6 rounded bg-orange-500"></div>
                            <span class="text-xs text-slate-300">中高</span>
                        </div>
                        <div class="flex items-center gap-1">
                            <div class="w-6 h-6 rounded bg-yellow-500"></div>
                            <span class="text-xs text-slate-300">中</span>
                        </div>
                        <div class="flex items-center gap-1">
                            <div class="w-6 h-6 rounded bg-emerald-500"></div>
                            <span class="text-xs text-slate-300">低頻（冷區）</span>
                        </div>
                        <div class="flex items-center gap-1">
                            <div class="w-6 h-6 rounded bg-slate-600"></div>
                            <span class="text-xs text-slate-300">未使用</span>
                        </div>
                    </div>
                </div>

                <!-- 熱力圖 -->
                <div class="flex-1 bg-slate-800 border border-slate-700 rounded-xl p-4 overflow-auto">
                    <div class="grid grid-cols-3 gap-6" id="heatmap-container">
                        <!-- I 庫 -->
                        <div class="bg-slate-900/50 rounded-lg p-4">
                            <h4 class="text-blue-400 font-bold mb-3 text-center">I 庫（原料）</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <div class="text-xs text-slate-500 mb-1 text-center">A 區</div>
                                    <div class="grid grid-cols-8 gap-1" id="heatmap-I-A"></div>
                                </div>
                                <div>
                                    <div class="text-xs text-slate-500 mb-1 text-center">B 區</div>
                                    <div class="grid grid-cols-8 gap-1" id="heatmap-I-B"></div>
                                </div>
                            </div>
                        </div>

                        <!-- J 庫 -->
                        <div class="bg-slate-900/50 rounded-lg p-4">
                            <h4 class="text-purple-400 font-bold mb-3 text-center">J 庫（成品）</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <div class="text-xs text-slate-500 mb-1 text-center">C 區</div>
                                    <div class="grid grid-cols-8 gap-1" id="heatmap-J-C"></div>
                                </div>
                                <div>
                                    <div class="text-xs text-slate-500 mb-1 text-center">D 區</div>
                                    <div class="grid grid-cols-8 gap-1" id="heatmap-J-D"></div>
                                </div>
                            </div>
                        </div>

                        <!-- K 庫 -->
                        <div class="bg-slate-900/50 rounded-lg p-4">
                            <h4 class="text-emerald-400 font-bold mb-3 text-center">K 庫（大型）</h4>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <div class="text-xs text-slate-500 mb-1 text-center">E 區</div>
                                    <div class="grid grid-cols-11 gap-0.5" id="heatmap-K-E"></div>
                                </div>
                                <div>
                                    <div class="text-xs text-slate-500 mb-1 text-center">F 區</div>
                                    <div class="grid grid-cols-11 gap-0.5" id="heatmap-K-F"></div>
                                </div>
                                <div>
                                    <div class="text-xs text-slate-500 mb-1 text-center">G 區</div>
                                    <div class="grid grid-cols-11 gap-0.5" id="heatmap-K-G"></div>
                                </div>
                                <div>
                                    <div class="text-xs text-slate-500 mb-1 text-center">H 區</div>
                                    <div class="grid grid-cols-11 gap-0.5" id="heatmap-K-H"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 統計摘要 -->
                    <div class="grid grid-cols-4 gap-4 mt-6 pt-4 border-t border-slate-700">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-red-400" id="hm-stat-hot">0</div>
                            <div class="text-xs text-slate-400">熱區儲位</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-yellow-400" id="hm-stat-medium">0</div>
                            <div class="text-xs text-slate-400">中頻儲位</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-emerald-400" id="hm-stat-cold">0</div>
                            <div class="text-xs text-slate-400">冷區儲位</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-slate-400" id="hm-stat-unused">0</div>
                            <div class="text-xs text-slate-400">未使用</div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- 品項選擇 Modal -->
    <div id="modal-product-select" class="fixed inset-0 z-50 bg-black/80 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-slate-900 border border-slate-700 rounded-2xl w-[700px] max-h-[80vh] shadow-2xl flex flex-col">
            <div class="bg-gradient-to-r from-cyan-800 to-cyan-700 p-4 rounded-t-2xl border-b border-cyan-600 flex justify-between items-center">
                <h3 class="text-white font-bold text-lg"><i class="fa-solid fa-box-open mr-2"></i>選擇品項</h3>
                <button onclick="closeProductSelectModal()" class="text-slate-300 hover:text-white text-xl">&times;</button>
            </div>
            <div class="p-4 flex flex-col flex-1 overflow-hidden">
                <!-- 搜尋列 -->
                <div class="flex gap-2 mb-3">
                    <div class="relative flex-1">
                        <i class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                        <input type="text" id="product-select-search" class="w-full p-2.5 pl-10 bg-slate-800 border border-slate-600 rounded-lg text-white" placeholder="輸入品號、品名或規格搜尋..." oninput="filterProductSelectList()" autofocus>
                    </div>
                    <select id="product-select-category" class="px-3 bg-slate-800 border border-slate-600 rounded-lg text-white text-sm" onchange="filterProductSelectList()">
                        <option value="">全部類別</option>
                        <option value="成品">成品</option>
                        <option value="原料">原料</option>
                        <option value="半成品">半成品</option>
                        <option value="包材">包材</option>
                    </select>
                </div>
                
                <!-- 品項列表 -->
                <div class="flex-1 overflow-y-auto bg-slate-800 rounded-lg border border-slate-700">
                    <table class="w-full text-sm">
                        <thead class="bg-slate-700 sticky top-0">
                            <tr>
                                <th class="p-2 text-left text-slate-300 w-24">品號</th>
                                <th class="p-2 text-left text-slate-300">品名</th>
                                <th class="p-2 text-left text-slate-300">規格</th>
                                <th class="p-2 text-center text-slate-300 w-20">板容量</th>
                                <th class="p-2 text-center text-slate-300 w-16">類別</th>
                                <th class="p-2 text-center text-slate-300 w-16">選擇</th>
                            </tr>
                        </thead>
                        <tbody id="product-select-list" class="divide-y divide-slate-700">
                        </tbody>
                    </table>
                </div>
                
                <!-- 統計 -->
                <div class="mt-3 flex justify-between items-center text-sm">
                    <span class="text-slate-400">共 <span id="product-select-count" class="text-cyan-400 font-bold">0</span> 筆品項</span>
                    <button onclick="closeProductSelectModal()" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg">
                        取消
                    </button>
                </div>
            </div>
        </div>
    </div>
    <input type="hidden" id="product-select-mode" value="">

    <!-- 品項主檔 Excel 匯入 Modal -->
    <div id="modal-pm-import" class="fixed inset-0 z-50 bg-black/80 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-slate-900 border border-slate-700 rounded-2xl w-[900px] max-h-[85vh] shadow-2xl flex flex-col">
            <div class="bg-gradient-to-r from-emerald-800 to-emerald-700 p-4 rounded-t-2xl border-b border-emerald-600 flex justify-between items-center">
                <h3 class="text-white font-bold text-lg"><i class="fa-solid fa-file-excel mr-2"></i>品項主檔 Excel 匯入</h3>
                <button onclick="closeProductMasterImport()" class="text-slate-300 hover:text-white text-xl">&times;</button>
            </div>

            <div class="p-4 flex-1 overflow-auto">
                <!-- Step 1: 上傳檔案 -->
                <div id="pm-import-step1" class="mb-4">
                    <div class="flex items-center gap-2 mb-3">
                        <span class="bg-emerald-600 text-white text-xs px-2 py-0.5 rounded font-bold">1</span>
                        <span class="text-white font-bold">選擇 Excel 檔案</span>
                    </div>
                    <div class="flex gap-3 items-center">
                        <input type="file" id="pm-import-file" accept=".xlsx,.xls,.csv"
                               class="flex-1 text-white file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-emerald-600 file:text-white file:font-bold hover:file:bg-emerald-500"
                               onchange="previewProductMasterImport()">
                        <button onclick="downloadProductMasterTemplate()" class="px-3 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg text-sm">
                            <i class="fa-solid fa-download mr-1"></i>下載範本
                        </button>
                    </div>
                    <div class="mt-2 text-xs text-slate-400">
                        <i class="fa-solid fa-info-circle mr-1"></i>
                        支援格式：.xlsx, .xls, .csv | 必填欄位：品號、品名、板容量
                    </div>
                </div>

                <!-- Step 2: 預覽資料 -->
                <div id="pm-import-step2" class="hidden">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2">
                            <span class="bg-emerald-600 text-white text-xs px-2 py-0.5 rounded font-bold">2</span>
                            <span class="text-white font-bold">預覽資料</span>
                        </div>
                        <div class="flex gap-3 text-sm">
                            <span class="text-emerald-400"><i class="fa-solid fa-plus-circle mr-1"></i>新增: <span id="pm-import-new-count">0</span></span>
                            <span class="text-yellow-400"><i class="fa-solid fa-edit mr-1"></i>更新: <span id="pm-import-update-count">0</span></span>
                            <span class="text-red-400"><i class="fa-solid fa-exclamation-circle mr-1"></i>錯誤: <span id="pm-import-error-count">0</span></span>
                            <span class="text-slate-400"><i class="fa-solid fa-copy mr-1"></i>重複: <span id="pm-import-skip-count">0</span></span>
                        </div>
                    </div>

                    <div class="bg-slate-800 rounded-lg border border-slate-700 max-h-[350px] overflow-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-slate-700 sticky top-0">
                                <tr>
                                    <th class="p-2 text-left text-slate-300">狀態</th>
                                    <th class="p-2 text-left text-slate-300">品號</th>
                                    <th class="p-2 text-left text-slate-300">品名</th>
                                    <th class="p-2 text-left text-slate-300">規格</th>
                                    <th class="p-2 text-center text-slate-300">板容量</th>
                                    <th class="p-2 text-center text-slate-300">保存期(月)</th>
                                    <th class="p-2 text-left text-slate-300">類別</th>
                                    <th class="p-2 text-left text-slate-300">備註</th>
                                </tr>
                            </thead>
                            <tbody id="pm-import-preview-body">
                            </tbody>
                        </table>
                    </div>

                    <!-- 匯入選項 -->
                    <div class="mt-3 p-3 bg-slate-800/50 rounded-lg border border-slate-700">
                        <div class="flex items-center gap-4">
                            <label class="flex items-center gap-2 text-sm text-white cursor-pointer">
                                <input type="checkbox" id="pm-import-update-existing" checked class="rounded">
                                <span>更新已存在的品項</span>
                            </label>
                            <label class="flex items-center gap-2 text-sm text-white cursor-pointer">
                                <input type="checkbox" id="pm-import-skip-errors" checked class="rounded">
                                <span>跳過錯誤項目繼續匯入</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Step 3: 匯入結果 -->
                <div id="pm-import-step3" class="hidden">
                    <div class="flex items-center gap-2 mb-3">
                        <span class="bg-emerald-600 text-white text-xs px-2 py-0.5 rounded font-bold">3</span>
                        <span class="text-white font-bold">匯入結果</span>
                    </div>
                    <div id="pm-import-result" class="p-4 bg-slate-800 rounded-lg border border-slate-700">
                        <!-- 結果會動態填充 -->
                    </div>
                </div>
            </div>

            <div class="p-4 border-t border-slate-700 flex justify-end gap-3">
                <button onclick="closeProductMasterImport()" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg">
                    取消
                </button>
                <button id="pm-import-btn" onclick="executeProductMasterImport()" disabled
                        class="px-6 py-2 bg-emerald-600 hover:bg-emerald-500 disabled:bg-slate-600 disabled:cursor-not-allowed text-white rounded-lg font-bold">
                    <i class="fa-solid fa-upload mr-1"></i>確認匯入
                </button>
            </div>
        </div>
    </div>

            <div id="modal-warehouse-manager" class="fixed inset-0 z-50 bg-black/80 hidden flex items-center justify-center backdrop-blur-sm">
                <div class="bg-slate-900 border border-slate-700 rounded-2xl w-[700px] max-h-[80vh] shadow-2xl flex flex-col">
                    <div class="bg-gradient-to-r from-slate-800 to-slate-700 p-4 rounded-t-2xl border-b border-slate-600 flex justify-between items-center">
                        <h3 class="text-white font-bold text-lg"><i class="fa-solid fa-warehouse mr-2"></i>倉庫管理</h3>
                        <button onclick="closeWarehouseManager()" class="text-slate-400 hover:text-white text-xl">&times;</button>
                    </div>

                    <div class="p-4 flex-1 overflow-auto">
                        <!-- 新增按鈕 -->
                        <div class="flex gap-2 mb-4">
                            <button onclick="openAddWarehouseModal('external')" class="bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded-lg font-bold text-sm">
                                <i class="fa-solid fa-plus mr-1"></i>新增外倉
                            </button>
                            <button onclick="openAddWarehouseModal('virtual')" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg font-bold text-sm">
                                <i class="fa-solid fa-plus mr-1"></i>新增虛擬倉
                            </button>
                        </div>

                        <!-- 本倉虛擬倉 -->
                        <div class="mb-4">
                            <div class="text-slate-400 text-xs mb-2 font-bold">本倉（需指定儲位）</div>
                            <div class="bg-slate-800 rounded-lg p-3 space-y-2">
                                <div class="flex items-center justify-between py-2 px-3 bg-slate-700/50 rounded">
                                    <span class="text-white"><i class="fa-solid fa-warehouse mr-2 text-yellow-400"></i>一般庫存</span>
                                    <span class="text-slate-500 text-xs">系統預設</span>
                                </div>
                                <div class="flex items-center justify-between py-2 px-3 bg-slate-700/50 rounded">
                                    <span class="text-white"><i class="fa-solid fa-box mr-2 text-cyan-400"></i>客戶寄倉</span>
                                    <span class="text-slate-500 text-xs">系統預設</span>
                                </div>
                                <div class="flex items-center justify-between py-2 px-3 bg-slate-700/50 rounded">
                                    <span class="text-white"><i class="fa-solid fa-lock mr-2 text-purple-400"></i>業務預留</span>
                                    <span class="text-slate-500 text-xs">系統預設</span>
                                </div>
                                <div id="virtual-warehouse-list"></div>
                            </div>
                        </div>

                        <!-- 崇文外倉 -->
                        <div class="mb-4">
                            <div class="text-slate-400 text-xs mb-2 font-bold">崇文 外倉（免儲位）</div>
                            <div class="bg-slate-800 rounded-lg p-3">
                                <div id="cw-warehouse-list" class="space-y-2"></div>
                            </div>
                        </div>

                        <!-- 八方外倉 -->
                        <div class="mb-4">
                            <div class="text-slate-400 text-xs mb-2 font-bold">八方 外倉（免儲位）</div>
                            <div class="bg-slate-800 rounded-lg p-3">
                                <div id="bf-warehouse-list" class="space-y-2"></div>
                            </div>
                        </div>
                    </div>

                    <div class="p-4 border-t border-slate-700">
                        <button onclick="closeWarehouseManager()" class="w-full py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg">關閉</button>
                    </div>
                </div>
            </div>

            <!-- 新增/編輯倉庫 Modal -->
            <div id="modal-add-warehouse" class="fixed inset-0 z-[60] bg-black/80 hidden flex items-center justify-center backdrop-blur-sm">
                <div class="bg-slate-900 border border-slate-700 rounded-2xl w-[400px] shadow-2xl">
                    <div class="bg-gradient-to-r from-emerald-900 to-emerald-800 p-4 rounded-t-2xl border-b border-slate-700">
                        <h3 class="text-white font-bold text-lg" id="add-warehouse-title"><i class="fa-solid fa-plus mr-2"></i>新增倉庫</h3>
                    </div>
                    <div class="p-6 space-y-4">
                        <input type="hidden" id="edit-warehouse-id">
                        <input type="hidden" id="warehouse-type" value="external">

                        <div id="company-select-row">
                            <label class="text-slate-400 text-xs mb-1 block">所屬公司 <span class="text-red-400">*</span></label>
                            <select id="warehouse-company" class="scan-input w-full">
                                <option value="崇文">崇文</option>
                                <option value="八方">八方</option>
                            </select>
                        </div>

                        <div>
                            <label class="text-slate-400 text-xs mb-1 block">倉庫名稱 <span class="text-red-400">*</span></label>
                            <input type="text" id="warehouse-name" class="scan-input w-full" placeholder="例：景山3號" oninput="updateWarehousePreview()">
                        </div>

                        <div id="warehouse-preview" class="bg-slate-800 rounded-lg p-3">
                            <div class="text-slate-400 text-xs mb-1">預覽</div>
                            <div class="text-white font-bold" id="warehouse-preview-text">崇文_</div>
                        </div>
                    </div>
                    <div class="p-4 border-t border-slate-700 flex gap-3">
                        <button onclick="closeAddWarehouseModal()" class="flex-1 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg">取消</button>
                        <button onclick="saveWarehouse()" class="flex-1 py-2 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg font-bold">確認</button>
                    </div>
                </div>
            </div>

            <!-- 外倉出庫 Modal -->
            <div id="modal-ext-outbound" class="fixed inset-0 z-50 bg-black/80 hidden flex items-center justify-center backdrop-blur-sm">
                <div class="bg-slate-900 border border-slate-700 rounded-2xl w-[450px] shadow-2xl">
                    <div class="bg-gradient-to-r from-orange-900 to-orange-800 p-4 rounded-t-2xl border-b border-slate-700">
                        <h3 class="text-white font-bold text-lg"><i class="fa-solid fa-arrow-right-from-bracket mr-2"></i>外倉出庫</h3>
                    </div>
                    <div class="p-6 space-y-4">
                        <input type="hidden" id="ext-out-id">
                        <div class="bg-slate-800 rounded-lg p-3">
                            <div class="text-slate-400 text-xs mb-1">品名</div>
                            <div class="text-white font-bold text-lg" id="ext-out-name">-</div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="bg-slate-800 rounded-lg p-3">
                                <div class="text-slate-400 text-xs mb-1">批號</div>
                                <div class="text-white" id="ext-out-batch">-</div>
                            </div>
                            <div class="bg-slate-800 rounded-lg p-3">
                                <div class="text-slate-400 text-xs mb-1">目前庫存</div>
                                <div class="text-yellow-400 font-bold text-xl" id="ext-out-stock">0</div>
                            </div>
                        </div>
                        <div>
                            <label class="text-slate-400 text-xs mb-1 block">出庫數量 <span class="text-red-400">*</span></label>
                            <div class="flex gap-2">
                                <input type="number" id="ext-out-qty" class="scan-input flex-1 text-center text-2xl font-bold" placeholder="0">
                                <button onclick="document.getElementById('ext-out-qty').value = document.getElementById('ext-out-stock').innerText" class="px-4 py-2 bg-red-600 hover:bg-red-500 text-white rounded-lg font-bold">全出</button>
                            </div>
                        </div>
                        <div>
                            <label class="text-slate-400 text-xs mb-1 block">備註</label>
                            <input type="text" id="ext-out-note" class="scan-input w-full" placeholder="出貨/銷售/報廢...">
                        </div>
                    </div>
                    <div class="p-4 border-t border-slate-700 flex gap-3">
                        <button onclick="closeExtOutboundModal()" class="flex-1 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg">取消</button>
                        <button onclick="confirmExtOutbound()" class="flex-1 py-2 bg-orange-600 hover:bg-orange-500 text-white rounded-lg font-bold">確認出庫</button>
                    </div>
                </div>
            </div>

            <!-- 調撥到本倉 Modal -->
            <div id="modal-transfer" class="fixed inset-0 z-50 bg-black/80 hidden flex items-center justify-center backdrop-blur-sm">
                <div class="bg-slate-900 border border-slate-700 rounded-2xl w-[500px] shadow-2xl">
                    <div class="bg-gradient-to-r from-emerald-900 to-emerald-800 p-4 rounded-t-2xl border-b border-slate-700">
                        <h3 class="text-white font-bold text-lg"><i class="fa-solid fa-truck-arrow-right mr-2"></i>調撥到本倉</h3>
                    </div>
                    <div class="p-6 space-y-4">
                        <input type="hidden" id="transfer-id">
                        <div class="bg-slate-800 rounded-lg p-3">
                            <div class="flex justify-between items-center">
                                <div>
                                    <div class="text-slate-400 text-xs mb-1">品名</div>
                                    <div class="text-white font-bold text-lg" id="transfer-name">-</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-slate-400 text-xs mb-1">來源倉庫</div>
                                    <div class="text-cyan-400 font-bold" id="transfer-from">-</div>
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-3 gap-3">
                            <div class="bg-slate-800 rounded-lg p-3">
                                <div class="text-slate-400 text-xs mb-1">批號</div>
                                <div class="text-white" id="transfer-batch">-</div>
                            </div>
                            <div class="bg-slate-800 rounded-lg p-3">
                                <div class="text-slate-400 text-xs mb-1">效期</div>
                                <div class="text-white" id="transfer-exp">-</div>
                            </div>
                            <div class="bg-slate-800 rounded-lg p-3">
                                <div class="text-slate-400 text-xs mb-1">可調數量</div>
                                <div class="text-yellow-400 font-bold text-xl" id="transfer-stock">0</div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-slate-400 text-xs mb-1 block">調撥數量 <span class="text-red-400">*</span></label>
                                <input type="number" id="transfer-qty" class="scan-input w-full text-center text-xl font-bold" placeholder="0">
                            </div>
                            <div>
                                <label class="text-slate-400 text-xs mb-1 block">目標儲位 <span class="text-red-400">*</span></label>
                                <input type="text" id="transfer-loc" class="scan-input w-full text-center text-xl font-bold" placeholder="A-01-01" style="text-transform:uppercase;">
                            </div>
                        </div>
                        <div class="bg-emerald-900/30 border border-emerald-600/50 rounded-lg p-3">
                            <div class="text-emerald-400 text-sm"><i class="fa-solid fa-info-circle mr-1"></i>調撥後將自動建立本倉棧板庫存</div>
                        </div>
                    </div>
                    <div class="p-4 border-t border-slate-700 flex gap-3">
                        <button onclick="closeTransferModal()" class="flex-1 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg">取消</button>
                        <button onclick="confirmTransfer()" class="flex-1 py-2 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg font-bold">確認調撥</button>
                    </div>
                </div>
            </div>

            <!-- 調撥品項選擇 Modal（精簡版）-->
            <div id="modal-transfer-product" class="fixed inset-0 z-50 bg-black/80 hidden flex items-center justify-center backdrop-blur-sm">
                <div class="bg-slate-900 border border-slate-700 rounded-2xl w-[850px] max-h-[85vh] shadow-2xl flex flex-col">
                    <!-- 標題列（精簡） -->
                    <div class="bg-gradient-to-r from-purple-900 to-indigo-900 px-4 py-3 rounded-t-2xl border-b border-slate-700 flex justify-between items-center flex-shrink-0">
                        <div class="flex items-center gap-3">
                            <i class="fa-solid fa-boxes-stacked text-white"></i>
                            <span class="text-white font-bold">選擇調撥品項</span>
                            <!-- 步驟指示（整合到標題列） -->
                            <div class="flex items-center gap-1 ml-4 text-xs" id="transfer-steps-inline">
                                <span class="bg-blue-600 text-white px-2 py-0.5 rounded font-bold" id="step-tag-1">1.品名</span>
                                <i class="fa-solid fa-chevron-right text-slate-500"></i>
                                <span class="text-slate-500" id="step-tag-2">2.規格</span>
                                <i class="fa-solid fa-chevron-right text-slate-500"></i>
                                <span class="text-slate-500" id="step-tag-3">3.批號</span>
                                <i class="fa-solid fa-chevron-right text-slate-500 step-loc-arrow" style="display:none;"></i>
                                <span class="text-slate-500 step-loc-tag" id="step-tag-4" style="display:none;">4.儲位</span>
                                <i class="fa-solid fa-chevron-right text-slate-500"></i>
                                <span class="text-slate-500" id="step-tag-5">數量</span>
                            </div>
                        </div>
                        <button onclick="closeTransferProductModal()" class="text-slate-400 hover:text-white">
                            <i class="fa-solid fa-xmark text-lg"></i>
                        </button>
                    </div>
                    
                    <!-- 主體區域 -->
                    <div class="flex flex-1 min-h-0">
                        <!-- 左側：品項選擇區 -->
                        <div class="flex-1 flex flex-col border-r border-slate-700">
                            <!-- 麵包屑 + 搜尋（合併） -->
                            <div class="px-3 py-2 border-b border-slate-700 flex items-center gap-2">
                                <button onclick="transferModalGoBack()" id="transfer-modal-back-btn" class="w-7 h-7 bg-slate-700 hover:bg-slate-600 text-white rounded flex items-center justify-center hidden">
                                    <i class="fa-solid fa-arrow-left text-xs"></i>
                                </button>
                                <div class="flex items-center gap-1 text-xs flex-1 min-w-0" id="transfer-bc-product">
                                    <span class="text-slate-400">尚未選擇</span>
                                </div>
                                <div class="relative w-48">
                                    <i class="fa-solid fa-search absolute left-2 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
                                    <input type="text" id="transfer-modal-search" class="scan-input pl-7 w-full h-7 text-xs" placeholder="搜尋..." oninput="filterTransferModalList()">
                                </div>
                            </div>
                            
                            <!-- 列表區域 -->
                            <div class="flex-1 overflow-auto p-2" id="transfer-modal-list-area">
                                <div class="text-center text-slate-500 py-10">
                                    <i class="fa-solid fa-spinner fa-spin text-2xl mb-2"></i>
                                    <div class="text-sm">載入中...</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 右側：已選清單（精簡） -->
                        <div class="w-56 flex flex-col bg-slate-800/30">
                            <div class="px-3 py-2 border-b border-slate-700 flex items-center justify-between">
                                <span class="text-white font-bold text-xs">
                                    <i class="fa-solid fa-cart-shopping mr-1 text-yellow-400"></i>已選
                                </span>
                                <span class="bg-yellow-600 text-white text-xs font-bold px-1.5 py-0.5 rounded-full min-w-[20px] text-center" id="transfer-cart-count">0</span>
                            </div>
                            <div class="flex-1 overflow-auto p-2" id="transfer-cart-list">
                                <div class="text-center text-slate-500 py-6 text-xs">
                                    <i class="fa-solid fa-inbox text-xl mb-1 opacity-50"></i>
                                    <div>尚未選擇</div>
                                </div>
                            </div>
                            <div class="p-2 border-t border-slate-700">
                                <button onclick="confirmTransferCart()" id="transfer-cart-confirm-btn" class="w-full py-2 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg font-bold text-xs transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                    <i class="fa-solid fa-check mr-1"></i>確認加入
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 原料領用品項選擇 Modal（精簡版）-->
            <div id="modal-rm-product" class="fixed inset-0 z-50 bg-black/80 hidden flex items-center justify-center backdrop-blur-sm">
                <div class="bg-slate-900 border border-slate-700 rounded-2xl w-[850px] max-h-[85vh] shadow-2xl flex flex-col">
                    <!-- 標題列（精簡） -->
                    <div class="bg-gradient-to-r from-cyan-900 to-blue-900 px-4 py-3 rounded-t-2xl border-b border-slate-700 flex justify-between items-center flex-shrink-0">
                        <div class="flex items-center gap-3">
                            <i class="fa-solid fa-fish text-white"></i>
                            <span class="text-white font-bold">選擇領用品項</span>
                            <!-- 步驟指示（整合到標題列） -->
                            <div class="flex items-center gap-1 ml-4 text-xs" id="rm-steps-inline">
                                <span class="bg-blue-600 text-white px-2 py-0.5 rounded font-bold" id="rm-step-tag-1">1.品名</span>
                                <i class="fa-solid fa-chevron-right text-slate-500"></i>
                                <span class="text-slate-500" id="rm-step-tag-2">2.規格</span>
                                <i class="fa-solid fa-chevron-right text-slate-500"></i>
                                <span class="text-slate-500" id="rm-step-tag-3">3.批號</span>
                                <i class="fa-solid fa-chevron-right text-slate-500"></i>
                                <span class="text-slate-500" id="rm-step-tag-4">4.儲位</span>
                                <i class="fa-solid fa-chevron-right text-slate-500"></i>
                                <span class="text-slate-500" id="rm-step-tag-5">數量</span>
                            </div>
                        </div>
                        <button onclick="closeRmProductModal()" class="text-slate-400 hover:text-white">
                            <i class="fa-solid fa-xmark text-lg"></i>
                        </button>
                    </div>
                    
                    <!-- 主體區域 -->
                    <div class="flex flex-1 min-h-0">
                        <!-- 左側：品項選擇區 -->
                        <div class="flex-1 flex flex-col border-r border-slate-700">
                            <!-- 麵包屑 + 搜尋（合併） -->
                            <div class="px-3 py-2 border-b border-slate-700 flex items-center gap-2">
                                <button onclick="rmModalGoBack()" id="rm-modal-back-btn" class="w-7 h-7 bg-slate-700 hover:bg-slate-600 text-white rounded flex items-center justify-center hidden">
                                    <i class="fa-solid fa-arrow-left text-xs"></i>
                                </button>
                                <div class="flex items-center gap-1 text-xs flex-1 min-w-0" id="rm-bc-product">
                                    <span class="text-slate-400">尚未選擇</span>
                                </div>
                                <div class="relative w-48">
                                    <i class="fa-solid fa-search absolute left-2 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
                                    <input type="text" id="rm-modal-search" class="scan-input pl-7 w-full h-7 text-xs" placeholder="搜尋..." oninput="filterRmModalList()">
                                </div>
                            </div>
                            
                            <!-- 列表區域 -->
                            <div class="flex-1 overflow-auto p-2" id="rm-modal-list-area">
                                <div class="text-center text-slate-500 py-10">
                                    <i class="fa-solid fa-spinner fa-spin text-2xl mb-2"></i>
                                    <div class="text-sm">載入中...</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 右側：已選清單（精簡） -->
                        <div class="w-56 flex flex-col bg-slate-800/30">
                            <div class="px-3 py-2 border-b border-slate-700 flex items-center justify-between">
                                <span class="text-white font-bold text-xs">
                                    <i class="fa-solid fa-cart-shopping mr-1 text-yellow-400"></i>已選
                                </span>
                                <span class="bg-yellow-600 text-white text-xs font-bold px-1.5 py-0.5 rounded-full min-w-[20px] text-center" id="rm-modal-cart-count">0</span>
                            </div>
                            <div class="flex-1 overflow-auto p-2" id="rm-modal-cart-list">
                                <div class="text-center text-slate-500 py-6 text-xs">
                                    <i class="fa-solid fa-inbox text-xl mb-1 opacity-50"></i>
                                    <div>尚未選擇</div>
                                </div>
                            </div>
                            <div class="p-2 border-t border-slate-700">
                                <button onclick="confirmRmModalCart()" id="rm-modal-confirm-btn" class="w-full py-2 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg font-bold text-xs transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                    <i class="fa-solid fa-check mr-1"></i>確認加入
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 領料確認 Modal -->
            <div id="modal-rm-confirm" class="fixed inset-0 z-50 bg-black/80 hidden flex items-center justify-center backdrop-blur-sm">
                <div class="bg-slate-900 border border-slate-700 rounded-2xl w-[600px] max-h-[90vh] overflow-hidden shadow-2xl flex flex-col">
                    <div class="bg-gradient-to-r from-cyan-900 to-cyan-800 p-4 rounded-t-2xl border-b border-slate-700">
                        <h3 class="text-white font-bold text-lg"><i class="fa-solid fa-clipboard-check mr-2"></i>確認領料出庫</h3>
                        <p class="text-cyan-200 text-sm mt-1">請確認每筆的實際領用數量</p>
                    </div>
                    <div class="p-4 flex-1 overflow-y-auto">
                        <!-- 領料明細列表 -->
                        <div id="rm-confirm-list" class="space-y-3">
                            <!-- 動態產生 -->
                        </div>
                    </div>
                    <div class="p-4 border-t border-slate-700 bg-slate-800/50">
                        <div class="grid grid-cols-2 gap-3 mb-4">
                            <div>
                                <label class="text-slate-400 text-xs mb-1 block">領用人 <span class="text-red-400">*</span></label>
                                <input type="text" id="rm-confirm-user" class="scan-input w-full" placeholder="輸入領用人姓名">
                            </div>
                            <div>
                                <label class="text-slate-400 text-xs mb-1 block">用途/生產批次</label>
                                <input type="text" id="rm-confirm-purpose" class="scan-input w-full" placeholder="如：加工A線、生產批次001">
                            </div>
                        </div>
                        <div class="flex justify-between items-center mb-4 p-3 bg-slate-900 rounded-lg">
                            <div class="text-slate-400">總計領用</div>
                            <div class="text-2xl font-bold text-yellow-400" id="rm-confirm-total">0 件</div>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="closeRmConfirmModal()" class="flex-1 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-lg">取消</button>
                            <button onclick="executeRmPickingLegacy()" class="flex-1 py-3 bg-green-600 hover:bg-green-500 text-white rounded-lg font-bold">
                                <i class="fa-solid fa-check mr-2"></i>確認出庫
                            </button>
                        </div>
                    </div>
                </div>
            </div>

    <div id="print-area" class="hidden"></div>

    <!-- 待執行入庫單彈窗 -->
    <div id="pending-inbound-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/70" onclick="closePendingInbounds()"></div>
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[900px] max-h-[80vh] bg-slate-900 rounded-lg border border-slate-700 shadow-2xl flex flex-col">
            <div class="p-4 border-b border-slate-700 flex justify-between items-center">
                <h3 class="text-white font-bold text-lg"><i class="fa-solid fa-clock text-yellow-400 mr-2"></i>待執行入庫單</h3>
                <button onclick="closePendingInbounds()" class="text-slate-400 hover:text-white text-xl">&times;</button>
            </div>
            <div class="p-4 flex-1 overflow-auto">
                <div class="flex justify-between items-center mb-3">
                    <div class="text-sm text-slate-400">堆高機手完成後，簽名交回再點「確認入帳」</div>
                    <div class="flex gap-2">
                        <button onclick="printSelectedInbounds()" class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-1 rounded text-xs font-bold">
                            <i class="fa-solid fa-print mr-1"></i>列印勾選
                        </button>
                        <button onclick="confirmSelectedInbounds()" class="bg-emerald-600 hover:bg-emerald-500 text-white px-3 py-1 rounded text-xs font-bold">
                            <i class="fa-solid fa-check-double mr-1"></i>批次確認入帳
                        </button>
                    </div>
                </div>
                <table class="w-full text-sm">
                    <thead class="bg-slate-800 sticky top-0">
                        <tr class="text-slate-400 text-xs">
                            <th class="p-2 text-left"><input type="checkbox" id="select-all-inbound" onchange="toggleSelectAllInbound()"></th>
                            <th class="p-2 text-left">單號</th>
                            <th class="p-2 text-left">類型</th>
                            <th class="p-2 text-left">儲位</th>
                            <th class="p-2 text-left">品名/規格</th>
                            <th class="p-2 text-left">批號</th>
                            <th class="p-2 text-left">效期</th>
                            <th class="p-2 text-right">數量</th>
                            <th class="p-2 text-left">建單時間</th>
                            <th class="p-2 text-center">操作</th>
                        </tr>
                    </thead>
                    <tbody id="pending-inbound-list">
                        <tr><td colspan="10" class="text-center text-slate-500 py-10">載入中...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 駁回原因彈窗 -->
    <div id="reject-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/70" onclick="closeRejectModal()"></div>
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[400px] bg-slate-900 rounded-lg border border-slate-700 shadow-2xl">
            <div class="p-4 border-b border-slate-700 flex justify-between items-center">
                <h3 class="text-white font-bold"><i class="fa-solid fa-times-circle text-red-400 mr-2"></i>駁回入庫單</h3>
                <button onclick="closeRejectModal()" class="text-slate-400 hover:text-white text-xl">&times;</button>
            </div>
            <div class="p-4">
                <input type="hidden" id="reject-order-id">
                <div class="mb-4">
                    <label class="text-sm text-slate-400 block mb-2">駁回原因 <span class="text-red-400">*</span></label>
                    <textarea id="reject-reason" class="scan-input w-full h-24 p-2" placeholder="請輸入駁回原因，倉管將依此修改後重新送審"></textarea>
                </div>
                <div class="flex gap-2">
                    <button onclick="closeRejectModal()" class="flex-1 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded">取消</button>
                    <button onclick="confirmReject()" class="flex-1 py-2 bg-red-600 hover:bg-red-500 text-white rounded font-bold">確認駁回</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 修改入庫單彈窗（駁回後倉管修改用） -->
    <div id="edit-inbound-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/70" onclick="closeEditInboundModal()"></div>
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[500px] bg-slate-900 rounded-lg border border-slate-700 shadow-2xl">
            <div class="p-4 border-b border-slate-700 flex justify-between items-center">
                <h3 class="text-white font-bold"><i class="fa-solid fa-edit text-blue-400 mr-2"></i>修改入庫單</h3>
                <button onclick="closeEditInboundModal()" class="text-slate-400 hover:text-white text-xl">&times;</button>
            </div>
            <div class="p-4">
                <input type="hidden" id="edit-order-id">

                <!-- 駁回原因顯示 -->
                <div id="edit-reject-reason-box" class="mb-4 p-3 bg-red-900/30 border border-red-500/50 rounded">
                    <div class="text-red-400 text-sm font-bold mb-1"><i class="fa-solid fa-exclamation-triangle mr-1"></i>駁回原因</div>
                    <div id="edit-reject-reason" class="text-white text-sm"></div>
                </div>

                <div class="space-y-3">
                    <div>
                        <label class="text-xs text-slate-400">品名</label>
                        <input type="text" id="edit-name" class="scan-input w-full">
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="text-xs text-slate-400">規格</label>
                            <input type="text" id="edit-spec" class="scan-input w-full">
                        </div>
                        <div>
                            <label class="text-xs text-slate-400">數量</label>
                            <input type="number" id="edit-qty" class="scan-input w-full">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="text-xs text-slate-400">批號</label>
                            <input type="text" id="edit-batch" class="scan-input w-full">
                        </div>
                        <div>
                            <label class="text-xs text-slate-400">效期</label>
                            <input type="date" id="edit-exp" class="scan-input w-full">
                        </div>
                    </div>
                    <div>
                        <label class="text-xs text-slate-400">儲位</label>
                        <input type="text" id="edit-loc" class="scan-input w-full">
                    </div>
                    <div>
                        <label class="text-xs text-slate-400">廠商</label>
                        <input type="text" id="edit-vendor" class="scan-input w-full">
                    </div>
                </div>

                <div class="flex gap-2 mt-4">
                    <button onclick="closeEditInboundModal()" class="flex-1 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded">取消</button>
                    <button onclick="submitEditAndReapprove()" class="flex-1 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded font-bold">修改並重新送審</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Firebase 初始化 -->
    <script src="firebase-init.js"></script>
    
    <!-- 主程式 -->
    <script src="app.js"></script>
</body>
</html>
