<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WMS å…¨åŠŸèƒ½æ——è‰¦ç‰ˆ (V56.0 æ™ºèƒ½å…¥åº«+å¤šç­†æ¨¡å¼)</title>
    <script>
        (function() {
            var w = console.warn;
            console.warn = function() {
                var a = Array.from(arguments);
                if (a[0] && typeof a[0] === 'string' && a[0].indexOf('cdn.tailwindcss.com') > -1) return;
                w.apply(console, a);
            };
        })();
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

    <style>
        body { font-family: 'Inter', 'Microsoft JhengHei', sans-serif; background-color: #0f172a; color: #cbd5e1; font-size: 13px; user-select: none; }
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 2px; }

        /* å°èˆª */
        .nav-item { display: flex; align-items: center; padding: 10px 16px; color: #94a3b8; cursor: pointer; transition: 0.2s; border-left: 3px solid transparent; font-size: 13px; }
        .nav-item:hover { background-color: #1e293b; color: white; }
        .nav-item.active { background-color: #1e293b; color: #38bdf8; border-left-color: #38bdf8; background: linear-gradient(90deg, rgba(56,189,248,0.1) 0%, rgba(30,41,59,0) 100%); font-weight: bold; }
        .nav-group { font-size: 11px; font-weight: bold; color: #64748b; padding: 14px 16px 4px; text-transform: uppercase; letter-spacing: 0.05em; }
        .nav-group-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 16px; color: #94a3b8; cursor: pointer; font-size: 13px; font-weight: 600; border-left: 3px solid transparent; transition: 0.2s; }
        .nav-group-header:hover { background-color: #1e293b; color: white; }
        .nav-group-header .nav-chevron { font-size: 10px; transition: transform 0.2s; }
        .nav-group-items { overflow: hidden; transition: max-height 0.3s ease; max-height: 500px; }
        .nav-group-items.collapsed { max-height: 0; }
        .nav-group-items.collapsed + .nav-group-header .nav-chevron { transform: rotate(-90deg); }
        .nav-group-items .nav-item { padding-left: 28px; font-size: 12px; }

        .glass-panel { background: #1e293b; border: 1px solid #334155; border-radius: 8px; }
        .scan-input { background: #0f172a; border: 1px solid #475569; color: white; border-radius: 6px; padding: 0 12px; font-family: monospace; width: 100%; transition: 0.3s; height: 36px; font-size: 14px; }
        .scan-input:focus { border-color: #3b82f6; box-shadow: 0 0 0 1px #3b82f6; outline: none; }
        .scan-input[readonly] { background: #1e293b; color: #64748b; cursor: not-allowed; }

        /* Badge */
        .badge { padding: 1px 5px; border-radius: 3px; font-size: 10px; font-weight: bold; display: inline-block; white-space: nowrap; }
        .badge-green { background: rgba(16, 185, 129, 0.2); color: #34d399; border: 1px solid rgba(16, 185, 129, 0.3); }
        .badge-purple { background: rgba(168, 85, 247, 0.2); color: #c084fc; border: 1px solid rgba(168, 85, 247, 0.3); }
        .badge-yellow { background: rgba(234, 179, 8, 0.2); color: #facc15; border: 1px solid rgba(234, 179, 8, 0.3); }
        .badge-orange { background: rgba(249, 115, 22, 0.2); color: #fb923c; border: 1px solid rgba(249, 115, 22, 0.3); }
        .badge-blue { background: rgba(59, 130, 246, 0.2); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.3); }
        .badge-red { background: rgba(239, 68, 68, 0.2); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.3); }

        .dense-table th { position: sticky; top: 0; background: #0f172a; z-index: 10; padding: 8px 12px; border-bottom: 1px solid #334155; font-size: 12px; color: #94a3b8; }
        .dense-table th.text-left { text-align: left; }
        .dense-table th.text-right { text-align: right; }
        .dense-table td { padding: 6px 12px; border-bottom: 1px solid #1e293b; white-space: nowrap; font-size: 12px; }
        .dense-table tr:hover { background-color: #334155; cursor: pointer; }

        /* åœ°åœ–æ¨£å¼ */
        .warehouse-container { display: grid; grid-template-columns: 1fr 1fr 600px; gap: 15px; height: 100%; background-color: #0f172a; padding: 15px; overflow: hidden; }
        .warehouse-container-new { display: grid; grid-template-columns: 1fr 1fr 1fr 500px; gap: 12px; height: 100%; background-color: #0f172a; padding: 15px; overflow: hidden; }

        /* æ–°å€‰åº«ä½ˆå±€ */
        .warehouse-new-layout { display: flex; gap: 12px; height: 100%; background-color: #0f172a; padding: 10px; overflow: hidden; }
        .warehouse-left-area { flex: 1; display: flex; flex-direction: column; gap: 10px; min-width: 0; }

        /* ä¸Šå±¤ I+J ä¸¦æ’ */
        .warehouse-ij-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; height: 35%; }
        .warehouse-building-ij { background: #1e293b; border: 2px solid #475569; border-radius: 8px; padding: 10px; position: relative; display: flex; flex-direction: column; }

        /* ä¸‹å±¤ K åº« */
        .warehouse-k-area { flex: 1; min-height: 0; }
        .warehouse-building-k { background: #1e293b; border: 2px solid #475569; border-radius: 8px; padding: 10px; position: relative; height: 100%; display: flex; flex-direction: column; }

        /* é€šç”¨æ¨™ç±¤ */
        .building-label { position: absolute; top: -10px; left: 12px; color: white; padding: 2px 10px; font-size: 11px; font-weight: bold; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.3); z-index: 5; }
        .zone-label { width: 28px; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 800; color: white; background: #3b82f6; border-radius: 4px 0 0 4px; flex-shrink: 0; }

        /* I/J å€åŸŸå †ç–Š (A/B, C/D ä¸Šä¸‹) */
        .zones-stack { display: flex; flex-direction: column; gap: 6px; flex: 1; margin-top: 14px; }
        .zone-row-item { display: flex; flex: 1; min-height: 0; }
        .rack-lanes-8 { display: grid; grid-template-columns: repeat(8, 1fr); gap: 4px; flex: 1; padding: 6px; background: rgba(15, 23, 42, 0.5); border: 1px solid #334155; border-radius: 0 4px 4px 0; }

        /* K å€åŸŸå †ç–Š (E/F/G/H ä¸Šä¸‹ï¼Œ22å··é“) */
        .zones-stack-k { display: flex; flex-direction: column; gap: 6px; flex: 1; margin-top: 14px; }
        .zone-row-item-k { display: flex; flex: 1; min-height: 0; }
        .rack-lanes-22 { display: grid; grid-template-columns: repeat(22, 1fr); gap: 3px; flex: 1; padding: 6px; background: rgba(15, 23, 42, 0.5); border: 1px solid #334155; border-radius: 0 4px 4px 0; }

        /* Hover æµ®å‹•æç¤ºå¡ç‰‡ - è¶…å¤§å°ºå¯¸ç‰ˆï¼Œä¸‰å±¤å®Œæ•´é¡¯ç¤º */
        .hover-tooltip { position: fixed; z-index: 9999; pointer-events: none; width: auto; min-width: 650px; max-width: 900px; max-height: 85vh; overflow-y: auto; background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border: 2px solid #3b82f6; border-radius: 14px; box-shadow: 0 25px 50px rgba(0,0,0,0.7), 0 0 30px rgba(59,130,246,0.4); animation: tooltipIn 0.15s ease-out; }
        .hover-tooltip.hidden { display: none; }
        .hover-tooltip table { white-space: nowrap; }
        .hover-tooltip table td, .hover-tooltip table th { white-space: nowrap; }
        @keyframes tooltipIn { from { opacity: 0; transform: translateY(8px) scale(0.96); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .tooltip-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 14px; background: linear-gradient(90deg, #3b82f6 0%, #8b5cf6 100%); border-radius: 12px 12px 0 0; }
        .tooltip-title { font-weight: 800; font-size: 15px; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .tooltip-badge { font-size: 12px; font-weight: 700; padding: 4px 12px; border-radius: 20px; background: rgba(255,255,255,0.2); color: white; }
        .tooltip-body { padding: 10px; display: flex; flex-direction: column; gap: 8px; }
        .tooltip-level { background: rgba(0,0,0,0.3); border-radius: 8px; padding: 8px 10px; border: 1px solid #334155; }
        .tooltip-level-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; padding-bottom: 4px; border-bottom: 1px solid #334155; }
        .tooltip-level-name { font-weight: 700; font-size: 12px; color: #94a3b8; }
        .tooltip-level-count { font-size: 11px; color: #64748b; font-weight: 600; }
        .tooltip-items { display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; }
        .tooltip-item { background: linear-gradient(135deg, #334155 0%, #1e293b 100%); border-radius: 4px; padding: 5px 6px; border-left: 3px solid #3b82f6; min-width: 0; }
        .tooltip-item.cat-raw { border-left-color: #f59e0b; }
        .tooltip-item.cat-fg { border-left-color: #10b981; }
        .tooltip-item.cat-wip { border-left-color: #8b5cf6; }
        .tooltip-item-name { font-weight: 600; font-size: 11px; color: #e2e8f0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.3; }
        .tooltip-item-info { font-size: 9px; color: #94a3b8; }
        .tooltip-item-qty { font-weight: 800; font-size: 12px; color: #60a5fa; }
        .tooltip-item.empty-slot { background: rgba(0,0,0,0.15); border-left-color: #475569; opacity: 0.5; }
        .tooltip-item.empty-slot .tooltip-item-name { color: #64748b; font-size: 10px; }
        .tooltip-empty { color: #475569; font-size: 10px; text-align: center; padding: 6px; background: rgba(0,0,0,0.2); border-radius: 4px; border: 1px dashed #334155; }
        .tooltip-summary { display: flex; gap: 8px; margin-bottom: 6px; }
        .tooltip-stat { flex: 1; text-align: center; padding: 8px 6px; background: rgba(0,0,0,0.3); border-radius: 6px; border: 1px solid #334155; }
        .tooltip-stat-value { font-size: 18px; font-weight: 800; color: #60a5fa; }
        .tooltip-stat-label { font-size: 10px; color: #64748b; margin-top: 2px; }
        .tooltip-stat.full .tooltip-stat-value { color: #ef4444; }
        .tooltip-stat.empty .tooltip-stat-value { color: #10b981; }
        .tooltip-items-1f { display: grid; grid-template-columns: repeat(8, 1fr); gap: 4px; }

        /* ç§»é™¤èˆŠçš„å›ºå®šé¢æ¿æ¨£å¼ï¼Œæ”¹ç”¨å…¨å¯¬ä½ˆå±€ */
        .warehouse-new-layout { display: block; height: 100%; background-color: #0f172a; padding: 10px; overflow: hidden; }
        .warehouse-left-area { display: flex; flex-direction: column; gap: 10px; height: 100%; }

        /* å··é“æ ¼å­ */
        .rack-lane-new { background: #0f172a; border: 1px solid #475569; border-radius: 3px; cursor: pointer; position: relative; transition: all 0.2s; overflow: hidden; display: flex; flex-direction: column; justify-content: flex-end; min-height: 28px; }
        .rack-lane-new:hover { border-color: #60a5fa; transform: scale(1.1); z-index: 10; box-shadow: 0 2px 8px rgba(0,0,0,0.5); }
        .rack-lane-new .lane-id-tag { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 9px; font-weight: 800; color: #475569; }
        .rack-lane-new:hover .lane-id-tag { color: #94a3b8; }
        .map-overview-col { overflow-y: auto; overflow-x: visible; display: flex; flex-direction: column; gap: 20px; padding-right: 5px; padding-top: 20px; }
        .warehouse-building { background: #1e293b; border: 2px solid #475569; border-radius: 12px; padding: 35px 15px 15px 15px; position: relative; margin-top: 15px; }
        .zone-header { font-size: 14px; font-weight: 900; color: #fff; background: #3b82f6; padding: 2px 8px; border-radius: 4px 4px 0 0; display: inline-block; margin-bottom: 0; border: 1px solid #60a5fa; }
        .zone-block { margin-bottom: 20px; border: 2px solid #334155; padding: 10px; border-radius: 0 8px 8px 8px; background: rgba(15, 23, 42, 0.5); position: relative; top: -1px; }
        .rack-lanes-grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 6px; }
        .rack-lanes-grid .rack-lane-new { height: 50px; min-height: 50px; }

        /* å…¥åº«ä¸­å¿ƒåœ°åœ–æ¨£å¼ */
        .inbound-map-container { display: flex; flex-direction: column; gap: 10px; height: 100%; }
        .inbound-map-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .inbound-warehouse { background: #1e293b; border: 1px solid #334155; border-radius: 8px; padding: 10px; }
        .inbound-warehouse-k { background: #1e293b; border: 1px solid #334155; border-radius: 8px; padding: 10px; }
        .inbound-zone { display: flex; align-items: center; gap: 6px; margin-bottom: 4px; }
        .inbound-zone:last-child { margin-bottom: 0; }
        .rack-lanes-grid-inbound { display: grid; grid-template-columns: repeat(8, 1fr); gap: 3px; flex: 1; }
        .rack-lanes-grid-inbound .rack-lane-new { height: 32px; min-height: 32px; }
        .inbound-k-zones { display: flex; flex-direction: column; gap: 4px; }
        .inbound-zone-k { display: flex; align-items: center; gap: 6px; }
        .rack-lanes-grid-k { display: grid; grid-template-columns: repeat(22, 1fr); gap: 2px; flex: 1; }
        .rack-lanes-grid-k .rack-lane-new { height: 32px; min-height: 32px; }
        .rack-lane { height: 60px; background: #0f172a; border: 1px solid #475569; border-radius: 4px; cursor: pointer; position: relative; transition: all 0.2s; overflow: hidden; display:flex; flex-direction:column; justify-content:flex-end; }
        .rack-lane:hover { border-color: #60a5fa; z-index: 10; transform: scale(1.05); box-shadow: 0 4px 6px rgba(0,0,0,0.5); }
        .rack-lane.active { border-color: #facc15; box-shadow: 0 0 0 2px rgba(250, 204, 21, 0.4); background: #334155; }
        .lane-id-tag { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 16px; font-weight: 900; color: #475569; z-index: 1; pointer-events: none; }
        .rack-lane:hover .lane-id-tag { color: #94a3b8; }
        .lane-fill-bar { position: absolute; bottom: 0; left: 0; right: 0; transition: height 0.3s; opacity: 0.6; z-index: 0; }
        .lane-full-locked { background: repeating-linear-gradient(45deg, #1f2937, #1f2937 10px, #374151 10px, #374151 20px); border-color: #ef4444; opacity: 0.7; cursor: not-allowed !important; }
        .lane-suggest-gold { background: rgba(234, 179, 8, 0.15); border: 2px solid #eab308; box-shadow: 0 0 10px rgba(234, 179, 8, 0.5); animation: pulse-gold 1.5s infinite; }
        @keyframes pulse-gold { 0% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0.4); } 70% { box-shadow: 0 0 0 8px rgba(234, 179, 8, 0); } 100% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0); } }

        /* è©³æƒ…é¢æ¿ */
        .rack-detail-panel { background: #1e293b; border-left: 1px solid #334155; padding: 0; display: flex; flex-direction: column; border-radius: 12px; height: 100%; overflow: hidden; box-shadow: -5px 0 20px rgba(0,0,0,0.5); }
        .levels-container { padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; flex: 1; }
        .level-card { background: #0f172a; border: 1px solid #334155; border-radius: 8px; padding: 10px; }
        .level-header { display: flex; justify-content: space-between; font-size: 12px; color: #cbd5e1; margin-bottom: 8px; font-weight: 800; border-bottom: 1px dashed #334155; padding-bottom: 4px; }
        .level-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }

        .pallet-box { width: 100%; height: 60px; border-radius: 4px; display: flex; flex-direction: column; justify-content: space-between; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.4); overflow: hidden; padding: 4px 6px; color: rgba(255,255,255,0.9); border: 1px solid rgba(255,255,255,0.1); transition: 0.2s; }
        .pallet-box:hover { transform: scale(1.05); z-index: 20; border-color: white; }
        .pallet-box .row-1 { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .pallet-box .row-1 .name { font-weight: bold; font-size: 11px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 70%; }
        .pallet-box .row-1 .qty { background: rgba(0,0,0,0.4); padding: 1px 4px; border-radius: 3px; font-size: 10px; font-weight: bold; color: white; }
        .pallet-box .row-2 { font-size: 10px; color: #fde047; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: left; width: 100%; }
        .pallet-box .row-3 { font-size: 9px; color: #cbd5e1; font-family: monospace; text-align: left; width: 100%; opacity: 0.8; }
        .bg-fg { background: linear-gradient(135deg, #7c3aed, #6d28d9); } .bg-raw { background: linear-gradient(135deg, #059669, #047857); } .bg-wip { background: linear-gradient(135deg, #ca8a04, #b45309); color: white; }
        .pallet-empty { background: transparent; border: 2px dashed #334155; color: #475569; display: flex; align-items: center; justify-content: center; font-size: 11px; height: 60px; }

        /* UI Components */
        .tab-btn { padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: bold; color: #64748b; background: #1e293b; border: 1px solid #334155; transition: 0.2s; font-size: 13px; }
        .tab-btn.active { background: #2563eb; color: white; border-color: #3b82f6; }
        .virtual-card { background: #334155; padding: 10px; border-radius: 6px; cursor: pointer; border: 1px solid transparent; text-align: center; }
        .virtual-card:hover { border-color: #38bdf8; background: #475569; }
        .move-box { width: 45%; height: 300px; background: #1e293b; border: 3px dashed #475569; border-radius: 16px; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: 0.3s; }
        .move-box.active { border-color: #38bdf8; background: #0f172a; border-style: solid; box-shadow: 0 0 20px rgba(56, 189, 248, 0.2); }
        .type-radio:checked + div { background-color: #1e40af; border-color: #3b82f6; color: white; }
        .mode-btn { padding: 10px; border-radius: 8px; border: 1px solid #475569; text-align: center; cursor: pointer; transition: 0.2s; color: #94a3b8; background: #1e293b; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 60px; }
        .mode-btn:hover { background: #334155; color: white; }
        .mode-btn.active-raw { background: #064e3b; border-color: #10b981; color: #34d399; font-weight: bold; box-shadow: 0 0 15px rgba(16, 185, 129, 0.4); }
        .mode-btn.active-fg { background: #4c1d95; border-color: #a855f7; color: #d8b4fe; font-weight: bold; box-shadow: 0 0 15px rgba(168, 85, 247, 0.4); }
        .mode-btn.active-wip { background: #451a03; border-color: #eab308; color: #fde047; font-weight: bold; box-shadow: 0 0 15px rgba(234, 179, 8, 0.4); }
        .mode-btn.active-ret { background: #431407; border-color: #fb923c; color: #fdba74; font-weight: bold; box-shadow: 0 0 10px rgba(251, 146, 60, 0.4); }
        .level-btn { width: 100%; padding: 12px; border-radius: 6px; font-weight: bold; text-align: center; transition: 0.2s; border: 1px solid; }
        .level-btn-active { background: #1e40af; border-color: #3b82f6; color: white; cursor: pointer; }
        .level-btn-active:hover { background: #2563eb; }
        .level-btn-full { background: #334155; border-color: #475569; color: #64748b; cursor: not-allowed; position: relative; }
        .level-btn-full::after { content: 'å·²æ»¿'; position: absolute; right: 10px; font-size: 10px; color: #ef4444; }
        .field-group.hidden { display: none; }
        .kpi-card { cursor: pointer; transition: all 0.2s; }
        .kpi-card:hover { transform: translateY(-3px); box-shadow: 0 4px 12px rgba(0,0,0,0.5); border-color: white; }

        /* è™›æ“¬å„²ä½å¡ç‰‡æ¨£å¼ */
        .virtual-loc-card {
            padding: 8px 6px;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .virtual-loc-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }
        .virtual-loc-card .text-xl {
            line-height: 1.2;
        }

        /* V50 é è¦½æ¨™ç±¤å°ˆç”¨æ¨£å¼ (æ¨¡æ“¬ç´™å¼µ) */
        .preview-label-card {
            background: white; color: black; padding: 10px; border-radius: 4px; font-family: sans-serif;
            border: 2px solid #ccc; width: 100%; box-shadow: 0 4px 6px rgba(0,0,0,0.3); margin-top: 10px;
        }
        .preview-header { text-align: center; font-weight: 900; border-bottom: 2px solid black; padding-bottom: 5px; margin-bottom: 5px; font-size: 14px; }
        .preview-row { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 4px; border-bottom: 1px dashed #eee; }
        .preview-val { font-weight: bold; }
        .preview-big { font-size: 24px; font-weight: 900; text-align: center; display: block; margin: 10px 0; }

        /* å€åŸŸå‹¾é¸æŒ‰éˆ•æ¨£å¼ */
        .zone-check-btn input:checked + span { background: #2563eb; color: white; }
        .zone-check-btn input:not(:checked) + span { background: #334155; color: #94a3b8; }
        .zone-check-btn span:hover { opacity: 0.8; }

        /* å°å‹æ’å–®å¡ç‰‡æ¨£å¼ */
        .mini-label-card { background: white; border-radius: 4px; padding: 6px; font-size: 10px; color: black; }
        .mini-label-card .name { font-weight: 900; font-size: 11px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .mini-label-card .spec { color: #666; font-size: 9px; }
        .mini-label-card .loc { font-weight: 900; font-size: 12px; color: #2563eb; }
        .mini-label-card .qty { font-weight: 900; font-size: 14px; color: #dc2626; text-align: right; }

        @media print { body * { visibility: hidden; } #print-area, #print-area * { visibility: visible; } #print-area { position: absolute; left: 0; top: 0; width: 100%; } .print-page { page-break-after: always; width: 100mm; height: 148mm; border: 3px solid black; padding: 15px; margin: 0 auto; color: black !important; background: white !important; display: flex; flex-direction: column; } .print-header { text-align: center; font-size: 24px; font-weight: 900; border-bottom: 2px solid black; padding-bottom: 10px; margin-bottom: 20px; } .print-row { display: flex; justify-content: space-between; margin-bottom: 15px; border-bottom: 1px dashed #ccc; padding-bottom: 5px; } .print-label { font-size: 14px; color: #333; font-weight: bold; } .print-val { font-size: 18px; font-weight: bold; text-align: right; } .print-big { font-size: 32px; font-weight: 900; } .print-footer { margin-top: auto; text-align: center; } }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <div id="view-login" class="fixed inset-0 z-50 bg-gradient-to-br from-slate-900 via-slate-800 to-blue-900 flex flex-col items-center justify-center p-6">
        <div class="w-full max-w-md space-y-6 text-center">
            <div class="mb-8">
                <i class="fa-solid fa-warehouse text-blue-500 text-6xl mb-4"></i>
                <h1 class="text-4xl font-black text-white">TERRY <span class="text-blue-400">WMS</span></h1>
                <p class="text-slate-400 mt-2">å€‰å„²ç®¡ç†ç³»çµ± v8.7.0</p>
            </div>
            <div class="bg-slate-800/50 border border-slate-700 rounded-2xl p-6 space-y-4">
                <div class="text-left">
                    <label class="text-slate-400 text-sm mb-1 block">å¸³è™Ÿ (Email)</label>
                    <input type="email" id="login-email" value="admin@bafang.com" class="scan-input text-lg w-full" placeholder="your@email.com">
                </div>
                <div class="text-left">
                    <label class="text-slate-400 text-sm mb-1 block">å¯†ç¢¼</label>
                    <input type="password" id="login-pwd" value="123456" class="scan-input text-lg w-full" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                </div>
                <div id="login-error" class="text-red-400 text-sm hidden"></div>
                <button onclick="loginSystem()" id="btn-login" class="w-full py-4 bg-blue-600 hover:bg-blue-500 text-white rounded-xl font-bold shadow-lg text-lg transition-all hover:scale-[1.02]">
                    <i class="fa-solid fa-right-to-bracket mr-2"></i>ç™»å…¥ç³»çµ±
                </button>
            </div>
            <p class="text-slate-500 text-xs">Â© 2024 Terry WMS. All rights reserved.</p>
        </div>
    </div>

    <div id="modal-level-select" class="fixed inset-0 z-40 bg-black/80 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-slate-900 border border-slate-700 p-8 rounded-2xl w-96 shadow-2xl">
            <div id="loc-select-physical" class="hidden">
                <h3 class="text-xl font-bold text-white mb-2 text-center">é¸æ“‡å…¥åº«å±¤æ•¸</h3>
                <p class="text-sm text-slate-400 mb-6 text-center font-mono" id="modal-lane-title">I-A ç¬¬ 1 è¡Œ</p>
                <div class="space-y-3">
                    <button id="btn-level-3f" onclick="selectLevel('3F')" class="level-btn">3F (8æ¿)</button>
                    <button id="btn-level-2f" onclick="selectLevel('2F')" class="level-btn">2F (5æ¿)</button>
                    <button id="btn-level-1f" onclick="selectLevel('1F')" class="level-btn level-btn-active relative">1F (æŒ‘é«˜ 16æ¿) <span class="absolute top-2 right-3 text-xs text-yellow-400 bg-yellow-900/50 px-1 rounded">æ•£è²¨</span></button>
                </div>
            </div>
            <div id="loc-select-virtual" class="hidden">
                <h3 class="text-xl font-bold text-white mb-4 text-center">é¸æ“‡è™›æ“¬å€‰åº«</h3>
                <div class="grid grid-cols-2 gap-3 mb-4" id="virtual-grid"></div>
                <div class="border-t border-slate-700 pt-4"><input type="text" id="new-virtual-name" class="scan-input text-sm mb-2" placeholder="æ–°è™›æ“¬åº«åç¨±..."><button onclick="addNewVirtualLoc()" class="w-full py-2 bg-emerald-600 hover:bg-emerald-500 rounded text-white text-sm font-bold">æ–°å¢è‡ªè¨‚åº«</button></div>
            </div>
            <button onclick="closeLocModal()" class="mt-6 w-full text-slate-500 text-sm hover:text-white">å–æ¶ˆ</button>
        </div>
    </div>

    <div id="modal-analytics" class="fixed inset-0 z-40 bg-black/90 hidden flex flex-col p-6 backdrop-blur-sm"><div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold text-white" id="analytics-title">è©³ç´°åˆ†æ</h2><button onclick="closeAnalytics()" class="text-slate-400 hover:text-white"><i class="fa-solid fa-xmark text-2xl"></i></button></div><div class="flex gap-4 mb-4 bg-slate-800 p-4 rounded border border-slate-700"><input type="text" class="scan-input w-48" placeholder="ğŸ” ç”¢å“/æ‰¹è™Ÿ"><input type="text" class="scan-input w-48" placeholder="ğŸ¢ å®¢æˆ¶åç¨±"><input type="text" class="scan-input w-48" placeholder="ğŸš› ç‰©æµå•†"><div class="flex items-center gap-2 text-slate-400 text-sm"><span>å‡ºè²¨æ—¥:</span><input type="date" class="scan-input w-32"><span>è‡³</span><input type="date" class="scan-input w-32"></div><button class="bg-blue-600 hover:bg-blue-500 text-white px-4 rounded font-bold ml-auto">æœå°‹</button></div><div class="flex-1 glass-panel overflow-auto"><table class="w-full dense-table text-left"><thead><tr><th>å–®è™Ÿ</th><th>å“åè¦æ ¼</th><th>æ‰¹è™Ÿ</th><th>æ•¸é‡</th><th>å®¢æˆ¶</th><th>ç‰©æµ</th><th>ç‹€æ…‹</th><th>å‚™è²¨æ—¥</th></tr></thead><tbody id="analytics-tbody"></tbody></table></div></div>

    <aside class="w-56 bg-slate-900 border-r border-slate-800 flex flex-col shrink-0 z-20">
        <div class="h-14 flex items-center px-4 border-b border-slate-800">
            <i class="fa-solid fa-cube text-blue-500 text-xl mr-2"></i>
            <div>
                <span class="font-black text-lg text-white tracking-wide">TERRY WMS</span>
                <span class="text-[10px] text-slate-500 ml-1">v9.2.0</span>
            </div>
        </div>
        <nav class="flex-1 overflow-y-auto py-1" id="main-nav">
            <!-- æ•¸ä½å€‰åº« -->
            <div class="nav-group-header" onclick="toggleNavGroup('grp-warehouse-view')">
                <span><i class="fa-solid fa-map-location-dot w-4 text-center mr-1 text-cyan-400"></i>æ•¸ä½å€‰åº«</span>
                <i class="fa-solid fa-chevron-down nav-chevron"></i>
            </div>
            <div class="nav-group-items" id="grp-warehouse-view">
                <div class="nav-item active" onclick="switchTab('visual-map', event)"><i class="fa-solid fa-map w-4 text-center mr-2"></i>å€‰åº«åœ°åœ–</div>
                <div class="nav-item" onclick="switchTab('inventory-query', event)"><i class="fa-solid fa-magnifying-glass w-4 text-center mr-2"></i>åº«å­˜æŸ¥è©¢</div>
            </div>

            <div class="nav-item" onclick="switchTab('dashboard', event)"><i class="fa-solid fa-chart-pie w-5 text-center mr-2"></i> æˆ°æƒ…åˆ†æ</div>
            <div class="nav-item" onclick="switchTab('work-board', event)"><i class="fa-solid fa-tv w-5 text-center mr-2 text-yellow-400"></i> å·¥å–®çœ‹æ¿</div>

            <!-- å…¥åº«ç®¡ç† -->
            <div class="nav-group-header" onclick="toggleNavGroup('grp-inbound')">
                <span><i class="fa-solid fa-arrow-down w-4 text-center mr-1 text-emerald-400"></i>å…¥åº«ç®¡ç†</span>
                <i class="fa-solid fa-chevron-down nav-chevron"></i>
            </div>
            <div class="nav-group-items" id="grp-inbound">
                <div class="nav-item" onclick="switchTab('unified-inbound', event)"><i class="fa-solid fa-bolt w-4 text-center mr-2"></i>æ™ºèƒ½å…¥åº«ä¸­å¿ƒ</div>
                <div class="nav-item" onclick="switchTab('pre-inbound', event)"><i class="fa-solid fa-container-storage w-4 text-center mr-2 text-cyan-400"></i>è²¨æ«ƒå…¥åº«ä½œæ¥­</div>
                <div class="nav-item" onclick="switchTab('approval', event)" id="nav-approval"><i class="fa-solid fa-clipboard-check w-4 text-center mr-2 text-yellow-400"></i>å¾…è²¡å‹™æ ¸å‡† <span id="approval-count" class="ml-auto bg-yellow-500 text-black text-xs px-1.5 rounded-full">0</span></div>
            </div>

            <!-- å‡ºåº«ç®¡ç† -->
            <div class="nav-group-header" onclick="toggleNavGroup('grp-outbound')">
                <span><i class="fa-solid fa-arrow-up w-4 text-center mr-1 text-red-400"></i>å‡ºåº«ç®¡ç†</span>
                <i class="fa-solid fa-chevron-down nav-chevron"></i>
            </div>
            <div class="nav-group-items" id="grp-outbound">
                <div class="nav-item" onclick="switchTab('wave-picking', event)"><i class="fa-solid fa-layer-group w-4 text-center mr-2 text-orange-400"></i>æ³¢æ¬¡æ€è²¨</div>
                <div class="nav-item" onclick="switchTab('picking-rm', event)"><i class="fa-solid fa-fish w-4 text-center mr-2"></i>åŸæ–™é ˜ç”¨</div>
                <div class="nav-item" onclick="switchTab('shipping', event)" style="display:none"><i class="fa-solid fa-truck-ramp-box w-4 text-center mr-2"></i>è¨‚å–®å‡ºè²¨</div>
            </div>

            <!-- åº«å­˜ç•°å‹•ä½œæ¥­ -->
            <div class="nav-group-header" onclick="toggleNavGroup('grp-warehouse')">
                <span><i class="fa-solid fa-warehouse w-4 text-center mr-1 text-blue-400"></i>åº«å­˜ç•°å‹•ä½œæ¥­</span>
                <i class="fa-solid fa-chevron-down nav-chevron"></i>
            </div>
            <div class="nav-group-items" id="grp-warehouse">
                <div class="nav-item" onclick="switchTab('move', event)"><i class="fa-solid fa-layer-group w-4 text-center mr-2"></i>æ™ºèƒ½èª¿åº¦</div>
                <div class="nav-item" onclick="switchTab('merge', event)"><i class="fa-solid fa-arrows-turn-to-dots w-4 text-center mr-2"></i>æ¿è™Ÿç•°å‹•</div>
                <div class="nav-item" onclick="switchTab('transfer', event)"><i class="fa-solid fa-right-left w-4 text-center mr-2"></i>å€‰åº«èª¿æ’¥</div>
                <div class="nav-item" onclick="switchTab('stocktake', event)"><i class="fa-solid fa-clipboard-check w-4 text-center mr-2"></i>åº«å­˜ç›¤é»</div>
            </div>

            <!-- å¤–éƒ¨å€‰åº« -->
            <div class="nav-group-header" onclick="toggleNavGroup('grp-external')">
                <span><i class="fa-solid fa-building w-4 text-center mr-1 text-purple-400"></i>å¤–éƒ¨å€‰åº«</span>
                <i class="fa-solid fa-chevron-down nav-chevron"></i>
            </div>
            <div class="nav-group-items collapsed" id="grp-external">
                <div class="nav-item" onclick="switchTab('external-warehouse', event)"><i class="fa-solid fa-building w-4 text-center mr-2"></i>å¤–å€‰ç®¡ç†</div>
            </div>

            <!-- ç†è²¨å ±è¡¨ -->
            <div class="nav-group-header" onclick="toggleNavGroup('grp-reports')">
                <span><i class="fa-solid fa-chart-line w-4 text-center mr-1 text-orange-400"></i>ç†è²¨å ±è¡¨</span>
                <i class="fa-solid fa-chevron-down nav-chevron"></i>
            </div>
            <div class="nav-group-items collapsed" id="grp-reports">
                <div class="nav-item" onclick="switchTab('picking-reports', event)"><i class="fa-solid fa-file-export w-4 text-center mr-2 text-green-400"></i>ğŸ“Š å ±è¡¨åŒ¯å‡º</div>
                <div class="nav-item" onclick="switchTab('expiry-management', event)"><i class="fa-solid fa-calendar-xmark w-4 text-center mr-2 text-red-400"></i>æ•ˆæœŸç®¡ç†</div>
                <div class="nav-item" onclick="switchTab('inventory-log', event)"><i class="fa-solid fa-clock-rotate-left w-4 text-center mr-2"></i>ç•°å‹•æŸ¥è©¢</div>
                <div class="nav-item" onclick="switchTab('product-analysis', event)"><i class="fa-solid fa-chart-bar w-4 text-center mr-2"></i>å‡ºè²¨åˆ†æ</div>
                <div class="nav-item" onclick="switchTab('warehouse-heatmap', event)"><i class="fa-solid fa-fire w-4 text-center mr-2"></i>ç†±åŠ›åœ–</div>
            </div>

            <!-- å€‰ç§Ÿç®¡ç† -->
            <div class="nav-group-header" onclick="toggleNavGroup('grp-rental')">
                <span><i class="fa-solid fa-dollar-sign w-4 text-center mr-1 text-yellow-400"></i>å€‰ç§Ÿç®¡ç†</span>
                <i class="fa-solid fa-chevron-down nav-chevron"></i>
            </div>
            <div class="nav-group-items" id="grp-rental">
                <div class="nav-item" onclick="switchTab('consignment', event)"><i class="fa-solid fa-box-archive w-4 text-center mr-2 text-amber-400"></i>å¯„å€‰ç®¡ç†</div>
                <div class="nav-item" onclick="switchTab('rental-report', event)"><i class="fa-solid fa-file-invoice-dollar w-4 text-center mr-2 text-emerald-400"></i>å€‰ç§Ÿå ±è¡¨</div>
                <div class="nav-item" onclick="switchTab('rental-settings', event)"><i class="fa-solid fa-sliders w-4 text-center mr-2 text-blue-400"></i>è²»ç‡è¨­å®š</div>
            </div>

            <!-- ç³»çµ±è¨­å®š -->
            <div class="nav-group-header" onclick="toggleNavGroup('grp-settings')">
                <span><i class="fa-solid fa-gear w-4 text-center mr-1 text-slate-400"></i>ç³»çµ±è¨­å®š</span>
                <i class="fa-solid fa-chevron-down nav-chevron"></i>
            </div>
            <div class="nav-group-items" id="grp-settings">
                <div class="nav-item" onclick="switchTab('user-management', event)"><i class="fa-solid fa-users-gear w-4 text-center mr-2 text-blue-400"></i>ä½¿ç”¨è€…ç®¡ç†</div>
                <div class="nav-item" onclick="switchTab('product-master', event)"><i class="fa-solid fa-box w-4 text-center mr-2"></i>å“é …ä¸»æª”</div>
                <div class="nav-item" onclick="switchTab('label-print', event)"><i class="fa-solid fa-print w-4 text-center mr-2 text-purple-400"></i>æ¨™ç±¤åˆ—å°</div>
                <div class="nav-item" onclick="switchTab('data-import', event)"><i class="fa-solid fa-file-import w-4 text-center mr-2 text-amber-400"></i>è³‡æ–™åŒ¯å…¥</div>
            </div>
        </nav>
        <!-- ç‰ˆæœ¬è³‡è¨Š -->
        <div class="p-3 border-t border-slate-800 text-center">
            <div class="text-[10px] text-slate-600">Version 9.2.0 | 2024-12-12</div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col min-w-0 bg-slate-900">
        <header class="h-16 border-b border-slate-800 flex items-center justify-between px-6 bg-slate-900 shrink-0">
            <h2 class="text-xl font-bold text-white" id="page-title">æ•¸ä½å€‰åº«ç›£æ§</h2>
            <div class="flex gap-3 items-center">
                <div class="flex items-center gap-2 px-3 py-1.5 bg-slate-800 rounded-lg border border-slate-700">
                    <i class="fa-solid fa-user-circle text-blue-400"></i>
                    <span class="text-sm text-white font-medium" id="current-user-name">è¼‰å…¥ä¸­...</span>
                    <span class="text-xs px-2 py-0.5 rounded-full" id="current-user-role-badge">-</span>
                </div>
                <button onclick="logoutSystem()" class="px-3 py-1.5 bg-red-600/20 hover:bg-red-600/40 text-red-400 hover:text-red-300 rounded-lg text-sm transition-colors" title="ç™»å‡º">
                    <i class="fa-solid fa-power-off mr-1"></i>ç™»å‡º
                </button>
            </div>
        </header>

        <div class="flex-1 overflow-hidden relative">

            <div id="view-visual-map" class="view-panel h-full flex flex-col">
                <div class="h-10 bg-slate-800/50 border-b border-slate-800 flex items-center px-4 gap-6 text-xs text-slate-400 shrink-0">
                    <span class="text-emerald-400"><i class="fa-solid fa-info-circle mr-1"></i>å®¹ç©èªªæ˜ï¼š</span>
                    <div class="flex items-center gap-1"><div class="w-3 h-3 bg-[#10b981] rounded-sm"></div> ä½ (<50%)</div>
                    <div class="flex items-center gap-1"><div class="w-3 h-3 bg-[#3b82f6] rounded-sm"></div> ä¸­ (50-99%)</div>
                    <div class="flex items-center gap-1"><div class="w-3 h-3 bg-[#ef4444] rounded-sm"></div> é«˜ (100%/æ»¿)</div>
                    <span class="ml-auto text-blue-400">é»æ“Šè»Œé“æŸ¥çœ‹è©³æƒ…</span>
                </div>
                <div class="warehouse-new-layout">
                    <!-- å·¦å´å€åŸŸï¼šIåº« + Jåº« (ä¸Šå±¤) + Kåº« (ä¸‹å±¤) -->
                    <div class="warehouse-left-area">
                        <!-- ä¸Šå±¤ï¼šIåº« + Jåº« ä¸¦æ’ -->
                        <div class="warehouse-ij-row">
                            <!-- I åº« (A/B ä¸Šä¸‹æ’åˆ—) -->
                            <div class="warehouse-building-ij">
                                <div class="building-label bg-blue-600">I åº« (åŸæ–™/é¤˜æ–™)</div>
                                <div class="zones-stack">
                                    <div class="zone-row-item">
                                        <div class="zone-label">A</div>
                                        <div class="rack-lanes-8" id="grid-I-A"></div>
                                    </div>
                                    <div class="zone-row-item">
                                        <div class="zone-label bg-indigo-600">B</div>
                                        <div class="rack-lanes-8" id="grid-I-B"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- J åº« (C/D ä¸Šä¸‹æ’åˆ—) -->
                            <div class="warehouse-building-ij">
                                <div class="building-label bg-purple-600">J åº« (æˆå“/åŠæˆå“)</div>
                                <div class="zones-stack">
                                    <div class="zone-row-item">
                                        <div class="zone-label bg-purple-600">C</div>
                                        <div class="rack-lanes-8" id="grid-J-C"></div>
                                    </div>
                                    <div class="zone-row-item">
                                        <div class="zone-label bg-pink-600">D</div>
                                        <div class="rack-lanes-8" id="grid-J-D"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ä¸‹å±¤ï¼šKåº« (E/F/G/H ä¸Šä¸‹æ’åˆ—ï¼Œæ¯åˆ—22å··é“) -->
                        <div class="warehouse-k-area">
                            <div class="warehouse-building-k">
                                <div class="building-label bg-emerald-600">K åº«</div>
                                <div class="zones-stack-k">
                                    <div class="zone-row-item-k">
                                        <div class="zone-label bg-emerald-600">E</div>
                                        <div class="rack-lanes-22" id="grid-K-E"></div>
                                    </div>
                                    <div class="zone-row-item-k">
                                        <div class="zone-label bg-teal-600">F</div>
                                        <div class="rack-lanes-22" id="grid-K-F"></div>
                                    </div>
                                    <div class="zone-row-item-k">
                                        <div class="zone-label bg-cyan-600">G</div>
                                        <div class="rack-lanes-22" id="grid-K-G"></div>
                                    </div>
                                    <div class="zone-row-item-k">
                                        <div class="zone-label bg-sky-600">H</div>
                                        <div class="rack-lanes-22" id="grid-K-H"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æš«å­˜å€ç›£æ§å€å¡Š -->
                <div class="shrink-0 border-t border-slate-700 bg-slate-900/50 p-3">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-white font-bold text-sm">
                            <i class="fa-solid fa-boxes-stacked mr-2 text-amber-400"></i>æš«å­˜å€ç›£æ§
                        </h3>
                        <span class="text-xs text-slate-500">æ»‘é¼ æ‡¸åœæŸ¥çœ‹è©³æƒ…</span>
                    </div>
                    <div class="grid grid-cols-11 gap-2" id="virtual-locations-grid">
                        <!-- é€²è²¨æš«å­˜å€ -->
                        <div class="virtual-loc-card bg-emerald-900/40 border border-emerald-600/50 hover:border-emerald-400"
                             onmouseenter="showVirtualLocTooltip(event, 'TEMP-IN')" onmousemove="moveHoverTooltip(event)" onmouseleave="hideHoverTooltip()" title="é€²è²¨æš«å­˜å€">
                            <div class="text-emerald-400 text-[10px] font-bold">TEMP-IN</div>
                            <div class="text-xl font-black text-white" id="vl-count-TEMP-IN">0</div>
                            <div class="text-[10px] text-emerald-300">é€²è²¨æš«å­˜</div>
                        </div>
                        <!-- å‡ºè²¨æš«å­˜å€ -->
                        <div class="virtual-loc-card bg-orange-900/40 border border-orange-600/50 hover:border-orange-400"
                             onmouseenter="showVirtualLocTooltip(event, 'TEMP-OUT')" onmousemove="moveHoverTooltip(event)" onmouseleave="hideHoverTooltip()" title="å‡ºè²¨æš«å­˜å€">
                            <div class="text-orange-400 text-[10px] font-bold">TEMP-OUT</div>
                            <div class="text-xl font-black text-white" id="vl-count-TEMP-OUT">0</div>
                            <div class="text-[10px] text-orange-300">å‡ºè²¨æš«å­˜</div>
                        </div>
                        <!-- Aå€å‰ç«¯ -->
                        <div class="virtual-loc-card bg-blue-900/40 border border-blue-600/50 hover:border-blue-400"
                             onmouseenter="showVirtualLocTooltip(event, 'A00')" onmousemove="moveHoverTooltip(event)" onmouseleave="hideHoverTooltip()" title="Aå€è²¨æ¶å‰ç«¯">
                            <div class="text-blue-400 text-[10px] font-bold">A00</div>
                            <div class="text-xl font-black text-white" id="vl-count-A00">0</div>
                            <div class="text-[10px] text-blue-300">Aå€å‰ç«¯</div>
                        </div>
                        <!-- Aå€æœ«ç«¯ -->
                        <div class="virtual-loc-card bg-blue-900/40 border border-blue-600/50 hover:border-blue-400"
                             onmouseenter="showVirtualLocTooltip(event, 'A99')" onmousemove="moveHoverTooltip(event)" onmouseleave="hideHoverTooltip()" title="Aå€è²¨æ¶æœ«ç«¯">
                            <div class="text-blue-400 text-[10px] font-bold">A99</div>
                            <div class="text-xl font-black text-white" id="vl-count-A99">0</div>
                            <div class="text-[10px] text-blue-300">Aå€æœ«ç«¯</div>
                        </div>
                        <!-- Bå€å‰ç«¯ -->
                        <div class="virtual-loc-card bg-indigo-900/40 border border-indigo-600/50 hover:border-indigo-400"
                             onmouseenter="showVirtualLocTooltip(event, 'B00')" onmousemove="moveHoverTooltip(event)" onmouseleave="hideHoverTooltip()" title="Bå€è²¨æ¶å‰ç«¯">
                            <div class="text-indigo-400 text-[10px] font-bold">B00</div>
                            <div class="text-xl font-black text-white" id="vl-count-B00">0</div>
                            <div class="text-[10px] text-indigo-300">Bå€å‰ç«¯</div>
                        </div>
                        <!-- Bå€æœ«ç«¯ -->
                        <div class="virtual-loc-card bg-indigo-900/40 border border-indigo-600/50 hover:border-indigo-400"
                             onmouseenter="showVirtualLocTooltip(event, 'B99')" onmousemove="moveHoverTooltip(event)" onmouseleave="hideHoverTooltip()" title="Bå€è²¨æ¶æœ«ç«¯">
                            <div class="text-indigo-400 text-[10px] font-bold">B99</div>
                            <div class="text-xl font-black text-white" id="vl-count-B99">0</div>
                            <div class="text-[10px] text-indigo-300">Bå€æœ«ç«¯</div>
                        </div>
                        <!-- Cå€å‰ç«¯ -->
                        <div class="virtual-loc-card bg-purple-900/40 border border-purple-600/50 hover:border-purple-400"
                             onmouseenter="showVirtualLocTooltip(event, 'C00')" onmousemove="moveHoverTooltip(event)" onmouseleave="hideHoverTooltip()" title="Cå€è²¨æ¶å‰ç«¯">
                            <div class="text-purple-400 text-[10px] font-bold">C00</div>
                            <div class="text-xl font-black text-white" id="vl-count-C00">0</div>
                            <div class="text-[10px] text-purple-300">Cå€å‰ç«¯</div>
                        </div>
                        <!-- Cå€æœ«ç«¯ -->
                        <div class="virtual-loc-card bg-purple-900/40 border border-purple-600/50 hover:border-purple-400"
                             onmouseenter="showVirtualLocTooltip(event, 'C99')" onmousemove="moveHoverTooltip(event)" onmouseleave="hideHoverTooltip()" title="Cå€è²¨æ¶æœ«ç«¯">
                            <div class="text-purple-400 text-[10px] font-bold">C99</div>
                            <div class="text-xl font-black text-white" id="vl-count-C99">0</div>
                            <div class="text-[10px] text-purple-300">Cå€æœ«ç«¯</div>
                        </div>
                        <!-- Då€å‰ç«¯ -->
                        <div class="virtual-loc-card bg-pink-900/40 border border-pink-600/50 hover:border-pink-400"
                             onmouseenter="showVirtualLocTooltip(event, 'D00')" onmousemove="moveHoverTooltip(event)" onmouseleave="hideHoverTooltip()" title="Då€è²¨æ¶å‰ç«¯">
                            <div class="text-pink-400 text-[10px] font-bold">D00</div>
                            <div class="text-xl font-black text-white" id="vl-count-D00">0</div>
                            <div class="text-[10px] text-pink-300">Då€å‰ç«¯</div>
                        </div>
                        <!-- Då€æœ«ç«¯ -->
                        <div class="virtual-loc-card bg-pink-900/40 border border-pink-600/50 hover:border-pink-400"
                             onmouseenter="showVirtualLocTooltip(event, 'D99')" onmousemove="moveHoverTooltip(event)" onmouseleave="hideHoverTooltip()" title="Då€è²¨æ¶æœ«ç«¯">
                            <div class="text-pink-400 text-[10px] font-bold">D99</div>
                            <div class="text-xl font-black text-white" id="vl-count-D99">0</div>
                            <div class="text-[10px] text-pink-300">Då€æœ«ç«¯</div>
                        </div>
                        <!-- å…¶ä»– -->
                        <div class="virtual-loc-card bg-slate-800/60 border border-slate-600/50 hover:border-slate-400"
                             onmouseenter="showVirtualLocTooltip(event, 'OTHER')" onmousemove="moveHoverTooltip(event)" onmouseleave="hideHoverTooltip()" title="å…¶ä»–ä½ç½®">
                            <div class="text-slate-400 text-[10px] font-bold">OTHER</div>
                            <div class="text-xl font-black text-white" id="vl-count-OTHER">0</div>
                            <div class="text-[10px] text-slate-400">å…¶ä»–ä½ç½®</div>
                        </div>
                    </div>
                </div>

                <!-- Hover æµ®å‹•æç¤ºå¡ç‰‡ -->
                <div id="hover-tooltip" class="hover-tooltip hidden">
                    <div class="tooltip-header">
                        <span class="tooltip-title" id="tooltip-title">I-A ç¬¬ 1 å··</span>
                        <span class="tooltip-badge" id="tooltip-badge">ç©ºä½: 12</span>
                    </div>
                    <div class="tooltip-body" id="tooltip-body"></div>
                </div>
            </div>

            <div id="view-dashboard" class="view-panel h-full hidden flex flex-col p-4 overflow-y-auto">
                <!-- é ‚éƒ¨ KPI å¡ç‰‡ -->
                <div class="grid grid-cols-5 gap-3 mb-4">
                    <div class="glass-panel kpi-card p-4 border-l-4 border-blue-500" onclick="openAnalytics('Total')">
                        <div class="text-slate-400 text-xs">ç¸½åº«å­˜ (æ¿)</div>
                        <div class="text-2xl font-bold text-white mt-1" id="kpi-total-pallets">0</div>
                    </div>
                    <div class="glass-panel kpi-card p-4 border-l-4 border-emerald-500">
                        <div class="text-slate-400 text-xs">å´‡æ–‡åº«å­˜</div>
                        <div class="text-2xl font-bold text-emerald-400 mt-1" id="kpi-cw-count">0</div>
                    </div>
                    <div class="glass-panel kpi-card p-4 border-l-4 border-cyan-500">
                        <div class="text-slate-400 text-xs">å…«æ–¹åº«å­˜</div>
                        <div class="text-2xl font-bold text-cyan-400 mt-1" id="kpi-bf-count">0</div>
                    </div>
                    <div class="glass-panel kpi-card p-4 border-l-4 border-amber-500">
                        <div class="text-slate-400 text-xs">æš«å­˜å€</div>
                        <div class="text-2xl font-bold text-amber-400 mt-1" id="kpi-virtual-count">0</div>
                    </div>
                    <div class="glass-panel kpi-card p-4 border-l-4 border-red-500" onclick="switchTab('expiry-management', event)">
                        <div class="text-slate-400 text-xs">æ•ˆæœŸè­¦ç¤º</div>
                        <div class="text-2xl font-bold text-red-400 mt-1" id="kpi-expiry-alert">0</div>
                    </div>
                </div>

                <!-- ä¸­é–“åœ–è¡¨å€ -->
                <div class="grid grid-cols-3 gap-4 mb-4">
                    <!-- å€‰åº«åˆ†å¸ƒåœ“é¤…åœ– -->
                    <div class="glass-panel p-4">
                        <h3 class="text-white font-bold text-sm mb-3"><i class="fa-solid fa-warehouse mr-2 text-blue-400"></i>å€‰åº«åˆ†å¸ƒ</h3>
                        <div class="h-48 flex items-center justify-center">
                            <canvas id="stockChart" style="max-height: 180px; max-width: 180px;"></canvas>
                        </div>
                    </div>

                    <!-- å…¬å¸åˆ†å¸ƒåœ“é¤…åœ– -->
                    <div class="glass-panel p-4">
                        <h3 class="text-white font-bold text-sm mb-3"><i class="fa-solid fa-building mr-2 text-emerald-400"></i>å…¬å¸åˆ†å¸ƒ</h3>
                        <div class="h-48 flex items-center justify-center">
                            <canvas id="companyChart" style="max-height: 180px; max-width: 180px;"></canvas>
                        </div>
                    </div>

                    <!-- æ•ˆæœŸåˆ†å¸ƒ -->
                    <div class="glass-panel p-4">
                        <h3 class="text-white font-bold text-sm mb-3"><i class="fa-solid fa-clock mr-2 text-orange-400"></i>æ•ˆæœŸåˆ†å¸ƒ</h3>
                        <div class="h-48 flex items-center justify-center">
                            <canvas id="expiryChart" style="max-height: 180px; max-width: 180px;"></canvas>
                        </div>
                    </div>
                </div>

                <!-- åº•éƒ¨è©³æƒ…å€ -->
                <div class="grid grid-cols-2 gap-4 flex-1 min-h-0">
                    <!-- å„å€‰åº«åº«å­˜æ˜ç´° -->
                    <div class="glass-panel p-4 flex flex-col overflow-hidden">
                        <h3 class="text-white font-bold text-sm mb-3"><i class="fa-solid fa-boxes-stacked mr-2 text-purple-400"></i>å„å€åº«å­˜çµ±è¨ˆ</h3>
                        <div class="flex-1 overflow-y-auto">
                            <table class="w-full text-sm">
                                <thead>
                                    <tr class="text-slate-400 border-b border-slate-700">
                                        <th class="text-left p-2">å€åŸŸ</th>
                                        <th class="text-right p-2">æ£§æ¿æ•¸</th>
                                        <th class="text-right p-2">ä½¿ç”¨ç‡</th>
                                    </tr>
                                </thead>
                                <tbody id="zone-stats-body">
                                    <tr><td colspan="3" class="text-center text-slate-500 py-4">è¼‰å…¥ä¸­...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- è¿‘æœŸæ•ˆæœŸå“é … -->
                    <div class="glass-panel p-4 flex flex-col overflow-hidden">
                        <h3 class="text-white font-bold text-sm mb-3"><i class="fa-solid fa-triangle-exclamation mr-2 text-red-400"></i>æ•ˆæœŸè­¦ç¤ºå“é … (30å¤©å…§)</h3>
                        <div class="flex-1 overflow-y-auto">
                            <table class="w-full text-sm">
                                <thead>
                                    <tr class="text-slate-400 border-b border-slate-700">
                                        <th class="text-left p-2">å“å</th>
                                        <th class="text-left p-2">å„²ä½</th>
                                        <th class="text-right p-2">æ•¸é‡</th>
                                        <th class="text-left p-2">æ•ˆæœŸ</th>
                                    </tr>
                                </thead>
                                <tbody id="expiry-alert-body">
                                    <tr><td colspan="4" class="text-center text-slate-500 py-4">è¼‰å…¥ä¸­...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å·¥å–®çœ‹æ¿ï¼ˆé›»è¦–è¢å¹•æŠ•æ”¾ç”¨ï¼‰-->
            <div id="view-work-board" class="view-panel h-full hidden flex flex-col p-4 bg-slate-950">
                <!-- é ‚éƒ¨æ§åˆ¶åˆ— -->
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center gap-4">
                        <h1 class="text-3xl font-bold text-white"><i class="fa-solid fa-clipboard-list mr-3 text-yellow-400"></i>å·¥å–®çœ‹æ¿</h1>
                        <span id="board-update-time" class="text-slate-400 text-lg"></span>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="openTVBoard()" class="px-4 py-2 bg-red-600 hover:bg-red-500 text-white rounded-lg font-bold">
                            <i class="fa-solid fa-tv mr-2"></i>é›»è¦–æŠ•æ”¾
                        </button>
                        <button onclick="refreshWorkBoard()" class="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-bold">
                            <i class="fa-solid fa-sync mr-2"></i>åˆ·æ–°
                        </button>
                        <button onclick="toggleBoardFullscreen()" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg font-bold">
                            <i class="fa-solid fa-expand mr-2"></i>å…¨è¢å¹•
                        </button>
                        <select id="board-refresh-interval" class="px-3 py-2 bg-slate-800 border border-slate-600 rounded-lg text-white" onchange="setBoardRefreshInterval()">
                            <option value="0">æ‰‹å‹•åˆ·æ–°</option>
                            <option value="10">10 ç§’</option>
                            <option value="30" selected>30 ç§’</option>
                            <option value="60">1 åˆ†é˜</option>
                            <option value="300">5 åˆ†é˜</option>
                        </select>
                    </div>
                </div>
                
                <!-- å·¥å–®çµ±è¨ˆæ‘˜è¦ -->
                <div class="grid grid-cols-5 gap-4 mb-4">
                    <div class="bg-gradient-to-br from-yellow-600 to-yellow-700 rounded-xl p-4 text-center">
                        <div class="text-5xl font-bold text-white" id="board-pending-count">0</div>
                        <div class="text-yellow-200 text-lg mt-1">å¾…å…¥åº«</div>
                    </div>
                    <div class="bg-gradient-to-br from-orange-600 to-orange-700 rounded-xl p-4 text-center">
                        <div class="text-5xl font-bold text-white" id="board-wave-count">0</div>
                        <div class="text-orange-200 text-lg mt-1">æ€è²¨ä¸­</div>
                    </div>
                    <div class="bg-gradient-to-br from-purple-600 to-purple-700 rounded-xl p-4 text-center">
                        <div class="text-5xl font-bold text-white" id="board-transfer-count">0</div>
                        <div class="text-purple-200 text-lg mt-1">å¾…èª¿æ’¥</div>
                    </div>
                    <div class="bg-gradient-to-br from-cyan-600 to-cyan-700 rounded-xl p-4 text-center">
                        <div class="text-5xl font-bold text-white" id="board-move-count">0</div>
                        <div class="text-cyan-200 text-lg mt-1">å¾…ç§»ä½</div>
                    </div>
                    <div class="bg-gradient-to-br from-red-600 to-red-700 rounded-xl p-4 text-center">
                        <div class="text-5xl font-bold text-white" id="board-urgent-count">0</div>
                        <div class="text-red-200 text-lg mt-1">ç·Šæ€¥</div>
                    </div>
                </div>
                
                <!-- å·¥å–®åˆ—è¡¨å€åŸŸ -->
                <div class="flex-1 grid grid-cols-3 gap-4 overflow-hidden">
                    <!-- å…¥åº«å·¥å–® -->
                    <div class="bg-slate-900 rounded-xl border-2 border-yellow-600 flex flex-col overflow-hidden">
                        <div class="bg-yellow-600 px-4 py-3 flex items-center justify-between">
                            <span class="text-xl font-bold text-white"><i class="fa-solid fa-arrow-down mr-2"></i>å¾…å…¥åº«</span>
                            <span class="bg-yellow-800 px-3 py-1 rounded-full text-white font-bold" id="board-pending-badge">0</span>
                        </div>
                        <div class="flex-1 overflow-y-auto p-3 space-y-2" id="board-pending-list">
                        </div>
                    </div>
                    
                    <!-- æ€è²¨å·¥å–® -->
                    <div class="bg-slate-900 rounded-xl border-2 border-orange-600 flex flex-col overflow-hidden">
                        <div class="bg-orange-600 px-4 py-3 flex items-center justify-between">
                            <span class="text-xl font-bold text-white"><i class="fa-solid fa-dolly mr-2"></i>æ€è²¨ä¸­</span>
                            <span class="bg-orange-800 px-3 py-1 rounded-full text-white font-bold" id="board-wave-badge">0</span>
                        </div>
                        <div class="flex-1 overflow-y-auto p-3 space-y-2" id="board-wave-list">
                        </div>
                    </div>
                    
                    <!-- èª¿æ’¥/ç§»ä½å·¥å–® -->
                    <div class="bg-slate-900 rounded-xl border-2 border-purple-600 flex flex-col overflow-hidden">
                        <div class="bg-purple-600 px-4 py-3 flex items-center justify-between">
                            <span class="text-xl font-bold text-white"><i class="fa-solid fa-right-left mr-2"></i>èª¿æ’¥/ç§»ä½</span>
                            <span class="bg-purple-800 px-3 py-1 rounded-full text-white font-bold" id="board-transfer-badge">0</span>
                        </div>
                        <div class="flex-1 overflow-y-auto p-3 space-y-2" id="board-transfer-list">
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-unified-inbound" class="view-panel h-full hidden flex flex-col p-2">
                <input type="hidden" id="in-category" value="Raw">

                <!-- é ‚éƒ¨æ­¥é©Ÿé€²åº¦æŒ‡ç¤ºå™¨ï¼ˆç²¾ç°¡ç‰ˆï¼‰-->
                <div class="flex items-center justify-center gap-1 mb-2 bg-slate-800/80 rounded-lg py-1.5 px-3">
                    <div id="inbound-step-1" class="flex items-center gap-1.5 px-3 py-1 rounded bg-blue-600 text-white text-sm">
                        <span class="w-5 h-5 rounded-full bg-white text-blue-600 flex items-center justify-center font-bold text-xs">1</span>
                        <span class="font-bold">å¡«å¯«è³‡æ–™</span>
                    </div>
                    <i class="fa-solid fa-chevron-right text-slate-600 text-[10px]"></i>
                    <div id="inbound-step-2" class="flex items-center gap-1.5 px-3 py-1 rounded bg-slate-700 text-slate-400 text-sm">
                        <span class="w-5 h-5 rounded-full bg-slate-600 text-slate-400 flex items-center justify-center font-bold text-xs">2</span>
                        <span>é¸æ“‡å„²ä½</span>
                    </div>
                    <i class="fa-solid fa-chevron-right text-slate-600 text-[10px]"></i>
                    <div id="inbound-step-3" class="flex items-center gap-1.5 px-3 py-1 rounded bg-slate-700 text-slate-400 text-sm">
                        <span class="w-5 h-5 rounded-full bg-slate-600 text-slate-400 flex items-center justify-center font-bold text-xs">3</span>
                        <span>ç¢ºèªå…¥åº«</span>
                    </div>
                    <div class="ml-auto">
                        <button onclick="showPendingInbounds()" class="px-2 py-1 bg-yellow-600 hover:bg-yellow-500 text-white rounded text-xs font-bold">
                            <i class="fa-solid fa-clock mr-1"></i>å¾…åŸ·è¡Œ <span id="pending-inbound-count" class="bg-yellow-800 px-1 rounded">0</span>
                        </button>
                    </div>
                </div>

                <!-- ä¸‰æ­¥é©Ÿä¸»å€åŸŸ -->
                <div class="flex gap-2 flex-1 min-h-0">

                    <!-- STEP 1: ç”¢å“è³‡è¨Šï¼ˆå„ªåŒ–ç‰ˆï¼‰-->
                    <div class="w-80 flex flex-col">
                        <div class="bg-slate-900 border border-slate-600 rounded-lg p-3 flex flex-col h-full overflow-y-auto">

                            <!-- å€å¡Š1: å…¬å¸åˆ¥ -->
                            <div class="mb-3">
                                <div class="text-xs text-slate-500 mb-1.5 flex items-center">
                                    <i class="fa-solid fa-building w-4 text-center mr-1"></i>å…¬å¸åˆ¥
                                </div>
                                <div class="flex gap-1 bg-slate-800 rounded-lg p-1">
                                    <label class="flex-1 cursor-pointer">
                                        <input type="radio" name="in-company" value="å´‡æ–‡" class="hidden peer" checked>
                                        <div class="text-center py-2 rounded-md text-sm font-bold peer-checked:bg-blue-600 peer-checked:text-white text-slate-400 transition-all flex items-center justify-center gap-1">
                                            <span class="w-2 h-2 rounded-full bg-blue-400 peer-checked:bg-white"></span>
                                            å´‡æ–‡
                                        </div>
                                    </label>
                                    <label class="flex-1 cursor-pointer">
                                        <input type="radio" name="in-company" value="å…«æ–¹" class="hidden peer">
                                        <div class="text-center py-2 rounded-md text-sm font-bold peer-checked:bg-purple-600 peer-checked:text-white text-slate-400 transition-all flex items-center justify-center gap-1">
                                            <span class="w-2 h-2 rounded-full bg-purple-400"></span>
                                            å…«æ–¹
                                        </div>
                                    </label>
                                </div>
                            </div>

                            <!-- å€å¡Š2: ç”¢å“è³‡è¨Š -->
                            <div class="mb-3">
                                <div class="text-xs text-slate-500 mb-1.5 flex items-center">
                                    <i class="fa-solid fa-box w-4 text-center mr-1"></i>ç”¢å“è³‡è¨Š
                                </div>
                                <div class="space-y-2">
                                    <!-- å“å -->
                                    <div class="relative">
                                        <input type="text" id="in-name" class="w-full p-2.5 pr-16 bg-slate-800 border-2 border-emerald-500 rounded-lg text-white font-bold" placeholder="é»æ“Šé¸æ“‡å“é …..." oninput="updateLivePreview(); updateInboundProgress();" readonly>
                                        <button onclick="openProductSelectModal('inbound')" class="absolute right-1 top-1/2 -translate-y-1/2 px-3 py-1.5 bg-emerald-600 hover:bg-emerald-500 text-white rounded text-xs font-bold">
                                            <i class="fa-solid fa-search mr-1"></i>é¸æ“‡
                                        </button>
                                    </div>
                                    <input type="hidden" id="in-product-code" value="">
                                    
                                    <!-- è¦æ ¼ -->
                                    <div class="relative">
                                        <span class="absolute left-2 top-1/2 -translate-y-1/2 text-yellow-400 text-[10px]">è¦æ ¼</span>
                                        <input type="text" id="in-spec" class="w-full p-2 pl-10 bg-slate-800 border border-yellow-500/30 rounded text-yellow-400 text-sm" placeholder="è‡ªå‹•å¸¶å…¥" oninput="updateLivePreview();">
                                    </div>
                                </div>
                            </div>

                            <!-- åˆ†éš”ç·š -->
                            <div class="border-t border-slate-700 my-2"></div>

                            <!-- å€å¡Š3: å…¥åº«è³‡æ–™ -->
                            <div class="flex-1">
                                <div class="text-xs text-slate-500 mb-1.5 flex items-center">
                                    <i class="fa-solid fa-clipboard-list w-4 text-center mr-1"></i>å…¥åº«è³‡æ–™
                                </div>
                                <div class="space-y-2">
                                    <!-- æ‰¹è™Ÿ + æ•ˆæœŸ -->
                                    <div class="grid grid-cols-2 gap-2">
                                        <div class="relative">
                                            <span class="absolute left-2 top-1/2 -translate-y-1/2 text-slate-500 text-[10px]">æ‰¹è™Ÿ</span>
                                            <input type="text" id="in-batch" class="w-full p-2 pl-9 bg-slate-800 border border-slate-600 rounded text-white text-sm" oninput="updateLivePreview()">
                                        </div>
                                        <div class="relative">
                                            <span class="absolute left-2 top-1/2 -translate-y-1/2 text-orange-400 text-[10px] font-bold">æ•ˆæœŸ*</span>
                                            <input type="date" id="in-exp" class="w-full p-2 pl-9 bg-slate-800 border border-orange-500/50 rounded text-white text-sm" oninput="updateLivePreview(); updateInboundProgress();">
                                        </div>
                                    </div>

                                    <!-- å“é …é¡å‹æ¨™ç±¤ï¼ˆè‡ªå‹•åˆ¤æ–·ï¼‰-->
                                    <div id="product-type-badge" class="hidden">
                                        <span id="type-badge-label" class="px-2 py-1 rounded text-xs font-bold bg-blue-600/20 text-blue-400 border border-blue-500/30">
                                            ğŸ“¦ å®šé‡å“
                                        </span>
                                        <input type="radio" name="in-product-type" value="fixed" class="hidden" checked>
                                        <input type="radio" name="in-product-type" value="variable" class="hidden">
                                    </div>

                                    <!-- å®šé‡å“ï¼šæ•¸é‡ -->
                                    <div id="fixed-weight-fields">
                                        <div class="relative">
                                            <span class="absolute left-2 top-1/2 -translate-y-1/2 text-cyan-400 text-xs font-bold">æ•¸é‡*</span>
                                            <input type="number" id="in-qty" class="w-full p-2.5 pl-12 pr-10 bg-slate-800 border-2 border-cyan-500/50 rounded-lg text-white text-lg font-bold text-center" placeholder="0" oninput="updateLivePreview(); updateInboundProgress();">
                                            <span class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm">ä»¶</span>
                                        </div>
                                    </div>

                                    <!-- ä¸å®šé‡å“ï¼šæ•¸é‡ + ç¸½é‡é‡ -->
                                    <div id="variable-weight-fields" class="hidden space-y-2">
                                        <div class="grid grid-cols-2 gap-2">
                                            <div class="relative">
                                                <span class="absolute left-2 top-1/2 -translate-y-1/2 text-amber-400 text-[10px] font-bold">æ•¸é‡*</span>
                                                <input type="number" id="in-qty-var" class="w-full p-2 pl-10 pr-6 bg-slate-800 border border-amber-500/50 rounded text-white text-sm font-bold text-center" oninput="updateLivePreview(); updateInboundProgress(); calcAvgWeight();">
                                                <span class="absolute right-2 top-1/2 -translate-y-1/2 text-amber-500 text-[10px]">ä»¶</span>
                                            </div>
                                            <div class="relative">
                                                <span class="absolute left-2 top-1/2 -translate-y-1/2 text-amber-400 text-[10px] font-bold">ç¸½é‡*</span>
                                                <input type="number" id="in-weight" class="w-full p-2 pl-10 pr-6 bg-slate-800 border border-amber-500/50 rounded text-white text-sm font-bold text-center" step="0.1" oninput="updateLivePreview(); calcAvgWeight(); updateInboundProgress();">
                                                <span class="absolute right-2 top-1/2 -translate-y-1/2 text-amber-500 text-[10px]">kg</span>
                                            </div>
                                        </div>
                                        <div id="avg-weight-hint" class="text-[10px] text-amber-400 bg-amber-900/20 rounded px-2 py-1 hidden">
                                            <i class="fa-solid fa-calculator mr-1"></i>å‡é‡ï¼š<span id="avg-weight-value">-</span> kg/ä»¶
                                        </div>
                                    </div>

                                    <!-- æ›´å¤šé¸é … -->
                                    <div class="border-t border-dashed border-slate-700 pt-2 mt-2">
                                        <button onclick="toggleInboundMoreOptions()" id="btn-more-options" class="w-full py-1 text-slate-500 hover:text-slate-300 text-xs flex items-center justify-center gap-1">
                                            <i class="fa-solid fa-chevron-down" id="more-options-icon"></i>
                                            <span id="more-options-text">æ›´å¤šé¸é …</span>
                                        </button>
                                        <div id="more-options-panel" class="hidden mt-2 space-y-2">
                                            <div class="relative">
                                                <span class="absolute left-2 top-1/2 -translate-y-1/2 text-slate-500 text-[10px]">å» å•†</span>
                                                <input type="text" id="in-vendor" class="w-full p-1.5 pl-10 bg-slate-800 border border-slate-600 rounded text-white text-sm" oninput="updateLivePreview()">
                                            </div>
                                            <div id="unit-weight-option" class="relative">
                                                <span class="absolute left-2 top-1/2 -translate-y-1/2 text-slate-500 text-[10px]">ç®±å®¹</span>
                                                <input type="number" id="in-unit-weight" class="w-full p-1.5 pl-10 pr-8 bg-slate-800 border border-slate-600 rounded text-white text-sm" step="0.1" oninput="updateLivePreview();">
                                                <span class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-500 text-[10px]">kg</span>
                                            </div>
                                            <div>
                                                <div class="text-[10px] text-slate-500 mb-1">å…¥åº«é¡å‹</div>
                                                <div class="grid grid-cols-4 gap-1">
                                                    <button type="button" onclick="selectInboundType('Raw')" id="btn-type-Raw" class="inbound-type-btn active py-1 rounded border border-emerald-500 bg-emerald-900/50 text-white text-[10px] font-bold">æ¡è³¼</button>
                                                    <button type="button" onclick="selectInboundType('FG')" id="btn-type-FG" class="inbound-type-btn py-1 rounded border border-slate-600 bg-slate-800 text-slate-400 text-[10px]">æˆå“</button>
                                                    <button type="button" onclick="selectInboundType('WIP')" id="btn-type-WIP" class="inbound-type-btn py-1 rounded border border-slate-600 bg-slate-800 text-slate-400 text-[10px]">åŠæˆå“</button>
                                                    <button type="button" onclick="selectInboundType('Return')" id="btn-type-Return" class="inbound-type-btn py-1 rounded border border-slate-600 bg-slate-800 text-slate-400 text-[10px]">é€€åº«</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ä¸­é–“å€å¡Š: ç›®æ¨™å€‰åº« + å„²ä½é¸æ“‡ -->
                    <div class="flex-1 flex flex-col min-w-0">
                        
                        <!-- ç›®æ¨™å€‰åº«é¸æ“‡ -->
                        <div class="bg-slate-900 border border-slate-600 rounded-lg p-3 mb-2">
                            <div class="text-xs text-slate-500 mb-1.5 flex items-center">
                                <i class="fa-solid fa-warehouse w-4 text-center mr-1"></i>ç›®æ¨™å€‰åº«
                            </div>
                            <select id="in-warehouse" class="w-full p-2 bg-slate-800 border border-slate-600 rounded-md text-white text-sm font-bold" onchange="onWarehouseChange()">
                                <optgroup label="æœ¬å€‰"><option value="MAIN">ğŸ­ ä¸€èˆ¬åº«å­˜</option><option value="MAIN-CONSIGN">ğŸ“¦ å®¢æˆ¶å¯„å€‰</option></optgroup>
                                <optgroup label="å´‡æ–‡å¤–å€‰" id="optgroup-cw"></optgroup>
                                <optgroup label="å…«æ–¹å¤–å€‰" id="optgroup-bf"></optgroup>
                                <optgroup label="â”€â”€"><option value="MANAGE">âš™ï¸ ç®¡ç†å€‰åº«</option></optgroup>
                            </select>
                        </div>
                        
                        <!-- å¤–å€‰æç¤ºå€åŸŸ -->
                        <div id="external-wh-section" class="bg-teal-900/40 border border-teal-500 rounded-lg p-4 flex-1 hidden">
                            <div class="text-teal-400 font-bold text-sm mb-2" id="inbound-wh-title">
                                <i class="fa-solid fa-building mr-1"></i>å¤–å€‰å…¥åº«
                            </div>
                            <div class="flex-1 flex items-center justify-center h-full">
                                <div class="text-center">
                                    <i class="fa-solid fa-building text-5xl text-teal-400 mb-3"></i>
                                    <p class="text-slate-300 text-sm mb-1">å¤–å€‰å…¥åº«ä¸éœ€æŒ‡å®šå„²ä½</p>
                                    <p class="text-slate-500 text-xs">ç³»çµ±å°‡è‡ªå‹•è¨˜éŒ„åˆ°å¤–å€‰åº«å­˜</p>
                                </div>
                            </div>
                        </div>

                        <!-- æœ¬å€‰å„²ä½é¸æ“‡å€åŸŸ -->
                        <div id="location-section" class="bg-emerald-900/40 border border-emerald-500 rounded-lg p-3 flex flex-col flex-1">
                            <div class="flex justify-between items-center mb-2">
                                <div class="text-emerald-400 font-bold text-sm"><i class="fa-solid fa-map-marker-alt mr-1"></i>é¸æ“‡å„²ä½</div>
                                <div class="flex gap-2 items-center">
                                    <button onclick="calculateSmartSuggest()" class="px-2 py-1 bg-yellow-600 hover:bg-yellow-500 text-white rounded text-xs font-bold">
                                        <i class="fa-solid fa-wand-magic-sparkles mr-1"></i>å»ºè­°
                                    </button>
                                    <input type="text" id="in-loc" class="w-28 p-1.5 bg-slate-800 border-2 border-emerald-500 rounded text-sm font-bold text-emerald-400 text-center" placeholder="å„²ä½" oninput="validateLocationInput(); updateInboundProgress();" onchange="validateLocationInput()">
                                </div>
                            </div>

                            <!-- å¿«é€Ÿé¸æ“‡æš«å­˜å€ï¼ˆç²¾ç°¡ç‰ˆï¼‰-->
                            <div class="mb-2 p-2 bg-slate-800/70 rounded border border-amber-500/30">
                                <div class="flex flex-wrap gap-1">
                                    <button onclick="selectVirtualLocation('TEMP-IN')" class="px-3 py-1.5 bg-emerald-700 hover:bg-emerald-600 text-white rounded text-xs font-bold">
                                        <i class="fa-solid fa-truck-loading mr-1"></i>é€²è²¨æš«å­˜
                                    </button>
                                    <button onclick="selectVirtualLocation('TEMP-OUT')" class="px-3 py-1.5 bg-orange-700 hover:bg-orange-600 text-white rounded text-xs font-bold">
                                        <i class="fa-solid fa-truck mr-1"></i>å‡ºè²¨æš«å­˜
                                    </button>
                                    <button onclick="selectVirtualLocation('A00')" class="px-2 py-1 bg-blue-800 hover:bg-blue-700 text-white rounded text-[10px]">A00</button>
                                    <button onclick="selectVirtualLocation('B00')" class="px-2 py-1 bg-indigo-800 hover:bg-indigo-700 text-white rounded text-[10px]">B00</button>
                                    <button onclick="selectVirtualLocation('C00')" class="px-2 py-1 bg-purple-800 hover:bg-purple-700 text-white rounded text-[10px]">C00</button>
                                    <button onclick="selectVirtualLocation('D00')" class="px-2 py-1 bg-pink-800 hover:bg-pink-700 text-white rounded text-[10px]">D00</button>
                                    <button onclick="selectVirtualLocation('OTHER')" class="px-2 py-1 bg-slate-700 hover:bg-slate-600 text-white rounded text-[10px]">å…¶ä»–</button>
                                </div>
                            </div>

                            <!-- æ™ºèƒ½å»ºè­°åˆ—è¡¨ -->
                            <div id="smart-suggest-panel" class="mb-2 hidden">
                                <div id="smart-suggest-list"></div>
                            </div>

                            <!-- å€‰åº«åœ°åœ– -->
                            <div class="flex-1 bg-slate-900/80 rounded border border-slate-700 p-2 overflow-auto relative">
                                <div class="absolute top-1 right-1 bg-slate-800/90 p-1 px-2 rounded text-[10px] text-slate-400 flex gap-2 z-10">
                                    <span><i class="fa-solid fa-star text-yellow-400 mr-1"></i>æ¨è–¦</span>
                                    <span class="text-emerald-400">â–¡ ç©ºä½</span>
                                </div>
                                <div class="inbound-map-container">
                                    <div class="inbound-map-row">
                                        <div class="inbound-warehouse"><div class="text-blue-400 font-bold text-xs mb-1">I åº«</div><div class="inbound-zone"><span class="text-[10px] text-slate-400">A</span><div class="rack-lanes-grid-inbound" id="grid-I-A-map"></div></div><div class="inbound-zone"><span class="text-[10px] text-slate-400">B</span><div class="rack-lanes-grid-inbound" id="grid-I-B-map"></div></div></div>
                                        <div class="inbound-warehouse"><div class="text-purple-400 font-bold text-xs mb-1">J åº«</div><div class="inbound-zone"><span class="text-[10px] text-slate-400">C</span><div class="rack-lanes-grid-inbound" id="grid-J-C-map"></div></div><div class="inbound-zone"><span class="text-[10px] text-slate-400">D</span><div class="rack-lanes-grid-inbound" id="grid-J-D-map"></div></div></div>
                                    </div>
                                    <div class="inbound-warehouse-k"><div class="text-emerald-400 font-bold text-xs mb-1">K åº«</div><div class="inbound-k-zones"><div class="inbound-zone-k"><span class="text-[10px] text-slate-400">E</span><div class="rack-lanes-grid-k" id="grid-K-E-map"></div></div><div class="inbound-zone-k"><span class="text-[10px] text-slate-400">F</span><div class="rack-lanes-grid-k" id="grid-K-F-map"></div></div><div class="inbound-zone-k"><span class="text-[10px] text-slate-400">G</span><div class="rack-lanes-grid-k" id="grid-K-G-map"></div></div><div class="inbound-zone-k"><span class="text-[10px] text-slate-400">H</span><div class="rack-lanes-grid-k" id="grid-K-H-map"></div></div></div></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- STEP 3: é è¦½ç¢ºèªï¼ˆç²¾ç°¡ç‰ˆï¼‰-->
                    <div class="w-48 flex flex-col">
                        <div class="bg-purple-900/40 border border-purple-500 rounded-lg p-3 flex flex-col h-full">
                            <div class="text-purple-400 font-bold text-sm mb-2"><i class="fa-solid fa-check-circle mr-1"></i>ç¢ºèªå…¥åº«</div>

                            <!-- å®Œæˆåº¦æª¢æŸ¥ï¼ˆç²¾ç°¡ç‰ˆï¼‰-->
                            <div id="inbound-checklist" class="bg-slate-800/70 rounded p-2 mb-2 text-xs space-y-1">
                                <div class="flex items-center gap-1" id="check-name"><i class="fa-solid fa-circle text-slate-600 text-[8px]"></i><span class="text-slate-400">å“å</span></div>
                                <div class="flex items-center gap-1" id="check-qty"><i class="fa-solid fa-circle text-slate-600 text-[8px]"></i><span class="text-slate-400">æ•¸é‡</span></div>
                                <div class="flex items-center gap-1" id="check-exp"><i class="fa-solid fa-circle text-slate-600 text-[8px]"></i><span class="text-slate-400">æ•ˆæœŸ</span></div>
                                <div class="flex items-center gap-1" id="check-loc"><i class="fa-solid fa-circle text-slate-600 text-[8px]"></i><span class="text-slate-400">å„²ä½</span></div>
                            </div>

                            <!-- å…¥åº«æŒ‡ä»¤å–®é è¦½ï¼ˆç²¾ç°¡ç‰ˆï¼‰-->
                            <div id="live-preview-box" class="bg-white rounded p-2 text-center mb-2">
                                <div class="text-sm font-black text-black truncate" id="prev-name">-</div>
                                <div class="text-xs font-bold text-gray-600" id="prev-spec">-</div>
                                <div class="flex justify-between text-[9px] text-gray-500 mt-1 pt-1 border-t">
                                    <span id="prev-batch">æ‰¹: -</span>
                                    <span id="prev-exp">æ•ˆ: -</span>
                                </div>
                                <div class="flex items-center justify-between mt-1 pt-1 border-t border-black">
                                    <span class="text-xs font-bold text-black" id="prev-loc">-</span>
                                    <span class="text-lg font-black text-red-600" id="prev-qty">0</span>
                                </div>
                            </div>

                            <!-- æ“ä½œæŒ‰éˆ•ï¼ˆæ™ºèƒ½åˆ¤æ–·ç‰ˆï¼‰-->
                            <div class="space-y-1.5 flex-1 flex flex-col justify-end">
                                <!-- æœ¬å€‰æ¨¡å¼æŒ‰éˆ• -->
                                <div id="main-wh-buttons">
                                    <button onclick="smartInbound('print')" id="btn-inbound-print" class="w-full py-3 bg-emerald-600 hover:bg-emerald-500 disabled:bg-slate-700 disabled:cursor-not-allowed text-white rounded font-bold text-sm mb-1.5" disabled>
                                        <i class="fa-solid fa-print mr-1"></i>ğŸ–¨ï¸ åˆ—å°ä¸¦å…¥åº«
                                    </button>
                                    <button onclick="smartInbound('direct')" id="btn-inbound-direct" class="w-full py-2 bg-blue-600 hover:bg-blue-500 disabled:bg-slate-700 disabled:cursor-not-allowed text-white rounded text-sm" disabled>
                                        <i class="fa-solid fa-bolt mr-1"></i>ğŸ“¦ ç¢ºèªå…¥åº«
                                    </button>
                                </div>
                                <!-- å¤–å€‰æ¨¡å¼æŒ‰éˆ• -->
                                <div id="external-wh-buttons" class="hidden">
                                    <button onclick="smartInbound('external')" id="btn-inbound-external" class="w-full py-3 bg-teal-600 hover:bg-teal-500 disabled:bg-slate-700 disabled:cursor-not-allowed text-white rounded font-bold text-sm" disabled>
                                        <i class="fa-solid fa-building mr-1"></i>ğŸ“¦ ç¢ºèªå…¥åº«ï¼ˆå¤–å€‰ï¼‰
                                    </button>
                                </div>
                                <!-- é€²éšé¸é … -->
                                <div class="pt-1 border-t border-slate-700">
                                    <button onclick="toggleAdvancedOptions()" class="w-full py-1 text-slate-500 hover:text-slate-300 text-xs">
                                        <i class="fa-solid fa-chevron-down mr-1" id="advanced-icon"></i>é€²éšé¸é …
                                    </button>
                                    <div id="advanced-options" class="hidden mt-1 space-y-1">
                                        <button onclick="createInboundOrder()" class="w-full py-1.5 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded text-xs border border-slate-600">
                                            <i class="fa-solid fa-clock mr-1"></i>åŠ å…¥å¾…åŸ·è¡Œå…¥åº«å–®ï¼ˆæ’ç¨‹ï¼‰
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å¾…è²¡å‹™æ ¸å‡†é é¢ -->
            <div id="view-approval" class="view-panel h-full hidden flex flex-col p-4">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h2 class="text-white font-bold text-lg"><i class="fa-solid fa-clipboard-check text-yellow-400 mr-2"></i>å¾…è²¡å‹™æ ¸å‡†å…¥åº«å–®</h2>
                        <p class="text-slate-400 text-sm">æ¡è³¼é€²è²¨éœ€ç¶“è²¡å‹™å¯©æ ¸å¾Œæ‰èƒ½å…¥åº«</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="refreshApprovalList()" class="px-3 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded text-sm">
                            <i class="fa-solid fa-refresh mr-1"></i>é‡æ–°æ•´ç†
                        </button>
                    </div>
                </div>

                <!-- ç¯©é¸ -->
                <div class="flex gap-4 mb-4">
                    <select id="approval-status-filter" class="scan-input w-40" onchange="filterApprovalList()">
                        <option value="pending">å¾…å¯©æ ¸</option>
                        <option value="rejected">å·²é§å›</option>
                        <option value="approved">å·²å¯©æ ¸</option>
                        <option value="all">å…¨éƒ¨</option>
                    </select>
                    <input type="text" id="approval-search" class="scan-input flex-1" placeholder="æœå°‹å“åã€å–®è™Ÿ..." oninput="filterApprovalList()">
                </div>

                <!-- åˆ—è¡¨ -->
                <div class="glass-panel flex-1 overflow-auto">
                    <table class="w-full text-sm">
                        <thead class="sticky top-0 bg-slate-800">
                            <tr class="text-slate-400 text-xs">
                                <th class="p-3 text-left">å–®è™Ÿ</th>
                                <th class="p-3 text-left">å“å</th>
                                <th class="p-3 text-left">è¦æ ¼</th>
                                <th class="p-3 text-left">æ‰¹è™Ÿ</th>
                                <th class="p-3 text-left">æ•ˆæœŸ</th>
                                <th class="p-3 text-right">æ•¸é‡</th>
                                <th class="p-3 text-left">å„²ä½</th>
                                <th class="p-3 text-left">å» å•†</th>
                                <th class="p-3 text-left">å»ºå–®äºº</th>
                                <th class="p-3 text-left">å»ºå–®æ™‚é–“</th>
                                <th class="p-3 text-center">ç‹€æ…‹</th>
                                <th class="p-3 text-center">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="approval-list-body">
                            <tr><td colspan="12" class="text-center text-slate-500 py-10">è¼‰å…¥ä¸­...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="view-pre-inbound" class="view-panel h-full hidden flex p-3 gap-3">
                <!-- å·¦å´ï¼šåŒ¯å…¥èˆ‡è¨­å®š -->
                <div class="w-80 glass-panel p-3 flex flex-col">
                    <h3 class="text-white font-bold mb-2 text-sm border-b border-slate-700 pb-2">ğŸ“¦ è²¨æ«ƒå…¥åº«ä½œæ¥­</h3>

                    <!-- 1. Excel åŒ¯å…¥ -->
                    <div class="mb-2 bg-slate-800 p-2 rounded border border-slate-700">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs text-blue-400 font-bold">1. Excel åŒ¯å…¥</span>
                            <button onclick="downloadTemplate('container')" class="text-[10px] text-slate-400 underline">ä¸‹è¼‰ç¯„æœ¬</button>
                        </div>
                        <input type="file" id="containerExcel" accept=".xlsx" class="hidden" onchange="handleContainerImport(event)">
                        <button onclick="document.getElementById('containerExcel').click()" class="w-full py-2 bg-emerald-600 hover:bg-emerald-500 text-white rounded text-sm font-bold">
                            <i class="fa-solid fa-file-excel mr-1"></i>ä¸Šå‚³ Excel
                        </button>
                        <div class="text-[10px] text-slate-500 mt-1">æ¬„ä½ï¼šå» å•†ã€å“åã€è¦æ ¼ã€æ‰¹è™Ÿã€æ•ˆæœŸã€æ•¸é‡ã€æ¯æ¿æ•¸ã€ç®±å®¹kgã€ç¸½é‡é‡kgã€é¡å‹(å®šé‡/ä¸å®šé‡)</div>
                    </div>

                    <!-- 1. æ‰‹å‹•æ–°å¢å“é …ï¼ˆèˆ‡ Excel ä¸¦è¡Œï¼‰-->
                    <div class="mb-2 bg-slate-800 p-2 rounded border border-slate-700">
                        <div class="text-xs text-cyan-400 font-bold mb-2">1. æ‰‹å‹•æ–°å¢å“é …</div>
                        <div class="space-y-1.5">
                            <!-- å…¬å¸é¸æ“‡ -->
                            <div class="flex gap-1 bg-slate-900 rounded p-1">
                                <label class="flex-1 cursor-pointer">
                                    <input type="radio" name="pre-company" value="å´‡æ–‡" class="hidden peer" checked>
                                    <div class="text-center py-1 rounded text-[10px] font-bold peer-checked:bg-blue-600 peer-checked:text-white text-slate-400">å´‡æ–‡</div>
                                </label>
                                <label class="flex-1 cursor-pointer">
                                    <input type="radio" name="pre-company" value="å…«æ–¹" class="hidden peer">
                                    <div class="text-center py-1 rounded text-[10px] font-bold peer-checked:bg-purple-600 peer-checked:text-white text-slate-400">å…«æ–¹</div>
                                </label>
                            </div>
                            <input type="text" id="pre-vendor" class="w-full p-1.5 bg-slate-900 border border-slate-600 rounded text-white text-sm" placeholder="å» å•†">
                            <!-- å“åï¼ˆå¾å“é …ä¸»æª”é–‹çª—é¸æ“‡ï¼‰-->
                            <div class="relative">
                                <input type="text" id="pre-name" class="w-full p-1.5 pr-12 bg-slate-900 border border-emerald-600/50 rounded text-white text-sm font-bold" placeholder="é»æ“Šé¸æ“‡å“é …..." readonly>
                                <button onclick="openProductSelectModal('container')" class="absolute right-1 top-1/2 -translate-y-1/2 px-1.5 py-0.5 bg-emerald-600 hover:bg-emerald-500 text-white rounded text-[10px] font-bold">
                                    <i class="fa-solid fa-search"></i>
                                </button>
                            </div>
                            <input type="hidden" id="pre-product-code" value="">
                            <input type="text" id="pre-spec" class="w-full p-1.5 bg-slate-900 border border-slate-600 rounded text-white text-sm" placeholder="è¦æ ¼ï¼ˆè‡ªå‹•å¸¶å…¥ï¼‰">
                            <div class="grid grid-cols-2 gap-1.5">
                                <input type="text" id="pre-batch" class="p-1.5 bg-slate-900 border border-slate-600 rounded text-white text-sm" placeholder="æ‰¹è™Ÿ *">
                                <input type="date" id="pre-exp" class="p-1.5 bg-slate-900 border border-slate-600 rounded text-white text-sm">
                            </div>
                            <!-- å“é …é¡å‹é¸æ“‡ -->
                            <div class="flex gap-1 bg-slate-900 rounded p-1">
                                <label class="flex-1 cursor-pointer">
                                    <input type="radio" name="pre-product-type" value="fixed" class="hidden peer" checked onchange="togglePreProductType('fixed')">
                                    <div class="text-center py-1 rounded text-[10px] font-bold peer-checked:bg-blue-600 peer-checked:text-white text-slate-400">ğŸ“¦ å®šé‡</div>
                                </label>
                                <label class="flex-1 cursor-pointer">
                                    <input type="radio" name="pre-product-type" value="variable" class="hidden peer" onchange="togglePreProductType('variable')">
                                    <div class="text-center py-1 rounded text-[10px] font-bold peer-checked:bg-amber-600 peer-checked:text-white text-slate-400">âš–ï¸ ä¸å®šé‡</div>
                                </label>
                            </div>
                            <!-- å®šé‡å“æ¬„ä½ -->
                            <div id="pre-fixed-fields" class="grid grid-cols-3 gap-1.5">
                                <input type="number" id="pre-qty" class="p-1.5 bg-slate-900 border border-slate-600 rounded text-white text-sm text-center" placeholder="æ•¸é‡ *">
                                <input type="number" id="pre-per-pallet" class="p-1.5 bg-slate-900 border border-slate-600 rounded text-white text-sm text-center" value="50" placeholder="æ¯æ¿æ•¸">
                                <input type="number" id="pre-unit-weight" class="p-1.5 bg-slate-900 border border-slate-600 rounded text-white text-sm text-center" placeholder="ç®±å®¹kg" step="0.1">
                            </div>
                            <!-- ä¸å®šé‡å“æ¬„ä½ -->
                            <div id="pre-variable-fields" class="hidden space-y-1.5">
                                <div class="grid grid-cols-2 gap-1.5">
                                    <div class="relative">
                                        <input type="number" id="pre-qty-var" class="w-full p-1.5 bg-slate-900 border border-amber-600/50 rounded text-white text-sm text-center pr-6" placeholder="æ•¸é‡ *">
                                        <span class="absolute right-2 top-1/2 -translate-y-1/2 text-amber-500 text-[10px]">ä»¶</span>
                                    </div>
                                    <div class="relative">
                                        <input type="number" id="pre-total-weight" class="w-full p-1.5 bg-slate-900 border border-amber-600/50 rounded text-white text-sm text-center pr-6" placeholder="ç¸½é‡é‡ *" step="0.1">
                                        <span class="absolute right-2 top-1/2 -translate-y-1/2 text-amber-500 text-[10px]">kg</span>
                                    </div>
                                </div>
                                <input type="number" id="pre-per-pallet-var" class="w-full p-1.5 bg-slate-900 border border-slate-600 rounded text-white text-sm text-center" value="50" placeholder="æ¯æ¿æ•¸">
                            </div>
                            <button onclick="addContainerItemAndGenerate()" class="w-full py-2 bg-blue-600 hover:bg-blue-500 text-white rounded text-sm font-bold">
                                <i class="fa-solid fa-plus mr-1"></i>æ–°å¢å“é …
                            </button>
                        </div>
                    </div>

                    <!-- 2. å„²ä½å€åŸŸè¨­å®š -->
                    <div class="flex-1 bg-slate-800 p-2 rounded border border-slate-700">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs text-yellow-400 font-bold">2. å„²ä½å€åŸŸè¨­å®š</span>
                            <button onclick="showAvailableLocations()" class="text-[10px] text-blue-400 underline">æŸ¥çœ‹ç©ºä½</button>
                        </div>
                        <!-- å€åŸŸå‹¾é¸æŒ‰éˆ• -->
                        <div class="grid grid-cols-8 gap-1 mb-2">
                            <label class="zone-check-btn"><input type="checkbox" value="A" checked class="container-zone-cb hidden"><span class="block text-center py-1.5 rounded text-xs font-bold cursor-pointer bg-blue-600 text-white">A</span></label>
                            <label class="zone-check-btn"><input type="checkbox" value="B" checked class="container-zone-cb hidden"><span class="block text-center py-1.5 rounded text-xs font-bold cursor-pointer bg-blue-600 text-white">B</span></label>
                            <label class="zone-check-btn"><input type="checkbox" value="C" class="container-zone-cb hidden"><span class="block text-center py-1.5 rounded text-xs font-bold cursor-pointer bg-slate-700 text-slate-400">C</span></label>
                            <label class="zone-check-btn"><input type="checkbox" value="D" class="container-zone-cb hidden"><span class="block text-center py-1.5 rounded text-xs font-bold cursor-pointer bg-slate-700 text-slate-400">D</span></label>
                            <label class="zone-check-btn"><input type="checkbox" value="E" class="container-zone-cb hidden"><span class="block text-center py-1.5 rounded text-xs font-bold cursor-pointer bg-slate-700 text-slate-400">E</span></label>
                            <label class="zone-check-btn"><input type="checkbox" value="F" class="container-zone-cb hidden"><span class="block text-center py-1.5 rounded text-xs font-bold cursor-pointer bg-slate-700 text-slate-400">F</span></label>
                            <label class="zone-check-btn"><input type="checkbox" value="G" class="container-zone-cb hidden"><span class="block text-center py-1.5 rounded text-xs font-bold cursor-pointer bg-slate-700 text-slate-400">G</span></label>
                            <label class="zone-check-btn"><input type="checkbox" value="H" class="container-zone-cb hidden"><span class="block text-center py-1.5 rounded text-xs font-bold cursor-pointer bg-slate-700 text-slate-400">H</span></label>
                        </div>
                        <select id="container-zones" class="hidden"></select>
                        <div class="flex items-center gap-2">
                            <select id="container-strategy" class="flex-1 p-1.5 bg-slate-900 border border-slate-600 rounded text-white text-xs">
                                <option value="clustered" selected>åŒå“é …é›†ä¸­</option>
                                <option value="sequential">é †åºåˆ†é…</option>
                            </select>
                            <label class="flex items-center gap-1 text-xs text-slate-400 whitespace-nowrap">
                                <input type="checkbox" id="container-skip-occupied" checked class="w-3 h-3">è·³éä½”ç”¨
                            </label>
                        </div>
                        <div id="available-count" class="text-xs text-emerald-400 mt-1"></div>
                    </div>
                </div>

                <!-- ä¸­é–“ï¼šå“é …æ¸…å–® -->
                <div class="w-72 glass-panel p-3 flex flex-col">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-white font-bold text-sm">ğŸ“‹ å…¥åº«å“é …æ¸…å–®</h3>
                        <button onclick="clearContainerItems()" class="text-xs text-red-400 hover:text-red-300">æ¸…é™¤å…¨éƒ¨</button>
                    </div>
                    <div id="container-items-list" class="flex-1 overflow-y-auto space-y-2">
                        <div class="text-center text-slate-500 py-6">
                            <i class="fa-solid fa-box-open text-3xl mb-2"></i>
                            <div class="text-sm">å°šç„¡å“é …</div>
                            <div class="text-xs text-slate-600">è«‹åŒ¯å…¥ Excel æˆ–æ‰‹å‹•æ–°å¢</div>
                        </div>
                    </div>
                    <div id="container-summary" class="mt-2 pt-2 border-t border-slate-700 hidden">
                        <div class="flex justify-between text-sm"><span class="text-slate-400">å“é …æ•¸</span><span class="text-white font-bold" id="container-item-count">0</span></div>
                        <div class="flex justify-between text-sm"><span class="text-slate-400">ç¸½æ¿æ•¸</span><span class="text-yellow-400 font-bold" id="container-pallet-count">0</span></div>
                        <div class="flex justify-between text-sm"><span class="text-slate-400">ç¸½æ•¸é‡</span><span class="text-emerald-400 font-bold" id="container-total-qty">0</span></div>
                    </div>
                </div>

                <!-- å³å´ï¼šæ¨™ç±¤é è¦½ -->
                <div class="flex-1 glass-panel p-3 flex flex-col">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-white font-bold text-sm">ğŸ·ï¸ æ£§æ¿æ’å–®é è¦½</h3>
                    </div>
                    <div id="container-labels-preview" class="flex-1 overflow-y-auto grid grid-cols-3 gap-2 content-start">
                        <div class="col-span-3 text-center text-slate-500 py-8">
                            <i class="fa-solid fa-tags text-3xl mb-2"></i>
                            <div>è«‹å…ˆæ–°å¢å“é …</div>
                        </div>
                    </div>
                    <!-- æ“ä½œæŒ‰éˆ•ç§»åˆ°åº•éƒ¨ -->
                    <div id="container-action-buttons" class="mt-3 pt-3 border-t border-slate-700 space-y-2 hidden">
                        <button onclick="printContainerLabels()" id="btn-print-labels" class="w-full py-2 bg-blue-600 hover:bg-blue-500 text-white rounded text-sm font-bold">
                            <i class="fa-solid fa-print mr-1"></i>åˆ—å°æ’å–®
                        </button>
                        <button onclick="confirmContainerInbound()" id="btn-confirm-inbound" class="w-full py-2 bg-emerald-600 hover:bg-emerald-500 text-white rounded text-sm font-bold">
                            <i class="fa-solid fa-check mr-1"></i>ç¢ºèªå…¥åº«
                        </button>
                    </div>
                </div>
            </div>

            <div id="view-inventory-query" class="view-panel h-full hidden flex flex-col p-4"><div class="flex gap-2 mb-3 items-center"><div class="flex gap-1 bg-slate-800 rounded p-1 mr-2"><button onclick="setInventoryCompany('all')" id="btn-inv-all" class="px-3 py-1.5 rounded text-xs font-bold bg-slate-600 text-white">å…¨éƒ¨</button><button onclick="setInventoryCompany('å´‡æ–‡')" id="btn-inv-cw" class="px-3 py-1.5 rounded text-xs font-bold bg-slate-700 text-slate-300 hover:bg-slate-600">å´‡æ–‡</button><button onclick="setInventoryCompany('å…«æ–¹')" id="btn-inv-bf" class="px-3 py-1.5 rounded text-xs font-bold bg-slate-700 text-slate-300 hover:bg-slate-600">å…«æ–¹</button></div><input type="text" id="global-search" class="scan-input pl-9 flex-1" placeholder="è¬ç”¨æœå°‹..." oninput="filterInventory()"><button onclick="exportInventoryToExcel()" class="bg-emerald-600 text-white px-3 py-1.5 rounded text-xs font-bold hover:bg-emerald-500 flex items-center gap-2"><i class="fa-solid fa-file-excel"></i> åŒ¯å‡ºåº«å­˜</button><button onclick="document.getElementById('stockImportInput').click()" class="bg-orange-600 text-white px-3 py-1.5 rounded text-xs font-bold hover:bg-orange-500 ml-auto flex items-center gap-2"><i class="fa-solid fa-file-import"></i> æœŸåˆåŒ¯å…¥</button><button onclick="downloadTemplate('stock')" class="text-slate-400 text-xs hover:text-white underline">ç¯„æœ¬</button><input type="file" id="stockImportInput" accept=".xlsx" class="hidden" onchange="handleStockImport(event)"></div><div class="glass-panel flex-1 overflow-auto"><table class="w-full dense-table"><thead><tr><th class="text-left">å…¬å¸</th><th class="text-left">å“å</th><th class="text-left">è¦æ ¼</th><th class="text-left">æ‰¹è™Ÿ</th><th class="text-right">æ•¸é‡</th><th class="text-right">é‡é‡</th><th class="text-left">ä½ç½®</th><th class="text-left">æ•ˆæœŸ</th><th class="text-right">æ“ä½œ</th></tr></thead><tbody id="inventory-list-body"></tbody></table></div></div>

            <!-- æˆå“å‡ºè²¨ï¼ˆè‡ªå‹•æ€è²¨ï¼‰ -->

            <!-- æ³¢æ¬¡æ€è²¨ -->
            <div id="view-wave-picking" class="view-panel h-full hidden flex flex-col p-4">
                <!-- é ‚éƒ¨æ¨™é¡Œ -->
                <div class="flex items-center justify-between bg-gradient-to-r from-orange-900 to-red-900 border border-orange-600 p-4 rounded-xl mb-4">
                    <div>
                        <h2 class="text-white font-bold text-2xl"><i class="fa-solid fa-layer-group mr-2 text-orange-400"></i>æ³¢æ¬¡æ€è²¨</h2>
                        <p class="text-orange-200 text-sm mt-1">ä¾ç‰©æµå•†åˆ†æ³¢æ¬¡ï¼Œç”¢ç”Ÿæ€è²¨å–®èˆ‡åˆ†è²¨æ¨™ç±¤</p>
                    </div>
                    <div class="flex gap-2 items-center">
                        <!-- å…¬å¸é¸æ“‡ -->
                        <div class="flex gap-1 bg-slate-900/50 rounded p-1 mr-2">
                            <button onclick="setWaveCompany('å´‡æ–‡')" id="btn-wave-cw" class="px-3 py-1.5 rounded text-xs font-bold bg-blue-600 text-white">å´‡æ–‡</button>
                            <button onclick="setWaveCompany('å…«æ–¹')" id="btn-wave-bf" class="px-3 py-1.5 rounded text-xs font-bold bg-slate-700 text-slate-300 hover:bg-slate-600">å…«æ–¹</button>
                        </div>
                        <input type="file" id="order-excel-import" accept=".xlsx,.xls" class="hidden" onchange="importERPExcel(event)">
                        <button onclick="document.getElementById('order-excel-import').click()" class="bg-purple-600 hover:bg-purple-500 text-white px-4 py-2 rounded-lg font-bold mr-2">
                            <i class="fa-solid fa-file-excel mr-1"></i>åŒ¯å…¥è¨‚å–®
                        </button>
                        <button onclick="autoCreateWavesByLogistics()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg font-bold mr-2">
                            <i class="fa-solid fa-wand-magic-sparkles mr-1"></i>è‡ªå‹•å»ºç«‹
                        </button>
                        <button onclick="openCreateWaveModal()" class="bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded-lg font-bold mr-2">
                            <i class="fa-solid fa-plus mr-1"></i>æ‰‹å‹•å»ºç«‹
                        </button>
                        <button onclick="openBackupModal()" class="bg-orange-600 hover:bg-orange-500 text-white px-4 py-2 rounded-lg font-bold">
                            <i class="fa-solid fa-database mr-1"></i>å‚™ä»½ç®¡ç†
                        </button>
                        <button onclick="openClearDataModal()" class="bg-slate-600 hover:bg-slate-500 text-white px-4 py-2 rounded-lg font-bold">
                            <i class="fa-solid fa-broom mr-1"></i>æ¸…é™¤è³‡æ–™
                        </button>
                        <button onclick="refreshWaveList()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg font-bold">
                            <i class="fa-solid fa-sync mr-1"></i>é‡æ–°æ•´ç†
                        </button>
                    </div>
                </div>

                <!-- æ³¢æ¬¡çµ±è¨ˆ -->
                <div class="grid grid-cols-5 gap-3 mb-4">
                    <div class="bg-gradient-to-br from-blue-900/50 to-blue-800/30 border border-blue-600/50 rounded-lg p-3 text-center">
                        <div class="text-blue-400 text-xs">ä»Šæ—¥æ³¢æ¬¡</div>
                        <div class="text-2xl font-black text-white" id="wave-stat-today">0</div>
                    </div>
                    <div class="bg-gradient-to-br from-yellow-900/50 to-yellow-800/30 border border-yellow-600/50 rounded-lg p-3 text-center">
                        <div class="text-yellow-400 text-xs">å¾…æ€è²¨</div>
                        <div class="text-2xl font-black text-white" id="wave-stat-pending">0</div>
                    </div>
                    <div class="bg-gradient-to-br from-orange-900/50 to-orange-800/30 border border-orange-600/50 rounded-lg p-3 text-center">
                        <div class="text-orange-400 text-xs">æ€è²¨ä¸­</div>
                        <div class="text-2xl font-black text-white" id="wave-stat-picking">0</div>
                    </div>
                    <div class="bg-gradient-to-br from-emerald-900/50 to-emerald-800/30 border border-emerald-600/50 rounded-lg p-3 text-center">
                        <div class="text-emerald-400 text-xs">å·²å®Œæˆ</div>
                        <div class="text-2xl font-black text-white" id="wave-stat-done">0</div>
                    </div>
                    <div class="bg-gradient-to-br from-purple-900/50 to-purple-800/30 border border-purple-600/50 rounded-lg p-3 text-center">
                        <div class="text-purple-400 text-xs">å¾…å‡ºè²¨è¨‚å–®</div>
                        <div class="text-2xl font-black text-white" id="wave-stat-orders">0</div>
                    </div>
                </div>

                <!-- æ³¢æ¬¡æ¸…å–® -->
                <div class="flex-1 bg-slate-800/50 border border-slate-700 rounded-xl overflow-hidden">
                    <div class="overflow-auto h-full">
                        <table class="w-full dense-table">
                            <thead class="bg-slate-900 sticky top-0">
                                <tr>
                                    <th class="p-3 text-left">æ³¢æ¬¡ç·¨è™Ÿ</th>
                                    <th class="p-3 text-left">ç‰©æµå•†</th>
                                    <th class="p-3 text-left">ç‹€æ…‹</th>
                                    <th class="p-3 text-right">è¨‚å–®æ•¸</th>
                                    <th class="p-3 text-right">å“é …æ•¸</th>
                                    <th class="p-3 text-right">ç¸½ä»¶æ•¸</th>
                                    <th class="p-3 text-left">å»ºç«‹æ™‚é–“</th>
                                    <th class="p-3 text-center">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="wave-list-body">
                                <tr><td colspan="8" class="text-center text-slate-500 py-8">è¼‰å…¥ä¸­...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- å»ºç«‹æ³¢æ¬¡ Modal -->
            <div id="modal-create-wave" class="fixed inset-0 z-50 bg-black/80 hidden flex items-center justify-center backdrop-blur-sm">
                <div class="bg-slate-900 border border-slate-700 rounded-2xl w-[800px] max-h-[90vh] shadow-2xl flex flex-col">
                    <div class="bg-gradient-to-r from-orange-900 to-red-900 p-4 rounded-t-2xl border-b border-slate-700">
                        <h3 class="text-white font-bold text-lg"><i class="fa-solid fa-plus-circle mr-2 text-orange-400"></i>å»ºç«‹æ€è²¨æ³¢æ¬¡</h3>
                    </div>
                    <div class="p-4 border-b border-slate-700">
                        <div class="grid grid-cols-3 gap-4">
                            <div>
                                <label class="text-slate-400 text-xs mb-1 block">ç‰©æµå•†ç¯©é¸</label>
                                <select id="wave-filter-logistics" class="scan-input w-full" onchange="filterWaveOrders()">
                                    <option value="">å…¨éƒ¨ç‰©æµ</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-slate-400 text-xs mb-1 block">å‡ºè²¨æ—¥æœŸ</label>
                                <input type="date" id="wave-filter-date" class="scan-input w-full" onchange="filterWaveOrders()">
                            </div>
                            <div class="flex items-end">
                                <button onclick="selectAllWaveOrders()" class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-2 rounded text-sm mr-2">å…¨é¸</button>
                                <button onclick="deselectAllWaveOrders()" class="bg-slate-600 hover:bg-slate-500 text-white px-3 py-2 rounded text-sm">å–æ¶ˆå…¨é¸</button>
                            </div>
                        </div>
                    </div>
                    <div class="flex-1 overflow-auto p-4">
                        <table class="w-full text-sm">
                            <thead class="bg-slate-800 sticky top-0">
                                <tr>
                                    <th class="p-2 text-left w-10"><input type="checkbox" id="wave-check-all" onchange="toggleWaveCheckAll()"></th>
                                    <th class="p-2 text-left">æ‰¹è™Ÿ</th>
                                    <th class="p-2 text-left">è¨‚å–®æ­¸å±¬</th>
                                    <th class="p-2 text-left">ç‰©æµå•†</th>
                                    <th class="p-2 text-left">å“å/è¦æ ¼</th>
                                    <th class="p-2 text-right">æ•¸é‡</th>
                                    <th class="p-2 text-left">éŠ·è²¨æ—¥æœŸ</th>
                                </tr>
                            </thead>
                            <tbody id="wave-orders-body">
                                <tr><td colspan="7" class="text-center text-slate-500 py-8">è¼‰å…¥ä¸­...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="p-4 border-t border-slate-700">
                        <div class="flex items-center justify-between">
                            <div class="text-sm">
                                <span class="text-slate-400">å·²é¸æ“‡ï¼š</span>
                                <span class="text-orange-400 font-bold" id="wave-selected-count">0</span>
                                <span class="text-slate-400 ml-2">ç­†è¨‚å–®</span>
                            </div>
                            <div class="flex gap-3">
                                <button onclick="createWave()" class="px-6 py-2 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg font-bold">
                                    <i class="fa-solid fa-check mr-2"></i>å»ºç«‹æ³¢æ¬¡
                                </button>
                                <button onclick="closeCreateWaveModal()" class="px-6 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg">å–æ¶ˆ</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ³¢æ¬¡åŸ·è¡Œ Modal -->
            <div id="modal-wave-execute" class="fixed inset-0 z-50 bg-black/80 hidden flex items-center justify-center backdrop-blur-sm">
                <div class="bg-slate-900 border border-slate-700 rounded-2xl w-[1000px] max-h-[90vh] shadow-2xl flex flex-col">
                    <div class="bg-gradient-to-r from-blue-900 to-indigo-900 p-4 rounded-t-2xl border-b border-slate-700 flex justify-between items-center">
                        <div>
                            <h3 class="text-white font-bold text-lg"><i class="fa-solid fa-clipboard-list mr-2 text-blue-400"></i>åŸ·è¡Œæ€è²¨ - <span id="wave-exec-no">W001</span></h3>
                            <p class="text-blue-200 text-xs mt-1" id="wave-exec-logistics">ç‰©æµå•†ï¼šé»‘è²“å®…æ€¥ä¾¿</p>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="text-sm">
                                <span class="text-slate-400">é€²åº¦ï¼š</span>
                                <span class="text-emerald-400 font-bold" id="wave-exec-progress">0/0</span>
                            </div>
                            <button onclick="printPickingList()" class="bg-emerald-600 hover:bg-emerald-500 text-white px-3 py-2 rounded-lg text-sm">
                                <i class="fa-solid fa-print mr-1"></i>åˆ—å°æ€è²¨å–®
                            </button>
                        </div>
                    </div>

                    <!-- æƒæå€ -->
                    <div class="p-4 border-b border-slate-700 bg-slate-800/30">
                        <div class="flex items-center gap-3">
                            <i class="fa-solid fa-barcode text-blue-400 text-xl"></i>
                            <input type="text" id="wave-scan-input" class="scan-input flex-1 text-lg" placeholder="æƒææ¿è™Ÿæˆ–å„²ä½ç¢ºèªæ€è²¨..." onkeypress="if(event.key==='Enter') confirmWaveScan()">
                            <button onclick="confirmWaveScan()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg font-bold">
                                <i class="fa-solid fa-check mr-1"></i>ç¢ºèª
                            </button>
                        </div>
                        <div id="wave-scan-result" class="mt-2 text-sm hidden"></div>
                    </div>

                    <!-- æ€è²¨æ¸…å–® -->
                    <div class="flex-1 overflow-auto p-4">
                        <table class="w-full text-sm">
                            <thead class="bg-slate-800 sticky top-0">
                                <tr>
                                    <th class="p-2 text-left w-16">ç‹€æ…‹</th>
                                    <th class="p-2 text-left">å„²ä½</th>
                                    <th class="p-2 text-left">æ¿è™Ÿ</th>
                                    <th class="p-2 text-left">å“å/è¦æ ¼</th>
                                    <th class="p-2 text-left">è¦æ ¼</th>
                                    <th class="p-2 text-right">æ€è²¨æ•¸</th>
                                    <th class="p-2 text-left">æ‰¹è™Ÿ</th>
                                    <th class="p-2 text-left">è¨‚å–®æ­¸å±¬</th>
                                </tr>
                            </thead>
                            <tbody id="wave-picking-list">
                                <tr><td colspan="8" class="text-center text-slate-500 py-8">è¼‰å…¥ä¸­...</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- åº•éƒ¨æŒ‰éˆ• -->
                    <div class="p-4 border-t border-slate-700 flex gap-3">
                        <button onclick="printSortingLabels()" class="flex-1 py-3 bg-purple-600 hover:bg-purple-500 text-white rounded-lg font-bold">
                            <i class="fa-solid fa-tags mr-2"></i>åˆ—å°åˆ†è²¨æ¨™ç±¤
                        </button>
                        <button onclick="completeWave()" class="flex-1 py-3 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg font-bold">
                            <i class="fa-solid fa-flag-checkered mr-2"></i>å®Œæˆæ³¢æ¬¡
                        </button>
                        <button onclick="closeWaveExecuteModal()" class="px-6 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-lg">é—œé–‰</button>
                    </div>
                </div>
            </div>

            <!-- åŸæ–™é ˜ç”¨ï¼ˆå»ºè­°+ç¢ºèªï¼‰ -->
            <div id="view-picking-rm" class="view-panel h-full hidden flex flex-col p-4">
                <div class="bg-gradient-to-r from-cyan-900 to-cyan-800 border border-cyan-600 p-4 rounded-lg mb-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-white font-bold text-xl"><i class="fa-solid fa-fish mr-2 text-cyan-400"></i>åŸæ–™é ˜ç”¨ - å»ºè­°ç¢ºèªæ¨¡å¼</h2>
                            <p class="text-cyan-200 text-sm mt-1">ç³»çµ±æä¾›å»ºè­°æ¸…å–®ï¼Œå€‰ç®¡ç¾å ´åˆ¤æ–·æ£§æ¿ç‹€æ…‹ã€ç–Šæ¿å¹³æ•´åº¦å¾Œç¢ºèªå¯¦éš›å–ç”¨</p>
                        </div>
                        <!-- å…¬å¸é¸æ“‡ -->
                        <div class="flex gap-1 bg-slate-900/50 rounded p-1">
                            <button onclick="setRmCompany('å´‡æ–‡')" id="btn-rm-cw" class="px-4 py-2 rounded text-sm font-bold bg-blue-600 text-white">å´‡æ–‡</button>
                            <button onclick="setRmCompany('å…«æ–¹')" id="btn-rm-bf" class="px-4 py-2 rounded text-sm font-bold bg-slate-700 text-slate-300 hover:bg-slate-600">å…«æ–¹</button>
                        </div>
                    </div>
                </div>
                <div class="flex gap-4 flex-1">
                    <!-- å·¦å´ï¼šéœ€æ±‚è¼¸å…¥ -->
                    <div class="w-80 glass-panel p-4 flex flex-col">
                        <h3 class="text-white font-bold mb-3 border-b border-slate-700 pb-2"><i class="fa-solid fa-clipboard-list mr-2 text-cyan-400"></i>é ˜æ–™éœ€æ±‚</h3>
                        <div class="space-y-3">
                            <div><label class="text-xs text-slate-400">å“å</label><input type="text" id="rm-pick-name" class="scan-input" placeholder="è¼¸å…¥å“åæœå°‹" oninput="searchProductForPicking('rm')"></div>
                            <div id="rm-product-suggestions" class="max-h-32 overflow-y-auto"></div>
                            <div><label class="text-xs text-slate-400">è¦æ ¼</label><input type="text" id="rm-pick-spec" class="scan-input" readonly></div>
                            <div><label class="text-xs text-slate-400">éœ€æ±‚æ•¸é‡</label><input type="number" id="rm-pick-qty" class="scan-input text-2xl font-bold text-center text-yellow-400" placeholder="0"></div>
                            <div><label class="text-xs text-slate-400">é ˜ç”¨å–®ä½/å‚™è¨»</label><input type="text" id="rm-pick-dept" class="scan-input" placeholder="å¦‚ï¼šåŠ å·¥èª²"></div>
                            <button onclick="calculatePickingPlan('rm')" class="w-full py-3 bg-cyan-600 hover:bg-cyan-500 text-white rounded font-bold text-lg mt-4">
                                <i class="fa-solid fa-list-check mr-2"></i>ç”¢ç”Ÿå»ºè­°æ¸…å–®
                            </button>
                        </div>
                    </div>
                    <!-- å³å´ï¼šå»ºè­°æ¸…å–® -->
                    <div class="flex-1 glass-panel p-4 flex flex-col">
                        <div class="flex justify-between items-center mb-3 border-b border-slate-700 pb-2">
                            <h3 class="text-white font-bold"><i class="fa-solid fa-hand-pointer mr-2 text-yellow-400"></i>å»ºè­°æ¸…å–®ï¼ˆè«‹ç¾å ´ç¢ºèªå‹¾é¸ï¼‰</h3>
                            <button onclick="printPickingSlip('rm')" class="bg-cyan-600 hover:bg-cyan-500 text-white px-4 py-2 rounded text-sm font-bold">
                                <i class="fa-solid fa-print mr-2"></i>åˆ—å°å»ºè­°å–®
                            </button>
                        </div>
                        <div class="bg-yellow-900/30 border border-yellow-600/50 rounded p-3 mb-3 text-sm">
                            <i class="fa-solid fa-triangle-exclamation text-yellow-400 mr-2"></i>
                            <span class="text-yellow-200">è«‹å€‰ç®¡åˆ°ç¾å ´ç¢ºèªï¼šæ£§æ¿ç‹€æ…‹ã€å †ç–Šå¹³æ•´åº¦ã€å¯¦éš›å¯å–ç”¨æ€§ï¼Œå†å‹¾é¸ç¢ºèª</span>
                        </div>
                        <div id="rm-picking-result" class="flex-1 overflow-auto">
                            <div class="text-center text-slate-500 py-20">
                                <i class="fa-solid fa-inbox text-4xl mb-4"></i>
                                <div>è«‹è¼¸å…¥å“åå’Œæ•¸é‡ï¼Œç³»çµ±å°‡åˆ—å‡ºç¬¦åˆæ¢ä»¶çš„å„²ä½ä¾›é¸æ“‡</div>
                            </div>
                        </div>
                        <div id="rm-picking-summary" class="border-t border-slate-700 pt-3 mt-3 hidden">
                            <div class="flex justify-between text-sm mb-2">
                                <span class="text-slate-400">å·²å‹¾é¸</span>
                                <span class="text-white font-bold" id="rm-selected-qty">0 ä»¶</span>
                            </div>
                            <div class="flex justify-between text-sm mb-3">
                                <span class="text-slate-400">éœ€æ±‚</span>
                                <span class="text-yellow-400" id="rm-required-qty">0 ä»¶</span>
                            </div>
                            <button onclick="confirmRmPicking()" class="w-full py-3 bg-green-600 hover:bg-green-500 text-white rounded font-bold">
                                <i class="fa-solid fa-check mr-2"></i>ç¢ºèªé ˜æ–™å‡ºåº«
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-shipping" class="view-panel h-full hidden flex flex-col">
                <!-- é ‚éƒ¨å·¥å…·åˆ— -->
                <div class="h-14 border-b border-slate-800 flex items-center px-4 gap-4 bg-slate-900/50">
                    <input type="file" id="excelInput" accept=".xlsx" class="hidden" onchange="handleExcelImport(event)">
                    <button onclick="document.getElementById('excelInput').click()" class="bg-emerald-600 text-white px-3 py-1.5 rounded text-xs font-bold hover:bg-emerald-500 shadow-lg flex items-center">
                        <i class="fa-solid fa-file-excel mr-2"></i>åŒ¯å…¥è¨‚å–®
                    </button>
                    <button onclick="downloadTemplate('order')" class="text-slate-400 text-xs hover:text-white underline">ç¯„æœ¬</button>
                    <button onclick="openManualOrderModal()" class="bg-blue-600 text-white px-3 py-1.5 rounded text-xs font-bold flex items-center">
                        <i class="fa-solid fa-plus mr-2"></i>æ‰‹å‹•æ–°å¢
                    </button>
                    <button onclick="exportShippingResult()" class="bg-slate-600 text-white px-3 py-1.5 rounded text-xs font-bold ml-2">
                        ğŸ“¤ åŒ¯å‡ºERP
                    </button>
                    <div class="flex items-center gap-2 border-l border-slate-700 pl-4">
                        <label class="text-xs text-slate-400">ç‰©æµ:</label>
                        <select id="filter-carrier" class="bg-slate-800 border border-slate-700 text-white text-xs rounded px-2 py-1.5" onchange="filterShippingList()">
                            <option value="ALL">å…¨éƒ¨</option>
                        </select>
                    </div>
                    <div class="text-xs text-slate-400 ml-auto">
                        å¾…å‡ºè²¨: <span class="text-white font-bold" id="order-count">0</span> å–®
                    </div>
                </div>

                <!-- ä¸»è¦å…§å®¹å€ -->
                <div class="flex-1 flex overflow-hidden">
                    <!-- å·¦å´ï¼šè¨‚å–®åˆ—è¡¨ -->
                    <div class="w-1/2 border-r border-slate-700 flex flex-col">
                        <div class="p-2 bg-slate-800 border-b border-slate-700">
                            <div class="text-sm font-bold text-white"><i class="fa-solid fa-list-check mr-2"></i>è¨‚å–®åˆ—è¡¨</div>
                        </div>
                        <div class="flex-1 overflow-auto p-2">
                            <table class="w-full dense-table text-left">
                                <thead>
                                    <tr>
                                        <th>ç‰©æµ</th>
                                        <th>å–®è™Ÿ</th>
                                        <th>å®¢æˆ¶</th>
                                        <th>å“é …</th>
                                        <th>æ•¸é‡</th>
                                        <th>ç‹€æ…‹</th>
                                        <th class="text-right">æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="shipping-list-body"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- å³å´ï¼šæ€è²¨æ˜ç´° -->
                    <div class="w-1/2 flex flex-col bg-slate-900/50">
                        <div class="p-2 bg-slate-800 border-b border-slate-700 flex justify-between items-center">
                            <div class="text-sm font-bold text-white"><i class="fa-solid fa-route mr-2 text-green-400"></i>æ€è²¨æ˜ç´°</div>
                            <button onclick="printOrderPickingSlip()" class="bg-green-600 hover:bg-green-500 text-white px-3 py-1 rounded text-xs font-bold">
                                <i class="fa-solid fa-print mr-1"></i>åˆ—å°æ€è²¨å–®
                            </button>
                        </div>
                        <div id="order-picking-detail" class="flex-1 overflow-auto p-3">
                            <div class="text-center text-slate-500 py-20">
                                <i class="fa-solid fa-hand-pointer text-4xl mb-4"></i>
                                <div>è«‹å¾å·¦å´é¸æ“‡è¨‚å–®æŸ¥çœ‹æ€è²¨æ˜ç´°</div>
                            </div>
                        </div>
                        <div id="order-picking-actions" class="p-3 border-t border-slate-700 hidden">
                            <button onclick="confirmOrderPicking()" class="w-full py-3 bg-green-600 hover:bg-green-500 text-white rounded font-bold">
                                <i class="fa-solid fa-check mr-2"></i>ç¢ºèªå‡ºè²¨å®Œæˆ
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ‰‹å‹•æ–°å¢è¨‚å–® Modal -->
            <div id="modal-manual-order" class="fixed inset-0 z-50 bg-black/80 hidden flex items-center justify-center">
                <div class="bg-slate-800 border border-slate-600 rounded-lg p-6 w-96">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-white font-bold"><i class="fa-solid fa-plus mr-2"></i>æ‰‹å‹•æ–°å¢å‡ºè²¨å–®</h3>
                        <button onclick="closeManualOrderModal()" class="text-slate-400 hover:text-white">&times;</button>
                    </div>
                    <div class="space-y-3">
                        <div>
                            <label class="text-xs text-slate-400">å®¢æˆ¶åç¨±</label>
                            <input type="text" id="manual-order-customer" class="scan-input" placeholder="å®¢æˆ¶åç¨±">
                        </div>
                        <div>
                            <label class="text-xs text-slate-400">å“å</label>
                            <input type="text" id="manual-order-product" class="scan-input" placeholder="å“å" oninput="searchProductForOrder()">
                            <div id="order-product-suggestions" class="max-h-24 overflow-y-auto mt-1"></div>
                        </div>
                        <div>
                            <label class="text-xs text-slate-400">è¦æ ¼</label>
                            <input type="text" id="manual-order-spec" class="scan-input" placeholder="è¦æ ¼" readonly>
                        </div>
                        <div>
                            <label class="text-xs text-slate-400">å‡ºè²¨æ•¸é‡</label>
                            <input type="number" id="manual-order-qty" class="scan-input text-center text-xl font-bold text-yellow-400" placeholder="0">
                        </div>
                        <div>
                            <label class="text-xs text-slate-400">ç‰©æµå•†</label>
                            <input type="text" id="manual-order-carrier" class="scan-input" placeholder="å¦‚ï¼šé»‘è²“ã€æ–°ç«¹ç‰©æµ">
                        </div>
                        <button onclick="createManualOrder()" class="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white rounded font-bold mt-4">
                            <i class="fa-solid fa-plus mr-2"></i>å»ºç«‹å‡ºè²¨å–®
                        </button>
                    </div>
                </div>
            </div>

            <div id="view-move" class="view-panel h-full hidden flex flex-col p-2 gap-2">
                <!-- é ‚éƒ¨æ¨™é¡Œåˆ— -->
                <div class="flex items-center justify-between bg-gradient-to-r from-blue-900 to-indigo-900 border border-blue-600 px-3 py-2 rounded-lg">
                    <div class="flex items-center gap-3">
                        <h2 class="text-white font-bold"><i class="fa-solid fa-clipboard-list mr-2 text-blue-400"></i>æ™ºèƒ½èª¿åº¦ä¸­å¿ƒ</h2>
                        <!-- çµ±è¨ˆè³‡è¨Š -->
                        <div class="flex items-center gap-2 text-sm" id="dispatch-stats-bar">
                            <span class="bg-orange-900/50 border border-orange-600/50 rounded px-2 py-0.5 text-orange-400">åˆä½µ <b class="text-white" id="stat-bar-merge">0</b></span>
                            <span class="bg-blue-900/50 border border-blue-600/50 rounded px-2 py-0.5 text-blue-400">ç§»ä½ <b class="text-white" id="stat-bar-move">0</b></span>
                            <span class="bg-emerald-900/50 border border-emerald-600/50 rounded px-2 py-0.5 text-emerald-400">é‡‹æ”¾ <b class="text-white" id="stat-bar-free">0</b></span>
                        </div>
                    </div>
                    <!-- æ“ä½œæŒ‰éˆ• -->
                    <div class="flex items-center gap-2">
                        <button onclick="startDispatchAnalysis()" class="px-3 py-1.5 bg-yellow-600 hover:bg-yellow-500 text-white rounded text-sm font-bold">
                            <i class="fa-solid fa-refresh mr-1"></i>é‡æ–°åˆ†æ
                        </button>
                        <button onclick="publishSelectedToMobile()" id="btn-publish-mobile" class="px-3 py-1.5 bg-purple-600 hover:bg-purple-500 text-white rounded text-sm font-bold disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            <i class="fa-solid fa-paper-plane mr-1"></i>ç™¼å¸ƒ (<span id="publish-count">0</span>)
                        </button>
                        <button onclick="printSelectedDispatchOrders()" id="btn-print-selected" class="px-3 py-1.5 bg-emerald-600 hover:bg-emerald-500 text-white rounded text-sm font-bold disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            <i class="fa-solid fa-print mr-1"></i>åˆ—å°
                        </button>
                    </div>
                </div>

                <!-- å·¥å–®é¸æ“‡å€ -->
                <div class="flex items-center gap-3 bg-slate-800/50 rounded px-3 py-2">
                    <label class="flex items-center gap-2 text-sm text-slate-300 cursor-pointer hover:text-white">
                        <input type="checkbox" id="dispatch-select-all" onchange="toggleAllDispatchOrders()" class="w-4 h-4 rounded accent-blue-500">
                        å…¨é¸
                    </label>
                    <span class="text-sm text-slate-400">å·²é¸ <span id="dispatch-selected-count" class="text-blue-400 font-bold">0</span> å€‹å·¥å–®</span>
                    <div class="flex-1"></div>
                    <span id="analysis-loading" class="hidden text-yellow-400 text-sm"><i class="fa-solid fa-spinner fa-spin mr-1"></i>åˆ†æä¸­...</span>
                </div>

                <!-- èª¿åº¦å·¥å–®åˆ—è¡¨ï¼ˆä¸»è¦å€åŸŸï¼‰-->
                <div class="flex-1 overflow-y-auto bg-slate-900/50 rounded-lg border border-slate-700 p-2" id="dispatch-orders-container">
                    <div class="text-center text-slate-500 py-10">
                        <i class="fa-solid fa-spinner fa-spin text-3xl mb-3"></i>
                        <div>æ­£åœ¨è‡ªå‹•åˆ†æåº«å­˜...</div>
                    </div>
                </div>
            </div>
            <div id="view-merge" class="view-panel h-full hidden flex flex-col p-4">
                <!-- æ¨™é¡Œåˆ— -->
                <div class="flex gap-2 mb-3">
                    <button onclick="setMergeMode('move')" id="btn-mode-move" class="flex-1 py-3 bg-blue-600 text-white rounded-lg font-bold text-lg border-2 border-blue-400">
                        <i class="fa-solid fa-dolly mr-2"></i>ç§»å‹•å„²ä½
                    </button>
                    <button onclick="setMergeMode('merge')" id="btn-mode-merge" class="flex-1 py-3 bg-slate-800 text-slate-400 rounded-lg font-bold text-lg border-2 border-slate-600">
                        <i class="fa-solid fa-compress mr-2"></i>åˆä½µåº«å­˜
                    </button>
                </div>

                <!-- ç§»å‹•æ¨¡å¼ -->
                <div id="panel-move" class="flex-1 flex flex-col max-w-2xl mx-auto w-full">
                    <!-- Step 1: é¸æ“‡è²¨ç‰© -->
                    <div class="bg-slate-800 border border-slate-600 rounded-lg p-4 mb-3">
                        <div class="flex items-center gap-2 mb-3">
                            <div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center text-white font-bold">1</div>
                            <span class="text-white font-bold">é¸æ“‡è¦ç§»å‹•çš„è²¨ç‰©</span>
                        </div>
                        <div class="flex gap-2 mb-2">
                            <input type="text" id="move-pallet-id" class="scan-input flex-1 text-lg" placeholder="æƒææˆ–è¼¸å…¥å…¥åº«å–®è™Ÿ" onchange="lookupPalletByDocNo(this.value, 'move')">
                            <button onclick="openMoveFallback()" class="px-3 bg-yellow-600 hover:bg-yellow-500 text-white rounded font-bold text-sm">
                                <i class="fa-solid fa-search mr-1"></i>æŸ¥è©¢
                            </button>
                        </div>
                        <div id="move-pallet-info" class="bg-slate-900 rounded p-2 min-h-[50px] text-sm">
                            <div class="text-slate-500 text-center py-2"><i class="fa-solid fa-barcode mr-2"></i>ç­‰å¾…æƒæ...</div>
                        </div>
                    </div>

                    <!-- Step 2: ç›®æ¨™å„²ä½ -->
                    <div class="bg-slate-800 border border-slate-600 rounded-lg p-4 mb-3">
                        <div class="flex items-center gap-2 mb-3">
                            <div class="w-8 h-8 rounded-full bg-emerald-600 flex items-center justify-center text-white font-bold">2</div>
                            <span class="text-white font-bold">è¼¸å…¥ç›®æ¨™å„²ä½</span>
                        </div>
                        <input type="text" id="move-target-loc" class="scan-input text-xl text-center font-bold tracking-wider" placeholder="I-A-05-2F">
                    </div>

                    <!-- ç¢ºèªæŒ‰éˆ• -->
                    <button onclick="executePalletMove()" class="py-4 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-bold text-xl">
                        <i class="fa-solid fa-check mr-2"></i>ç¢ºèªç§»å‹•
                    </button>
                </div>

                <!-- ç§»å‹•å‚™æ¡ˆé¢æ¿ -->
                <div id="panel-move-fallback" class="fixed inset-0 z-50 bg-black/80 hidden flex items-center justify-center p-4">
                    <div class="bg-slate-800 rounded-xl w-full max-w-lg max-h-[70vh] flex flex-col">
                        <div class="flex justify-between items-center p-3 border-b border-slate-700">
                            <div class="text-white font-bold"><i class="fa-solid fa-search mr-2 text-yellow-400"></i>æŸ¥è©¢åº«å­˜</div>
                            <button onclick="closeMoveFallback()" class="text-slate-400 hover:text-white text-xl"><i class="fa-solid fa-xmark"></i></button>
                        </div>
                        <div class="p-3 border-b border-slate-700">
                            <div class="flex gap-2">
                                <input type="text" id="fallback-move-loc" class="scan-input flex-1" placeholder="å„²ä½ I-A-03-2F" onchange="searchPalletsByLocation(this.value, 'move')">
                                <input type="text" id="fallback-move-search" class="scan-input flex-1" placeholder="å“å" oninput="searchPalletsByName(this.value, 'move')">
                            </div>
                        </div>
                        <div id="fallback-move-list" class="flex-1 overflow-y-auto p-2">
                            <div class="text-slate-500 text-center py-6">è¼¸å…¥å„²ä½æˆ–å“åæœå°‹</div>
                        </div>
                    </div>
                </div>

                <!-- åˆä½µæ¨¡å¼ -->
                <div id="panel-merge" class="flex-1 flex-col hidden max-w-2xl mx-auto w-full">
                    <!-- ä¾†æºA -->
                    <div class="bg-slate-800 border border-purple-600 rounded-lg p-4 mb-2">
                        <div class="flex items-center gap-2 mb-2">
                            <div class="w-8 h-8 rounded-full bg-purple-600 flex items-center justify-center text-white font-bold">A</div>
                            <span class="text-white font-bold">ä¿ç•™çš„åº«å­˜ <span class="text-purple-400 text-sm">ï¼ˆæ•¸é‡æœƒå¢åŠ ï¼‰</span></span>
                        </div>
                        <div class="flex gap-2 mb-2">
                            <input type="text" id="merge-keep-id" class="scan-input flex-1" placeholder="æƒæå…¥åº«å–®è™Ÿ" onchange="lookupPalletByDocNo(this.value, 'keep')">
                            <button onclick="openMergeFallback('keep')" class="px-3 bg-yellow-600 hover:bg-yellow-500 text-white rounded text-sm">
                                <i class="fa-solid fa-search"></i>
                            </button>
                        </div>
                        <div id="merge-keep-info" class="bg-slate-900 rounded p-2 min-h-[40px] text-sm">
                            <div class="text-slate-500 text-center py-1"><i class="fa-solid fa-barcode mr-1"></i>ç­‰å¾…æƒæ...</div>
                        </div>
                    </div>

                    <!-- åŠ è™Ÿ -->
                    <div class="text-center text-2xl text-slate-600 py-1"><i class="fa-solid fa-plus"></i></div>

                    <!-- ä¾†æºB -->
                    <div class="bg-slate-800 border border-orange-600 rounded-lg p-4 mb-3">
                        <div class="flex items-center gap-2 mb-2">
                            <div class="w-8 h-8 rounded-full bg-orange-600 flex items-center justify-center text-white font-bold">B</div>
                            <span class="text-white font-bold">ç§»å…¥çš„åº«å­˜ <span class="text-orange-400 text-sm">ï¼ˆå°‡è¢«åˆªé™¤ï¼‰</span></span>
                        </div>
                        <div class="flex gap-2 mb-2">
                            <input type="text" id="merge-remove-id" class="scan-input flex-1" placeholder="æƒæå…¥åº«å–®è™Ÿ" onchange="lookupPalletByDocNo(this.value, 'remove')">
                            <button onclick="openMergeFallback('remove')" class="px-3 bg-yellow-600 hover:bg-yellow-500 text-white rounded text-sm">
                                <i class="fa-solid fa-search"></i>
                            </button>
                        </div>
                        <div id="merge-remove-info" class="bg-slate-900 rounded p-2 min-h-[40px] text-sm">
                            <div class="text-slate-500 text-center py-1"><i class="fa-solid fa-barcode mr-1"></i>ç­‰å¾…æƒæ...</div>
                        </div>
                    </div>

                    <!-- ç¢ºèªæŒ‰éˆ• -->
                    <button onclick="executePalletMerge()" class="py-4 bg-purple-600 hover:bg-purple-500 text-white rounded-lg font-bold text-xl">
                        <i class="fa-solid fa-compress mr-2"></i>ç¢ºèªåˆä½µ
                    </button>
                </div>

                <!-- åˆä½µå‚™æ¡ˆé¢æ¿ -->
                <div id="panel-merge-fallback" class="fixed inset-0 z-50 bg-black/80 hidden flex items-center justify-center p-4">
                    <div class="bg-slate-800 rounded-xl w-full max-w-lg max-h-[70vh] flex flex-col">
                        <div class="flex justify-between items-center p-3 border-b border-slate-700">
                            <div class="text-white font-bold"><i class="fa-solid fa-search mr-2 text-yellow-400"></i>æŸ¥è©¢åº«å­˜ <span id="merge-fallback-target" class="text-slate-400 text-sm"></span></div>
                            <button onclick="closeMergeFallback()" class="text-slate-400 hover:text-white text-xl"><i class="fa-solid fa-xmark"></i></button>
                        </div>
                        <div class="p-3 border-b border-slate-700">
                            <div class="flex gap-2">
                                <input type="text" id="fallback-merge-loc" class="scan-input flex-1" placeholder="å„²ä½" onchange="searchPalletsByLocation(this.value, 'merge')">
                                <input type="text" id="fallback-merge-search" class="scan-input flex-1" placeholder="å“å" oninput="searchPalletsByName(this.value, 'merge')">
                            </div>
                        </div>
                        <div id="fallback-merge-list" class="flex-1 overflow-y-auto p-2">
                            <div class="text-slate-500 text-center py-6">è¼¸å…¥å„²ä½æˆ–å“åæœå°‹</div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="view-stocktake" class="view-panel h-full hidden p-6"><div class="flex justify-between items-center mb-6"><h3 class="text-white font-bold">ç›¤é»ä»»å‹™</h3><button class="px-4 py-2 bg-blue-600 text-white rounded text-sm font-bold shadow-lg">å»ºç«‹ç›¤é»å–®</button></div><div class="glass-panel p-5 border border-slate-600 relative opacity-50"><div class="text-center py-10 text-slate-500">å°šç„¡ä»»å‹™</div></div></div>

            <!-- å¤–éƒ¨å€‰åº«ç®¡ç† -->

            <!-- å ±è¡¨ä¸­å¿ƒ -->
            <!-- ç†è²¨å ±è¡¨ä¸­å¿ƒ - å·¦å³æ¬„ä½ˆå±€ -->
            <div id="view-picking-reports" class="view-panel h-full hidden flex flex-col p-4">
                <!-- é ‚éƒ¨æ¨™é¡Œåˆ— -->
                <div class="flex items-center justify-between bg-gradient-to-r from-green-900 to-emerald-900 border border-green-600 p-3 rounded-xl mb-3">
                    <div class="flex items-center gap-3">
                        <i class="fa-solid fa-file-export text-3xl text-green-400"></i>
                        <div>
                            <h2 class="text-white font-bold text-xl">ç†è²¨å ±è¡¨ä¸­å¿ƒ</h2>
                            <p class="text-green-200 text-xs">å‡ºè²¨çµ±è¨ˆ | åº«å­˜åˆ†æ | æ³¢æ¬¡æ•ˆç‡ | Excel åŒ¯å‡º</p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="generateTodayReport()" class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-2 rounded-lg text-sm font-bold">
                            <i class="fa-solid fa-sun mr-1"></i>ä»Šæ—¥å ±è¡¨
                        </button>
                        <button onclick="generateLowStockReport()" class="bg-red-600 hover:bg-red-500 text-white px-3 py-2 rounded-lg text-sm font-bold">
                            <i class="fa-solid fa-triangle-exclamation mr-1"></i>ä½åº«å­˜
                        </button>
                    </div>
                </div>

                <!-- å·¦å³æ¬„ä¸»é«” -->
                <div class="flex-1 flex gap-3 min-h-0">
                    <!-- å·¦æ¬„ï¼šæ—¥æœŸé¸æ“‡ + å ±è¡¨é¡å‹ -->
                    <div class="w-72 flex flex-col gap-3 flex-shrink-0">
                        <!-- æ—¥æœŸé¸æ“‡ -->
                        <div class="bg-slate-800/80 border border-slate-700 rounded-xl p-3">
                            <h3 class="text-white font-bold text-sm mb-3 flex items-center">
                                <i class="fa-solid fa-calendar-days mr-2 text-blue-400"></i>æŸ¥è©¢å€é–“
                            </h3>
                            <div class="space-y-2">
                                <div>
                                    <label class="text-slate-400 text-xs mb-1 block">é–‹å§‹æ—¥æœŸ</label>
                                    <input type="date" id="report-date-from" class="scan-input w-full text-sm">
                                </div>
                                <div>
                                    <label class="text-slate-400 text-xs mb-1 block">çµæŸæ—¥æœŸ</label>
                                    <input type="date" id="report-date-to" class="scan-input w-full text-sm">
                                </div>
                                <div>
                                    <label class="text-slate-400 text-xs mb-1 block">å¿«é€Ÿé¸æ“‡</label>
                                    <select id="report-quick-date" class="scan-input w-full text-sm" onchange="setQuickDateRange()">
                                        <option value="">è‡ªè¨‚å€é–“</option>
                                        <option value="today">ä»Šå¤©</option>
                                        <option value="yesterday">æ˜¨å¤©</option>
                                        <option value="week">æœ¬é€±</option>
                                        <option value="month">æœ¬æœˆ</option>
                                        <option value="lastmonth">ä¸Šæœˆ</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- å ±è¡¨é¡å‹é¸å–® -->
                        <div class="flex-1 bg-slate-800/80 border border-slate-700 rounded-xl p-3 overflow-auto">
                            <h3 class="text-white font-bold text-sm mb-3 flex items-center">
                                <i class="fa-solid fa-list mr-2 text-green-400"></i>å ±è¡¨é¡å‹
                            </h3>

                            <!-- å‡ºè²¨å ±è¡¨ -->
                            <div class="mb-3">
                                <div class="text-xs text-blue-400 font-bold mb-2 flex items-center">
                                    <i class="fa-solid fa-truck mr-1"></i>å‡ºè²¨å ±è¡¨
                                </div>
                                <div class="space-y-1">
                                    <button onclick="generateReport('shipping-logistics')" class="report-btn w-full">
                                        <i class="fa-solid fa-truck-fast text-blue-400"></i>ä¾ç‰©æµå•†çµ±è¨ˆ
                                    </button>
                                    <button onclick="generateReport('shipping-customer')" class="report-btn w-full">
                                        <i class="fa-solid fa-users text-green-400"></i>ä¾å®¢æˆ¶çµ±è¨ˆ
                                    </button>
                                    <button onclick="generateReport('shipping-product')" class="report-btn w-full">
                                        <i class="fa-solid fa-box text-yellow-400"></i>ä¾ç”¢å“çµ±è¨ˆ
                                    </button>
                                </div>
                            </div>

                            <!-- åº«å­˜å ±è¡¨ -->
                            <div class="mb-3">
                                <div class="text-xs text-orange-400 font-bold mb-2 flex items-center">
                                    <i class="fa-solid fa-warehouse mr-1"></i>åº«å­˜å ±è¡¨
                                </div>
                                <div class="space-y-1">
                                    <button onclick="generateReport('inventory-summary')" class="report-btn w-full">
                                        <i class="fa-solid fa-chart-pie text-cyan-400"></i>åº«å­˜å½™ç¸½
                                    </button>
                                    <button onclick="generateReport('inventory-expiry')" class="report-btn w-full">
                                        <i class="fa-solid fa-calendar-xmark text-red-400"></i>æ•ˆæœŸé è­¦
                                    </button>
                                </div>
                            </div>

                            <!-- æ³¢æ¬¡å ±è¡¨ -->
                            <div class="mb-3">
                                <div class="text-xs text-purple-400 font-bold mb-2 flex items-center">
                                    <i class="fa-solid fa-layer-group mr-1"></i>æ³¢æ¬¡å ±è¡¨
                                </div>
                                <div class="space-y-1">
                                    <button onclick="generateReport('wave-summary')" class="report-btn w-full">
                                        <i class="fa-solid fa-chart-bar text-blue-400"></i>æ³¢æ¬¡çµ±è¨ˆ
                                    </button>
                                    <button onclick="generateReport('wave-efficiency')" class="report-btn w-full">
                                        <i class="fa-solid fa-gauge-high text-green-400"></i>æ€è²¨æ•ˆç‡
                                    </button>
                                </div>
                            </div>

                            <!-- è¨‚å–®å ±è¡¨ -->
                            <div class="mb-3">
                                <div class="text-xs text-yellow-400 font-bold mb-2 flex items-center">
                                    <i class="fa-solid fa-receipt mr-1"></i>è¨‚å–®å ±è¡¨
                                </div>
                                <div class="space-y-1">
                                    <button onclick="generateReport('order-status')" class="report-btn w-full">
                                        <i class="fa-solid fa-list-check text-blue-400"></i>è¨‚å–®ç‹€æ…‹çµ±è¨ˆ
                                    </button>
                                    <button onclick="generateReport('pending-orders')" class="report-btn w-full">
                                        <i class="fa-solid fa-clock text-yellow-400"></i>å¾…è™•ç†è¨‚å–®
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- å³æ¬„ï¼šå ±è¡¨é è¦½å€ï¼ˆä¸»è¦å€åŸŸï¼‰ -->
                    <div class="flex-1 bg-slate-800/50 border border-slate-700 rounded-xl overflow-hidden flex flex-col min-w-0">
                        <!-- é è¦½å€æ¨™é¡Œåˆ— -->
                        <div class="bg-slate-900 p-3 border-b border-slate-700 flex justify-between items-center flex-shrink-0">
                            <h3 class="text-white font-bold flex items-center">
                                <i class="fa-solid fa-eye mr-2 text-slate-400"></i>
                                å ±è¡¨é è¦½
                                <span id="report-title-hint" class="ml-2 text-sm font-normal text-slate-500"></span>
                            </h3>
                            <div class="flex gap-2">
                                <button onclick="exportReportExcel()" class="bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded-lg text-sm font-bold transition">
                                    <i class="fa-solid fa-file-excel mr-1"></i>åŒ¯å‡º Excel
                                </button>
                                <button onclick="printReport()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-bold transition">
                                    <i class="fa-solid fa-print mr-1"></i>åˆ—å°
                                </button>
                            </div>
                        </div>
                        <!-- é è¦½å…§å®¹å€ -->
                        <div class="flex-1 overflow-auto p-4" id="report-preview-area">
                            <div class="h-full flex flex-col items-center justify-center text-slate-500">
                                <i class="fa-solid fa-chart-simple text-8xl mb-6 opacity-30"></i>
                                <div class="text-xl mb-2">è«‹å¾å·¦å´é¸æ“‡å ±è¡¨é¡å‹</div>
                                <div class="text-sm text-slate-600">æ”¯æ´ Excel åŒ¯å‡ºåŠåˆ—å°åŠŸèƒ½</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-external-warehouse" class="view-panel h-full hidden flex flex-col p-4">
                <!-- é ‚éƒ¨æ§åˆ¶å€ -->
                <div class="glass-panel p-3 mb-3">
                    <div class="flex items-center gap-4 flex-wrap">
                        <div class="flex items-center gap-2">
                            <i class="fa-solid fa-building text-cyan-400"></i>
                            <span class="text-white font-bold">å¤–éƒ¨å€‰åº«ç®¡ç†</span>
                        </div>
                        <div class="w-px h-6 bg-slate-600"></div>
                        <!-- å…¬å¸é¸æ“‡ -->
                        <div class="flex items-center gap-2">
                            <span class="text-slate-400 text-xs">å…¬å¸ï¼š</span>
                            <button onclick="setExtCompany('all')" id="btn-ext-all" class="px-3 py-1.5 rounded text-xs font-bold bg-slate-600 text-white">å…¨éƒ¨</button>
                            <button onclick="setExtCompany('å´‡æ–‡')" id="btn-ext-cw" class="px-3 py-1.5 rounded text-xs font-bold bg-slate-700 text-slate-300 hover:bg-slate-600">å´‡æ–‡</button>
                            <button onclick="setExtCompany('å…«æ–¹')" id="btn-ext-bf" class="px-3 py-1.5 rounded text-xs font-bold bg-slate-700 text-slate-300 hover:bg-slate-600">å…«æ–¹</button>
                        </div>
                        <div class="w-px h-6 bg-slate-600"></div>
                        <!-- å€‰åº«ç¯©é¸ -->
                        <select id="ext-wh-filter" class="scan-input text-xs w-40" onchange="filterExternalWarehouse(this.value)">
                            <option value="">å…¨éƒ¨å¤–å€‰</option>
                        </select>
                        <button onclick="exportExternalStock()" class="bg-emerald-600 hover:bg-emerald-500 text-white px-3 py-1.5 rounded text-xs font-bold ml-auto">
                            <i class="fa-solid fa-file-excel mr-1"></i>åŒ¯å‡º
                        </button>
                    </div>
                </div>

                <div class="flex gap-3 flex-1 min-h-0">
                    <!-- å·¦å´ï¼šå¤–å€‰åº«å­˜åˆ—è¡¨ -->
                    <div class="flex-1 glass-panel p-3 flex flex-col">
                        <div class="flex justify-between items-center mb-2 border-b border-slate-700 pb-2">
                            <h3 class="text-white font-bold text-sm"><i class="fa-solid fa-boxes-stacked mr-2 text-cyan-400"></i>å¤–å€‰åº«å­˜æ˜ç´°</h3>
                            <span class="text-xs text-slate-400" id="ext-stock-count">0 ç­†</span>
                        </div>
                        <div class="flex-1 overflow-auto">
                            <table class="w-full text-xs">
                                <thead class="sticky top-0 bg-slate-800">
                                    <tr class="text-slate-400">
                                        <th class="text-left p-2">å…¬å¸</th>
                                        <th class="text-left p-2">å€‰åº«</th>
                                        <th class="text-left p-2">å“å</th>
                                        <th class="text-left p-2">è¦æ ¼</th>
                                        <th class="text-left p-2">æ‰¹è™Ÿ</th>
                                        <th class="text-right p-2">æ•¸é‡</th>
                                        <th class="text-left p-2">æ•ˆæœŸ</th>
                                        <th class="text-center p-2">æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="external-stock-list">
                                    <tr><td colspan="8" class="text-center text-slate-500 py-10">è¼‰å…¥ä¸­...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- å³å´ï¼šæ‰‹å‹•èª¿æ•´/å°å¸³ -->
                    <div class="w-72 glass-panel p-3 flex flex-col">
                        <h3 class="text-white font-bold text-sm mb-2 border-b border-slate-700 pb-2">
                            <i class="fa-solid fa-pen-to-square mr-2 text-yellow-400"></i>åº«å­˜èª¿æ•´/å°å¸³
                        </h3>
                        <div class="space-y-2">
                            <!-- å…¬å¸é¸æ“‡ -->
                            <div>
                                <label class="text-xs text-slate-400">å…¬å¸ *</label>
                                <div class="flex gap-1 bg-slate-900 rounded p-1">
                                    <label class="flex-1 cursor-pointer">
                                        <input type="radio" name="ext-adj-company" value="å´‡æ–‡" class="hidden peer" checked>
                                        <div class="text-center py-1 rounded text-xs font-bold peer-checked:bg-blue-600 peer-checked:text-white text-slate-400">å´‡æ–‡</div>
                                    </label>
                                    <label class="flex-1 cursor-pointer">
                                        <input type="radio" name="ext-adj-company" value="å…«æ–¹" class="hidden peer">
                                        <div class="text-center py-1 rounded text-xs font-bold peer-checked:bg-purple-600 peer-checked:text-white text-slate-400">å…«æ–¹</div>
                                    </label>
                                </div>
                            </div>
                            <div>
                                <label class="text-xs text-slate-400">å¤–å€‰ *</label>
                                <select id="ext-adj-wh" class="scan-input text-sm">
                                    <option value="">é¸æ“‡å€‰åº«</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs text-slate-400">å“å *</label>
                                <input type="text" id="ext-adj-name" class="scan-input text-sm" placeholder="å“å">
                            </div>
                            <div>
                                <label class="text-xs text-slate-400">è¦æ ¼</label>
                                <input type="text" id="ext-adj-spec" class="scan-input" placeholder="è¦æ ¼">
                            </div>
                            <div>
                                <label class="text-xs text-slate-400">æ‰¹è™Ÿ *ï¼ˆè‡ªç”¢/é€²å£/å¤§å®—å¿…å¡«ï¼‰</label>
                                <input type="text" id="ext-adj-batch" class="scan-input" placeholder="æ‰¹è™Ÿ">
                            </div>
                            <div>
                                <label class="text-xs text-red-400">æ•ˆæœŸ *ï¼ˆå¿…å¡«ï¼‰</label>
                                <input type="date" id="ext-adj-exp" class="scan-input border-red-500/50">
                            </div>
                            <div>
                                <label class="text-xs text-slate-400">èª¿æ•´æ•¸é‡ *</label>
                                <input type="number" id="ext-adj-qty" class="scan-input text-center font-bold" placeholder="æ­£æ•¸å¢åŠ /è² æ•¸æ¸›å°‘">
                            </div>
                            <div>
                                <label class="text-xs text-slate-400">èª¿æ•´åŸå› </label>
                                <select id="ext-adj-reason" class="scan-input">
                                    <option value="ç›¤é»èª¿æ•´">ç›¤é»èª¿æ•´</option>
                                    <option value="å¤–å€‰å‡ºè²¨">å¤–å€‰å‡ºè²¨ï¼ˆæ‰£åº«å­˜ï¼‰</option>
                                    <option value="å¤–å€‰æ”¶è²¨">å¤–å€‰æ”¶è²¨ï¼ˆåŠ åº«å­˜ï¼‰</option>
                                    <option value="æè€—å ±å»¢">æè€—å ±å»¢</option>
                                    <option value="å…¶ä»–">å…¶ä»–</option>
                                </select>
                            </div>
                            <button onclick="submitExternalAdjust()" class="w-full py-3 bg-yellow-600 hover:bg-yellow-500 text-white rounded font-bold mt-2">
                                <i class="fa-solid fa-check mr-2"></i>ç¢ºèªèª¿æ•´
                            </button>
                        </div>

                        <div class="mt-4 pt-4 border-t border-slate-700">
                            <h4 class="text-white font-bold text-sm mb-2"><i class="fa-solid fa-file-import mr-2 text-emerald-400"></i>æ‰¹æ¬¡åŒ¯å…¥å°å¸³</h4>
                            <p class="text-xs text-slate-500 mb-2">åŒ¯å…¥å¤–å€‰æä¾›çš„åº«å­˜è¡¨é€²è¡Œå°å¸³</p>
                            <input type="file" id="ext-import-file" accept=".xlsx,.csv" class="hidden" onchange="handleExternalImport(event)">
                            <button onclick="document.getElementById('ext-import-file').click()" class="w-full py-2 bg-emerald-600 hover:bg-emerald-500 text-white rounded text-sm font-bold">
                                <i class="fa-solid fa-upload mr-2"></i>ä¸Šå‚³å¤–å€‰åº«å­˜è¡¨
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å€‰åº«èª¿æ’¥ -->
            <div id="view-transfer" class="view-panel h-full hidden flex flex-col p-4">
                <!-- é ‚éƒ¨æ§åˆ¶åˆ—ï¼šå…¬å¸é¸æ“‡å’Œèª¿æ’¥æ–¹å‘ -->
                <div class="glass-panel p-3 mb-3">
                    <div class="flex items-center gap-4 flex-wrap">
                        <!-- æ¨™é¡Œ -->
                        <div class="flex items-center gap-2">
                            <i class="fa-solid fa-right-left text-purple-400"></i>
                            <span class="text-white font-bold">å€‰åº«èª¿æ’¥</span>
                        </div>

                        <div class="w-px h-6 bg-slate-600"></div>

                        <!-- å…¬å¸é¸æ“‡ -->
                        <div class="flex items-center gap-2">
                            <span class="text-slate-400 text-xs">å…¬å¸ï¼š</span>
                            <button onclick="setTransferCompany('å´‡æ–‡')" id="btn-transfer-cw" class="px-3 py-1.5 rounded font-bold text-xs bg-blue-600 text-white">å´‡æ–‡</button>
                            <button onclick="setTransferCompany('å…«æ–¹')" id="btn-transfer-bf" class="px-3 py-1.5 rounded font-bold text-xs bg-slate-700 text-slate-300 hover:bg-slate-600">å…«æ–¹</button>
                        </div>

                        <div class="w-px h-6 bg-slate-600"></div>

                        <!-- èª¿æ’¥æ–¹å‘ -->
                        <div class="flex items-center gap-2">
                            <span class="text-slate-400 text-xs">èª¿æ’¥æ–¹å‘ï¼š</span>
                            <button onclick="setTransferMode('in')" id="btn-mode-in" class="px-3 py-1.5 rounded font-bold text-xs bg-emerald-600 text-white">
                                <i class="fa-solid fa-arrow-right mr-1"></i>èª¿æ’¥å…¥åº«
                            </button>
                            <button onclick="setTransferMode('out')" id="btn-mode-out" class="px-3 py-1.5 rounded font-bold text-xs bg-slate-700 text-slate-300 hover:bg-slate-600">
                                <i class="fa-solid fa-arrow-left mr-1"></i>èª¿æ’¥å‡ºåº«
                            </button>
                            <button onclick="setTransferMode('ext')" id="btn-mode-ext" class="px-3 py-1.5 rounded font-bold text-xs bg-slate-700 text-slate-300 hover:bg-slate-600">
                                <i class="fa-solid fa-arrows-left-right mr-1"></i>å¤–åº«èª¿æ’¥
                            </button>
                        </div>

                        <!-- èªªæ˜æ–‡å­— -->
                        <div class="ml-auto text-xs" id="transfer-mode-desc">
                            <span class="text-emerald-400"><i class="fa-solid fa-info-circle mr-1"></i>å¤–å€‰ â†’ é€²è²¨æš«å­˜å€ï¼ˆä¹‹å¾Œç§»æ¿ä¸Šæ¶ï¼‰</span>
                        </div>
                    </div>
                </div>

                <div class="flex gap-3 flex-1 min-h-0">
                    <!-- å·¦å´ï¼šèª¿æ’¥è¨­å®š -->
                    <div class="w-80 glass-panel p-3 flex flex-col">
                        <h3 class="text-white font-bold mb-2 border-b border-slate-700 pb-2 text-sm" id="transfer-form-title">
                            <i class="fa-solid fa-truck-arrow-right mr-2 text-emerald-400"></i>èª¿æ’¥å…¥åº«ï¼ˆå¤–å€‰â†’æœ¬å€‰ï¼‰
                        </h3>

                        <div class="space-y-2 flex-1 overflow-auto">
                            <!-- ä¾†æº/ç›®æ¨™å€‰åº« -->
                            <div class="grid grid-cols-2 gap-2" id="transfer-warehouse-row">
                                <div id="transfer-source-div">
                                    <label class="text-xs text-slate-400" id="transfer-source-label">ä¾†æºå¤–å€‰ *</label>
                                    <select id="transfer-source" class="scan-input text-sm" onchange="onTransferSourceChange()">
                                        <option value="">é¸æ“‡å¤–å€‰</option>
                                    </select>
                                </div>
                                <div id="transfer-target-div" style="display:none;">
                                    <label class="text-xs text-slate-400">ç›®æ¨™å¤–å€‰ *</label>
                                    <select id="transfer-target" class="scan-input text-sm">
                                        <option value="">é¸æ“‡å¤–å€‰</option>
                                    </select>
                                </div>
                            </div>

                            <!-- å“åæœå°‹ -->
                            <div>
                                <label class="text-xs text-slate-400">å“å *</label>
                                <input type="text" id="transfer-product" class="scan-input text-sm" placeholder="æœå°‹å“å..." oninput="searchTransferProduct()">
                                <div id="transfer-product-list" class="max-h-28 overflow-y-auto bg-slate-800 rounded mt-1"></div>
                            </div>

                            <!-- è¦æ ¼/æ‰¹è™Ÿ -->
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="text-xs text-slate-400">è¦æ ¼</label>
                                    <input type="text" id="transfer-spec" class="scan-input text-sm" readonly>
                                </div>
                                <div>
                                    <label class="text-xs text-slate-400">æ‰¹è™Ÿ</label>
                                    <input type="text" id="transfer-batch" class="scan-input text-sm" readonly>
                                </div>
                            </div>

                            <!-- æ•ˆæœŸ -->
                            <div>
                                <label class="text-xs text-slate-400">æ•ˆæœŸ</label>
                                <input type="text" id="transfer-exp" class="scan-input text-sm" readonly>
                            </div>

                            <!-- ä¾†æºå„²ä½ï¼ˆèª¿æ’¥å‡ºåº«å°ˆç”¨ï¼‰ -->
                            <div id="transfer-location-div" style="display:none;">
                                <label class="text-xs text-slate-400">ä¾†æºå„²ä½ *</label>
                                <select id="transfer-location" class="scan-input text-sm" onchange="onTransferLocationChange()">
                                    <option value="">é¸æ“‡å„²ä½</option>
                                </select>
                            </div>

                            <!-- å¯èª¿æ•¸é‡ -->
                            <div class="flex items-center gap-4">
                                <div>
                                    <label class="text-xs text-slate-400">å¯èª¿æ•¸é‡</label>
                                    <div class="text-lg font-bold text-yellow-400" id="transfer-available">0</div>
                                </div>
                            </div>

                            <!-- èª¿æ’¥æ•¸é‡ -->
                            <div>
                                <label class="text-xs text-slate-400">èª¿æ’¥æ•¸é‡ *</label>
                                <input type="number" id="transfer-qty" class="scan-input text-center text-lg font-bold" placeholder="0" min="1">
                            </div>

                            <!-- èª¿æ’¥å…¥åº«è™•ç†æ–¹å¼ï¼ˆåƒ…èª¿æ’¥å…¥åº«æ¨¡å¼é¡¯ç¤ºï¼‰ -->
                            <div id="transfer-in-options" class="bg-slate-800 rounded-lg p-2 border border-slate-600">
                                <label class="text-xs text-slate-400 mb-1.5 block">å…¥åº«å¾Œè™•ç†æ–¹å¼</label>
                                <div class="space-y-1.5">
                                    <label class="flex items-center gap-2 cursor-pointer p-1.5 rounded hover:bg-slate-700">
                                        <input type="radio" name="transfer-in-method" value="pending" class="text-emerald-500" checked>
                                        <div class="flex-1">
                                            <span class="text-white text-sm font-bold">ç”¢ç”Ÿå¾…åŸ·è¡Œå·¥å–®</span>
                                            <div class="text-slate-400 text-xs">æ¨é€åˆ°æ™ºèƒ½å…¥åº«ä¸­å¿ƒï¼Œç”±ç¾å ´äººå“¡æƒæé¸ä½å…¥åº«</div>
                                        </div>
                                        <span class="text-emerald-400 text-xs px-1.5 py-0.5 bg-emerald-900/50 rounded">å»ºè­°</span>
                                    </label>
                                    <label class="flex items-center gap-2 cursor-pointer p-1.5 rounded hover:bg-slate-700">
                                        <input type="radio" name="transfer-in-method" value="temp" class="text-yellow-500">
                                        <div class="flex-1">
                                            <span class="text-white text-sm">å…¥æš«å­˜å€</span>
                                            <div class="text-slate-400 text-xs">ç›´æ¥å…¥é€²è²¨æš«å­˜å€ï¼ˆTEMP-INï¼‰ï¼Œä¹‹å¾Œæ‰‹å‹•ç§»ä½</div>
                                        </div>
                                    </label>
                                </div>
                            </div>

                            <!-- åŠ å…¥æŒ‰éˆ• -->
                            <button onclick="addTransferItem()" class="w-full py-2 bg-blue-600 hover:bg-blue-500 text-white rounded font-bold text-sm">
                                <i class="fa-solid fa-plus mr-1"></i>åŠ å…¥èª¿æ’¥æ¸…å–®
                            </button>
                        </div>
                    </div>

                    <!-- å³å´ï¼šèª¿æ’¥æ¸…å–® -->
                    <div class="flex-1 glass-panel p-3 flex flex-col">
                        <div class="flex justify-between items-center mb-2 border-b border-slate-700 pb-2">
                            <h3 class="text-white font-bold text-sm"><i class="fa-solid fa-list-check mr-2 text-yellow-400"></i>èª¿æ’¥æ¸…å–®</h3>
                            <button onclick="clearTransferList()" class="bg-slate-700 hover:bg-slate-600 text-white px-2 py-1 rounded text-xs">
                                <i class="fa-solid fa-trash mr-1"></i>æ¸…ç©º
                            </button>
                        </div>
                        <div class="flex-1 overflow-auto">
                            <table class="w-full text-xs">
                                <thead class="sticky top-0 bg-slate-800">
                                    <tr class="text-slate-400">
                                        <th class="text-left p-1.5">å“å</th>
                                        <th class="text-left p-1.5">è¦æ ¼</th>
                                        <th class="text-left p-1.5">æ‰¹è™Ÿ</th>
                                        <th class="text-left p-1.5">æ•ˆæœŸ</th>
                                        <th class="text-left p-1.5">ä¾†æº</th>
                                        <th class="text-left p-1.5">ç›®æ¨™</th>
                                        <th class="text-right p-1.5">æ•¸é‡</th>
                                        <th class="text-center p-1.5">æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="transfer-list">
                                    <tr><td colspan="8" class="text-center text-slate-500 py-8">å°šæœªåŠ å…¥èª¿æ’¥å“é …</td></tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="border-t border-slate-700 pt-2 mt-2">
                            <button onclick="executeTransfer()" class="w-full py-2.5 bg-purple-600 hover:bg-purple-500 text-white rounded-lg font-bold" id="btn-execute-transfer" disabled>
                                <i class="fa-solid fa-check-double mr-2"></i>ç¢ºèªåŸ·è¡Œèª¿æ’¥
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ä½¿ç”¨è€…ç®¡ç†é é¢ -->
            <div id="view-user-management" class="view-panel h-full hidden flex flex-col p-4">
                <!-- é ‚éƒ¨æ¨™é¡Œ -->
                <div class="flex items-center justify-between bg-gradient-to-r from-blue-900 to-indigo-900 border border-blue-600 p-4 rounded-xl mb-4">
                    <div>
                        <h2 class="text-white font-bold text-2xl"><i class="fa-solid fa-users-gear mr-2 text-blue-400"></i>ä½¿ç”¨è€…ç®¡ç†</h2>
                        <p class="text-blue-200 text-sm mt-1">ç®¡ç†ç³»çµ±ä½¿ç”¨è€…å¸³è™Ÿèˆ‡æ¬Šé™è§’è‰² <span class="text-cyan-400">(Firebase é›²ç«¯åŒæ­¥)</span></p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="loadUserList()" class="bg-slate-700 hover:bg-slate-600 text-white px-3 py-2 rounded-lg">
                            <i class="fa-solid fa-rotate"></i>
                        </button>
                        <button onclick="exportUserList()" class="bg-slate-700 hover:bg-slate-600 text-white px-3 py-2 rounded-lg">
                            <i class="fa-solid fa-download mr-1"></i>åŒ¯å‡º
                        </button>
                        <button onclick="openAddUserModal()" class="bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded-lg font-bold">
                            <i class="fa-solid fa-user-plus mr-2"></i>æ–°å¢ä½¿ç”¨è€…
                        </button>
                    </div>
                </div>

                <!-- è§’è‰²æ¬Šé™èªªæ˜ + çµ±è¨ˆï¼ˆæ•´åˆï¼‰ -->
                <div class="bg-slate-800/50 border border-slate-700 rounded-xl p-4 mb-4">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-white font-bold"><i class="fa-solid fa-shield-halved mr-2 text-purple-400"></i>è§’è‰²æ¬Šé™ç¸½è¦½</h3>
                        <span id="user-count" class="text-slate-400 text-sm bg-slate-700/50 px-3 py-1 rounded-full">å…± 0 ä½ä½¿ç”¨è€…</span>
                    </div>
                    <div class="grid grid-cols-7 gap-2 text-sm">
                        <div class="bg-red-900/30 border border-red-600/50 rounded-lg p-3 hover:bg-red-900/50 transition cursor-pointer" onclick="document.getElementById('user-role-filter').value='admin';filterUserList();">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-red-400 font-bold text-xs"><i class="fa-solid fa-crown mr-1"></i>ç®¡ç†å“¡</span>
                                <span class="text-red-400 font-black text-lg" id="stat-admin">0</span>
                            </div>
                            <div class="text-slate-400 text-[10px] leading-relaxed">å…¨éƒ¨åŠŸèƒ½<br>ä½¿ç”¨è€…ç®¡ç†</div>
                        </div>
                        <div class="bg-emerald-900/30 border border-emerald-600/50 rounded-lg p-3 hover:bg-emerald-900/50 transition cursor-pointer" onclick="document.getElementById('user-role-filter').value='finance';filterUserList();">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-emerald-400 font-bold text-xs"><i class="fa-solid fa-calculator mr-1"></i>è²¡å‹™</span>
                                <span class="text-emerald-400 font-black text-lg" id="stat-finance">0</span>
                            </div>
                            <div class="text-slate-400 text-[10px] leading-relaxed">å…¥åº«æ ¸å‡†<br>å€‰ç§Ÿå ±è¡¨</div>
                        </div>
                        <div class="bg-purple-900/30 border border-purple-600/50 rounded-lg p-3 hover:bg-purple-900/50 transition cursor-pointer" onclick="document.getElementById('user-role-filter').value='supervisor';filterUserList();">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-purple-400 font-bold text-xs"><i class="fa-solid fa-user-tie mr-1"></i>ä¸»ç®¡</span>
                                <span class="text-purple-400 font-black text-lg" id="stat-supervisor">0</span>
                            </div>
                            <div class="text-slate-400 text-[10px] leading-relaxed">å…¨éƒ¨æ“ä½œ<br>å ±è¡¨æ ¸å‡†</div>
                        </div>
                        <div class="bg-cyan-900/30 border border-cyan-600/50 rounded-lg p-3 hover:bg-cyan-900/50 transition cursor-pointer" onclick="document.getElementById('user-role-filter').value='sales';filterUserList();">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-cyan-400 font-bold text-xs"><i class="fa-solid fa-briefcase mr-1"></i>æ¥­å‹™</span>
                                <span class="text-cyan-400 font-black text-lg" id="stat-sales">0</span>
                            </div>
                            <div class="text-slate-400 text-[10px] leading-relaxed">åº«å­˜æŸ¥è©¢<br>å¯„å€‰å ±è¡¨</div>
                        </div>
                        <div class="bg-blue-900/30 border border-blue-600/50 rounded-lg p-3 hover:bg-blue-900/50 transition cursor-pointer" onclick="document.getElementById('user-role-filter').value='operator';filterUserList();">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-blue-400 font-bold text-xs"><i class="fa-solid fa-user mr-1"></i>å€‰ç®¡</span>
                                <span class="text-blue-400 font-black text-lg" id="stat-operator">0</span>
                            </div>
                            <div class="text-slate-400 text-[10px] leading-relaxed">å…¥åº«å‡ºåº«<br>é–‹ç«‹å·¥å–®</div>
                        </div>
                        <div class="bg-orange-900/30 border border-orange-600/50 rounded-lg p-3 hover:bg-orange-900/50 transition cursor-pointer" onclick="document.getElementById('user-role-filter').value='forklift';filterUserList();">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-orange-400 font-bold text-xs"><i class="fa-solid fa-truck mr-1"></i>å †é«˜æ©Ÿ</span>
                                <span class="text-orange-400 font-black text-lg" id="stat-forklift">0</span>
                            </div>
                            <div class="text-slate-400 text-[10px] leading-relaxed">åŸ·è¡Œå·¥å–®<br>ç§»ä½ä¸Šæ¶</div>
                        </div>
                        <div class="bg-slate-700/30 border border-slate-600/50 rounded-lg p-3 hover:bg-slate-700/50 transition cursor-pointer" onclick="document.getElementById('user-role-filter').value='readonly';filterUserList();">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-slate-300 font-bold text-xs"><i class="fa-solid fa-eye mr-1"></i>åªè®€</span>
                                <span class="text-slate-300 font-black text-lg" id="stat-readonly">0</span>
                            </div>
                            <div class="text-slate-400 text-[10px] leading-relaxed">åƒ…èƒ½æŸ¥è©¢<br>ç„¡æ“ä½œæ¬Š</div>
                        </div>
                    </div>
                </div>

                <!-- æœå°‹ç¯©é¸ -->
                <div class="bg-slate-800/50 border border-slate-700 rounded-xl p-3 mb-4">
                    <div class="flex gap-3 items-center">
                        <input type="text" id="user-search" class="scan-input flex-1" placeholder="ğŸ” æœå°‹ Email æˆ–å§“å..." oninput="filterUserList()">
                        <select id="user-role-filter" class="scan-input w-40" onchange="filterUserList()">
                            <option value="">å…¨éƒ¨è§’è‰²</option>
                            <option value="admin">ç®¡ç†å“¡</option>
                            <option value="finance">è²¡å‹™äººå“¡</option>
                            <option value="supervisor">å€‰ç®¡ä¸»ç®¡</option>
                            <option value="sales">æ¥­å‹™äººå“¡</option>
                            <option value="operator">å€‰ç®¡äººå“¡</option>
                            <option value="forklift">å †é«˜æ©Ÿæ‰‹</option>
                            <option value="readonly">åªè®€</option>
                        </select>
                        <select id="user-status-filter" class="scan-input w-32" onchange="filterUserList()">
                            <option value="">å…¨éƒ¨ç‹€æ…‹</option>
                            <option value="active">å•Ÿç”¨</option>
                            <option value="inactive">åœç”¨</option>
                        </select>
                        <button onclick="document.getElementById('user-role-filter').value='';document.getElementById('user-status-filter').value='';document.getElementById('user-search').value='';filterUserList();" class="bg-slate-700 hover:bg-slate-600 text-slate-300 px-3 py-2 rounded-lg text-sm" title="æ¸…é™¤ç¯©é¸">
                            <i class="fa-solid fa-filter-circle-xmark"></i>
                        </button>
                    </div>
                </div>

                <!-- ä½¿ç”¨è€…æ¸…å–® -->
                <div class="flex-1 bg-slate-800/50 border border-slate-700 rounded-xl overflow-hidden">
                    <div class="overflow-auto h-full">
                        <table class="w-full dense-table">
                            <thead>
                                <tr class="bg-slate-900">
                                    <th class="p-3 text-left">Email</th>
                                    <th class="p-3 text-left">å§“å</th>
                                    <th class="p-3 text-left">è§’è‰²</th>
                                    <th class="p-3 text-left">éƒ¨é–€</th>
                                    <th class="p-3 text-center">ç‹€æ…‹</th>
                                    <th class="p-3 text-left">æœ€å¾Œç™»å…¥</th>
                                    <th class="p-3 text-left">å»ºç«‹æ™‚é–“</th>
                                    <th class="p-3 text-center">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="user-list-body">
                                <tr><td colspan="8" class="text-center text-slate-500 py-8"><i class="fa-solid fa-spinner fa-spin mr-2"></i>è¼‰å…¥ä¸­...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- æ–°å¢/ç·¨è¼¯ä½¿ç”¨è€… Modal -->
            <div id="modal-user-edit" class="fixed inset-0 z-50 bg-black/80 hidden flex items-center justify-center backdrop-blur-sm">
                <div class="bg-slate-900 border border-slate-700 rounded-2xl w-[600px] shadow-2xl max-h-[90vh] overflow-hidden flex flex-col">
                    <div class="bg-gradient-to-r from-blue-900 to-indigo-900 p-4 rounded-t-2xl border-b border-slate-700">
                        <h3 class="text-white font-bold text-lg" id="modal-user-title"><i class="fa-solid fa-user-plus mr-2"></i>æ–°å¢ä½¿ç”¨è€…</h3>
                    </div>
                    <div class="p-6 space-y-4 overflow-y-auto flex-1">
                        <input type="hidden" id="edit-user-id">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-slate-400 text-xs mb-1 block">Email <span class="text-red-400">*</span></label>
                                <input type="email" id="edit-user-email" class="scan-input w-full" placeholder="user@company.com">
                            </div>
                            <div>
                                <label class="text-slate-400 text-xs mb-1 block">å§“å <span class="text-red-400">*</span></label>
                                <input type="text" id="edit-user-name" class="scan-input w-full" placeholder="ç‹å°æ˜">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-slate-400 text-xs mb-1 block">è§’è‰²ç¯„æœ¬ <span class="text-red-400">*</span></label>
                                <select id="edit-user-role" class="scan-input w-full" onchange="applyRoleTemplate()">
                                    <option value="admin">ç®¡ç†å“¡ï¼ˆå…¨éƒ¨æ¬Šé™ï¼‰</option>
                                    <option value="finance">è²¡å‹™äººå“¡</option>
                                    <option value="supervisor">å€‰ç®¡ä¸»ç®¡</option>
                                    <option value="sales">æ¥­å‹™äººå“¡</option>
                                    <option value="operator" selected>å€‰ç®¡äººå“¡</option>
                                    <option value="forklift">å †é«˜æ©Ÿæ‰‹</option>
                                    <option value="readonly">åªè®€</option>
                                    <option value="custom">ğŸ”§ è‡ªè¨‚æ¬Šé™</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-slate-400 text-xs mb-1 block">éƒ¨é–€</label>
                                <input type="text" id="edit-user-dept" class="scan-input w-full" placeholder="å€‰å„²éƒ¨">
                            </div>
                        </div>

                        <!-- è‡ªè¨‚æ¬Šé™å€å¡Š -->
                        <div id="custom-permissions-section" class="bg-slate-800/50 border border-slate-700 rounded-xl p-4">
                            <div class="flex items-center justify-between mb-3">
                                <label class="text-slate-300 text-sm font-bold"><i class="fa-solid fa-key mr-2 text-amber-400"></i>åŠŸèƒ½æ¬Šé™</label>
                                <div class="flex gap-2">
                                    <button type="button" onclick="selectAllPermissions()" class="text-xs bg-slate-700 hover:bg-slate-600 text-slate-300 px-2 py-1 rounded">å…¨é¸</button>
                                    <button type="button" onclick="clearAllPermissions()" class="text-xs bg-slate-700 hover:bg-slate-600 text-slate-300 px-2 py-1 rounded">æ¸…é™¤</button>
                                </div>
                            </div>
                            <div class="grid grid-cols-3 gap-2 text-sm">
                                <!-- å…¥åº«ç®¡ç† -->
                                <div class="bg-emerald-900/20 border border-emerald-700/30 rounded-lg p-2">
                                    <div class="text-emerald-400 text-xs font-bold mb-2"><i class="fa-solid fa-arrow-down mr-1"></i>å…¥åº«ç®¡ç†</div>
                                    <label class="flex items-center gap-2 text-slate-300 text-xs cursor-pointer hover:text-white">
                                        <input type="checkbox" id="perm-inbound" class="perm-checkbox w-3 h-3"> å…¥åº«ä½œæ¥­
                                    </label>
                                    <label class="flex items-center gap-2 text-slate-300 text-xs cursor-pointer hover:text-white mt-1">
                                        <input type="checkbox" id="perm-approve" class="perm-checkbox w-3 h-3"> å…¥åº«æ ¸å‡†
                                    </label>
                                </div>
                                <!-- åº«å­˜ç•°å‹•ä½œæ¥­ -->
                                <div class="bg-blue-900/20 border border-blue-700/30 rounded-lg p-2">
                                    <div class="text-blue-400 text-xs font-bold mb-2"><i class="fa-solid fa-warehouse mr-1"></i>åº«å­˜ç•°å‹•ä½œæ¥­</div>
                                    <label class="flex items-center gap-2 text-slate-300 text-xs cursor-pointer hover:text-white">
                                        <input type="checkbox" id="perm-inventory" class="perm-checkbox w-3 h-3"> åº«å­˜æŸ¥è©¢
                                    </label>
                                    <label class="flex items-center gap-2 text-slate-300 text-xs cursor-pointer hover:text-white mt-1">
                                        <input type="checkbox" id="perm-move" class="perm-checkbox w-3 h-3"> åº«å­˜èª¿åº¦
                                    </label>
                                    <label class="flex items-center gap-2 text-slate-300 text-xs cursor-pointer hover:text-white mt-1">
                                        <input type="checkbox" id="perm-merge" class="perm-checkbox w-3 h-3"> æ¿è™Ÿç•°å‹•
                                    </label>
                                    <label class="flex items-center gap-2 text-slate-300 text-xs cursor-pointer hover:text-white mt-1">
                                        <input type="checkbox" id="perm-stocktake" class="perm-checkbox w-3 h-3"> åº«å­˜ç›¤é»
                                    </label>
                                </div>
                                <!-- å‡ºåº«ç®¡ç† -->
                                <div class="bg-red-900/20 border border-red-700/30 rounded-lg p-2">
                                    <div class="text-red-400 text-xs font-bold mb-2"><i class="fa-solid fa-arrow-up mr-1"></i>å‡ºåº«ç®¡ç†</div>
                                    <label class="flex items-center gap-2 text-slate-300 text-xs cursor-pointer hover:text-white">
                                        <input type="checkbox" id="perm-outbound" class="perm-checkbox w-3 h-3"> æ³¢æ¬¡æ€è²¨
                                    </label>
                                    <label class="flex items-center gap-2 text-slate-300 text-xs cursor-pointer hover:text-white mt-1">
                                        <input type="checkbox" id="perm-dispatch" class="perm-checkbox w-3 h-3"> åŸ·è¡Œèª¿åº¦
                                    </label>
                                </div>
                                <!-- å€‰ç§Ÿç®¡ç† -->
                                <div class="bg-amber-900/20 border border-amber-700/30 rounded-lg p-2">
                                    <div class="text-amber-400 text-xs font-bold mb-2"><i class="fa-solid fa-dollar-sign mr-1"></i>å€‰ç§Ÿç®¡ç†</div>
                                    <label class="flex items-center gap-2 text-slate-300 text-xs cursor-pointer hover:text-white">
                                        <input type="checkbox" id="perm-consignment" class="perm-checkbox w-3 h-3"> å¯„å€‰ç®¡ç†
                                    </label>
                                    <label class="flex items-center gap-2 text-slate-300 text-xs cursor-pointer hover:text-white mt-1">
                                        <input type="checkbox" id="perm-rental" class="perm-checkbox w-3 h-3"> å€‰ç§Ÿå ±è¡¨
                                    </label>
                                </div>
                                <!-- å ±è¡¨åˆ†æ -->
                                <div class="bg-purple-900/20 border border-purple-700/30 rounded-lg p-2">
                                    <div class="text-purple-400 text-xs font-bold mb-2"><i class="fa-solid fa-chart-line mr-1"></i>å ±è¡¨åˆ†æ</div>
                                    <label class="flex items-center gap-2 text-slate-300 text-xs cursor-pointer hover:text-white">
                                        <input type="checkbox" id="perm-report" class="perm-checkbox w-3 h-3"> å ±è¡¨åŒ¯å‡º
                                    </label>
                                    <label class="flex items-center gap-2 text-slate-300 text-xs cursor-pointer hover:text-white mt-1">
                                        <input type="checkbox" id="perm-analysis" class="perm-checkbox w-3 h-3"> å‡ºè²¨åˆ†æ
                                    </label>
                                </div>
                                <!-- ç³»çµ±ç®¡ç† -->
                                <div class="bg-slate-700/30 border border-slate-600/30 rounded-lg p-2">
                                    <div class="text-slate-300 text-xs font-bold mb-2"><i class="fa-solid fa-gear mr-1"></i>ç³»çµ±ç®¡ç†</div>
                                    <label class="flex items-center gap-2 text-slate-300 text-xs cursor-pointer hover:text-white">
                                        <input type="checkbox" id="perm-users" class="perm-checkbox w-3 h-3"> ä½¿ç”¨è€…ç®¡ç†
                                    </label>
                                    <label class="flex items-center gap-2 text-slate-300 text-xs cursor-pointer hover:text-white mt-1">
                                        <input type="checkbox" id="perm-settings" class="perm-checkbox w-3 h-3"> ç³»çµ±è¨­å®š
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div id="password-fields">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-slate-400 text-xs mb-1 block">å¯†ç¢¼ <span class="text-red-400">*</span></label>
                                    <input type="password" id="edit-user-password" class="scan-input w-full" placeholder="è‡³å°‘6ä½">
                                </div>
                                <div>
                                    <label class="text-slate-400 text-xs mb-1 block">ç¢ºèªå¯†ç¢¼ <span class="text-red-400">*</span></label>
                                    <input type="password" id="edit-user-password2" class="scan-input w-full" placeholder="å†æ¬¡è¼¸å…¥">
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="edit-user-active" checked class="w-4 h-4">
                            <label for="edit-user-active" class="text-slate-300 text-sm">å¸³è™Ÿå•Ÿç”¨</label>
                        </div>
                    </div>
                    <div class="p-4 border-t border-slate-700 flex gap-3">
                        <button onclick="saveUser()" class="flex-1 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-bold">
                            <i class="fa-solid fa-save mr-2"></i>å„²å­˜
                        </button>
                        <button onclick="closeUserModal()" class="flex-1 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>

            <!-- åŸ·è¡Œèª¿åº¦å·¥å–® Modal -->
            <div id="modal-dispatch-execute" class="fixed inset-0 z-50 bg-black/80 hidden flex items-center justify-center backdrop-blur-sm">
                <div class="bg-slate-900 border border-slate-700 rounded-2xl w-[900px] max-h-[90vh] shadow-2xl flex flex-col">
                    <!-- æ¨™é¡Œ -->
                    <div class="bg-gradient-to-r from-orange-900 to-red-900 p-4 rounded-t-2xl border-b border-slate-700 flex items-center justify-between">
                        <div>
                            <h3 class="text-white font-bold text-lg"><i class="fa-solid fa-play-circle mr-2 text-orange-400"></i>åŸ·è¡Œèª¿åº¦å·¥å–®</h3>
                            <p class="text-orange-200 text-xs mt-1" id="dispatch-exec-subtitle">æƒææ¿è™Ÿç¢ºèªåŸ·è¡Œ</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <label class="flex items-center gap-2 text-sm">
                                <input type="checkbox" id="dispatch-batch-mode" class="w-4 h-4" onchange="toggleDispatchBatchMode()">
                                <span class="text-orange-200">æ‰¹æ¬¡å‹¾é¸æ¨¡å¼</span>
                            </label>
                        </div>
                    </div>

                    <!-- å·¥å–®é¸æ“‡ -->
                    <div class="p-4 border-b border-slate-700 bg-slate-800/50">
                        <div class="flex items-center gap-4">
                            <label class="text-slate-400 text-sm">é¸æ“‡å·¥å–®ï¼š</label>
                            <select id="dispatch-exec-order-select" class="scan-input flex-1" onchange="loadDispatchExecOrder()">
                                <option value="">-- è«‹é¸æ“‡ --</option>
                            </select>
                            <div class="text-sm">
                                <span class="text-slate-400">é€²åº¦ï¼š</span>
                                <span class="text-emerald-400 font-bold" id="dispatch-exec-progress">0/0</span>
                            </div>
                        </div>
                    </div>

                    <!-- æƒæå€ -->
                    <div id="dispatch-scan-area" class="p-4 border-b border-slate-700 bg-slate-800/30">
                        <div class="flex items-center gap-3">
                            <i class="fa-solid fa-barcode text-blue-400 text-xl"></i>
                            <input type="text" id="dispatch-scan-input" class="scan-input flex-1 text-lg" placeholder="æƒææ¿è™Ÿç¢ºèª..." onkeypress="if(event.key==='Enter') confirmDispatchScan()">
                            <button onclick="confirmDispatchScan()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg font-bold">
                                <i class="fa-solid fa-check mr-1"></i>ç¢ºèª
                            </button>
                        </div>
                        <div id="dispatch-scan-result" class="mt-2 text-sm hidden"></div>
                    </div>

                    <!-- æ“ä½œæ¸…å–® -->
                    <div class="flex-1 overflow-auto p-4">
                        <table class="w-full text-sm">
                            <thead class="bg-slate-800 sticky top-0">
                                <tr>
                                    <th class="text-left p-2 w-10" id="dispatch-batch-header" style="display:none"><input type="checkbox" id="dispatch-check-all" onchange="toggleAllDispatchChecks()"></th>
                                    <th class="text-left p-2 w-16">ç‹€æ…‹</th>
                                    <th class="text-left p-2">é¡å‹</th>
                                    <th class="text-left p-2">ä¾†æºå„²ä½</th>
                                    <th class="text-left p-2">æ¿è™Ÿ</th>
                                    <th class="text-right p-2">æ•¸é‡</th>
                                    <th class="text-center p-2 w-12">â†’</th>
                                    <th class="text-left p-2">ç›®æ¨™å„²ä½</th>
                                    <th class="text-left p-2">èªªæ˜</th>
                                </tr>
                            </thead>
                            <tbody id="dispatch-exec-list">
                                <tr><td colspan="9" class="text-center text-slate-500 py-8">è«‹é¸æ“‡å·¥å–®</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- åº•éƒ¨æŒ‰éˆ• -->
                    <div class="p-4 border-t border-slate-700 flex gap-3">
                        <button onclick="executeDispatchBatch()" id="btn-dispatch-batch-exec" class="flex-1 py-3 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg font-bold hidden">
                            <i class="fa-solid fa-check-double mr-2"></i>åŸ·è¡Œå‹¾é¸é …ç›®
                        </button>
                        <button onclick="completeDispatchOrder()" id="btn-dispatch-complete" class="flex-1 py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-bold">
                            <i class="fa-solid fa-flag-checkered mr-2"></i>å®Œæˆå·¥å–®
                        </button>
                        <button onclick="closeDispatchExecuteModal()" class="px-6 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-lg">é—œé–‰</button>
                    </div>
                </div>
            </div>

            <!-- å“é …ä¸»æª” -->
            <div id="view-product-master" class="view-panel h-full hidden flex flex-col p-4">
                <div class="bg-gradient-to-r from-cyan-900 to-cyan-800 border border-cyan-600 p-3 rounded-lg mb-3 flex justify-between items-center">
                    <h2 class="text-white font-bold text-lg"><i class="fa-solid fa-box mr-2 text-cyan-400"></i>å“é …ä¸»æª”</h2>
                    <div class="flex gap-2">
                        <button onclick="showProductMasterImport()" class="px-3 py-1.5 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg text-sm font-bold">
                            <i class="fa-solid fa-file-excel mr-1"></i>Excel åŒ¯å…¥
                        </button>
                        <button onclick="downloadProductMasterTemplate()" class="px-3 py-1.5 bg-blue-600 hover:bg-blue-500 text-white rounded-lg text-sm font-bold">
                            <i class="fa-solid fa-download mr-1"></i>ä¸‹è¼‰ç¯„æœ¬
                        </button>
                        <button onclick="exportProductMaster()" class="px-3 py-1.5 bg-slate-600 hover:bg-slate-500 text-white rounded-lg text-sm font-bold">
                            <i class="fa-solid fa-file-export mr-1"></i>åŒ¯å‡º
                        </button>
                        <button onclick="clearAllProductMaster()" class="px-3 py-1.5 bg-red-600 hover:bg-red-500 text-white rounded-lg text-sm font-bold">
                            <i class="fa-solid fa-trash mr-1"></i>æ¸…ç©ºå…¨éƒ¨
                        </button>
                    </div>
                </div>

                <div class="flex gap-3 flex-1 overflow-hidden">
                    <!-- å·¦å´ï¼šæ–°å¢/ç·¨è¼¯ï¼ˆæ–°å¢æ¬„ä½ï¼‰-->
                    <div class="w-80 glass-panel p-3 flex flex-col overflow-y-auto">
                        <h3 class="text-white font-bold mb-2 text-sm border-b border-slate-700 pb-2">
                            <i class="fa-solid fa-plus-circle mr-1 text-cyan-400"></i>æ–°å¢/ç·¨è¼¯å“é …
                        </h3>
                        <div class="space-y-2 text-sm">
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="text-xs text-slate-400">å“è™Ÿ</label>
                                    <input type="text" id="pm-code" class="scan-input py-1" placeholder="A001">
                                </div>
                                <div>
                                    <label class="text-xs text-slate-400">é¡åˆ¥</label>
                                    <select id="pm-category" class="scan-input py-1">
                                        <option value="æˆå“">æˆå“</option>
                                        <option value="åŸæ–™">åŸæ–™</option>
                                        <option value="åŠæˆå“">åŠæˆå“</option>
                                        <option value="åŒ…æ">åŒ…æ</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="text-xs text-slate-400">å“å *</label>
                                <input type="text" id="pm-name" class="scan-input py-1" placeholder="ä¾‹ï¼šé®­é­šåˆ‡ç‰‡">
                            </div>
                            <div>
                                <label class="text-xs text-slate-400">è¦æ ¼</label>
                                <input type="text" id="pm-spec" class="scan-input py-1" placeholder="300/400">
                            </div>
                            
                            <!-- æ–°å¢ï¼šè¨ˆé‡æ–¹å¼ -->
                            <div class="bg-slate-800/50 rounded p-2 border border-slate-700">
                                <label class="text-xs text-cyan-400 font-bold mb-1 block">è¨ˆé‡æ–¹å¼</label>
                                <div class="flex gap-2">
                                    <label class="flex-1 cursor-pointer">
                                        <input type="radio" name="pm-weight-type" value="fixed" class="hidden peer" checked>
                                        <div class="text-center py-1.5 rounded text-xs font-bold peer-checked:bg-blue-600 peer-checked:text-white bg-slate-700 text-slate-400 transition-all">
                                            ğŸ“¦ å®šé‡å“
                                        </div>
                                    </label>
                                    <label class="flex-1 cursor-pointer">
                                        <input type="radio" name="pm-weight-type" value="variable" class="hidden peer">
                                        <div class="text-center py-1.5 rounded text-xs font-bold peer-checked:bg-amber-600 peer-checked:text-white bg-slate-700 text-slate-400 transition-all">
                                            âš–ï¸ ä¸å®šé‡
                                        </div>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- æ–°å¢ï¼šå…¥åº«é¡å‹ -->
                            <div class="bg-slate-800/50 rounded p-2 border border-slate-700">
                                <label class="text-xs text-cyan-400 font-bold mb-1 block">å…¥åº«é¡å‹</label>
                                <div class="grid grid-cols-4 gap-1">
                                    <label class="cursor-pointer">
                                        <input type="radio" name="pm-inbound-type" value="Raw" class="hidden peer" checked>
                                        <div class="text-center py-1 rounded text-[10px] font-bold peer-checked:bg-emerald-600 peer-checked:text-white bg-slate-700 text-slate-400">æ¡è³¼</div>
                                    </label>
                                    <label class="cursor-pointer">
                                        <input type="radio" name="pm-inbound-type" value="FG" class="hidden peer">
                                        <div class="text-center py-1 rounded text-[10px] font-bold peer-checked:bg-blue-600 peer-checked:text-white bg-slate-700 text-slate-400">æˆå“</div>
                                    </label>
                                    <label class="cursor-pointer">
                                        <input type="radio" name="pm-inbound-type" value="WIP" class="hidden peer">
                                        <div class="text-center py-1 rounded text-[10px] font-bold peer-checked:bg-yellow-600 peer-checked:text-white bg-slate-700 text-slate-400">åŠæˆå“</div>
                                    </label>
                                    <label class="cursor-pointer">
                                        <input type="radio" name="pm-inbound-type" value="Return" class="hidden peer">
                                        <div class="text-center py-1 rounded text-[10px] font-bold peer-checked:bg-orange-600 peer-checked:text-white bg-slate-700 text-slate-400">é€€åº«</div>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-3 gap-2">
                                <div>
                                    <label class="text-xs text-slate-400">æ¿å®¹é‡(ä»¶)</label>
                                    <input type="number" id="pm-pallet-capacity" class="scan-input py-1" placeholder="40" min="1">
                                </div>
                                <div>
                                    <label class="text-xs text-cyan-400 font-bold">ç®±å®¹(kg)</label>
                                    <input type="number" id="pm-unit-weight" class="scan-input py-1 border-cyan-500/50" placeholder="10" step="0.1" min="0">
                                </div>
                                <div>
                                    <label class="text-xs text-slate-400">é¤˜æ¿%</label>
                                    <input type="number" id="pm-partial-threshold" class="scan-input py-1" value="50" min="10" max="90">
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="text-xs text-slate-400">ä¿å­˜æœŸ(æœˆ)</label>
                                    <input type="number" id="pm-shelf-life" class="scan-input py-1" value="24" min="1" max="60">
                                </div>
                                <div>
                                    <label class="text-xs text-slate-400">å‚™è¨»</label>
                                    <input type="text" id="pm-note" class="scan-input py-1" placeholder="èªªæ˜">
                                </div>
                            </div>
                            <input type="hidden" id="pm-edit-id" value="">
                            <div class="flex gap-2">
                                <button onclick="saveProductMaster()" class="flex-1 py-1.5 bg-cyan-600 hover:bg-cyan-500 text-white rounded font-bold text-sm">
                                    <i class="fa-solid fa-save mr-1"></i>å„²å­˜
                                </button>
                                <button onclick="clearProductMasterForm()" class="px-3 py-1.5 bg-slate-700 hover:bg-slate-600 text-white rounded text-sm">
                                    æ¸…é™¤
                                </button>
                            </div>
                        </div>

                        <div class="mt-3 pt-2 border-t border-slate-700">
                            <div class="text-xs text-slate-400 mb-1">å¿«é€Ÿè¨­å®šï¼š</div>
                            <div class="flex flex-wrap gap-1 mb-1">
                                <span class="text-[10px] text-slate-500">æ¿å®¹é‡:</span>
                                <button onclick="document.getElementById('pm-pallet-capacity').value=30" class="px-1.5 py-0.5 bg-slate-700 hover:bg-slate-600 text-white rounded text-[10px]">30</button>
                                <button onclick="document.getElementById('pm-pallet-capacity').value=40" class="px-1.5 py-0.5 bg-yellow-600 hover:bg-yellow-500 text-white rounded text-[10px] font-bold">40</button>
                                <button onclick="document.getElementById('pm-pallet-capacity').value=50" class="px-1.5 py-0.5 bg-slate-700 hover:bg-slate-600 text-white rounded text-[10px]">50</button>
                                <button onclick="document.getElementById('pm-pallet-capacity').value=60" class="px-1.5 py-0.5 bg-slate-700 hover:bg-slate-600 text-white rounded text-[10px]">60</button>
                            </div>
                            <div class="flex flex-wrap gap-1 mb-1">
                                <span class="text-[10px] text-slate-500">ç®±å®¹kg:</span>
                                <button onclick="document.getElementById('pm-unit-weight').value=5" class="px-1.5 py-0.5 bg-slate-700 hover:bg-slate-600 text-white rounded text-[10px]">5</button>
                                <button onclick="document.getElementById('pm-unit-weight').value=10" class="px-1.5 py-0.5 bg-cyan-600 hover:bg-cyan-500 text-white rounded text-[10px] font-bold">10</button>
                                <button onclick="document.getElementById('pm-unit-weight').value=15" class="px-1.5 py-0.5 bg-slate-700 hover:bg-slate-600 text-white rounded text-[10px]">15</button>
                                <button onclick="document.getElementById('pm-unit-weight').value=20" class="px-1.5 py-0.5 bg-slate-700 hover:bg-slate-600 text-white rounded text-[10px]">20</button>
                            </div>
                            <div class="flex flex-wrap gap-1">
                                <span class="text-[10px] text-slate-500">ä¿å­˜æœŸ:</span>
                                <button onclick="document.getElementById('pm-shelf-life').value=12" class="px-1.5 py-0.5 bg-slate-700 hover:bg-slate-600 text-white rounded text-[10px]">12æœˆ</button>
                                <button onclick="document.getElementById('pm-shelf-life').value=18" class="px-1.5 py-0.5 bg-slate-700 hover:bg-slate-600 text-white rounded text-[10px]">18æœˆ</button>
                                <button onclick="document.getElementById('pm-shelf-life').value=24" class="px-1.5 py-0.5 bg-slate-700 hover:bg-slate-600 text-white rounded text-[10px]">24æœˆ</button>
                                <button onclick="document.getElementById('pm-shelf-life').value=36" class="px-1.5 py-0.5 bg-slate-700 hover:bg-slate-600 text-white rounded text-[10px]">36æœˆ</button>
                            </div>
                        </div>
                    </div>

                    <!-- å³å´ï¼šå“é …æ¸…å–®ï¼ˆæ›´æ–°è¡¨é ­ï¼‰-->
                    <div class="flex-1 glass-panel flex flex-col overflow-hidden">
                        <div class="p-2 border-b border-slate-700 flex justify-between items-center">
                            <h3 class="text-white font-bold text-sm">
                                <i class="fa-solid fa-list mr-1 text-cyan-400"></i>å“é …æ¸…å–®
                            </h3>
                            <div class="flex gap-2 items-center">
                                <input type="text" id="pm-search" class="scan-input w-40 py-1" placeholder="æœå°‹å“å..." oninput="filterProductMaster()">
                                <button onclick="autoImportFromInventory()" class="bg-emerald-600 hover:bg-emerald-500 text-white px-2 py-1 rounded text-xs font-bold">
                                    <i class="fa-solid fa-magic mr-1"></i>è‡ªå‹•åŒ¯å…¥
                                </button>
                            </div>
                        </div>
                        <div class="flex-1 overflow-auto">
                            <table class="w-full dense-table">
                                <thead>
                                    <tr>
                                        <th>å“è™Ÿ</th>
                                        <th>å“å</th>
                                        <th>è¦æ ¼</th>
                                        <th class="text-center">è¨ˆé‡</th>
                                        <th class="text-center">ç®±å®¹</th>
                                        <th class="text-center">æ¿å®¹</th>
                                        <th class="text-center">å…¥åº«é¡å‹</th>
                                        <th class="text-center">æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="product-master-list">
                                    <tr><td colspan="8" class="text-center text-slate-500 py-10">è¼‰å…¥ä¸­...</td></tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="p-2 border-t border-slate-700 flex justify-between items-center text-xs">
                            <span class="text-slate-400">å…± <span id="pm-total-count" class="text-white font-bold">0</span> ç­†</span>
                            <span class="text-slate-500">æ–°å¢æ¬„ä½ï¼šè¨ˆé‡æ–¹å¼ã€ç®±å®¹ã€å…¥åº«é¡å‹</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ¨™ç±¤åˆ—å°é é¢ -->
            <div id="view-label-print" class="view-panel h-full hidden flex flex-col p-4">
                <div class="bg-gradient-to-r from-purple-900 to-purple-800 border border-purple-600 p-3 rounded-lg mb-4">
                    <h2 class="text-white font-bold text-xl"><i class="fa-solid fa-print mr-2 text-purple-400"></i>æ¨™ç±¤åˆ—å°</h2>
                    <p class="text-purple-200 text-sm mt-1">åˆ—å°å„²ä½æ¢ç¢¼ã€é‡å°æ£§æ¿å–®</p>
                </div>

                <div class="grid grid-cols-2 gap-6 flex-1 min-h-0">
                    <!-- å·¦å´ï¼šå„²ä½æ¢ç¢¼åˆ—å° -->
                    <div class="glass-panel p-4 flex flex-col overflow-hidden">
                        <div class="flex items-center justify-between mb-3 pb-2 border-b border-slate-700">
                            <h3 class="text-white font-bold text-lg">
                                <i class="fa-solid fa-location-dot mr-2 text-blue-400"></i>å„²ä½æ¢ç¢¼åˆ—å°
                            </h3>
                            <button onclick="printLocationLabels()" class="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-bold text-sm">
                                <i class="fa-solid fa-print mr-1"></i>åˆ—å°å„²ä½æ¢ç¢¼
                            </button>
                        </div>

                        <div class="flex-1 overflow-y-auto space-y-3">
                            <!-- Step 1: å€‰åº«é¸æ“‡ -->
                            <div class="bg-slate-800/50 rounded-lg p-3">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="bg-blue-600 text-white text-xs px-2 py-0.5 rounded font-bold">1</span>
                                    <span class="text-sm text-slate-300 font-bold">é¸æ“‡å€‰åº«å€åŸŸ</span>
                                </div>
                                <div class="grid grid-cols-4 gap-2">
                                    <button onclick="selectLocZone('I-A')" class="loc-zone-btn px-2 py-1.5 bg-blue-900/50 border border-blue-700 rounded text-blue-400 font-bold text-xs hover:bg-blue-800/50 transition-colors" data-zone="I-A">I-A</button>
                                    <button onclick="selectLocZone('I-B')" class="loc-zone-btn px-2 py-1.5 bg-blue-900/50 border border-blue-700 rounded text-blue-400 font-bold text-xs hover:bg-blue-800/50 transition-colors" data-zone="I-B">I-B</button>
                                    <button onclick="selectLocZone('J-C')" class="loc-zone-btn px-2 py-1.5 bg-purple-900/50 border border-purple-700 rounded text-purple-400 font-bold text-xs hover:bg-purple-800/50 transition-colors" data-zone="J-C">J-C</button>
                                    <button onclick="selectLocZone('J-D')" class="loc-zone-btn px-2 py-1.5 bg-purple-900/50 border border-purple-700 rounded text-purple-400 font-bold text-xs hover:bg-purple-800/50 transition-colors" data-zone="J-D">J-D</button>
                                    <button onclick="selectLocZone('K-E')" class="loc-zone-btn px-2 py-1.5 bg-emerald-900/50 border border-emerald-700 rounded text-emerald-400 font-bold text-xs hover:bg-emerald-800/50 transition-colors" data-zone="K-E">K-E</button>
                                    <button onclick="selectLocZone('K-F')" class="loc-zone-btn px-2 py-1.5 bg-emerald-900/50 border border-emerald-700 rounded text-emerald-400 font-bold text-xs hover:bg-emerald-800/50 transition-colors" data-zone="K-F">K-F</button>
                                    <button onclick="selectLocZone('K-G')" class="loc-zone-btn px-2 py-1.5 bg-emerald-900/50 border border-emerald-700 rounded text-emerald-400 font-bold text-xs hover:bg-emerald-800/50 transition-colors" data-zone="K-G">K-G</button>
                                    <button onclick="selectLocZone('K-H')" class="loc-zone-btn px-2 py-1.5 bg-emerald-900/50 border border-emerald-700 rounded text-emerald-400 font-bold text-xs hover:bg-emerald-800/50 transition-colors" data-zone="K-H">K-H</button>
                                </div>
                            </div>

                            <!-- Step 2: æ’è™Ÿç¯„åœ + æ¨“å±¤ -->
                            <div class="bg-slate-800/50 rounded-lg p-3">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="bg-blue-600 text-white text-xs px-2 py-0.5 rounded font-bold">2</span>
                                    <span class="text-sm text-slate-300 font-bold">è¨­å®šç¯„åœ</span>
                                </div>
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="text-xs text-slate-500 mb-1 block">æ’è™Ÿç¯„åœ</label>
                                        <div class="flex items-center gap-1">
                                            <input type="number" id="loc-row-start" class="scan-input w-16 text-center py-1" value="1" min="1" max="22">
                                            <span class="text-slate-500">~</span>
                                            <input type="number" id="loc-row-end" class="scan-input w-16 text-center py-1" value="22" min="1" max="22">
                                        </div>
                                    </div>
                                    <div>
                                        <label class="text-xs text-slate-500 mb-1 block">æ¨“å±¤</label>
                                        <div class="flex gap-1">
                                            <label class="flex items-center gap-1 px-2 py-1 bg-slate-700 rounded cursor-pointer text-xs">
                                                <input type="checkbox" id="loc-floor-1f" checked class="w-3 h-3">
                                                <span class="text-white">1F</span>
                                            </label>
                                            <label class="flex items-center gap-1 px-2 py-1 bg-slate-700 rounded cursor-pointer text-xs">
                                                <input type="checkbox" id="loc-floor-2f" checked class="w-3 h-3">
                                                <span class="text-white">2F</span>
                                            </label>
                                            <label class="flex items-center gap-1 px-2 py-1 bg-slate-700 rounded cursor-pointer text-xs">
                                                <input type="checkbox" id="loc-floor-3f" checked class="w-3 h-3">
                                                <span class="text-white">3F</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- é è¦½ -->
                            <div class="bg-slate-900 rounded-lg p-3">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-xs text-slate-400"><i class="fa-solid fa-eye mr-1"></i>é è¦½</span>
                                    <span class="text-xs text-blue-400 font-bold" id="loc-print-count">0 å¼µ</span>
                                </div>
                                <div class="text-white text-sm" id="loc-print-preview">
                                    <span class="text-slate-500">è«‹é¸æ“‡å€‰åº«å€åŸŸ</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- å³å´ï¼šæ£§æ¿å–®é‡å° -->
                    <div class="glass-panel p-4 flex flex-col overflow-hidden">
                        <div class="flex items-center justify-between mb-3 pb-2 border-b border-slate-700">
                            <h3 class="text-white font-bold text-lg">
                                <i class="fa-solid fa-qrcode mr-2 text-emerald-400"></i>æ£§æ¿å–®é‡å°
                            </h3>
                            <button onclick="reprintPalletLabel()" id="btn-reprint-pallet" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg font-bold text-sm disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                <i class="fa-solid fa-print mr-1"></i>é‡å°æ£§æ¿å–®
                            </button>
                        </div>

                        <div class="flex-1 overflow-y-auto space-y-3">
                            <!-- æœå°‹ -->
                            <div class="bg-slate-800/50 rounded-lg p-3">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="bg-emerald-600 text-white text-xs px-2 py-0.5 rounded font-bold">1</span>
                                    <span class="text-sm text-slate-300 font-bold">è¼¸å…¥æ£§æ¿ç·¨è™Ÿ</span>
                                </div>
                                <div class="flex gap-2">
                                    <input type="text" id="reprint-pallet-id" class="scan-input flex-1" placeholder="P20241220001 æˆ–æƒæ QR Code" onkeyup="if(event.keyCode===13) searchPalletForReprint()">
                                    <button onclick="searchPalletForReprint()" class="px-3 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg">
                                        <i class="fa-solid fa-search"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- æœå°‹çµæœ / æ£§æ¿è³‡è¨Š -->
                            <div class="bg-slate-900 rounded-lg p-3 flex-1 min-h-[150px]" id="reprint-pallet-info">
                                <div class="text-slate-500 text-center py-6">
                                    <i class="fa-solid fa-qrcode text-3xl mb-2 opacity-30"></i>
                                    <div class="text-sm">è¼¸å…¥æ£§æ¿ç·¨è™Ÿé€²è¡Œæœå°‹</div>
                                </div>
                            </div>

                            <!-- æœ€è¿‘é‡å°è¨˜éŒ„ -->
                            <div class="bg-slate-800/50 rounded-lg p-3">
                                <div class="text-xs text-slate-400 mb-2"><i class="fa-solid fa-history mr-1"></i>æœ€è¿‘é‡å°è¨˜éŒ„</div>
                                <div id="reprint-history" class="space-y-1 max-h-24 overflow-y-auto text-xs">
                                    <div class="text-slate-600">å°šç„¡é‡å°è¨˜éŒ„</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- è³‡æ–™åŒ¯å…¥é é¢ -->
            <div id="view-data-import" class="view-panel h-full hidden flex flex-col p-4">
                <div class="bg-gradient-to-r from-amber-900 to-amber-800 border border-amber-600 p-3 rounded-lg mb-3">
                    <h2 class="text-white font-bold text-lg"><i class="fa-solid fa-file-import mr-2 text-amber-400"></i>è³‡æ–™åŒ¯å…¥</h2>
                    <p class="text-amber-200 text-sm mt-1">å¾ Excel æ‰¹æ¬¡åŒ¯å…¥åº«å­˜è³‡æ–™</p>
                </div>

                <div class="flex gap-4 flex-1 overflow-hidden">
                    <!-- å·¦å´ï¼šä¸Šå‚³å€åŸŸ -->
                    <div class="w-80 glass-panel p-4 flex flex-col">
                        <h3 class="text-white font-bold mb-3 text-sm border-b border-slate-700 pb-2">
                            <i class="fa-solid fa-upload mr-1 text-amber-400"></i>æ­¥é©Ÿä¸€ï¼šä¸Šå‚³ Excel
                        </h3>

                        <!-- ä¸Šå‚³å€ -->
                        <div id="import-dropzone" class="border-2 border-dashed border-slate-600 rounded-lg p-6 text-center mb-4 hover:border-amber-500 transition-colors cursor-pointer"
                             onclick="document.getElementById('import-excel-file').click()"
                             ondrop="handleImportDrop(event)" ondragover="handleImportDragOver(event)" ondragleave="handleImportDragLeave(event)">
                            <i class="fa-solid fa-cloud-upload-alt text-4xl text-slate-500 mb-3"></i>
                            <p class="text-slate-400 text-sm">æ‹–æ›³ Excel æª”æ¡ˆåˆ°é€™è£¡</p>
                            <p class="text-slate-500 text-xs mt-1">æˆ–é»æ“Šé¸æ“‡æª”æ¡ˆ</p>
                            <input type="file" id="import-excel-file" accept=".xlsx,.xls" class="hidden" onchange="handleImportFileSelect(event)">
                        </div>

                        <!-- ä¸‹è¼‰ç¯„æœ¬ -->
                        <div class="bg-slate-800/50 rounded-lg p-3 mb-4">
                            <div class="text-xs text-slate-400 mb-2">ğŸ“¥ ä¸‹è¼‰ç¯„æœ¬ï¼š</div>
                            <button onclick="downloadImportTemplate()" class="w-full py-2 bg-emerald-600 hover:bg-emerald-500 text-white rounded text-sm font-bold">
                                <i class="fa-solid fa-download mr-1"></i>åº«å­˜åŒ¯å…¥ç¯„æœ¬.xlsx
                            </button>
                        </div>

                        <!-- åŒ¯å…¥é¸é … -->
                        <div class="bg-slate-800/50 rounded-lg p-3 mb-4">
                            <div class="text-xs text-slate-400 mb-2">âš™ï¸ åŒ¯å…¥é¸é …ï¼š</div>
                            <label class="flex items-center gap-2 text-sm text-white mb-2 cursor-pointer">
                                <input type="checkbox" id="import-opt-create-location" checked class="rounded">
                                <span>è‡ªå‹•å»ºç«‹æ–°å„²ä½</span>
                            </label>
                            <label class="flex items-center gap-2 text-sm text-white mb-2 cursor-pointer">
                                <input type="checkbox" id="import-opt-create-product" checked class="rounded">
                                <span>è‡ªå‹•å»ºç«‹æ–°å“é …</span>
                            </label>
                            <label class="flex items-center gap-2 text-sm text-white cursor-pointer">
                                <input type="checkbox" id="import-opt-skip-duplicate" checked class="rounded">
                                <span>è·³éé‡è¤‡è³‡æ–™</span>
                            </label>
                        </div>

                        <!-- è™›æ“¬å„²ä½èªªæ˜ -->
                        <div class="bg-slate-800/50 rounded-lg p-3 text-xs">
                            <div class="text-slate-400 mb-2">ğŸ“ è™›æ“¬å„²ä½ï¼š</div>
                            <div class="grid grid-cols-2 gap-1 text-slate-500">
                                <span>A00~D00 è²¨æ¶å‰ç«¯</span>
                                <span>A99~D99 è²¨æ¶æœ«ç«¯</span>
                                <span>TEMP-IN é€²è²¨æš«å­˜</span>
                                <span>TEMP-OUT å‡ºè²¨æš«å­˜</span>
                            </div>
                        </div>
                    </div>

                    <!-- å³å´ï¼šé è¦½èˆ‡çµæœ -->
                    <div class="flex-1 glass-panel flex flex-col overflow-hidden">
                        <div class="p-3 border-b border-slate-700 flex justify-between items-center">
                            <h3 class="text-white font-bold text-sm">
                                <i class="fa-solid fa-table mr-1 text-amber-400"></i>æ­¥é©ŸäºŒï¼šé è¦½è³‡æ–™
                            </h3>
                            <div class="flex gap-2 items-center">
                                <span id="import-stats" class="text-xs text-slate-400">å°šæœªä¸Šå‚³æª”æ¡ˆ</span>
                                <button id="btn-execute-import" onclick="executeImport()"
                                        class="bg-amber-600 hover:bg-amber-500 text-white px-4 py-1.5 rounded text-sm font-bold disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                    <i class="fa-solid fa-database mr-1"></i>åŸ·è¡ŒåŒ¯å…¥
                                </button>
                            </div>
                        </div>

                        <!-- é è¦½è¡¨æ ¼ -->
                        <div class="flex-1 overflow-auto">
                            <table class="w-full dense-table" id="import-preview-table">
                                <thead>
                                    <tr>
                                        <th class="w-8">#</th>
                                        <th class="text-center w-12">ç‹€æ…‹</th>
                                        <th>å„²ä½</th>
                                        <th>å…¬å¸</th>
                                        <th>å“è™Ÿ</th>
                                        <th>å“å</th>
                                        <th>è¦æ ¼</th>
                                        <th class="text-right">æ•¸é‡</th>
                                        <th>å–®ä½</th>
                                        <th>æ‰¹è™Ÿ</th>
                                        <th>æ•ˆæœŸ</th>
                                    </tr>
                                </thead>
                                <tbody id="import-preview-body">
                                    <tr><td colspan="11" class="text-center text-slate-500 py-10">
                                        <i class="fa-solid fa-file-excel text-4xl text-slate-600 mb-3 block"></i>
                                        <p>è«‹ä¸Šå‚³ Excel æª”æ¡ˆ</p>
                                    </td></tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- åº•éƒ¨çµ±è¨ˆ -->
                        <div class="p-3 border-t border-slate-700 flex justify-between items-center text-xs">
                            <div class="flex gap-4">
                                <span class="text-slate-400">ç¸½ç­†æ•¸ï¼š<span id="import-total" class="text-white font-bold">0</span></span>
                                <span class="text-emerald-400">âœ“ æœ‰æ•ˆï¼š<span id="import-valid" class="font-bold">0</span></span>
                                <span class="text-red-400">âœ— éŒ¯èª¤ï¼š<span id="import-invalid" class="font-bold">0</span></span>
                                <span class="text-yellow-400">âš  é‡è¤‡ï¼š<span id="import-duplicate" class="font-bold">0</span></span>
                            </div>
                            <span class="text-slate-500">åŒ¯å…¥å¾Œè³‡æ–™å°‡æ–°å¢åˆ° Firebase</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å¯„å€‰ç®¡ç†é é¢ -->
            <div id="view-consignment" class="view-panel h-full hidden flex flex-col p-4">
                <div class="bg-gradient-to-r from-amber-900 to-orange-900 border border-amber-600 p-3 rounded-lg mb-3">
                    <div class="flex justify-between items-center">
                        <!-- å·¦å´ï¼šæ¨™é¡Œ -->
                        <div>
                            <h2 class="text-white font-bold text-lg"><i class="fa-solid fa-box-archive mr-2 text-amber-400"></i>å¯„å€‰ç®¡ç†</h2>
                        </div>
                        <!-- å³å´ï¼šçµ±è¨ˆè³‡è¨Š -->
                        <div class="flex items-center gap-2 text-sm">
                            <div class="flex items-center gap-1.5 px-3 py-1.5 bg-slate-900/80 rounded-lg border border-emerald-500/50">
                                <span class="text-emerald-300 text-xs">å…è²»æœŸ</span>
                                <span class="text-emerald-400 font-bold text-lg" id="consign-free-count">0</span>
                            </div>
                            <div class="flex items-center gap-1.5 px-3 py-1.5 bg-slate-900/80 rounded-lg border border-blue-500/50">
                                <span class="text-blue-300 text-xs">è¨ˆè²»ä¸­</span>
                                <span class="text-blue-400 font-bold text-lg" id="consign-charging-count">0</span>
                            </div>
                            <div class="flex items-center gap-1.5 px-3 py-1.5 bg-slate-900/80 rounded-lg border border-orange-500/50">
                                <span class="text-orange-300 text-xs">æœ¬æœˆåˆ°æœŸ</span>
                                <span class="text-orange-400 font-bold text-lg" id="consign-expiring-count">0</span>
                            </div>
                            <div class="flex items-center gap-1.5 px-3 py-1.5 bg-slate-900/80 rounded-lg border border-purple-500/50">
                                <span class="text-purple-300 text-xs">å¯„å€‰</span>
                                <span class="text-purple-400 font-bold text-lg" id="consign-total-units">0</span>
                                <span class="text-purple-300 text-xs">ä»¶</span>
                            </div>
                            <div class="flex items-center gap-1.5 px-3 py-1.5 bg-slate-900/80 rounded-lg border border-yellow-500/50">
                                <span class="text-yellow-300 text-xs">ç´¯è¨ˆ</span>
                                <span class="text-yellow-400 font-bold text-lg" id="consign-total-rent">$0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ç¯©é¸åˆ— -->
                <div class="flex gap-2 mb-3 items-center">
                    <select id="consign-status-filter" class="scan-input w-32" onchange="filterConsignments()">
                        <option value="all">å…¨éƒ¨ç‹€æ…‹</option>
                        <option value="free">å…è²»æœŸå…§</option>
                        <option value="charging">è¨ˆè²»ä¸­</option>
                        <option value="completed">å·²çµæ¸…</option>
                    </select>
                    <select id="consign-source-filter" class="scan-input w-28" onchange="filterConsignments()">
                        <option value="all">å…¨éƒ¨ä¾†æº</option>
                        <option value="internal">å…§å€‰</option>
                        <option value="external">å¤–å€‰</option>
                    </select>
                    <input type="text" id="consign-search" class="scan-input w-48" placeholder="æœå°‹å®¢æˆ¶/å“å..." oninput="filterConsignments()">
                    <div class="flex-1"></div>
                    <button onclick="openNewConsignmentModal()" class="px-4 py-1.5 bg-amber-600 hover:bg-amber-500 text-white rounded text-sm font-bold">
                        <i class="fa-solid fa-plus mr-1"></i>æ–°å¢å¯„å€‰
                    </button>
                    <button onclick="exportConsignments()" class="px-3 py-1.5 bg-emerald-600 hover:bg-emerald-500 text-white rounded text-sm">
                        <i class="fa-solid fa-file-excel mr-1"></i>åŒ¯å‡º
                    </button>
                </div>

                <!-- å¯„å€‰æ¸…å–® -->
                <div class="glass-panel flex-1 overflow-auto">
                    <table class="w-full dense-table">
                        <thead>
                            <tr>
                                <th>ä¾†æºå€‰åº«</th>
                                <th>å¯„åº«å€‰</th>
                                <th>å®¢æˆ¶</th>
                                <th>å“å</th>
                                <th>æ‰¹è™Ÿ</th>
                                <th class="text-right">åŸå§‹</th>
                                <th class="text-right">å‰©é¤˜</th>
                                <th>å…è²»æˆªæ­¢</th>
                                <th class="text-right">å¤©æ•¸</th>
                                <th class="text-right">ç§Ÿé‡‘</th>
                                <th>ç‹€æ…‹</th>
                                <th class="text-center">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="consignment-list">
                            <tr><td colspan="12" class="text-center text-slate-500 py-10">å°šç„¡å¯„å€‰è³‡æ–™</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- å€‰ç§Ÿå ±è¡¨é é¢ -->
            <div id="view-rental-report" class="view-panel h-full hidden flex flex-col p-4">
                <div class="bg-gradient-to-r from-emerald-900 to-teal-900 border border-emerald-600 p-3 rounded-lg mb-3">
                    <div class="flex justify-between items-center">
                        <div>
                            <h2 class="text-white font-bold text-lg"><i class="fa-solid fa-file-invoice-dollar mr-2 text-emerald-400"></i>å€‰ç§Ÿå ±è¡¨</h2>
                            <p class="text-emerald-200 text-sm">è‡ªæœ‰åº«å­˜æˆæœ¬ã€å®¢æˆ¶å¯„å€‰å¸³å–®</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-slate-300 text-sm">è¨ˆè²»æœˆä»½ï¼š</span>
                            <input type="month" id="rental-month" class="scan-input w-40" onchange="loadRentalReport()">
                            <button onclick="generateMonthlyBill()" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg font-bold">
                                <i class="fa-solid fa-file-invoice mr-1"></i>ç”¢ç”Ÿå¸³å–®
                            </button>
                        </div>
                    </div>
                </div>

                <!-- å ±è¡¨å…§å®¹ -->
                <div class="grid grid-cols-2 gap-4 flex-1 min-h-0">
                    <!-- å·¦å´ï¼šè‡ªæœ‰åº«å­˜ -->
                    <div class="glass-panel p-4 flex flex-col overflow-hidden">
                        <div class="flex items-center justify-between mb-3 pb-2 border-b border-slate-700">
                            <h3 class="text-white font-bold">
                                <i class="fa-solid fa-warehouse mr-2 text-blue-400"></i>è‡ªæœ‰åº«å­˜å€‰ç§Ÿï¼ˆå¸³é¢ï¼‰
                            </h3>
                            <span class="text-xs text-slate-400">ä¸æ”¶è²»ï¼Œåƒ…ä¾›æˆæœ¬åƒè€ƒ</span>
                        </div>
                        <div class="flex-1 overflow-y-auto">
                            <table class="w-full text-sm">
                                <thead>
                                    <tr class="text-slate-400 border-b border-slate-700">
                                        <th class="text-left p-2">å…¬å¸</th>
                                        <th class="text-right p-2">å¹³å‡æ¿æ•¸</th>
                                        <th class="text-right p-2">æ¿å¤©æ•¸</th>
                                        <th class="text-right p-2">å€‰ç§Ÿé‡‘é¡</th>
                                    </tr>
                                </thead>
                                <tbody id="own-stock-rental-body">
                                    <tr><td colspan="4" class="text-center text-slate-500 py-6">é¸æ“‡æœˆä»½å¾Œè¼‰å…¥</td></tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-3 pt-3 border-t border-slate-700 flex justify-between items-center">
                            <span class="text-slate-400 text-sm">è‡ªæœ‰åº«å­˜åˆè¨ˆ</span>
                            <span class="text-xl font-bold text-blue-400" id="own-stock-total">$0</span>
                        </div>
                    </div>

                    <!-- å³å´ï¼šå®¢æˆ¶å¯„å€‰ -->
                    <div class="glass-panel p-4 flex flex-col overflow-hidden">
                        <div class="flex items-center justify-between mb-3 pb-2 border-b border-slate-700">
                            <h3 class="text-white font-bold">
                                <i class="fa-solid fa-users mr-2 text-amber-400"></i>å®¢æˆ¶å¯„å€‰å¸³å–®ï¼ˆæ‡‰æ”¶ï¼‰
                            </h3>
                            <span class="text-xs text-emerald-400 font-bold">å¯¦éš›æ”¶è²»</span>
                        </div>
                        <div class="flex-1 overflow-y-auto">
                            <table class="w-full text-sm">
                                <thead>
                                    <tr class="text-slate-400 border-b border-slate-700">
                                        <th class="text-left p-2">å®¢æˆ¶</th>
                                        <th class="text-right p-2">å¯„å€‰ä»¶æ•¸</th>
                                        <th class="text-right p-2">ä»¶å¤©æ•¸</th>
                                        <th class="text-right p-2">å€‰ç§Ÿé‡‘é¡</th>
                                    </tr>
                                </thead>
                                <tbody id="consign-rental-body">
                                    <tr><td colspan="4" class="text-center text-slate-500 py-6">é¸æ“‡æœˆä»½å¾Œè¼‰å…¥</td></tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-3 pt-3 border-t border-slate-700 flex justify-between items-center">
                            <span class="text-slate-400 text-sm">å®¢æˆ¶å¯„å€‰åˆè¨ˆ</span>
                            <span class="text-xl font-bold text-amber-400" id="consign-total">$0</span>
                        </div>
                    </div>
                </div>

                <!-- åº•éƒ¨ï¼šç†è²¨è²»ç”¨ + ç¸½è¨ˆ -->
                <div class="grid grid-cols-3 gap-4 mt-3">
                    <div class="glass-panel p-4">
                        <h4 class="text-white font-bold text-sm mb-2"><i class="fa-solid fa-dolly mr-1 text-purple-400"></i>ç†è²¨è²»ç”¨</h4>
                        <div class="flex justify-between text-sm">
                            <span class="text-slate-400">æœ¬æœˆå…¥åº«</span>
                            <span class="text-white"><span id="handling-inbound-count">0</span> æ¿ Ã— 200 = <span class="text-purple-400 font-bold" id="handling-inbound-fee">$0</span></span>
                        </div>
                    </div>
                    <div class="glass-panel p-4">
                        <h4 class="text-white font-bold text-sm mb-2"><i class="fa-solid fa-clock mr-1 text-orange-400"></i>æš«å­˜å€è¶…æ™‚</h4>
                        <div class="flex justify-between text-sm">
                            <span class="text-slate-400">è¶…æ™‚è²»ç”¨</span>
                            <span class="text-orange-400 font-bold" id="temp-overtime-fee">$0</span>
                        </div>
                    </div>
                    <div class="glass-panel p-4 bg-gradient-to-r from-emerald-900/50 to-teal-900/50">
                        <h4 class="text-white font-bold text-sm mb-2"><i class="fa-solid fa-calculator mr-1 text-emerald-400"></i>æœ¬æœˆæ‡‰æ”¶ç¸½è¨ˆ</h4>
                        <div class="text-2xl font-bold text-emerald-400" id="monthly-total">$0</div>
                    </div>
                </div>
            </div>

            <!-- è²»ç‡è¨­å®šé é¢ -->
            <div id="view-rental-settings" class="view-panel h-full hidden flex flex-col p-4">
                <div class="bg-gradient-to-r from-blue-900 to-indigo-900 border border-blue-600 p-3 rounded-lg mb-4">
                    <h2 class="text-white font-bold text-lg"><i class="fa-solid fa-sliders mr-2 text-blue-400"></i>è²»ç‡è¨­å®š</h2>
                    <p class="text-blue-200 text-sm">å€‰ç§Ÿè²»ç‡ã€ç†è²¨è²»ç”¨ã€æ”¶è²»é–‹é—œè¨­å®š</p>
                </div>

                <div class="grid grid-cols-2 gap-4 flex-1 min-h-0 overflow-y-auto">
                    <!-- å·¦å´ï¼šæ”¶è²»é–‹é—œ + å€‰ç§Ÿè²»ç‡ -->
                    <div class="space-y-4">
                        <!-- æ”¶è²»é–‹é—œ -->
                        <div class="glass-panel p-4">
                            <h3 class="text-white font-bold text-sm mb-3 pb-2 border-b border-slate-700">
                                <i class="fa-solid fa-toggle-on mr-2 text-emerald-400"></i>è‡ªæœ‰åº«å­˜æ”¶è²»é–‹é—œ
                            </h3>
                            <div class="space-y-3">
                                <div class="flex items-center justify-between">
                                    <span class="text-white">å´‡æ–‡è‡ªæœ‰åº«å­˜</span>
                                    <div class="flex items-center gap-2">
                                        <label class="flex items-center gap-1 cursor-pointer">
                                            <input type="radio" name="charge-cw" value="no" checked class="w-4 h-4" onchange="updateRentalSettings()">
                                            <span class="text-slate-400 text-sm">ä¸æ”¶è²»</span>
                                        </label>
                                        <label class="flex items-center gap-1 cursor-pointer">
                                            <input type="radio" name="charge-cw" value="yes" class="w-4 h-4" onchange="updateRentalSettings()">
                                            <span class="text-emerald-400 text-sm">æ”¶è²»</span>
                                        </label>
                                    </div>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-white">å…«æ–¹è‡ªæœ‰åº«å­˜</span>
                                    <div class="flex items-center gap-2">
                                        <label class="flex items-center gap-1 cursor-pointer">
                                            <input type="radio" name="charge-bf" value="no" checked class="w-4 h-4" onchange="updateRentalSettings()">
                                            <span class="text-slate-400 text-sm">ä¸æ”¶è²»</span>
                                        </label>
                                        <label class="flex items-center gap-1 cursor-pointer">
                                            <input type="radio" name="charge-bf" value="yes" class="w-4 h-4" onchange="updateRentalSettings()">
                                            <span class="text-emerald-400 text-sm">æ”¶è²»</span>
                                        </label>
                                    </div>
                                </div>
                                <div class="pt-2 border-t border-slate-700">
                                    <div class="flex items-center justify-between">
                                        <span class="text-slate-400 text-sm">æ”¶è²»ç”Ÿæ•ˆæ—¥æœŸ</span>
                                        <input type="date" id="charge-effective-date" class="scan-input w-40 py-1" onchange="updateRentalSettings()">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- å€‰ç§Ÿè²»ç‡ -->
                        <div class="glass-panel p-4">
                            <h3 class="text-white font-bold text-sm mb-3 pb-2 border-b border-slate-700">
                                <i class="fa-solid fa-warehouse mr-2 text-blue-400"></i>å€‰ç§Ÿè²»ç‡ï¼ˆæ¿/å¤©ï¼‰
                            </h3>
                            <div class="space-y-3">
                                <div class="bg-slate-800 p-3 rounded-lg">
                                    <div class="text-cyan-400 font-bold text-sm mb-2">å…«æ–¹è²»ç‡</div>
                                    <div class="flex items-center gap-2">
                                        <span class="text-slate-400 text-sm">ä¸€èˆ¬è²»ç‡ï¼š</span>
                                        <input type="number" id="rate-bf-normal" class="scan-input w-20 py-1 text-center" value="22" onchange="updateRentalSettings()">
                                        <span class="text-slate-400 text-sm">å…ƒ/æ¿/å¤©</span>
                                    </div>
                                </div>
                                <div class="bg-slate-800 p-3 rounded-lg">
                                    <div class="text-emerald-400 font-bold text-sm mb-2">å´‡æ–‡è²»ç‡ï¼ˆéšæ¢¯/å…¨é¡åˆ¶ï¼‰</div>
                                    <div class="space-y-2">
                                        <div class="flex items-center gap-2">
                                            <span class="text-slate-400 text-sm">1 ~</span>
                                            <input type="number" id="rate-cw-tier1-max" class="scan-input w-16 py-1 text-center" value="300" onchange="updateRentalSettings()">
                                            <span class="text-slate-400 text-sm">æ¿ï¼š</span>
                                            <input type="number" id="rate-cw-tier1" class="scan-input w-16 py-1 text-center" value="22" onchange="updateRentalSettings()">
                                            <span class="text-slate-400 text-sm">å…ƒ</span>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <span class="text-slate-400 text-sm">è¶…éä»¥ä¸Šï¼š</span>
                                            <input type="number" id="rate-cw-tier2" class="scan-input w-16 py-1 text-center" value="20" onchange="updateRentalSettings()">
                                            <span class="text-slate-400 text-sm">å…ƒï¼ˆå…¨é¡é©ç”¨ï¼‰</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- å³å´ï¼šç†è²¨è²»ç”¨ + æš«å­˜å€ + çµç®— -->
                    <div class="space-y-4">
                        <!-- ç†è²¨è²»ç”¨ -->
                        <div class="glass-panel p-4">
                            <h3 class="text-white font-bold text-sm mb-3 pb-2 border-b border-slate-700">
                                <i class="fa-solid fa-dolly mr-2 text-purple-400"></i>ç†è²¨è²»ç”¨
                            </h3>
                            <div class="space-y-3">
                                <div class="flex items-center justify-between">
                                    <span class="text-white">å…¥åº«è²»</span>
                                    <div class="flex items-center gap-2">
                                        <input type="number" id="fee-inbound" class="scan-input w-20 py-1 text-center" value="200" onchange="updateRentalSettings()">
                                        <span class="text-slate-400 text-sm">å…ƒ/æ¿</span>
                                    </div>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-white">å‡ºåº«è²»</span>
                                    <div class="flex items-center gap-2">
                                        <input type="number" id="fee-outbound" class="scan-input w-20 py-1 text-center" value="0" onchange="updateRentalSettings()">
                                        <span class="text-slate-400 text-sm">å…ƒ/æ¿</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- æš«å­˜å€è¨­å®š -->
                        <div class="glass-panel p-4">
                            <h3 class="text-white font-bold text-sm mb-3 pb-2 border-b border-slate-700">
                                <i class="fa-solid fa-clock mr-2 text-orange-400"></i>æš«å­˜å€è¨­å®š
                            </h3>
                            <div class="flex items-center justify-between">
                                <span class="text-white">å…è²»æ™‚æ•¸</span>
                                <div class="flex items-center gap-2">
                                    <input type="number" id="temp-free-hours" class="scan-input w-20 py-1 text-center" value="4" onchange="updateRentalSettings()">
                                    <span class="text-slate-400 text-sm">å°æ™‚</span>
                                </div>
                            </div>
                            <div class="mt-2 text-xs text-slate-500">
                                è¶…éå…è²»æ™‚æ•¸å¾Œï¼ŒæŒ‰ä¸€èˆ¬å€‰ç§Ÿè²»ç‡è¨ˆç®—
                            </div>
                        </div>

                        <!-- çµç®—è¨­å®š -->
                        <div class="glass-panel p-4">
                            <h3 class="text-white font-bold text-sm mb-3 pb-2 border-b border-slate-700">
                                <i class="fa-solid fa-calendar-check mr-2 text-emerald-400"></i>çµç®—è¨­å®š
                            </h3>
                            <div class="space-y-3">
                                <div class="flex items-center justify-between">
                                    <span class="text-white">æ¯æœˆçµç®—æ—¥</span>
                                    <div class="flex items-center gap-2">
                                        <input type="number" id="settle-day" class="scan-input w-16 py-1 text-center" value="25" min="1" max="28" onchange="updateRentalSettings()">
                                        <span class="text-slate-400 text-sm">è™Ÿ</span>
                                    </div>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-white">å¯„å€‰å…è²»æˆªæ­¢</span>
                                    <div class="flex items-center gap-2">
                                        <span class="text-slate-400 text-sm">é è¨­è‡³ç•¶æœˆ</span>
                                        <input type="number" id="free-until-day" class="scan-input w-16 py-1 text-center" value="25" min="1" max="28" onchange="updateRentalSettings()">
                                        <span class="text-slate-400 text-sm">è™Ÿ</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- å„²å­˜æŒ‰éˆ• -->
                        <button onclick="saveRentalSettings()" class="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-bold">
                            <i class="fa-solid fa-save mr-2"></i>å„²å­˜è¨­å®š
                        </button>
                    </div>
                </div>
            </div>

            <!-- æ•ˆæœŸç®¡ç†é é¢ -->
            <div id="view-expiry-management" class="view-panel h-full hidden flex flex-col p-4">
                <!-- é ‚éƒ¨æ¨™é¡Œ -->
                <div class="flex items-center justify-between bg-gradient-to-r from-red-900 to-orange-900 border border-red-600 p-4 rounded-xl mb-4">
                    <div>
                        <h2 class="text-white font-bold text-2xl"><i class="fa-solid fa-calendar-xmark mr-2 text-red-400"></i>æ•ˆæœŸç®¡ç†</h2>
                        <p class="text-red-200 text-sm mt-1">ç›£æ§åº«å­˜æ•ˆæœŸç‹€æ…‹ï¼Œç®¡ç†å³æœŸå“èˆ‡éæœŸå“</p>
                    </div>
                    <div class="flex gap-2 items-center">
                        <span class="text-slate-300 text-sm">å³æœŸå¤©æ•¸ï¼š</span>
                        <select id="expiry-days-setting" class="scan-input w-24" onchange="saveExpirySettings(); refreshExpiryReport();">
                            <option value="30">30å¤©</option>
                            <option value="60">60å¤©</option>
                            <option value="90" selected>90å¤©</option>
                            <option value="120">120å¤©</option>
                            <option value="180">180å¤©</option>
                        </select>
                        <button onclick="refreshExpiryReport()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg font-bold">
                            <i class="fa-solid fa-sync mr-2"></i>é‡æ–°æ•´ç†
                        </button>
                        <button onclick="printExpiryReport()" class="bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded-lg font-bold">
                            <i class="fa-solid fa-print mr-2"></i>åˆ—å°å ±è¡¨
                        </button>
                    </div>
                </div>

                <!-- æ•ˆæœŸçµ±è¨ˆå¡ç‰‡ -->
                <div class="grid grid-cols-5 gap-3 mb-4">
                    <div class="bg-gradient-to-br from-red-900/50 to-red-800/30 border border-red-600/50 rounded-xl p-4 text-center">
                        <div class="text-red-400 text-sm mb-1"><i class="fa-solid fa-skull-crossbones mr-1"></i>å·²éæœŸ</div>
                        <div class="text-3xl font-black text-red-400" id="expiry-stat-expired">0</div>
                        <div class="text-xs text-red-300 mt-1" id="expiry-stat-expired-qty">0 ä»¶</div>
                    </div>
                    <div class="bg-gradient-to-br from-orange-900/50 to-orange-800/30 border border-orange-600/50 rounded-xl p-4 text-center">
                        <div class="text-orange-400 text-sm mb-1"><i class="fa-solid fa-triangle-exclamation mr-1"></i>7å¤©å…§åˆ°æœŸ</div>
                        <div class="text-3xl font-black text-orange-400" id="expiry-stat-7days">0</div>
                        <div class="text-xs text-orange-300 mt-1" id="expiry-stat-7days-qty">0 ä»¶</div>
                    </div>
                    <div class="bg-gradient-to-br from-yellow-900/50 to-yellow-800/30 border border-yellow-600/50 rounded-xl p-4 text-center">
                        <div class="text-yellow-400 text-sm mb-1"><i class="fa-solid fa-clock mr-1"></i>30å¤©å…§åˆ°æœŸ</div>
                        <div class="text-3xl font-black text-yellow-400" id="expiry-stat-30days">0</div>
                        <div class="text-xs text-yellow-300 mt-1" id="expiry-stat-30days-qty">0 ä»¶</div>
                    </div>
                    <div class="bg-gradient-to-br from-cyan-900/50 to-cyan-800/30 border border-cyan-600/50 rounded-xl p-4 text-center">
                        <div class="text-cyan-400 text-sm mb-1"><i class="fa-solid fa-hourglass-half mr-1"></i>å³æœŸå“</div>
                        <div class="text-3xl font-black text-cyan-400" id="expiry-stat-soon">0</div>
                        <div class="text-xs text-cyan-300 mt-1" id="expiry-stat-soon-qty">0 ä»¶</div>
                    </div>
                    <div class="bg-gradient-to-br from-emerald-900/50 to-emerald-800/30 border border-emerald-600/50 rounded-xl p-4 text-center">
                        <div class="text-emerald-400 text-sm mb-1"><i class="fa-solid fa-check-circle mr-1"></i>æ•ˆæœŸæ­£å¸¸</div>
                        <div class="text-3xl font-black text-emerald-400" id="expiry-stat-normal">0</div>
                        <div class="text-xs text-emerald-300 mt-1" id="expiry-stat-normal-qty">0 ä»¶</div>
                    </div>
                </div>

                <!-- ç¯©é¸æ¢ä»¶ -->
                <div class="flex gap-2 mb-3">
                    <button onclick="filterExpiryReport('all')" class="expiry-filter-btn active bg-slate-700 text-white px-4 py-2 rounded-lg text-sm font-bold" data-filter="all">
                        <i class="fa-solid fa-list mr-1"></i>å…¨éƒ¨
                    </button>
                    <button onclick="filterExpiryReport('expired')" class="expiry-filter-btn bg-slate-800 text-slate-400 px-4 py-2 rounded-lg text-sm font-bold" data-filter="expired">
                        <i class="fa-solid fa-skull-crossbones mr-1"></i>å·²éæœŸ
                    </button>
                    <button onclick="filterExpiryReport('7days')" class="expiry-filter-btn bg-slate-800 text-slate-400 px-4 py-2 rounded-lg text-sm font-bold" data-filter="7days">
                        <i class="fa-solid fa-triangle-exclamation mr-1"></i>7å¤©å…§
                    </button>
                    <button onclick="filterExpiryReport('30days')" class="expiry-filter-btn bg-slate-800 text-slate-400 px-4 py-2 rounded-lg text-sm font-bold" data-filter="30days">
                        <i class="fa-solid fa-clock mr-1"></i>30å¤©å…§
                    </button>
                    <button onclick="filterExpiryReport('soon')" class="expiry-filter-btn bg-slate-800 text-slate-400 px-4 py-2 rounded-lg text-sm font-bold" data-filter="soon">
                        <i class="fa-solid fa-hourglass-half mr-1"></i>å³æœŸå“
                    </button>
                    <div class="flex-1"></div>
                    <input type="text" id="expiry-search" class="scan-input w-64" placeholder="æœå°‹å“å..." oninput="filterExpiryBySearch()">
                </div>

                <!-- æ•ˆæœŸæ¸…å–® -->
                <div class="flex-1 bg-slate-800/50 border border-slate-700 rounded-xl overflow-hidden">
                    <div class="overflow-auto h-full">
                        <table class="w-full dense-table">
                            <thead>
                                <tr class="bg-slate-900">
                                    <th class="p-3 text-left w-24">ç‹€æ…‹</th>
                                    <th class="p-3 text-left">å“å</th>
                                    <th class="p-3 text-left">è¦æ ¼</th>
                                    <th class="p-3 text-left">å„²ä½</th>
                                    <th class="p-3 text-right">æ•¸é‡</th>
                                    <th class="p-3 text-left">æ•ˆæœŸ</th>
                                    <th class="p-3 text-left">å‰©é¤˜å¤©æ•¸</th>
                                    <th class="p-3 text-left">æ‰¹è™Ÿ</th>
                                    <th class="p-3 text-center">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="expiry-table-body">
                                <tr><td colspan="9" class="text-center text-slate-500 py-8">è¼‰å…¥ä¸­...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- åº«å­˜ç•°å‹•æŸ¥è©¢é é¢ -->
            <div id="view-inventory-log" class="view-panel h-full hidden flex flex-col p-4">
                <!-- é ‚éƒ¨æ¨™é¡Œï¼ˆæ•´åˆçµ±è¨ˆï¼‰ -->
                <div class="bg-gradient-to-r from-purple-900 to-indigo-900 border border-purple-600 p-4 rounded-xl mb-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-6">
                            <div>
                                <h2 class="text-white font-bold text-xl"><i class="fa-solid fa-clock-rotate-left mr-2 text-purple-400"></i>åº«å­˜ç•°å‹•æŸ¥è©¢</h2>
                                <p class="text-purple-200 text-xs mt-1">æŸ¥è©¢å“é …çš„å…¥åº«ã€å‡ºåº«ã€ç§»ä½ç­‰æ­·å²è¨˜éŒ„</p>
                            </div>
                            <!-- çµ±è¨ˆæ•¸æ“šæ•´åˆåœ¨æ¨™é¡Œåˆ— -->
                            <div class="flex gap-4 ml-4 pl-4 border-l border-purple-500/50" id="log-summary">
                                <div class="text-center">
                                    <div class="text-lg font-bold text-white" id="log-stat-total">0</div>
                                    <div class="text-[10px] text-purple-300">ç¸½ç­†æ•¸</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-lg font-bold text-emerald-400" id="log-stat-inbound">0</div>
                                    <div class="text-[10px] text-purple-300">å…¥åº«</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-lg font-bold text-red-400" id="log-stat-outbound">0</div>
                                    <div class="text-[10px] text-purple-300">å‡ºåº«</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-lg font-bold text-blue-400" id="log-stat-move">0</div>
                                    <div class="text-[10px] text-purple-300">ç§»ä½</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-lg font-bold text-yellow-400" id="log-stat-other">0</div>
                                    <div class="text-[10px] text-purple-300">å…¶ä»–</div>
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="rebuildHistoryLogs()" class="bg-orange-600 hover:bg-orange-500 text-white px-3 py-2 rounded-lg font-bold text-sm">
                                <i class="fa-solid fa-database mr-1"></i>è£œå»ºè¨˜éŒ„
                            </button>
                            <button onclick="exportInventoryLog()" class="bg-emerald-600 hover:bg-emerald-500 text-white px-3 py-2 rounded-lg font-bold text-sm">
                                <i class="fa-solid fa-file-excel mr-1"></i>åŒ¯å‡º
                            </button>
                        </div>
                    </div>
                </div>

                <!-- æŸ¥è©¢æ¢ä»¶ï¼ˆç²¾ç°¡ç‰ˆï¼‰ -->
                <div class="bg-slate-800 border border-slate-700 rounded-xl p-3 mb-3">
                    <div class="flex gap-3 items-end">
                        <!-- æ—¥æœŸç¯„åœ -->
                        <div class="flex-1">
                            <label class="text-slate-400 text-xs mb-1 block">æ—¥æœŸç¯„åœ</label>
                            <div class="flex gap-2 items-center">
                                <input type="date" id="log-date-from" class="scan-input flex-1 text-sm py-1.5" />
                                <span class="text-slate-500">~</span>
                                <input type="date" id="log-date-to" class="scan-input flex-1 text-sm py-1.5" />
                            </div>
                        </div>

                        <!-- å“é …åç¨± -->
                        <div class="w-36">
                            <label class="text-slate-400 text-xs mb-1 block">å“é …åç¨±</label>
                            <input type="text" id="log-product-name" class="scan-input w-full text-sm py-1.5" placeholder="å“å..." />
                        </div>

                        <!-- å„²ä½ -->
                        <div class="w-28">
                            <label class="text-slate-400 text-xs mb-1 block">å„²ä½</label>
                            <input type="text" id="log-location" class="scan-input w-full text-sm py-1.5" placeholder="I-A-01" />
                        </div>

                        <!-- ç•°å‹•é¡å‹ -->
                        <div class="w-28">
                            <label class="text-slate-400 text-xs mb-1 block">é¡å‹</label>
                            <select id="log-type" class="scan-input w-full text-sm py-1.5">
                                <option value="">å…¨éƒ¨</option>
                                <option value="inbound">å…¥åº«</option>
                                <option value="outbound">å‡ºåº«</option>
                                <option value="picking">é ˜ç”¨</option>
                                <option value="move">ç§»ä½</option>
                                <option value="merge">åˆä½µ</option>
                                <option value="transfer">èª¿æ’¥</option>
                                <option value="adjust">ç›¤é»èª¿æ•´</option>
                            </select>
                        </div>

                        <!-- æŸ¥è©¢æŒ‰éˆ• -->
                        <button onclick="searchInventoryLog()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-1.5 rounded-lg font-bold text-sm">
                            <i class="fa-solid fa-search mr-1"></i>æŸ¥è©¢
                        </button>

                        <!-- å¿«é€Ÿç¯©é¸ -->
                        <div class="flex gap-1 border-l border-slate-600 pl-3">
                            <button onclick="setLogDateRange('today')" class="text-xs px-2 py-1.5 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded">ä»Šå¤©</button>
                            <button onclick="setLogDateRange('week')" class="text-xs px-2 py-1.5 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded">7å¤©</button>
                            <button onclick="setLogDateRange('month')" class="text-xs px-2 py-1.5 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded">30å¤©</button>
                            <button onclick="setLogDateRange('all')" class="text-xs px-2 py-1.5 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded">å…¨éƒ¨</button>
                        </div>
                    </div>
                </div>

                <!-- æŸ¥è©¢çµæœè¡¨æ ¼ -->
                <div class="flex-1 bg-slate-800 border border-slate-700 rounded-xl overflow-hidden flex flex-col">
                    <div class="flex-1 overflow-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-slate-700 sticky top-0">
                                <tr>
                                    <th class="text-left p-3 text-slate-300 font-medium">æ—¥æœŸæ™‚é–“</th>
                                    <th class="text-left p-3 text-slate-300 font-medium">å…¬å¸</th>
                                    <th class="text-left p-3 text-slate-300 font-medium">é¡å‹</th>
                                    <th class="text-left p-3 text-slate-300 font-medium">å“é …</th>
                                    <th class="text-left p-3 text-slate-300 font-medium">è¦æ ¼</th>
                                    <th class="text-right p-3 text-slate-300 font-medium">æ•¸é‡</th>
                                    <th class="text-right p-3 text-slate-300 font-medium">é‡é‡</th>
                                    <th class="text-left p-3 text-slate-300 font-medium">å„²ä½</th>
                                    <th class="text-left p-3 text-slate-300 font-medium">æ‰¹è™Ÿ</th>
                                    <th class="text-left p-3 text-slate-300 font-medium">å‚™è¨»</th>
                                </tr>
                            </thead>
                            <tbody id="inventory-log-list">
                                <tr><td colspan="10" class="text-center text-slate-500 py-16">
                                    <i class="fa-solid fa-search text-4xl mb-3 opacity-30"></i>
                                    <p>è«‹è¨­å®šæŸ¥è©¢æ¢ä»¶å¾Œé»æ“Šã€ŒæŸ¥è©¢ã€</p>
                                </td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="p-3 border-t border-slate-700 flex justify-between items-center text-sm bg-slate-800">
                        <span class="text-slate-400">æŸ¥è©¢çµæœï¼š<span id="log-result-count" class="text-white font-bold">0</span> ç­†</span>
                        <div class="flex gap-2" id="log-pagination"></div>
                    </div>
                </div>
            </div>

            <!-- å“é …å‡ºè²¨åˆ†æé é¢ -->
            <div id="view-product-analysis" class="view-panel h-full hidden flex flex-col p-4">
                <!-- é ‚éƒ¨æ¨™é¡Œ -->
                <div class="flex items-center justify-between bg-gradient-to-r from-orange-900 to-red-900 border border-orange-600 p-4 rounded-xl mb-4">
                    <div>
                        <h2 class="text-white font-bold text-2xl"><i class="fa-solid fa-chart-bar mr-2 text-orange-400"></i>å“é …å‡ºè²¨åˆ†æ</h2>
                        <p class="text-orange-200 text-sm mt-1">åˆ†æå„å“é …çš„å‡ºè²¨é »ç‡èˆ‡æ•¸é‡æ’è¡Œ</p>
                    </div>
                    <button onclick="refreshProductAnalysis()" class="bg-orange-600 hover:bg-orange-500 text-white px-5 py-3 rounded-lg font-bold">
                        <i class="fa-solid fa-sync mr-2"></i>é‡æ–°åˆ†æ
                    </button>
                </div>

                <!-- æŸ¥è©¢æ¢ä»¶ -->
                <div class="bg-slate-800 border border-slate-700 rounded-xl p-4 mb-4">
                    <div class="flex gap-4 items-end">
                        <div>
                            <label class="text-slate-400 text-xs mb-1 block">åˆ†ææœŸé–“</label>
                            <div class="flex gap-2 items-center">
                                <input type="date" id="analysis-date-from" class="scan-input" />
                                <span class="text-slate-500">~</span>
                                <input type="date" id="analysis-date-to" class="scan-input" />
                            </div>
                        </div>
                        <div>
                            <label class="text-slate-400 text-xs mb-1 block">æ’åºä¾æ“š</label>
                            <select id="analysis-sort" class="scan-input">
                                <option value="count">å‡ºè²¨æ¬¡æ•¸</option>
                                <option value="qty">å‡ºè²¨æ•¸é‡</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-slate-400 text-xs mb-1 block">é¡¯ç¤ºç­†æ•¸</label>
                            <select id="analysis-limit" class="scan-input">
                                <option value="10">Top 10</option>
                                <option value="20">Top 20</option>
                                <option value="50">Top 50</option>
                                <option value="100">å…¨éƒ¨</option>
                            </select>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="setAnalysisDateRange('week')" class="text-xs px-3 py-2 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded">è¿‘7å¤©</button>
                            <button onclick="setAnalysisDateRange('month')" class="text-xs px-3 py-2 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded">è¿‘30å¤©</button>
                            <button onclick="setAnalysisDateRange('quarter')" class="text-xs px-3 py-2 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded">è¿‘3å€‹æœˆ</button>
                        </div>
                    </div>
                </div>

                <!-- çµ±è¨ˆæ‘˜è¦ -->
                <div class="grid grid-cols-4 gap-3 mb-4">
                    <div class="bg-slate-800 border border-slate-700 rounded-lg p-4 text-center">
                        <div class="text-3xl font-bold text-white" id="pa-stat-products">0</div>
                        <div class="text-xs text-slate-400 mt-1">å‡ºè²¨å“é …æ•¸</div>
                    </div>
                    <div class="bg-emerald-900/30 border border-emerald-600/50 rounded-lg p-4 text-center">
                        <div class="text-3xl font-bold text-emerald-400" id="pa-stat-total-count">0</div>
                        <div class="text-xs text-slate-400 mt-1">ç¸½å‡ºè²¨æ¬¡æ•¸</div>
                    </div>
                    <div class="bg-blue-900/30 border border-blue-600/50 rounded-lg p-4 text-center">
                        <div class="text-3xl font-bold text-blue-400" id="pa-stat-total-qty">0</div>
                        <div class="text-xs text-slate-400 mt-1">ç¸½å‡ºè²¨æ•¸é‡</div>
                    </div>
                    <div class="bg-purple-900/30 border border-purple-600/50 rounded-lg p-4 text-center">
                        <div class="text-3xl font-bold text-purple-400" id="pa-stat-avg">0</div>
                        <div class="text-xs text-slate-400 mt-1">å¹³å‡æ¯æ¬¡å‡ºè²¨</div>
                    </div>
                </div>

                <!-- åœ–è¡¨èˆ‡æ’è¡Œæ¦œ -->
                <div class="flex-1 flex gap-4 overflow-hidden">
                    <!-- å·¦å´ï¼šé•·æ¢åœ– -->
                    <div class="w-1/2 bg-slate-800 border border-slate-700 rounded-xl p-4 flex flex-col">
                        <h3 class="text-white font-bold mb-3"><i class="fa-solid fa-chart-bar text-orange-400 mr-2"></i>å‡ºè²¨æ’è¡Œæ¦œ</h3>
                        <div class="flex-1 overflow-auto" id="pa-bar-chart">
                            <div class="text-center text-slate-500 py-16">
                                <i class="fa-solid fa-chart-bar text-4xl mb-3 opacity-30"></i>
                                <p>é»æ“Šã€Œé‡æ–°åˆ†æã€è¼‰å…¥è³‡æ–™</p>
                            </div>
                        </div>
                    </div>

                    <!-- å³å´ï¼šè©³ç´°åˆ—è¡¨ -->
                    <div class="w-1/2 bg-slate-800 border border-slate-700 rounded-xl overflow-hidden flex flex-col">
                        <div class="p-3 border-b border-slate-700">
                            <h3 class="text-white font-bold"><i class="fa-solid fa-list-ol text-blue-400 mr-2"></i>è©³ç´°æ’è¡Œ</h3>
                        </div>
                        <div class="flex-1 overflow-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-slate-700 sticky top-0">
                                    <tr>
                                        <th class="text-center p-2 text-slate-300 w-12">#</th>
                                        <th class="text-left p-2 text-slate-300">å“é …</th>
                                        <th class="text-left p-2 text-slate-300">è¦æ ¼</th>
                                        <th class="text-right p-2 text-slate-300">æ¬¡æ•¸</th>
                                        <th class="text-right p-2 text-slate-300">æ•¸é‡</th>
                                        <th class="text-right p-2 text-slate-300">ä½”æ¯”</th>
                                    </tr>
                                </thead>
                                <tbody id="pa-ranking-list">
                                    <tr><td colspan="6" class="text-center text-slate-500 py-8">å°šç„¡è³‡æ–™</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å€‰åº«ç†±åŠ›åœ–é é¢ -->
            <div id="view-warehouse-heatmap" class="view-panel h-full hidden flex flex-col p-4">
                <!-- é ‚éƒ¨æ¨™é¡Œ -->
                <div class="flex items-center justify-between bg-gradient-to-r from-red-900 to-orange-900 border border-red-600 p-4 rounded-xl mb-4">
                    <div>
                        <h2 class="text-white font-bold text-2xl"><i class="fa-solid fa-fire mr-2 text-red-400"></i>å€‰åº«ç†±åŠ›åœ–</h2>
                        <p class="text-red-200 text-sm mt-1">è¦–è¦ºåŒ–å„å„²ä½çš„ä½¿ç”¨é »ç‡èˆ‡é€±è½‰ç‹€æ³</p>
                    </div>
                    <button onclick="refreshWarehouseHeatmap()" class="bg-red-600 hover:bg-red-500 text-white px-5 py-3 rounded-lg font-bold">
                        <i class="fa-solid fa-sync mr-2"></i>é‡æ–°åˆ†æ
                    </button>
                </div>

                <!-- æŸ¥è©¢æ¢ä»¶èˆ‡åœ–ä¾‹ -->
                <div class="flex gap-4 mb-4">
                    <div class="bg-slate-800 border border-slate-700 rounded-xl p-4 flex gap-4 items-end">
                        <div>
                            <label class="text-slate-400 text-xs mb-1 block">åˆ†ææœŸé–“</label>
                            <div class="flex gap-2 items-center">
                                <input type="date" id="heatmap-date-from" class="scan-input" />
                                <span class="text-slate-500">~</span>
                                <input type="date" id="heatmap-date-to" class="scan-input" />
                            </div>
                        </div>
                        <div>
                            <label class="text-slate-400 text-xs mb-1 block">ç†±åŠ›æŒ‡æ¨™</label>
                            <select id="heatmap-metric" class="scan-input" onchange="refreshWarehouseHeatmap()">
                                <option value="frequency">ä½¿ç”¨é »ç‡ï¼ˆå‡ºå…¥åº«æ¬¡æ•¸ï¼‰</option>
                                <option value="turnover">é€±è½‰ç‡</option>
                                <option value="duration">å¹³å‡åœç•™å¤©æ•¸</option>
                            </select>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="setHeatmapDateRange('month')" class="text-xs px-3 py-2 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded">è¿‘30å¤©</button>
                            <button onclick="setHeatmapDateRange('quarter')" class="text-xs px-3 py-2 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded">è¿‘3å€‹æœˆ</button>
                        </div>
                    </div>

                    <!-- ç†±åŠ›åœ–ä¾‹ -->
                    <div class="bg-slate-800 border border-slate-700 rounded-xl p-4 flex items-center gap-4">
                        <span class="text-slate-400 text-xs">ç†±åº¦ï¼š</span>
                        <div class="flex items-center gap-1">
                            <div class="w-6 h-6 rounded bg-red-600"></div>
                            <span class="text-xs text-slate-300">é«˜é »ï¼ˆç†±å€ï¼‰</span>
                        </div>
                        <div class="flex items-center gap-1">
                            <div class="w-6 h-6 rounded bg-orange-500"></div>
                            <span class="text-xs text-slate-300">ä¸­é«˜</span>
                        </div>
                        <div class="flex items-center gap-1">
                            <div class="w-6 h-6 rounded bg-yellow-500"></div>
                            <span class="text-xs text-slate-300">ä¸­</span>
                        </div>
                        <div class="flex items-center gap-1">
                            <div class="w-6 h-6 rounded bg-emerald-500"></div>
                            <span class="text-xs text-slate-300">ä½é »ï¼ˆå†·å€ï¼‰</span>
                        </div>
                        <div class="flex items-center gap-1">
                            <div class="w-6 h-6 rounded bg-slate-600"></div>
                            <span class="text-xs text-slate-300">æœªä½¿ç”¨</span>
                        </div>
                    </div>
                </div>

                <!-- ç†±åŠ›åœ– -->
                <div class="flex-1 bg-slate-800 border border-slate-700 rounded-xl p-4 overflow-auto">
                    <div class="grid grid-cols-3 gap-6" id="heatmap-container">
                        <!-- I åº« -->
                        <div class="bg-slate-900/50 rounded-lg p-4">
                            <h4 class="text-blue-400 font-bold mb-3 text-center">I åº«ï¼ˆåŸæ–™ï¼‰</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <div class="text-xs text-slate-500 mb-1 text-center">A å€</div>
                                    <div class="grid grid-cols-8 gap-1" id="heatmap-I-A"></div>
                                </div>
                                <div>
                                    <div class="text-xs text-slate-500 mb-1 text-center">B å€</div>
                                    <div class="grid grid-cols-8 gap-1" id="heatmap-I-B"></div>
                                </div>
                            </div>
                        </div>

                        <!-- J åº« -->
                        <div class="bg-slate-900/50 rounded-lg p-4">
                            <h4 class="text-purple-400 font-bold mb-3 text-center">J åº«ï¼ˆæˆå“ï¼‰</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <div class="text-xs text-slate-500 mb-1 text-center">C å€</div>
                                    <div class="grid grid-cols-8 gap-1" id="heatmap-J-C"></div>
                                </div>
                                <div>
                                    <div class="text-xs text-slate-500 mb-1 text-center">D å€</div>
                                    <div class="grid grid-cols-8 gap-1" id="heatmap-J-D"></div>
                                </div>
                            </div>
                        </div>

                        <!-- K åº« -->
                        <div class="bg-slate-900/50 rounded-lg p-4">
                            <h4 class="text-emerald-400 font-bold mb-3 text-center">K åº«ï¼ˆå¤§å‹ï¼‰</h4>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <div class="text-xs text-slate-500 mb-1 text-center">E å€</div>
                                    <div class="grid grid-cols-11 gap-0.5" id="heatmap-K-E"></div>
                                </div>
                                <div>
                                    <div class="text-xs text-slate-500 mb-1 text-center">F å€</div>
                                    <div class="grid grid-cols-11 gap-0.5" id="heatmap-K-F"></div>
                                </div>
                                <div>
                                    <div class="text-xs text-slate-500 mb-1 text-center">G å€</div>
                                    <div class="grid grid-cols-11 gap-0.5" id="heatmap-K-G"></div>
                                </div>
                                <div>
                                    <div class="text-xs text-slate-500 mb-1 text-center">H å€</div>
                                    <div class="grid grid-cols-11 gap-0.5" id="heatmap-K-H"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- çµ±è¨ˆæ‘˜è¦ -->
                    <div class="grid grid-cols-4 gap-4 mt-6 pt-4 border-t border-slate-700">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-red-400" id="hm-stat-hot">0</div>
                            <div class="text-xs text-slate-400">ç†±å€å„²ä½</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-yellow-400" id="hm-stat-medium">0</div>
                            <div class="text-xs text-slate-400">ä¸­é »å„²ä½</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-emerald-400" id="hm-stat-cold">0</div>
                            <div class="text-xs text-slate-400">å†·å€å„²ä½</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-slate-400" id="hm-stat-unused">0</div>
                            <div class="text-xs text-slate-400">æœªä½¿ç”¨</div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- å“é …é¸æ“‡ Modal -->
    <div id="modal-product-select" class="fixed inset-0 z-50 bg-black/80 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-slate-900 border border-slate-700 rounded-2xl w-[700px] max-h-[80vh] shadow-2xl flex flex-col">
            <div class="bg-gradient-to-r from-cyan-800 to-cyan-700 p-4 rounded-t-2xl border-b border-cyan-600 flex justify-between items-center">
                <h3 class="text-white font-bold text-lg"><i class="fa-solid fa-box-open mr-2"></i>é¸æ“‡å“é …</h3>
                <button onclick="closeProductSelectModal()" class="text-slate-300 hover:text-white text-xl">&times;</button>
            </div>
            <div class="p-4 flex flex-col flex-1 overflow-hidden">
                <!-- æœå°‹åˆ— -->
                <div class="flex gap-2 mb-3">
                    <div class="relative flex-1">
                        <i class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                        <input type="text" id="product-select-search" class="w-full p-2.5 pl-10 bg-slate-800 border border-slate-600 rounded-lg text-white" placeholder="è¼¸å…¥å“è™Ÿã€å“åæˆ–è¦æ ¼æœå°‹..." oninput="filterProductSelectList()" autofocus>
                    </div>
                    <select id="product-select-category" class="px-3 bg-slate-800 border border-slate-600 rounded-lg text-white text-sm" onchange="filterProductSelectList()">
                        <option value="">å…¨éƒ¨é¡åˆ¥</option>
                        <option value="æˆå“">æˆå“</option>
                        <option value="åŸæ–™">åŸæ–™</option>
                        <option value="åŠæˆå“">åŠæˆå“</option>
                        <option value="åŒ…æ">åŒ…æ</option>
                    </select>
                </div>
                
                <!-- å“é …åˆ—è¡¨ -->
                <div class="flex-1 overflow-y-auto bg-slate-800 rounded-lg border border-slate-700">
                    <table class="w-full text-sm">
                        <thead class="bg-slate-700 sticky top-0">
                            <tr>
                                <th class="p-2 text-left text-slate-300 w-24">å“è™Ÿ</th>
                                <th class="p-2 text-left text-slate-300">å“å</th>
                                <th class="p-2 text-left text-slate-300">è¦æ ¼</th>
                                <th class="p-2 text-center text-slate-300 w-20">æ¿å®¹é‡</th>
                                <th class="p-2 text-center text-slate-300 w-16">é¡åˆ¥</th>
                                <th class="p-2 text-center text-slate-300 w-16">é¸æ“‡</th>
                            </tr>
                        </thead>
                        <tbody id="product-select-list" class="divide-y divide-slate-700">
                        </tbody>
                    </table>
                </div>
                
                <!-- çµ±è¨ˆ -->
                <div class="mt-3 flex justify-between items-center text-sm">
                    <span class="text-slate-400">å…± <span id="product-select-count" class="text-cyan-400 font-bold">0</span> ç­†å“é …</span>
                    <button onclick="closeProductSelectModal()" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg">
                        å–æ¶ˆ
                    </button>
                </div>
            </div>
        </div>
    </div>
    <input type="hidden" id="product-select-mode" value="">

    <!-- å“é …ä¸»æª” Excel åŒ¯å…¥ Modal -->
    <div id="modal-pm-import" class="fixed inset-0 z-50 bg-black/80 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-slate-900 border border-slate-700 rounded-2xl w-[900px] max-h-[85vh] shadow-2xl flex flex-col">
            <div class="bg-gradient-to-r from-emerald-800 to-emerald-700 p-4 rounded-t-2xl border-b border-emerald-600 flex justify-between items-center">
                <h3 class="text-white font-bold text-lg"><i class="fa-solid fa-file-excel mr-2"></i>å“é …ä¸»æª” Excel åŒ¯å…¥</h3>
                <button onclick="closeProductMasterImport()" class="text-slate-300 hover:text-white text-xl">&times;</button>
            </div>

            <div class="p-4 flex-1 overflow-auto">
                <!-- Step 1: ä¸Šå‚³æª”æ¡ˆ -->
                <div id="pm-import-step1" class="mb-4">
                    <div class="flex items-center gap-2 mb-3">
                        <span class="bg-emerald-600 text-white text-xs px-2 py-0.5 rounded font-bold">1</span>
                        <span class="text-white font-bold">é¸æ“‡ Excel æª”æ¡ˆ</span>
                    </div>
                    <div class="flex gap-3 items-center">
                        <input type="file" id="pm-import-file" accept=".xlsx,.xls,.csv"
                               class="flex-1 text-white file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-emerald-600 file:text-white file:font-bold hover:file:bg-emerald-500"
                               onchange="previewProductMasterImport()">
                        <button onclick="downloadProductMasterTemplate()" class="px-3 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg text-sm">
                            <i class="fa-solid fa-download mr-1"></i>ä¸‹è¼‰ç¯„æœ¬
                        </button>
                    </div>
                    <div class="mt-2 text-xs text-slate-400">
                        <i class="fa-solid fa-info-circle mr-1"></i>
                        æ”¯æ´æ ¼å¼ï¼š.xlsx, .xls, .csv | å¿…å¡«æ¬„ä½ï¼šå“è™Ÿã€å“åã€æ¿å®¹é‡
                    </div>
                </div>

                <!-- Step 2: é è¦½è³‡æ–™ -->
                <div id="pm-import-step2" class="hidden">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2">
                            <span class="bg-emerald-600 text-white text-xs px-2 py-0.5 rounded font-bold">2</span>
                            <span class="text-white font-bold">é è¦½è³‡æ–™</span>
                        </div>
                        <div class="flex gap-3 text-sm">
                            <span class="text-emerald-400"><i class="fa-solid fa-plus-circle mr-1"></i>æ–°å¢: <span id="pm-import-new-count">0</span></span>
                            <span class="text-yellow-400"><i class="fa-solid fa-edit mr-1"></i>æ›´æ–°: <span id="pm-import-update-count">0</span></span>
                            <span class="text-red-400"><i class="fa-solid fa-exclamation-circle mr-1"></i>éŒ¯èª¤: <span id="pm-import-error-count">0</span></span>
                            <span class="text-slate-400"><i class="fa-solid fa-copy mr-1"></i>é‡è¤‡: <span id="pm-import-skip-count">0</span></span>
                        </div>
                    </div>

                    <div class="bg-slate-800 rounded-lg border border-slate-700 max-h-[350px] overflow-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-slate-700 sticky top-0">
                                <tr>
                                    <th class="p-2 text-left text-slate-300">ç‹€æ…‹</th>
                                    <th class="p-2 text-left text-slate-300">å“è™Ÿ</th>
                                    <th class="p-2 text-left text-slate-300">å“å</th>
                                    <th class="p-2 text-left text-slate-300">è¦æ ¼</th>
                                    <th class="p-2 text-center text-slate-300">æ¿å®¹é‡</th>
                                    <th class="p-2 text-center text-slate-300">ä¿å­˜æœŸ(æœˆ)</th>
                                    <th class="p-2 text-left text-slate-300">é¡åˆ¥</th>
                                    <th class="p-2 text-left text-slate-300">å‚™è¨»</th>
                                </tr>
                            </thead>
                            <tbody id="pm-import-preview-body">
                            </tbody>
                        </table>
                    </div>

                    <!-- åŒ¯å…¥é¸é … -->
                    <div class="mt-3 p-3 bg-slate-800/50 rounded-lg border border-slate-700">
                        <div class="flex items-center gap-4">
                            <label class="flex items-center gap-2 text-sm text-white cursor-pointer">
                                <input type="checkbox" id="pm-import-update-existing" checked class="rounded">
                                <span>æ›´æ–°å·²å­˜åœ¨çš„å“é …</span>
                            </label>
                            <label class="flex items-center gap-2 text-sm text-white cursor-pointer">
                                <input type="checkbox" id="pm-import-skip-errors" checked class="rounded">
                                <span>è·³ééŒ¯èª¤é …ç›®ç¹¼çºŒåŒ¯å…¥</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Step 3: åŒ¯å…¥çµæœ -->
                <div id="pm-import-step3" class="hidden">
                    <div class="flex items-center gap-2 mb-3">
                        <span class="bg-emerald-600 text-white text-xs px-2 py-0.5 rounded font-bold">3</span>
                        <span class="text-white font-bold">åŒ¯å…¥çµæœ</span>
                    </div>
                    <div id="pm-import-result" class="p-4 bg-slate-800 rounded-lg border border-slate-700">
                        <!-- çµæœæœƒå‹•æ…‹å¡«å…… -->
                    </div>
                </div>
            </div>

            <div class="p-4 border-t border-slate-700 flex justify-end gap-3">
                <button onclick="closeProductMasterImport()" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg">
                    å–æ¶ˆ
                </button>
                <button id="pm-import-btn" onclick="executeProductMasterImport()" disabled
                        class="px-6 py-2 bg-emerald-600 hover:bg-emerald-500 disabled:bg-slate-600 disabled:cursor-not-allowed text-white rounded-lg font-bold">
                    <i class="fa-solid fa-upload mr-1"></i>ç¢ºèªåŒ¯å…¥
                </button>
            </div>
        </div>
    </div>

            <div id="modal-warehouse-manager" class="fixed inset-0 z-50 bg-black/80 hidden flex items-center justify-center backdrop-blur-sm">
                <div class="bg-slate-900 border border-slate-700 rounded-2xl w-[700px] max-h-[80vh] shadow-2xl flex flex-col">
                    <div class="bg-gradient-to-r from-slate-800 to-slate-700 p-4 rounded-t-2xl border-b border-slate-600 flex justify-between items-center">
                        <h3 class="text-white font-bold text-lg"><i class="fa-solid fa-warehouse mr-2"></i>å€‰åº«ç®¡ç†</h3>
                        <button onclick="closeWarehouseManager()" class="text-slate-400 hover:text-white text-xl">&times;</button>
                    </div>

                    <div class="p-4 flex-1 overflow-auto">
                        <!-- æ–°å¢æŒ‰éˆ• -->
                        <div class="flex gap-2 mb-4">
                            <button onclick="openAddWarehouseModal('external')" class="bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded-lg font-bold text-sm">
                                <i class="fa-solid fa-plus mr-1"></i>æ–°å¢å¤–å€‰
                            </button>
                            <button onclick="openAddWarehouseModal('virtual')" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg font-bold text-sm">
                                <i class="fa-solid fa-plus mr-1"></i>æ–°å¢è™›æ“¬å€‰
                            </button>
                        </div>

                        <!-- æœ¬å€‰è™›æ“¬å€‰ -->
                        <div class="mb-4">
                            <div class="text-slate-400 text-xs mb-2 font-bold">æœ¬å€‰ï¼ˆéœ€æŒ‡å®šå„²ä½ï¼‰</div>
                            <div class="bg-slate-800 rounded-lg p-3 space-y-2">
                                <div class="flex items-center justify-between py-2 px-3 bg-slate-700/50 rounded">
                                    <span class="text-white"><i class="fa-solid fa-warehouse mr-2 text-yellow-400"></i>ä¸€èˆ¬åº«å­˜</span>
                                    <span class="text-slate-500 text-xs">ç³»çµ±é è¨­</span>
                                </div>
                                <div class="flex items-center justify-between py-2 px-3 bg-slate-700/50 rounded">
                                    <span class="text-white"><i class="fa-solid fa-box mr-2 text-cyan-400"></i>å®¢æˆ¶å¯„å€‰</span>
                                    <span class="text-slate-500 text-xs">ç³»çµ±é è¨­</span>
                                </div>
                                <div class="flex items-center justify-between py-2 px-3 bg-slate-700/50 rounded">
                                    <span class="text-white"><i class="fa-solid fa-lock mr-2 text-purple-400"></i>æ¥­å‹™é ç•™</span>
                                    <span class="text-slate-500 text-xs">ç³»çµ±é è¨­</span>
                                </div>
                                <div id="virtual-warehouse-list"></div>
                            </div>
                        </div>

                        <!-- å´‡æ–‡å¤–å€‰ -->
                        <div class="mb-4">
                            <div class="text-slate-400 text-xs mb-2 font-bold">å´‡æ–‡ å¤–å€‰ï¼ˆå…å„²ä½ï¼‰</div>
                            <div class="bg-slate-800 rounded-lg p-3">
                                <div id="cw-warehouse-list" class="space-y-2"></div>
                            </div>
                        </div>

                        <!-- å…«æ–¹å¤–å€‰ -->
                        <div class="mb-4">
                            <div class="text-slate-400 text-xs mb-2 font-bold">å…«æ–¹ å¤–å€‰ï¼ˆå…å„²ä½ï¼‰</div>
                            <div class="bg-slate-800 rounded-lg p-3">
                                <div id="bf-warehouse-list" class="space-y-2"></div>
                            </div>
                        </div>
                    </div>

                    <div class="p-4 border-t border-slate-700">
                        <button onclick="closeWarehouseManager()" class="w-full py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg">é—œé–‰</button>
                    </div>
                </div>
            </div>

            <!-- æ–°å¢/ç·¨è¼¯å€‰åº« Modal -->
            <div id="modal-add-warehouse" class="fixed inset-0 z-[60] bg-black/80 hidden flex items-center justify-center backdrop-blur-sm">
                <div class="bg-slate-900 border border-slate-700 rounded-2xl w-[400px] shadow-2xl">
                    <div class="bg-gradient-to-r from-emerald-900 to-emerald-800 p-4 rounded-t-2xl border-b border-slate-700">
                        <h3 class="text-white font-bold text-lg" id="add-warehouse-title"><i class="fa-solid fa-plus mr-2"></i>æ–°å¢å€‰åº«</h3>
                    </div>
                    <div class="p-6 space-y-4">
                        <input type="hidden" id="edit-warehouse-id">
                        <input type="hidden" id="warehouse-type" value="external">

                        <div id="company-select-row">
                            <label class="text-slate-400 text-xs mb-1 block">æ‰€å±¬å…¬å¸ <span class="text-red-400">*</span></label>
                            <select id="warehouse-company" class="scan-input w-full">
                                <option value="å´‡æ–‡">å´‡æ–‡</option>
                                <option value="å…«æ–¹">å…«æ–¹</option>
                            </select>
                        </div>

                        <div>
                            <label class="text-slate-400 text-xs mb-1 block">å€‰åº«åç¨± <span class="text-red-400">*</span></label>
                            <input type="text" id="warehouse-name" class="scan-input w-full" placeholder="ä¾‹ï¼šæ™¯å±±3è™Ÿ" oninput="updateWarehousePreview()">
                        </div>

                        <div id="warehouse-preview" class="bg-slate-800 rounded-lg p-3">
                            <div class="text-slate-400 text-xs mb-1">é è¦½</div>
                            <div class="text-white font-bold" id="warehouse-preview-text">å´‡æ–‡_</div>
                        </div>
                    </div>
                    <div class="p-4 border-t border-slate-700 flex gap-3">
                        <button onclick="closeAddWarehouseModal()" class="flex-1 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg">å–æ¶ˆ</button>
                        <button onclick="saveWarehouse()" class="flex-1 py-2 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg font-bold">ç¢ºèª</button>
                    </div>
                </div>
            </div>

            <!-- å¤–å€‰å‡ºåº« Modal -->
            <div id="modal-ext-outbound" class="fixed inset-0 z-50 bg-black/80 hidden flex items-center justify-center backdrop-blur-sm">
                <div class="bg-slate-900 border border-slate-700 rounded-2xl w-[450px] shadow-2xl">
                    <div class="bg-gradient-to-r from-orange-900 to-orange-800 p-4 rounded-t-2xl border-b border-slate-700">
                        <h3 class="text-white font-bold text-lg"><i class="fa-solid fa-arrow-right-from-bracket mr-2"></i>å¤–å€‰å‡ºåº«</h3>
                    </div>
                    <div class="p-6 space-y-4">
                        <input type="hidden" id="ext-out-id">
                        <div class="bg-slate-800 rounded-lg p-3">
                            <div class="text-slate-400 text-xs mb-1">å“å</div>
                            <div class="text-white font-bold text-lg" id="ext-out-name">-</div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="bg-slate-800 rounded-lg p-3">
                                <div class="text-slate-400 text-xs mb-1">æ‰¹è™Ÿ</div>
                                <div class="text-white" id="ext-out-batch">-</div>
                            </div>
                            <div class="bg-slate-800 rounded-lg p-3">
                                <div class="text-slate-400 text-xs mb-1">ç›®å‰åº«å­˜</div>
                                <div class="text-yellow-400 font-bold text-xl" id="ext-out-stock">0</div>
                            </div>
                        </div>
                        <div>
                            <label class="text-slate-400 text-xs mb-1 block">å‡ºåº«æ•¸é‡ <span class="text-red-400">*</span></label>
                            <div class="flex gap-2">
                                <input type="number" id="ext-out-qty" class="scan-input flex-1 text-center text-2xl font-bold" placeholder="0">
                                <button onclick="document.getElementById('ext-out-qty').value = document.getElementById('ext-out-stock').innerText" class="px-4 py-2 bg-red-600 hover:bg-red-500 text-white rounded-lg font-bold">å…¨å‡º</button>
                            </div>
                        </div>
                        <div>
                            <label class="text-slate-400 text-xs mb-1 block">å‚™è¨»</label>
                            <input type="text" id="ext-out-note" class="scan-input w-full" placeholder="å‡ºè²¨/éŠ·å”®/å ±å»¢...">
                        </div>
                    </div>
                    <div class="p-4 border-t border-slate-700 flex gap-3">
                        <button onclick="closeExtOutboundModal()" class="flex-1 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg">å–æ¶ˆ</button>
                        <button onclick="confirmExtOutbound()" class="flex-1 py-2 bg-orange-600 hover:bg-orange-500 text-white rounded-lg font-bold">ç¢ºèªå‡ºåº«</button>
                    </div>
                </div>
            </div>

            <!-- èª¿æ’¥åˆ°æœ¬å€‰ Modal -->
            <div id="modal-transfer" class="fixed inset-0 z-50 bg-black/80 hidden flex items-center justify-center backdrop-blur-sm">
                <div class="bg-slate-900 border border-slate-700 rounded-2xl w-[500px] shadow-2xl">
                    <div class="bg-gradient-to-r from-emerald-900 to-emerald-800 p-4 rounded-t-2xl border-b border-slate-700">
                        <h3 class="text-white font-bold text-lg"><i class="fa-solid fa-truck-arrow-right mr-2"></i>èª¿æ’¥åˆ°æœ¬å€‰</h3>
                    </div>
                    <div class="p-6 space-y-4">
                        <input type="hidden" id="transfer-id">
                        <div class="bg-slate-800 rounded-lg p-3">
                            <div class="flex justify-between items-center">
                                <div>
                                    <div class="text-slate-400 text-xs mb-1">å“å</div>
                                    <div class="text-white font-bold text-lg" id="transfer-name">-</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-slate-400 text-xs mb-1">ä¾†æºå€‰åº«</div>
                                    <div class="text-cyan-400 font-bold" id="transfer-from">-</div>
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-3 gap-3">
                            <div class="bg-slate-800 rounded-lg p-3">
                                <div class="text-slate-400 text-xs mb-1">æ‰¹è™Ÿ</div>
                                <div class="text-white" id="transfer-batch">-</div>
                            </div>
                            <div class="bg-slate-800 rounded-lg p-3">
                                <div class="text-slate-400 text-xs mb-1">æ•ˆæœŸ</div>
                                <div class="text-white" id="transfer-exp">-</div>
                            </div>
                            <div class="bg-slate-800 rounded-lg p-3">
                                <div class="text-slate-400 text-xs mb-1">å¯èª¿æ•¸é‡</div>
                                <div class="text-yellow-400 font-bold text-xl" id="transfer-stock">0</div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-slate-400 text-xs mb-1 block">èª¿æ’¥æ•¸é‡ <span class="text-red-400">*</span></label>
                                <input type="number" id="transfer-qty" class="scan-input w-full text-center text-xl font-bold" placeholder="0">
                            </div>
                            <div>
                                <label class="text-slate-400 text-xs mb-1 block">ç›®æ¨™å„²ä½ <span class="text-red-400">*</span></label>
                                <input type="text" id="transfer-loc" class="scan-input w-full text-center text-xl font-bold" placeholder="A-01-01" style="text-transform:uppercase;">
                            </div>
                        </div>
                        <div class="bg-emerald-900/30 border border-emerald-600/50 rounded-lg p-3">
                            <div class="text-emerald-400 text-sm"><i class="fa-solid fa-info-circle mr-1"></i>èª¿æ’¥å¾Œå°‡è‡ªå‹•å»ºç«‹æœ¬å€‰æ£§æ¿åº«å­˜</div>
                        </div>
                    </div>
                    <div class="p-4 border-t border-slate-700 flex gap-3">
                        <button onclick="closeTransferModal()" class="flex-1 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg">å–æ¶ˆ</button>
                        <button onclick="confirmTransfer()" class="flex-1 py-2 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg font-bold">ç¢ºèªèª¿æ’¥</button>
                    </div>
                </div>
            </div>

            <!-- é ˜æ–™ç¢ºèª Modal -->
            <div id="modal-rm-confirm" class="fixed inset-0 z-50 bg-black/80 hidden flex items-center justify-center backdrop-blur-sm">
                <div class="bg-slate-900 border border-slate-700 rounded-2xl w-[600px] max-h-[90vh] overflow-hidden shadow-2xl flex flex-col">
                    <div class="bg-gradient-to-r from-cyan-900 to-cyan-800 p-4 rounded-t-2xl border-b border-slate-700">
                        <h3 class="text-white font-bold text-lg"><i class="fa-solid fa-clipboard-check mr-2"></i>ç¢ºèªé ˜æ–™å‡ºåº«</h3>
                        <p class="text-cyan-200 text-sm mt-1">è«‹ç¢ºèªæ¯ç­†çš„å¯¦éš›é ˜ç”¨æ•¸é‡</p>
                    </div>
                    <div class="p-4 flex-1 overflow-y-auto">
                        <!-- é ˜æ–™æ˜ç´°åˆ—è¡¨ -->
                        <div id="rm-confirm-list" class="space-y-3">
                            <!-- å‹•æ…‹ç”¢ç”Ÿ -->
                        </div>
                    </div>
                    <div class="p-4 border-t border-slate-700 bg-slate-800/50">
                        <div class="grid grid-cols-2 gap-3 mb-4">
                            <div>
                                <label class="text-slate-400 text-xs mb-1 block">é ˜ç”¨äºº <span class="text-red-400">*</span></label>
                                <input type="text" id="rm-confirm-user" class="scan-input w-full" placeholder="è¼¸å…¥é ˜ç”¨äººå§“å">
                            </div>
                            <div>
                                <label class="text-slate-400 text-xs mb-1 block">ç”¨é€”/ç”Ÿç”¢æ‰¹æ¬¡</label>
                                <input type="text" id="rm-confirm-purpose" class="scan-input w-full" placeholder="å¦‚ï¼šåŠ å·¥Aç·šã€ç”Ÿç”¢æ‰¹æ¬¡001">
                            </div>
                        </div>
                        <div class="flex justify-between items-center mb-4 p-3 bg-slate-900 rounded-lg">
                            <div class="text-slate-400">ç¸½è¨ˆé ˜ç”¨</div>
                            <div class="text-2xl font-bold text-yellow-400" id="rm-confirm-total">0 ä»¶</div>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="closeRmConfirmModal()" class="flex-1 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-lg">å–æ¶ˆ</button>
                            <button onclick="executeRmPicking()" class="flex-1 py-3 bg-green-600 hover:bg-green-500 text-white rounded-lg font-bold">
                                <i class="fa-solid fa-check mr-2"></i>ç¢ºèªå‡ºåº«
                            </button>
                        </div>
                    </div>
                </div>
            </div>

    <div id="print-area" class="hidden"></div>

    <!-- å¾…åŸ·è¡Œå…¥åº«å–®å½ˆçª— -->
    <div id="pending-inbound-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/70" onclick="closePendingInbounds()"></div>
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[900px] max-h-[80vh] bg-slate-900 rounded-lg border border-slate-700 shadow-2xl flex flex-col">
            <div class="p-4 border-b border-slate-700 flex justify-between items-center">
                <h3 class="text-white font-bold text-lg"><i class="fa-solid fa-clock text-yellow-400 mr-2"></i>å¾…åŸ·è¡Œå…¥åº«å–®</h3>
                <button onclick="closePendingInbounds()" class="text-slate-400 hover:text-white text-xl">&times;</button>
            </div>
            <div class="p-4 flex-1 overflow-auto">
                <div class="flex justify-between items-center mb-3">
                    <div class="text-sm text-slate-400">å †é«˜æ©Ÿæ‰‹å®Œæˆå¾Œï¼Œç°½åäº¤å›å†é»ã€Œç¢ºèªå…¥å¸³ã€</div>
                    <div class="flex gap-2">
                        <button onclick="printSelectedInbounds()" class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-1 rounded text-xs font-bold">
                            <i class="fa-solid fa-print mr-1"></i>åˆ—å°å‹¾é¸
                        </button>
                        <button onclick="confirmSelectedInbounds()" class="bg-emerald-600 hover:bg-emerald-500 text-white px-3 py-1 rounded text-xs font-bold">
                            <i class="fa-solid fa-check-double mr-1"></i>æ‰¹æ¬¡ç¢ºèªå…¥å¸³
                        </button>
                    </div>
                </div>
                <table class="w-full text-sm">
                    <thead class="bg-slate-800 sticky top-0">
                        <tr class="text-slate-400 text-xs">
                            <th class="p-2 text-left"><input type="checkbox" id="select-all-inbound" onchange="toggleSelectAllInbound()"></th>
                            <th class="p-2 text-left">å–®è™Ÿ</th>
                            <th class="p-2 text-left">é¡å‹</th>
                            <th class="p-2 text-left">å„²ä½</th>
                            <th class="p-2 text-left">å“å/è¦æ ¼</th>
                            <th class="p-2 text-left">æ‰¹è™Ÿ</th>
                            <th class="p-2 text-left">æ•ˆæœŸ</th>
                            <th class="p-2 text-right">æ•¸é‡</th>
                            <th class="p-2 text-left">å»ºå–®æ™‚é–“</th>
                            <th class="p-2 text-center">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="pending-inbound-list">
                        <tr><td colspan="10" class="text-center text-slate-500 py-10">è¼‰å…¥ä¸­...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- é§å›åŸå› å½ˆçª— -->
    <div id="reject-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/70" onclick="closeRejectModal()"></div>
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[400px] bg-slate-900 rounded-lg border border-slate-700 shadow-2xl">
            <div class="p-4 border-b border-slate-700 flex justify-between items-center">
                <h3 class="text-white font-bold"><i class="fa-solid fa-times-circle text-red-400 mr-2"></i>é§å›å…¥åº«å–®</h3>
                <button onclick="closeRejectModal()" class="text-slate-400 hover:text-white text-xl">&times;</button>
            </div>
            <div class="p-4">
                <input type="hidden" id="reject-order-id">
                <div class="mb-4">
                    <label class="text-sm text-slate-400 block mb-2">é§å›åŸå›  <span class="text-red-400">*</span></label>
                    <textarea id="reject-reason" class="scan-input w-full h-24 p-2" placeholder="è«‹è¼¸å…¥é§å›åŸå› ï¼Œå€‰ç®¡å°‡ä¾æ­¤ä¿®æ”¹å¾Œé‡æ–°é€å¯©"></textarea>
                </div>
                <div class="flex gap-2">
                    <button onclick="closeRejectModal()" class="flex-1 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded">å–æ¶ˆ</button>
                    <button onclick="confirmReject()" class="flex-1 py-2 bg-red-600 hover:bg-red-500 text-white rounded font-bold">ç¢ºèªé§å›</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¿®æ”¹å…¥åº«å–®å½ˆçª—ï¼ˆé§å›å¾Œå€‰ç®¡ä¿®æ”¹ç”¨ï¼‰ -->
    <div id="edit-inbound-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/70" onclick="closeEditInboundModal()"></div>
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[500px] bg-slate-900 rounded-lg border border-slate-700 shadow-2xl">
            <div class="p-4 border-b border-slate-700 flex justify-between items-center">
                <h3 class="text-white font-bold"><i class="fa-solid fa-edit text-blue-400 mr-2"></i>ä¿®æ”¹å…¥åº«å–®</h3>
                <button onclick="closeEditInboundModal()" class="text-slate-400 hover:text-white text-xl">&times;</button>
            </div>
            <div class="p-4">
                <input type="hidden" id="edit-order-id">

                <!-- é§å›åŸå› é¡¯ç¤º -->
                <div id="edit-reject-reason-box" class="mb-4 p-3 bg-red-900/30 border border-red-500/50 rounded">
                    <div class="text-red-400 text-sm font-bold mb-1"><i class="fa-solid fa-exclamation-triangle mr-1"></i>é§å›åŸå› </div>
                    <div id="edit-reject-reason" class="text-white text-sm"></div>
                </div>

                <div class="space-y-3">
                    <div>
                        <label class="text-xs text-slate-400">å“å</label>
                        <input type="text" id="edit-name" class="scan-input w-full">
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="text-xs text-slate-400">è¦æ ¼</label>
                            <input type="text" id="edit-spec" class="scan-input w-full">
                        </div>
                        <div>
                            <label class="text-xs text-slate-400">æ•¸é‡</label>
                            <input type="number" id="edit-qty" class="scan-input w-full">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="text-xs text-slate-400">æ‰¹è™Ÿ</label>
                            <input type="text" id="edit-batch" class="scan-input w-full">
                        </div>
                        <div>
                            <label class="text-xs text-slate-400">æ•ˆæœŸ</label>
                            <input type="date" id="edit-exp" class="scan-input w-full">
                        </div>
                    </div>
                    <div>
                        <label class="text-xs text-slate-400">å„²ä½</label>
                        <input type="text" id="edit-loc" class="scan-input w-full">
                    </div>
                    <div>
                        <label class="text-xs text-slate-400">å» å•†</label>
                        <input type="text" id="edit-vendor" class="scan-input w-full">
                    </div>
                </div>

                <div class="flex gap-2 mt-4">
                    <button onclick="closeEditInboundModal()" class="flex-1 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded">å–æ¶ˆ</button>
                    <button onclick="submitEditAndReapprove()" class="flex-1 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded font-bold">ä¿®æ”¹ä¸¦é‡æ–°é€å¯©</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        window.loginSystem = function() { console.log("Loading..."); };
        window.logoutSystem = function() { console.log("Loading..."); };
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, getDoc, setDoc, doc, query, where, orderBy, limit, onSnapshot, writeBatch, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail, createUserWithEmailAndPassword, fetchSignInMethodsForEmail } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = { apiKey: "AIzaSyBEWzyRMJQirGbh28ANkE6aN42GzUBuw2s", authDomain: "terrywms-2345f.firebaseapp.com", projectId: "terrywms-2345f", storageBucket: "terrywms-2345f.firebasestorage.app", messagingSenderId: "75589714942", appId: "1:75589714942:web:3a7f723c3d1449df78f6af" };
        const app = initializeApp(firebaseConfig); const db = getFirestore(app); const auth = getAuth(app);

        const secondaryApp = initializeApp(firebaseConfig, "SecondaryApp");
        const secondaryAuth = getAuth(secondaryApp);
        window.secondaryAuth = secondaryAuth;

        window.sendPasswordResetEmail = sendPasswordResetEmail;
        window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
        window.fetchSignInMethodsForEmail = fetchSignInMethodsForEmail;
        window.auth = auth;
        window.db = db; window.collection = collection; window.addDoc = addDoc; window.getDoc = getDoc; window.setDoc = setDoc; window.doc = doc; window.updateDoc = updateDoc; window.deleteDoc = deleteDoc; window.writeBatch = writeBatch; window.getDocs = getDocs; window.query = query; window.where = where; window.orderBy = orderBy; window.limit = limit; window.onSnapshot = onSnapshot; window.serverTimestamp = serverTimestamp;

        // ========== å„²ä½æ ¼å¼å·¥å…·å‡½æ•¸ï¼ˆå¿…é ˆæœ€å…ˆå®šç¾©ï¼‰==========
        window.formatLocationId = function(zone, row, level) {
            var rowStr = row < 10 ? '0' + row : '' + row;
            return zone + '-' + rowStr + '-' + level;
        };

        window.parseLocationId = function(locId) {
            if (!locId || locId.startsWith('V-') || locId.startsWith('O-')) return null;
            var parts = locId.split('-');
            if (parts.length < 3) return null;

            var warehouse = parts[0];  // I, J, K
            var zoneChar = parts[1];   // A, B, C, D, E, F, G, H
            var rowStr = parts[2];     // 01, 08, 15
            var level = parts[3] || ''; // 3F, 2F, 1F

            var row = parseInt(rowStr) || 0;

            return {
                warehouse: warehouse,
                zoneChar: zoneChar,
                row: row,
                level: level,
                zone: warehouse + '-' + zoneChar,
                laneKey: warehouse + '-' + zoneChar + '-' + (row < 10 ? '0' + row : row)
            };
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('view-login').classList.add('hidden');
                if (window.setCurrentUser) window.setCurrentUser(user.email);
                initAllListeners();
            } else {
                document.getElementById('view-login').classList.remove('hidden');
                window.currentUser = null;
            }
        });
        window.loginSystem = async () => {
            var errorEl = document.getElementById('login-error');
            errorEl.classList.add('hidden');

            try {
                await signInWithEmailAndPassword(auth, document.getElementById('login-email').value, document.getElementById('login-pwd').value);
            } catch (err) {
                var msg = 'ç™»å…¥å¤±æ•—';
                if (err.code === 'auth/user-not-found') msg = 'å¸³è™Ÿä¸å­˜åœ¨';
                else if (err.code === 'auth/wrong-password') msg = 'å¯†ç¢¼éŒ¯èª¤';
                else if (err.code === 'auth/invalid-email') msg = 'Email æ ¼å¼éŒ¯èª¤';
                else if (err.code === 'auth/too-many-requests') msg = 'å˜—è©¦æ¬¡æ•¸éå¤šï¼Œè«‹ç¨å¾Œå†è©¦';

                errorEl.innerText = msg;
                errorEl.classList.remove('hidden');
            }
        }
        window.logoutSystem = () => { signOut(auth); location.reload(); }

        let currentInventory = []; let currentOrders = [];
        function initAllListeners() {
            onSnapshot(collection(db, "pallets"), (snapshot) => {
                currentInventory = [];
                const tbody = document.getElementById('inventory-list-body');
                if(tbody) tbody.innerHTML = '';
                let stats = { total:0, fg:0, ret:0, virt:0, chart:{raw:0, fg:0, wip:0} };

                snapshot.forEach(d => {
                    const data = d.data();
                    if(data.quantity > 0 || data.totalWeight > 0) {
                        currentInventory.push({ id: d.id, ...data });
                        stats.total++;
                        if(data.category === 'FG') { stats.fg++; stats.chart.fg++; } else if(data.category === 'WIP') { stats.chart.wip++; } else { stats.chart.raw++; }
                        if(data.source === 'Factory_Return') stats.ret++;
                        if(data.locationId && data.locationId.startsWith('V-')) stats.virt++;
                        let badge = '<span class="badge badge-green">åŸæ–™</span>';
                        if(data.category === 'FG') badge = '<span class="badge badge-purple">æˆå“</span>';
                        if(data.category === 'WIP') badge = '<span class="badge badge-yellow">åŠæˆå“</span>';
                        if(data.source === 'Factory_Return') badge = '<span class="badge badge-orange">é¤˜æ–™</span>';
                        if(tbody) {
                            var weightDisplay = '-';
                            if (data.productType === 'variable' && data.totalWeight > 0) {
                                weightDisplay = '<span class="text-amber-400">' + data.totalWeight + ' kg</span>';
                            } else if (data.unitWeight > 0) {
                                weightDisplay = '<span class="text-slate-400">@' + data.unitWeight + ' kg</span>';
                            } else if (data.totalWeight > 0) {
                                weightDisplay = '<span class="text-amber-400">' + data.totalWeight + ' kg</span>';
                            }

                            var expDisplay = '-';
                            var expClass = 'text-slate-400';
                            if (data.expiryDate) {
                                var expDate = data.expiryDate.toDate ? data.expiryDate.toDate() : new Date(data.expiryDate);
                                var today = new Date();
                                var diffDays = Math.ceil((expDate - today) / (1000 * 60 * 60 * 24));
                                expDisplay = expDate.toLocaleDateString('zh-TW');
                                if (diffDays < 0) {
                                    expClass = 'text-red-500 font-bold';
                                } else if (diffDays < 30) {
                                    expClass = 'text-red-400';
                                } else if (diffDays < 90) {
                                    expClass = 'text-yellow-400';
                                }
                            }

                            tbody.innerHTML += `<tr class="border-b border-slate-700 hover:bg-slate-800" data-company="${data.company || ''}" data-type="internal"><td class="p-2"><span class="px-1.5 py-0.5 rounded text-xs ${data.company === 'å…«æ–¹' ? 'bg-purple-900/50 text-purple-300' : 'bg-blue-900/50 text-blue-300'}">${data.company || 'å´‡æ–‡'}</span></td><td class="text-white p-2">${data.productName}</td><td class="text-yellow-400 p-2">${data.spec||'-'}</td><td class="text-slate-400 font-mono p-2">${data.batchNo||'-'}</td><td class="text-right text-white p-2">${data.quantity||'-'}</td><td class="text-right p-2">${weightDisplay}</td><td class="p-2 text-cyan-400 font-mono">${data.locationId}</td><td class="p-2 ${expClass}">${expDisplay}</td><td class="p-2 text-right"><button onclick="editPallet('${d.id}')" class="text-blue-400 hover:text-blue-300 mr-2" title="ç·¨è¼¯"><i class="fa-solid fa-edit"></i></button><button onclick="deletePallet('${d.id}')" class="text-red-500 hover:bg-red-500/20 rounded px-2" title="åˆªé™¤"><i class="fa-solid fa-trash"></i></button></td></tr>`;
                        }
                    }
                });
                if(document.getElementById('kpi-total-pallets')) {
                    document.getElementById('kpi-total-pallets').innerText = stats.total;
                    var fgEl = document.getElementById('kpi-fg-count');
                    var retEl = document.getElementById('kpi-return-count');
                    if (fgEl) fgEl.innerText = stats.fg;
                    if (retEl) retEl.innerText = stats.ret;
                    updateChart(stats.chart);
                }
                updateDashboardStats(currentInventory);

                renderAllMaps();

                if (typeof loadVirtualLocationCounts === 'function') {
                    loadVirtualLocationCounts();
                }

                if (!window._expiryAlertChecked) {
                    window._expiryAlertChecked = true;
                    setTimeout(function() { if (window.checkExpiryAlert) window.checkExpiryAlert(); }, 1500);
                }
            });
            onSnapshot(collection(db, "shippingOrders"), (snapshot) => { currentOrders = []; snapshot.forEach(d => currentOrders.push(d.data())); renderShippingListWithPicking(); });

            if (window.updateApprovalCount) updateApprovalCount();
            if (window.updatePendingInboundCount) updatePendingInboundCount();
        }
        let myChart = null;
        let companyChart = null;
        let expiryChart = null;

        function updateChart(data) {
            const ctx = document.getElementById('stockChart'); if(!ctx) return;
            const chartConfig = {
                type: 'doughnut',
                data: {
                    labels: ['åŸæ–™', 'æˆå“', 'åŠæˆå“'],
                    datasets: [{
                        data: [data.raw, data.fg, data.wip],
                        backgroundColor: ['#10b981', '#a855f7', '#facc15'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { position: 'bottom', labels: { color: 'white', boxWidth: 12, padding: 8, font: { size: 11 } } }
                    }
                }
            };

            if(myChart) {
                myChart.data.datasets[0].data = [data.raw, data.fg, data.wip];
                myChart.update();
            } else {
                myChart = new Chart(ctx, chartConfig);
            }
        }

        function updateDashboardStats(inventory) {
            console.log('ğŸ” updateDashboardStats è¢«å‘¼å«ï¼Œinventory é•·åº¦:', inventory ? inventory.length : 0);

            if (!inventory) inventory = [];

            if (inventory.length > 0) {
                console.log('ğŸ“¦ ç¬¬ä¸€ç­†è³‡æ–™çµæ§‹:', JSON.stringify(inventory[0], null, 2));
            }

            let cwCount = 0, bfCount = 0, virtualCount = 0;
            let expiryAlerts = [];
            const zoneStats = {};
            const VIRTUAL_LOCS = ['TEMP-IN', 'TEMP-OUT', 'A00', 'A99', 'B00', 'B99', 'C00', 'C99', 'D00', 'D99', 'OTHER'];
            const zoneCapacity = { 'I-A': 638, 'I-B': 638, 'J-C': 638, 'J-D': 638, 'K-E': 638, 'K-F': 638, 'K-G': 638, 'K-H': 638 };

            const today = new Date();
            const thirtyDays = new Date(today.getTime() + 30 * 24 * 60 * 60 * 1000);

            inventory.forEach(item => {
                const company = item.company || item.owner || item.customer || '';
                if (company.includes('å´‡æ–‡') || company === 'CW' || company === 'cw') cwCount++;
                else if (company.includes('å…«æ–¹') || company === 'BF' || company === 'bf') bfCount++;
                else {
                    bfCount++; // é è¨­æ­¸é¡
                }

                const locId = item.locationId || '';
                const locUpper = locId.toUpperCase();
                if (VIRTUAL_LOCS.includes(locUpper) || VIRTUAL_LOCS.includes(locId)) {
                    virtualCount++;
                }

                if (locId && !VIRTUAL_LOCS.includes(locUpper)) {
                    const parsed = window.parseLocationId ? window.parseLocationId(locId) : null;
                    if (parsed && parsed.zone) {
                        if (!zoneStats[parsed.zone]) zoneStats[parsed.zone] = 0;
                        zoneStats[parsed.zone]++;
                    }
                }

                if (item.expiryDate) {
                    let expDate;
                    try {
                        expDate = item.expiryDate.toDate ? item.expiryDate.toDate() : new Date(item.expiryDate);
                        if (!isNaN(expDate.getTime()) && expDate <= thirtyDays) {
                            expiryAlerts.push({
                                productName: item.productName,
                                locationId: item.locationId,
                                quantity: item.quantity,
                                expiryDate: expDate,
                                isExpired: expDate < today
                            });
                        }
                    } catch(e) { /* å¿½ç•¥ç„¡æ•ˆæ—¥æœŸ */ }
                }
            });

            const cwEl = document.getElementById('kpi-cw-count');
            const bfEl = document.getElementById('kpi-bf-count');
            const virtualEl = document.getElementById('kpi-virtual-count');
            const expiryEl = document.getElementById('kpi-expiry-alert');

            console.log('ğŸ“Š KPI å…ƒç´ :', { cwEl: !!cwEl, bfEl: !!bfEl, virtualEl: !!virtualEl, expiryEl: !!expiryEl });

            if (cwEl) cwEl.textContent = cwCount;
            if (bfEl) bfEl.textContent = bfCount;
            if (virtualEl) virtualEl.textContent = virtualCount;
            if (expiryEl) expiryEl.textContent = expiryAlerts.length;

            console.log('ğŸ“Š æˆ°æƒ…åˆ†ææ›´æ–°:', { ç¸½åº«å­˜: inventory.length, å´‡æ–‡: cwCount, å…«æ–¹: bfCount, æš«å­˜å€: virtualCount, æ•ˆæœŸè­¦ç¤º: expiryAlerts.length, å€åŸŸçµ±è¨ˆ: zoneStats });

            updateCompanyChart(cwCount, bfCount);

            const expired = expiryAlerts.filter(e => e.isExpired).length;
            const nearExpiry = expiryAlerts.filter(e => !e.isExpired).length;
            const normal = inventory.length - expired - nearExpiry;
            updateExpiryChart(expired, nearExpiry, normal);

            updateZoneStatsTable(zoneStats, zoneCapacity);

            updateExpiryAlertTable(expiryAlerts);
        }

        function updateCompanyChart(cw, bf) {
            const ctx = document.getElementById('companyChart'); if(!ctx) return;
            const chartConfig = {
                type: 'doughnut',
                data: {
                    labels: ['å´‡æ–‡', 'å…«æ–¹'],
                    datasets: [{
                        data: [cw, bf],
                        backgroundColor: ['#10b981', '#06b6d4'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { position: 'bottom', labels: { color: 'white', boxWidth: 12, padding: 8, font: { size: 11 } } }
                    }
                }
            };

            if (companyChart) {
                companyChart.data.datasets[0].data = [cw, bf];
                companyChart.update();
            } else {
                companyChart = new Chart(ctx, chartConfig);
            }
        }

        function updateExpiryChart(expired, nearExpiry, normal) {
            const ctx = document.getElementById('expiryChart'); if(!ctx) return;
            const chartConfig = {
                type: 'doughnut',
                data: {
                    labels: ['å·²éæœŸ', '30å¤©å…§', 'æ­£å¸¸'],
                    datasets: [{
                        data: [expired, nearExpiry, normal],
                        backgroundColor: ['#ef4444', '#f97316', '#22c55e'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { position: 'bottom', labels: { color: 'white', boxWidth: 12, padding: 8, font: { size: 11 } } }
                    }
                }
            };

            if (expiryChart) {
                expiryChart.data.datasets[0].data = [expired, nearExpiry, normal];
                expiryChart.update();
            } else {
                expiryChart = new Chart(ctx, chartConfig);
            }
        }

        function updateZoneStatsTable(zoneStats, zoneCapacity) {
            const tbody = document.getElementById('zone-stats-body');
            if (!tbody) return;

            const zones = ['I-A', 'I-B', 'J-C', 'J-D', 'K-E', 'K-F', 'K-G', 'K-H'];
            let html = '';

            zones.forEach(zone => {
                const count = zoneStats[zone] || 0;
                const capacity = zoneCapacity[zone] || 638;
                const percent = Math.round((count / capacity) * 100);
                const colorClass = percent >= 90 ? 'text-red-400' : percent >= 70 ? 'text-yellow-400' : 'text-emerald-400';

                html += '<tr class="border-b border-slate-700/50 hover:bg-slate-800/50">';
                html += '<td class="p-2 font-bold text-white">' + zone + '</td>';
                html += '<td class="p-2 text-right text-white">' + count + '</td>';
                html += '<td class="p-2 text-right ' + colorClass + '">' + percent + '%</td>';
                html += '</tr>';
            });

            tbody.innerHTML = html || '<tr><td colspan="3" class="text-center text-slate-500 py-4">ç„¡è³‡æ–™</td></tr>';
        }

        function updateExpiryAlertTable(alerts) {
            const tbody = document.getElementById('expiry-alert-body');
            if (!tbody) return;

            alerts.sort((a, b) => a.expiryDate - b.expiryDate);

            let html = '';
            alerts.slice(0, 10).forEach(item => {
                const dateStr = item.expiryDate.toLocaleDateString('zh-TW');
                const colorClass = item.isExpired ? 'text-red-400' : 'text-orange-400';
                const badge = item.isExpired ? '<span class="text-[10px] bg-red-600 px-1 rounded">éæœŸ</span>' : '';

                html += '<tr class="border-b border-slate-700/50 hover:bg-slate-800/50">';
                html += '<td class="p-2 text-white">' + (item.productName || '-') + '</td>';
                html += '<td class="p-2 text-slate-400 font-mono text-xs">' + (item.locationId || '-') + '</td>';
                html += '<td class="p-2 text-right text-white">' + (item.quantity || 0) + '</td>';
                html += '<td class="p-2 ' + colorClass + '">' + dateStr + ' ' + badge + '</td>';
                html += '</tr>';
            });

            if (alerts.length > 10) {
                html += '<tr><td colspan="4" class="text-center text-slate-500 py-2 text-xs">é‚„æœ‰ ' + (alerts.length - 10) + ' ç­†...</td></tr>';
            }

            tbody.innerHTML = html || '<tr><td colspan="4" class="text-center text-emerald-400 py-4"><i class="fa-solid fa-check-circle mr-1"></i>ç›®å‰æ²’æœ‰æ•ˆæœŸè­¦ç¤º</td></tr>';
        }

        window.currentInventory = () => currentInventory; window.currentOrders = () => currentOrders; window.currentPallets = () => currentInventory;
        Object.defineProperty(window, 'inventory', {
            get: function() { return currentInventory; }
        });
        window.fetchInventory = function() {
            return new Promise(function(resolve) {
                setTimeout(resolve, 100);
            });
        };
    </script>

    <script>
        // ========== é€šç”¨å·¥å…·å‡½æ•¸åº« ==========

window.WMS = window.WMS || {};

WMS.createModal = function(id, options) {
    var opts = options || {};
    var modal = document.createElement('div');
    modal.id = id;
    modal.className = 'fixed inset-0 bg-black/80 flex items-center justify-center z-50';

    var width = opts.width || '500px';
    var maxHeight = opts.maxHeight || '80vh';

    var html = '<div class="bg-slate-800 rounded-xl p-6 w-[' + width + '] max-h-[' + maxHeight + '] overflow-y-auto border border-slate-600">';

    if (opts.title) {
        html += '<div class="flex justify-between items-center mb-4">';
        html += '<h3 class="text-white font-bold text-lg">';
        if (opts.icon) html += '<i class="' + opts.icon + ' mr-2"></i>';
        html += opts.title + '</h3>';
        html += '<button onclick="WMS.closeModal(\'' + id + '\')" class="text-slate-400 hover:text-white">';
        html += '<i class="fa-solid fa-xmark text-xl"></i></button>';
        html += '</div>';
    }

    html += '<div id="' + id + '-content">' + (opts.content || '') + '</div>';
    html += '</div>';

    modal.innerHTML = html;
    document.body.appendChild(modal);

    if (opts.closeOnBackdrop !== false) {
        modal.addEventListener('click', function(e) {
            if (e.target === modal) WMS.closeModal(id);
        });
    }

    return modal;
};

WMS.closeModal = function(id) {
    var modal = document.getElementById(id);
    if (modal) modal.remove();
};

WMS.updateModalContent = function(id, content) {
    var contentEl = document.getElementById(id + '-content');
    if (contentEl) contentEl.innerHTML = content;
};

WMS.formatDate = function(date, format) {
    if (!date) return '-';

    var d = date;
    if (typeof date === 'string') d = new Date(date);
    if (date.toDate) d = date.toDate(); // Firestore Timestamp

    if (isNaN(d.getTime())) return '-';

    format = format || 'YYYY/MM/DD';

    var year = d.getFullYear();
    var month = String(d.getMonth() + 1).padStart(2, '0');
    var day = String(d.getDate()).padStart(2, '0');
    var hours = String(d.getHours()).padStart(2, '0');
    var minutes = String(d.getMinutes()).padStart(2, '0');
    var seconds = String(d.getSeconds()).padStart(2, '0');

    return format
        .replace('YYYY', year)
        .replace('MM', month)
        .replace('DD', day)
        .replace('HH', hours)
        .replace('mm', minutes)
        .replace('ss', seconds);
};

WMS.timeAgo = function(date) {
    if (!date) return '-';

    var d = date;
    if (typeof date === 'string') d = new Date(date);
    if (date.toDate) d = date.toDate();

    var now = new Date();
    var diff = Math.floor((now - d) / 1000); // ç§’æ•¸

    if (diff < 60) return 'å‰›å‰›';
    if (diff < 3600) return Math.floor(diff / 60) + ' åˆ†é˜å‰';
    if (diff < 86400) return Math.floor(diff / 3600) + ' å°æ™‚å‰';
    if (diff < 604800) return Math.floor(diff / 86400) + ' å¤©å‰';

    return WMS.formatDate(d);
};

WMS.formatNumber = function(num, decimals) {
    if (num === null || num === undefined) return '-';
    decimals = decimals || 0;
    return Number(num).toLocaleString('zh-TW', { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
};

WMS.statusBadge = function(status, type) {
    var configs = {
        'pending': { bg: 'bg-yellow-500/20', text: 'text-yellow-400', label: 'å¾…è™•ç†' },
        'processing': { bg: 'bg-blue-500/20', text: 'text-blue-400', label: 'è™•ç†ä¸­' },
        'completed': { bg: 'bg-emerald-500/20', text: 'text-emerald-400', label: 'å·²å®Œæˆ' },
        'cancelled': { bg: 'bg-slate-500/20', text: 'text-slate-400', label: 'å·²å–æ¶ˆ' },
        'picking': { bg: 'bg-purple-500/20', text: 'text-purple-400', label: 'æ€è²¨ä¸­' },
        'sorted': { bg: 'bg-cyan-500/20', text: 'text-cyan-400', label: 'å·²åˆ†è²¨' },
        'shipped': { bg: 'bg-emerald-500/20', text: 'text-emerald-400', label: 'å·²å‡ºè²¨' },
        'Active': { bg: 'bg-emerald-500/20', text: 'text-emerald-400', label: 'æ­£å¸¸' },
        'Reserved': { bg: 'bg-yellow-500/20', text: 'text-yellow-400', label: 'ä¿ç•™' },
        'Depleted': { bg: 'bg-slate-500/20', text: 'text-slate-400', label: 'å·²ç”¨å®Œ' }
    };

    var config = configs[status] || { bg: 'bg-slate-500/20', text: 'text-slate-400', label: status || '-' };

    return '<span class="px-2 py-1 rounded text-xs ' + config.bg + ' ' + config.text + '">' + config.label + '</span>';
};

WMS.toast = function(message, type, duration) {
    type = type || 'info';
    duration = duration || 3000;

    var colors = {
        'success': 'bg-emerald-600',
        'error': 'bg-red-600',
        'warning': 'bg-yellow-600',
        'info': 'bg-blue-600'
    };

    var icons = {
        'success': 'fa-check-circle',
        'error': 'fa-xmark-circle',
        'warning': 'fa-triangle-exclamation',
        'info': 'fa-info-circle'
    };

    var toast = document.createElement('div');
    toast.className = 'fixed top-4 right-4 ' + colors[type] + ' text-white px-4 py-3 rounded-lg shadow-lg z-[9999] flex items-center gap-2 animate-fade-in';
    toast.innerHTML = '<i class="fa-solid ' + icons[type] + '"></i><span>' + message + '</span>';

    document.body.appendChild(toast);

    setTimeout(function() {
        toast.style.opacity = '0';
        toast.style.transition = 'opacity 0.3s';
        setTimeout(function() { toast.remove(); }, 300);
    }, duration);
};

WMS.confirm = function(message, options) {
    return new Promise(function(resolve) {
        var opts = options || {};
        var id = 'wms-confirm-' + Date.now();

        var content = '<div class="text-center">';
        content += '<div class="text-5xl mb-4">' + (opts.icon || 'âš ï¸') + '</div>';
        content += '<div class="text-white text-lg mb-2">' + message + '</div>';
        if (opts.description) {
            content += '<div class="text-slate-400 text-sm mb-4">' + opts.description + '</div>';
        }
        content += '<div class="flex gap-3 justify-center mt-6">';
        content += '<button id="' + id + '-cancel" class="px-6 py-2 bg-slate-600 hover:bg-slate-500 text-white rounded-lg">' + (opts.cancelText || 'å–æ¶ˆ') + '</button>';
        content += '<button id="' + id + '-confirm" class="px-6 py-2 ' + (opts.danger ? 'bg-red-600 hover:bg-red-500' : 'bg-blue-600 hover:bg-blue-500') + ' text-white rounded-lg font-bold">' + (opts.confirmText || 'ç¢ºå®š') + '</button>';
        content += '</div></div>';

        WMS.createModal(id, { content: content, width: '400px' });

        document.getElementById(id + '-confirm').onclick = function() {
            WMS.closeModal(id);
            resolve(true);
        };
        document.getElementById(id + '-cancel').onclick = function() {
            WMS.closeModal(id);
            resolve(false);
        };
    });
};

WMS.showLoading = function(message) {
    var id = 'wms-loading';
    if (document.getElementById(id)) return;

    var modal = document.createElement('div');
    modal.id = id;
    modal.className = 'fixed inset-0 bg-black/60 flex items-center justify-center z-[9999]';
    modal.innerHTML = '<div class="bg-slate-800 rounded-xl p-8 text-center">' +
        '<i class="fa-solid fa-spinner fa-spin text-4xl text-blue-400 mb-4"></i>' +
        '<div class="text-white">' + (message || 'è™•ç†ä¸­...') + '</div></div>';
    document.body.appendChild(modal);
};

WMS.hideLoading = function() {
    var modal = document.getElementById('wms-loading');
    if (modal) modal.remove();
};

WMS.sortTable = function(data, key, direction) {
    direction = direction || 'asc';
    return data.slice().sort(function(a, b) {
        var valA = a[key];
        var valB = b[key];

        if (valA === null || valA === undefined) return 1;
        if (valB === null || valB === undefined) return -1;

        if (typeof valA === 'string') valA = valA.toLowerCase();
        if (typeof valB === 'string') valB = valB.toLowerCase();

        if (valA < valB) return direction === 'asc' ? -1 : 1;
        if (valA > valB) return direction === 'asc' ? 1 : -1;
        return 0;
    });
};

WMS.debounce = function(func, wait) {
    var timeout;
    return function() {
        var context = this;
        var args = arguments;
        clearTimeout(timeout);
        timeout = setTimeout(function() {
            func.apply(context, args);
        }, wait);
    };
};

WMS.copyToClipboard = function(text) {
    if (navigator.clipboard) {
        navigator.clipboard.writeText(text).then(function() {
            WMS.toast('å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿', 'success');
        });
    } else {
        var textarea = document.createElement('textarea');
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        WMS.toast('å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿', 'success');
    }
};

WMS.formatLocation = function(locationId) {
    if (!locationId) return '-';
    return locationId;
};

WMS.parseBoxPerPackage = function(productName) {
    if (!productName) return 0;
    var match = productName.match(/(\d+)[ç›’ç®±åŒ…è¢‹å…¥]/);
    return match ? parseInt(match[1]) : 0;
};

console.log('âœ… WMS å·¥å…·å‡½æ•¸åº«å·²è¼‰å…¥');

        // ========== é€šç”¨é è¦½åˆ—å°ç³»çµ±ï¼ˆå„ªåŒ–ç‰ˆï¼‰==========
        function openPrintPreview(htmlContent, title, width, height, options) {
            width = width || 1000;
            height = height || 750;
            options = options || {};

            var previewHtml = '<!DOCTYPE html><html><head><meta charset="UTF-8">';
            previewHtml += '<title>åˆ—å°é è¦½ - ' + (title || 'æ–‡ä»¶') + '</title>';
            previewHtml += '<style>';
            previewHtml += '@media screen { body { margin: 0; padding: 0; background: #0f172a; font-family: "Microsoft JhengHei", sans-serif; } }';
            previewHtml += '.preview-toolbar { position: fixed; top: 0; left: 0; right: 0; background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); padding: 15px 24px; display: flex; align-items: center; justify-content: space-between; z-index: 9999; box-shadow: 0 4px 20px rgba(0,0,0,0.4); }';
            previewHtml += '.preview-toolbar h2 { color: white; margin: 0; font-size: 18px; display: flex; align-items: center; gap: 10px; }';
            previewHtml += '.preview-toolbar .btn-group { display: flex; gap: 12px; }';
            previewHtml += '.preview-toolbar button { padding: 12px 28px; font-size: 15px; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s; }';
            previewHtml += '.preview-toolbar .btn-print { background: #10b981; color: white; font-size: 16px; }';
            previewHtml += '.preview-toolbar .btn-print:hover { background: #059669; transform: scale(1.03); box-shadow: 0 4px 15px rgba(16,185,129,0.4); }';
            previewHtml += '.preview-toolbar .btn-copies { background: #f59e0b; color: white; }';
            previewHtml += '.preview-toolbar .btn-copies:hover { background: #d97706; }';
            previewHtml += '.preview-toolbar .btn-close { background: #475569; color: white; }';
            previewHtml += '.preview-toolbar .btn-close:hover { background: #334155; }';
            previewHtml += '.preview-toolbar input[type=number] { width: 60px; padding: 8px; border: 2px solid #3b82f6; border-radius: 6px; font-size: 16px; font-weight: bold; text-align: center; }';
            previewHtml += '.preview-container { margin-top: 70px; padding: 30px; display: flex; flex-direction: column; align-items: center; gap: 20px; min-height: calc(100vh - 70px); }';
            previewHtml += '.preview-paper { background: white; box-shadow: 0 10px 50px rgba(0,0,0,0.5); border-radius: 4px; }';
            previewHtml += '.preview-hint { color: #64748b; font-size: 13px; margin-top: 10px; }';
            previewHtml += '.zoom-controls { position: fixed; bottom: 20px; right: 20px; display: flex; gap: 8px; background: #1e293b; padding: 8px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }';
            previewHtml += '.zoom-controls button { width: 40px; height: 40px; border: none; background: #334155; color: white; border-radius: 6px; cursor: pointer; font-size: 18px; }';
            previewHtml += '.zoom-controls button:hover { background: #475569; }';
            previewHtml += '.zoom-controls span { color: #94a3b8; padding: 0 10px; line-height: 40px; font-size: 14px; }';
            previewHtml += '@media print { .preview-toolbar, .zoom-controls, .preview-hint { display: none !important; } .preview-container { margin: 0; padding: 0; } .preview-paper { box-shadow: none; border-radius: 0; } }';
            previewHtml += '</style></head><body>';

            previewHtml += '<div class="preview-toolbar">';
            previewHtml += '<h2>ğŸ“„ ' + (title || 'åˆ—å°é è¦½') + '</h2>';
            previewHtml += '<div class="btn-group">';
            if (options.showCopies !== false) {
                previewHtml += '<span style="color:white;font-size:14px;margin-right:-5px;">ä»½æ•¸:</span>';
                previewHtml += '<input type="number" id="print-copies" value="1" min="1" max="99">';
            }
            previewHtml += '<button class="btn-print" onclick="doPrint()">ğŸ–¨ï¸ ç¢ºèªåˆ—å°</button>';
            previewHtml += '<button class="btn-close" onclick="window.close()">âœ• é—œé–‰</button>';
            previewHtml += '</div></div>';

            previewHtml += '<div class="preview-container">';
            previewHtml += '<div class="preview-paper" id="preview-paper" style="transform-origin: top center;">';
            previewHtml += htmlContent;
            previewHtml += '</div>';
            previewHtml += '<div class="preview-hint">ğŸ’¡ æç¤ºï¼šå¯ä½¿ç”¨ä¸‹æ–¹æŒ‰éˆ•ç¸®æ”¾é è¦½ï¼Œåˆ—å°æ™‚æœƒè‡ªå‹•èª¿æ•´ç‚ºåŸå§‹å¤§å°</div>';
            previewHtml += '</div>';

            previewHtml += '<div class="zoom-controls">';
            previewHtml += '<button onclick="zoomOut()">ï¼</button>';
            previewHtml += '<span id="zoom-level">100%</span>';
            previewHtml += '<button onclick="zoomIn()">ï¼‹</button>';
            previewHtml += '<button onclick="zoomReset()">â†º</button>';
            previewHtml += '</div>';

            previewHtml += '<script>';
            previewHtml += 'var currentZoom = 100;';
            previewHtml += 'function updateZoom() { document.getElementById("preview-paper").style.transform = "scale(" + (currentZoom/100) + ")"; document.getElementById("zoom-level").innerText = currentZoom + "%"; }';
            previewHtml += 'function zoomIn() { if(currentZoom < 150) { currentZoom += 10; updateZoom(); } }';
            previewHtml += 'function zoomOut() { if(currentZoom > 50) { currentZoom -= 10; updateZoom(); } }';
            previewHtml += 'function zoomReset() { currentZoom = 100; updateZoom(); }';
            previewHtml += 'function doPrint() {';
            previewHtml += '  var copies = parseInt(document.getElementById("print-copies")?.value || 1);';
            previewHtml += '  currentZoom = 100; updateZoom();';  // åˆ—å°å‰é‡ç½®ç¸®æ”¾
            previewHtml += '  for(var i = 0; i < copies; i++) { window.print(); }';
            previewHtml += '}';
            previewHtml += 'document.addEventListener("keydown", function(e) {';
            previewHtml += '  if(e.ctrlKey && e.key === "p") { e.preventDefault(); doPrint(); }';  // Ctrl+P å¿«æ·éµ
            previewHtml += '  if(e.key === "Escape") { window.close(); }';  // ESC é—œé–‰
            previewHtml += '});';
            previewHtml += '<\/script>';

            previewHtml += '</body></html>';

            var win = window.open('', '_blank', 'width=' + width + ',height=' + height);
            if (win) {
                win.document.write(previewHtml);
                win.document.close();
            } else {
                alert('ç„¡æ³•é–‹å•Ÿåˆ—å°é è¦½è¦–çª—ï¼\n\nè«‹æª¢æŸ¥ï¼š\n1. ç€è¦½å™¨æ˜¯å¦é˜»æ“‹å½ˆå‡ºè¦–çª—\n2. è«‹å…è¨±æ­¤ç¶²ç«™çš„å½ˆå‡ºè¦–çª—');
            }
            return win;
        }

        function toggleNavGroup(groupId) {
            var group = document.getElementById(groupId);
            if (group) {
                group.classList.toggle('collapsed');
                var header = group.previousElementSibling;
                if (header) {
                    var chevron = header.querySelector('.nav-chevron');
                    if (chevron) {
                        if (group.classList.contains('collapsed')) {
                            chevron.style.transform = 'rotate(-90deg)';
                        } else {
                            chevron.style.transform = 'rotate(0deg)';
                        }
                    }
                }
            }
        }

        function switchTab(viewId, evt) {
            document.querySelectorAll('.view-panel').forEach(function(el) { el.classList.add('hidden'); });
            document.getElementById('view-' + viewId).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(function(el) { el.classList.remove('active'); });

            if(evt && evt.currentTarget) {
                evt.currentTarget.classList.add('active');
                document.getElementById('page-title').innerText = evt.currentTarget.innerText.trim();
            }

            if(viewId === 'visual-map') { renderAllMaps(); window.currentViewingLane = null; }
            if(viewId === 'unified-inbound') { renderAllMaps(); }
            if(viewId === 'move') { initSmartDispatch(); }
            if(viewId === 'approval') { loadApprovalList(); }
            if(viewId === 'inventory-log') { initInventoryLogPage(); }
            if(viewId === 'product-analysis') { initProductAnalysis(); }
            if(viewId === 'warehouse-heatmap') { initWarehouseHeatmap(); }
            if(viewId === 'expiry-management') { refreshExpiryReport(); }
            if(viewId === 'user-management') { loadUserList(); }
            if(viewId === 'wave-picking') { loadWavesFromFirebase(); }
            if(viewId === 'product-master') { loadProductMasterFromFirebase(); }
            if(viewId === 'external-warehouse') { loadExternalStock(); updateExtWarehouseFilter(); }
            if(viewId === 'consignment') { loadConsignmentsFromFirebase(); }
            if(viewId === 'rental-settings') { loadRentalSettingsFromFirebase(); }
            if(viewId === 'rental-report') { loadRentalSettingsFromFirebase(); }
            if(viewId === 'work-board') { refreshWorkBoard(); setBoardRefreshInterval(); }
        }
        function renderAllMaps() {
            renderMapUI('grid-I-A'); renderMapUI('grid-I-B');
            renderMapUI('grid-J-C'); renderMapUI('grid-J-D');
            renderMapUI('grid-K-E'); renderMapUI('grid-K-F'); renderMapUI('grid-K-G'); renderMapUI('grid-K-H');
            renderMapUI('grid-I-A-map'); renderMapUI('grid-I-B-map');
            renderMapUI('grid-J-C-map'); renderMapUI('grid-J-D-map');
            renderMapUI('grid-K-E-map'); renderMapUI('grid-K-F-map'); renderMapUI('grid-K-G-map'); renderMapUI('grid-K-H-map');
            if(window.currentViewingLane) showLaneDetail(window.currentViewingLane.zone, window.currentViewingLane.row);
            updateOZoneStats();
        }

        const mapConfig = {
            'grid-I-A':8, 'grid-I-B':8,
            'grid-J-C':8, 'grid-J-D':8,
            'grid-K-E':22, 'grid-K-F':22, 'grid-K-G':22, 'grid-K-H':22,
            'grid-I-A-map':8, 'grid-I-B-map':8,
            'grid-J-C-map':8, 'grid-J-D-map':8,
            'grid-K-E-map':22, 'grid-K-F-map':22, 'grid-K-G-map':22, 'grid-K-H-map':22
        };
        let lockedLane = null;

        function updateOZoneStats() {
            var inventory = window.currentInventory ? window.currentInventory() : [];
            var oZoneItems = inventory.filter(function(item) {
                return item.locationId && item.locationId.startsWith('O-');
            });

            var totalCount = oZoneItems.length;
            var totalQty = oZoneItems.reduce(function(sum, item) {
                return sum + (parseInt(item.quantity) || 0);
            }, 0);

            var countEl = document.getElementById('o-zone-count');
            var qtyEl = document.getElementById('o-zone-qty');

            if (countEl) countEl.textContent = totalCount;
            if (qtyEl) qtyEl.textContent = totalQty;
        }
        const LANE_CAPACITY = 20;

        function renderMapUI(gridId) {
            const container = document.getElementById(gridId); if(!container) return; container.innerHTML = '';
            const parts = gridId.replace('grid-', '').replace('-map', '').split('-'); const zoneKey = `${parts[0]}-${parts[1]}`;
            const zoneChar = parts[1];
            const warehouse = parts[0];
            const inventory = window.currentInventory ? window.currentInventory() : [];
            const laneStatus = {};
            inventory.forEach(item => {
                if(!item.locationId || item.locationId.startsWith('V-')) return;
                var parsed = parseLocationId(item.locationId);
                if(!parsed) return;
                if(parsed.zone === zoneKey) {
                    var lane = parsed.row;
                    if(!laneStatus[lane]) laneStatus[lane] = { count: 0, products: new Set() };
                    laneStatus[lane].count++;
                    laneStatus[lane].products.add(item.productName);
                }
            });

            const isKZone = zoneKey.startsWith('K-');
            const laneCount = isKZone ? 22 : 8;

            for(let i=1; i<=laneCount; i++) {
                const status = laneStatus[i] || { count: 0 };
                const fillPercent = Math.min((status.count / LANE_CAPACITY) * 100, 100);

                let fillColor = '#10b981'; if(fillPercent>=50) fillColor='#3b82f6'; if(fillPercent>=100) fillColor='#ef4444';
                let cls = '';
                if (status.count >= LANE_CAPACITY) cls += ' lane-full-locked';
                if (lockedLane && lockedLane.zone === zoneKey && lockedLane.row === i) cls += ' border-yellow-400 shadow-[0_0_10px_rgba(250,204,21,0.5)] z-20';
                const targetName = document.getElementById('in-name') ? document.getElementById('in-name').value : '';
                if(targetName && status.products && status.products.has(targetName) && fillPercent < 100) cls += ' lane-suggest-gold';

                const div = document.createElement('div'); div.className = `rack-lane-new ${cls}`;
                var starIcon = cls.includes('gold') ? '<i class="fa-solid fa-star text-yellow-400 absolute top-1/2 left-1/2 -translate-x-1/2 text-[8px]"></i>' : '';
                div.innerHTML = '<span class="lane-id-tag">' + zoneChar + i + '</span><div class="lane-fill-bar" style="height:' + fillPercent + '%; background:' + fillColor + '"></div>' + starIcon;

                var isInbound = !document.getElementById('view-unified-inbound').classList.contains('hidden');
                if(isInbound) {
                    (function(z, r) { div.onclick = function() { openLevelSelector(z, r); }; })(zoneKey, i);
                } else {
                    (function(z, r) {
                        div.onmouseenter = function(e) { showHoverTooltip(e, z, r); };
                        div.onmouseleave = function() { hideHoverTooltip(); };
                        div.onmousemove = function(e) { moveHoverTooltip(e); };
                    })(zoneKey, i);
                }
                container.appendChild(div);
            }
        }

        window.currentViewingLane = null;

        function showHoverTooltip(e, zone, row) {
            const tooltip = document.getElementById('hover-tooltip');
            const title = document.getElementById('tooltip-title');
            const badge = document.getElementById('tooltip-badge');
            const body = document.getElementById('tooltip-body');
            if (!tooltip) return;

            const inventory = window.currentInventory ? window.currentInventory() : [];
            const zoneChar = zone.split('-')[1];
            const warehouse = zone.split('-')[0];
            const lanePrefix = zone + '-' + (row < 10 ? '0'+row : row);
            const items = inventory.filter(d => d.locationId && d.locationId.startsWith(lanePrefix));
            const levels = { '3F': [], '2F': [], '1F': [] };
            items.forEach(d => {
                var parsed = parseLocationId(d.locationId);
                if(parsed && levels[parsed.level]) levels[parsed.level].push(d);
            });

            const totalItems = levels['3F'].length + levels['2F'].length + levels['1F'].length;
            const totalCapacity = 8 + 5 + 16;  // 3F:8 + 2F:5 + 1F:16 = 29 æ¿
            const emptySlots = Math.max(0, totalCapacity - totalItems);
            const fillPercent = Math.round((totalItems / totalCapacity) * 100);

            title.textContent = lanePrefix + ' å··';
            badge.textContent = fillPercent + '% ä½¿ç”¨ä¸­';
            badge.style.background = fillPercent >= 100 ? 'rgba(239,68,68,0.5)' : fillPercent >= 50 ? 'rgba(59,130,246,0.5)' : 'rgba(16,185,129,0.5)';

            body.innerHTML = renderTooltipContent(levels, emptySlots, totalItems);

            tooltip.classList.remove('hidden');
            moveHoverTooltip(e);
        }

        function moveHoverTooltip(e) {
            const tooltip = document.getElementById('hover-tooltip');
            if (!tooltip || tooltip.classList.contains('hidden')) return;

            const padding = 10;
            const rect = tooltip.getBoundingClientRect();
            const vw = window.innerWidth;
            const vh = window.innerHeight;
            const tooltipW = Math.min(rect.width, 580);
            const tooltipH = rect.height;

            let x = e.clientX + padding;
            let y = e.clientY + padding;

            if (x + tooltipW > vw - padding) {
                x = e.clientX - tooltipW - padding;
            }
            if (y + tooltipH > vh - padding) {
                y = vh - tooltipH - padding;
            }
            if (x < padding) x = padding;
            if (y < padding) y = padding;

            tooltip.style.left = x + 'px';
            tooltip.style.top = y + 'px';
        }

        function hideHoverTooltip() {
            const tooltip = document.getElementById('hover-tooltip');
            if (tooltip) tooltip.classList.add('hidden');
        }

        function renderTooltipContent(levels, emptySlots, totalItems) {
            let html = '<div class="tooltip-summary">';
            html += '<div class="tooltip-stat ' + (totalItems > 0 ? '' : 'empty') + '"><div class="tooltip-stat-value">' + totalItems + '</div><div class="tooltip-stat-label">å·²å­˜æ”¾</div></div>';
            html += '<div class="tooltip-stat ' + (emptySlots === 0 ? 'full' : 'empty') + '"><div class="tooltip-stat-value">' + emptySlots + '</div><div class="tooltip-stat-label">ç©ºä½</div></div>';
            html += '</div>';

            const allItems = [...levels['3F'], ...levels['2F'], ...levels['1F']];

            if (allItems.length > 0) {
                html += '<table class="w-full text-xs">';
                html += '<thead><tr class="text-slate-400 border-b border-slate-700">';
                html += '<th class="p-1.5 text-left">å„²ä½</th>';
                html += '<th class="p-1.5 text-left">æ£§æ¿ç·¨è™Ÿ</th>';
                html += '<th class="p-1.5 text-left">å…¬å¸</th>';
                html += '<th class="p-1.5 text-left">å“å</th>';
                html += '<th class="p-1.5 text-left">è¦æ ¼</th>';
                html += '<th class="p-1.5 text-right">æ•¸é‡</th>';
                html += '<th class="p-1.5 text-left">æ•ˆæœŸ</th>';
                html += '<th class="p-1.5 text-left">å¯„å€‰</th>';
                html += '</tr></thead><tbody>';

                allItems.forEach(item => {
                    const companyClass = item.company === 'å´‡æ–‡' ? 'bg-blue-600' : 'bg-emerald-600';

                    let expiryStr = '-';
                    if (item.expiryDate) {
                        const expDate = item.expiryDate.toDate ? item.expiryDate.toDate() : new Date(item.expiryDate);
                        expiryStr = expDate.toLocaleDateString('zh-TW');
                        const daysLeft = Math.ceil((expDate - new Date()) / (1000 * 60 * 60 * 24));
                        if (daysLeft < 0) {
                            expiryStr = '<span class="text-red-400">' + expiryStr + '</span>';
                        } else if (daysLeft <= 30) {
                            expiryStr = '<span class="text-orange-400">' + expiryStr + '</span>';
                        }
                    }

                    let consignStr = '-';
                    if (window.getLocationConsignments && item.locationId) {
                        const consignments = window.getLocationConsignments(item.locationId);
                        const matchingConsign = consignments.filter(c =>
                            c.productName === item.productName && c.spec === item.spec
                        );
                        if (matchingConsign.length > 0) {
                            const totalConsigned = matchingConsign.reduce((sum, c) => sum + c.qty, 0);
                            const customers = [...new Set(matchingConsign.map(c => c.customer))];
                            consignStr = '<span class="text-amber-400">' + totalConsigned + 'ä»¶</span>';
                            consignStr += '<span class="text-[10px] text-slate-500 ml-1">(' + customers.join(',') + ')</span>';
                        }
                    }

                    html += '<tr class="border-b border-slate-800 hover:bg-slate-800/50">';
                    let locDisplay = item.locationId || '-';
                    if (item.locationId) {
                        locDisplay = item.locationId
                            .replace(/-1F$/, '-<span class="text-emerald-400">1F</span>')
                            .replace(/-2F$/, '-<span class="text-sky-400">2F</span>')
                            .replace(/-3F$/, '-<span class="text-purple-400">3F</span>');
                    }
                    html += '<td class="p-1.5 font-mono text-[10px] text-slate-300 font-bold">' + locDisplay + '</td>';
                    html += '<td class="p-1.5 font-mono text-[10px] text-slate-400">' + (item.palletId || '-') + '</td>';
                    html += '<td class="p-1.5"><span class="px-1 py-0.5 rounded text-[10px] ' + companyClass + '">' + (item.company || '-') + '</span></td>';
                    html += '<td class="p-1.5 text-white">' + (item.productName || '-') + '</td>';
                    html += '<td class="p-1.5 text-slate-400 text-[10px]">' + (item.spec || '-') + '</td>';
                    var qtyDisplay = (item.quantity || 0) + 'ä»¶';
                    if (item.productType === 'variable' && item.totalWeight > 0) {
                        qtyDisplay += '<span class="text-amber-400 text-[10px] ml-1">/ ' + item.totalWeight + 'kg</span>';
                    } else if (item.unitWeight && item.unitWeight > 0) {
                        qtyDisplay += '<span class="text-slate-500 text-[10px] ml-1">@' + item.unitWeight + 'kg</span>';
                    } else if (item.totalWeight && item.totalWeight > 0) {
                        qtyDisplay += '<span class="text-amber-400 text-[10px] ml-1">/ ' + item.totalWeight + 'kg</span>';
                    }
                    html += '<td class="p-1.5 text-right font-bold text-white">' + qtyDisplay + '</td>';
                    html += '<td class="p-1.5">' + expiryStr + '</td>';
                    html += '<td class="p-1.5">' + consignStr + '</td>';
                    html += '</tr>';
                });

                html += '</tbody></table>';
            } else {
                html += '<div class="text-center text-slate-500 py-4">æ­¤å··é“ç›®å‰æ²’æœ‰åº«å­˜</div>';
            }

            return html;
        }

        function renderTooltipLevel(name, items, cap) {
            let html = '<div class="tooltip-level">';
            html += '<div class="tooltip-level-header"><span class="tooltip-level-name">' + name + '</span><span class="tooltip-level-count">' + items.length + '/' + cap + '</span></div>';

            const gridClass = cap >= 8 ? 'tooltip-items-1f' : 'tooltip-items';
            html += '<div class="' + gridClass + '">';

            items.forEach(item => {
                let catClass = 'cat-raw';
                if (item.category === 'FG') catClass = 'cat-fg';
                if (item.category === 'WIP') catClass = 'cat-wip';
                html += '<div class="tooltip-item ' + catClass + '">';
                html += '<div class="tooltip-item-name">' + (item.productName || 'æœªçŸ¥') + '</div>';
                html += '<div class="tooltip-item-qty">' + (item.quantity || 0) + '</div>';
                html += '</div>';
            });

            var emptyCount = cap - items.length;
            if (emptyCount > 0) {
                html += '<div class="tooltip-item empty-slot">';
                html += '<div class="tooltip-item-name">ç©ºä½ Ã—' + emptyCount + '</div>';
                html += '<div class="tooltip-item-qty">-</div>';
                html += '</div>';
            }

            html += '</div></div>';
            return html;
        }

        function showLaneDetail(zone, row) {
            window.currentViewingLane = { zone, row };
        }
        function renderVisualLevel(layer, items, cap, isHigh) {
            let boxes = '';
            items.forEach(item => {
                let bg = 'bg-raw'; if(item.category==='FG') bg='bg-fg'; if(item.category==='WIP') bg='bg-wip';
                boxes += `
                    <div class="pallet-box ${bg} ${isHigh?'loose':''}" title="${item.productName}">
                        <div class="row-1"><span class="name">${item.productName}</span><span class="qty">${item.quantity}ä»¶</span></div>
                        <div class="row-2">${item.spec||'ç„¡è¦æ ¼'}</div>
                        <div class="row-3">${item.batchNo}</div>
                    </div>
                `;
            });
            for(let i=0; i<(cap-items.length); i++) boxes += `<div class="pallet-box pallet-empty">ç©º</div>`;
            return `
                <div class="level-card">
                    <div class="level-header"><span class="${isHigh?'text-yellow-500':'text-slate-300'}">${layer} ${isHigh?'(æŒ‘é«˜)':''}</span><span>${items.length}/${cap}</span></div>
                    <div class="level-grid ${isHigh?'grid-cols-4 gap-2':'grid-cols-4 gap-2'}">${boxes}</div>
                </div>
            `;
        }

        function exportShippingResult() {
            if(!window.currentOrders || window.currentOrders().length === 0) { alert("ç„¡å‡ºè²¨è³‡æ–™å¯åŒ¯å‡º"); return; }
            var data = window.currentOrders().map(function(o) {
                return { 'å–®è™Ÿ': o.orderId, 'å®¢æˆ¶': o.customer, 'ç‰©æµ': o.carrier, 'ç‹€æ…‹': o.status, 'å“é …æ•¸': o.items.length };
            });
            var ws = XLSX.utils.json_to_sheet(data);
            var wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Shipping_Result");
            XLSX.writeFile(wb, "WMS_Shipping_Result_" + new Date().toISOString().slice(0,10) + ".xlsx");
        }

        function openAnalytics(type) { document.getElementById('analytics-title').innerText = type==='Total'?'åº«å­˜ç¸½è¦½':type; document.getElementById('modal-analytics').classList.remove('hidden'); }
        function closeAnalytics() { document.getElementById('modal-analytics').classList.add('hidden'); }

        let currentLane = null;
        function openLevelSelector(zone, row) {
            currentLane = { zone, row };
            var lanePrefix = zone + '-' + (row < 10 ? '0'+row : row);
            document.getElementById('modal-lane-title').innerText = lanePrefix + ' å··';
            var inventory = window.currentInventory();
            var items = inventory.filter(function(d) { return d.locationId && d.locationId.startsWith(lanePrefix); });

            var c3 = items.filter(function(d) { var p = parseLocationId(d.locationId); return p && p.level === '3F'; }).length;
            var c2 = items.filter(function(d) { var p = parseLocationId(d.locationId); return p && p.level === '2F'; }).length;
            var c1 = items.filter(function(d) { var p = parseLocationId(d.locationId); return p && p.level === '1F'; }).length;

            var CAP_3F = 8;   // 3F å®¹é‡ï¼š8 æ¿
            var CAP_2F = 5;   // 2F å®¹é‡ï¼š5 æ¿
            var CAP_1F = 16;  // 1F å®¹é‡ï¼š16 æ¿ï¼ˆæŒ‘é«˜ï¼‰

            var btn3F = document.getElementById('btn-level-3f');
            var avail3F = CAP_3F - c3;
            if(c3 >= CAP_3F) {
                btn3F.classList.add('level-btn-full');
                btn3F.disabled = true;
                btn3F.innerHTML = '<div class="font-bold text-red-400">3F (æ»¿)</div><div class="text-xs text-red-300 mt-1">' + c3 + '/' + CAP_3F + ' æ¿</div><div class="text-xs text-red-500">âš ï¸ å·²æ»¿è¼‰</div>';
            } else {
                btn3F.classList.remove('level-btn-full');
                btn3F.disabled = false;
                btn3F.innerHTML = '<div class="font-bold text-white">3F</div><div class="text-xs text-slate-300 mt-1">' + c3 + '/' + CAP_3F + ' æ¿</div><div class="text-xs text-green-400">âœ“ å¯æ”¾ ' + avail3F + ' æ¿</div>';
            }

            var btn2F = document.getElementById('btn-level-2f');
            var avail2F = CAP_2F - c2;
            if(c2 >= CAP_2F) {
                btn2F.classList.add('level-btn-full');
                btn2F.disabled = true;
                btn2F.innerHTML = '<div class="font-bold text-red-400">2F (æ»¿)</div><div class="text-xs text-red-300 mt-1">' + c2 + '/' + CAP_2F + ' æ¿</div><div class="text-xs text-red-500">âš ï¸ å·²æ»¿è¼‰</div>';
            } else {
                btn2F.classList.remove('level-btn-full');
                btn2F.disabled = false;
                btn2F.innerHTML = '<div class="font-bold text-white">2F</div><div class="text-xs text-slate-300 mt-1">' + c2 + '/' + CAP_2F + ' æ¿</div><div class="text-xs text-green-400">âœ“ å¯æ”¾ ' + avail2F + ' æ¿</div>';
            }

            var btn1F = document.getElementById('btn-level-1f');
            var avail1F = CAP_1F - c1;
            if(c1 >= CAP_1F) {
                btn1F.classList.add('level-btn-full');
                btn1F.disabled = true;
                btn1F.innerHTML = '<div class="font-bold text-red-400">1F æŒ‘é«˜ (æ»¿)</div><div class="text-xs text-red-300 mt-1">' + c1 + '/' + CAP_1F + ' æ¿</div><div class="text-xs text-red-500">âš ï¸ å·²æ»¿è¼‰</div>';
            } else {
                btn1F.classList.remove('level-btn-full');
                btn1F.disabled = false;
                btn1F.innerHTML = '<div class="font-bold text-yellow-400">1F æŒ‘é«˜</div><div class="text-xs text-slate-300 mt-1">' + c1 + '/' + CAP_1F + ' æ¿</div><div class="text-xs text-green-400">âœ“ å¯æ”¾ ' + avail1F + ' æ¿</div>';
            }

            document.getElementById('loc-select-physical').classList.remove('hidden');
            document.getElementById('loc-select-virtual').classList.add('hidden');
            document.getElementById('modal-level-select').classList.remove('hidden');
        }
        function closeLocModal() { document.getElementById('modal-level-select').classList.add('hidden'); }
        function selectLevel(level) { if(!currentLane) return; const rowStr = currentLane.row < 10 ? '0'+currentLane.row : currentLane.row; document.getElementById('in-loc').value = `${currentLane.zone}-${rowStr}-${level}`; closeLocModal(); updateLivePreview(); }

        const virtualLocations = [{id:'V-SALES',name:'æ¥­å‹™ä¿ç•™'},{id:'V-TEMP',name:'è‡¨æ™‚æš«å­˜'},{id:'V-QC',name:'å“ç®¡ç•™ç½®'}];
        function openVirtualSelector() { document.getElementById('virtual-grid').innerHTML = virtualLocations.map(v=>`<div class="virtual-card" onclick="selectVirtualLoc('${v.id}')"><div class="font-bold text-white text-sm">${v.name}</div><div class="text-[10px] text-slate-400 mt-1">${v.id}</div></div>`).join(''); document.getElementById('loc-select-physical').classList.add('hidden'); document.getElementById('loc-select-virtual').classList.remove('hidden'); document.getElementById('modal-level-select').classList.remove('hidden'); }
        function addNewVirtualLoc() { const name = document.getElementById('new-virtual-name').value; if(name) { virtualLocations.push({id:`V-CUSTOM-${Date.now().toString().slice(-4)}`, name}); openVirtualSelector(); } }
        function selectVirtualLoc(id) { document.getElementById('in-loc').value = id; closeLocModal(); }
        function setCategory(cat) {
            document.querySelectorAll('.border-emerald-600, .border-slate-600').forEach(el => { if(el.id.startsWith('cat-')) el.className = "border border-slate-600 text-slate-400 text-center rounded text-[10px] py-1"; });
            const activeEl = document.getElementById('cat-'+cat);
            if(cat==='Raw') activeEl.className = "border border-emerald-600 bg-emerald-900/30 text-emerald-400 text-center rounded text-[10px] py-1 font-bold";
            if(cat==='FG') activeEl.className = "border border-purple-600 bg-purple-900/30 text-purple-400 text-center rounded text-[10px] py-1 font-bold";
            if(cat==='WIP') activeEl.className = "border border-yellow-600 bg-yellow-900/30 text-yellow-400 text-center rounded text-[10px] py-1 font-bold";
            document.getElementById('in-category').value = cat;
        }

        function focusNext(e, nextId) { if(e.key === 'Enter') { if(nextId==='confirm-btn') confirmUnifiedInbound(); else document.getElementById(nextId).focus(); } }

        // ===== å…¥åº«å–®åŠŸèƒ½ï¼ˆçµ±ä¸€æ ¼å¼ - è·Ÿè²¨æ«ƒå…¥åº«ä¸€æ¨£ï¼‰=====
        window.previewInboundSlip = function() {
            var name = document.getElementById('in-name').value;
            var spec = document.getElementById('in-spec').value || '';
            var qty = document.getElementById('in-qty').value;
            var batch = document.getElementById('in-batch').value || '';
            var exp = document.getElementById('in-exp').value || '';
            var loc = document.getElementById('in-loc').value || '';
            var vendor = document.getElementById('in-vendor') ? document.getElementById('in-vendor').value : '';

            if(!name) { alert('è«‹å…ˆå¡«å¯«å“å'); return; }
            if(!qty) { alert('è«‹å…ˆå¡«å¯«æ•¸é‡'); return; }

            var now = new Date();
            var slipNo = 'PL-' + (batch || 'IN') + '-' + ('0'+(now.getMonth()+1)).slice(-2) + ('0'+now.getDate()).slice(-2) + '-001';

            var labelHtml = generateSlipLabelHtml({
                locationId: loc || 'å¾…åˆ†é…',
                productName: name,
                spec: spec,
                batchNo: batch || '-',
                expiryDate: exp,
                quantity: qty,
                vendor: vendor,
                palletId: slipNo
            }, 0);

            var html = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>æ£§æ¿æ’å–® - ' + name + '</title>';
            html += '<style>';
            html += '@page { size: A4 landscape; margin: 0; }';
            html += '* { margin: 0; padding: 0; box-sizing: border-box; }';
            html += 'body { font-family: Microsoft JhengHei, Arial, sans-serif; background: #fff; }';
            html += '.label-page { width: 297mm; height: 210mm; padding: 8mm; box-sizing: border-box; }';
            html += '.label-content { height: 100%; border: 3px solid #000; display: flex; flex-direction: column; }';
            html += '.location-row { background: #e5e5e5; border-bottom: 3px solid #000; padding: 8mm 0; text-align: center; }';
            html += '.location-text { font-size: 26mm; font-weight: 900; letter-spacing: 5mm; }';
            html += '.product-section { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 5mm; }';
            html += '.product-name { font-size: 28mm; font-weight: 900; }';
            html += '.product-spec { font-size: 16mm; color: #333; margin-top: 3mm; }';
            html += '.info-row { border-top: 3px solid #000; display: flex; }';
            html += '.info-cell { flex: 1; text-align: center; padding: 5mm 2mm; border-right: 1px solid #ccc; }';
            html += '.info-cell:last-child { border-right: none; }';
            html += '.info-label { font-size: 4mm; color: #666; margin-bottom: 2mm; }';
            html += '.info-value { font-size: 14mm; font-weight: 900; }';
            html += '.info-value.qty { font-size: 22mm; color: #dc2626; }';
            html += '.barcode-row { border-top: 2px dashed #999; padding: 4mm 0; text-align: center; }';
            html += '.no-print { text-align: center; padding: 20px; }';
            html += '.no-print button { padding: 15px 40px; font-size: 18px; border: none; cursor: pointer; font-weight: bold; margin: 0 10px; border-radius: 8px; }';
            html += '.btn-print { background: #059669; color: white; }';
            html += '.btn-close { background: #666; color: white; }';
            html += '@media print { .no-print { display: none !important; } }';
            html += '</style>';
            html += '<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"><\/script>';
            html += '</head><body>';

            html += '<div class="label-page"><div class="label-content">';

            html += '<div class="location-row"><div class="location-text">' + (loc || 'å¾…åˆ†é…') + '</div></div>';

            html += '<div class="product-section">';
            html += '<div class="product-name">' + name + ' <span style="font-size:16mm;color:#333;">' + spec + '</span></div>';
            if (vendor) {
                html += '<div class="product-spec">(' + vendor + ')</div>';
            }
            html += '</div>';

            html += '<div class="info-row">';
            html += '<div class="info-cell"><div class="info-label">æ‰¹è™Ÿ</div><div class="info-value">' + (batch || '-') + '</div></div>';
            html += '<div class="info-cell"><div class="info-label">æ•ˆæœŸ</div><div class="info-value">' + (exp || '-') + '</div></div>';
            html += '<div class="info-cell"><div class="info-label">æ•¸é‡</div><div class="info-value qty">' + qty + '</div></div>';
            html += '<div class="info-cell"><div class="info-label">å» å•†</div><div class="info-value">' + (vendor || '-') + '</div></div>';
            html += '</div>';

            html += '<div class="barcode-row"><svg id="slip-barcode"></svg></div>';

            html += '</div></div>';

            html += '<div class="no-print">';
            html += '<button class="btn-print" onclick="window.print()">ğŸ–¨ï¸ åˆ—å°å…¨éƒ¨ 1 å¼µæ’å–®</button>';
            html += '<button class="btn-close" onclick="window.close()">é—œé–‰</button>';
            html += '</div>';

            html += '<script>window.onload = function() { try { JsBarcode("#slip-barcode", "' + slipNo + '", {format:"CODE128",height:15,width:3,displayValue:true,fontSize:16,fontOptions:"bold",margin:5}); } catch(e) {} };<\/script>';
            html += '</body></html>';

            var printWindow = window.open('', '_blank', 'width=1100,height=800');
            printWindow.document.write(html);
            printWindow.document.close();
        };

                window.showBatchInboundDialog = function() {
            var name = document.getElementById('in-name').value;
            var qty = document.getElementById('in-qty').value;
            var loc = document.getElementById('in-loc').value;
            if(!name) { alert("è«‹å…ˆå¡«å¯«å“å"); return; }
            if(!qty) { alert("è«‹å…ˆå¡«å¯«æ•¸é‡"); return; }
            if(!loc) { alert("è«‹å…ˆé¸æ“‡å„²ä½"); return; }
            var count = prompt("è¦æ‰¹æ¬¡å…¥åº«å¹¾æ¿ï¼Ÿ", "10");
            if(!count || count < 1) return;
            executeBatchInbound(parseInt(count));
        };

        function getLaneCapacity(zone, row) {
            var inventory = window.currentInventory ? window.currentInventory() : [];
            var lanePrefix = zone + '-' + (row < 10 ? '0' + row : row);
            var items = inventory.filter(function(d) { return d.locationId && d.locationId.startsWith(lanePrefix); });

            var c3 = items.filter(function(d) { var p = parseLocationId(d.locationId); return p && p.level === '3F'; }).length;
            var c2 = items.filter(function(d) { var p = parseLocationId(d.locationId); return p && p.level === '2F'; }).length;
            var c1 = items.filter(function(d) { var p = parseLocationId(d.locationId); return p && p.level === '1F'; }).length;

            var CAP_3F = 8;
            var CAP_2F = 5;
            var CAP_1F = 16;

            return {
                '3F': { used: c3, max: CAP_3F, available: CAP_3F - c3 },
                '2F': { used: c2, max: CAP_2F, available: CAP_2F - c2 },
                '1F': { used: c1, max: CAP_1F, available: CAP_1F - c1 }
            };
        }

        function allocatePallets(baseLoc, count) {
            var parsed = parseLocationId(baseLoc);
            if (!parsed) return null;

            var zone = parsed.zone;
            var row = parsed.row;
            var preferredLevel = parsed.level || '2F';

            var capacity = getLaneCapacity(zone, row);
            var allocations = [];
            var remaining = count;

            var levelOrder = [preferredLevel];
            if(preferredLevel !== '3F') levelOrder.push('3F');
            if(preferredLevel !== '2F') levelOrder.push('2F');
            if(preferredLevel !== '1F') levelOrder.push('1F');

            for(var i = 0; i < levelOrder.length && remaining > 0; i++) {
                var level = levelOrder[i];
                var avail = capacity[level].available;
                if(avail > 0) {
                    var toPlace = Math.min(avail, remaining);
                    for(var j = 0; j < toPlace; j++) {
                        allocations.push(formatLocationId(zone, row, level));
                    }
                    remaining -= toPlace;
                }
            }

            return { allocations: allocations, overflow: remaining };
        }

        async function executeBatchInbound(count) {
            var loc = document.getElementById('in-loc').value;
            var allocation = allocatePallets(loc, count);

            if(!allocation || allocation.allocations.length === 0) {
                alert('éŒ¯èª¤ï¼šç„¡æ³•åˆ†é…å„²ä½');
                return;
            }

            if(allocation.overflow > 0) {
                alert('è­¦å‘Šï¼šæ­¤å··é“å‰©é¤˜å®¹é‡ä¸è¶³ï¼\n\n' +
                    'è¦æ±‚å…¥åº«ï¼š' + count + ' æ¿\n' +
                    'å¯æ”¾å…¥ï¼š' + allocation.allocations.length + ' æ¿\n' +
                    'è¶…å‡ºï¼š' + allocation.overflow + ' æ¿\n\n' +
                    'è«‹é¸æ“‡å…¶ä»–å··é“å­˜æ”¾å‰©é¤˜æ£§æ¿ã€‚');
                count = allocation.allocations.length;
            }

            var summary = {};
            allocation.allocations.forEach(function(loc) {
                var level = loc.split('-').pop();
                summary[level] = (summary[level] || 0) + 1;
            });
            var summaryText = Object.keys(summary).map(function(k) { return k + ': ' + summary[k] + 'æ¿'; }).join(', ');

            if(!confirm('ç¢ºå®šè¦æ‰¹æ¬¡å…¥åº« ' + count + ' æ¿ï¼Ÿ\n\nåˆ†é…æ–¹å¼ï¼š' + summaryText + '\n\nå…¥åº«å¾Œå°‡ç”¢ç”Ÿã€Œæ‰¹æ¬¡å…¥åº«å–®ã€ä¾›ç¾å ´ä½œæ¥­')) return;

            try {
                var batch = window.writeBatch(window.db);
                var now = new Date();
                var name = document.getElementById('in-name').value;
                var spec = document.getElementById('in-spec').value || '';
                var batchNo = document.getElementById('in-batch') ? document.getElementById('in-batch').value : '';
                var qty = parseInt(document.getElementById('in-qty').value);
                var category = document.getElementById('in-category').value;
                var vendor = document.getElementById('in-vendor') ? document.getElementById('in-vendor').value : '';

                var companyRadio = document.querySelector('input[name="in-company"]:checked');
                var company = companyRadio ? companyRadio.value : 'å´‡æ–‡';

                var palletList = [];

                for(var i = 0; i < allocation.allocations.length; i++) {
                    var sheetId = window.generateSheetId();
                    var ref = window.doc(window.collection(window.db, "pallets"));
                    batch.set(ref, {
                        palletId: sheetId,
                        sheetId: sheetId,
                        productName: name,
                        spec: spec,
                        batchNo: batchNo,
                        quantity: qty,
                        locationId: allocation.allocations[i],
                        category: category,
                        vendor: vendor,
                        company: company,
                        status: "Available",
                        inboundDate: now,
                        source: "BatchInbound"
                    });

                    palletList.push({
                        seq: i + 1,
                        palletId: sheetId,
                        locationId: allocation.allocations[i],
                        qty: qty
                    });
                }
                await batch.commit();

                printBatchInboundSlip({
                    name: name,
                    spec: spec,
                    batchNo: batchNo,
                    qty: qty,
                    category: category,
                    vendor: vendor,
                    palletList: palletList,
                    date: now
                });

                alert('æ‰¹æ¬¡å…¥åº«æˆåŠŸï¼\n\nå·²ç”¢ç”Ÿ ' + count + ' å€‹æ£§æ¿\nç¸½æ•¸é‡ï¼š' + (qty * count) + ' ä»¶\n\nåˆ†é…ï¼š' + summaryText);
                if(!document.getElementById('lock-mode').checked) {
                    document.getElementById('in-name').value = '';
                    document.getElementById('in-spec').value = '';
                    document.getElementById('in-qty').value = '';
                    document.getElementById('in-loc').value = '';
                    document.getElementById('in-warehouse').value = 'MAIN';
                    onWarehouseChange();
                }
                renderAllMaps();
            } catch(e) {
                alert('æ‰¹æ¬¡å…¥åº«å¤±æ•—ï¼š' + e.message);
            }
        }

        function printBatchInboundSlip(data) {
            var categoryNames = { 'Raw': 'æ¡è³¼é€²è²¨', 'FG': 'ç”¢ç·šæˆå“', 'WIP': 'ç”¢ç·šåŠæˆå“', 'Return': 'é¤˜æ–™é€€åº«' };
            var now = data.date;
            var slipNo = 'BIN-' + now.getFullYear() + ('0'+(now.getMonth()+1)).slice(-2) + ('0'+now.getDate()).slice(-2) + '-' + ('0'+now.getHours()).slice(-2) + ('0'+now.getMinutes()).slice(-2) + ('0'+now.getSeconds()).slice(-2);
            var dateStr = now.getFullYear() + '/' + ('0'+(now.getMonth()+1)).slice(-2) + '/' + ('0'+now.getDate()).slice(-2) + ' ' + ('0'+now.getHours()).slice(-2) + ':' + ('0'+now.getMinutes()).slice(-2);
            var totalQty = data.qty * data.palletList.length;

            var html = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>æ‰¹æ¬¡å…¥åº«å–® ' + slipNo + '</title>';
            html += '<style>* { margin: 0; padding: 0; box-sizing: border-box; } body { font-family: Microsoft JhengHei, Arial, sans-serif; padding: 20px; font-size: 14px; }';
            html += '.slip { width: 100%; max-width: 900px; margin: 0 auto; border: 2px solid #000; }';
            html += '.slip-header { background: #1a1a2e; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }';
            html += '.slip-title { font-size: 24px; font-weight: bold; }';
            html += '.slip-info { padding: 15px 20px; background: #f5f5f5; border-bottom: 1px solid #ddd; display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }';
            html += '.info-item { } .info-label { font-size: 11px; color: #666; } .info-value { font-weight: bold; font-size: 16px; }';
            html += '.slip-table { width: 100%; border-collapse: collapse; }';
            html += '.slip-table th { background: #e5e5e5; padding: 10px; border: 1px solid #ccc; text-align: center; font-size: 13px; }';
            html += '.slip-table td { padding: 10px; border: 1px solid #ccc; text-align: center; }';
            html += '.slip-table .loc { font-size: 18px; font-weight: bold; color: #059669; }';
            html += '.slip-table .pallet-id { font-family: monospace; font-size: 12px; color: #666; }';
            html += '.slip-table .check-box { width: 24px; height: 24px; border: 2px solid #333; display: inline-block; }';
            html += '.slip-footer { padding: 15px 20px; background: #f9f9f9; border-top: 2px solid #000; display: flex; justify-content: space-between; }';
            html += '.sign-box { text-align: center; } .sign-line { border-bottom: 1px solid #000; width: 120px; height: 35px; margin-bottom: 5px; }';
            html += '.sign-label { font-size: 11px; color: #666; }';
            html += '.category-tag { display: inline-block; padding: 4px 12px; border-radius: 4px; font-size: 12px; font-weight: bold; }';
            html += '.category-Raw { background: #dbeafe; color: #1d4ed8; }';
            html += '.category-FG { background: #fae8ff; color: #a21caf; }';
            html += '.category-WIP { background: #fef3c7; color: #b45309; }';
            html += '.category-Return { background: #fee2e2; color: #dc2626; }';
            html += '.note { padding: 10px 20px; background: #fffbeb; border-top: 1px dashed #f59e0b; font-size: 12px; color: #92400e; }';
            html += '@media print { body { padding: 0; } .no-print { display: none !important; } .slip { border: 1px solid #000; } }</style></head><body>';

            html += '<div class="slip">';
            html += '<div class="slip-header"><div><div class="slip-title">ğŸ“¦ æ‰¹æ¬¡å…¥åº«å–®</div><div style="font-size:12px;">å–®è™Ÿ: ' + slipNo + '</div></div>';
            html += '<div style="text-align:right;"><span class="category-tag category-' + data.category + '">' + (categoryNames[data.category] || data.category) + '</span>';
            html += '<div style="font-size:12px;margin-top:5px;">' + dateStr + '</div></div></div>';

            html += '<div class="slip-info">';
            html += '<div class="info-item"><div class="info-label">å» å•†</div><div class="info-value">' + (data.vendor || '-') + '</div></div>';
            html += '<div class="info-item"><div class="info-label">å“å</div><div class="info-value">' + data.name + '</div></div>';
            html += '<div class="info-item"><div class="info-label">è¦æ ¼</div><div class="info-value">' + (data.spec || '-') + '</div></div>';
            html += '<div class="info-item"><div class="info-label">æ‰¹è™Ÿ</div><div class="info-value">' + (data.batchNo || '-') + '</div></div>';
            html += '<div class="info-item"><div class="info-label">æ¯æ¿æ•¸é‡</div><div class="info-value">' + data.qty + ' ä»¶</div></div>';
            html += '<div class="info-item"><div class="info-label">ç¸½æ¿æ•¸</div><div class="info-value">' + data.palletList.length + ' æ¿</div></div>';
            html += '<div class="info-item"><div class="info-label">ç¸½æ•¸é‡</div><div class="info-value" style="color:#dc2626;">' + totalQty + ' ä»¶</div></div>';
            html += '</div>';

            html += '<table class="slip-table"><thead><tr>';
            html += '<th style="width:50px;">åºè™Ÿ</th>';
            html += '<th style="width:180px;">æ£§æ¿ç·¨è™Ÿ</th>';
            html += '<th style="width:150px;">ç›®æ¨™å„²ä½</th>';
            html += '<th style="width:80px;">æ•¸é‡</th>';
            html += '<th style="width:60px;">ä¸Šæ¶</th>';
            html += '<th style="width:60px;">ç¢ºèª</th>';
            html += '<th>å‚™è¨»</th>';
            html += '</tr></thead><tbody>';

            data.palletList.forEach(function(p) {
                html += '<tr>';
                html += '<td>' + p.seq + '</td>';
                html += '<td class="pallet-id">' + p.palletId + '</td>';
                html += '<td class="loc">' + p.locationId + '</td>';
                html += '<td>' + p.qty + '</td>';
                html += '<td><span class="check-box"></span></td>';
                html += '<td><span class="check-box"></span></td>';
                html += '<td></td>';
                html += '</tr>';
            });

            html += '</tbody></table>';

            html += '<div class="note">âš ï¸ <b>å¤–åº«æ£§æ¿èªªæ˜</b>ï¼šè‹¥æ£§æ¿ç„¡ QR Codeï¼Œè«‹å°‡ã€Œæ£§æ¿ç·¨è™Ÿã€æ‰‹å¯«æ–¼æ£§æ¿æ¨™ç¤ºç‰Œä¸Šï¼Œæˆ–è²¼é™„æœ¬å–®å½±æœ¬æ–¼æ£§æ¿ä¸Šä»¥ä¾¿è¿½æº¯ã€‚</div>';

            html += '<div class="slip-footer">';
            html += '<div class="sign-box"><div class="sign-line"></div><div class="sign-label">è£½å–®äººå“¡</div></div>';
            html += '<div class="sign-box"><div class="sign-line"></div><div class="sign-label">å€‰ç®¡ç°½æ”¶</div></div>';
            html += '<div class="sign-box"><div class="sign-line"></div><div class="sign-label">å †é«˜æ©Ÿæ‰‹</div></div>';
            html += '<div class="sign-box"><div class="sign-line"></div><div class="sign-label">ä¸»ç®¡ç¢ºèª</div></div>';
            html += '</div></div>';

            html += '<div class="no-print" style="text-align:center;margin-top:20px;">';
            html += '<button onclick="window.print()" style="padding:12px 30px;font-size:16px;background:#059669;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:bold;">ğŸ–¨ï¸ åˆ—å°æ‰¹æ¬¡å…¥åº«å–®</button>';
            html += '<button onclick="window.close()" style="padding:12px 30px;font-size:16px;background:#6b7280;color:white;border:none;border-radius:8px;cursor:pointer;margin-left:10px;">é—œé–‰</button>';
            html += '</div></body></html>';

            var printWindow = window.open('', '_blank', 'width=1000,height=800');
            printWindow.document.write(html);
            printWindow.document.close();
        }

        async function handleUnifiedScan(e) {
            if(e.key === 'Enter') {
                const barcode = e.target.value.trim();
                const mode = document.getElementById('in-category').value;
                if (mode === 'Return') {
                    try {
                        const q = window.query(window.collection(window.db, "pallets"), window.where("palletId", "==", barcode));
                        const snap = await window.getDocs(q);
                        if(!snap.empty) {
                            const data = snap.docs[0].data();
                            document.getElementById('in-parent-id').value = data.palletId;
                            document.getElementById('in-name').value = data.productName + " (é¤˜æ–™)";
                            document.getElementById('in-spec').value = data.spec;
                            document.getElementById('in-batch').value = data.batchNo; document.getElementById('in-batch').readOnly = true;
                            document.getElementById('in-exp').value = data.expiryDate; document.getElementById('in-exp').readOnly = true;
                            document.getElementById('in-barcode').value = "RET-" + Date.now();
                            document.getElementById('in-qty').focus();
                            alert("ğŸ“¦ è®€å–åŸæ–™æˆåŠŸï¼");
                        } else { alert("âŒ æŸ¥ç„¡æ­¤æ¨™ç±¤"); }
                    } catch(err) { console.error(err); }
                } else {
                    try {
                        const palletID = document.getElementById('in-pallet-id').value;
                        const snap = await window.getDocs(window.query(window.collection(window.db, "pallets"), window.where("palletId", "==", barcode)));
                        if(!snap.empty) {
                            const data = snap.docs[0].data();
                            document.getElementById('in-name').value = data.productName;
                            document.getElementById('in-spec').value = data.spec||"";
                            document.getElementById('in-batch').value = data.batchNo;
                            document.getElementById('in-qty').value = data.quantity;
                            document.getElementById('in-exp').value = data.expiryDate;
                            alert("ğŸ“¦ æƒæåˆ°èˆŠè²¨ï¼");
                        } else { document.getElementById('in-name').focus(); if(!document.getElementById('in-batch').value) document.getElementById('in-batch').value = "B"+new Date().toISOString().slice(0,10).replace(/-/g,""); }
                        renderMapUI('grid-I-A-map');
                    } catch(err) { console.error(err); }
                }
            }
        }

        function generateInternalBarcode() { document.getElementById('in-barcode').value = "INT-"+Date.now(); document.getElementById('in-name').focus(); }

        function updateLivePreview() {
            var locEl = document.getElementById('prev-loc');
            if(locEl) locEl.innerText = document.getElementById('in-loc').value || '-';
            document.getElementById('prev-name').innerText = document.getElementById('in-name').value || '-';
            document.getElementById('prev-spec').innerText = document.getElementById('in-spec').value || '-';
            document.getElementById('prev-batch').innerText = 'æ‰¹è™Ÿ: ' + (document.getElementById('in-batch').value || '-');
            document.getElementById('prev-exp').innerText = 'æ•ˆæœŸ: ' + (document.getElementById('in-exp').value || '-');
            document.getElementById('prev-qty').innerText = document.getElementById('in-qty').value || '0';
        }

        window.selectInboundType = function(type) {
            document.getElementById('in-type-select').value = type;

            document.querySelectorAll('.inbound-type-btn').forEach(function(btn) {
                btn.classList.remove('active', 'border-blue-500', 'bg-blue-900/50', 'text-white');
                btn.classList.remove('border-purple-500', 'bg-purple-900/50', 'text-purple-400');
                btn.classList.remove('border-yellow-500', 'bg-yellow-900/50', 'text-yellow-400');
                btn.classList.remove('border-orange-500', 'bg-orange-900/50', 'text-orange-400');
                btn.classList.add('border-slate-600', 'bg-slate-800', 'text-slate-400');
            });

            var activeBtn = document.getElementById('btn-type-' + type);
            if (activeBtn) {
                activeBtn.classList.remove('border-slate-600', 'bg-slate-800', 'text-slate-400');
                var colors = {
                    'Raw': ['border-blue-500', 'bg-blue-900/50', 'text-white'],
                    'FG': ['border-purple-500', 'bg-purple-900/50', 'text-white'],
                    'WIP': ['border-yellow-500', 'bg-yellow-900/50', 'text-white'],
                    'Return': ['border-orange-500', 'bg-orange-900/50', 'text-white']
                };
                activeBtn.classList.add(...(colors[type] || colors['Raw']));
                activeBtn.classList.add('active');
            }

            onInboundTypeChange();
        };

        window.updateInboundProgress = function() {
            var nameEl = document.getElementById('in-name');
            var expEl = document.getElementById('in-exp');
            var locEl = document.getElementById('in-loc');
            var btn = document.getElementById('btn-inbound-main');

            if (!nameEl || !expEl || !btn) return;

            var name = nameEl.value.trim();
            var exp = expEl.value;

            var loc = locEl ? locEl.value.trim() : '';
            var locSection = document.getElementById('location-section');
            var isExternalMode = locSection && locSection.style.display === 'none';
            var locOk = isExternalMode || !!loc; // å¤–å€‰æ¨¡å¼ä¸éœ€è¦å„²ä½ï¼Œæˆ–æœ¬å€‰æœ‰å¡«å„²ä½

            var variableFields = document.getElementById('variable-weight-fields');
            var isVariable = variableFields && !variableFields.classList.contains('hidden');

            var qtyOk = false;
            if (isVariable) {
                var qtyVarEl = document.getElementById('in-qty-var');
                var weightEl = document.getElementById('in-weight');
                var qtyVal = qtyVarEl ? parseInt(qtyVarEl.value) : 0;
                var weightVal = weightEl ? parseFloat(weightEl.value) : 0;
                qtyOk = qtyVal > 0 && weightVal > 0;
            } else {
                var qtyEl = document.getElementById('in-qty');
                var qtyVal = qtyEl ? parseInt(qtyEl.value) : 0;
                qtyOk = qtyVal > 0;
            }

            if (typeof updateCheckItem === 'function') {
                updateCheckItem('check-name', !!name);
                updateCheckItem('check-qty', qtyOk);
                updateCheckItem('check-exp', !!exp);
                updateCheckItem('check-loc', locOk);
            }

            var allOk = !!name && qtyOk && !!exp && locOk;

            var s1 = document.getElementById('inbound-step-1');
            var s2 = document.getElementById('inbound-step-2');
            var s3 = document.getElementById('inbound-step-3');

            var step1Done = !!name && qtyOk && !!exp;

            if (s1) s1.className = step1Done ? 'flex items-center gap-2 px-4 py-2 rounded-lg bg-emerald-600 text-white transition-all' : 'flex items-center gap-2 px-4 py-2 rounded-lg bg-blue-600 text-white transition-all';
            if (s2) s2.className = locOk ? 'flex items-center gap-2 px-4 py-2 rounded-lg bg-emerald-600 text-white transition-all' : 'flex items-center gap-2 px-4 py-2 rounded-lg bg-slate-700 text-slate-400 transition-all';
            if (s3) s3.className = allOk ? 'flex items-center gap-2 px-4 py-2 rounded-lg bg-purple-600 text-white transition-all' : 'flex items-center gap-2 px-4 py-2 rounded-lg bg-slate-700 text-slate-400 transition-all';

            btn.disabled = !allOk;
        };

        function updateCheckItem(id, isComplete) {
            var el = document.getElementById(id);
            if (!el) return;
            var icon = el.querySelector('i');
            var text = el.querySelector('span');
            if (isComplete) {
                icon.className = 'fa-solid fa-check-circle text-emerald-400 text-xs';
                text.className = 'text-emerald-400';
            } else {
                icon.className = 'fa-solid fa-circle text-slate-600 text-xs';
                text.className = 'text-slate-400';
            }
        }

        window.toggleProductType = function(type) {
            var fixedFields = document.getElementById('fixed-weight-fields');
            var variableFields = document.getElementById('variable-weight-fields');
            var avgWeightHint = document.getElementById('avg-weight-hint');

            if (type === 'fixed') {
                fixedFields.classList.remove('hidden');
                variableFields.classList.add('hidden');
                avgWeightHint.classList.add('hidden');
            } else {
                fixedFields.classList.add('hidden');
                variableFields.classList.remove('hidden');
                avgWeightHint.classList.remove('hidden');
            }

            updateInboundProgress();
        };

        window.calcAvgWeight = function() {
            var qty = parseInt(document.getElementById('in-qty-var').value) || 0;
            var weight = parseFloat(document.getElementById('in-weight').value) || 0;
            var avgSpan = document.getElementById('avg-weight-value');

            if (qty > 0 && weight > 0) {
                var avg = Math.round(weight / qty * 100) / 100;
                avgSpan.innerText = avg;
            } else {
                avgSpan.innerText = '-';
            }
        };

        window.getProductType = function() {
            var radio = document.querySelector('input[name="in-product-type"]:checked');
            return radio ? radio.value : 'fixed';
        };

        async function confirmUnifiedInbound() {
             var loc = document.getElementById('in-loc').value;
             var sheetId = document.getElementById('in-sheet-id').value;
             var palletId = document.getElementById('in-pallet-id') ? document.getElementById('in-pallet-id').value : '';
             var finalID = sheetId || palletId;

             if(!loc) { alert("âŒ è«‹å…ˆé¸å„²ä½"); return; }
             if(!finalID) { alert("âŒ è«‹è¼¸å…¥æ’å–®ç·¨è™Ÿ"); return; }
             if(!document.getElementById('in-name').value) { alert("âŒ è«‹å¡«å¯«å“å"); return; }

             var productType = getProductType();
             var qty, totalWeight, unitWeight;

             if (productType === 'fixed') {
                 qty = parseInt(document.getElementById('in-qty').value) || 0;
                 unitWeight = parseFloat(document.getElementById('in-unit-weight').value) || 0;
                 totalWeight = qty * unitWeight; // è¨ˆç®—ç¸½é‡é‡
                 if (!qty) { alert("âŒ è«‹å¡«å¯«æ•¸é‡"); return; }
             } else {
                 qty = parseInt(document.getElementById('in-qty-var').value) || 0;
                 totalWeight = parseFloat(document.getElementById('in-weight').value) || 0;
                 unitWeight = qty > 0 ? Math.round(totalWeight / qty * 100) / 100 : 0;
                 if (!qty) { alert("âŒ è«‹å¡«å¯«æ•¸é‡"); return; }
                 if (!totalWeight) { alert("âŒ ä¸å®šé‡å“è«‹å¡«å¯«ç¸½é‡é‡"); return; }
             }

             var productName = document.getElementById('in-name').value;
             var spec = document.getElementById('in-spec').value || '';
             var batchNo = document.getElementById('in-batch') ? document.getElementById('in-batch').value : '';
             var expDate = document.getElementById('in-exp') ? document.getElementById('in-exp').value : '';
             var vendor = document.getElementById('in-vendor') ? document.getElementById('in-vendor').value : '';

             var companyRadio = document.querySelector('input[name="in-company"]:checked');
             var company = companyRadio ? companyRadio.value : 'å´‡æ–‡';

             try {
                await window.addDoc(window.collection(window.db, "pallets"), {
                    palletId: finalID,
                    sheetId: sheetId,
                    contentId: sheetId,
                    productName: productName,
                    spec: spec,
                    batchNo: batchNo,
                    expiryDate: expDate,
                    quantity: qty,
                    totalWeight: totalWeight,
                    unitWeight: unitWeight,
                    productType: productType,
                    locationId: loc,
                    category: document.getElementById('in-category').value,
                    inboundDate: new Date(),
                    status: "Available",
                    vendor: vendor,
                    company: company,
                    workOrder: document.getElementById('in-wo') ? document.getElementById('in-wo').value : '',
                    source: 'Inbound'
                });

                var categoryNames = { 'Raw': 'æ¡è³¼é€²è²¨', 'FG': 'ç”¢ç·šæˆå“', 'WIP': 'ç”¢ç·šåŠæˆå“', 'Return': 'é¤˜æ–™é€€åº«' };
                var categoryName = categoryNames[document.getElementById('in-category').value] || 'å…¥åº«';
                var weightNote = productType === 'fixed'
                    ? (unitWeight > 0 ? ' (ç®±å®¹' + unitWeight + 'kg)' : '')
                    : ' (ç¸½é‡' + totalWeight + 'kg)';
                await window.logInventoryChange({
                    type: 'inbound',
                    company: company,
                    productName: productName,
                    spec: spec,
                    quantity: qty,
                    weight: totalWeight,
                    quantityChange: qty,
                    weightChange: totalWeight,
                    locationId: loc,
                    batchNo: batchNo,
                    palletId: finalID,
                    expDate: expDate,
                    note: categoryName + (vendor ? ' - ' + vendor : '') + weightNote
                });

                var successMsg = "âœ… å…¥åº«æˆåŠŸï¼\næ•¸é‡ï¼š" + qty + " ä»¶";
                if (productType === 'fixed' && unitWeight > 0) {
                    successMsg += "\nç®±å®¹ï¼š" + unitWeight + " kg/ä»¶";
                } else if (productType === 'variable') {
                    successMsg += "\nç¸½é‡ï¼š" + totalWeight + " kgï¼ˆå‡é‡ " + unitWeight + " kg/ä»¶ï¼‰";
                }
                alert(successMsg);

                setTimeout(function() {
                    var shouldPreview = document.getElementById('preview-pallet-tag') && document.getElementById('preview-pallet-tag').checked;
                    if(shouldPreview) {
                        var data = {
                            vendor: document.getElementById('in-vendor') ? document.getElementById('in-vendor').value : '',
                            productName: document.getElementById('in-name').value,
                            spec: document.getElementById('in-spec').value || '',
                            batchNo: document.getElementById('in-batch') ? document.getElementById('in-batch').value : '',
                            qty: document.getElementById('in-qty').value,
                            weight: document.getElementById('in-weight').value,
                            loc: loc,
                            barcode: finalID
                        };
                        printAutoLabel(data);
                    }
                }, 500);

                if(!document.getElementById('lock-mode').checked) {
                    document.getElementById('in-sheet-id').value = '';
                    document.getElementById('in-loc').value = '';
                    document.getElementById('in-name').value = '';
                    document.getElementById('in-spec').value = '';
                    document.getElementById('in-qty').value = '';
                    document.getElementById('in-unit-weight').value = '';
                    document.getElementById('in-qty-var').value = '';
                    document.getElementById('in-weight').value = '';
                    document.getElementById('avg-weight-value').innerText = '-';
                }
             } catch(e) {
                 console.error('å…¥åº«éŒ¯èª¤:', e);
                 alert("éŒ¯èª¤: " + e.message);
             }
        }

        function printAutoLabel(d) {
            var exp = document.getElementById('in-exp') ? document.getElementById('in-exp').value : '';
            var vendor = document.getElementById('in-vendor') ? document.getElementById('in-vendor').value : '';

            var html = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>æ£§æ¿æ’å–® - ' + d.productName + '</title>';
            html += '<style>';
            html += '@page { size: A4 landscape; margin: 0; }';
            html += '* { margin: 0; padding: 0; box-sizing: border-box; }';
            html += 'body { font-family: Microsoft JhengHei, Arial, sans-serif; background: #fff; }';
            html += '.label-page { width: 297mm; height: 210mm; padding: 5mm; box-sizing: border-box; }';
            html += '.label-content { height: 100%; border: 3px solid #000; display: flex; flex-direction: column; }';
            html += '.row-1 { flex: 2; display: flex; align-items: center; justify-content: center; border-bottom: 3px solid #000; }';
            html += '.product-name { font-size: 144px; font-weight: 900; text-align: center; line-height: 1; }';
            html += '.row-2 { flex: 1; display: flex; align-items: center; justify-content: center; border-bottom: 3px solid #000; }';
            html += '.product-spec { font-size: 100px; font-weight: 700; color: #333; text-align: center; }';
            html += '.row-3 { display: flex; border-bottom: 2px solid #000; }';
            html += '.info-cell { text-align: center; padding: 4mm 2mm; border-right: 1px solid #ccc; }';
            html += '.info-cell:last-child { border-right: none; }';
            html += '.info-cell.batch { flex: 1.2; }';
            html += '.info-cell.expiry { flex: 1.5; white-space: nowrap; }';
            html += '.info-cell.qty { flex: 1; }';
            html += '.info-cell.vendor { flex: 1.2; }';
            html += '.info-label { font-size: 14px; color: #666; margin-bottom: 2mm; }';
            html += '.info-value { font-size: 48px; font-weight: 900; }';
            html += '.info-value.qty-val { font-size: 100px; color: #dc2626; }';
            html += '.info-value.vendor-val { font-size: 100px; }';
            html += '.row-4 { display: flex; align-items: center; padding: 3mm 5mm; }';
            html += '.location-box { background: #000; color: #fff; font-size: 56px; font-weight: 900; padding: 3mm 8mm; margin-right: 5mm; }';
            html += '.barcode-box { flex: 1; text-align: center; }';
            html += '.no-print { text-align: center; padding: 20px; }';
            html += '.no-print button { padding: 15px 40px; font-size: 18px; border: none; cursor: pointer; font-weight: bold; margin: 0 10px; border-radius: 8px; }';
            html += '.btn-print { background: #059669; color: white; }';
            html += '.btn-close { background: #666; color: white; }';
            html += '@media print { .no-print { display: none !important; } }';
            html += '</style>';
            html += '<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"><\/script>';
            html += '</head><body>';

            html += '<div class="label-page"><div class="label-content">';

            html += '<div class="row-1" style="display:flex;align-items:center;padding:0 8mm;">';
            html += '<div id="qrcode" style="width:200px;height:200px;flex-shrink:0;margin-right:15mm;"></div>';
            html += '<div class="product-name" style="flex:1;text-align:center;">' + d.productName + '</div>';
            html += '</div>';

            html += '<div class="row-2"><div class="product-spec">' + (d.spec || '-') + '</div></div>';

            html += '<div class="row-3">';
            html += '<div class="info-cell batch"><div class="info-label">æ‰¹è™Ÿ</div><div class="info-value">' + (d.batchNo || '-') + '</div></div>';
            html += '<div class="info-cell expiry"><div class="info-label">æ•ˆæœŸ</div><div class="info-value">' + (exp || '-') + '</div></div>';
            html += '<div class="info-cell qty"><div class="info-label">æ•¸é‡</div><div class="info-value qty-val">' + d.qty + '</div></div>';
            if (d.weight && parseFloat(d.weight) > 0) {
                html += '<div class="info-cell vendor"><div class="info-label">é‡é‡</div><div class="info-value" style="color:#d97706;">' + d.weight + ' kg</div></div>';
            } else {
                html += '<div class="info-cell vendor"><div class="info-label">å» å•†</div><div class="info-value vendor-val">' + (vendor || '-') + '</div></div>';
            }
            html += '</div>';

            html += '<div class="row-4" style="display:flex;align-items:center;padding:5mm 8mm;">';
            html += '<div class="location-box" style="font-size:64px;padding:5mm 12mm;min-width:200px;text-align:center;">' + (d.loc || 'å¾…åˆ†é…') + '</div>';
            html += '<div style="flex:1;display:flex;align-items:center;justify-content:center;">';
            html += '<svg id="slip-barcode"></svg>';
            html += '</div>';
            html += '</div>';

            html += '</div></div>';

            html += '<div class="no-print">';
            html += '<button class="btn-print" onclick="window.print()">ğŸ–¨ï¸ åˆ—å°å…¨éƒ¨ 1 å¼µæ’å–®</button>';
            html += '<button class="btn-close" onclick="window.close()">é—œé–‰</button>';
            html += '</div>';

            html += '<script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"><\/script>';
            html += '<script>window.onload = function() {';
            html += 'try { var qr = qrcode(0, "L"); qr.addData("' + d.barcode + '"); qr.make(); document.getElementById("qrcode").innerHTML = qr.createSvgTag(8, 0); } catch(e) {}';
            html += 'try { JsBarcode("#slip-barcode", "' + d.barcode + '", {format:"CODE128",height:60,width:1.5,displayValue:true,fontSize:14,margin:5,textMargin:2}); } catch(e) {}';
            html += '};<\/script>';
            html += '</body></html>';

            var printWindow = window.open('', '_blank', 'width=1100,height=800');
            printWindow.document.write(html);
            printWindow.document.close();
        }

        function handleExcelImport(e) { const file = e.target.files[0]; const reader = new FileReader(); reader.onload = function(evt) { const wb = XLSX.read(evt.target.result, {type:'array'}); const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]); processOrders(json); }; reader.readAsArrayBuffer(file); e.target.value = ''; }
        async function processOrders(json) { const batch = window.writeBatch(window.db); const orders = {}; json.forEach(row => { const oid = row['å–®è™Ÿ']||row['OrderNo']; if(!oid) return; if(!orders[oid]) orders[oid] = { orderId:oid, customer:row['å®¢æˆ¶']||'Unknown', carrier:row['ç‰©æµ']||'è‡ªå–', status:'Pending', items:[] }; orders[oid].items.push({ productId:row['å“è™Ÿ'], productName:row['å“å'], qty:row['æ•¸é‡'], spec:row['è¦æ ¼']||'' }); }); Object.values(orders).forEach(o => batch.set(window.doc(window.db, "shippingOrders", o.orderId), o)); await batch.commit(); alert("è¨‚å–®åŒ¯å…¥æˆåŠŸï¼"); }
        function renderShippingList() { renderShippingListWithPicking(); }
        function filterShippingList() { renderShippingListWithPicking(); }
        function handleStockImport(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = async function(evt) {
                const wb = XLSX.read(evt.target.result, {type:'array'});
                const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                if(confirm(`åŒ¯å…¥ ${json.length} ç­†ï¼Ÿ`)) {
                    const batch = window.writeBatch(window.db);
                    var logPromises = [];
                    json.forEach((r,i) => {
                        const palletId = r['æ¢ç¢¼']||`OLD-${i}`;
                        const qty = parseInt(r['æ•¸é‡']) || 0;

                        var productType = 'fixed';
                        var unitWeight = parseFloat(r['ç®±å®¹kg']) || 0;
                        var totalWeight = parseFloat(r['ç¸½é‡é‡kg']) || 0;

                        if (r['é¡å‹']) {
                            productType = (r['é¡å‹'] === 'ä¸å®šé‡' || r['é¡å‹'] === 'variable') ? 'variable' : 'fixed';
                        } else if (totalWeight > 0 && unitWeight === 0) {
                            productType = 'variable';
                        }

                        if (productType === 'fixed' && unitWeight > 0) {
                            totalWeight = qty * unitWeight;
                        } else if (productType === 'variable' && qty > 0 && totalWeight > 0) {
                            unitWeight = Math.round(totalWeight / qty * 100) / 100;
                        }

                        const ref = window.doc(window.collection(window.db, "pallets"));
                        batch.set(ref, {
                            palletId: palletId,
                            productName: r['å“å'],
                            spec: r['è¦æ ¼']||'',
                            batchNo: r['æ‰¹è™Ÿ']||'',
                            quantity: qty,
                            totalWeight: totalWeight,
                            unitWeight: unitWeight,
                            productType: productType,
                            locationId: r['å„²ä½'] || "INIT-STAGE",
                            status: "Available",
                            inboundDate: new Date(),
                            source: "Opening"
                        });
                        logPromises.push(window.logInventoryChange({
                            type: 'inbound',
                            productName: r['å“å'],
                            spec: r['è¦æ ¼'] || '',
                            quantity: qty,
                            weight: totalWeight,
                            quantityChange: qty,
                            weightChange: totalWeight,
                            locationId: r['å„²ä½'] || 'INIT-STAGE',
                            batchNo: r['æ‰¹è™Ÿ'] || '',
                            palletId: palletId,
                            note: 'æœŸåˆåŒ¯å…¥' + (totalWeight > 0 ? ' (' + totalWeight + 'kg)' : '')
                        }));
                    });
                    await batch.commit();
                    await Promise.all(logPromises);
                    alert("é–‹å¸³æˆåŠŸ");
                }
            };
            reader.readAsArrayBuffer(file);
            e.target.value = '';
        }

        window.exportInventoryToExcel = function() {
            var pallets = window.currentPallets ? window.currentPallets() : [];

            if (pallets.length === 0) {
                alert('æ²’æœ‰åº«å­˜è³‡æ–™å¯åŒ¯å‡º');
                return;
            }

            var data = [
                ['å…¬å¸', 'æ¢ç¢¼', 'å“å', 'è¦æ ¼', 'æ‰¹è™Ÿ', 'æ•ˆæœŸ', 'æ•¸é‡', 'é¡å‹', 'ç®±å®¹kg', 'ç¸½é‡é‡kg', 'å„²ä½', 'å» å•†', 'å…¥åº«æ—¥æœŸ']
            ];

            pallets.forEach(function(p) {
                var expDate = '';
                if (p.expiryDate) {
                    if (p.expiryDate.toDate) {
                        expDate = p.expiryDate.toDate().toISOString().split('T')[0];
                    } else if (typeof p.expiryDate === 'string') {
                        expDate = p.expiryDate;
                    }
                }

                var inboundDate = '';
                if (p.inboundDate) {
                    if (p.inboundDate.toDate) {
                        inboundDate = p.inboundDate.toDate().toISOString().split('T')[0];
                    } else if (typeof p.inboundDate === 'string') {
                        inboundDate = p.inboundDate.split('T')[0];
                    }
                }

                var productType = p.productType === 'variable' ? 'ä¸å®šé‡' : 'å®šé‡';

                data.push([
                    p.company || '',
                    p.palletId || '',
                    p.productName || '',
                    p.spec || '',
                    p.batchNo || '',
                    expDate,
                    p.quantity || 0,
                    productType,
                    p.unitWeight || '',
                    p.totalWeight || '',
                    p.locationId || '',
                    p.vendor || '',
                    inboundDate
                ]);
            });

            var ws = XLSX.utils.aoa_to_sheet(data);
            ws['!cols'] = [
                {wch:18}, // æ¢ç¢¼
                {wch:20}, // å“å
                {wch:15}, // è¦æ ¼
                {wch:12}, // æ‰¹è™Ÿ
                {wch:12}, // æ•ˆæœŸ
                {wch:8},  // æ•¸é‡
                {wch:8},  // é¡å‹
                {wch:8},  // ç®±å®¹
                {wch:10}, // ç¸½é‡é‡
                {wch:12}, // å„²ä½
                {wch:10}, // å» å•†
                {wch:12}  // å…¥åº«æ—¥æœŸ
            ];

            var wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'åº«å­˜æ¸…å–®');

            var filename = 'åº«å­˜æ¸…å–®_' + new Date().toISOString().split('T')[0] + '.xlsx';
            XLSX.writeFile(wb, filename);

            alert('âœ… åŒ¯å‡ºæˆåŠŸï¼\n\nå…± ' + (data.length - 1) + ' ç­†åº«å­˜');
        };

        // ========== è²¨æ«ƒå…¥åº«ä½œæ¥­ ==========

        window._containerData = {
            items: [],
            labels: []
        };

        window.downloadTemplate = function(type) {
            if (type === 'container' || type === 'pre') {
                var wb = XLSX.utils.book_new();
                var data = [
                    ['å» å•†', 'å“å', 'è¦æ ¼', 'æ‰¹è™Ÿ', 'æ•ˆæœŸ', 'æ•¸é‡', 'æ¯æ¿æ•¸', 'é¡å‹', 'ç®±å®¹kg', 'ç¸½é‡é‡kg'],
                    ['å‚³é®®', 'ç†Ÿç™½è¦ 50/60', '1.1KG*8ç›’', 'B240301', '2025/12/31', 400, 50, 'å®šé‡', 10, ''],
                    ['å‚³é®®', 'èŠ±æåœˆ', '300g*10åŒ…', 'B240302', '2025/11/30', 200, 40, 'å®šé‡', 3, ''],
                    ['æµ·æ´‹', 'èˆ¹å‡é€æŠ½', '40/60', 'B240303', '2025/10/31', 50, 50, 'ä¸å®šé‡', '', 1250],
                    ['æµ·æ´‹', 'é­·é­šåŸæ–™', '-', 'B240304', '2025/09/30', 30, 30, 'ä¸å®šé‡', '', 680]
                ];
                var ws = XLSX.utils.aoa_to_sheet(data);
                ws['!cols'] = [{wch:10},{wch:20},{wch:15},{wch:12},{wch:12},{wch:8},{wch:8},{wch:8},{wch:8},{wch:10}];
                XLSX.utils.book_append_sheet(wb, ws, 'å…¥åº«æ¸…å–®');
                XLSX.writeFile(wb, 'è²¨æ«ƒå…¥åº«ç¯„æœ¬.xlsx');
            } else if (type === 'stock') {
                var wb = XLSX.utils.book_new();
                var data = [
                    ['å“å', 'è¦æ ¼', 'æ‰¹è™Ÿ', 'æ•ˆæœŸ', 'æ•¸é‡', 'å„²ä½', 'é¡å‹', 'ç®±å®¹kg', 'ç¸½é‡é‡kg', 'æ¢ç¢¼'],
                    ['ç†Ÿç™½è¦', '50/60 1.1KG', 'B240101', '2025/06/30', 50, 'I-A-01-3F', 'å®šé‡', 10, '', 'PL-B240101-001'],
                    ['èˆ¹å‡é€æŠ½', '40/60', 'B240201', '2025/08/31', 30, 'I-A-02-3F', 'ä¸å®šé‡', '', 750, 'PL-B240201-001']
                ];
                var ws = XLSX.utils.aoa_to_sheet(data);
                ws['!cols'] = [{wch:15},{wch:15},{wch:12},{wch:12},{wch:8},{wch:12},{wch:8},{wch:8},{wch:10},{wch:18}];
                XLSX.utils.book_append_sheet(wb, ws, 'åº«å­˜');
                XLSX.writeFile(wb, 'æœŸåˆåº«å­˜ç¯„æœ¬.xlsx');
            }
        };

        window.handleContainerImport = function(event) {
            var file = event.target.files[0];
            if (!file) return;

            var reader = new FileReader();
            reader.onload = function(e) {
                var data = new Uint8Array(e.target.result);
                var workbook = XLSX.read(data, { type: 'array' });
                var sheet = workbook.Sheets[workbook.SheetNames[0]];
                var rows = XLSX.utils.sheet_to_json(sheet);

                var importCount = 0;
                rows.forEach(function(row) {
                    var qty = parseInt(row['æ•¸é‡']) || 0;
                    var perPallet = parseInt(row['æ¯æ¿æ•¸']) || 50;

                    var productType = 'fixed';
                    var unitWeight = parseFloat(row['ç®±å®¹kg']) || 0;
                    var totalWeight = parseFloat(row['ç¸½é‡é‡kg']) || 0;

                    if (row['é¡å‹']) {
                        productType = (row['é¡å‹'] === 'ä¸å®šé‡' || row['é¡å‹'] === 'variable') ? 'variable' : 'fixed';
                    } else if (totalWeight > 0 && unitWeight === 0) {
                        productType = 'variable';
                    }

                    if (productType === 'fixed') {
                        totalWeight = qty * unitWeight;
                    } else {
                        unitWeight = qty > 0 ? Math.round(totalWeight / qty * 100) / 100 : 0;
                    }

                    var item = {
                        id: 'CI-' + Date.now() + '-' + Math.random().toString(36).substr(2, 5),
                        vendor: row['å» å•†'] || '',
                        productName: row['å“å'] || '',
                        spec: row['è¦æ ¼'] || '',
                        batchNo: row['æ‰¹è™Ÿ'] || '',
                        expiryDate: row['æ•ˆæœŸ'] || '',
                        quantity: qty,
                        perPallet: perPallet,
                        palletCount: Math.ceil(qty / perPallet),
                        productType: productType,
                        unitWeight: unitWeight,
                        totalWeight: totalWeight
                    };

                    if (item.productName && item.quantity > 0) {
                        window._containerData.items.push(item);
                        importCount++;
                    }
                });

                renderContainerItems();

                if (importCount > 0) {
                    autoGenerateLabels();
                }

                alert('åŒ¯å…¥æˆåŠŸï¼š' + importCount + ' ç­†å“é …');
            };
            reader.readAsArrayBuffer(file);
            event.target.value = '';
        };

        window.togglePreProductType = function(type) {
            var fixedFields = document.getElementById('pre-fixed-fields');
            var variableFields = document.getElementById('pre-variable-fields');

            if (type === 'fixed') {
                fixedFields.classList.remove('hidden');
                variableFields.classList.add('hidden');
            } else {
                fixedFields.classList.add('hidden');
                variableFields.classList.remove('hidden');
            }
        };

        window.getPreProductType = function() {
            var radio = document.querySelector('input[name="pre-product-type"]:checked');
            return radio ? radio.value : 'fixed';
        };

        window.addContainerItem = function() {
            var companyRadio = document.querySelector('input[name="pre-company"]:checked');
            var company = companyRadio ? companyRadio.value : 'å´‡æ–‡';

            var vendor = document.getElementById('pre-vendor').value.trim();
            var name = document.getElementById('pre-name').value.trim();
            var spec = document.getElementById('pre-spec').value.trim();
            var batch = document.getElementById('pre-batch').value.trim();
            var exp = document.getElementById('pre-exp').value;

            var productType = getPreProductType();
            var qty, perPallet, unitWeight, totalWeight;

            if (productType === 'fixed') {
                qty = parseInt(document.getElementById('pre-qty').value) || 0;
                perPallet = parseInt(document.getElementById('pre-per-pallet').value) || 50;
                unitWeight = parseFloat(document.getElementById('pre-unit-weight').value) || 0;
                totalWeight = qty * unitWeight;
            } else {
                qty = parseInt(document.getElementById('pre-qty-var').value) || 0;
                totalWeight = parseFloat(document.getElementById('pre-total-weight').value) || 0;
                perPallet = parseInt(document.getElementById('pre-per-pallet-var').value) || 50;
                unitWeight = qty > 0 ? Math.round(totalWeight / qty * 100) / 100 : 0;
            }

            if (!name) { alert('è«‹è¼¸å…¥å“å'); return false; }
            if (!batch) { alert('è«‹è¼¸å…¥æ‰¹è™Ÿ'); return false; }
            if (qty <= 0) { alert('è«‹è¼¸å…¥æ•¸é‡'); return false; }
            if (productType === 'variable' && totalWeight <= 0) { alert('ä¸å®šé‡å“è«‹è¼¸å…¥ç¸½é‡é‡'); return false; }

            var item = {
                id: 'CI-' + Date.now() + '-' + Math.random().toString(36).substr(2, 5),
                company: company,
                vendor: vendor,
                productName: name,
                spec: spec,
                batchNo: batch,
                expiryDate: exp,
                quantity: qty,
                perPallet: perPallet,
                palletCount: Math.ceil(qty / perPallet),
                productType: productType,
                unitWeight: unitWeight,
                totalWeight: totalWeight
            };

            window._containerData.items.push(item);
            renderContainerItems();

            document.getElementById('pre-name').value = '';
            document.getElementById('pre-spec').value = '';
            document.getElementById('pre-batch').value = '';
            document.getElementById('pre-qty').value = '';
            document.getElementById('pre-unit-weight').value = '';
            document.getElementById('pre-qty-var').value = '';
            document.getElementById('pre-total-weight').value = '';

            return true;
        };

        window.addContainerItemAndGenerate = function() {
            var success = addContainerItem();
            if (success) {
                autoGenerateLabels();
            }
        };

        window.autoGenerateLabels = function() {
            var items = window._containerData.items;
            if (items.length === 0) return;

            var strategy = document.getElementById('container-strategy').value;

            var selectedZones = [];
            document.querySelectorAll('.container-zone-cb:checked').forEach(function(cb) {
                selectedZones.push(cb.value);
            });

            if (selectedZones.length === 0) {
                selectedZones = ['A', 'B'];
            }

            var labels = smartAllocateLocations(items, {
                strategy: strategy,
                zones: selectedZones
            });

            var overflowCount = labels.filter(function(l) { return l.overflow; }).length;
            if (overflowCount > 0) {
                console.warn('æœ‰ ' + overflowCount + ' æ¿æ‰¾ä¸åˆ°ç©ºä½');
            }

            window._containerData.labels = labels;
            renderContainerLabels();

            document.getElementById('container-action-buttons').classList.remove('hidden');
        };

        window.renderContainerItems = function() {
            var container = document.getElementById('container-items-list');
            var items = window._containerData.items;

            if (items.length === 0) {
                container.innerHTML = '<div class="text-center text-slate-500 py-8"><i class="fa-solid fa-box-open text-3xl mb-2"></i><div>å°šç„¡å“é …ï¼Œè«‹åŒ¯å…¥ Excel æˆ–æ‰‹å‹•æ–°å¢</div></div>';
                document.getElementById('container-summary').classList.add('hidden');
                return;
            }

            var html = '';
            var totalPallets = 0;
            var totalQty = 0;

            items.forEach(function(item, idx) {
                totalPallets += item.palletCount;
                totalQty += item.quantity;

                html += '<div class="bg-slate-800 p-3 rounded border border-slate-700">' +
                    '<div class="flex justify-between items-start">' +
                    '<div class="flex-1">' +
                    '<div class="text-white font-bold text-sm">' + item.productName + '</div>' +
                    '<div class="text-slate-400 text-xs">' + item.spec + '</div>' +
                    '<div class="text-xs mt-1">' +
                    '<span class="text-blue-400">æ‰¹è™Ÿ: ' + item.batchNo + '</span>' +
                    (item.expiryDate ? ' <span class="text-yellow-400 ml-2">æ•ˆæœŸ: ' + item.expiryDate + '</span>' : '') +
                    '</div>' +
                    '<div class="text-xs mt-1">' +
                    '<span class="text-emerald-400">æ•¸é‡: ' + item.quantity + '</span>' +
                    '<span class="text-orange-400 ml-2">æ¿æ•¸: ' + item.palletCount + '</span>' +
                    '</div>' +
                    '</div>' +
                    '<button onclick="removeContainerItem(\'' + item.id + '\')" class="text-red-400 hover:text-red-300 ml-2">' +
                    '<i class="fa-solid fa-trash"></i>' +
                    '</button>' +
                    '</div></div>';
            });

            container.innerHTML = html;

            document.getElementById('container-summary').classList.remove('hidden');
            document.getElementById('container-item-count').textContent = items.length;
            document.getElementById('container-pallet-count').textContent = totalPallets;
            document.getElementById('container-total-qty').textContent = totalQty;
        };

        window.removeContainerItem = function(id) {
            window._containerData.items = window._containerData.items.filter(function(item) {
                return item.id !== id;
            });
            renderContainerItems();
        };

        window.clearContainerItems = function() {
            if (!confirm('ç¢ºå®šæ¸…é™¤æ‰€æœ‰å“é …ï¼Ÿ')) return;
            window._containerData.items = [];
            window._containerData.labels = [];
            renderContainerItems();
            document.getElementById('container-labels-preview').innerHTML = '<div class="col-span-3 text-center text-slate-500 py-8"><i class="fa-solid fa-tags text-3xl mb-2"></i><div>è«‹å…ˆæ–°å¢å“é …</div></div>';
            document.getElementById('container-action-buttons').classList.add('hidden');
        };

        window.getAllAvailableLocations = function() {
            var pallets = window._inventoryData && window._inventoryData.pallets ? window._inventoryData.pallets : [];
            var occupiedSet = new Set();

            var skipOccupied = document.getElementById('container-skip-occupied');
            var shouldSkip = skipOccupied ? skipOccupied.checked : true;

            if (shouldSkip) {
                pallets.forEach(function(p) {
                    if (p.locationId) occupiedSet.add(p.locationId);
                });
            }

            var warehouseConfig = {
                'I': { zones: ['A', 'B'], maxRow: 8 },
                'J': { zones: ['C', 'D'], maxRow: 8 },
                'K': { zones: ['E', 'F', 'G', 'H'], maxRow: 22 }
            };

            var levels = ['3F', '2F', '1F'];
            var levelCapacity = { '3F': 8, '2F': 5, '1F': 16 };

            var available = [];

            Object.keys(warehouseConfig).forEach(function(warehouse) {
                var config = warehouseConfig[warehouse];
                config.zones.forEach(function(zoneChar) {
                    for (var row = 1; row <= config.maxRow; row++) {
                        levels.forEach(function(level) {
                            var rowStr = row < 10 ? '0' + row : '' + row;
                            var locId = warehouse + '-' + zoneChar + '-' + rowStr + '-' + level;

                            if (!occupiedSet.has(locId)) {
                                available.push({
                                    locationId: locId,
                                    warehouse: warehouse,
                                    zone: warehouse + '-' + zoneChar,
                                    zoneChar: zoneChar,
                                    row: row,
                                    level: level,
                                    capacity: levelCapacity[level]
                                });
                            }
                        });
                    }
                });
            });

            return available;
        };

        window.getFilteredAvailableLocations = function(options) {
            var all = getAllAvailableLocations();
            var opts = options || {};

            if (opts.usedLocations && opts.usedLocations.length > 0) {
                var usedSet = new Set(opts.usedLocations);
                all = all.filter(function(loc) {
                    return !usedSet.has(loc.locationId);
                });
            }

            if (opts.zones && opts.zones.length > 0) {
                all = all.filter(function(loc) {
                    return opts.zones.includes(loc.zoneChar);
                });
            }

            if (opts.warehouses && opts.warehouses.length > 0) {
                all = all.filter(function(loc) {
                    return opts.warehouses.includes(loc.warehouse);
                });
            }

            if (opts.levels && opts.levels.length > 0) {
                all = all.filter(function(loc) {
                    return opts.levels.includes(loc.level);
                });
            }

            if (opts.startRow) {
                all = all.filter(function(loc) {
                    return loc.row >= opts.startRow;
                });
            }

            return all;
        };

        window.smartAllocateLocations = function(items, options) {
            var opts = options || {};
            var strategy = opts.strategy || 'sequential'; // sequential, clustered, scattered
            var available = getFilteredAvailableLocations(opts);
            var usedLocations = [];
            var allocations = [];

            if (available.length === 0) {
                alert('æ²’æœ‰å¯ç”¨å„²ä½ï¼');
                return [];
            }

            items.forEach(function(item) {
                var remaining = item.quantity;
                var remainingWeight = item.totalWeight || 0;
                var palletNo = 1;
                var itemLocations = [];

                while (remaining > 0 && available.length > 0) {
                    var palletQty = Math.min(remaining, item.perPallet);
                    var palletWeight = 0;
                    if (item.productType === 'variable' && item.totalWeight > 0) {
                        palletWeight = Math.round((palletQty / item.quantity) * item.totalWeight * 10) / 10;
                    } else if (item.unitWeight > 0) {
                        palletWeight = palletQty * item.unitWeight;
                    }

                    var selectedLoc;

                    if (strategy === 'clustered' && itemLocations.length > 0) {
                        var lastLoc = itemLocations[itemLocations.length - 1];
                        selectedLoc = findNearestLocation(available, lastLoc);
                    } else {
                        selectedLoc = available[0];
                    }

                    if (!selectedLoc) {
                        selectedLoc = { locationId: 'OVERFLOW-' + palletNo };
                    } else {
                        available = available.filter(function(loc) {
                            return loc.locationId !== selectedLoc.locationId;
                        });
                    }

                    var allocation = {
                        id: 'PL-' + item.batchNo + '-' + String(palletNo).padStart(3, '0'),
                        company: item.company || 'å´‡æ–‡',
                        vendor: item.vendor,
                        productName: item.productName,
                        spec: item.spec,
                        batchNo: item.batchNo,
                        expiryDate: item.expiryDate,
                        quantity: palletQty,
                        totalWeight: palletWeight,
                        unitWeight: item.unitWeight || 0,
                        productType: item.productType || 'fixed',
                        locationId: selectedLoc.locationId,
                        palletNo: palletNo + '/' + item.palletCount,
                        zone: selectedLoc.zone,
                        warehouse: selectedLoc.warehouse,
                        level: selectedLoc.level
                    };

                    allocations.push(allocation);
                    itemLocations.push(selectedLoc);
                    usedLocations.push(selectedLoc.locationId);

                    remaining -= palletQty;
                    remainingWeight -= palletWeight;
                    palletNo++;
                }

                while (remaining > 0) {
                    var palletQty = Math.min(remaining, item.perPallet);
                    var palletWeight = 0;
                    if (item.productType === 'variable' && item.totalWeight > 0) {
                        palletWeight = Math.round((palletQty / item.quantity) * item.totalWeight * 10) / 10;
                    } else if (item.unitWeight > 0) {
                        palletWeight = palletQty * item.unitWeight;
                    }

                    allocations.push({
                        id: 'PL-' + item.batchNo + '-' + String(palletNo).padStart(3, '0'),
                        vendor: item.vendor,
                        productName: item.productName,
                        spec: item.spec,
                        batchNo: item.batchNo,
                        expiryDate: item.expiryDate,
                        quantity: palletQty,
                        totalWeight: palletWeight,
                        unitWeight: item.unitWeight || 0,
                        productType: item.productType || 'fixed',
                        locationId: 'âš ï¸ ç„¡ç©ºä½',
                        palletNo: palletNo + '/' + item.palletCount,
                        overflow: true
                    });
                    remaining -= palletQty;
                    palletNo++;
                }
            });

            return allocations;
        };

        function findNearestLocation(available, lastLoc) {
            if (!lastLoc || available.length === 0) return available[0];

            var sameZoneRow = available.filter(function(loc) {
                return loc.zone === lastLoc.zone && loc.row === lastLoc.row;
            });
            if (sameZoneRow.length > 0) return sameZoneRow[0];

            var sameZone = available.filter(function(loc) {
                return loc.zone === lastLoc.zone && Math.abs(loc.row - lastLoc.row) <= 2;
            });
            if (sameZone.length > 0) return sameZone[0];

            var anyInZone = available.filter(function(loc) {
                return loc.zone === lastLoc.zone;
            });
            if (anyInZone.length > 0) return anyInZone[0];

            return available[0];
        };

        window.getNextAvailableLocation = function(zone, startRow, startLevel, usedLocations) {
            var available = getFilteredAvailableLocations({
                zones: [zone],
                startRow: startRow,
                usedLocations: usedLocations
            });

            if (available.length === 0) {
                return { locationId: zone + '-XX-XX', nextRow: 99, nextLevel: 1 };
            }

            var loc = available[0];
            return {
                locationId: loc.locationId,
                nextRow: loc.row,
                nextLevel: loc.level
            };
        };

        window.generateContainerLabels = function() {
            var items = window._containerData.items;
            if (items.length === 0) {
                alert('è«‹å…ˆæ–°å¢å“é …');
                return;
            }

            var strategy = document.getElementById('container-strategy').value;

            var selectedZones = [];
            document.querySelectorAll('.container-zone-cb:checked').forEach(function(cb) {
                selectedZones.push(cb.value);
            });

            if (selectedZones.length === 0) {
                alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹å€åŸŸ');
                return;
            }

            var labels = smartAllocateLocations(items, {
                strategy: strategy,
                zones: selectedZones
            });

            var overflowCount = labels.filter(function(l) { return l.overflow; }).length;
            if (overflowCount > 0) {
                alert('è­¦å‘Šï¼šæœ‰ ' + overflowCount + ' æ¿æ‰¾ä¸åˆ°ç©ºä½ï¼\nè«‹è€ƒæ…®æ“´å¤§æœå°‹å€åŸŸã€‚');
            }

            window._containerData.labels = labels;
            renderContainerLabels();

            document.getElementById('btn-print-labels').disabled = false;
            document.getElementById('btn-print-labels').classList.remove('cursor-not-allowed', 'bg-slate-700', 'text-slate-500');
            document.getElementById('btn-print-labels').classList.add('bg-blue-600', 'text-white');
            document.getElementById('btn-confirm-inbound').classList.remove('hidden');
        };

        window.showAvailableLocations = function() {
            var selectedZones = [];
            document.querySelectorAll('.container-zone-cb:checked').forEach(function(cb) {
                selectedZones.push(cb.value);
            });

            if (selectedZones.length === 0) {
                document.getElementById('available-count').innerHTML = '<div class="text-yellow-400">è«‹é¸æ“‡å€åŸŸ</div>';
                return;
            }

            var available = getFilteredAvailableLocations({ zones: selectedZones });

            var zoneMaxRows = { 'A': 8, 'B': 8, 'C': 8, 'D': 8, 'E': 22, 'F': 22, 'G': 22, 'H': 22 };
            var total = 0;
            selectedZones.forEach(function(z) {
                total += (zoneMaxRows[z] || 8) * 5; // æ’æ•¸ x 5å±¤
            });

            var occupied = total - available.length;
            var occupancyRate = total > 0 ? Math.round((occupied / total) * 100) : 0;

            var byZone = {};
            available.forEach(function(loc) {
                byZone[loc.zone] = (byZone[loc.zone] || 0) + 1;
            });

            var zoneInfo = selectedZones.map(function(z) {
                return z + 'å€: ' + (byZone[z] || 0) + 'ç©ºä½';
            }).join(', ');

            document.getElementById('available-count').innerHTML =
                '<div>å¯ç”¨ç©ºä½: <span class="text-white font-bold">' + available.length + '</span> / ' + total + '</div>' +
                '<div>ä½”ç”¨ç‡: <span class="' + (occupancyRate > 80 ? 'text-red-400' : 'text-yellow-400') + '">' + occupancyRate + '%</span></div>' +
                '<div class="text-slate-400 text-[10px] mt-1">' + zoneInfo + '</div>';
        };

        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.container-zone-cb').forEach(function(cb) {
                cb.addEventListener('change', function() {
                    var span = this.nextElementSibling;
                    if (this.checked) {
                        span.classList.remove('bg-slate-700', 'text-slate-400');
                        span.classList.add('bg-blue-600', 'text-white');
                    } else {
                        span.classList.remove('bg-blue-600', 'text-white');
                        span.classList.add('bg-slate-700', 'text-slate-400');
                    }
                    showAvailableLocations();
                });
            });

            setTimeout(function() {
                if (window.showAvailableLocations) showAvailableLocations();
            }, 1000);
        });

        window.renderContainerLabels = function() {
            var container = document.getElementById('container-labels-preview');
            var labels = window._containerData.labels;

            if (labels.length === 0) {
                container.innerHTML = '<div class="col-span-3 text-center text-slate-500 py-8"><i class="fa-solid fa-tags text-3xl mb-2"></i><div>è«‹å…ˆæ–°å¢å“é …</div></div>';
                return;
            }

            var html = '';
            labels.forEach(function(label, idx) {
                var expDisplay = label.expiryDate ? formatDate(label.expiryDate) : '-';

                html += '<div class="bg-white rounded border-2 border-black overflow-hidden" style="aspect-ratio: 297/210;">' +
                    '<div class="border-b-2 border-black p-1 text-center" style="height: 35%;">' +
                    '<div class="font-black text-black leading-tight" style="font-size: clamp(12px, 3vw, 18px);">' + label.productName + '</div>' +
                    '</div>' +
                    '<div class="border-b border-black p-0.5 text-center bg-gray-50" style="height: 15%;">' +
                    '<div class="text-gray-700 font-bold" style="font-size: clamp(8px, 2vw, 12px);">' + (label.spec || '-') + '</div>' +
                    '</div>' +
                    '<div class="border-b border-black grid grid-cols-4 text-center" style="height: 25%;">' +
                    '<div class="border-r border-gray-300 p-0.5">' +
                    '<div class="text-gray-500" style="font-size: 6px;">æ‰¹è™Ÿ</div>' +
                    '<div class="font-bold text-black" style="font-size: clamp(6px, 1.5vw, 9px);">' + label.batchNo + '</div>' +
                    '</div>' +
                    '<div class="border-r border-gray-300 p-0.5">' +
                    '<div class="text-gray-500" style="font-size: 6px;">æ•ˆæœŸ</div>' +
                    '<div class="font-bold text-black" style="font-size: clamp(6px, 1.5vw, 9px);">' + expDisplay + '</div>' +
                    '</div>' +
                    '<div class="border-r border-gray-300 p-0.5">' +
                    '<div class="text-gray-500" style="font-size: 6px;">æ•¸é‡</div>' +
                    '<div class="font-black text-red-600" style="font-size: clamp(8px, 2vw, 14px);">' + label.quantity + '</div>' +
                    '</div>' +
                    '<div class="p-0.5">' +
                    '<div class="text-gray-500" style="font-size: 6px;">å» å•†</div>' +
                    '<div class="font-bold text-black" style="font-size: clamp(6px, 1.5vw, 9px);">' + (label.vendor || '-') + '</div>' +
                    '</div>' +
                    '</div>' +
                    '<div class="flex items-center justify-between px-1" style="height: 25%;">' +
                    '<div class="bg-black text-white font-black px-1.5 py-0.5 rounded" style="font-size: clamp(10px, 2.5vw, 16px);">' + label.locationId + '</div>' +
                    '<div class="text-gray-500 font-mono" style="font-size: clamp(6px, 1.5vw, 10px);">' + label.palletNo + '</div>' +
                    '</div>' +
                    '</div>';
            });

            container.innerHTML = html;
        };

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            var d = new Date(dateStr);
            if (isNaN(d.getTime())) return dateStr;
            return d.getFullYear() + '/' + String(d.getMonth() + 1).padStart(2, '0') + '/' + String(d.getDate()).padStart(2, '0');
        }

        window.printContainerLabels = function() {
            var labels = window._containerData.labels;
            if (labels.length === 0) {
                alert('è«‹å…ˆç”¢ç”Ÿæ£§æ¿æ’å–®');
                return;
            }

            var html = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>æ£§æ¿æ’å–®</title>';
            html += '<style>';
            html += '@page { size: A4 landscape; margin: 0; }';
            html += '* { margin: 0; padding: 0; box-sizing: border-box; }';
            html += 'body { font-family: Microsoft JhengHei, Arial, sans-serif; background: #fff; }';
            html += '.label-page { width: 297mm; height: 210mm; padding: 3mm; box-sizing: border-box; page-break-after: always; overflow: hidden; }';
            html += '.label-page:last-child { page-break-after: auto; }';
            html += '.label-content { height: 100%; border: 3px solid #000; display: flex; flex-direction: column; overflow: hidden; }';
            // ç¬¬ä¸€åˆ—ï¼šQR code 8x8cm + å“å144px (å›ºå®šé«˜åº¦80mm)
            html += '.row-1 { height: 80mm; min-height: 80mm; max-height: 80mm; display: flex; align-items: center; border-bottom: 3px solid #000; padding: 0 8mm; overflow: hidden; }';
            html += '.qr-container { width: 80mm; height: 76mm; flex-shrink: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; }';
            html += '.qr-box { width: 68mm; height: 68mm; }';
            html += '.qr-box svg { width: 100% !important; height: 100% !important; }';
            html += '.qr-label { font-size: 11px; color: #666; margin-top: 1mm; text-align: center; white-space: nowrap; }';
            html += '.product-name { flex: 1; font-size: 144px; font-weight: 900; text-align: center; line-height: 1; overflow: hidden; display: flex; align-items: center; justify-content: center; }';
            // ç¬¬äºŒåˆ—ï¼šè¦æ ¼è‡ªå‹•ç¸®æ”¾ (å›ºå®šé«˜åº¦35mm)
            html += '.row-2 { height: 35mm; min-height: 35mm; max-height: 35mm; display: flex; align-items: center; justify-content: center; border-bottom: 3px solid #000; overflow: hidden; padding: 0 5mm; }';
            html += '.product-spec { font-weight: 700; color: #333; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }';
            // ç¬¬ä¸‰åˆ—ï¼šæ•¸é‡ã€æ‰¹è™Ÿã€æ•ˆæœŸ60px (å›ºå®šé«˜åº¦45mmï¼Œä¸æŠ˜è¡Œ)
            html += '.row-3 { height: 45mm; min-height: 45mm; max-height: 45mm; display: flex; border-bottom: 2px solid #000; }';
            html += '.info-cell { flex: 1; text-align: center; padding: 2mm; border-right: 1px solid #ccc; display: flex; flex-direction: column; justify-content: center; overflow: hidden; }';
            html += '.info-cell:last-child { border-right: none; }';
            html += '.info-label { font-size: 12px; color: #666; margin-bottom: 1mm; }';
            html += '.info-value { font-size: 60px; font-weight: 900; line-height: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }';
            html += '.info-value.qty-val { color: #dc2626; }';
            // ç¬¬å››åˆ—ï¼šå„²ä½36px + å» å•†36px (å‰©é¤˜ç©ºé–“)
            html += '.row-4 { flex: 1; display: flex; align-items: center; padding: 2mm 8mm; min-height: 30mm; }';
            html += '.location-box { background: #000; color: #fff; font-size: 36px; font-weight: 900; padding: 3mm 10mm; margin-right: 10mm; white-space: nowrap; }';
            html += '.vendor-box { font-size: 36px; font-weight: 700; color: #333; flex: 1; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }';
            html += '.no-print { text-align: center; padding: 20px; }';
            html += '.no-print button { padding: 15px 40px; font-size: 18px; border: none; cursor: pointer; font-weight: bold; margin: 0 10px; border-radius: 8px; }';
            html += '.btn-print { background: #059669; color: white; }';
            html += '.btn-close { background: #666; color: white; }';
            html += '@media print { .no-print { display: none !important; } }';
            html += '</style>';
            html += '</head><body>';

            labels.forEach(function(label, idx) {
                var expDisplay = label.expiryDate ? formatDate(label.expiryDate) : '-';
                var specText = label.spec || '-';
                // æ ¹æ“šè¦æ ¼æ–‡å­—é•·åº¦å‹•æ…‹èª¿æ•´å­—é«”å¤§å° 100/80/60/45/36
                var specFontSize = 100;
                if (specText.length > 10) specFontSize = 80;
                if (specText.length > 15) specFontSize = 60;
                if (specText.length > 25) specFontSize = 45;
                if (specText.length > 35) specFontSize = 36;

                html += '<div class="label-page"><div class="label-content">';

                // ç¬¬ä¸€åˆ—ï¼šQR code + å“å
                html += '<div class="row-1">';
                html += '<div class="qr-container"><div id="qrcode-' + idx + '" class="qr-box"></div><div class="qr-label">' + (label.palletNo || label.id) + '</div></div>';
                html += '<div class="product-name">' + label.productName + '</div>';
                html += '</div>';

                // ç¬¬äºŒåˆ—ï¼šè¦æ ¼ (è‡ªå‹•ç¸®æ”¾å­—é«”)
                html += '<div class="row-2"><div class="product-spec" style="font-size:' + specFontSize + 'px;">' + specText + '</div></div>';

                // ç¬¬ä¸‰åˆ—ï¼šæ•¸é‡ã€æ‰¹è™Ÿã€æ•ˆæœŸ
                html += '<div class="row-3">';
                html += '<div class="info-cell"><div class="info-label">æ•¸é‡</div><div class="info-value qty-val">' + label.quantity + '</div></div>';
                html += '<div class="info-cell"><div class="info-label">æ‰¹è™Ÿ</div><div class="info-value">' + (label.batchNo || '-') + '</div></div>';
                html += '<div class="info-cell"><div class="info-label">æ•ˆæœŸ</div><div class="info-value">' + expDisplay + '</div></div>';
                html += '</div>';

                // ç¬¬å››åˆ—ï¼šå„²ä½ã€å» å•†
                html += '<div class="row-4">';
                html += '<div class="location-box">' + label.locationId + '</div>';
                html += '<div class="vendor-box">' + (label.vendor || '-') + '</div>';
                html += '</div>';

                html += '</div></div>';
            });

            html += '<div class="no-print">';
            html += '<button class="btn-print" onclick="window.print()">ğŸ–¨ï¸ åˆ—å°å…¨éƒ¨ ' + labels.length + ' å¼µæ’å–®</button>';
            html += '<button class="btn-close" onclick="window.close()">é—œé–‰</button>';
            html += '</div>';

            html += '<script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"><\/script>';
            html += '<script>window.onload = function() {';
            labels.forEach(function(label, idx) {
                var qrData = label.palletNo || label.id;
                html += 'try { var qr' + idx + ' = qrcode(0, "M"); qr' + idx + '.addData("' + qrData + '"); qr' + idx + '.make(); document.getElementById("qrcode-' + idx + '").innerHTML = qr' + idx + '.createSvgTag(0, 0); } catch(e) { console.error(e); }';
            });
            html += '};<\/script>';

            html += '</body></html>';

            var printWindow = window.open('', '_blank', 'width=1100,height=800');
            printWindow.document.write(html);
            printWindow.document.close();
        };

        window.confirmContainerInbound = async function() {
            var labels = window._containerData.labels;
            if (labels.length === 0) {
                alert('è«‹å…ˆç”¢ç”Ÿæ£§æ¿æ’å–®');
                return;
            }

            if (!confirm('ç¢ºå®šå°‡ ' + labels.length + ' æ¿è²¨ç‰©å…¥åº«ï¼Ÿ\n\nå…¥åº«å¾Œå°‡å»ºç«‹å¯¦éš›åº«å­˜è¨˜éŒ„ã€‚')) return;

            try {
                var batch = window.writeBatch(window.db);

                labels.forEach(function(label) {
                    var palletId = label.id;
                    var docRef = window.doc(window.collection(window.db, 'pallets'), palletId);

                    batch.set(docRef, {
                        palletId: palletId,
                        company: label.company || 'å´‡æ–‡',
                        vendor: label.vendor || '',
                        productName: label.productName,
                        spec: label.spec || '',
                        batchNo: label.batchNo,
                        expiryDate: label.expiryDate ? new Date(label.expiryDate) : null,
                        quantity: label.quantity,
                        totalWeight: label.totalWeight || 0,
                        unitWeight: label.unitWeight || 0,
                        productType: label.productType || 'fixed',
                        locationId: label.locationId,
                        status: 'Active',
                        inboundDate: new Date(),
                        createdAt: new Date()
                    });
                });

                await batch.commit();

                alert('å…¥åº«æˆåŠŸï¼å…± ' + labels.length + ' æ¿');

                window._containerData.items = [];
                window._containerData.labels = [];
                renderContainerItems();
                document.getElementById('container-labels-preview').innerHTML = '<div class="col-span-2 text-center text-slate-500 py-8"><i class="fa-solid fa-tags text-3xl mb-2"></i><div>è«‹å…ˆæ–°å¢å“é …ä¸¦ç”¢ç”Ÿæ’å–®</div></div>';
                document.getElementById('btn-print-labels').disabled = true;
                document.getElementById('btn-confirm-inbound').classList.add('hidden');

            } catch (err) {
                console.error('å…¥åº«å¤±æ•—:', err);
                alert('å…¥åº«å¤±æ•—ï¼š' + err.message);
            }
        };

                function handlePreInboundImport(e) { const file = e.target.files[0]; const reader = new FileReader(); reader.onload = function(evt) { const wb = XLSX.read(evt.target.result, {type:'array'}); const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]); if(confirm(`åŒ¯å…¥ ${json.length} ç­†ï¼Ÿ`)) { const batch = window.writeBatch(window.db); json.forEach((r,i) => { const pid = `PRE-${Date.now()}-${i}`; batch.set(window.doc(window.collection(window.db, "pallets"), pid), { palletId:pid, vendor:r['å» å•†']||'', productName:r['å“å'], spec:r['è¦æ ¼']||'', batchNo:r['æ‰¹è™Ÿ']||'', quantity:r['æ•¸é‡'], locationId:"VIRTUAL-DOCK", status:"Planned", inboundDate:new Date() }); }); batch.commit().then(() => alert("åŒ¯å…¥æˆåŠŸ")); } }; reader.readAsArrayBuffer(file); }
        function generatePlan() {
            const count = document.getElementById('pre-count').value; const name = document.getElementById('pre-name').value; const spec = document.getElementById('pre-spec').value; const batch = document.getElementById('pre-batch').value; const vendor = document.getElementById('pre-vendor').value;
            const area = document.getElementById('preview-area'); area.innerHTML = '';
            document.getElementById('btn-print').disabled = false; document.getElementById('btn-print').classList.remove('cursor-not-allowed', 'bg-slate-700'); document.getElementById('btn-print').classList.add('bg-blue-600', 'text-white');
            for(let i=1; i<=count; i++) { const code = `PRE-${batch}-${i}`; area.innerHTML += `<div class="bg-white p-3 rounded text-black text-xs border border-slate-300"><div class="font-bold text-sm">${name}</div><div>è¦æ ¼: ${spec}</div><div>æ‰¹è™Ÿ: ${batch}</div><div>${vendor}</div><svg id="bc-${i}" class="w-full h-10 mt-1"></svg></div>`; setTimeout(() => JsBarcode(`#bc-${i}`, code, {format:"CODE128", height:30, displayValue:true}), 100); }
        }
        function printLabels() {
            var previewArea = document.getElementById('preview-area');
            if (!previewArea || previewArea.innerHTML.trim() === '') {
                alert('è«‹å…ˆç”¢ç”Ÿæ¨™ç±¤');
                return;
            }
            openPrintPreview(previewArea.innerHTML, 'å…¥åº«æ¨™ç±¤', 900, 700);
        }

        window.deletePallet = async function(id) {
            if(!confirm("ç¢ºå®šåˆªé™¤æ­¤åº«å­˜ï¼Ÿ")) return;

            var pallets = window.currentPallets ? window.currentPallets() : [];
            var pallet = pallets.find(function(p) { return p.id === id; });

            await window.deleteDoc(window.doc(window.db, "pallets", id));

            if (pallet) {
                await window.logInventoryChange({
                    type: 'adjust',
                    company: pallet.company || '',
                    productName: pallet.productName || '',
                    spec: pallet.spec || '',
                    quantity: pallet.quantity || 0,
                    quantityChange: -(pallet.quantity || 0),
                    locationId: pallet.locationId || '',
                    batchNo: pallet.batchNo || '',
                    palletId: pallet.palletId || '',
                    note: 'æ‰‹å‹•åˆªé™¤åº«å­˜'
                });
            }
        }

        window.clearLane = async function(zone, row) {
            if(!confirm(`âš ï¸ è­¦å‘Šï¼šç¢ºå®šæ¸…ç©º [${zone} ç¬¬ ${row} è¡Œ]ï¼Ÿ`)) return;

            const q = window.query(window.collection(window.db, "pallets"), window.where("locationId", ">=", `${zone}-${row < 10 ? '0'+row : row}`), window.where("locationId", "<=", `${zone}-${row < 10 ? '0'+row : row}\uf8ff`));
            const snap = await window.getDocs(q);
            const batch = window.writeBatch(window.db);
            var logPromises = [];

            snap.forEach(function(doc) {
                batch.delete(doc.ref);
                var data = doc.data();
                logPromises.push(window.logInventoryChange({
                    type: 'adjust',
                    company: data.company || '',
                    productName: data.productName || '',
                    spec: data.spec || '',
                    quantity: data.quantity || 0,
                    quantityChange: -(data.quantity || 0),
                    locationId: data.locationId || '',
                    batchNo: data.batchNo || '',
                    palletId: data.palletId || '',
                    note: 'æ¸…ç©ºå··é“: ' + zone + '-' + row
                }));
            });

            await batch.commit();
            await Promise.all(logPromises);
            alert("å··é“å·²æ¸…ç©º");
        }

        window.inventoryCompanyFilter = 'all';

        window.setInventoryCompany = function(company) {
            window.inventoryCompanyFilter = company;

            document.getElementById('btn-inv-all').className = company === 'all'
                ? 'px-3 py-1.5 rounded text-xs font-bold bg-slate-600 text-white'
                : 'px-3 py-1.5 rounded text-xs font-bold bg-slate-700 text-slate-300 hover:bg-slate-600';
            document.getElementById('btn-inv-cw').className = company === 'å´‡æ–‡'
                ? 'px-3 py-1.5 rounded text-xs font-bold bg-blue-600 text-white'
                : 'px-3 py-1.5 rounded text-xs font-bold bg-slate-700 text-slate-300 hover:bg-slate-600';
            document.getElementById('btn-inv-bf').className = company === 'å…«æ–¹'
                ? 'px-3 py-1.5 rounded text-xs font-bold bg-purple-600 text-white'
                : 'px-3 py-1.5 rounded text-xs font-bold bg-slate-700 text-slate-300 hover:bg-slate-600';

            filterInventory();
        };

        function filterInventory() {
            const term = document.getElementById('global-search').value.toLowerCase();
            const companyFilter = window.inventoryCompanyFilter || 'all';

            document.querySelectorAll('#inventory-list-body tr').forEach(row => {
                const matchesTerm = row.innerText.toLowerCase().includes(term);
                const rowCompany = row.getAttribute('data-company') || '';
                const matchesCompany = companyFilter === 'all' || rowCompany === companyFilter;

                row.style.display = (matchesTerm && matchesCompany) ? '' : 'none';
            });
        }
        function downloadTemplate(type) {
            let data = [];
            if(type==='stock') data = [{å“å:'é­·é­š', æ•¸é‡:50, è¦æ ¼:'300/400', æ‰¹è™Ÿ:'B123', æœ‰æ•ˆæ—¥æœŸ:'2025-12-01'}];
            if(type==='pre') data = [{å» å•†:'æµ·ç¥', å“å:'é®­é­š', æ•¸é‡:20, è¦æ ¼:'åˆ‡ç‰‡', æ‰¹è™Ÿ:'B456', æœ‰æ•ˆæ—¥æœŸ:'2025-11-01', é è¨ˆæ¿æ•¸:5, æ¯æ¿æ•¸é‡:50}];
            if(type==='order') data = [{å–®è™Ÿ:'DO-001', å®¢æˆ¶:'æµ·éœ¸ç‹', å“å:'é­·é­š', è¦æ ¼:'300/400', æ•¸é‡:10, æ‰¹è™Ÿ:'B20241209-001', å‚™è¨»:'æ€¥ä»¶', ç‰©æµ:'é»‘è²“'}];
            const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Template"); XLSX.writeFile(wb, `${type}_template.xlsx`);
        }

        // ========== å€‰åº«ç®¡ç†ç³»çµ± ==========

        window.DEFAULT_WAREHOUSES = [
            { code: 'CW-STORE', name: 'é–€å¸‚å€‰', company: 'å´‡æ–‡', type: 'external', icon: 'store', active: true, sortOrder: 1 },
            { code: 'CW-JS1', name: 'æ™¯å±±1è™Ÿ', company: 'å´‡æ–‡', type: 'external', icon: 'building', active: true, sortOrder: 2 },
            { code: 'CW-JS2', name: 'æ™¯å±±2è™Ÿ', company: 'å´‡æ–‡', type: 'external', icon: 'building', active: true, sortOrder: 3 },
            { code: 'CW-QT', name: 'æ´½é€š', company: 'å´‡æ–‡', type: 'external', icon: 'building', active: true, sortOrder: 4 },
            { code: 'CW-YX', name: 'æœ‰èˆˆ', company: 'å´‡æ–‡', type: 'external', icon: 'building', active: true, sortOrder: 5 },
            { code: 'CW-FK', name: 'å¯Œå´‘', company: 'å´‡æ–‡', type: 'external', icon: 'building', active: true, sortOrder: 6 },
            { code: 'CW-PS', name: 'å“é †', company: 'å´‡æ–‡', type: 'external', icon: 'building', active: true, sortOrder: 7 },
            { code: 'BF-STORE', name: 'é–€å¸‚å€‰', company: 'å…«æ–¹', type: 'external', icon: 'store', active: true, sortOrder: 11 },
            { code: 'BF-JS1', name: 'æ™¯å±±1è™Ÿ', company: 'å…«æ–¹', type: 'external', icon: 'building', active: true, sortOrder: 12 },
            { code: 'BF-JS2', name: 'æ™¯å±±2è™Ÿ', company: 'å…«æ–¹', type: 'external', icon: 'building', active: true, sortOrder: 13 },
            { code: 'BF-QT', name: 'æ´½é€š', company: 'å…«æ–¹', type: 'external', icon: 'building', active: true, sortOrder: 14 },
            { code: 'BF-YX', name: 'æœ‰èˆˆ', company: 'å…«æ–¹', type: 'external', icon: 'building', active: true, sortOrder: 15 },
            { code: 'BF-FK', name: 'å¯Œå´‘', company: 'å…«æ–¹', type: 'external', icon: 'building', active: true, sortOrder: 16 },
            { code: 'BF-PS', name: 'å“é †', company: 'å…«æ–¹', type: 'external', icon: 'building', active: true, sortOrder: 17 }
        ];

        window.VIRTUAL_WAREHOUSES = {
            'MAIN': { name: 'ä¸€èˆ¬åº«å­˜', needsLocation: true, icon: 'warehouse' },
            'MAIN-CONSIGN': { name: 'å®¢æˆ¶å¯„å€‰', needsLocation: true, icon: 'box' },
            'MAIN-RESERVE': { name: 'æ¥­å‹™é ç•™', needsLocation: true, icon: 'lock' }
        };

        window.warehousesData = [];

        window.loadWarehouses = async function() {
            try {
                var snapshot = await window.getDocs(window.collection(window.db, 'warehouses'));
                window.warehousesData = [];
                snapshot.forEach(function(doc) {
                    window.warehousesData.push({ id: doc.id, ...doc.data() });
                });

                if (window.warehousesData.length === 0) {
                    await initDefaultWarehouses();
                }

                updateWarehouseDropdown();

            } catch(e) {
                console.error('è¼‰å…¥å€‰åº«è³‡æ–™å¤±æ•—:', e);
                window.warehousesData = window.DEFAULT_WAREHOUSES.map(function(w, i) {
                    return { id: 'default-' + i, ...w };
                });
                updateWarehouseDropdown();
            }
        };

        async function initDefaultWarehouses() {
            for (var w of window.DEFAULT_WAREHOUSES) {
                try {
                    await window.addDoc(window.collection(window.db, 'warehouses'), {
                        ...w,
                        createdAt: new Date().toISOString()
                    });
                } catch(e) {
                    console.error('åˆå§‹åŒ–å€‰åº«å¤±æ•—:', e);
                }
            }
            var snapshot = await window.getDocs(window.collection(window.db, 'warehouses'));
            window.warehousesData = [];
            snapshot.forEach(function(doc) {
                window.warehousesData.push({ id: doc.id, ...doc.data() });
            });
        }

        window.updateWarehouseDropdown = function() {
            var cwGroup = document.getElementById('optgroup-cw');
            var bfGroup = document.getElementById('optgroup-bf');

            if (!cwGroup || !bfGroup) return;

            cwGroup.innerHTML = '';
            bfGroup.innerHTML = '';

            var cwWarehouses = window.warehousesData.filter(function(w) {
                return w.company === 'å´‡æ–‡' && w.active !== false;
            }).sort(function(a, b) { return (a.sortOrder || 99) - (b.sortOrder || 99); });

            var bfWarehouses = window.warehousesData.filter(function(w) {
                return w.company === 'å…«æ–¹' && w.active !== false;
            }).sort(function(a, b) { return (a.sortOrder || 99) - (b.sortOrder || 99); });

            cwWarehouses.forEach(function(w) {
                var opt = document.createElement('option');
                opt.value = w.code;
                var icon = w.icon === 'store' ? 'ğŸª' : 'ğŸ¢';
                opt.textContent = icon + ' å´‡æ–‡_' + w.name;
                cwGroup.appendChild(opt);
            });

            bfWarehouses.forEach(function(w) {
                var opt = document.createElement('option');
                opt.value = w.code;
                var icon = w.icon === 'store' ? 'ğŸª' : 'ğŸ¢';
                opt.textContent = icon + ' å…«æ–¹_' + w.name;
                bfGroup.appendChild(opt);
            });
        };

        window.isExternalWarehouse = function(warehouseId) {
            if (!warehouseId) return false;
            if (warehouseId.startsWith('MAIN')) return false;
            if (warehouseId === 'MANAGE') return false;
            return true;
        };

        window.getWarehouseDisplayName = function(warehouseId) {
            if (!warehouseId) return '';

            if (window.VIRTUAL_WAREHOUSES[warehouseId]) {
                return window.VIRTUAL_WAREHOUSES[warehouseId].name;
            }

            var wh = window.warehousesData.find(function(w) { return w.code === warehouseId; });
            if (wh) {
                return wh.company + '_' + wh.name;
            }

            return warehouseId;
        };

        window.onWarehouseChange = function() {
            var warehouseId = document.getElementById('in-warehouse').value;

            if (warehouseId === 'MANAGE') {
                document.getElementById('in-warehouse').value = 'MAIN'; // é‡ç½®é¸å–®
                openWarehouseManager();
                return;
            }

            var isExternal = isExternalWarehouse(warehouseId);

            var locSection = document.getElementById('location-section');
            var extSection = document.getElementById('external-wh-section');

            if (locSection) locSection.style.display = isExternal ? 'none' : 'flex';
            if (extSection) extSection.style.display = isExternal ? 'flex' : 'none';

            if (isExternal) {
                var displayName = getWarehouseDisplayName(warehouseId);
                var titleEl = document.getElementById('inbound-wh-title');
                if (titleEl) {
                    titleEl.innerHTML = '<span class="bg-cyan-500 text-white px-2 py-1 rounded mr-2">2</span><i class="fa-solid fa-building mr-2 text-cyan-400"></i>' + displayName + ' å…¥åº«';
                }
            }

            updateLivePreview();
        };

        window.onInboundTypeChange = function() {
            var select = document.getElementById('in-type-select');
            if (!select) return;
            var mode = select.value;
            document.getElementById('in-category').value = mode;
            updateLivePreview();
        };

        window.setInboundMode = function(mode) {
            const elem = document.getElementById('in-category');
            if (elem) elem.value = mode;

            ['raw', 'fg', 'wip', 'ret'].forEach(m => {
                const btn = document.getElementById('btn-mode-' + m);
                if (btn) {
                    btn.classList.remove('bg-blue-600', 'bg-purple-600', 'bg-orange-600', 'bg-cyan-600');
                    btn.classList.add('bg-slate-700');
                }
            });

            const colors = {
                'raw': 'bg-blue-600',
                'fg': 'bg-purple-600',
                'wip': 'bg-orange-600',
                'ret': 'bg-cyan-600'
            };

            const activeBtn = document.getElementById('btn-mode-' + mode.toLowerCase());
            if (activeBtn) {
                activeBtn.classList.remove('bg-slate-700');
                activeBtn.classList.add(colors[mode.toLowerCase()] || 'bg-blue-600');
            }

            updateLivePreview();
        };

        window.generateSheetId = function() {
            const date = new Date();
            const year = date.getFullYear().toString().slice(-2);
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            const random = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
            return 'PRE-' + year + month + day + '-' + random;
        };

        window.autoFillBarcode = function() {
            const sheetInput = document.getElementById('in-sheet-id');

            if (sheetInput && !sheetInput.value) {
                sheetInput.value = window.generateSheetId();
                alert('âœ… å·²ç”Ÿæˆæ’å–®ç·¨è™Ÿï¼š' + sheetInput.value + '\n\nè«‹å°‡æ­¤ç·¨è™Ÿåˆ—å°è²¼åœ¨æ£§æ¿ä¸Š');
            } else if (sheetInput && sheetInput.value) {
                alert('âš ï¸ æ’å–®ç·¨è™Ÿå·²å­˜åœ¨ï¼š' + sheetInput.value);
            }
        };

        // ===== ç°¡åŒ–ç‰ˆæ¿è™Ÿç§»å‹•åŠŸèƒ½ =====

        window.selectedPallet = null;
        window.currentFilter = '';

        window.renderPalletList = function() {
            var container = document.getElementById('pallet-list');
            if (!container) return;

            var inventory = window.currentInventory ? window.currentInventory() : [];
            var filtered = window.currentFilter
                ? inventory.filter(function(item) { return item.productName === window.currentFilter; })
                : inventory;

            if (filtered.length === 0) {
                container.innerHTML = '<div class="text-center text-slate-400 py-8">ç„¡å„²ä½è³‡æ–™</div>';
                return;
            }

            var zones = { 'I-A': [], 'I-B': [], 'J-C': [], 'J-D': [] };
            filtered.forEach(function(item) {
                var parsed = parseLocationId(item.locationId);
                if (parsed && zones[parsed.zone]) {
                    zones[parsed.zone].push(item);
                }
            });

            var zoneNames = { 'I-A': 'Aå€', 'I-B': 'Bå€', 'J-C': 'Cå€', 'J-D': 'Då€' };
            var html = '';

            for (var zoneKey in zones) {
                var items = zones[zoneKey];
                if (items.length === 0 && window.currentFilter) continue;

                html += '<div class="mb-3 border border-slate-600 rounded">';
                html += '<div class="bg-slate-800 px-3 py-2 font-bold text-white">' + zoneNames[zoneKey] + '</div>';

                if (items.length === 0) {
                    html += '<div class="p-3 text-slate-500 text-sm">æ­¤å€ç„¡å„²ä½</div>';
                } else {
                    items.forEach(function(item) {
                        var bg = 'bg-blue-900/30 border-blue-500';
                        if (item.category === 'FG') bg = 'bg-green-900/30 border-green-500';
                        if (item.category === 'WIP') bg = 'bg-yellow-900/30 border-yellow-500';

                        html += '<div class="' + bg + ' border m-2 p-2 rounded cursor-pointer hover:bg-opacity-70" ';
                        html += 'onclick="selectPallet(\'' + item.id + '\', \'' + item.locationId + '\', \'' + item.productName + '\', ' + (item.quantity || 0) + ')">';
                        html += '<div class="flex justify-between items-start">';
                        html += '<div><div class="text-white font-bold">' + item.locationId + '</div>';
                        html += '<div class="text-slate-300 text-sm">' + item.productName + '</div></div>';
                        html += '<div class="text-white font-bold text-lg">' + (item.quantity || 0) + ' ä»¶</div>';
                        html += '</div>';
                        html += '<div class="text-xs text-slate-400 mt-1">æ¿è™Ÿ: ' + item.palletId + '</div>';
                        html += '</div>';
                    });
                }
                html += '</div>';
            }

            container.innerHTML = html;
        };

        window.selectPallet = function(id, location, product, quantity) {
            window.selectedPallet = { id: id, location: location, product: product, quantity: quantity };

            var panel = document.getElementById('operation-panel');
            if (!panel) return;

            var inventory = window.currentInventory ? window.currentInventory() : [];
            var sameProduct = inventory.filter(function(item) {
                return item.productName === product && item.id !== id;
            });

            var html = '<div class="space-y-3">';
            html += '<div class="bg-slate-900 border border-slate-700 rounded p-3">';
            html += '<div class="text-xs text-slate-400 mb-2">å·²é¸æ“‡ï¼š</div>';
            html += '<div class="text-white font-bold">' + location + '</div>';
            html += '<div class="text-slate-300">' + product + '</div>';
            html += '<div class="text-white font-bold text-lg">' + quantity + ' ä»¶</div>';
            html += '</div>';

            html += '<div><div class="text-white font-bold text-sm mb-2">è«‹é¸æ“‡æ“ä½œï¼š</div>';
            html += '<button onclick="showMoveOptions()" class="w-full p-3 bg-emerald-700 text-white rounded mb-2 hover:bg-emerald-600">';
            html += '<i class="fa-solid fa-arrow-right mr-2"></i>ç§»å‹•åˆ°å…¶ä»–å„²ä½</button>';

            if (sameProduct.length > 0) {
                html += '<button onclick="showMergeOptions()" class="w-full p-3 bg-yellow-700 text-white rounded hover:bg-yellow-600">';
                html += '<i class="fa-solid fa-layer-group mr-2"></i>åˆä½µï¼ˆæ‰¾åˆ° ' + sameProduct.length + ' å€‹ç›¸åŒå“åï¼‰</button>';
            }
            html += '</div></div>';

            panel.innerHTML = html;
        };

        window.showMoveOptions = function() {
            var panel = document.getElementById('operation-panel');
            if (!panel) return;

            var html = '<div class="space-y-2">';
            html += '<button onclick="selectPallet(null)" class="text-sm text-blue-400 hover:text-blue-300">';
            html += '<i class="fa-solid fa-arrow-left mr-1"></i>è¿”å›</button>';
            html += '<div class="text-white font-bold mb-2">è¼¸å…¥ç›®æ¨™å„²ä½ï¼š</div>';
            html += '<input type="text" id="target-location" class="w-full p-2 bg-slate-800 text-white rounded border border-slate-600" ';
            html += 'placeholder="ä¾‹å¦‚: I-A-05-2F">';
            html += '<button onclick="executeMove()" class="w-full p-3 bg-blue-600 text-white rounded hover:bg-blue-500 mt-3">';
            html += 'ç¢ºèªç§»å‹•</button>';
            html += '</div>';

            panel.innerHTML = html;
        };

        window.showMergeOptions = function() {
            var panel = document.getElementById('operation-panel');
            if (!panel) return;

            var source = window.selectedPallet;
            var inventory = window.currentInventory ? window.currentInventory() : [];
            var targets = inventory.filter(function(item) {
                return item.productName === source.product && item.id !== source.id;
            });

            var html = '<div class="space-y-2">';
            html += '<button onclick="selectPallet(null)" class="text-sm text-blue-400 hover:text-blue-300">';
            html += '<i class="fa-solid fa-arrow-left mr-1"></i>è¿”å›</button>';
            html += '<div class="text-white font-bold mb-2">é¸æ“‡åˆä½µç›®æ¨™ï¼š</div>';

            targets.forEach(function(target) {
                html += '<div class="p-2 bg-slate-800 border border-slate-600 rounded cursor-pointer hover:border-yellow-500" ';
                html += 'onclick="executeMerge(\'' + target.id + '\', ' + (target.quantity || 0) + ')">';
                html += '<div class="flex justify-between">';
                html += '<div class="text-white">' + target.locationId + '</div>';
                html += '<div class="text-white font-bold">' + (target.quantity || 0) + ' ä»¶</div>';
                html += '</div>';
                html += '<div class="text-xs text-green-400 mt-1">åˆä½µå¾Œ: ' + (source.quantity + (target.quantity || 0)) + ' ä»¶</div>';
                html += '</div>';
            });

            html += '</div>';
            panel.innerHTML = html;
        };

        window.executeMove = async function() {
            var source = window.selectedPallet;
            var targetLoc = document.getElementById('target-location');
            if (!source || !targetLoc || !targetLoc.value) {
                alert('è«‹è¼¸å…¥ç›®æ¨™å„²ä½');
                return;
            }

            var newLoc = targetLoc.value.trim();
            if (!confirm('ç¢ºå®šå°‡ ' + source.location + ' ç§»å‹•åˆ° ' + newLoc + 'ï¼Ÿ')) return;

            try {
                await window.updateDoc(window.doc(window.db, "pallets", source.id), { locationId: newLoc });
                alert('âœ… ç§»å‹•æˆåŠŸï¼');
                window.selectedPallet = null;
                renderPalletList();
                document.getElementById('operation-panel').innerHTML = '<div class="text-center text-slate-400 py-8">è«‹é¸æ“‡æ£§æ¿</div>';
            } catch (err) {
                console.error(err);
                alert('âŒ ç§»å‹•å¤±æ•—: ' + err.message);
            }
        };

        window.executeMerge = async function(targetId, targetQty) {
            var source = window.selectedPallet;
            if (!source) return;

            var totalQty = source.quantity + targetQty;
            if (!confirm('ç¢ºå®šåˆä½µï¼Ÿ\nåˆä½µå¾Œç¸½æ•¸: ' + totalQty + ' ä»¶')) return;

            try {
                var pallets = window.currentPallets ? window.currentPallets() : [];
                var targetPallet = pallets.find(function(p) { return p.id === targetId; });

                var batch = window.writeBatch(window.db);
                batch.update(window.doc(window.db, "pallets", targetId), { quantity: totalQty });
                batch.delete(window.doc(window.db, "pallets", source.id));
                await batch.commit();

                await window.logInventoryChange({
                    type: 'merge',
                    company: source.company || '',
                    productName: source.productName,
                    spec: source.spec || '',
                    quantity: totalQty,
                    quantityChange: source.quantity,
                    locationId: targetPallet ? targetPallet.locationId : '',
                    fromLocation: source.locationId,
                    toLocation: targetPallet ? targetPallet.locationId : '',
                    batchNo: source.batchNo || '',
                    palletId: targetPallet ? targetPallet.palletId : targetId,
                    note: 'åˆä½µ: ' + source.palletId + '(' + source.quantity + 'ä»¶)'
                });

                alert('âœ… åˆä½µæˆåŠŸï¼');
                window.selectedPallet = null;
                renderPalletList();
                document.getElementById('operation-panel').innerHTML = '<div class="text-center text-slate-400 py-8">è«‹é¸æ“‡æ£§æ¿</div>';
            } catch (err) {
                console.error(err);
                alert('âŒ åˆä½µå¤±æ•—: ' + err.message);
            }
        };

        window.updateProductFilter = function() {
            var select = document.getElementById('product-filter');
            if (!select) return;

            var inventory = window.currentInventory ? window.currentInventory() : [];
            var products = {};
            inventory.forEach(function(item) {
                if (item.productName) products[item.productName] = true;
            });

            var html = '<option value="">-- å…¨éƒ¨é¡¯ç¤º --</option>';
            Object.keys(products).sort().forEach(function(name) {
                html += '<option value="' + name + '">' + name + '</option>';
            });
            select.innerHTML = html;
        };

        window.filterByProduct = function() {
            var select = document.getElementById('product-filter');
            window.currentFilter = select ? select.value : '';
            renderPalletList();
        };

        // ===== æ™ºèƒ½èª¿åº¦ç³»çµ± v4 =====

        window.dispatchTasks = [];
        window.selectedProduct = null;
        window.analysisData = null;

        window.analyzeDispersion = function() {
            var inventory = window.currentInventory ? window.currentInventory() : [];

            var productGroups = {};
            inventory.forEach(function(item) {
                var name = item.productName;
                if (!productGroups[name]) {
                    productGroups[name] = [];
                }
                productGroups[name].push(item);
            });

            var analysis = [];
            for (var name in productGroups) {
                var items = productGroups[name];

                var lanes = {};
                var totalQty = 0;
                items.forEach(function(item) {
                    var parsed = parseLocationId(item.locationId);
                    var lane = parsed ? parsed.laneKey : '';
                    if (!lane) return;
                    if (!lanes[lane]) {
                        lanes[lane] = { qty: 0, count: 0 };
                    }
                    lanes[lane].qty += (item.quantity || 0);
                    lanes[lane].count++;
                    totalQty += (item.quantity || 0);
                });

                var laneList = Object.keys(lanes);
                var laneCount = laneList.length;
                var isolatedCount = 0;  // å­¤ç«‹ç¾¤çµ„æ•¸ï¼ˆåªæœ‰1å€‹å„²ä½çš„ç¾¤çµ„ï¼‰
                var groupedCount = 0;   // é›†ä¸­ç¾¤çµ„æ•¸ï¼ˆæœ‰2+å€‹å„²ä½çš„ç¾¤çµ„ï¼‰

                laneList.forEach(function(lane) {
                    if (lanes[lane].count < 2) {
                        isolatedCount++;
                    } else {
                        groupedCount++;
                    }
                });

                if (isolatedCount === 0) continue;

                var avgQty = totalQty / items.length;

                analysis.push({
                    productName: name,
                    locationCount: items.length,
                    laneCount: laneCount,
                    isolatedCount: isolatedCount,  // å­¤ç«‹ç¾¤çµ„æ•¸
                    groupedCount: groupedCount,    // é›†ä¸­ç¾¤çµ„æ•¸
                    totalQty: totalQty,
                    avgQty: Math.round(avgQty),
                    lanes: lanes,
                    items: items
                });
            }

            analysis.sort(function(a, b) {
                if (b.isolatedCount !== a.isolatedCount) return b.isolatedCount - a.isolatedCount;
                return b.laneCount - a.laneCount;
            });

            window.analysisData = analysis;
            return analysis;
        };

        window.renderDispersionRanking = function() {
            var container = document.getElementById('dispersion-ranking');
            if (!container) return;

            var analysis = window.analyzeDispersion();

            if (analysis.length === 0) {
                container.innerHTML = '<div class="text-green-400 text-sm p-3"><i class="fa-solid fa-check-circle mr-2"></i>æ‰€æœ‰å“é …å·²é›†ä¸­å­˜æ”¾ï¼ˆç„¡å­¤ç«‹å„²ä½ï¼‰ï¼Œç„¡éœ€èª¿åº¦</div>';
                return;
            }

            var html = '';
            analysis.forEach(function(item, index) {
                var priority = 'ğŸ”´';
                var bgColor = 'bg-red-900/20 border-red-600';
                if (item.isolatedCount === 2) {
                    priority = 'ğŸŸ¡';
                    bgColor = 'bg-yellow-900/20 border-yellow-600';
                } else if (item.isolatedCount === 1) {
                    priority = 'ğŸŸ¢';
                    bgColor = 'bg-green-900/20 border-green-600';
                }

                html += '<div class="' + bgColor + ' border rounded p-3 mb-2 cursor-pointer hover:bg-opacity-40" ';
                html += 'onclick="selectProductForDispatch(\'' + item.productName + '\')">';
                html += '<div class="flex justify-between items-start mb-1">';
                html += '<div class="text-white font-bold">' + priority + ' ' + item.productName + '</div>';
                html += '<div class="text-xs text-slate-400">#' + (index + 1) + '</div>';
                html += '</div>';
                html += '<div class="text-sm text-slate-300"><span class="text-red-400 font-bold">' + item.isolatedCount + '</span> å€‹å­¤ç«‹å„²ä½éœ€èª¿åº¦</div>';
                html += '<div class="text-xs text-slate-500">' + item.laneCount + ' å··é“ / ' + item.locationCount + ' å„²ä½</div>';
                html += '<div class="text-sm text-slate-300 mt-1">ç¸½è¨ˆ <span class="text-white font-bold">' + item.totalQty + '</span> ä»¶</div>';
                html += '</div>';
            });

            container.innerHTML = html;
        };

        window.selectProductForDispatch = function(productName) {
            window.selectedProduct = productName;

            var data = window.analysisData.find(function(item) {
                return item.productName === productName;
            });

            if (!data) return;

            renderProductStats(data);

            var suggestion = generateSmartSuggestion(data);

            renderVisualMap(data, suggestion);
        };

        window.renderProductStats = function(data) {
            var container = document.getElementById('product-stats');
            if (!container) return;

            var distribution = {};
            data.items.forEach(function(item) {
                var parsed = parseLocationId(item.locationId);
                var zone = parsed ? parsed.zoneChar : '?'; // A, B, C, D
                if (!distribution[zone]) distribution[zone] = 0;
                distribution[zone]++;
            });

            var distText = '';
            for (var zone in distribution) {
                distText += zone + 'å€:' + distribution[zone] + ' ';
            }

            var html = '<div class="bg-slate-800 border border-slate-600 rounded p-3">';
            html += '<div class="text-white font-bold mb-2">ğŸ“Š ' + data.productName + ' çµ±è¨ˆ</div>';
            html += '<div class="text-sm text-slate-300 space-y-1">';
            html += '<div>â€¢ ç¸½æ•¸é‡: <span class="text-white font-bold">' + data.totalQty + '</span> ä»¶</div>';
            html += '<div>â€¢ å„²ä½æ•¸: <span class="text-yellow-400 font-bold">' + data.locationCount + '</span> å€‹</div>';
            html += '<div>â€¢ å¹³å‡: <span class="text-white font-bold">' + data.avgQty + '</span> ä»¶/ä½</div>';
            html += '<div>â€¢ åˆ†ä½ˆ: <span class="text-blue-400">' + distText + '</span></div>';
            html += '</div></div>';

            container.innerHTML = html;
        };

        window.generateSmartSuggestion = function(data) {
            var inventory = window.currentInventory ? window.currentInventory() : [];

            // ===== å»ºç«‹ç¾¤çµ„ï¼šåŒä¸€å··é“çš„å„²ä½æ­¸ç‚ºä¸€çµ„ =====
            var groups = {};  // { 'I-A01': { qty: 500, count: 3, items: [...] }, ... }

            data.items.forEach(function(item) {
                var parsed = parseLocationId(item.locationId);
                var lane = parsed ? parsed.laneKey : ''; // å¦‚ I-A01
                if (!lane) return;
                if (!groups[lane]) {
                    groups[lane] = { qty: 0, count: 0, items: [] };
                }
                groups[lane].qty += (item.quantity || 0);
                groups[lane].count++;
                groups[lane].items.push(item);
            });

            var groupList = Object.keys(groups).map(function(lane) {
                return {
                    lane: lane,
                    qty: groups[lane].qty,
                    count: groups[lane].count,  // ç¾¤çµ„å…§å„²ä½æ•¸
                    items: groups[lane].items
                };
            }).sort(function(a, b) {
                if (b.qty !== a.qty) return b.qty - a.qty;
                return b.count - a.count;
            });

            // ===== åˆ†é¡ç¾¤çµ„ =====
            var keepGroups = [];    // ä¿ç•™çš„ç¾¤çµ„ï¼ˆé›†ä¸­å­˜æ”¾ï¼‰
            var moveGroups = [];    // éœ€èª¿åº¦çš„ç¾¤çµ„ï¼ˆå­¤ç«‹å„²ä½ï¼‰

            groupList.forEach(function(g) {
                if (g.count >= 2) {
                    keepGroups.push(g);
                } else {
                    moveGroups.push(g);
                }
            });

            if (moveGroups.length === 0) {
                return {
                    keep: data.items,
                    move: [],
                    suggestions: [],
                    freedSpaces: 0,
                    targetLane: groupList[0] ? groupList[0].lane : null,
                    heatMap: groupList,
                    groups: { keep: keepGroups, move: moveGroups },
                    message: 'âœ… æ‰€æœ‰å“é …å·²é›†ä¸­å­˜æ”¾ï¼ˆç„¡å­¤ç«‹å„²ä½ï¼‰ï¼Œç„¡éœ€èª¿åº¦'
                };
            }

            if (keepGroups.length === 0) {
                var targetGroup = groupList[0];
                keepGroups = [targetGroup];
                moveGroups = groupList.slice(1);

                if (moveGroups.length === 0) {
                    return {
                        keep: data.items,
                        move: [],
                        suggestions: [],
                        freedSpaces: 0,
                        targetLane: targetGroup.lane,
                        heatMap: groupList,
                        groups: { keep: keepGroups, move: moveGroups },
                        message: 'âœ… åƒ…æœ‰å–®ä¸€å„²ä½ï¼Œç„¡éœ€èª¿åº¦'
                    };
                }
            }

            // ===== ç›®æ¨™å··é“ = æœ€å¤§ç¾¤çµ„ï¼ˆæ•¸é‡æœ€å¤šï¼‰ =====
            var targetGroup = keepGroups[0];
            var targetLane = targetGroup.lane;

            var keepItems = [];
            keepGroups.forEach(function(g) {
                keepItems = keepItems.concat(g.items);
            });

            var moveItems = [];
            moveGroups.forEach(function(g) {
                moveItems = moveItems.concat(g.items);
            });

            // ===== è¨ˆç®—ç›®æ¨™å··é“çš„å¯ç”¨ç©ºä½ =====
            function getLaneEmptySlots(lanePrefix) {
                var laneItems = inventory.filter(function(item) {
                    return item.locationId && item.locationId.startsWith(lanePrefix);
                });
                var usedSlots = { '3F': 0, '2F': 0, '1F': 0 };
                laneItems.forEach(function(item) {
                    var parsed = parseLocationId(item.locationId);
                    var level = parsed ? parsed.level : '';
                    if (usedSlots[level] !== undefined) usedSlots[level]++;
                });
                var emptySlots = [];
                for (var j = usedSlots['3F']; j < 8; j++) emptySlots.push(lanePrefix + '-3F');
                for (var j = usedSlots['2F']; j < 5; j++) emptySlots.push(lanePrefix + '-2F');
                for (var j = usedSlots['1F']; j < 16; j++) emptySlots.push(lanePrefix + '-1F');
                return emptySlots;
            }

            // ===== ç”Ÿæˆèª¿åº¦å»ºè­° =====
            var suggestions = [];
            var emptySlots = getLaneEmptySlots(targetLane);
            var slotIndex = 0;

            moveItems.forEach(function(moveItem) {
                var parsed = parseLocationId(moveItem.locationId);
                var fromLane = parsed ? parsed.laneKey : '';
                var fromGroup = groups[fromLane];

                if (slotIndex < emptySlots.length) {
                    suggestions.push({
                        from: moveItem,
                        fromLane: fromLane,
                        fromGroupSize: fromGroup ? fromGroup.count : 1,
                        toLocation: emptySlots[slotIndex],
                        toLane: targetLane,
                        toGroupSize: targetGroup.count,
                        quantity: moveItem.quantity || 0,
                        reason: 'å­¤ç«‹(' + (fromGroup ? fromGroup.count : 1) + 'å„²ä½) â†’ é›†ä¸­(' + targetGroup.count + 'å„²ä½)'
                    });
                    slotIndex++;
                } else {
                    suggestions.push({
                        from: moveItem,
                        fromLane: fromLane,
                        toLocation: 'ç„¡å¯ç”¨ç©ºä½',
                        toLane: targetLane + ' (å·²æ»¿)',
                        quantity: moveItem.quantity || 0,
                        noSpace: true,
                        reason: 'ç›®æ¨™å··é“å·²æ»¿'
                    });
                }
            });

            return {
                keep: keepItems,
                move: moveItems,
                suggestions: suggestions,
                freedSpaces: suggestions.filter(function(s) { return !s.noSpace; }).length,
                targetLane: targetLane,
                targetHeat: targetGroup.qty,
                targetGroupSize: targetGroup.count,
                heatMap: groupList,
                groups: { keep: keepGroups, move: moveGroups }
            };
        };

        window.renderVisualMap = function(data, suggestion) {
            var container = document.getElementById('visual-map');
            if (!container) return;

            var html = '<div class="space-y-3">';

            if (suggestion.message) {
                html += '<div class="bg-green-900/30 border border-green-600 rounded-lg p-6 text-center">';
                html += '<i class="fa-solid fa-check-circle text-4xl text-green-400 mb-3"></i>';
                html += '<div class="text-green-300 font-bold text-lg">' + suggestion.message + '</div>';
                html += '<div class="text-slate-400 text-sm mt-2">ç›®æ¨™å··é“ï¼š<span class="text-white font-bold">' + (suggestion.targetLane || '-') + '</span></div>';
                html += '</div>';
                html += '</div>';
                container.innerHTML = html;
                window.currentSuggestion = suggestion;
                return;
            }

            // ===== ç¾¤çµ„ç†±åŠ›åœ–é¡¯ç¤º =====
            html += '<div class="bg-slate-800/50 border border-slate-600 rounded-lg p-3 mb-3">';
            html += '<div class="text-white font-bold mb-2"><i class="fa-solid fa-layer-group text-orange-400 mr-2"></i>å··é“ç¾¤çµ„åˆ†æ</div>';
            html += '<div class="flex flex-wrap gap-2">';

            if (suggestion.heatMap) {
                var maxHeat = suggestion.heatMap[0] ? suggestion.heatMap[0].qty : 1;
                suggestion.heatMap.forEach(function(h, idx) {
                    var heatPercent = Math.round((h.qty / maxHeat) * 100);
                    var isIsolated = h.count < 2;  // å­¤ç«‹ç¾¤çµ„
                    var isTarget = suggestion.groups && suggestion.groups.keep.length > 0 && suggestion.groups.keep[0].lane === h.lane;
                    var borderClass = isTarget ? 'ring-2 ring-yellow-400' : (isIsolated ? 'ring-1 ring-red-400' : '');
                    var bgClass = isIsolated ? 'bg-red-900/50' : 'bg-slate-700';

                    html += '<div class="relative group">';
                    html += '<div class="' + borderClass + ' ' + bgClass + ' rounded p-2 text-center min-w-[90px]">';
                    html += '<div class="text-xs text-slate-400 mb-1">' + h.lane + '</div>';
                    html += '<div class="h-2 bg-slate-600 rounded overflow-hidden mb-1">';
                    html += '<div class="h-full ' + (isIsolated ? 'bg-red-500' : 'bg-green-500') + '" style="width:' + heatPercent + '%"></div>';
                    html += '</div>';
                    html += '<div class="text-white font-bold text-sm">' + h.qty + 'ä»¶</div>';
                    html += '<div class="text-xs ' + (isIsolated ? 'text-red-400' : 'text-green-400') + '">' + h.count + 'å„²ä½</div>';
                    if (isTarget) {
                        html += '<div class="text-[10px] text-yellow-400 mt-1">ğŸ¯ ç›®æ¨™ç¾¤çµ„</div>';
                    } else if (isIsolated) {
                        html += '<div class="text-[10px] text-red-400 mt-1">âš ï¸ å­¤ç«‹</div>';
                    } else {
                        html += '<div class="text-[10px] text-green-400 mt-1">âœ… é›†ä¸­</div>';
                    }
                    html += '</div>';
                    html += '</div>';
                });
            }
            html += '</div>';
            html += '<div class="text-xs text-slate-500 mt-2"><i class="fa-solid fa-info-circle mr-1"></i>ç¾¤çµ„è¦å‰‡ï¼šâ‰¥2å„²ä½=é›†ä¸­(ç¶ )ã€1å„²ä½=å­¤ç«‹(ç´…)éœ€èª¿åº¦</div>';
            html += '</div>';

            html += '<div class="flex justify-between items-center mb-3">';
            html += '<div class="text-white font-bold">ğŸ“ èª¿åº¦æ–¹æ¡ˆ <span class="text-sm text-slate-400">(ç›®æ¨™: ' + suggestion.targetLane + ' / ' + (suggestion.targetGroupSize || 0) + 'å„²ä½)</span></div>';
            html += '<div class="flex items-center gap-3">';
            html += '<label class="flex items-center gap-2 text-sm text-slate-300 cursor-pointer">';
            html += '<input type="checkbox" id="select-all-tasks" checked onchange="toggleAllTasks(this.checked)" class="w-4 h-4 rounded">';
            html += '<span>å…¨é¸</span>';
            html += '</label>';
            html += '<span id="selected-count" class="text-xs text-blue-400">å·²é¸ ' + suggestion.suggestions.filter(function(s){return !s.noSpace}).length + ' é …</span>';
            html += '</div>';
            html += '</div>';

            html += '<div class="mb-3 bg-green-900/20 border border-green-600/50 rounded p-3">';
            html += '<div class="text-green-400 text-sm font-bold mb-2">âœ… é›†ä¸­ç¾¤çµ„ä¿ç•™ï¼ˆ' + suggestion.keep.length + 'å„²ä½ï¼‰</div>';
            html += '<div class="flex flex-wrap gap-2">';
            suggestion.keep.forEach(function(item) {
                html += '<div class="bg-green-900/50 border border-green-600 rounded px-2 py-1 text-sm">';
                html += '<span class="text-white font-bold">' + item.locationId + '</span>';
                html += '<span class="text-green-300 ml-2">' + (item.quantity || 0) + 'ä»¶</span>';
                html += '</div>';
            });
            html += '</div></div>';

            html += '<div class="mb-3">';
            html += '<div class="text-red-400 text-sm font-bold mb-2">âš ï¸ å­¤ç«‹å„²ä½èª¿åº¦ï¼ˆ' + suggestion.suggestions.length + 'é …ï¼‰â†’ é›†ä¸­ç¾¤çµ„</div>';
            html += '<div class="space-y-2" id="task-list">';

            suggestion.suggestions.forEach(function(sug, index) {
                var isDisabled = sug.noSpace;
                var borderColor = isDisabled ? 'border-slate-600' : 'border-red-600/50';
                var bgColor = isDisabled ? 'bg-slate-800/30' : 'bg-red-900/20';
                var opacity = isDisabled ? 'opacity-50' : '';

                html += '<div class="' + bgColor + ' border ' + borderColor + ' rounded p-3 ' + opacity + '" data-task-index="' + index + '">';
                html += '<div class="flex items-center gap-3">';

                if (!isDisabled) {
                    html += '<input type="checkbox" checked class="task-checkbox w-5 h-5 rounded cursor-pointer" data-index="' + index + '" onchange="updateTaskSelection()">';
                } else {
                    html += '<div class="w-5 h-5 rounded bg-red-900/50 flex items-center justify-center"><i class="fa-solid fa-ban text-red-400 text-xs"></i></div>';
                }

                html += '<div class="flex-1 flex items-center justify-between">';
                html += '<div class="flex items-center gap-2">';
                html += '<span class="text-white font-bold">' + sug.from.locationId + '</span>';
                html += '<span class="text-slate-400">(' + sug.quantity + 'ä»¶)</span>';
                html += '</div>';
                html += '<i class="fa-solid fa-arrow-right text-slate-500"></i>';
                html += '<div class="text-right">';
                if (isDisabled) {
                    html += '<span class="text-red-400">ç„¡ç©ºä½</span>';
                } else {
                    html += '<span class="text-green-400 font-bold">' + sug.toLocation + '</span>';
                }
                html += '</div>';
                html += '</div>';
                html += '</div>';
                html += '</div>';
            });

            html += '</div></div>';

            html += '<div class="bg-blue-900/20 border border-blue-600/50 rounded p-3" id="effect-preview">';
            html += '<div class="text-blue-400 font-bold mb-2">ğŸ“ˆ é æœŸæ•ˆæœ</div>';
            html += '<div class="text-sm text-slate-300 grid grid-cols-3 gap-2">';
            var validCount = suggestion.suggestions.filter(function(s){return !s.noSpace}).length;
            html += '<div>é‡‹æ”¾ <span class="text-yellow-400 font-bold" id="effect-spaces">' + validCount + '</span> ç©ºä½</div>';
            html += '<div>æ¸›å°‘ <span class="text-green-400 font-bold" id="effect-percent">' + Math.round(validCount / data.locationCount * 100) + '%</span></div>';
            html += '<div>åŸ·è¡Œ <span class="text-white font-bold" id="effect-tasks">' + validCount + '</span> æ¬¡</div>';
            html += '</div></div>';

            html += '<div class="mt-4 flex gap-2">';
            html += '<button onclick="generateDispatchOrder()" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white py-2 px-4 rounded font-bold" id="btn-generate">';
            html += '<i class="fa-solid fa-file-lines mr-2"></i>ç”Ÿæˆèª¿åº¦å–® (<span id="btn-count">' + validCount + '</span>é …)';
            html += '</button>';
            html += '<button onclick="cancelDispatch()" class="bg-slate-700 hover:bg-slate-600 text-white py-2 px-4 rounded">';
            html += 'å–æ¶ˆ';
            html += '</button>';
            html += '</div>';

            html += '</div>';

            container.innerHTML = html;

            window.currentSuggestion = suggestion;
            window.currentData = data;
        };

        window.toggleAllTasks = function(checked) {
            var checkboxes = document.querySelectorAll('.task-checkbox');
            checkboxes.forEach(function(cb) {
                cb.checked = checked;
            });
            updateTaskSelection();
        };

        window.updateTaskSelection = function() {
            var checkboxes = document.querySelectorAll('.task-checkbox');
            var checkedCount = 0;
            var total = checkboxes.length;

            checkboxes.forEach(function(cb) {
                if (cb.checked) checkedCount++;
            });

            var countEl = document.getElementById('selected-count');
            if (countEl) countEl.textContent = 'å·²é¸ ' + checkedCount + ' é …';

            var btnCount = document.getElementById('btn-count');
            if (btnCount) btnCount.textContent = checkedCount;

            var effectSpaces = document.getElementById('effect-spaces');
            if (effectSpaces) effectSpaces.textContent = checkedCount;

            var effectTasks = document.getElementById('effect-tasks');
            if (effectTasks) effectTasks.textContent = checkedCount;

            var effectPercent = document.getElementById('effect-percent');
            if (effectPercent && window.currentData) {
                effectPercent.textContent = Math.round(checkedCount / window.currentData.locationCount * 100) + '%';
            }

            var selectAll = document.getElementById('select-all-tasks');
            if (selectAll) {
                selectAll.checked = checkedCount === total;
                selectAll.indeterminate = checkedCount > 0 && checkedCount < total;
            }

            var btnGenerate = document.getElementById('btn-generate');
            if (btnGenerate) {
                btnGenerate.disabled = checkedCount === 0;
                btnGenerate.className = checkedCount === 0
                    ? 'flex-1 bg-slate-600 text-slate-400 py-2 px-4 rounded font-bold cursor-not-allowed'
                    : 'flex-1 bg-blue-600 hover:bg-blue-500 text-white py-2 px-4 rounded font-bold';
            }
        };

        window.generateDispatchOrder = function() {
            if (!window.currentSuggestion || !window.selectedProduct) {
                alert('è«‹å…ˆé¸æ“‡å“åä¸¦æŸ¥çœ‹å»ºè­°');
                return;
            }

            var suggestion = window.currentSuggestion;
            var product = window.selectedProduct;

            var selectedIndices = [];
            var checkboxes = document.querySelectorAll('.task-checkbox');
            checkboxes.forEach(function(cb) {
                if (cb.checked) {
                    selectedIndices.push(parseInt(cb.getAttribute('data-index')));
                }
            });

            if (selectedIndices.length === 0) {
                alert('è«‹è‡³å°‘é¸æ“‡ä¸€é …èª¿åº¦ä»»å‹™');
                return;
            }

            var selectedSuggestions = [];
            selectedIndices.forEach(function(idx) {
                var sug = suggestion.suggestions[idx];
                if (sug && !sug.noSpace) {
                    selectedSuggestions.push(sug);
                }
            });

            if (selectedSuggestions.length === 0) {
                alert('æ²’æœ‰å¯åŸ·è¡Œçš„èª¿åº¦ä»»å‹™');
                return;
            }

            var orderNo = 'DSP-' + Date.now().toString().slice(-6);
            var timestamp = new Date().toLocaleString('zh-TW');

            var tasks = [];
            selectedSuggestions.forEach(function(sug, index) {
                tasks.push({
                    taskNo: index + 1,
                    fromLocation: sug.from.locationId,
                    fromPalletId: sug.from.palletId,
                    toLocation: sug.toLocation,
                    toLane: sug.toLane,
                    quantity: sug.quantity,
                    status: 'pending'
                });
            });

            var previewData = {
                orderNo: orderNo,
                productName: product,
                createdAt: timestamp,
                tasks: tasks,
                totalTasks: tasks.length
            };

            showDispatchPreview(previewData);
        };

        window.showDispatchPreview = function(previewData) {
            var modal = document.getElementById('dispatch-preview-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'dispatch-preview-modal';
                modal.className = 'fixed inset-0 bg-black/70 flex items-center justify-center z-50';
                document.body.appendChild(modal);
            }

            var html = '<div class="bg-slate-800 rounded-lg p-6 max-w-3xl w-full mx-4 max-h-[85vh] overflow-y-auto">';

            html += '<div class="flex justify-between items-start mb-4">';
            html += '<div>';
            html += '<h2 class="text-2xl font-bold text-white">ğŸ“‹ èª¿åº¦å–®é è¦½</h2>';
            html += '<div class="text-slate-400 text-sm mt-1">è«‹ç¢ºèªç„¡èª¤å¾Œå†ç”Ÿæˆæ­£å¼èª¿åº¦å–®</div>';
            html += '</div>';
            html += '<button onclick="closePreviewModal()" class="text-slate-400 hover:text-white text-2xl">&times;</button>';
            html += '</div>';

            html += '<div class="bg-gradient-to-r from-blue-900 to-blue-800 border border-blue-600 rounded-lg p-4 mb-4">';
            html += '<div class="grid grid-cols-3 gap-4 text-sm">';
            html += '<div><div class="text-blue-300 mb-1">èª¿åº¦å–®ç·¨è™Ÿ</div><div class="text-white font-bold">' + previewData.orderNo + '</div></div>';
            html += '<div><div class="text-blue-300 mb-1">å“å</div><div class="text-white font-bold">' + previewData.productName + '</div></div>';
            html += '<div><div class="text-blue-300 mb-1">ç”Ÿæˆæ™‚é–“</div><div class="text-white font-bold">' + previewData.createdAt + '</div></div>';
            html += '</div></div>';

            html += '<div class="mb-4">';
            html += '<div class="flex justify-between items-center mb-3">';
            html += '<h3 class="text-white font-bold">ğŸ“¦ ä»»å‹™æ¸…å–®ï¼ˆå…± ' + previewData.totalTasks + ' é …ï¼‰</h3>';
            html += '<div class="text-xs text-slate-400">ğŸ’¡ æç¤ºï¼šå¯ä»¥èª¿æ•´åŸ·è¡Œé †åº</div>';
            html += '</div>';

            html += '<div class="space-y-2">';
            previewData.tasks.forEach(function(task, index) {
                html += '<div class="bg-slate-900 border border-slate-700 rounded-lg p-4 hover:border-blue-500 transition-all">';

                html += '<div class="flex justify-between items-start mb-3">';
                html += '<div class="flex items-center gap-3">';
                html += '<div class="bg-blue-900 text-blue-300 px-3 py-1 rounded font-bold text-sm">ä»»å‹™ ' + task.taskNo + '</div>';

                if (index > 0) {
                    html += '<button onclick="moveTaskUp(' + index + ')" class="text-slate-400 hover:text-white text-xs px-2 py-1 bg-slate-800 rounded" title="ä¸Šç§»">';
                    html += '<i class="fa-solid fa-arrow-up"></i></button>';
                }
                if (index < previewData.totalTasks - 1) {
                    html += '<button onclick="moveTaskDown(' + index + ')" class="text-slate-400 hover:text-white text-xs px-2 py-1 bg-slate-800 rounded" title="ä¸‹ç§»">';
                    html += '<i class="fa-solid fa-arrow-down"></i></button>';
                }
                html += '</div>';

                html += '<button onclick="removeTask(' + index + ')" class="text-red-400 hover:text-red-300 text-xs px-2 py-1 bg-slate-800 rounded" title="ç§»é™¤æ­¤ä»»å‹™">';
                html += '<i class="fa-solid fa-trash mr-1"></i>ç§»é™¤</button>';
                html += '</div>';

                html += '<div class="grid grid-cols-4 gap-3">';

                html += '<div class="col-span-1">';
                html += '<div class="text-xs text-slate-400 mb-1">ğŸ“ ä¾†æºå„²ä½</div>';
                html += '<div class="text-white font-bold text-sm">' + task.fromLocation + '</div>';
                html += '<div class="text-xs text-slate-500 mt-1">æ¿è™Ÿï¼š' + task.fromPalletId + '</div>';
                html += '</div>';

                html += '<div class="col-span-1 flex items-center justify-center">';
                html += '<div class="text-slate-500">';
                html += '<i class="fa-solid fa-arrow-right text-2xl"></i>';
                html += '<div class="text-xs mt-1">' + task.quantity + ' ä»¶</div>';
                html += '</div>';
                html += '</div>';

                html += '<div class="col-span-1">';
                html += '<div class="text-xs text-slate-400 mb-1">ğŸ¯ ç›®æ¨™å„²ä½</div>';
                html += '<div class="text-green-400 font-bold text-sm">' + task.toLocation + '</div>';
                html += '<div class="text-xs text-green-600 mt-1">åˆä½µåˆ°æ­¤</div>';
                html += '</div>';

                html += '<div class="col-span-1">';
                html += '<div class="text-xs text-slate-400 mb-1">â±ï¸ é ä¼°æ™‚é–“</div>';
                html += '<div class="text-yellow-400 font-bold text-sm">~5 åˆ†é˜</div>';
                html += '<div class="text-xs text-slate-500 mt-1">å«ç§»å‹•æ™‚é–“</div>';
                html += '</div>';

                html += '</div>';
                html += '</div>';
            });
            html += '</div>';
            html += '</div>';

            html += '<div class="bg-gradient-to-r from-purple-900/30 to-blue-900/30 border border-purple-600/50 rounded-lg p-4 mb-4">';
            html += '<div class="text-purple-300 font-bold mb-2">ğŸ“Š åŸ·è¡Œæ‘˜è¦</div>';
            html += '<div class="grid grid-cols-3 gap-4 text-sm">';
            html += '<div>';
            html += '<div class="text-slate-400">ç¸½ä»»å‹™æ•¸</div>';
            html += '<div class="text-white font-bold text-xl">' + previewData.totalTasks + ' é …</div>';
            html += '</div>';
            html += '<div>';
            html += '<div class="text-slate-400">é ä¼°ç¸½æ™‚é•·</div>';
            html += '<div class="text-yellow-400 font-bold text-xl">~' + (previewData.totalTasks * 5) + ' åˆ†é˜</div>';
            html += '</div>';
            html += '<div>';
            html += '<div class="text-slate-400">é‡‹æ”¾ç©ºä½</div>';
            html += '<div class="text-green-400 font-bold text-xl">' + previewData.totalTasks + ' å€‹</div>';
            html += '</div>';
            html += '</div>';
            html += '</div>';

            html += '<div class="bg-blue-900/20 border border-blue-600/50 rounded-lg p-4 mb-4">';
            html += '<div class="text-blue-400 font-bold mb-2">ğŸ“± PDA ç«¯åŸ·è¡Œæµç¨‹</div>';
            html += '<div class="space-y-2 text-sm text-slate-300">';
            html += '<div class="flex items-start gap-2">';
            html += '<div class="bg-blue-600 text-white w-5 h-5 rounded-full flex items-center justify-center text-xs flex-shrink-0 mt-0.5">1</div>';
            html += '<div>å †é«˜æ©Ÿå¸æ©Ÿçš„ PDA æœƒæ”¶åˆ°æ¨é€é€šçŸ¥</div>';
            html += '</div>';
            html += '<div class="flex items-start gap-2">';
            html += '<div class="bg-blue-600 text-white w-5 h-5 rounded-full flex items-center justify-center text-xs flex-shrink-0 mt-0.5">2</div>';
            html += '<div>PDA é¡¯ç¤ºç¬¬ä¸€å€‹ä»»å‹™ï¼šã€Œè«‹å‰å¾€ ' + previewData.tasks[0].fromLocation + 'ã€</div>';
            html += '</div>';
            html += '<div class="flex items-start gap-2">';
            html += '<div class="bg-blue-600 text-white w-5 h-5 rounded-full flex items-center justify-center text-xs flex-shrink-0 mt-0.5">3</div>';
            html += '<div>å¸æ©Ÿåˆ°é”å¾Œæƒææ£§æ¿æ¢ç¢¼ â†’ <span class="text-green-400 font-bold">å—¶ï¼ç¢ºèªæ­£ç¢º</span></div>';
            html += '</div>';
            html += '<div class="flex items-start gap-2">';
            html += '<div class="bg-blue-600 text-white w-5 h-5 rounded-full flex items-center justify-center text-xs flex-shrink-0 mt-0.5">4</div>';
            html += '<div>è¼‰è²¨ç§»å‹•åˆ° ' + previewData.tasks[0].toLocation + 'ï¼Œæƒæå„²ä½ â†’ <span class="text-green-400 font-bold">å—¶ï¼ä»»å‹™å®Œæˆ</span></div>';
            html += '</div>';
            html += '<div class="flex items-start gap-2">';
            html += '<div class="bg-blue-600 text-white w-5 h-5 rounded-full flex items-center justify-center text-xs flex-shrink-0 mt-0.5">5</div>';
            html += '<div>è‡ªå‹•é¡¯ç¤ºä¸‹ä¸€å€‹ä»»å‹™ï¼Œé‡è¤‡æ­¥é©Ÿ 3-4</div>';
            html += '</div>';
            html += '<div class="flex items-start gap-2">';
            html += '<div class="bg-blue-600 text-white w-5 h-5 rounded-full flex items-center justify-center text-xs flex-shrink-0 mt-0.5">6</div>';
            html += '<div>æ‰€æœ‰ä»»å‹™å®Œæˆå¾Œï¼ŒPDA é¡¯ç¤ºã€ŒğŸ‰ èª¿åº¦å–®å®Œæˆï¼ã€</div>';
            html += '</div>';
            html += '</div>';
            html += '</div>';

            html += '<div class="flex gap-3">';
            html += '<button onclick="confirmAndGenerate()" class="flex-1 bg-gradient-to-r from-green-600 to-green-500 hover:from-green-500 hover:to-green-400 text-white py-3 px-6 rounded-lg font-bold text-lg shadow-lg">';
            html += '<i class="fa-solid fa-check-circle mr-2"></i>ç¢ºèªç„¡èª¤ï¼Œæ­£å¼ç”Ÿæˆ';
            html += '</button>';
            html += '<button onclick="closePreviewModal()" class="bg-slate-700 hover:bg-slate-600 text-white py-3 px-6 rounded-lg">';
            html += '<i class="fa-solid fa-times mr-2"></i>å–æ¶ˆ';
            html += '</button>';
            html += '</div>';

            html += '</div>';

            modal.innerHTML = html;
            modal.classList.remove('hidden');

            window.currentPreviewData = previewData;
        };

        window.confirmAndGenerate = async function() {
            if (!window.currentPreviewData) return;

            var previewData = window.currentPreviewData;

            var order = {
                orderNo: previewData.orderNo,
                productName: previewData.productName,
                createdAt: previewData.createdAt,
                tasks: previewData.tasks,
                operations: previewData.tasks.map(function(t, idx) {
                    return {
                        id: 'op-' + idx,
                        type: t.toLane ? 'åˆä½µ' : 'ç§»ä½',
                        from: t.fromLocation,
                        palletId: t.fromPalletId,
                        to: t.toLocation,
                        qty: t.quantity
                    };
                }),
                totalTasks: previewData.tasks.length,
                completedTasks: 0,
                completedOps: [],
                status: 'pending',
                createdBy: window.getOperatorName ? window.getOperatorName() : 'system'
            };

            try {
                await window.addDoc(window.collection(window.db, 'dispatchOrders'), order);
            } catch (err) {
                console.error('å­˜åˆ° Firebase å¤±æ•—:', err);
            }

            if (!window.dispatchOrders) window.dispatchOrders = [];
            window.dispatchOrders.push(order);

            closePreviewModal();

            setTimeout(function() {
                alert('âœ… èª¿åº¦å–®å·²ç”Ÿæˆï¼\n\nç·¨è™Ÿï¼š' + order.orderNo + '\nä»»å‹™æ•¸ï¼š' + order.totalTasks + ' é …\n\nğŸ“± æ‰‹æ©Ÿç‰ˆå·²åŒæ­¥ï¼Œå †é«˜æ©Ÿæ‰‹å¯ç«‹å³åŸ·è¡Œ');
                showDispatchOrder(order);
            }, 300);
        };

        window.closePreviewModal = function() {
            var modal = document.getElementById('dispatch-preview-modal');
            if (modal) modal.classList.add('hidden');
        };

        window.moveTaskUp = function(index) {
            if (!window.currentPreviewData || index === 0) return;
            var tasks = window.currentPreviewData.tasks;
            var temp = tasks[index];
            tasks[index] = tasks[index - 1];
            tasks[index - 1] = temp;
            tasks.forEach(function(task, i) {
                task.taskNo = i + 1;
            });
            showDispatchPreview(window.currentPreviewData);
        };

        window.moveTaskDown = function(index) {
            if (!window.currentPreviewData || index === window.currentPreviewData.tasks.length - 1) return;
            var tasks = window.currentPreviewData.tasks;
            var temp = tasks[index];
            tasks[index] = tasks[index + 1];
            tasks[index + 1] = temp;
            tasks.forEach(function(task, i) {
                task.taskNo = i + 1;
            });
            showDispatchPreview(window.currentPreviewData);
        };

        window.removeTask = function(index) {
            if (!window.currentPreviewData) return;
            if (!confirm('ç¢ºå®šè¦ç§»é™¤æ­¤ä»»å‹™å—ï¼Ÿ')) return;
            window.currentPreviewData.tasks.splice(index, 1);
            window.currentPreviewData.totalTasks = window.currentPreviewData.tasks.length;
            window.currentPreviewData.tasks.forEach(function(task, i) {
                task.taskNo = i + 1;
            });
            if (window.currentPreviewData.tasks.length === 0) {
                alert('æ‰€æœ‰ä»»å‹™å·²ç§»é™¤');
                closePreviewModal();
                return;
            }
            showDispatchPreview(window.currentPreviewData);
        };

        window.showDispatchOrder = function(order) {
            var modal = document.getElementById('dispatch-order-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'dispatch-order-modal';
                modal.className = 'fixed inset-0 bg-black/70 flex items-center justify-center z-50';
                document.body.appendChild(modal);
            }

            var html = '<div class="bg-slate-800 rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">';
            html += '<div class="flex justify-between items-start mb-4">';
            html += '<div>';
            html += '<h2 class="text-2xl font-bold text-white">ğŸ“‹ èª¿åº¦å–® ' + order.orderNo + '</h2>';
            html += '<div class="text-slate-400 text-sm mt-1">å“åï¼š' + order.productName + ' | ç”Ÿæˆæ™‚é–“ï¼š' + order.createdAt + '</div>';
            html += '</div>';
            html += '<button onclick="closeDispatchOrderModal()" class="text-slate-400 hover:text-white text-2xl">&times;</button>';
            html += '</div>';

            html += '<div class="space-y-3 mb-4">';
            order.tasks.forEach(function(task) {
                var statusIcon = 'â±ï¸';
                var statusText = 'å¾…åŸ·è¡Œ';
                var statusColor = 'text-yellow-400';

                if (task.status === 'completed') {
                    statusIcon = 'âœ…';
                    statusText = 'å·²å®Œæˆ';
                    statusColor = 'text-green-400';
                }

                html += '<div class="bg-slate-900 border border-slate-700 rounded p-3">';
                html += '<div class="flex justify-between items-start mb-2">';
                html += '<div class="text-white font-bold">ä»»å‹™ ' + task.taskNo + '</div>';
                html += '<div class="' + statusColor + ' text-sm">' + statusIcon + ' ' + statusText + '</div>';
                html += '</div>';
                html += '<div class="grid grid-cols-3 gap-2 text-sm">';
                html += '<div><div class="text-slate-400">å¾</div><div class="text-white font-bold">' + task.fromLocation + '</div></div>';
                html += '<div class="text-center"><div class="text-slate-400">æ•¸é‡</div><div class="text-yellow-400 font-bold">' + task.quantity + ' ä»¶</div></div>';
                html += '<div class="text-right"><div class="text-slate-400">åˆ°</div><div class="text-white font-bold">' + task.toLocation + '</div></div>';
                html += '</div>';
                html += '<div class="text-xs text-slate-500 mt-2">æ¿è™Ÿï¼š' + task.fromPalletId + '</div>';
                html += '</div>';
            });
            html += '</div>';

            html += '<div class="bg-blue-900/30 border border-blue-600 rounded p-3 mb-4">';
            html += '<div class="text-blue-400 font-bold mb-1">ğŸ“± PDA ç«¯æ“ä½œæµç¨‹</div>';
            html += '<div class="text-sm text-slate-300 space-y-1">';
            html += '<div>1ï¸âƒ£ å †é«˜æ©Ÿå¸æ©Ÿ PDA æœƒæ”¶åˆ°æ­¤èª¿åº¦å–®</div>';
            html += '<div>2ï¸âƒ£ å¸æ©ŸæŒ‰é †åºåŸ·è¡Œæ¯å€‹ä»»å‹™</div>';
            html += '<div>3ï¸âƒ£ åˆ°é”ä¾†æºä½ â†’ æƒææ£§æ¿ (å—¶ï¼ç¢ºèª)</div>';
            html += '<div>4ï¸âƒ£ åˆ°é”ç›®æ¨™ä½ â†’ æƒæå„²ä½ (å—¶ï¼å®Œæˆ)</div>';
            html += '<div>5ï¸âƒ£ ç³»çµ±è‡ªå‹•æ›´æ–°å®Œæˆç‹€æ…‹</div>';
            html += '</div></div>';

            html += '<div class="flex gap-2">';
            html += '<button onclick="alert(\'è«‹ä½¿ç”¨æ™ºèƒ½èª¿åº¦ä¸­å¿ƒçš„åˆ—å°åŠŸèƒ½\')" class="flex-1 bg-green-600 hover:bg-green-500 text-white py-2 px-4 rounded">';
            html += '<i class="fa-solid fa-print mr-2"></i>åˆ—å°èª¿åº¦å–®</button>';
            html += '<button onclick="closeDispatchOrderModal()" class="bg-slate-700 hover:bg-slate-600 text-white py-2 px-4 rounded">é—œé–‰</button>';
            html += '</div>';

            html += '</div>';

            modal.innerHTML = html;
            modal.classList.remove('hidden');
        };

        window.closeDispatchOrderModal = function() {
            var modal = document.getElementById('dispatch-order-modal');
            if (modal) modal.classList.add('hidden');
        };

        window.cancelDispatch = function() {
            window.selectedProduct = null;
            window.currentSuggestion = null;
            var el = document.getElementById('dispatch-detail-panel');
            if (el) {
                el.innerHTML = '<div class="text-center text-slate-500 py-16"><i class="fa-solid fa-hand-pointer text-6xl mb-4 opacity-30"></i><p class="text-lg">è«‹å¾å·¦å´é¸æ“‡å“é …</p></div>';
            }
        };

        window.initSmartDispatch = function() {
            console.log('initSmartDispatch è¢«å‘¼å« - è‡ªå‹•é–‹å§‹åˆ†æ');
            startDispatchAnalysis();
        };

        // ========== èª¿åº¦ä¸­å¿ƒæ­¥é©Ÿæ§åˆ¶ï¼ˆç°¡åŒ–ç‰ˆï¼‰==========
        window.currentDispatchStep = 2; // ç›´æ¥åˆ°æ­¥é©Ÿ 2ï¼ˆé¸æ“‡å·¥å–®ï¼‰

        window.goToDispatchStep = function(step) {
            console.log('goToDispatchStep è¢«å‘¼å«, step =', step);
            document.querySelectorAll('.dispatch-step').forEach(function(el) {
                el.classList.add('hidden');
            });

            var targetStep = document.getElementById('dispatch-step-' + step);
            if (targetStep) targetStep.classList.remove('hidden');

            for (var i = 1; i <= 3; i++) {
                var indicator = document.getElementById('step-' + i + '-indicator');
                if (!indicator) continue;

                if (i < step) {
                    indicator.className = 'flex items-center gap-2 px-4 py-2 rounded-lg bg-emerald-600 text-white';
                    indicator.querySelector('div').className = 'w-7 h-7 rounded-full bg-white text-emerald-600 flex items-center justify-center font-bold';
                } else if (i === step) {
                    indicator.className = 'flex items-center gap-2 px-4 py-2 rounded-lg bg-blue-600 text-white';
                    indicator.querySelector('div').className = 'w-7 h-7 rounded-full bg-white text-blue-600 flex items-center justify-center font-bold';
                } else {
                    indicator.className = 'flex items-center gap-2 px-4 py-2 rounded-lg bg-slate-700 text-slate-400';
                    indicator.querySelector('div').className = 'w-7 h-7 rounded-full bg-slate-600 text-slate-400 flex items-center justify-center font-bold';
                }
            }

            window.currentDispatchStep = step;
        };

        window.startDispatchAnalysis = function() {
            document.getElementById('analysis-loading').classList.remove('hidden');

            setTimeout(function() {
                refreshDispatchAnalysis();
            }, 500);
        };

        window.refreshDispatchAnalysis = function() {
            console.log('é–‹å§‹èª¿åº¦åˆ†æ...');
            var pallets = window.currentPallets ? window.currentPallets() : [];
            console.log('å–å¾—åº«å­˜è³‡æ–™:', pallets ? pallets.length : 0, 'ç­†');

            if (!pallets || pallets.length === 0) {
                document.getElementById('dispatch-orders-container').innerHTML = '<div class="text-slate-500 text-center py-8 bg-slate-900/50 border border-slate-700 rounded-lg"><i class="fa-solid fa-database text-4xl mb-3 opacity-30"></i><p>ç„¡åº«å­˜è³‡æ–™</p><p class="text-xs mt-2">è«‹å…ˆè¼‰å…¥åº«å­˜è³‡æ–™</p></div>';
                return;
            }

            var productGroups = {};
            var skippedCount = 0;
            pallets.forEach(function(p) {
                if (!p.locationId) { skippedCount++; return; }
                var zone = p.locationId.split('-')[0];
                if (zone !== 'I' && zone !== 'J' && zone !== 'K') { skippedCount++; return; }

                var parsed = parseLocationId(p.locationId);
                var laneKey = parsed ? parsed.laneKey : p.locationId;

                var key = p.productName + '|' + (p.spec || '');
                if (!productGroups[key]) {
                    productGroups[key] = {
                        name: p.productName,
                        spec: p.spec || '',
                        items: [],
                        locations: new Set(),
                        lanes: new Set(),  // å··é“ï¼ˆå¦‚ I-A-01ï¼‰
                        zones: new Set(),  // å„²å€ï¼ˆå¦‚ I, J, Kï¼‰
                        totalQty: 0
                    };
                }
                productGroups[key].items.push(p);
                productGroups[key].locations.add(p.locationId);
                productGroups[key].lanes.add(laneKey);
                productGroups[key].zones.add(zone);
                productGroups[key].totalQty += (p.quantity || 0);
            });

            var dispatchItems = [];
            var optimized = 0;
            var totalMoveOps = 0;
            var totalMergeOps = 0;
            var totalPartialOps = 0;

            Object.values(productGroups).forEach(function(g) {
                var laneCount = g.lanes.size;  // å··é“æ•¸
                var locCount = g.locations.size;

                // ========== å–å¾—å“é …çš„æ¿å®¹é‡è¨­å®šï¼ˆæ–¹æ¡ˆ A+Dï¼‰==========
                var productConfig = window.getProductPalletCapacity ? window.getProductPalletCapacity(g.name, g.spec) : null;
                var palletCapacity = null;
                var partialPercent = 50;
                var useAutoDetect = false;

                if (productConfig) {
                    palletCapacity = productConfig.palletCapacity;
                    partialPercent = productConfig.partialThreshold || 50;
                } else {
                    useAutoDetect = true;
                    var maxQty = 0;
                    g.items.forEach(function(p) {
                        if ((p.quantity || 0) > maxQty) maxQty = p.quantity;
                    });
                    palletCapacity = maxQty > 0 ? Math.ceil(maxQty * 1.1) : 45;
                }

                var partialThresholdQty = Math.floor(palletCapacity * partialPercent / 100);

                var laneGroups = {};
                g.items.forEach(function(p) {
                    var parsed = parseLocationId(p.locationId);
                    if (parsed) {
                        var laneKey = parsed.laneKey;
                        if (!laneGroups[laneKey]) laneGroups[laneKey] = { qty: 0, palletCount: 0, items: [] };
                        laneGroups[laneKey].qty += (p.quantity || 0);
                        laneGroups[laneKey].palletCount++;
                        laneGroups[laneKey].items.push(p);
                    }
                });

                var laneList = Object.keys(laneGroups);

                var mainLane = null;
                if (laneList.length > 0) {
                    mainLane = laneList.sort(function(a, b) {
                        return laneGroups[b].qty - laneGroups[a].qty;
                    })[0];
                }

                // ========== ç¬¬ä¸€æ­¥ï¼šé¤˜æ¿åˆä½µå»ºè­° ==========
                var partialMerges = [];

                var partialPallets = g.items.filter(function(p) {
                    var qty = p.quantity || 0;
                    return qty > 0 && qty < partialThresholdQty;
                });

                if (partialPallets.length > 1) {
                    partialPallets.sort(function(a, b) {
                        var qtyDiff = (b.quantity || 0) - (a.quantity || 0);
                        if (qtyDiff !== 0) return qtyDiff;
                        var batchA = a.batchNo || '';
                        var batchB = b.batchNo || '';
                        if (batchA !== batchB) return batchA.localeCompare(batchB);
                        var expA = a.expDate || a.expiryDate || '9999';
                        var expB = b.expDate || b.expiryDate || '9999';
                        return expA.localeCompare(expB);
                    });

                    var used = new Set();

                    for (var i = 0; i < partialPallets.length; i++) {
                        if (used.has(i)) continue;

                        var keepPallet = partialPallets[i];
                        var currentTotal = keepPallet.quantity || 0;
                        var mergeGroup = {
                            keep: {
                                palletId: keepPallet.palletId,
                                location: keepPallet.locationId,
                                qty: keepPallet.quantity,
                                batchNo: keepPallet.batchNo,
                                expDate: keepPallet.expDate || keepPallet.expiryDate
                            },
                            sources: []
                        };

                        used.add(i);

                        for (var j = i + 1; j < partialPallets.length; j++) {
                            if (used.has(j)) continue;

                            var sourcePallet = partialPallets[j];
                            var newTotal = currentTotal + (sourcePallet.quantity || 0);

                            if (newTotal <= palletCapacity) {
                                mergeGroup.sources.push({
                                    palletId: sourcePallet.palletId,
                                    location: sourcePallet.locationId,
                                    qty: sourcePallet.quantity,
                                    batchNo: sourcePallet.batchNo,
                                    expDate: sourcePallet.expDate || sourcePallet.expiryDate
                                });
                                currentTotal = newTotal;
                                used.add(j);
                            }
                        }

                        if (mergeGroup.sources.length > 0) {
                            mergeGroup.totalAfterMerge = currentTotal;
                            mergeGroup.freedLocations = mergeGroup.sources.length;
                            mergeGroup.palletCapacity = palletCapacity;
                            mergeGroup.useAutoDetect = useAutoDetect;
                            partialMerges.push(mergeGroup);
                        }
                    }
                }

                // ========== ç¬¬äºŒæ­¥ï¼šå­¤ç«‹æ¿ç§»ä½å»ºè­° ==========
                var isolatedMoves = [];

                if (laneList.length >= 3 && mainLane) {
                    var mainLaneQty = laneGroups[mainLane].qty;
                    var totalQty = g.totalQty;

                    var mainWarehouse = mainLane.split('-')[0];

                    var mainLaneOccupied = new Set();
                    laneGroups[mainLane].items.forEach(function(item) {
                        mainLaneOccupied.add(item.locationId);
                    });

                    var mainLaneParts = mainLane.split('-');
                    var mainZone = mainLaneParts[0];
                    var mainRow = mainLaneParts[1];
                    var mainCol = mainLaneParts[2];

                    var levelPriority = ['2F', '3F', '1F'];
                    var availableSlots = [];
                    levelPriority.forEach(function(level) {
                        var slotId = mainZone + '-' + mainRow + '-' + mainCol + '-' + level;
                        if (!mainLaneOccupied.has(slotId)) {
                            var isOccupiedByOthers = pallets.some(function(p) {
                                return p.locationId === slotId;
                            });
                            if (!isOccupiedByOthers) {
                                availableSlots.push(slotId);
                            }
                        }
                    });

                    if (availableSlots.length === 0) {
                    } else {
                        var slotIndex = 0;

                        laneList.forEach(function(lane) {
                            if (lane === mainLane) return;

                            var laneData = laneGroups[lane];
                            var laneWarehouse = lane.split('-')[0];

                            var isReallyIsolated = laneData.palletCount === 1;
                            var isDifferentWarehouse = laneWarehouse !== mainWarehouse;

                            if (isReallyIsolated || (isDifferentWarehouse && laneData.palletCount <= 2)) {
                                if (slotIndex < availableSlots.length) {
                                    laneData.items.forEach(function(p) {
                                        if (slotIndex >= availableSlots.length) return;

                                        var targetSlot = availableSlots[slotIndex];
                                        slotIndex++;

                                        var reason = isReallyIsolated ?
                                            'å­¤ç«‹æ¿(åƒ…1æ¿)' :
                                            'è·¨å€(' + laneWarehouse + 'â†’' + mainWarehouse + ')';

                                        isolatedMoves.push({
                                            type: 'isolated',
                                            palletId: p.palletId,
                                            from: p.locationId,
                                            fromLane: lane,
                                            toLane: mainLane,
                                            toSlot: targetSlot,
                                            qty: p.quantity,
                                            batchNo: p.batchNo,
                                            expDate: p.expDate || p.expiryDate,
                                            reason: reason
                                        });
                                    });
                                }
                            }
                        });
                    }
                }

                totalPartialOps += partialMerges.length;
                totalMoveOps += isolatedMoves.length;

                if (partialMerges.length === 0 && isolatedMoves.length === 0) {
                    optimized++;
                    return;
                }

                var priority = 'low';
                if (partialMerges.length >= 2 || isolatedMoves.length >= 3) priority = 'high';
                else if (partialMerges.length >= 1 || isolatedMoves.length >= 1) priority = 'medium';

                dispatchItems.push({
                    name: g.name,
                    spec: g.spec,
                    totalQty: g.totalQty,
                    laneCount: laneCount,
                    locCount: locCount,
                    mainLane: mainLane,
                    partialMerges: partialMerges,    // ç¬¬ä¸€æ­¥ï¼šé¤˜æ¿åˆä½µ
                    isolatedMoves: isolatedMoves,    // ç¬¬äºŒæ­¥ï¼šå­¤ç«‹ç§»ä½
                    palletCapacity: palletCapacity,
                    useAutoDetect: useAutoDetect,
                    priority: priority
                });
            });

            dispatchItems.sort(function(a, b) {
                var priorityOrder = { high: 0, medium: 1, low: 2 };
                if (priorityOrder[a.priority] !== priorityOrder[b.priority]) {
                    return priorityOrder[a.priority] - priorityOrder[b.priority];
                }
                return (b.partialMerges.length + b.isolatedMoves.length) -
                       (a.partialMerges.length + a.isolatedMoves.length);
            });

            window._dispatchAnalysis = dispatchItems;

            var totalProducts = Object.keys(productGroups).length;
            var el1 = document.getElementById('stat-need-dispatch');
            var el3 = document.getElementById('stat-need-partial');
            var elFreed = document.getElementById('stat-freed-slots');
            var elOps = document.getElementById('stat-total-ops');
            var el5 = document.getElementById('stat-optimized');
            var el6 = document.getElementById('stat-total-products');

            var totalFreedSlots = 0;
            var totalOps = 0;
            dispatchItems.forEach(function(d) {
                if (d.partialMerges) {
                    d.partialMerges.forEach(function(m) {
                        totalFreedSlots += m.sources.length;
                        totalOps += m.sources.length; // æ¯å€‹ä¾†æºæ¿è¦åˆä½µä¸€æ¬¡
                    });
                }
                if (d.isolatedMoves) {
                    totalOps += d.isolatedMoves.length;
                }
            });

            if (el1) el1.innerText = totalMoveOps;
            if (el3) el3.innerText = totalPartialOps;
            if (elFreed) elFreed.innerText = totalFreedSlots;
            if (elOps) elOps.innerText = totalOps;
            if (el5) el5.innerText = optimized;
            if (el6) el6.innerText = totalProducts;

            var barMerge = document.getElementById('stat-bar-merge');
            var barMove = document.getElementById('stat-bar-move');
            var barOps = document.getElementById('stat-bar-ops');
            var barFree = document.getElementById('stat-bar-free');
            if (barMerge) barMerge.innerText = totalPartialOps;
            if (barMove) barMove.innerText = totalMoveOps;
            if (barOps) barOps.innerText = totalOps;
            if (barFree) barFree.innerText = totalFreedSlots;

            console.log('èª¿åº¦åˆ†æå®Œæˆ:', {
                totalProducts: totalProducts,
                needDispatch: dispatchItems.length,
                optimized: optimized,
                partialOps: totalPartialOps,
                moveOps: totalMoveOps,
                freedSlots: totalFreedSlots
            });

            renderDispatchOrders(dispatchItems);

            var loadingEl = document.getElementById('analysis-loading');
            if (loadingEl) loadingEl.classList.add('hidden');
            goToDispatchStep(2);

            var btnStep3 = document.getElementById('btn-goto-step3');
            if (btnStep3) {
                if (dispatchItems.length === 0) {
                    btnStep3.disabled = true;
                    btnStep3.innerText = 'ç„¡éœ€èª¿åº¦';
                } else {
                    btnStep3.disabled = false;
                    btnStep3.innerHTML = 'ä¸‹ä¸€æ­¥ï¼šç™¼å¸ƒåŸ·è¡Œ <i class="fa-solid fa-arrow-right ml-2"></i>';
                }
            }
        };

        function renderDispatchOrders(items) {
            var container = document.getElementById('dispatch-orders-container');
            if (!container) return;

            if (items.length === 0) {
                container.innerHTML = '<div class="text-center py-12"><i class="fa-solid fa-check-circle text-emerald-400 text-5xl mb-4"></i><p class="text-emerald-400 text-xl font-bold">æ‰€æœ‰å“é …éƒ½å·²å„ªåŒ–ï¼</p><p class="text-slate-500 mt-2">ç›®å‰ç„¡éœ€åŸ·è¡Œèª¿åº¦ä½œæ¥­</p></div>';
                updateDispatchSelectionUI();
                return;
            }

            var html = '<table class="w-full text-sm">';
            html += '<thead class="bg-slate-800 sticky top-0">';
            html += '<tr class="text-slate-400 text-xs">';
            html += '<th class="p-2 text-left w-8"><input type="checkbox" id="dispatch-select-all-table" onchange="toggleAllDispatchOrders()" class="w-4 h-4"></th>';
            html += '<th class="p-2 text-left">å“é …</th>';
            html += '<th class="p-2 text-center w-20">æ“ä½œ</th>';
            html += '<th class="p-2 text-left">æ˜ç´°</th>';
            html += '<th class="p-2 text-center w-16">é‡‹æ”¾</th>';
            html += '<th class="p-2 text-center w-12"></th>';
            html += '</tr></thead><tbody>';

            var orderNo = 1;
            items.forEach(function(item, idx) {
                var hasMerge = item.partialMerges && item.partialMerges.length > 0;
                var hasMove = item.isolatedMoves && item.isolatedMoves.length > 0;
                var mergeCount = 0, moveCount = 0, freeCount = 0;

                if (hasMerge) {
                    item.partialMerges.forEach(function(g) {
                        mergeCount += g.sources.length;
                        freeCount += g.sources.length;
                    });
                }
                if (hasMove) moveCount = item.isolatedMoves.length;

                html += '<tr class="border-b border-slate-700 hover:bg-slate-800/50 dispatch-order-item" data-idx="' + idx + '">';

                html += '<td class="p-2"><input type="checkbox" class="dispatch-order-checkbox w-4 h-4 accent-purple-500" data-idx="' + idx + '" onchange="updateDispatchSelectionUI()"></td>';

                html += '<td class="p-2">';
                html += '<div class="flex items-center gap-2">';
                html += '<span class="bg-blue-600 text-white text-[10px] font-bold px-1.5 py-0.5 rounded">' + String(orderNo).padStart(3, '0') + '</span>';
                html += '<span class="text-white font-bold">' + item.name + '</span>';
                if (item.spec) html += '<span class="text-slate-500 text-xs">(' + item.spec + ')</span>';
                html += '</div>';
                html += '<div class="text-[10px] text-slate-500 mt-0.5">å®¹é‡' + item.palletCapacity + ' Â· åº«å­˜' + item.totalQty + ' Â· ' + item.laneCount + 'å··é“</div>';
                html += '</td>';

                html += '<td class="p-2 text-center">';
                if (mergeCount > 0) html += '<span class="inline-block bg-orange-900/50 text-orange-400 text-[10px] px-1.5 py-0.5 rounded border border-orange-700 mr-1">ä½µ' + mergeCount + '</span>';
                if (moveCount > 0) html += '<span class="inline-block bg-blue-900/50 text-blue-400 text-[10px] px-1.5 py-0.5 rounded border border-blue-700">ç§»' + moveCount + '</span>';
                html += '</td>';

                html += '<td class="p-2 text-xs">';
                if (hasMerge) {
                    item.partialMerges.forEach(function(g, gIdx) {
                        var srcLocs = g.sources.map(function(s) { return s.location; }).join(', ');
                        html += '<div class="text-orange-300 mb-0.5">';
                        html += '<span class="text-orange-500">â†’</span> ' + srcLocs + ' <span class="text-slate-500">ä½µå…¥</span> <span class="text-emerald-400 font-mono">' + g.keep.location + '</span>';
                        html += ' <span class="text-slate-600">(' + g.totalAfterMerge + 'ä»¶)</span>';
                        html += '</div>';
                    });
                }
                if (hasMove) {
                    item.isolatedMoves.forEach(function(m) {
                        html += '<div class="text-blue-300 mb-0.5">';
                        html += '<span class="text-blue-500">â†’</span> <span class="font-mono">' + m.from + '</span> <span class="text-slate-500">ç§»è‡³</span> <span class="text-emerald-400 font-mono">' + m.toSlot + '</span>';
                        html += ' <span class="text-slate-600">(' + m.qty + 'ä»¶)</span>';
                        html += '</div>';
                    });
                }
                html += '</td>';

                html += '<td class="p-2 text-center">';
                if (freeCount > 0) {
                    html += '<span class="text-emerald-400 font-bold">' + freeCount + '</span>';
                } else {
                    html += '<span class="text-slate-600">-</span>';
                }
                html += '</td>';

                html += '<td class="p-2 text-center">';
                html += '<button onclick="printSingleDispatchOrder(' + idx + ')" class="text-slate-400 hover:text-white"><i class="fa-solid fa-print"></i></button>';
                html += '</td>';

                html += '</tr>';
                orderNo++;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
            updateDispatchSelectionUI();
        }

        window.printSingleDispatchOrder = function(idx) {
            if (!window._dispatchAnalysis) {
                alert('è«‹å…ˆåŸ·è¡Œèª¿åº¦åˆ†æ');
                return;
            }
            var item = window._dispatchAnalysis[idx];
            if (!item) {
                alert('æ‰¾ä¸åˆ°å·¥å–®è³‡æ–™');
                return;
            }
            printDispatchOrder([item], 'èª¿åº¦å·¥å–® - ' + item.name);
        };

        // ========== èª¿åº¦å·¥å–®å‹¾é¸åŠŸèƒ½ ==========
        window.toggleAllDispatchOrders = function() {
            var selectAll = document.getElementById('dispatch-select-all');
            var selectAllTable = document.getElementById('dispatch-select-all-table');
            var isChecked = selectAll ? selectAll.checked : (selectAllTable ? selectAllTable.checked : false);
            var checkboxes = document.querySelectorAll('.dispatch-order-checkbox');
            checkboxes.forEach(function(cb) {
                cb.checked = isChecked;
            });
            updateDispatchSelectionUI();
        };

        window.updateDispatchSelectionUI = function() {
            var checkboxes = document.querySelectorAll('.dispatch-order-checkbox:checked');
            var count = checkboxes.length;
            var total = document.querySelectorAll('.dispatch-order-checkbox').length;

            var countEl = document.getElementById('dispatch-selected-count');
            if (countEl) countEl.innerText = count;

            var publishCountEl = document.getElementById('publish-count');
            if (publishCountEl) publishCountEl.innerText = count;

            var selectAll = document.getElementById('dispatch-select-all');
            if (selectAll) {
                selectAll.checked = count === total && total > 0;
                selectAll.indeterminate = count > 0 && count < total;
            }

            var btnPublish = document.getElementById('btn-publish-mobile');
            var btnPrint = document.getElementById('btn-print-selected');
            if (btnPublish) btnPublish.disabled = count === 0;
            if (btnPrint) btnPrint.disabled = count === 0;
        };

        window.getSelectedDispatchIndices = function() {
            var indices = [];
            document.querySelectorAll('.dispatch-order-checkbox:checked').forEach(function(cb) {
                indices.push(parseInt(cb.dataset.idx));
            });
            return indices;
        };

        window.publishSelectedToMobile = async function() {
            var indices = getSelectedDispatchIndices();
            if (indices.length === 0) {
                alert('è«‹å…ˆå‹¾é¸è¦ç™¼å¸ƒçš„å·¥å–®');
                return;
            }

            var items = indices.map(function(idx) { return window._dispatchAnalysis[idx]; }).filter(Boolean);

            var totalOps = 0;
            items.forEach(function(item) {
                if (item.partialMerges) {
                    item.partialMerges.forEach(function(g) { totalOps += g.sources.length; });
                }
                if (item.isolatedMoves) totalOps += item.isolatedMoves.length;
            });

            if (!confirm('ç¢ºå®šè¦ç™¼å¸ƒ ' + items.length + ' å€‹èª¿åº¦å·¥å–®åˆ°æ‰‹æ©Ÿï¼Ÿ\n\nå…± ' + totalOps + ' é …æ“ä½œ\n\nç™¼å¸ƒå¾Œï¼Œå †é«˜æ©Ÿæ‰‹çš„æ‰‹æ©Ÿæœƒç«‹å³æ”¶åˆ°é€šçŸ¥')) {
                return;
            }

            var successCount = 0;
            var timestamp = new Date().toISOString();
            var batchNo = 'DSP-' + Date.now().toString().slice(-8);

            for (var i = 0; i < items.length; i++) {
                var item = items[i];
                var operations = [];
                var opIndex = 0;

                if (item.partialMerges) {
                    item.partialMerges.forEach(function(group) {
                        group.sources.forEach(function(src) {
                            operations.push({
                                id: 'op-' + opIndex++,
                                type: 'åˆä½µ',
                                from: src.location,
                                palletId: src.palletId || '',
                                qty: src.qty,
                                to: group.keep.location
                            });
                        });
                    });
                }

                if (item.isolatedMoves) {
                    item.isolatedMoves.forEach(function(m) {
                        operations.push({
                            id: 'op-' + opIndex++,
                            type: 'ç§»ä½',
                            from: m.from,
                            palletId: m.palletId || '',
                            qty: m.qty,
                            to: m.toSlot,
                            reason: m.reason
                        });
                    });
                }

                if (operations.length === 0) continue;

                var order = {
                    orderNo: batchNo + '-' + String(i + 1).padStart(3, '0'),
                    batchNo: batchNo,
                    productName: item.name,
                    spec: item.spec || '',
                    operations: operations,
                    totalOps: operations.length,
                    completedOps: [],
                    status: 'pending',
                    createdAt: timestamp,
                    createdBy: window.getOperatorName ? window.getOperatorName() : 'system'
                };

                try {
                    await window.addDoc(window.collection(window.db, 'dispatchOrders'), order);
                    successCount++;
                } catch (err) {
                    console.error('ç™¼å¸ƒå·¥å–®å¤±æ•—:', err);
                }
            }

            if (successCount > 0) {
                alert('âœ… å·²ç™¼å¸ƒ ' + successCount + ' å€‹èª¿åº¦å·¥å–®åˆ°æ‰‹æ©Ÿï¼\n\næ‰¹æ¬¡ç·¨è™Ÿï¼š' + batchNo + '\n\nğŸ“± å †é«˜æ©Ÿæ‰‹çš„æ‰‹æ©Ÿæœƒæ”¶åˆ°é€šçŸ¥');

                document.querySelectorAll('.dispatch-order-checkbox').forEach(function(cb) { cb.checked = false; });
                document.getElementById('dispatch-select-all').checked = false;
                updateDispatchSelectionUI();
            } else {
                alert('âŒ ç™¼å¸ƒå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š');
            }
        };

        window.printSelectedDispatchOrders = function() {
            var indices = getSelectedDispatchIndices();
            if (indices.length === 0) {
                alert('è«‹å…ˆå‹¾é¸è¦åˆ—å°çš„å·¥å–®');
                return;
            }

            var items = indices.map(function(idx) { return window._dispatchAnalysis[idx]; }).filter(Boolean);
            printDispatchOrdersInternal(items, 'èª¿åº¦å·¥å–®ï¼ˆé¸å–ï¼‰');
        };

        window.publishDispatchToMobile = async function() {
            if (!window._dispatchAnalysis || window._dispatchAnalysis.length === 0) {
                alert('ç›®å‰æ²’æœ‰èª¿åº¦å·¥å–®å¯ç™¼å¸ƒ\n\nè«‹å…ˆç­‰å¾…ç³»çµ±åˆ†æå®Œæˆ');
                return;
            }

            var items = window._dispatchAnalysis;
            var totalOps = 0;
            items.forEach(function(item) {
                if (item.partialMerges) {
                    item.partialMerges.forEach(function(g) { totalOps += g.sources.length; });
                }
                if (item.isolatedMoves) totalOps += item.isolatedMoves.length;
            });

            if (!confirm('ç¢ºå®šè¦ç™¼å¸ƒ ' + items.length + ' å€‹èª¿åº¦å·¥å–®åˆ°æ‰‹æ©Ÿï¼Ÿ\n\nå…± ' + totalOps + ' é …æ“ä½œ\n\nç™¼å¸ƒå¾Œï¼Œå †é«˜æ©Ÿæ‰‹çš„æ‰‹æ©Ÿæœƒç«‹å³æ”¶åˆ°é€šçŸ¥')) {
                return;
            }

            var successCount = 0;
            var timestamp = new Date().toISOString();
            var batchNo = 'DSP-' + Date.now().toString().slice(-8);

            for (var i = 0; i < items.length; i++) {
                var item = items[i];
                var operations = [];
                var opIndex = 0;

                if (item.partialMerges) {
                    item.partialMerges.forEach(function(group) {
                        group.sources.forEach(function(src) {
                            operations.push({
                                id: 'op-' + opIndex++,
                                type: 'åˆä½µ',
                                from: src.location,
                                palletId: src.palletId || '',
                                qty: src.qty,
                                to: group.keep.location
                            });
                        });
                    });
                }

                if (item.isolatedMoves) {
                    item.isolatedMoves.forEach(function(m) {
                        operations.push({
                            id: 'op-' + opIndex++,
                            type: 'ç§»ä½',
                            from: m.from,
                            palletId: m.palletId || '',
                            qty: m.qty,
                            to: m.toSlot,
                            reason: m.reason
                        });
                    });
                }

                if (operations.length === 0) continue;

                var order = {
                    orderNo: batchNo + '-' + String(i + 1).padStart(3, '0'),
                    batchNo: batchNo,
                    productName: item.name,
                    spec: item.spec || '',
                    operations: operations,
                    totalOps: operations.length,
                    completedOps: [],
                    status: 'pending',
                    createdAt: timestamp,
                    createdBy: window.getOperatorName ? window.getOperatorName() : 'system'
                };

                try {
                    await window.addDoc(window.collection(window.db, 'dispatchOrders'), order);
                    successCount++;
                } catch (err) {
                    console.error('ç™¼å¸ƒå·¥å–®å¤±æ•—:', err);
                }
            }

            if (successCount > 0) {
                alert('âœ… å·²ç™¼å¸ƒ ' + successCount + ' å€‹èª¿åº¦å·¥å–®åˆ°æ‰‹æ©Ÿï¼\n\næ‰¹æ¬¡ç·¨è™Ÿï¼š' + batchNo + '\n\nğŸ“± å †é«˜æ©Ÿæ‰‹çš„æ‰‹æ©Ÿæœƒæ”¶åˆ°é€šçŸ¥');

                var section = document.getElementById('published-orders-section');
                var list = document.getElementById('published-orders-list');
                if (section && list) {
                    section.classList.remove('hidden');
                    list.innerHTML += '<div class="flex items-center justify-between bg-slate-800 rounded-lg p-3">' +
                        '<div class="flex items-center gap-3">' +
                        '<i class="fa-solid fa-check-circle text-green-400"></i>' +
                        '<span class="text-white font-mono">' + batchNo + '</span>' +
                        '<span class="text-slate-400 text-sm">' + successCount + ' å€‹å·¥å–®</span>' +
                        '</div>' +
                        '<span class="text-slate-500 text-sm">' + new Date().toLocaleTimeString('zh-TW') + '</span>' +
                        '</div>';
                }
            } else {
                alert('âŒ ç™¼å¸ƒå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š');
            }
        };

        window.printAllDispatchOrders = function() {
            if (!window._dispatchAnalysis) {
                alert('è«‹å…ˆåŸ·è¡Œèª¿åº¦åˆ†æï¼ˆé»æ“Šã€Œé–‹å§‹åˆ†æã€æŒ‰éˆ•ï¼‰');
                return;
            }
            var items = window._dispatchAnalysis;
            if (items.length === 0) {
                alert('ç›®å‰ç„¡éœ€è¦èª¿åº¦çš„å·¥å–®ï¼ˆæ‰€æœ‰å“é …éƒ½å·²å„ªåŒ–ï¼‰');
                return;
            }
            printDispatchOrdersInternal(items, 'èª¿åº¦å·¥å–®ç¸½è¡¨');
        };

        function printDispatchOrdersInternal(items, title) {
            var html = '<style>';
                html += '.page-header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 8px; margin-bottom: 15px; }';
                html += '.page-header h1 { font-size: 18px; margin: 0; }';
                html += '.page-header .date { font-size: 10px; color: #666; }';
                html += '.order { border: 2px solid #333; margin-bottom: 15px; page-break-inside: avoid; }';
                html += '.order-header { background: #333; color: white; padding: 8px 12px; font-size: 13px; font-weight: bold; }';
                html += '.order-info { background: #f5f5f5; padding: 6px 12px; border-bottom: 1px solid #ccc; font-size: 10px; }';
                html += '.order-info span { margin-right: 15px; }';
                html += '.section { border-top: 1px solid #ccc; }';
                html += '.section-header { background: #eee; padding: 5px 12px; font-weight: bold; font-size: 11px; }';
                html += '.section-header.merge { background: #fff3cd; }';
                html += '.section-header.move { background: #cce5ff; }';
                html += 'table { width: 100%; border-collapse: collapse; }';
                html += 'th { background: #f0f0f0; text-align: left; padding: 5px 8px; font-weight: normal; font-size: 10px; border-bottom: 1px solid #ccc; }';
                html += 'td { padding: 6px 8px; border-bottom: 1px solid #eee; }';
                html += '.from { color: #c00; font-weight: bold; font-family: monospace; }';
                html += '.to { color: #060; font-weight: bold; font-family: monospace; }';
                html += '.qty { text-align: right; font-weight: bold; }';
                html += '.checkbox { width: 18px; height: 18px; border: 2px solid #333; display: inline-block; }';
                html += '.result-row { background: #e8f5e9; font-weight: bold; }';
                html += '.signature { margin-top: 20px; display: flex; justify-content: space-around; }';
                html += '.signature div { text-align: center; }';
                html += '.signature .line { width: 120px; border-bottom: 1px solid #000; height: 30px; margin-bottom: 5px; }';
                html += '</style>';

                html += '<div class="page-header">';
                html += '<h1>' + title + '</h1>';
                html += '<div class="date">ç”¢ç”Ÿæ™‚é–“ï¼š' + new Date().toLocaleString('zh-TW') + '</div>';
                html += '</div>';

            items.forEach(function(item, idx) {
                html += '<div class="order">';
                html += '<div class="order-header">å·¥å–® #' + String(idx + 1).padStart(3, '0') + 'ã€€' + item.name + (item.spec ? ' (' + item.spec + ')' : '') + '</div>';

                html += '<div class="order-info">';
                html += '<span>æ¿å®¹é‡ï¼š<b>' + item.palletCapacity + '</b> ä»¶/æ¿</span>';
                html += '<span>é¤˜æ¿æ¨™æº–ï¼š<b>&lt;' + Math.floor(item.palletCapacity * 0.5) + '</b>ä»¶</span>';
                html += '<span>ç¸½åº«å­˜ï¼š<b>' + item.totalQty + '</b> ä»¶</span>';
                html += '<span>ä¸»å··é“ï¼š<b>' + (item.mainLane || '-') + '</b></span>';
                html += '</div>';

                if (item.partialMerges && item.partialMerges.length > 0) {
                    item.partialMerges.forEach(function(group, gIdx) {
                        html += '<div class="section">';
                        html += '<div class="section-header merge">ã€åˆä½µä½œæ¥­ #' + (gIdx + 1) + 'ã€‘å®Œæˆå¾Œé‡‹æ”¾ ' + group.sources.length + ' å€‹å„²ä½</div>';
                        html += '<table>';
                        html += '<tr><th style="width:40px">æ­¥é©Ÿ</th><th>ä¾†æºå„²ä½</th><th>æ¿è™Ÿ</th><th style="width:60px">æ•¸é‡</th><th style="width:30px">â†’</th><th>ç›®æ¨™å„²ä½</th><th>èªªæ˜</th><th style="width:50px">å®Œæˆ</th></tr>';

                        group.sources.forEach(function(src, sIdx) {
                            html += '<tr>';
                            html += '<td>' + (sIdx + 1) + '</td>';
                            html += '<td class="from">' + src.location + '</td>';
                            html += '<td>' + (src.palletId || '-') + '</td>';
                            html += '<td class="qty">' + src.qty + ' ä»¶</td>';
                            html += '<td>â†’</td>';
                            html += '<td class="to">' + group.keep.location + '</td>';
                            html += '<td>åˆä½µè‡³æ­¤ï¼Œä¾†æºæ¸…ç©º</td>';
                            html += '<td><span class="checkbox"></span></td>';
                            html += '</tr>';
                        });

                        html += '<tr class="result-row">';
                        html += '<td colspan="3">åˆä½µå¾Œçµæœ</td>';
                        html += '<td class="qty">' + group.totalAfterMerge + ' ä»¶</td>';
                        html += '<td></td>';
                        html += '<td class="to">' + group.keep.location + '</td>';
                        html += '<td>' + Math.round(group.totalAfterMerge / item.palletCapacity * 100) + '% æ¿å®¹é‡</td>';
                        html += '<td></td>';
                        html += '</tr>';
                        html += '</table></div>';
                    });
                }

                if (item.isolatedMoves && item.isolatedMoves.length > 0) {
                    html += '<div class="section">';
                    html += '<div class="section-header move">ã€ç§»ä½ä½œæ¥­ã€‘ç§»è‡³ä¸»å··é“ ' + item.mainLane + ' é›†ä¸­å­˜æ”¾</div>';
                    html += '<table>';
                    html += '<tr><th style="width:40px">æ­¥é©Ÿ</th><th>ä¾†æºå„²ä½</th><th>æ¿è™Ÿ</th><th style="width:60px">æ•¸é‡</th><th style="width:30px">â†’</th><th>ç›®æ¨™å„²ä½</th><th>ç§»ä½åŸå› </th><th style="width:50px">å®Œæˆ</th></tr>';

                    item.isolatedMoves.forEach(function(m, mIdx) {
                        html += '<tr>';
                        html += '<td>' + (mIdx + 1) + '</td>';
                        html += '<td class="from">' + m.from + '</td>';
                        html += '<td>' + (m.palletId || '-') + '</td>';
                        html += '<td class="qty">' + m.qty + ' ä»¶</td>';
                        html += '<td>â†’</td>';
                        html += '<td class="to">' + m.toSlot + '</td>';
                        html += '<td>' + m.reason + '</td>';
                        html += '<td><span class="checkbox"></span></td>';
                        html += '</tr>';
                    });
                    html += '</table></div>';
                }

                html += '</div>';
            });

            html += '<div class="signature">';
            html += '<div><div class="line"></div>è£½å–®äºº</div>';
            html += '<div><div class="line"></div>åŸ·è¡Œäºº</div>';
            html += '<div><div class="line"></div>ç¢ºèªäºº</div>';
            html += '</div>';

            openPrintPreview(html, title, 1000, 800);
        }

        // ========== èª¿åº¦å·¥å–®åŸ·è¡Œç³»çµ± ==========

        window._dispatchExecData = {
            currentOrderIdx: -1,
            operations: [],      // ç•¶å‰å·¥å–®çš„æ‰€æœ‰æ“ä½œ
            completedIds: []     // å·²å®Œæˆçš„æ“ä½œID
        };

        window.openDispatchExecuteModal = function() {
            var items = window._dispatchAnalysis;
            if (!items || items.length === 0) {
                alert('ç›®å‰ç„¡èª¿åº¦å·¥å–®å¯åŸ·è¡Œ\nè«‹å…ˆé»æ“Šã€Œé‡æ–°åˆ†æã€ç”¢ç”Ÿå·¥å–®');
                return;
            }

            var select = document.getElementById('dispatch-exec-order-select');
            select.innerHTML = '<option value="">-- è«‹é¸æ“‡å·¥å–® --</option>';
            items.forEach(function(item, idx) {
                var opsCount = (item.partialMerges ? item.partialMerges.reduce(function(sum, m) { return sum + m.sources.length; }, 0) : 0) +
                               (item.isolatedMoves ? item.isolatedMoves.length : 0);
                select.innerHTML += '<option value="' + idx + '">å·¥å–® #' + String(idx + 1).padStart(3, '0') + ' - ' + item.name + ' (' + opsCount + 'é …æ“ä½œ)</option>';
            });

            window._dispatchExecData = { currentOrderIdx: -1, operations: [], completedIds: [] };
            document.getElementById('dispatch-exec-list').innerHTML = '<tr><td colspan="9" class="text-center text-slate-500 py-8">è«‹é¸æ“‡å·¥å–®</td></tr>';
            document.getElementById('dispatch-exec-progress').innerText = '0/0';
            document.getElementById('dispatch-scan-input').value = '';
            document.getElementById('dispatch-scan-result').classList.add('hidden');
            document.getElementById('dispatch-batch-mode').checked = false;
            toggleDispatchBatchMode();

            document.getElementById('modal-dispatch-execute').classList.remove('hidden');

            setTimeout(function() {
                document.getElementById('dispatch-scan-input').focus();
            }, 100);
        };

        window.closeDispatchExecuteModal = function() {
            document.getElementById('modal-dispatch-execute').classList.add('hidden');
        };

        window.toggleDispatchBatchMode = function() {
            var batchMode = document.getElementById('dispatch-batch-mode').checked;
            var scanArea = document.getElementById('dispatch-scan-area');
            var batchHeader = document.getElementById('dispatch-batch-header');
            var batchExecBtn = document.getElementById('btn-dispatch-batch-exec');

            if (batchMode) {
                scanArea.style.display = 'none';
                batchHeader.style.display = '';
                batchExecBtn.classList.remove('hidden');
                document.getElementById('dispatch-exec-subtitle').innerText = 'å‹¾é¸å·²å®Œæˆé …ç›®å¾Œæ‰¹æ¬¡åŸ·è¡Œ';
            } else {
                scanArea.style.display = '';
                batchHeader.style.display = 'none';
                batchExecBtn.classList.add('hidden');
                document.getElementById('dispatch-exec-subtitle').innerText = 'æƒææ¿è™Ÿç¢ºèªåŸ·è¡Œ';
            }

            renderDispatchExecList();
        };

        window.loadDispatchExecOrder = function() {
            var select = document.getElementById('dispatch-exec-order-select');
            var idx = parseInt(select.value);

            if (isNaN(idx) || idx < 0) {
                document.getElementById('dispatch-exec-list').innerHTML = '<tr><td colspan="9" class="text-center text-slate-500 py-8">è«‹é¸æ“‡å·¥å–®</td></tr>';
                document.getElementById('dispatch-exec-progress').innerText = '0/0';
                return;
            }

            var item = window._dispatchAnalysis[idx];
            if (!item) return;

            var operations = [];
            var opIdx = 0;

            if (item.partialMerges) {
                item.partialMerges.forEach(function(group, gIdx) {
                    group.sources.forEach(function(src, sIdx) {
                        operations.push({
                            id: 'merge-' + gIdx + '-' + sIdx,
                            type: 'merge',
                            typeName: 'åˆä½µ',
                            from: src.location,
                            palletId: src.palletId || '',
                            qty: src.qty,
                            to: group.keep.location,
                            toSlotSuggested: group.keep.location,
                            note: 'åˆä½µè‡³ä¿ç•™æ¿',
                            completed: false,
                            groupIdx: gIdx,
                            sourceIdx: sIdx,
                            keepPallet: group.keep
                        });
                        opIdx++;
                    });
                });
            }

            if (item.isolatedMoves) {
                item.isolatedMoves.forEach(function(m, mIdx) {
                    operations.push({
                        id: 'move-' + mIdx,
                        type: 'move',
                        typeName: 'ç§»ä½',
                        from: m.from,
                        palletId: m.palletId || '',
                        qty: m.qty,
                        to: m.toSlot,
                        toSlotSuggested: m.toSlot,
                        note: m.reason,
                        completed: false
                    });
                    opIdx++;
                });
            }

            window._dispatchExecData = {
                currentOrderIdx: idx,
                currentItem: item,
                operations: operations,
                completedIds: []
            };

            renderDispatchExecList();
            updateDispatchProgress();

            document.getElementById('dispatch-scan-input').focus();
        };

        function renderDispatchExecList() {
            var tbody = document.getElementById('dispatch-exec-list');
            var ops = window._dispatchExecData.operations;
            var batchMode = document.getElementById('dispatch-batch-mode').checked;

            if (ops.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center text-slate-500 py-8">è«‹é¸æ“‡å·¥å–®</td></tr>';
                return;
            }

            var html = '';
            ops.forEach(function(op) {
                var statusBadge = op.completed
                    ? '<span class="badge badge-green"><i class="fa-solid fa-check mr-1"></i>å®Œæˆ</span>'
                    : '<span class="badge badge-yellow"><i class="fa-solid fa-clock mr-1"></i>å¾…åŸ·è¡Œ</span>';
                var rowClass = op.completed ? 'bg-emerald-900/20' : '';
                var typeColor = op.type === 'merge' ? 'orange' : 'blue';

                html += '<tr class="' + rowClass + ' border-b border-slate-700/50 hover:bg-slate-800/50">';

                if (batchMode) {
                    html += '<td class="p-2"><input type="checkbox" class="dispatch-op-check w-4 h-4" data-id="' + op.id + '"' + (op.completed ? ' checked disabled' : '') + '></td>';
                }

                html += '<td class="p-2">' + statusBadge + '</td>';
                html += '<td class="p-2"><span class="badge badge-' + typeColor + '">' + op.typeName + '</span></td>';
                html += '<td class="p-2 font-mono text-red-400 font-bold">' + op.from + '</td>';
                html += '<td class="p-2 font-mono text-slate-300">' + (op.palletId || '-') + '</td>';
                html += '<td class="p-2 text-right text-yellow-400 font-bold">' + op.qty + '</td>';
                html += '<td class="p-2 text-center text-slate-500"><i class="fa-solid fa-arrow-right"></i></td>';
                html += '<td class="p-2 font-mono text-emerald-400 font-bold">' + op.to + '</td>';
                html += '<td class="p-2 text-slate-400 text-xs">' + op.note + '</td>';
                html += '</tr>';
            });

            tbody.innerHTML = html;
        }

        function updateDispatchProgress() {
            var ops = window._dispatchExecData.operations;
            var completed = ops.filter(function(op) { return op.completed; }).length;
            document.getElementById('dispatch-exec-progress').innerText = completed + '/' + ops.length;
        }

        window.confirmDispatchScan = function() {
            var input = document.getElementById('dispatch-scan-input');
            var scanned = input.value.trim();
            var resultEl = document.getElementById('dispatch-scan-result');

            if (!scanned) {
                resultEl.innerHTML = '<span class="text-yellow-400"><i class="fa-solid fa-exclamation-triangle mr-1"></i>è«‹è¼¸å…¥æ¿è™Ÿ</span>';
                resultEl.classList.remove('hidden');
                return;
            }

            var ops = window._dispatchExecData.operations;
            var found = null;

            for (var i = 0; i < ops.length; i++) {
                if (!ops[i].completed) {
                    if (ops[i].palletId === scanned || ops[i].from === scanned) {
                        found = ops[i];
                        break;
                    }
                }
            }

            if (!found) {
                resultEl.innerHTML = '<span class="text-red-400"><i class="fa-solid fa-times-circle mr-1"></i>æ‰¾ä¸åˆ°ç¬¦åˆçš„å¾…åŸ·è¡Œé …ç›®ï¼š' + scanned + '</span>';
                resultEl.classList.remove('hidden');
                input.select();
                return;
            }

            executeDispatchOperation(found);

            resultEl.innerHTML = '<span class="text-emerald-400"><i class="fa-solid fa-check-circle mr-1"></i>å·²ç¢ºèªï¼š' + found.from + ' â†’ ' + found.to + '</span>';
            resultEl.classList.remove('hidden');

            input.value = '';
            input.focus();
        };

        window.toggleAllDispatchChecks = function() {
            var checkAll = document.getElementById('dispatch-check-all').checked;
            document.querySelectorAll('.dispatch-op-check:not(:disabled)').forEach(function(cb) {
                cb.checked = checkAll;
            });
        };

        window.executeDispatchBatch = async function() {
            var checkboxes = document.querySelectorAll('.dispatch-op-check:checked:not(:disabled)');
            if (checkboxes.length === 0) {
                alert('è«‹å‹¾é¸è¦åŸ·è¡Œçš„é …ç›®');
                return;
            }

            if (!confirm('ç¢ºå®šè¦åŸ·è¡Œå‹¾é¸çš„ ' + checkboxes.length + ' é …æ“ä½œï¼Ÿ\n\nç³»çµ±å°‡è‡ªå‹•æ›´æ–°åº«å­˜ä½ç½®ã€‚')) {
                return;
            }

            var ops = window._dispatchExecData.operations;
            var ids = [];
            checkboxes.forEach(function(cb) { ids.push(cb.dataset.id); });

            for (var i = 0; i < ops.length; i++) {
                if (ids.indexOf(ops[i].id) >= 0 && !ops[i].completed) {
                    await executeDispatchOperation(ops[i]);
                }
            }

            alert('âœ… å·²åŸ·è¡Œ ' + ids.length + ' é …æ“ä½œ');
        };

        async function executeDispatchOperation(op) {
            try {
                if (op.type === 'merge') {
                    var q = window.query(window.collection(window.db, 'pallets'), window.where('palletId', '==', op.palletId));
                    var snap = await window.getDocs(q);

                    if (!snap.empty) {
                        var sourceDoc = snap.docs[0];
                        var sourceData = sourceDoc.data();

                        await window.logInventoryChange({
                            type: 'merge',
                            productName: sourceData.productName,
                            spec: sourceData.spec || '',
                            quantity: 0,
                            quantityChange: -sourceData.quantity,
                            fromLocation: op.from,
                            toLocation: op.to,
                            palletId: op.palletId,
                            batchNo: sourceData.batchNo || '',
                            note: 'åˆä½µè‡³ ' + op.to
                        });

                        await window.deleteDoc(sourceDoc.ref);

                        if (op.keepPallet && op.keepPallet.palletId) {
                            var q2 = window.query(window.collection(window.db, 'pallets'), window.where('palletId', '==', op.keepPallet.palletId));
                            var snap2 = await window.getDocs(q2);
                            if (!snap2.empty) {
                                var newQty = (parseInt(snap2.docs[0].data().quantity) || 0) + op.qty;
                                await window.updateDoc(snap2.docs[0].ref, { quantity: newQty });
                            }
                        }
                    }

                } else if (op.type === 'move') {
                    var q = window.query(window.collection(window.db, 'pallets'), window.where('palletId', '==', op.palletId));
                    var snap = await window.getDocs(q);

                    if (!snap.empty) {
                        var palletDoc = snap.docs[0];
                        var palletData = palletDoc.data();

                        await window.logInventoryChange({
                            type: 'move',
                            productName: palletData.productName,
                            spec: palletData.spec || '',
                            quantity: palletData.quantity,
                            quantityChange: 0,
                            fromLocation: op.from,
                            toLocation: op.to,
                            palletId: op.palletId,
                            batchNo: palletData.batchNo || '',
                            note: op.note
                        });

                        await window.updateDoc(palletDoc.ref, { locationId: op.to });
                    }
                }

                op.completed = true;
                window._dispatchExecData.completedIds.push(op.id);

                renderDispatchExecList();
                updateDispatchProgress();

            } catch (err) {
                console.error('åŸ·è¡Œæ“ä½œå¤±æ•—:', err);
                alert('æ“ä½œå¤±æ•—: ' + err.message);
            }
        }

        window.completeDispatchOrder = function() {
            var ops = window._dispatchExecData.operations;
            var completed = ops.filter(function(op) { return op.completed; }).length;

            if (completed === 0) {
                alert('å°šæœªåŸ·è¡Œä»»ä½•æ“ä½œ');
                return;
            }

            var remaining = ops.length - completed;
            var msg = 'å·¥å–®åŸ·è¡Œæ‘˜è¦ï¼š\n\n';
            msg += 'âœ… å·²å®Œæˆï¼š' + completed + ' é …\n';
            if (remaining > 0) {
                msg += 'â³ æœªå®Œæˆï¼š' + remaining + ' é …\n';
            }
            msg += '\nç¢ºå®šè¦çµæŸæ­¤å·¥å–®å—ï¼Ÿ';

            if (!confirm(msg)) return;

            if (window.loadInventory) window.loadInventory();

            closeDispatchExecuteModal();

            setTimeout(function() {
                if (window.refreshDispatchAnalysis) window.refreshDispatchAnalysis();
            }, 500);

            alert('âœ… å·¥å–®å·²å®Œæˆï¼\n\nåº«å­˜å·²æ›´æ–°ï¼Œç³»çµ±å°‡é‡æ–°åˆ†æèª¿åº¦éœ€æ±‚ã€‚');
        };

        // ========== æ³¢æ¬¡æ€è²¨ç³»çµ± ==========

        window._waveData = {
            waves: [],
            currentWave: null,
            pickingList: [],
            completedItems: []
        };

        window.loadWavesFromFirebase = async function() {
            try {
                if (!window.db || !window.collection || !window.getDocs) {
                    console.log('Firebase å°šæœªåˆå§‹åŒ–ï¼Œä½¿ç”¨ localStorage');
                    window._waveData.waves = JSON.parse(localStorage.getItem('wms_waves') || '[]');
                    refreshWaveList();
                    return;
                }

                var snapshot = await window.getDocs(window.collection(window.db, 'waves'));
                window._waveData.waves = [];
                snapshot.forEach(function(doc) {
                    window._waveData.waves.push({ id: doc.id, ...doc.data() });
                });

                window._waveData.waves.sort(function(a, b) {
                    return (b.createdAt || '').localeCompare(a.createdAt || '');
                });

                console.log('æ³¢æ¬¡è³‡æ–™å·²è¼‰å…¥:', window._waveData.waves.length, 'ç­†');

                localStorage.setItem('wms_waves', JSON.stringify(window._waveData.waves));

                refreshWaveList();
            } catch(e) {
                console.error('è¼‰å…¥æ³¢æ¬¡è³‡æ–™å¤±æ•—:', e);
                window._waveData.waves = JSON.parse(localStorage.getItem('wms_waves') || '[]');
                refreshWaveList();
            }
        };

        async function saveWaves() {
            localStorage.setItem('wms_waves', JSON.stringify(window._waveData.waves));
        }

        function generateWaveNo() {
            var today = new Date();
            var dateStr = today.getFullYear().toString().substr(2) +
                         String(today.getMonth() + 1).padStart(2, '0') +
                         String(today.getDate()).padStart(2, '0');
            var todayWaves = window._waveData.waves.filter(function(w) {
                return w.waveNo && w.waveNo.indexOf('W' + dateStr) === 0;
            });
            var seq = todayWaves.length + 1;
            return 'W' + dateStr + '-' + String(seq).padStart(3, '0');
        }

        window.waveCompany = 'å´‡æ–‡';

        window.setWaveCompany = function(company) {
            window.waveCompany = company;

            document.getElementById('btn-wave-cw').className = company === 'å´‡æ–‡'
                ? 'px-3 py-1.5 rounded text-xs font-bold bg-blue-600 text-white'
                : 'px-3 py-1.5 rounded text-xs font-bold bg-slate-700 text-slate-300 hover:bg-slate-600';
            document.getElementById('btn-wave-bf').className = company === 'å…«æ–¹'
                ? 'px-3 py-1.5 rounded text-xs font-bold bg-purple-600 text-white'
                : 'px-3 py-1.5 rounded text-xs font-bold bg-slate-700 text-slate-300 hover:bg-slate-600';

            refreshWaveList();
        };

        window.rmCompany = 'å´‡æ–‡';

        window.setRmCompany = function(company) {
            window.rmCompany = company;

            document.getElementById('btn-rm-cw').className = company === 'å´‡æ–‡'
                ? 'px-4 py-2 rounded text-sm font-bold bg-blue-600 text-white'
                : 'px-4 py-2 rounded text-sm font-bold bg-slate-700 text-slate-300 hover:bg-slate-600';
            document.getElementById('btn-rm-bf').className = company === 'å…«æ–¹'
                ? 'px-4 py-2 rounded text-sm font-bold bg-purple-600 text-white'
                : 'px-4 py-2 rounded text-sm font-bold bg-slate-700 text-slate-300 hover:bg-slate-600';

            document.getElementById('rm-product-suggestions').innerHTML = '';
            document.getElementById('rm-pick-name').value = '';
            document.getElementById('rm-pick-spec').value = '';
        };

        window.refreshWaveList = function() {
            var tbody = document.getElementById('wave-list-body');
            if (!tbody) return;

            var waves = window._waveData.waves;

            var today = new Date().toISOString().split('T')[0];
            var todayWaves = waves.filter(function(w) { return w.createdAt && w.createdAt.indexOf(today) === 0; });
            var pending = waves.filter(function(w) { return w.status === 'pending'; });
            var picking = waves.filter(function(w) { return w.status === 'picking'; });
            var done = waves.filter(function(w) { return w.status === 'done'; });

            document.getElementById('wave-stat-today').innerText = todayWaves.length;
            document.getElementById('wave-stat-pending').innerText = pending.length;
            document.getElementById('wave-stat-picking').innerText = picking.length;
            document.getElementById('wave-stat-done').innerText = done.length;

            var orders = (window._orderData && window._orderData.orders) ? window._orderData.orders.filter(function(o) {
                return o.status === 'pending' || o.status === 'confirmed';
            }) : [];
            document.getElementById('wave-stat-orders').innerText = orders.length;

            if (waves.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-slate-500 py-8">å°šç„¡æ³¢æ¬¡è³‡æ–™</td></tr>';
                return;
            }

            var sorted = waves.slice().sort(function(a, b) {
                return new Date(b.createdAt) - new Date(a.createdAt);
            });

            var html = '';
            sorted.forEach(function(wave) {
                var statusBadge = '';
                var progressInfo = '';
                var timeInfo = '';

                if (wave.status === 'pending') {
                    statusBadge = '<span class="badge badge-yellow"><i class="fa-solid fa-clock mr-1"></i>å¾…æ€è²¨</span>';
                } else if (wave.status === 'picking') {
                    statusBadge = '<span class="badge badge-blue"><i class="fa-solid fa-spinner fa-spin mr-1"></i>æ€è²¨ä¸­</span>';
                    if (wave.startedAt) {
                        var mins = Math.round((new Date() - new Date(wave.startedAt)) / 60000);
                        timeInfo = '<div class="text-xs text-orange-400">å·²é€²è¡Œ ' + mins + ' åˆ†é˜</div>';
                    }
                } else if (wave.status === 'sorting') {
                    statusBadge = '<span class="badge badge-purple"><i class="fa-solid fa-tags mr-1"></i>å¾…åˆ†è²¨</span>';
                } else if (wave.status === 'done') {
                    statusBadge = '<span class="badge badge-green"><i class="fa-solid fa-check mr-1"></i>å·²å‡ºè²¨</span>';
                    if (wave.completedAt && wave.createdAt) {
                        var mins = Math.round((new Date(wave.completedAt) - new Date(wave.createdAt)) / 60000);
                        timeInfo = '<div class="text-xs text-slate-500">è€—æ™‚ ' + mins + ' åˆ†é˜</div>';
                    }
                }

                var hasChanges = wave.hasOrderChanges;
                var rowClass = hasChanges ? 'bg-orange-900/20 border-l-4 border-l-orange-500' : '';
                html += '<tr class="hover:bg-slate-800/50 border-b border-slate-700/50 ' + rowClass + '">';
                html += '<td class="p-3 font-mono text-cyan-400 font-bold">' + wave.waveNo;
                if (hasChanges) {
                    html += ' <span class="text-orange-400 text-xs" title="è¨‚å–®æœ‰ç•°å‹•"><i class="fa-solid fa-triangle-exclamation"></i></span>';
                }
                html += '</td>';
                html += '<td class="p-3 text-white">' + (wave.logistics || 'æ··åˆ') + '</td>';
                html += '<td class="p-3">' + statusBadge + '</td>';
                html += '<td class="p-3 text-right text-slate-300">' + (wave.orders ? wave.orders.length : 0) + '</td>';
                html += '<td class="p-3 text-right text-slate-300">' + (wave.itemCount || 0) + ' é …</td>';
                html += '<td class="p-3 text-right text-yellow-400 font-bold">' + (wave.totalQty || 0) + ' <span class="text-xs text-slate-400 font-normal">ä»¶</span></td>';
                html += '<td class="p-3 text-slate-400 text-xs">' + new Date(wave.createdAt).toLocaleString('zh-TW') + '</td>';
                html += '<td class="p-3 text-center">';
                if (wave.status === 'pending') {
                    html += '<button onclick="openWaveExecute(\'' + wave.waveNo + '\')" class="bg-blue-600 hover:bg-blue-500 text-white text-xs px-3 py-1 rounded mr-1"><i class="fa-solid fa-play mr-1"></i>é–‹å§‹æ€è²¨</button>';
                    html += '<button onclick="openAddToWaveModal(\'' + wave.waveNo + '\')" class="bg-purple-600 hover:bg-purple-500 text-white text-xs px-2 py-1 rounded mr-1" title="è¿½åŠ è¨‚å–®"><i class="fa-solid fa-plus"></i></button>';
                } else if (wave.status === 'picking') {
                    html += '<button onclick="openWaveExecute(\'' + wave.waveNo + '\')" class="bg-orange-600 hover:bg-orange-500 text-white text-xs px-3 py-1 rounded mr-1"><i class="fa-solid fa-spinner fa-spin mr-1"></i>ç¹¼çºŒæ€è²¨</button>';
                } else if (wave.status === 'sorting') {
                    html += '<button onclick="openWaveSorting(\'' + wave.waveNo + '\')" class="bg-purple-600 hover:bg-purple-500 text-white text-xs px-3 py-1 rounded mr-1"><i class="fa-solid fa-tags mr-1"></i>åˆ†è²¨ä½œæ¥­</button>';
                }
                html += '<button onclick="viewWaveDetail(\'' + wave.waveNo + '\')" class="bg-slate-600 hover:bg-slate-500 text-white text-xs px-2 py-1 rounded mr-1" title="æª¢è¦–æ˜ç´°"><i class="fa-solid fa-eye"></i></button>';
                if (wave.status === 'pending') {
                    html += '<button onclick="deleteWave(\'' + wave.waveNo + '\')" class="bg-red-600 hover:bg-red-500 text-white text-xs px-2 py-1 rounded" title="åˆªé™¤æ³¢æ¬¡"><i class="fa-solid fa-trash"></i></button>';
                }
                if (wave.status === 'done') {
                    html += '<button onclick="printWaveLabels(\'' + wave.waveNo + '\')" class="bg-slate-600 hover:bg-slate-500 text-white text-xs px-2 py-1 rounded" title="é‡å°æ¨™ç±¤"><i class="fa-solid fa-print"></i></button>';
                }
                html += '</td>';
                html += '</tr>';
            });

            tbody.innerHTML = html;

        checkWaveChangeAlert();
        };

function checkWaveChangeAlert() {
    var changedWaves = (window._waveData.waves || []).filter(function(w) { return w.hasOrderChanges; });
    var existingAlert = document.getElementById('wave-change-alert-bar');

    if (changedWaves.length > 0) {
        var waveNos = changedWaves.map(function(w) { return w.waveNo; }).join(', ');

        if (!existingAlert) {
            var alertBar = document.createElement('div');
            alertBar.id = 'wave-change-alert-bar';
            alertBar.className = 'fixed top-0 left-0 right-0 z-[100] bg-gradient-to-r from-red-600 to-orange-600 text-white py-3 px-4 flex items-center justify-between shadow-lg';
            alertBar.innerHTML = '<div class="flex items-center gap-3">' +
                '<i class="fa-solid fa-triangle-exclamation text-2xl animate-pulse"></i>' +
                '<div>' +
                '<span class="font-bold">âš ï¸ æœ‰ ' + changedWaves.length + ' å€‹æ³¢æ¬¡éœ€è¦æ›´æ–°æ€è²¨å–®ï¼</span>' +
                '<span class="ml-2 text-red-200">(' + waveNos + ')</span>' +
                '</div>' +
                '</div>' +
                '<button onclick="updateChangedWaves()" class="bg-white text-red-600 px-4 py-2 rounded-lg font-bold hover:bg-red-100 transition flex items-center gap-2">' +
                '<i class="fa-solid fa-print"></i>ç«‹å³æ›´æ–°ä¸¦åˆ—å°' +
                '</button>';
            document.body.appendChild(alertBar);

            document.body.style.paddingTop = '56px';
        } else {
            existingAlert.querySelector('.font-bold').innerText = 'âš ï¸ æœ‰ ' + changedWaves.length + ' å€‹æ³¢æ¬¡éœ€è¦æ›´æ–°æ€è²¨å–®ï¼';
        }
    } else {
        if (existingAlert) {
            existingAlert.remove();
            document.body.style.paddingTop = '';
        }
    }
}

window.openWaveSorting = function(waveNo) {
    var wave = window._waveData.waves.find(function(w) { return w.waveNo === waveNo; });
    if (!wave) {
        alert('æ‰¾ä¸åˆ°æ³¢æ¬¡ ' + waveNo);
        return;
    }

    window._waveData.currentWave = wave;

    var modal = document.createElement('div');
    modal.id = 'modal-wave-sorting';
    modal.className = 'fixed inset-0 z-50 bg-black/80 flex items-center justify-center backdrop-blur-sm';

    var ordersHtml = '';
    (wave.orders || []).forEach(function(order) {
        var totalPkgQty = 0;
        var itemsHtml = (order.items || []).filter(function(item) {
            return !window.isExcludedFromSortingLabel(item.productName);
        }).map(function(item) {
            var qty = item.quantity || 0;
            var boxPerPkg = parseBoxPerPackage(item.productName);
            var pkgQty = (boxPerPkg > 0 && qty > 0) ? Math.ceil(qty / boxPerPkg) : (item.packageQty || 1);
            if (!window.isPackagingItem(item.productName)) {
                totalPkgQty += pkgQty;
            }
            var isPackaging = window.isPackagingItem(item.productName);
            var qtyDisplay = isPackaging ? '<span class="text-slate-500">' + pkgQty + ' (åŒ…æ)</span>' : '<span class="text-yellow-400 font-bold">' + pkgQty + ' ä»¶</span>';
            return '<div class="flex justify-between text-sm py-1 border-b border-slate-700/50">' +
                '<span class="text-slate-300">' + item.productName + ' ' + (item.spec || '') + '</span>' +
                qtyDisplay + '</div>';
        }).join('');

        itemsHtml += '<div class="flex justify-between text-sm py-2 mt-1 bg-slate-700/50 rounded px-2">' +
            '<span class="text-white font-bold">å°è¨ˆ</span>' +
            '<span class="text-red-400 font-bold text-lg">' + totalPkgQty + ' ä»¶</span></div>';

        ordersHtml += '<div class="bg-slate-800 border border-slate-600 rounded-lg p-4 mb-3">' +
            '<div class="flex justify-between items-start mb-3">' +
            '<div><div class="text-cyan-400 font-mono text-sm">' + order.orderNo + '</div>' +
            '<div class="text-white font-bold text-lg">' + order.customer + '</div>' +
            '<div class="text-slate-400 text-xs">' + (order.address || '') + '</div></div>' +
            '<div class="text-right"><span class="px-2 py-1 rounded text-xs bg-slate-700 text-slate-300">' + (order.logistics || wave.logistics) + '</span>' +
            '<div class="mt-2"><button onclick="printSingleLabel(\'' + order.orderNo + '\')" class="bg-purple-600 hover:bg-purple-500 text-white text-xs px-3 py-1 rounded">' +
            '<i class="fa-solid fa-tag mr-1"></i>åˆ—å°æ¨™ç±¤</button></div></div></div>' +
            '<div class="border-t border-slate-600 pt-2">' + itemsHtml + '</div></div>';
    });

    modal.innerHTML = '<div class="bg-slate-900 border border-slate-700 rounded-2xl w-[900px] max-h-[90vh] shadow-2xl flex flex-col">' +
        '<div class="bg-gradient-to-r from-purple-900 to-pink-900 p-4 rounded-t-2xl border-b border-slate-700 flex justify-between items-center">' +
        '<div><h3 class="text-white font-bold text-lg"><i class="fa-solid fa-tags mr-2 text-purple-400"></i>åˆ†è²¨ä½œæ¥­ - ' + wave.waveNo + '</h3>' +
        '<p class="text-purple-200 text-xs mt-1">ç‰©æµå•†ï¼š' + wave.logistics + ' | è¨‚å–®æ•¸ï¼š' + (wave.orders || []).length + '</p></div>' +
        '<button onclick="printAllLabels()" class="bg-purple-600 hover:bg-purple-500 text-white px-4 py-2 rounded-lg text-sm font-bold">' +
        '<i class="fa-solid fa-print mr-1"></i>åˆ—å°å…¨éƒ¨æ¨™ç±¤</button></div>' +
        '<div class="p-4 bg-purple-900/20 border-b border-slate-700"><div class="flex items-center text-purple-300 text-sm">' +
        '<i class="fa-solid fa-info-circle mr-2"></i>è«‹ä¾æ¨™ç±¤å°‡è²¨ç‰©åˆ†é…çµ¦å„å®¢æˆ¶ï¼Œç¢ºèªç„¡èª¤å¾Œé»æ“Šã€Œå®Œæˆåˆ†è²¨ã€</div></div>' +
        '<div class="flex-1 overflow-auto p-4">' + ordersHtml + '</div>' +
        '<div class="p-4 border-t border-slate-700 flex gap-3">' +
        (wave.logistics === 'å¤§æ¦®' || wave.logistics === 'å¤§æ¦®è²¨é‹' ?
        '<button onclick="openPalletPlanModal()" class="flex-1 py-3 bg-orange-600 hover:bg-orange-500 text-white rounded-lg font-bold">' +
        '<i class="fa-solid fa-pallet mr-2"></i>æ£§æ¿å †ç–Šè¦åŠƒ</button>' : '') +
        '<button onclick="completeSorting()" class="flex-1 py-3 bg-green-600 hover:bg-green-500 text-white rounded-lg font-bold">' +
        '<i class="fa-solid fa-truck mr-2"></i>å®Œæˆåˆ†è²¨ï¼Œå‡ºè²¨</button>' +
        '<button onclick="closeSortingModal()" class="px-6 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-lg">é—œé–‰</button></div></div>';

    document.body.appendChild(modal);
};

window.closeSortingModal = function() {
    var modal = document.getElementById('modal-wave-sorting');
    if (modal) modal.remove();
};

window.printSingleLabel = function(orderNo) {
    var wave = window._waveData.currentWave;
    var order = (wave.orders || []).find(function(o) { return o.orderNo === orderNo; });
    if (!order) return;

    var printWindow = window.open('', '_blank', 'width=1100,height=800');
    var totalPkg = 0;
    var itemsHtml = (order.items || []).filter(function(item) {
        return !window.isExcludedFromSortingLabel(item.productName);
    }).map(function(item) {
        var qty = item.quantity || 0;
        var boxPerPkg = parseBoxPerPackage(item.productName);
        var pkgQty = (boxPerPkg > 0 && qty > 0) ? Math.ceil(qty / boxPerPkg) : (item.packageQty || 1);
        if (!window.isPackagingItem(item.productName)) {
            totalPkg += pkgQty;
        }
        var isPackaging = window.isPackagingItem(item.productName);
        var qtyText = isPackaging ? '(åŒ…æ)' : pkgQty + ' ä»¶';
        return '<div class="item"><span>' + item.productName + ' ' + (item.spec || '') + '</span><strong>' + qtyText + '</strong></div>';
    }).join('');

    printWindow.document.write('<!DOCTYPE html><html><head><title>åˆ†è²¨æ¨™ç±¤</title>' +
        '<style>body{font-family:"Microsoft JhengHei",sans-serif;padding:20px}' +
        '.label{border:2px solid #333;padding:15px;width:320px}' +
        '.logistics{background:#333;color:white;padding:5px 10px;font-weight:bold;margin:-15px -15px 10px -15px}' +
        '.customer{font-size:24px;font-weight:bold;margin:10px 0}' +
        '.total{background:#dc2626;color:white;padding:8px;text-align:center;font-size:20px;font-weight:bold;margin:10px 0;border-radius:4px}' +
        '.items{border-top:1px dashed #ccc;padding-top:10px}' +
        '.item{margin:5px 0;display:flex;justify-content:space-between}' +
        '.address{font-size:12px;color:#666;margin-top:10px;border-top:1px dashed #ccc;padding-top:10px}</style></head>' +
        '<body><div class="label"><div class="logistics">' + (order.logistics || wave.logistics) + '</div>' +
        '<div style="font-size:14px;color:#666">ğŸ“¦ ' + order.orderNo + '</div>' +
        '<div class="customer">ğŸ‘¤ ' + order.customer + '</div>' +
        '<div class="total">å…± ' + totalPkg + ' ä»¶</div>' +
        '<div class="items">' + itemsHtml + '</div>' +
        (order.address ? '<div class="address">ğŸ“ ' + order.address + '</div>' : '') +
        '</div><script>window.print();<\/script></body></html>');
    printWindow.document.close();
};

window.printAllLabels = function() {
    var wave = window._waveData.currentWave;
    var printWindow = window.open('', '_blank', 'width=1100,height=800');

    var labelsHtml = (wave.orders || []).map(function(order) {
        var totalPkg = 0;
        var itemsHtml = (order.items || []).filter(function(item) {
            return !window.isExcludedFromSortingLabel(item.productName);
        }).map(function(item) {
            var qty = item.quantity || 0;
            var boxPerPkg = parseBoxPerPackage(item.productName);
            var pkgQty = (boxPerPkg > 0 && qty > 0) ? Math.ceil(qty / boxPerPkg) : (item.packageQty || 1);
            if (!window.isPackagingItem(item.productName)) {
                totalPkg += pkgQty;
            }
            var isPackaging = window.isPackagingItem(item.productName);
            var qtyText = isPackaging ? '(åŒ…æ)' : pkgQty + ' ä»¶';
            return '<div class="item"><span>' + item.productName + '</span><strong>' + qtyText + '</strong></div>';
        }).join('');

        return '<div class="label"><div class="logistics">' + (order.logistics || wave.logistics) + '</div>' +
            '<div style="font-size:14px;color:#666">ğŸ“¦ ' + order.orderNo + '</div>' +
            '<div class="customer">ğŸ‘¤ ' + order.customer + '</div>' +
            '<div class="total">å…± ' + totalPkg + ' ä»¶</div>' +
            '<div class="items">' + itemsHtml + '</div>' +
            (order.address ? '<div class="address">ğŸ“ ' + order.address + '</div>' : '') + '</div>';
    }).join('');

    printWindow.document.write('<!DOCTYPE html><html><head><title>åˆ†è²¨æ¨™ç±¤</title>' +
        '<style>body{font-family:"Microsoft JhengHei",sans-serif;padding:20px}' +
        '.label{border:2px solid #333;padding:15px;width:320px;margin-bottom:20px;page-break-inside:avoid}' +
        '.logistics{background:#333;color:white;padding:5px 10px;font-weight:bold;margin:-15px -15px 10px -15px}' +
        '.customer{font-size:24px;font-weight:bold;margin:10px 0}' +
        '.total{background:#dc2626;color:white;padding:8px;text-align:center;font-size:20px;font-weight:bold;margin:10px 0;border-radius:4px}' +
        '.items{border-top:1px dashed #ccc;padding-top:10px}' +
        '.item{margin:5px 0;display:flex;justify-content:space-between}' +
        '.address{font-size:12px;color:#666;margin-top:10px;border-top:1px dashed #ccc;padding-top:10px}</style></head>' +
        '<body>' + labelsHtml + '<script>window.print();<\/script></body></html>');
    printWindow.document.close();
};

// ========== æ£§æ¿å †ç–Šè¦åŠƒåŠŸèƒ½ ==========

var PALLET_CONFIG = {
    bottomCount: 7,    // æ¯å±¤åº•æ•¸ï¼ˆä»¶ï¼‰
    layerCount: 8,     // å±¤æ•¸
    maxCapacity: 56    // ç¸½å®¹é‡ï¼ˆ7Ã—8=56ä»¶ï¼‰
};

window.openPalletPlanModal = function() {
    var wave = window._waveData.currentWave;
    if (!wave || !wave.orders || wave.orders.length === 0) {
        alert('ç„¡è¨‚å–®è³‡æ–™');
        return;
    }

    if (wave.logistics !== 'å¤§æ¦®' && wave.logistics !== 'å¤§æ¦®è²¨é‹') {
        alert('æ£§æ¿å †ç–Šè¦åŠƒåƒ…é©ç”¨æ–¼å¤§æ¦®è²¨é‹');
        return;
    }

    var ordersWithQty = (wave.orders || []).map(function(order) {
        var totalPkg = 0;
        (order.items || []).forEach(function(item) {
            var qty = item.quantity || 0;
            var boxPerPkg = parseBoxPerPackage(item.productName);
            var pkgQty = (boxPerPkg > 0 && qty > 0) ? Math.ceil(qty / boxPerPkg) : (item.packageQty || 1);
            totalPkg += pkgQty;
        });
        return {
            orderNo: order.orderNo,
            customer: order.customer,
            address: order.address || '',
            logistics: order.logistics || wave.logistics,
            totalPkg: totalPkg
        };
    });

    ordersWithQty.sort(function(a, b) {
        if (a.totalPkg !== b.totalPkg) return a.totalPkg - b.totalPkg;

        return a.orderNo.localeCompare(b.orderNo);
    });

    var pallets = [];
    var currentPallet = { orders: [], totalPkg: 0, layers: [] };
    var currentLayer = [];
    var currentLayerPkg = 0;

    ordersWithQty.forEach(function(order) {
        if (currentPallet.totalPkg + order.totalPkg > PALLET_CONFIG.maxCapacity) {
            if (currentLayer.length > 0) {
                currentPallet.layers.push(currentLayer);
            }
            if (currentPallet.orders.length > 0) {
                pallets.push(currentPallet);
            }
            currentPallet = { orders: [], totalPkg: 0, layers: [] };
            currentLayer = [];
            currentLayerPkg = 0;
        }

        if (currentLayerPkg + order.totalPkg > PALLET_CONFIG.bottomCount) {
            if (currentLayer.length > 0) {
                currentPallet.layers.push(currentLayer);
            }
            currentLayer = [];
            currentLayerPkg = 0;
        }

        currentPallet.orders.push(order);
        currentPallet.totalPkg += order.totalPkg;
        currentLayer.push(order);
        currentLayerPkg += order.totalPkg;
    });

    if (currentLayer.length > 0) {
        currentPallet.layers.push(currentLayer);
    }
    if (currentPallet.orders.length > 0) {
        pallets.push(currentPallet);
    }

    var modal = document.createElement('div');
    modal.id = 'modal-pallet-plan';
    modal.className = 'fixed inset-0 z-50 bg-black/80 flex items-center justify-center backdrop-blur-sm overflow-auto py-4';

    var palletsHtml = pallets.map(function(pallet, pIdx) {
        var layersHtml = pallet.layers.map(function(layer, lIdx) {
            var layerNum = pallet.layers.length - lIdx;
            var layerOrders = layer.map(function(o) {
                return '<span class="inline-block bg-slate-600 text-white text-xs px-2 py-1 rounded mr-1 mb-1">' +
                    o.customer + ' <span class="text-yellow-400">' + o.totalPkg + 'ä»¶</span></span>';
            }).join('');
            var layerTotal = layer.reduce(function(sum, o) { return sum + o.totalPkg; }, 0);

            return '<div class="border-b border-slate-600 py-2">' +
                '<div class="flex justify-between items-center mb-1">' +
                '<span class="text-slate-400 text-sm">ç¬¬ ' + layerNum + ' å±¤' + (layerNum === 1 ? ' (åº•å±¤-æ•£æ¿/äººå·¥)' : layerNum === pallet.layers.length ? ' (é ‚å±¤-å †é«˜æ©Ÿ)' : '') + '</span>' +
                '<span class="text-cyan-400 text-sm">' + layerTotal + ' ä»¶</span>' +
                '</div>' +
                '<div>' + layerOrders + '</div>' +
                '</div>';
        }).join('');

        var usagePercent = Math.round(pallet.totalPkg / PALLET_CONFIG.maxCapacity * 100);
        var usageColor = usagePercent >= 80 ? 'text-green-400' : (usagePercent >= 50 ? 'text-yellow-400' : 'text-red-400');

        return '<div class="bg-slate-800 border border-slate-600 rounded-lg p-4 mb-4">' +
            '<div class="flex justify-between items-center mb-3 pb-2 border-b border-slate-500">' +
            '<div class="text-white font-bold text-lg"><i class="fa-solid fa-pallet mr-2 text-orange-400"></i>æ£§æ¿ #' + (pIdx + 1) + '</div>' +
            '<div class="text-right">' +
            '<div class="' + usageColor + ' font-bold">' + pallet.totalPkg + ' / ' + PALLET_CONFIG.maxCapacity + ' ä»¶</div>' +
            '<div class="text-slate-400 text-xs">ä½¿ç”¨ç‡ ' + usagePercent + '%</div>' +
            '</div></div>' +
            '<div class="text-xs text-orange-300 mb-2"><i class="fa-solid fa-arrow-up mr-1"></i>å¾ä¸Šå¾€ä¸‹è®€ = å–è²¨é †åºï¼ˆå…ˆå–ä¸Šå±¤ï¼‰</div>' +
            layersHtml +
            '</div>';
    }).join('');

    var totalOrders = ordersWithQty.length;
    var totalPkg = ordersWithQty.reduce(function(sum, o) { return sum + o.totalPkg; }, 0);

    modal.innerHTML = '<div class="bg-slate-900 border border-slate-700 rounded-2xl w-[800px] max-h-[90vh] shadow-2xl flex flex-col m-4">' +
        '<div class="bg-gradient-to-r from-orange-900 to-amber-900 p-4 rounded-t-2xl border-b border-slate-700">' +
        '<h3 class="text-white font-bold text-lg"><i class="fa-solid fa-pallet mr-2 text-orange-400"></i>æ£§æ¿å †ç–Šè¦åŠƒ - ' + wave.waveNo + '</h3>' +
        '<p class="text-orange-200 text-sm mt-1">ç‰©æµå•†ï¼š' + wave.logistics + ' | è¨‚å–®ï¼š' + totalOrders + ' ç­† | ç¸½ä»¶æ•¸ï¼š' + totalPkg + ' ä»¶ | æ£§æ¿ï¼š' + pallets.length + ' æ¿</p></div>' +
        '<div class="p-4 bg-orange-900/20 border-b border-slate-700">' +
        '<div class="flex items-center justify-between">' +
        '<div class="text-orange-300 text-sm"><i class="fa-solid fa-lightbulb mr-2"></i>å †ç–ŠåŸå‰‡ï¼šå°å–®å…ˆç–Šï¼ˆåº•å±¤-æ•£æ¿äººå·¥ï¼‰ï¼Œå¤§å–®å¾Œç–Šï¼ˆä¸Šå±¤-å †é«˜æ©Ÿï¼‰</div>' +
        '<div class="text-slate-400 text-xs">æ£§æ¿å®¹é‡ï¼š' + PALLET_CONFIG.bottomCount + 'åº• Ã— ' + PALLET_CONFIG.layerCount + 'å±¤ = ' + PALLET_CONFIG.maxCapacity + 'ä»¶</div>' +
        '</div></div>' +
        '<div class="flex-1 overflow-auto p-4">' + palletsHtml + '</div>' +
        '<div class="p-4 border-t border-slate-700 flex gap-3">' +
        '<button onclick="printPalletPlan()" class="flex-1 py-3 bg-orange-600 hover:bg-orange-500 text-white rounded-lg font-bold">' +
        '<i class="fa-solid fa-print mr-2"></i>åˆ—å°å †ç–Šè¦åŠƒè¡¨</button>' +
        '<button onclick="closePalletPlanModal()" class="px-6 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-lg">é—œé–‰</button></div></div>';

    document.body.appendChild(modal);
};

window.closePalletPlanModal = function() {
    var modal = document.getElementById('modal-pallet-plan');
    if (modal) modal.remove();
};

function getDeliveryRegion(address) {
    if (!address) return 0;

    var regionWeights = {
        'å°åŒ—': 1, 'è‡ºåŒ—': 1, 'æ–°åŒ—': 1, 'åŸºéš†': 2, 'æ¡ƒåœ’': 2, 'æ–°ç«¹': 3,
        'è‹—æ —': 4, 'å°ä¸­': 5, 'è‡ºä¸­': 5, 'å½°åŒ–': 5, 'å—æŠ•': 6, 'é›²æ—': 6,
        'å˜‰ç¾©': 7, 'å°å—': 8, 'è‡ºå—': 8, 'é«˜é›„': 9, 'å±æ±': 10,
        'å®œè˜­': 6, 'èŠ±è“®': 11, 'å°æ±': 12, 'è‡ºæ±': 12,
        'æ¾æ¹–': 15, 'é‡‘é–€': 16, 'é¦¬ç¥–': 16, 'é€£æ±Ÿ': 16
    };

    for (var city in regionWeights) {
        if (address.includes(city)) {
            return regionWeights[city];
        }
    }
    return 5; // é è¨­ä¸­ç­‰è·é›¢
}

window.printPalletPlan = function() {
    var wave = window._waveData.currentWave;

    var ordersWithQty = (wave.orders || []).map(function(order) {
        var totalPkg = 0;
        (order.items || []).forEach(function(item) {
            var qty = item.quantity || 0;
            var boxPerPkg = parseBoxPerPackage(item.productName);
            var pkgQty = (boxPerPkg > 0 && qty > 0) ? Math.ceil(qty / boxPerPkg) : (item.packageQty || 1);
            totalPkg += pkgQty;
        });
        return {
            orderNo: order.orderNo,
            customer: order.customer,
            address: order.address || '',
            totalPkg: totalPkg
        };
    });

    ordersWithQty.sort(function(a, b) {
        if (a.totalPkg !== b.totalPkg) return a.totalPkg - b.totalPkg;
        return a.orderNo.localeCompare(b.orderNo);
    });

    var pallets = [];
    var currentPallet = { orders: [], totalPkg: 0 };

    ordersWithQty.forEach(function(order) {
        if (currentPallet.totalPkg + order.totalPkg > PALLET_CONFIG.maxCapacity) {
            if (currentPallet.orders.length > 0) pallets.push(currentPallet);
            currentPallet = { orders: [], totalPkg: 0 };
        }
        currentPallet.orders.push(order);
        currentPallet.totalPkg += order.totalPkg;
    });
    if (currentPallet.orders.length > 0) pallets.push(currentPallet);

    var printWindow = window.open('', '_blank', 'width=1100,height=800');
    var now = new Date().toLocaleString('zh-TW');

    var html = '<!DOCTYPE html><html><head><title>æ£§æ¿å †ç–Šè¦åŠƒè¡¨</title>' +
        '<style>' +
        'body { font-family: "Microsoft JhengHei", sans-serif; font-size: 12px; padding: 15px; }' +
        '.header { text-align: center; margin-bottom: 15px; border-bottom: 2px solid #333; padding-bottom: 10px; }' +
        '.header h2 { margin: 0 0 5px 0; }' +
        '.info { margin-bottom: 15px; display: flex; gap: 20px; }' +
        '.info-item { background: #f3f4f6; padding: 5px 10px; border-radius: 4px; }' +
        '.pallet { border: 2px solid #333; margin-bottom: 15px; page-break-inside: avoid; }' +
        '.pallet-header { background: #374151; color: white; padding: 8px 10px; font-weight: bold; display: flex; justify-content: space-between; }' +
        '.pallet-body { padding: 10px; }' +
        '.layer { border-bottom: 1px dashed #ccc; padding: 5px 0; }' +
        '.layer:last-child { border-bottom: none; }' +
        '.layer-num { color: #666; font-size: 11px; }' +
        '.order-tag { display: inline-block; background: #e5e7eb; padding: 2px 8px; margin: 2px; border-radius: 3px; }' +
        '.order-qty { color: #dc2626; font-weight: bold; }' +
        '.note { background: #fef3c7; padding: 10px; margin-bottom: 15px; border-radius: 4px; }' +
        '.timestamp { text-align: right; font-size: 10px; color: #666; margin-top: 15px; }' +
        '</style></head><body>';

    html += '<div class="header"><h2>æ£§æ¿å †ç–Šè¦åŠƒè¡¨</h2><h3>' + wave.waveNo + ' - ' + wave.logistics + '</h3></div>';

    html += '<div class="note"><b>ğŸ“‹ å †ç–ŠåŸå‰‡ï¼š</b>å°å–®å…ˆç–Šï¼ˆåº•å±¤-æ•£æ¿/äººå·¥æ¬é‹ï¼‰ï¼Œå¤§å–®å¾Œç–Šï¼ˆä¸Šå±¤-å †é«˜æ©Ÿæ¬é‹ï¼‰<br>' +
        '<b>ğŸ“¦ æ£§æ¿è¦æ ¼ï¼š</b>' + PALLET_CONFIG.bottomCount + ' åº• Ã— ' + PALLET_CONFIG.layerCount + ' å±¤ = ' + PALLET_CONFIG.maxCapacity + ' ä»¶/æ¿</div>';

    html += '<div class="info">' +
        '<div class="info-item"><b>è¨‚å–®æ•¸ï¼š</b>' + ordersWithQty.length + ' ç­†</div>' +
        '<div class="info-item"><b>ç¸½ä»¶æ•¸ï¼š</b>' + ordersWithQty.reduce(function(s,o){return s+o.totalPkg;},0) + ' ä»¶</div>' +
        '<div class="info-item"><b>æ£§æ¿æ•¸ï¼š</b>' + pallets.length + ' æ¿</div></div>';

    pallets.forEach(function(pallet, pIdx) {
        html += '<div class="pallet">';
        html += '<div class="pallet-header"><span>æ£§æ¿ #' + (pIdx + 1) + '</span><span>' + pallet.totalPkg + ' / ' + PALLET_CONFIG.maxCapacity + ' ä»¶</span></div>';
        html += '<div class="pallet-body">';

        var stackOrder = 1;
        pallet.orders.slice().reverse().forEach(function(order, idx) {
            var layerNum = Math.floor(idx / PALLET_CONFIG.bottomCount) + 1;
            html += '<div class="layer">' +
                '<span class="layer-num">å–è²¨é †åº ' + stackOrder + '</span> ' +
                '<span class="order-tag">' + order.customer + ' <span class="order-qty">' + order.totalPkg + 'ä»¶</span></span> ' +
                '<span style="color:#666;font-size:10px">' + order.address.substring(0, 15) + '...</span>' +
                '</div>';
            stackOrder++;
        });

        html += '</div></div>';
    });

    html += '<div class="timestamp">åˆ—å°æ—¥æœŸï¼š' + now + '</div>';
    html += '<script>window.print();<\/script></body></html>';

    printWindow.document.write(html);
    printWindow.document.close();
};

window.completeSorting = async function() {
    var wave = window._waveData.currentWave;

    if (!confirm('ç¢ºå®šå®Œæˆåˆ†è²¨ï¼Ÿ\n\næ³¢æ¬¡ ' + wave.waveNo + ' å°‡æ¨™è¨˜ç‚ºã€å·²å‡ºè²¨ã€‘')) {
        return;
    }

    wave.status = 'done';
    wave.sortedAt = new Date().toISOString();
    wave.completedAt = new Date().toISOString();

    if (wave.id) {
        try {
            await window.updateDoc(window.doc(window.db, 'waves', wave.id), {
                status: 'done',
                sortedAt: wave.sortedAt,
                completedAt: wave.completedAt
            });
        } catch (err) {
            console.error('æ›´æ–°æ³¢æ¬¡ç‹€æ…‹å¤±æ•—:', err);
        }
    }

    for (var i = 0; i < (wave.orders || []).length; i++) {
        var order = wave.orders[i];
        var orderInData = window._orderData.orders.find(function(o) { return o.orderNo === order.orderNo; });
        if (orderInData) {
            orderInData.status = 'shipped';
        }
        if (order.id) {
            try {
                await window.updateDoc(window.doc(window.db, 'salesOrders', order.id), {
                    status: 'shipped',
                    shippedAt: new Date().toISOString(),
                    waveNo: wave.waveNo
                });
            } catch (err) {
                console.error('æ›´æ–°è¨‚å–®ç‹€æ…‹å¤±æ•—:', order.orderNo, err);
            }
        }
    }

    saveWaves();

    var mins = Math.round((new Date(wave.completedAt) - new Date(wave.createdAt)) / 60000);
    alert('âœ… æ³¢æ¬¡ ' + wave.waveNo + ' å·²å®Œæˆå‡ºè²¨ï¼\n\nè¨‚å–®æ•¸ï¼š' + (wave.orders || []).length + ' ç­†\nç¸½è€—æ™‚ï¼š' + mins + ' åˆ†é˜');

    closeSortingModal();
    refreshWaveList();
};

window.viewWaveDetail = function(waveNo) {
    var wave = window._waveData.waves.find(function(w) { return w.waveNo === waveNo; });
    if (!wave) return;

    var statusMap = { pending: 'å¾…æ€è²¨', picking: 'æ€è²¨ä¸­', sorting: 'å¾…åˆ†è²¨', done: 'å·²å‡ºè²¨' };
    var timeInfo = 'å»ºç«‹ï¼š' + new Date(wave.createdAt).toLocaleString('zh-TW');
    if (wave.startedAt) timeInfo += '\né–‹å§‹æ€è²¨ï¼š' + new Date(wave.startedAt).toLocaleString('zh-TW');
    if (wave.pickedAt) timeInfo += '\næ€è²¨å®Œæˆï¼š' + new Date(wave.pickedAt).toLocaleString('zh-TW');
    if (wave.completedAt) timeInfo += '\nå‡ºè²¨å®Œæˆï¼š' + new Date(wave.completedAt).toLocaleString('zh-TW');

    var orderList = (wave.orders || []).map(function(o, i) { return (i + 1) + '. ' + o.customer + ' (' + o.orderNo + ')'; }).join('\n');

    alert('ã€æ³¢æ¬¡æ˜ç´°ã€‘\n\n' +
        'æ³¢æ¬¡ç·¨è™Ÿï¼š' + wave.waveNo + '\n' +
        'ç‰©æµå•†ï¼š' + wave.logistics + '\n' +
        'ç‹€æ…‹ï¼š' + (statusMap[wave.status] || wave.status) + '\n' +
        'è¨‚å–®æ•¸ï¼š' + (wave.orders || []).length + ' ç­†\n' +
        'å“é …æ•¸ï¼š' + (wave.itemCount || 0) + ' é …\n' +
        'ç¸½ä»¶æ•¸ï¼š' + (wave.totalQty || 0) + ' ä»¶ï¼ˆåŒ…è£å–®ä½ï¼‰\n' +
        (wave.totalSmallQty ? 'æœ€å°å–®ä½ï¼š' + wave.totalSmallQty + '\n' : '') + '\n' +
        'ã€æ™‚é–“è¨˜éŒ„ã€‘\n' + timeInfo + '\n\n' +
        'ã€è¨‚å–®æ¸…å–®ã€‘\n' + orderList);
};

window.deleteWave = async function(waveNo) {
    var wave = window._waveData.waves.find(function(w) { return w.waveNo === waveNo; });
    if (!wave) return;

    if (wave.status !== 'pending') {
        alert('åªèƒ½åˆªé™¤ã€Œå¾…æ€è²¨ã€ç‹€æ…‹çš„æ³¢æ¬¡');
        return;
    }

    if (!confirm('ç¢ºå®šè¦åˆªé™¤æ³¢æ¬¡ ' + waveNo + 'ï¼Ÿ\n\nè¨‚å–®æ•¸ï¼š' + (wave.orders || []).length + ' ç­†\nåˆªé™¤å¾Œè¨‚å–®å°‡æ¢å¾©ç‚ºå¾…è™•ç†ç‹€æ…‹ã€‚')) {
        return;
    }

    for (var i = 0; i < (wave.orders || []).length; i++) {
        var order = wave.orders[i];
        var orderInData = window._orderData.orders.find(function(o) { return o.orderNo === order.orderNo; });
        if (orderInData) {
            orderInData.status = 'pending';
            orderInData.waveNo = null;
        }
        if (order.id) {
            try {
                await window.updateDoc(window.doc(window.db, 'salesOrders', order.id), {
                    status: 'pending',
                    waveNo: null
                });
            } catch (err) {
                console.error('æ¢å¾©è¨‚å–®ç‹€æ…‹å¤±æ•—:', err);
            }
        }
    }

    if (wave.id) {
        try {
            await window.deleteDoc(window.doc(window.db, 'waves', wave.id));
        } catch (err) {
            console.error('åˆªé™¤æ³¢æ¬¡å¤±æ•—:', err);
        }
    }

    var idx = window._waveData.waves.findIndex(function(w) { return w.waveNo === waveNo; });
    if (idx >= 0) window._waveData.waves.splice(idx, 1);
    saveWaves();

    alert('âœ… æ³¢æ¬¡ ' + waveNo + ' å·²åˆªé™¤');
    refreshWaveList();
};

window.printWaveLabels = function(waveNo) {
    var wave = window._waveData.waves.find(function(w) { return w.waveNo === waveNo; });
    if (!wave) return;
    window._waveData.currentWave = wave;
    printAllLabels();
};

// ========== å‚™ä»½èˆ‡é‚„åŸåŠŸèƒ½ ==========

window._backupConfig = {
    lastBackupTime: localStorage.getItem('lastBackupTime') || null,
    backupReminder: parseInt(localStorage.getItem('backupReminder')) || 7, // é è¨­ 7 å¤©æé†’
    collections: [
        { name: 'pallets', label: 'åº«å­˜è³‡æ–™' },
        { name: 'salesOrders', label: 'éŠ·è²¨è¨‚å–®' },
        { name: 'waves', label: 'æ³¢æ¬¡è³‡æ–™' },
        { name: 'inventoryLogs', label: 'ç•°å‹•è¨˜éŒ„' },
        { name: 'inboundOrders', label: 'å…¥åº«å–®' },
        { name: 'inboundTasks', label: 'å…¥åº«ä»»å‹™' },
        { name: 'shippingOrders', label: 'å‡ºè²¨å–®' },
        { name: 'dispatchOrders', label: 'æ´¾è»Šå–®' },
        { name: 'externalStock', label: 'å¤–éƒ¨åº«å­˜' },
        { name: 'productMaster', label: 'å“é …ä¸»æª”' },
        { name: 'warehouses', label: 'å¤–å€‰è¨­å®š' },
        { name: 'consignments', label: 'å¯„å€‰è³‡æ–™' },
        { name: 'settings', label: 'ç³»çµ±è¨­å®š' }
    ]
};

window.checkBackupReminder = function() {
    var lastBackup = window._backupConfig.lastBackupTime;
    var reminderDays = window._backupConfig.backupReminder;

    if (!lastBackup) {
        showBackupReminder('æ‚¨å°šæœªå‚™ä»½éè³‡æ–™ï¼Œå»ºè­°ç«‹å³å‚™ä»½ï¼');
        return;
    }

    var lastDate = new Date(lastBackup);
    var now = new Date();
    var diffDays = Math.floor((now - lastDate) / (1000 * 60 * 60 * 24));

    if (diffDays >= reminderDays) {
        showBackupReminder('è·é›¢ä¸Šæ¬¡å‚™ä»½å·²ç¶“ ' + diffDays + ' å¤©ï¼Œå»ºè­°ç«‹å³å‚™ä»½ï¼');
    }
};

window.showBackupReminder = function(message) {
    var reminder = document.createElement('div');
    reminder.id = 'backup-reminder';
    reminder.className = 'fixed bottom-4 right-4 bg-orange-600 text-white p-4 rounded-lg shadow-lg z-50 max-w-sm';
    reminder.innerHTML =
        '<div class="flex items-start gap-3">' +
        '<i class="fa-solid fa-database text-2xl"></i>' +
        '<div class="flex-1">' +
        '<div class="font-bold">å‚™ä»½æé†’</div>' +
        '<div class="text-sm mt-1">' + message + '</div>' +
        '<div class="flex gap-2 mt-3">' +
        '<button onclick="openBackupModal(); closeBackupReminder();" class="bg-white text-orange-600 px-3 py-1 rounded text-sm font-bold">ç«‹å³å‚™ä»½</button>' +
        '<button onclick="closeBackupReminder()" class="text-white/80 hover:text-white text-sm">ç¨å¾Œæé†’</button>' +
        '</div></div>' +
        '<button onclick="closeBackupReminder()" class="text-white/60 hover:text-white"><i class="fa-solid fa-xmark"></i></button>' +
        '</div>';
    document.body.appendChild(reminder);
};

window.closeBackupReminder = function() {
    var reminder = document.getElementById('backup-reminder');
    if (reminder) reminder.remove();
};

window.openBackupModal = function() {
    var lastBackup = window._backupConfig.lastBackupTime;
    var lastBackupStr = lastBackup ? new Date(lastBackup).toLocaleString('zh-TW') : 'å¾æœªå‚™ä»½';

    var modal = document.createElement('div');
    modal.id = 'backup-modal';
    modal.className = 'fixed inset-0 bg-black/80 flex items-center justify-center z-50';
    modal.innerHTML =
        '<div class="bg-slate-800 rounded-xl p-6 w-[600px] max-h-[80vh] overflow-y-auto border border-slate-600">' +
        '<div class="flex justify-between items-center mb-4">' +
        '<h3 class="text-white font-bold text-lg"><i class="fa-solid fa-database mr-2 text-orange-400"></i>å‚™ä»½èˆ‡é‚„åŸ</h3>' +
        '<button onclick="closeBackupModal()" class="text-slate-400 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>' +
        '</div>' +

        '<div class="bg-slate-700/50 rounded-lg p-4 mb-4">' +
        '<div class="flex justify-between items-center">' +
        '<div><div class="text-slate-400 text-sm">ä¸Šæ¬¡å‚™ä»½æ™‚é–“</div>' +
        '<div class="text-white font-bold">' + lastBackupStr + '</div></div>' +
        '<div id="backup-status"></div>' +
        '</div></div>' +

        '<div class="bg-slate-700/30 rounded-lg p-4 mb-4 border border-slate-600">' +
        '<div class="flex items-center gap-2 mb-3">' +
        '<i class="fa-solid fa-file-excel text-emerald-400 text-xl"></i>' +
        '<div><div class="text-white font-bold">æ–¹å¼ä¸€ï¼šExcel å‚™ä»½</div>' +
        '<div class="text-slate-400 text-xs">åŒ¯å‡ºæ‰€æœ‰è³‡æ–™ç‚º Excel æª”æ¡ˆï¼Œå¯é›¢ç·šä¿å­˜</div></div>' +
        '</div>' +
        '<div class="grid grid-cols-2 gap-3">' +
        '<button onclick="exportBackupExcel()" class="bg-emerald-600 hover:bg-emerald-500 text-white py-3 rounded-lg font-bold">' +
        '<i class="fa-solid fa-download mr-2"></i>åŒ¯å‡ºå‚™ä»½</button>' +
        '<div><input type="file" id="restore-excel-input" accept=".xlsx" class="hidden" onchange="restoreFromExcel(event)">' +
        '<button onclick="document.getElementById(\'restore-excel-input\').click()" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-lg font-bold">' +
        '<i class="fa-solid fa-upload mr-2"></i>é‚„åŸå‚™ä»½</button></div>' +
        '</div>' +
        '</div>' +

        '<div class="bg-slate-700/30 rounded-lg p-4 mb-4 border border-slate-600">' +
        '<div class="flex items-center gap-2 mb-3">' +
        '<i class="fa-solid fa-cloud text-blue-400 text-xl"></i>' +
        '<div><div class="text-white font-bold">æ–¹å¼äºŒï¼šé›²ç«¯å‚™ä»½ (Firebase)</div>' +
        '<div class="text-slate-400 text-xs">å‚™ä»½åˆ° Firebase é›²ç«¯ï¼Œå¯è·¨è£ç½®é‚„åŸ</div></div>' +
        '</div>' +
        '<div class="grid grid-cols-2 gap-3 mb-3">' +
        '<button onclick="exportBackupToFirebase()" class="bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-lg font-bold">' +
        '<i class="fa-solid fa-cloud-arrow-up mr-2"></i>å‚™ä»½åˆ°é›²ç«¯</button>' +
        '<button onclick="showCloudBackupList()" class="bg-slate-600 hover:bg-slate-500 text-white py-3 rounded-lg font-bold">' +
        '<i class="fa-solid fa-list mr-2"></i>æŸ¥çœ‹é›²ç«¯å‚™ä»½</button>' +
        '</div>' +
        '<div id="cloud-backup-list" class="hidden"></div>' +
        '</div>' +

        '<div class="bg-slate-700/30 rounded-lg p-4 border border-slate-600">' +
        '<div class="flex items-center gap-2 mb-3">' +
        '<i class="fa-solid fa-bell text-yellow-400 text-xl"></i>' +
        '<div class="text-white font-bold">å‚™ä»½æé†’è¨­å®š</div>' +
        '</div>' +
        '<div class="flex items-center gap-3">' +
        '<span class="text-slate-300">æ¯</span>' +
        '<select id="backup-reminder-days" class="scan-input w-20 text-center" onchange="updateBackupReminder()">' +
        '<option value="1"' + (window._backupConfig.backupReminder === 1 ? ' selected' : '') + '>1</option>' +
        '<option value="3"' + (window._backupConfig.backupReminder === 3 ? ' selected' : '') + '>3</option>' +
        '<option value="7"' + (window._backupConfig.backupReminder === 7 ? ' selected' : '') + '>7</option>' +
        '<option value="14"' + (window._backupConfig.backupReminder === 14 ? ' selected' : '') + '>14</option>' +
        '<option value="30"' + (window._backupConfig.backupReminder === 30 ? ' selected' : '') + '>30</option>' +
        '</select>' +
        '<span class="text-slate-300">å¤©æé†’ä¸€æ¬¡</span>' +
        '</div>' +
        '</div>' +

        '</div>';

    document.body.appendChild(modal);
};

window.closeBackupModal = function() {
    var modal = document.getElementById('backup-modal');
    if (modal) modal.remove();
};

window.updateBackupReminder = function() {
    var days = parseInt(document.getElementById('backup-reminder-days').value);
    window._backupConfig.backupReminder = days;
    localStorage.setItem('backupReminder', days);
};

// ========== Excel å‚™ä»½ ==========

window.serializeFirestoreData = function(data) {
    if (!data) return data;
    if (data.toDate && typeof data.toDate === 'function') {
        return data.toDate().toISOString();
    }
    if (Array.isArray(data)) {
        return data.map(function(item) { return serializeFirestoreData(item); });
    }
    if (typeof data === 'object') {
        var result = {};
        Object.keys(data).forEach(function(key) {
            result[key] = serializeFirestoreData(data[key]);
        });
        return result;
    }
    return data;
};

window.exportBackupExcel = async function() {
    var statusEl = document.getElementById('backup-status');
    statusEl.innerHTML = '<span class="text-yellow-400"><i class="fa-solid fa-spinner fa-spin mr-1"></i>å‚™ä»½ä¸­...</span>';

    try {
        var wb = XLSX.utils.book_new();
        var timestamp = new Date().toISOString().slice(0, 10);
        var collections = window._backupConfig.collections;
        var summary = { timestamp: new Date().toISOString(), version: 'WMS v3.0', collections: {} };

        for (var i = 0; i < collections.length; i++) {
            var col = collections[i];
            statusEl.innerHTML = '<span class="text-yellow-400"><i class="fa-solid fa-spinner fa-spin mr-1"></i>å‚™ä»½ ' + col.label + '... (' + (i+1) + '/' + collections.length + ')</span>';

            try {
                var snap = await window.getDocs(window.collection(window.db, col.name));
                var data = [];

                snap.forEach(function(doc) {
                    var d = serializeFirestoreData(doc.data());
                    data.push({
                        '_docId': doc.id,
                        '_data': JSON.stringify(d)
                    });
                });

                summary.collections[col.name] = data.length;

                if (data.length > 0) {
                    var ws = XLSX.utils.json_to_sheet(data);
                    var sheetName = col.label.substring(0, 31);
                    XLSX.utils.book_append_sheet(wb, ws, sheetName);
                }
            } catch (e) {
                console.log('å‚™ä»½ ' + col.name + ' è·³é:', e);
                summary.collections[col.name] = 0;
            }
        }

        var infoData = [{
            'å‚™ä»½æ™‚é–“': summary.timestamp,
            'ç³»çµ±ç‰ˆæœ¬': summary.version,
            'å‚™ä»½å…§å®¹': JSON.stringify(summary.collections)
        }];
        var wsInfo = XLSX.utils.json_to_sheet(infoData);
        XLSX.utils.book_append_sheet(wb, wsInfo, '_å‚™ä»½è³‡è¨Š');

        var filename = 'WMSå®Œæ•´å‚™ä»½_' + timestamp + '.xlsx';
        XLSX.writeFile(wb, filename);

        var now = new Date().toISOString();
        window._backupConfig.lastBackupTime = now;
        localStorage.setItem('lastBackupTime', now);

        var summaryText = Object.keys(summary.collections).map(function(k) {
            var col = collections.find(function(c) { return c.name === k; });
            return (col ? col.label : k) + ': ' + summary.collections[k] + ' ç­†';
        }).join('\n');

        statusEl.innerHTML = '<span class="text-emerald-400"><i class="fa-solid fa-check mr-1"></i>å‚™ä»½å®Œæˆï¼</span>';

        setTimeout(function() {
            closeBackupModal();
            alert('âœ… å®Œæ•´å‚™ä»½å®Œæˆï¼\n\næª”æ¡ˆï¼š' + filename + '\n\n' + summaryText);
        }, 500);

    } catch (err) {
        console.error('å‚™ä»½å¤±æ•—:', err);
        statusEl.innerHTML = '<span class="text-red-400"><i class="fa-solid fa-xmark mr-1"></i>å‚™ä»½å¤±æ•—</span>';
        alert('å‚™ä»½å¤±æ•—ï¼š' + err.message);
    }
};

window.deserializeData = function(data) {
    if (!data) return data;
    if (typeof data === 'string') {
        if (/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/.test(data)) {
            return new Date(data);
        }
        return data;
    }
    if (Array.isArray(data)) {
        return data.map(function(item) { return deserializeData(item); });
    }
    if (typeof data === 'object') {
        var result = {};
        Object.keys(data).forEach(function(key) {
            result[key] = deserializeData(data[key]);
        });
        return result;
    }
    return data;
};

window.clearCollection = async function(collectionName) {
    var snap = await window.getDocs(window.collection(window.db, collectionName));
    var batch = window.writeBatch(window.db);
    var count = 0;

    snap.forEach(function(doc) {
        batch.delete(doc.ref);
        count++;
        if (count >= 450) {
            return;
        }
    });

    if (count > 0) {
        await batch.commit();
    }

    if (snap.size >= 450) {
        await clearCollection(collectionName);
    }

    return count;
};

window.restoreFromExcel = async function(event) {
    var file = event.target.files[0];
    if (!file) return;

    if (!confirm('âš ï¸ è­¦å‘Šï¼šä¸€éµé‚„åŸå°‡åŸ·è¡Œä»¥ä¸‹æ“ä½œï¼š\n\n1. æ¸…ç©ºç¾æœ‰æ‰€æœ‰è³‡æ–™\n2. å¾å‚™ä»½æª”æ¡ˆå®Œæ•´é‚„åŸ\n\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼ç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ')) {
        event.target.value = '';
        return;
    }

    if (!confirm('ğŸ”´ æœ€å¾Œç¢ºèªï¼š\n\næ‰€æœ‰ç¾æœ‰è³‡æ–™å°‡è¢«åˆªé™¤ä¸¦æ›¿æ›ç‚ºå‚™ä»½å…§å®¹ï¼\n\nè«‹è¼¸å…¥ã€Œç¢ºå®šã€ç¹¼çºŒ...') || !confirm('ç¢ºå®šé‚„åŸï¼Ÿ')) {
        event.target.value = '';
        return;
    }

    var statusEl = document.getElementById('backup-status');
    statusEl.innerHTML = '<span class="text-yellow-400"><i class="fa-solid fa-spinner fa-spin mr-1"></i>è®€å–å‚™ä»½æª”æ¡ˆ...</span>';

    try {
        var reader = new FileReader();
        reader.onload = async function(e) {
            var data = new Uint8Array(e.target.result);
            var workbook = XLSX.read(data, { type: 'array' });
            var collections = window._backupConfig.collections;
            var restored = {};

            var sheetToCollection = {};
            collections.forEach(function(col) {
                sheetToCollection[col.label.substring(0, 31)] = col.name;
            });

            statusEl.innerHTML = '<span class="text-red-400"><i class="fa-solid fa-spinner fa-spin mr-1"></i>æ¸…ç©ºç¾æœ‰è³‡æ–™...</span>';

            for (var i = 0; i < collections.length; i++) {
                var col = collections[i];
                statusEl.innerHTML = '<span class="text-red-400"><i class="fa-solid fa-spinner fa-spin mr-1"></i>æ¸…ç©º ' + col.label + '...</span>';
                try {
                    await clearCollection(col.name);
                } catch (e) {
                    console.log('æ¸…ç©º ' + col.name + ' è·³é:', e);
                }
            }

            for (var i = 0; i < workbook.SheetNames.length; i++) {
                var sheetName = workbook.SheetNames[i];

                if (sheetName === '_å‚™ä»½è³‡è¨Š') continue;

                var collectionName = sheetToCollection[sheetName];
                if (!collectionName) {
                    console.log('æœªçŸ¥å·¥ä½œè¡¨:', sheetName);
                    continue;
                }

                var colConfig = collections.find(function(c) { return c.name === collectionName; });
                statusEl.innerHTML = '<span class="text-yellow-400"><i class="fa-solid fa-spinner fa-spin mr-1"></i>é‚„åŸ ' + (colConfig ? colConfig.label : collectionName) + '...</span>';

                var sheet = workbook.Sheets[sheetName];
                var rows = XLSX.utils.sheet_to_json(sheet);

                restored[collectionName] = 0;

                for (var j = 0; j < rows.length; j++) {
                    var row = rows[j];
                    var docId = row['_docId'] || (collectionName + '-' + Date.now() + '-' + j);
                    var docData = {};

                    try {
                        docData = JSON.parse(row['_data'] || '{}');
                        docData = deserializeData(docData);
                    } catch (e) {
                        console.log('è§£æè³‡æ–™å¤±æ•—:', e);
                        continue;
                    }

                    await window.setDoc(window.doc(window.db, collectionName, docId), docData);
                    restored[collectionName]++;
                }
            }

            var summaryText = Object.keys(restored).map(function(k) {
                var col = collections.find(function(c) { return c.name === k; });
                return (col ? col.label : k) + ': ' + restored[k] + ' ç­†';
            }).join('\n');

            statusEl.innerHTML = '<span class="text-emerald-400"><i class="fa-solid fa-check mr-1"></i>é‚„åŸå®Œæˆï¼</span>';

            alert('âœ… ä¸€éµé‚„åŸå®Œæˆï¼\n\n' + summaryText + '\n\né é¢å°‡é‡æ–°è¼‰å…¥...');

            setTimeout(function() { location.reload(); }, 1000);
        };

        reader.readAsArrayBuffer(file);

    } catch (err) {
        console.error('é‚„åŸå¤±æ•—:', err);
        statusEl.innerHTML = '<span class="text-red-400"><i class="fa-solid fa-xmark mr-1"></i>é‚„åŸå¤±æ•—</span>';
        alert('é‚„åŸå¤±æ•—ï¼š' + err.message);
    }

    event.target.value = '';
};

// ========== Firebase é›²ç«¯å‚™ä»½ ==========

window.exportBackupToFirebase = async function() {
    var statusEl = document.getElementById('backup-status');
    statusEl.innerHTML = '<span class="text-yellow-400"><i class="fa-solid fa-spinner fa-spin mr-1"></i>å‚™ä»½åˆ°é›²ç«¯...</span>';

    try {
        var timestamp = new Date().toISOString();
        var backupId = 'backup-' + timestamp.replace(/[:.]/g, '-');
        var collections = window._backupConfig.collections;

        var backupData = {
            id: backupId,
            timestamp: timestamp,
            version: 'WMS v3.0',
            collections: {}
        };

        var summary = {};

        for (var i = 0; i < collections.length; i++) {
            var col = collections[i];
            statusEl.innerHTML = '<span class="text-yellow-400"><i class="fa-solid fa-spinner fa-spin mr-1"></i>å‚™ä»½ ' + col.label + '...</span>';

            try {
                var snap = await window.getDocs(window.collection(window.db, col.name));
                backupData.collections[col.name] = [];

                snap.forEach(function(doc) {
                    var d = serializeFirestoreData(doc.data());
                    backupData.collections[col.name].push({ id: doc.id, data: d });
                });

                summary[col.name] = backupData.collections[col.name].length;
            } catch (e) {
                console.log('å‚™ä»½ ' + col.name + ' è·³é:', e);
                summary[col.name] = 0;
            }
        }

        await window.setDoc(window.doc(window.db, 'backups', backupId), {
            timestamp: timestamp,
            version: 'WMS v3.0',
            summary: summary,
            data: JSON.stringify(backupData)
        });

        window._backupConfig.lastBackupTime = timestamp;
        localStorage.setItem('lastBackupTime', timestamp);

        var summaryText = Object.keys(summary).map(function(k) {
            var col = collections.find(function(c) { return c.name === k; });
            return (col ? col.label : k) + ': ' + summary[k] + ' ç­†';
        }).join('\n');

        statusEl.innerHTML = '<span class="text-emerald-400"><i class="fa-solid fa-check mr-1"></i>é›²ç«¯å‚™ä»½å®Œæˆï¼</span>';

        alert('âœ… é›²ç«¯å‚™ä»½å®Œæˆï¼\n\nå‚™ä»½IDï¼š' + backupId + '\n\n' + summaryText);

    } catch (err) {
        console.error('é›²ç«¯å‚™ä»½å¤±æ•—:', err);
        statusEl.innerHTML = '<span class="text-red-400"><i class="fa-solid fa-xmark mr-1"></i>å‚™ä»½å¤±æ•—</span>';
        alert('é›²ç«¯å‚™ä»½å¤±æ•—ï¼š' + err.message);
    }
};

window.showCloudBackupList = async function() {
    var listEl = document.getElementById('cloud-backup-list');
    listEl.classList.remove('hidden');
    listEl.innerHTML = '<div class="text-center py-4"><i class="fa-solid fa-spinner fa-spin mr-1"></i>è¼‰å…¥ä¸­...</div>';

    try {
        var backupsSnap = await window.getDocs(window.collection(window.db, 'backups'));
        var backups = [];
        backupsSnap.forEach(function(doc) {
            var d = doc.data();
            backups.push({
                id: doc.id,
                timestamp: d.timestamp,
                palletsCount: d.palletsCount || 0,
                ordersCount: d.ordersCount || 0,
                wavesCount: d.wavesCount || 0
            });
        });

        backups.sort(function(a, b) {
            return new Date(b.timestamp) - new Date(a.timestamp);
        });

        if (backups.length === 0) {
            listEl.innerHTML = '<div class="text-center py-4 text-slate-400">å°šç„¡é›²ç«¯å‚™ä»½</div>';
            return;
        }

        var html = '<div class="max-h-48 overflow-y-auto space-y-2 mt-3">';
        backups.forEach(function(b) {
            var date = new Date(b.timestamp).toLocaleString('zh-TW');
            html += '<div class="bg-slate-800 p-3 rounded flex justify-between items-center">' +
                '<div>' +
                '<div class="text-white text-sm">' + date + '</div>' +
                '<div class="text-slate-400 text-xs">åº«å­˜ ' + b.palletsCount + ' / è¨‚å–® ' + b.ordersCount + ' / æ³¢æ¬¡ ' + b.wavesCount + '</div>' +
                '</div>' +
                '<div class="flex gap-2">' +
                '<button onclick="restoreFromFirebase(\'' + b.id + '\')" class="bg-blue-600 hover:bg-blue-500 text-white px-2 py-1 rounded text-xs">é‚„åŸ</button>' +
                '<button onclick="deleteCloudBackup(\'' + b.id + '\')" class="bg-red-600 hover:bg-red-500 text-white px-2 py-1 rounded text-xs">åˆªé™¤</button>' +
                '</div></div>';
        });
        html += '</div>';

        listEl.innerHTML = html;

    } catch (err) {
        console.error('è¼‰å…¥å‚™ä»½åˆ—è¡¨å¤±æ•—:', err);
        listEl.innerHTML = '<div class="text-center py-4 text-red-400">è¼‰å…¥å¤±æ•—</div>';
    }
};

window.restoreFromFirebase = async function(backupId) {
    if (!confirm('âš ï¸ è­¦å‘Šï¼šä¸€éµé‚„åŸå°‡åŸ·è¡Œä»¥ä¸‹æ“ä½œï¼š\n\n1. æ¸…ç©ºç¾æœ‰æ‰€æœ‰è³‡æ–™\n2. å¾é›²ç«¯å‚™ä»½å®Œæ•´é‚„åŸ\n\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼ç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ')) return;

    if (!confirm('ğŸ”´ æœ€å¾Œç¢ºèªï¼šç¢ºå®šé‚„åŸï¼Ÿ')) return;

    var statusEl = document.getElementById('backup-status');
    statusEl.innerHTML = '<span class="text-yellow-400"><i class="fa-solid fa-spinner fa-spin mr-1"></i>è®€å–é›²ç«¯å‚™ä»½...</span>';

    try {
        var backupDoc = await window.getDoc(window.doc(window.db, 'backups', backupId));
        if (!backupDoc.exists()) {
            alert('å‚™ä»½ä¸å­˜åœ¨');
            return;
        }

        var backupData = JSON.parse(backupDoc.data().data);
        var collections = window._backupConfig.collections;
        var restored = {};

        statusEl.innerHTML = '<span class="text-red-400"><i class="fa-solid fa-spinner fa-spin mr-1"></i>æ¸…ç©ºç¾æœ‰è³‡æ–™...</span>';

        for (var i = 0; i < collections.length; i++) {
            var col = collections[i];
            statusEl.innerHTML = '<span class="text-red-400"><i class="fa-solid fa-spinner fa-spin mr-1"></i>æ¸…ç©º ' + col.label + '...</span>';
            try {
                await clearCollection(col.name);
            } catch (e) {
                console.log('æ¸…ç©º ' + col.name + ' è·³é:', e);
            }
        }

        var collectionNames = Object.keys(backupData.collections || {});

        for (var i = 0; i < collectionNames.length; i++) {
            var colName = collectionNames[i];
            var colConfig = collections.find(function(c) { return c.name === colName; });
            var items = backupData.collections[colName] || [];

            statusEl.innerHTML = '<span class="text-yellow-400"><i class="fa-solid fa-spinner fa-spin mr-1"></i>é‚„åŸ ' + (colConfig ? colConfig.label : colName) + '...</span>';

            restored[colName] = 0;

            for (var j = 0; j < items.length; j++) {
                var item = items[j];
                var docData = deserializeData(item.data);
                await window.setDoc(window.doc(window.db, colName, item.id), docData);
                restored[colName]++;
            }
        }

        var summaryText = Object.keys(restored).map(function(k) {
            var col = collections.find(function(c) { return c.name === k; });
            return (col ? col.label : k) + ': ' + restored[k] + ' ç­†';
        }).join('\n');

        statusEl.innerHTML = '<span class="text-emerald-400"><i class="fa-solid fa-check mr-1"></i>é‚„åŸå®Œæˆï¼</span>';

        alert('âœ… ä¸€éµé‚„åŸå®Œæˆï¼\n\n' + summaryText + '\n\né é¢å°‡é‡æ–°è¼‰å…¥...');

        setTimeout(function() { location.reload(); }, 1000);

    } catch (err) {
        console.error('é‚„åŸå¤±æ•—:', err);
        statusEl.innerHTML = '<span class="text-red-400"><i class="fa-solid fa-xmark mr-1"></i>é‚„åŸå¤±æ•—</span>';
        alert('é‚„åŸå¤±æ•—ï¼š' + err.message);
    }
};

window.deleteCloudBackup = async function(backupId) {
    if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å‚™ä»½ï¼Ÿ')) return;

    try {
        await window.deleteDoc(window.doc(window.db, 'backups', backupId));
        showCloudBackupList();
    } catch (err) {
        alert('åˆªé™¤å¤±æ•—ï¼š' + err.message);
    }
};

setTimeout(function() {
    checkBackupReminder();
}, 3000);

// ========== æ¸…é™¤è³‡æ–™åŠŸèƒ½ ==========

window.openClearDataModal = function() {
    var modal = document.createElement('div');
    modal.id = 'modal-clear-data';
    modal.className = 'fixed inset-0 z-50 bg-black/80 flex items-center justify-center backdrop-blur-sm';

    var waveCount = (window._waveData.waves || []).length;
    var orderCount = (window._orderData.orders || []).length;
    var pendingOrders = window._orderData.orders.filter(function(o) { return o.status === 'pending'; }).length;
    var inWaveOrders = window._orderData.orders.filter(function(o) { return o.waveNo; }).length;

    modal.innerHTML = '<div class="bg-slate-900 border border-slate-700 rounded-2xl w-[500px] shadow-2xl">' +
        '<div class="bg-gradient-to-r from-red-900 to-orange-900 p-4 rounded-t-2xl border-b border-slate-700">' +
        '<h3 class="text-white font-bold text-lg"><i class="fa-solid fa-triangle-exclamation mr-2 text-yellow-400"></i>æ¸…é™¤è³‡æ–™</h3>' +
        '<p class="text-red-200 text-xs mt-1">æ­¤æ“ä½œç„¡æ³•å¾©åŸï¼Œè«‹è¬¹æ…é¸æ“‡</p></div>' +
        '<div class="p-6">' +
        '<div class="bg-slate-800 rounded-lg p-4 mb-4">' +
        '<div class="text-slate-300 text-sm mb-2">ç›®å‰è³‡æ–™ç‹€æ…‹ï¼š</div>' +
        '<div class="grid grid-cols-2 gap-2 text-sm">' +
        '<div class="text-slate-400">æ³¢æ¬¡æ•¸é‡ï¼š<span class="text-white font-bold">' + waveCount + '</span></div>' +
        '<div class="text-slate-400">è¨‚å–®ç¸½æ•¸ï¼š<span class="text-white font-bold">' + orderCount + '</span></div>' +
        '<div class="text-slate-400">å¾…è™•ç†è¨‚å–®ï¼š<span class="text-yellow-400 font-bold">' + pendingOrders + '</span></div>' +
        '<div class="text-slate-400">å·²å»ºæ³¢æ¬¡è¨‚å–®ï¼š<span class="text-blue-400 font-bold">' + inWaveOrders + '</span></div>' +
        '</div></div>' +
        '<div class="space-y-3">' +
        '<button onclick="clearAllWaves()" class="w-full py-3 bg-orange-600 hover:bg-orange-500 text-white rounded-lg font-bold text-left px-4">' +
        '<i class="fa-solid fa-layer-group mr-2"></i>æ¸…é™¤æ‰€æœ‰æ³¢æ¬¡<br><span class="text-xs text-orange-200 font-normal">è¨‚å–®ä¿ç•™ï¼Œæ³¢æ¬¡å…¨éƒ¨åˆªé™¤ï¼Œè¨‚å–®ç‹€æ…‹æ¢å¾©ç‚ºå¾…è™•ç†</span></button>' +
        '<button onclick="clearAllOrders()" class="w-full py-3 bg-red-600 hover:bg-red-500 text-white rounded-lg font-bold text-left px-4">' +
        '<i class="fa-solid fa-file-lines mr-2"></i>æ¸…é™¤æ‰€æœ‰è¨‚å–®<br><span class="text-xs text-red-200 font-normal">è¨‚å–®å’Œæ³¢æ¬¡å…¨éƒ¨åˆªé™¤ï¼ˆå¾ Firebase ç§»é™¤ï¼‰</span></button>' +
        '<button onclick="clearLocalStorage()" class="w-full py-3 bg-slate-600 hover:bg-slate-500 text-white rounded-lg font-bold text-left px-4">' +
        '<i class="fa-solid fa-database mr-2"></i>æ¸…é™¤æœ¬æ©Ÿå¿«å–<br><span class="text-xs text-slate-300 font-normal">åƒ…æ¸…é™¤ç€è¦½å™¨ localStorageï¼Œä¸å½±éŸ¿ Firebase è³‡æ–™</span></button>' +
        '</div></div>' +
        '<div class="p-4 border-t border-slate-700 flex justify-end">' +
        '<button onclick="closeClearDataModal()" class="px-6 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg">é—œé–‰</button>' +
        '</div></div>';

    document.body.appendChild(modal);
};

window.closeClearDataModal = function() {
    var modal = document.getElementById('modal-clear-data');
    if (modal) modal.remove();
};

window.clearAllWaves = async function() {
    var waveCount = (window._waveData.waves || []).length;
    if (waveCount === 0) {
        alert('ç›®å‰æ²’æœ‰æ³¢æ¬¡è³‡æ–™');
        return;
    }

    if (!confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰ ' + waveCount + ' å€‹æ³¢æ¬¡å—ï¼Ÿ\n\nè¨‚å–®æœƒä¿ç•™ï¼Œç‹€æ…‹æ¢å¾©ç‚ºå¾…è™•ç†\næ­¤æ“ä½œç„¡æ³•å¾©åŸ')) {
        return;
    }

    for (var i = 0; i < window._waveData.waves.length; i++) {
        var wave = window._waveData.waves[i];
        (wave.orders || []).forEach(function(order) {
            var o = window._orderData.orders.find(function(x) { return x.orderNo === order.orderNo; });
            if (o) {
                o.status = 'pending';
                o.waveNo = null;
                if (o.id) {
                    window.updateDoc(window.doc(window.db, 'salesOrders', o.id), {
                        status: 'pending', waveNo: null
                    }).catch(function(err) { console.error(err); });
                }
            }
        });

        if (wave.id) {
            window.deleteDoc(window.doc(window.db, 'waves', wave.id)).catch(function(err) {
                console.error(err);
            });
        }
    }

    window._waveData.waves = [];
    saveWaves();
    refreshWaveList();
    renderOrderList();
    closeClearDataModal();

    alert('å·²æ¸…é™¤ ' + waveCount + ' å€‹æ³¢æ¬¡ï¼');
};

window.clearAllOrders = async function() {
    var orderCount = (window._orderData.orders || []).length;
    var waveCount = (window._waveData.waves || []).length;

    if (orderCount === 0 && waveCount === 0) {
        alert('ç›®å‰æ²’æœ‰è³‡æ–™');
        return;
    }

    if (!confirm('è­¦å‘Šï¼å°‡æ°¸ä¹…åˆªé™¤ï¼š\n\n' + orderCount + ' ç­†è¨‚å–®\n' + waveCount + ' å€‹æ³¢æ¬¡\n\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) return;
    if (!confirm('å†æ¬¡ç¢ºèªï¼šç¢ºå®šè¦åˆªé™¤æ‰€æœ‰è³‡æ–™å—ï¼Ÿ')) return;

    var progressDiv = document.createElement('div');
    progressDiv.id = 'clear-progress';
    progressDiv.className = 'fixed inset-0 bg-black/90 flex items-center justify-center z-[200]';
    progressDiv.innerHTML = '<div class="bg-slate-800 rounded-xl p-8 text-center">' +
        '<i class="fa-solid fa-trash fa-spin text-4xl text-red-400 mb-4"></i>' +
        '<div class="text-white text-lg">æ¸…é™¤è³‡æ–™ä¸­...</div></div>';
    document.body.appendChild(progressDiv);

    for (var i = 0; i < window._orderData.orders.length; i++) {
        var order = window._orderData.orders[i];
        if (order.id) {
            try { await window.deleteDoc(window.doc(window.db, 'salesOrders', order.id)); } catch (err) {}
        }
    }

    for (var j = 0; j < window._waveData.waves.length; j++) {
        var wave = window._waveData.waves[j];
        if (wave.id) {
            try { await window.deleteDoc(window.doc(window.db, 'waves', wave.id)); } catch (err) {}
        }
    }

    window._orderData.orders = [];
    window._waveData.waves = [];
    localStorage.removeItem('wms_waves');

    document.getElementById('clear-progress').remove();

    refreshWaveList();
    renderOrderList();
    closeClearDataModal();

    alert('å·²æ¸…é™¤æ‰€æœ‰è³‡æ–™ï¼');
};

window.clearLocalStorage = function() {
    if (!confirm('ç¢ºå®šè¦æ¸…é™¤æœ¬æ©Ÿå¿«å–å—ï¼Ÿ')) return;

    localStorage.removeItem('wms_waves');
    localStorage.removeItem('wms_orders');

    closeClearDataModal();
    alert('æœ¬æ©Ÿå¿«å–å·²æ¸…é™¤ï¼é é¢å°‡é‡æ–°è¼‰å…¥ã€‚');
    location.reload();
};

        window.openCreateWaveModal = function() {
            var orders = (window._orderData && window._orderData.orders) ? window._orderData.orders.filter(function(o) {
                return o.status === 'pending' || o.status === 'confirmed';
            }) : [];

            if (orders.length === 0) {
                alert('ç›®å‰æ²’æœ‰å¾…å‡ºè²¨è¨‚å–®');
                return;
            }

            var logistics = {};
            orders.forEach(function(o) {
                var l = o.logistics || 'æœªæŒ‡å®š';
                logistics[l] = true;
            });

            var logisticsSelect = document.getElementById('wave-filter-logistics');
            logisticsSelect.innerHTML = '<option value="">å…¨éƒ¨ç‰©æµ</option>';
            Object.keys(logistics).forEach(function(l) {
                logisticsSelect.innerHTML += '<option value="' + l + '">' + l + '</option>';
            });

            document.getElementById('wave-filter-date').value = new Date().toISOString().split('T')[0];

            window._waveCreateOrders = orders;
            renderWaveOrders(orders);
            updateWaveSelectedCount();

            document.getElementById('modal-create-wave').classList.remove('hidden');
        };

        window.closeCreateWaveModal = function() {
            document.getElementById('modal-create-wave').classList.add('hidden');
        };

        function renderWaveOrders(orders) {
            var tbody = document.getElementById('wave-orders-body');

            if (orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-slate-500 py-8">ç„¡ç¬¦åˆæ¢ä»¶çš„è¨‚å–®</td></tr>';
                return;
            }

            var html = '';
            orders.forEach(function(o) {
                html += '<tr class="hover:bg-slate-800/50 border-b border-slate-700/50">';
                html += '<td class="p-2"><input type="checkbox" class="wave-order-check w-4 h-4" data-id="' + o.id + '"></td>';
                html += '<td class="p-2 font-mono text-cyan-400">' + (o.orderNo || o.id) + '</td>';
                html += '<td class="p-2 text-white">' + (o.customer || '-') + '</td>';
                html += '<td class="p-2 text-purple-400">' + (o.logistics || '-') + '</td>';
                html += '<td class="p-2 text-slate-300">' + (o.productName || '-') + '</td>';
                html += '<td class="p-2 text-right text-yellow-400 font-bold">' + (o.quantity || 0) + '</td>';
                html += '<td class="p-2 text-slate-400 text-xs">' + (o.shipDate || '-') + '</td>';
                html += '</tr>';
            });

            tbody.innerHTML = html;

            document.querySelectorAll('.wave-order-check').forEach(function(cb) {
                cb.addEventListener('change', updateWaveSelectedCount);
            });
        }

        window.filterWaveOrders = function() {
            var logisticsFilter = document.getElementById('wave-filter-logistics').value;
            var dateFilter = document.getElementById('wave-filter-date').value;

            var filtered = (window._waveCreateOrders || []).filter(function(o) {
                if (logisticsFilter && o.logistics !== logisticsFilter) return false;
                if (dateFilter && o.shipDate !== dateFilter) return false;
                return true;
            });

            renderWaveOrders(filtered);
        };

        window.selectAllWaveOrders = function() {
            document.querySelectorAll('.wave-order-check').forEach(function(cb) { cb.checked = true; });
            updateWaveSelectedCount();
        };

        window.deselectAllWaveOrders = function() {
            document.querySelectorAll('.wave-order-check').forEach(function(cb) { cb.checked = false; });
            updateWaveSelectedCount();
        };

        window.toggleWaveCheckAll = function() {
            var checkAll = document.getElementById('wave-check-all').checked;
            document.querySelectorAll('.wave-order-check').forEach(function(cb) { cb.checked = checkAll; });
            updateWaveSelectedCount();
        };

        function updateWaveSelectedCount() {
            var count = document.querySelectorAll('.wave-order-check:checked').length;
            document.getElementById('wave-selected-count').innerText = count;
        }

        window.createWave = async function() {
            var selectedIds = [];
            document.querySelectorAll('.wave-order-check:checked').forEach(function(cb) {
                selectedIds.push(cb.dataset.id);
            });

            if (selectedIds.length === 0) {
                alert('è«‹é¸æ“‡è‡³å°‘ä¸€ç­†è¨‚å–®');
                return;
            }

            var orders = (window._waveCreateOrders || []).filter(function(o) {
                return selectedIds.indexOf(o.id) >= 0;
            });

            var logistics = {};
            var totalQty = 0;
            var itemCount = 0;
            orders.forEach(function(o) {
                var l = o.logistics || 'æœªæŒ‡å®š';
                logistics[l] = true;
                totalQty += parseInt(o.quantity) || 0;
                itemCount++;
            });

            var logisticsStr = Object.keys(logistics).join(', ');

            var wave = {
                waveNo: generateWaveNo(),
                logistics: logisticsStr,
                status: 'pending',
                orders: orders.map(function(o) { return { id: o.id, orderNo: o.orderNo, customer: o.customer, productName: o.productName, quantity: o.quantity }; }),
                itemCount: itemCount,
                totalQty: totalQty,
                createdAt: new Date().toISOString(),
                createdBy: window.getOperatorName ? window.getOperatorName() : 'system'
            };

            try {
                await window.addDoc(window.collection(window.db, 'waves'), wave);
            } catch (err) {
                console.error('å­˜åˆ° Firebase å¤±æ•—:', err);
            }

            window._waveData.waves.push(wave);
            saveWaves();

            closeCreateWaveModal();
            refreshWaveList();

            alert('âœ… æ³¢æ¬¡ ' + wave.waveNo + ' å»ºç«‹æˆåŠŸï¼\n\nåŒ…å« ' + itemCount + ' ç­†è¨‚å–®ï¼Œå…± ' + totalQty + ' ä»¶\n\nğŸ“± æ‰‹æ©Ÿç‰ˆå·²åŒæ­¥');
        };

        window.deleteWave = async function(waveNo) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ³¢æ¬¡ ' + waveNo + 'ï¼Ÿ')) return;

            try {
                var q = window.query(window.collection(window.db, 'waves'), window.where('waveNo', '==', waveNo));
                var snap = await window.getDocs(q);
                snap.forEach(async function(doc) {
                    await window.deleteDoc(doc.ref);
                });
            } catch (err) {
                console.error('Firebase åˆªé™¤å¤±æ•—:', err);
            }

            window._waveData.waves = window._waveData.waves.filter(function(w) { return w.waveNo !== waveNo; });
            saveWaves();
            refreshWaveList();
            alert('âœ… å·²åˆªé™¤æ³¢æ¬¡ ' + waveNo);
        };

        window.openWaveExecute = function(waveNo) {
            var wave = window._waveData.waves.find(function(w) { return w.waveNo === waveNo; });
            if (!wave) {
                alert('æ‰¾ä¸åˆ°æ³¢æ¬¡ ' + waveNo);
                return;
            }

            if (wave.status === 'pending') {
                wave.status = 'picking';
                wave.startedAt = new Date().toISOString();
                saveWaves();
            }

            window._waveData.currentWave = wave;
            window._waveData.completedItems = wave.completedItems || [];

            document.getElementById('wave-exec-no').innerText = wave.waveNo;
            document.getElementById('wave-exec-logistics').innerText = 'ç‰©æµå•†ï¼š' + wave.logistics;

            generatePickingList(wave);

            document.getElementById('modal-wave-execute').classList.remove('hidden');

            setTimeout(function() {
                document.getElementById('wave-scan-input').focus();
            }, 100);
        };

        window.closeWaveExecuteModal = function() {
            document.getElementById('modal-wave-execute').classList.add('hidden');
            refreshWaveList();
        };

        function generatePickingList(wave) {
            var pickingList = [];
            var pallets = window.currentPallets ? window.currentPallets() : [];

            (wave.orders || []).forEach(function(order) {
                var needed = parseInt(order.quantity) || 0;
                var productName = order.productName;

                var matchingPallets = pallets.filter(function(p) {
                    return p.productName === productName;
                }).sort(function(a, b) {
                    var dateA = a.expDate || '9999-12-31';
                    var dateB = b.expDate || '9999-12-31';
                    return dateA.localeCompare(dateB);
                });

                matchingPallets.forEach(function(pallet) {
                    if (needed <= 0) return;

                    var available = parseInt(pallet.quantity) || 0;
                    var pick = Math.min(available, needed);

                    if (pick > 0) {
                        pickingList.push({
                            id: pallet.palletId + '-' + order.id,
                            palletId: pallet.palletId,
                            locationId: pallet.locationId,
                            productName: pallet.productName,
                            spec: pallet.spec || '',
                            pickQty: pick,
                            orderNo: order.orderNo,
                            orderId: order.id,
                            customer: order.customer,
                            completed: false
                        });
                        needed -= pick;
                    }
                });

                if (needed > 0) {
                    pickingList.push({
                        id: 'shortage-' + order.id,
                        palletId: '-',
                        locationId: 'åº«å­˜ä¸è¶³',
                        productName: order.productName,
                        spec: '',
                        pickQty: needed,
                        orderNo: order.orderNo,
                        orderId: order.id,
                        customer: order.customer,
                        completed: false,
                        shortage: true
                    });
                }
            });

            var completedIds = window._waveData.completedItems || [];
            pickingList.forEach(function(item) {
                if (completedIds.indexOf(item.id) >= 0) {
                    item.completed = true;
                }
            });

            window._waveData.pickingList = pickingList;
            renderPickingList();
            updateWaveProgress();
        }

        function renderPickingList() {
            var tbody = document.getElementById('wave-picking-list');
            var list = window._waveData.pickingList;

            if (list.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-slate-500 py-8">ç„¡æ€è²¨é …ç›®</td></tr>';
                return;
            }

            list.sort(function(a, b) {
                return (a.locationId || '').localeCompare(b.locationId || '');
            });

            var html = '';
            list.forEach(function(item) {
                var statusBadge = item.completed
                    ? '<span class="badge badge-green"><i class="fa-solid fa-check"></i></span>'
                    : item.shortage
                        ? '<span class="badge badge-red"><i class="fa-solid fa-exclamation"></i></span>'
                        : '<span class="badge badge-yellow"><i class="fa-solid fa-clock"></i></span>';
                var rowClass = item.completed ? 'bg-emerald-900/20' : item.shortage ? 'bg-red-900/20' : '';

                var qtyDisplay = item.pickQty;
                if (item.totalWeight && item.totalWeight > 0 && item.availableQty > 0) {
                    var pickWeight = Math.round(item.pickQty / item.availableQty * item.totalWeight * 10) / 10;
                    if (pickWeight > 0) {
                        qtyDisplay += '<span class="text-amber-400 text-xs ml-1">/' + pickWeight + 'kg</span>';
                    }
                }

                html += '<tr class="' + rowClass + ' border-b border-slate-700/50 hover:bg-slate-800/50">';
                html += '<td class="p-2">' + statusBadge + '</td>';
                html += '<td class="p-2 font-mono text-cyan-400 font-bold">' + item.locationId + '</td>';
                html += '<td class="p-2 font-mono text-slate-300">' + item.palletId + '</td>';
                html += '<td class="p-2 text-white">' + item.productName + '</td>';
                html += '<td class="p-2 text-slate-400">' + item.spec + '</td>';
                html += '<td class="p-2 text-right text-yellow-400 font-bold">' + qtyDisplay + '</td>';
                html += '<td class="p-2 font-mono text-purple-400">' + item.orderNo + '</td>';
                html += '<td class="p-2 text-slate-300">' + item.customer + '</td>';
                html += '</tr>';
            });

            tbody.innerHTML = html;
        }

        function updateWaveProgress() {
            var list = window._waveData.pickingList;
            var completed = list.filter(function(item) { return item.completed; }).length;
            var total = list.filter(function(item) { return !item.shortage; }).length;
            document.getElementById('wave-exec-progress').innerText = completed + '/' + total;
        }

        window.confirmWaveScan = function() {
            var input = document.getElementById('wave-scan-input');
            var scanned = input.value.trim();
            var resultEl = document.getElementById('wave-scan-result');

            if (!scanned) {
                resultEl.innerHTML = '<span class="text-yellow-400"><i class="fa-solid fa-exclamation-triangle mr-1"></i>è«‹è¼¸å…¥æ¿è™Ÿæˆ–å„²ä½</span>';
                resultEl.classList.remove('hidden');
                return;
            }

            var list = window._waveData.pickingList;
            var found = null;

            for (var i = 0; i < list.length; i++) {
                if (!list[i].completed && !list[i].shortage) {
                    if (list[i].palletId === scanned || list[i].locationId === scanned) {
                        found = list[i];
                        break;
                    }
                }
            }

            if (!found) {
                resultEl.innerHTML = '<span class="text-red-400"><i class="fa-solid fa-times-circle mr-1"></i>æ‰¾ä¸åˆ°å¾…æ€é …ç›®ï¼š' + scanned + '</span>';
                resultEl.classList.remove('hidden');
                input.select();
                return;
            }

            executePickingItem(found);

            resultEl.innerHTML = '<span class="text-emerald-400"><i class="fa-solid fa-check-circle mr-1"></i>å·²æ€ï¼š' + found.locationId + ' â†’ ' + found.productName + ' x ' + found.pickQty + '</span>';
            resultEl.classList.remove('hidden');

            input.value = '';
            input.focus();
        };

        async function executePickingItem(item) {
            try {
                var q = window.query(window.collection(window.db, 'pallets'), window.where('palletId', '==', item.palletId));
                var snap = await window.getDocs(q);

                if (!snap.empty) {
                    var palletDoc = snap.docs[0];
                    var palletData = palletDoc.data();
                    var newQty = (parseInt(palletData.quantity) || 0) - item.pickQty;

                    var pickWeight = 0;
                    var newWeight = palletData.totalWeight || 0;
                    if (palletData.totalWeight > 0 && palletData.quantity > 0) {
                        pickWeight = Math.round((item.pickQty / palletData.quantity) * palletData.totalWeight * 10) / 10;
                        newWeight = Math.round((palletData.totalWeight - pickWeight) * 10) / 10;
                    }

                    await window.logInventoryChange({
                        type: 'outbound',
                        productName: palletData.productName,
                        spec: palletData.spec || '',
                        quantity: newQty,
                        weight: pickWeight,
                        quantityChange: -item.pickQty,
                        weightChange: -pickWeight,
                        locationId: item.locationId,
                        palletId: item.palletId,
                        batchNo: palletData.batchNo || '',
                        orderId: item.orderNo,
                        note: 'æ³¢æ¬¡æ€è²¨ ' + window._waveData.currentWave.waveNo + (pickWeight > 0 ? ' (' + pickWeight + 'kg)' : '')
                    });

                    if (newQty <= 0) {
                        await window.deleteDoc(palletDoc.ref);
                    } else {
                        var updateData = { quantity: newQty };
                        if (palletData.totalWeight > 0) {
                            updateData.totalWeight = newWeight;
                        }
                        await window.updateDoc(palletDoc.ref, updateData);
                    }
                }

                item.completed = true;
                window._waveData.completedItems.push(item.id);

                var wave = window._waveData.currentWave;
                wave.completedItems = window._waveData.completedItems;
                saveWaves();

                renderPickingList();
                updateWaveProgress();

            } catch (err) {
                console.error('æ€è²¨å¤±æ•—:', err);
                alert('æ€è²¨å¤±æ•—: ' + err.message);
            }
        }

        window.completeWave = async function() {
            var list = window._waveData.pickingList;
            var completed = list.filter(function(item) { return item.completed; }).length;
            var total = list.filter(function(item) { return !item.shortage; }).length;
            var shortage = list.filter(function(item) { return item.shortage; }).length;

            if (completed === 0) {
                alert('å°šæœªæ€è²¨ä»»ä½•é …ç›®');
                return;
            }

            var msg = 'æ³¢æ¬¡å®Œæˆæ‘˜è¦ï¼š\n\n';
            msg += 'âœ… å·²æ€è²¨ï¼š' + completed + ' / ' + total + ' é …\n';
            if (shortage > 0) {
                msg += 'âš ï¸ åº«å­˜ä¸è¶³ï¼š' + shortage + ' é …\n';
            }
            msg += '\nç¢ºå®šè¦å®Œæˆæ­¤æ³¢æ¬¡å—ï¼Ÿ';

            if (!confirm(msg)) return;

            var wave = window._waveData.currentWave;
            wave.status = 'done';
            wave.completedAt = new Date().toISOString();
            wave.completedBy = window.getOperatorName ? window.getOperatorName() : 'system';
            saveWaves();

            closeWaveExecuteModal();
            alert('âœ… æ³¢æ¬¡ ' + wave.waveNo + ' å·²å®Œæˆï¼');
        };

        window.printPickingList = function() {
            var wave = window._waveData.currentWave;
            var list = window._waveData.pickingList;

            if (!wave || !wave.summary || wave.summary.length === 0) {
                alert('ç„¡æ€è²¨è³‡æ–™');
                return;
            }

            wave.printVersion = (wave.printVersion || 0) + 1;
            var version = wave.printVersion;

            var html = '<style>';
            html += 'body { font-family: "Microsoft JhengHei", sans-serif; font-size: 12px; }';
            html += '.header { text-align: center; margin-bottom: 15px; border-bottom: 2px solid #333; padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }';
            html += '.header h2 { margin: 0; }';
            html += '.version { background: #374151; color: white; padding: 4px 12px; border-radius: 4px; font-weight: bold; }';
            html += '.info-row { display: flex; gap: 15px; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px dashed #ccc; }';
            html += '.info-item { flex: 1; }';
            html += '.info-label { font-size: 11px; color: #666; }';
            html += '.info-value { font-size: 15px; font-weight: bold; }';
            html += 'table { width: 100%; border-collapse: collapse; }';
            html += 'th, td { border: 1px solid #333; padding: 6px; text-align: left; }';
            html += 'th { background: #374151; color: white; font-size: 11px; }';
            html += '.loc { font-weight: bold; font-size: 13px; color: #1e40af; }';
            html += '.qty { text-align: center; font-weight: bold; font-size: 16px; color: #c00; }';
            html += '.check { width: 30px; text-align: center; }';
            html += '.floor-1f { background: #dbeafe; }';
            html += '.floor-2f { background: #fef3c7; }';
            html += '.floor-3f { background: #fee2e2; }';
            html += '.timestamp { text-align: right; font-size: 10px; color: #666; margin-top: 10px; }';
            html += '</style>';

            html += '<div class="header">';
            html += '<div><h2>æ€è²¨å–®</h2><h3 style="margin:5px 0 0 0">' + wave.waveNo + '</h3></div>';
            html += '<span class="version">ç‰ˆæ¬¡ V' + version + '</span>';
            html += '</div>';

            html += '<div class="info-row">';
            html += '<div class="info-item"><div class="info-label">ç‰©æµå•†</div><div class="info-value">' + wave.logistics + '</div></div>';
            html += '<div class="info-item"><div class="info-label">è¨‚å–®æ•¸</div><div class="info-value">' + (wave.orders ? wave.orders.length : 0) + ' ç­†</div></div>';
            html += '<div class="info-item"><div class="info-label">å“é …æ•¸</div><div class="info-value">' + wave.itemCount + ' é …</div></div>';
            html += '<div class="info-item"><div class="info-label">ç¸½ä»¶æ•¸</div><div class="info-value" style="color:#c00">' + wave.totalQty + ' ä»¶</div></div>';
            html += '</div>';

            var summaryWithLoc = (wave.summary || []).filter(function(item) {
                return !window.isExcludedFromPickingList(item.productName);
            }).map(function(item) {
                var invInfo = findProductInventoryInfo(item.productName, item.spec);
                return {
                    productName: item.productName,
                    spec: item.spec || '-',
                    unit: item.unit || 'ä»¶',
                    totalQty: item.totalQty,
                    location: invInfo.location,
                    batchNo: invInfo.batchNo,
                    expiryDate: invInfo.expiryDate,
                    floor: invInfo.floor
                };
            });

            summaryWithLoc.sort(function(a, b) {
                if (b.totalQty !== a.totalQty) return b.totalQty - a.totalQty;
                return a.floor - b.floor;
            });

            html += '<table>';
            html += '<tr><th class="check">âœ“</th><th style="width:70px">å„²ä½</th><th style="width:100px">å“å</th><th>è¦æ ¼</th><th style="width:80px">æ‰¹è™Ÿ</th><th style="width:80px">æ•ˆæœŸ</th><th style="width:50px" class="qty">æ•¸é‡</th><th style="width:35px">å–®ä½</th></tr>';

            summaryWithLoc.forEach(function(item) {
                var floorClass = item.floor === 1 ? 'floor-1f' : (item.floor === 2 ? 'floor-2f' : (item.floor === 3 ? 'floor-3f' : ''));
                html += '<tr class="' + floorClass + '">';
                html += '<td class="check">â˜</td>';
                html += '<td class="loc">' + item.location + '</td>';
                html += '<td>' + item.productName + '</td>';
                html += '<td>' + item.spec + '</td>';
                html += '<td style="font-size:11px">' + item.batchNo + '</td>';
                html += '<td style="font-size:11px">' + item.expiryDate + '</td>';
                html += '<td class="qty">' + item.totalQty + '</td>';
                html += '<td>' + item.unit + '</td>';
                html += '</tr>';
            });

            html += '</table>';
            var printTime = new Date().toLocaleString('zh-TW');
            html += '<div class="timestamp">ç‰ˆæ¬¡ V' + version + ' | åˆ—å°æ—¥æœŸï¼š' + printTime + '</div>';

            openPrintPreview(html, 'æ€è²¨å–® - ' + wave.waveNo, 900, 700);
        };

        window.viewWaveDetail = function(waveNo) {
            var wave = window._waveData.waves.find(function(w) { return w.waveNo === waveNo; });
            if (!wave) return;

            var msg = 'æ³¢æ¬¡ï¼š' + wave.waveNo + '\n';
            msg += 'ç‰©æµå•†ï¼š' + wave.logistics + '\n';
            msg += 'ç‹€æ…‹ï¼š' + (wave.status === 'done' ? 'å·²å®Œæˆ' : wave.status === 'picking' ? 'æ€è²¨ä¸­' : 'å¾…æ€è²¨') + '\n';
            msg += 'è¨‚å–®æ•¸ï¼š' + (wave.orders ? wave.orders.length : 0) + '\n';
            msg += 'ç¸½ä»¶æ•¸ï¼š' + wave.totalQty + '\n';
            msg += 'å»ºç«‹æ™‚é–“ï¼š' + new Date(wave.createdAt).toLocaleString('zh-TW') + '\n';
            if (wave.completedAt) {
                msg += 'å®Œæˆæ™‚é–“ï¼š' + new Date(wave.completedAt).toLocaleString('zh-TW') + '\n';
            }

            alert(msg);
        };

        window.openAddToWaveModal = function(waveNo) {
            var wave = window._waveData.waves.find(function(w) { return w.waveNo === waveNo; });
            if (!wave) {
                alert('æ‰¾ä¸åˆ°æ³¢æ¬¡');
                return;
            }

            var existingOrderIds = [];
            window._waveData.waves.forEach(function(w) {
                if (w.orders) {
                    w.orders.forEach(function(o) { existingOrderIds.push(o.id); });
                }
            });

            var availableOrders = (window.currentOrders ? window.currentOrders() : []).filter(function(o) {
                return (o.status === 'pending' || o.status === 'confirmed') &&
                       existingOrderIds.indexOf(o.id) < 0;
            });

            if (availableOrders.length === 0) {
                alert('ç›®å‰æ²’æœ‰å¯è¿½åŠ çš„è¨‚å–®\n\næ‰€æœ‰å¾…å‡ºè²¨è¨‚å–®éƒ½å·²åŠ å…¥æ³¢æ¬¡ä¸­');
                return;
            }

            var msg = 'å¯è¿½åŠ åˆ°æ³¢æ¬¡ ' + waveNo + ' çš„è¨‚å–®ï¼š\n\n';
            availableOrders.forEach(function(o, idx) {
                msg += (idx + 1) + '. ' + (o.orderNo || o.id) + ' - ' + o.customer + ' (' + o.quantity + 'ä»¶)\n';
            });
            msg += '\nè«‹è¼¸å…¥è¦è¿½åŠ çš„è¨‚å–®ç·¨è™Ÿï¼ˆå¤šç­†ç”¨é€—è™Ÿåˆ†éš”ï¼‰ï¼š';

            var input = prompt(msg);
            if (!input) return;

            var selectedNos = input.split(',').map(function(s) { return s.trim(); });
            var addedOrders = [];
            var addedQty = 0;

            availableOrders.forEach(function(o) {
                var orderNo = o.orderNo || o.id;
                var idx = availableOrders.indexOf(o);
                if (selectedNos.indexOf(String(idx + 1)) >= 0 || selectedNos.indexOf(orderNo) >= 0) {
                    addedOrders.push({
                        id: o.id,
                        orderNo: o.orderNo,
                        customer: o.customer,
                        productName: o.productName,
                        quantity: o.quantity
                    });
                    addedQty += parseInt(o.quantity) || 0;
                }
            });

            if (addedOrders.length === 0) {
                alert('æœªé¸æ“‡ä»»ä½•è¨‚å–®');
                return;
            }

            wave.orders = wave.orders.concat(addedOrders);
            wave.itemCount = wave.orders.length;
            wave.totalQty = (wave.totalQty || 0) + addedQty;
            wave.updatedAt = new Date().toISOString();

            if (wave.status === 'picking' && window._waveData.currentWave &&
                window._waveData.currentWave.waveNo === waveNo) {
                generatePickingList(wave);
            }

            saveWaves();
            refreshWaveList();

            alert('âœ… å·²è¿½åŠ  ' + addedOrders.length + ' ç­†è¨‚å–®åˆ°æ³¢æ¬¡ ' + waveNo + '\n\næ–°å¢ä»¶æ•¸ï¼š' + addedQty);
        };

        // ========== åº«å­˜ç•°å‹•è¨˜éŒ„ç³»çµ± ==========

        window.rebuildHistoryLogs = async function() {
            if (!confirm('æ­¤åŠŸèƒ½æœƒå°‡ç›®å‰æ‰€æœ‰åº«å­˜è£œå»ºç‚ºã€ŒæœŸåˆå…¥åº«ã€è¨˜éŒ„ã€‚\n\nç¢ºå®šè¦åŸ·è¡Œå—ï¼Ÿ')) {
                return;
            }

            try {
                var pallets = window.currentPallets ? window.currentPallets() : [];
                if (pallets.length === 0) {
                    alert('ç›®å‰æ²’æœ‰åº«å­˜è³‡æ–™');
                    return;
                }

                var count = 0;
                var errors = 0;

                var progressDiv = document.createElement('div');
                progressDiv.id = 'rebuild-progress';
                progressDiv.className = 'fixed inset-0 z-50 bg-black/80 flex items-center justify-center';
                progressDiv.innerHTML = '<div class="bg-slate-800 p-8 rounded-xl text-center"><i class="fa-solid fa-spinner fa-spin text-4xl text-blue-400 mb-4"></i><div class="text-white text-xl">è£œå»ºä¸­... 0/' + pallets.length + '</div></div>';
                document.body.appendChild(progressDiv);

                for (var i = 0; i < pallets.length; i++) {
                    var p = pallets[i];

                    try {
                        await window.logInventoryChange({
                            type: 'inbound',
                            productName: p.productName || '',
                            spec: p.spec || '',
                            quantity: p.quantity || 0,
                            quantityChange: p.quantity || 0,
                            locationId: p.locationId || '',
                            batchNo: p.batchNo || '',
                            palletId: p.palletId || '',
                            expDate: p.expDate || p.expiryDate || '',
                            note: 'æœŸåˆè£œå»º - ' + (p.source || 'æ—¢æœ‰åº«å­˜')
                        });
                        count++;
                    } catch (e) {
                        errors++;
                        console.error('è£œå»ºå¤±æ•—:', p.palletId, e);
                    }

                    progressDiv.querySelector('div > div').textContent = 'è£œå»ºä¸­... ' + (i + 1) + '/' + pallets.length;
                }

                document.body.removeChild(progressDiv);

                alert('âœ… è£œå»ºå®Œæˆï¼\n\næˆåŠŸï¼š' + count + ' ç­†\nå¤±æ•—ï¼š' + errors + ' ç­†');

                searchInventoryLog();

            } catch (e) {
                alert('âŒ è£œå»ºå¤±æ•—ï¼š' + e.message);
                var prog = document.getElementById('rebuild-progress');
                if (prog) prog.remove();
            }
        };

        window.logInventoryChange = async function(data) {
            try {
                if (!window.db || !window.collection || !window.addDoc) {
                    console.log('Firebase å°šæœªåˆå§‹åŒ–ï¼Œè·³éè¨˜éŒ„ç•°å‹•');
                    return null;
                }

                var operator = data.operator || (window.getOperatorName ? window.getOperatorName() : 'system');

                var logEntry = {
                    timestamp: new Date().toISOString(),
                    type: data.type,                    // inbound, outbound, move, merge, adjust, scrap
                    company: data.company || '',        // å…¬å¸åˆ¥
                    productName: data.productName || '',
                    spec: data.spec || '',
                    quantity: data.quantity || 0,
                    quantityChange: data.quantityChange || 0,  // +å…¥åº« -å‡ºåº«
                    locationId: data.locationId || '',
                    fromLocation: data.fromLocation || '',     // ç§»ä½ç”¨
                    toLocation: data.toLocation || '',         // ç§»ä½ç”¨
                    batchNo: data.batchNo || '',
                    palletId: data.palletId || '',
                    expDate: data.expDate || '',
                    note: data.note || '',
                    operator: operator,
                    orderId: data.orderId || '',               // é—œè¯å–®è™Ÿ
                    createdAt: window.serverTimestamp ? window.serverTimestamp() : new Date()
                };

                var docRef = await addDoc(collection(db, 'inventoryLogs'), logEntry);
                console.log('ç•°å‹•è¨˜éŒ„å·²å„²å­˜:', logEntry.type, logEntry.productName, 'å…¬å¸:', logEntry.company, 'æ“ä½œè€…:', operator);
                return docRef.id;
            } catch (e) {
                console.error('è¨˜éŒ„ç•°å‹•å¤±æ•—:', e);
                return null;
            }
        };

        window.setLogDateRange = function(range) {
            var today = new Date();
            var fromDate = new Date();
            var toDate = today;

            switch(range) {
                case 'today':
                    fromDate = today;
                    break;
                case 'week':
                    fromDate.setDate(today.getDate() - 7);
                    break;
                case 'month':
                    fromDate.setDate(today.getDate() - 30);
                    break;
                case 'all':
                    fromDate = new Date('2024-01-01');
                    break;
            }

            document.getElementById('log-date-from').value = fromDate.toISOString().split('T')[0];
            document.getElementById('log-date-to').value = toDate.toISOString().split('T')[0];
        };

        window.initInventoryLogPage = function() {
            setLogDateRange('week');
        };

        window.searchInventoryLog = async function() {
            var dateFrom = document.getElementById('log-date-from').value;
            var dateTo = document.getElementById('log-date-to').value;
            var productName = document.getElementById('log-product-name').value.trim().toLowerCase();
            var location = document.getElementById('log-location').value.trim().toUpperCase();
            var logType = document.getElementById('log-type').value;

            var tbody = document.getElementById('inventory-log-list');
            tbody.innerHTML = '<tr><td colspan="8" class="text-center text-slate-500 py-8"><i class="fa-solid fa-spinner fa-spin mr-2"></i>æŸ¥è©¢ä¸­...</td></tr>';

            try {
                if (!window.db || !window.collection || !window.getDocs) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center text-red-400 py-8">Firebase å°šæœªåˆå§‹åŒ–</td></tr>';
                    return;
                }

                var logsRef = window.collection(window.db, 'inventoryLogs');
                var constraints = [];

                if (dateFrom) {
                    constraints.push(window.where('timestamp', '>=', dateFrom + 'T00:00:00'));
                }
                if (dateTo) {
                    constraints.push(window.where('timestamp', '<=', dateTo + 'T23:59:59'));
                }

                if (logType) {
                    constraints.push(window.where('type', '==', logType));
                }

                var q = constraints.length > 0 ?
                    query(logsRef, ...constraints, orderBy('timestamp', 'desc'), limit(500)) :
                    query(logsRef, orderBy('timestamp', 'desc'), limit(500));

                var snapshot = await window.getDocs(q);
                var logs = [];

                snapshot.forEach(function(doc) {
                    var data = doc.data();
                    data.id = doc.id;

                    if (productName && !(data.productName || '').toLowerCase().includes(productName)) {
                        return;
                    }

                    if (location) {
                        var matchLoc = (data.locationId || '').toUpperCase().includes(location) ||
                                       (data.fromLocation || '').toUpperCase().includes(location) ||
                                       (data.toLocation || '').toUpperCase().includes(location);
                        if (!matchLoc) return;
                    }

                    logs.push(data);
                });

                updateLogStatistics(logs);

                renderInventoryLogs(logs);

            } catch (e) {
                console.error('æŸ¥è©¢ç•°å‹•è¨˜éŒ„å¤±æ•—:', e);
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-red-400 py-8">æŸ¥è©¢å¤±æ•—: ' + e.message + '</td></tr>';
            }
        };

        function updateLogStatistics(logs) {
            var stats = { total: logs.length, inbound: 0, outbound: 0, move: 0, other: 0 };

            logs.forEach(function(log) {
                switch(log.type) {
                    case 'inbound': stats.inbound++; break;
                    case 'outbound': stats.outbound++; break;
                    case 'move': stats.move++; break;
                    default: stats.other++; break;
                }
            });

            document.getElementById('log-stat-total').textContent = stats.total;
            document.getElementById('log-stat-inbound').textContent = stats.inbound;
            document.getElementById('log-stat-outbound').textContent = stats.outbound;
            document.getElementById('log-stat-move').textContent = stats.move;
            document.getElementById('log-stat-other').textContent = stats.other;
            document.getElementById('log-result-count').textContent = stats.total;
        }

        function renderInventoryLogs(logs) {
            var tbody = document.getElementById('inventory-log-list');

            if (logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="text-center text-slate-500 py-16"><i class="fa-solid fa-inbox text-4xl mb-3 opacity-30"></i><p>æŸ¥ç„¡è³‡æ–™</p></td></tr>';
                return;
            }

            var html = '';
            logs.forEach(function(log) {
                var typeLabel = getLogTypeLabel(log.type);
                var typeClass = getLogTypeClass(log.type);
                var qtyDisplay = formatQuantityChange(log);
                var weightDisplay = formatWeightChange(log);
                var locationDisplay = formatLocationDisplay(log);

                var companyClass = log.company === 'å…«æ–¹' ? 'bg-purple-900/50 text-purple-300' : 'bg-blue-900/50 text-blue-300';
                var companyLabel = log.company ? '<span class="px-1.5 py-0.5 rounded text-xs ' + companyClass + '">' + log.company + '</span>' : '-';

                html += '<tr class="border-t border-slate-700 hover:bg-slate-700/30">';
                html += '<td class="p-3 text-slate-300 font-mono text-xs">' + formatTimestamp(log.timestamp) + '</td>';
                html += '<td class="p-3">' + companyLabel + '</td>';
                html += '<td class="p-3"><span class="px-2 py-1 rounded text-xs font-bold ' + typeClass + '">' + typeLabel + '</span></td>';
                html += '<td class="p-3 text-white font-medium">' + (log.productName || '-') + '</td>';
                html += '<td class="p-3 text-slate-400">' + (log.spec || '-') + '</td>';
                html += '<td class="p-3 text-right font-bold ' + qtyDisplay.class + '">' + qtyDisplay.text + '</td>';
                html += '<td class="p-3 text-right ' + weightDisplay.class + '">' + weightDisplay.text + '</td>';
                html += '<td class="p-3 font-mono text-sm">' + locationDisplay + '</td>';
                html += '<td class="p-3 text-slate-400 text-xs">' + (log.batchNo || '-') + '</td>';
                html += '<td class="p-3 text-slate-500 text-xs max-w-[150px] truncate" title="' + (log.note || '') + '">' + (log.note || '-') + '</td>';
                html += '</tr>';
            });

            tbody.innerHTML = html;
        }

        function getLogTypeLabel(type) {
            var labels = {
                'inbound': 'å…¥åº«',
                'outbound': 'å‡ºåº«',
                'move': 'ç§»ä½',
                'merge': 'åˆä½µ',
                'adjust': 'èª¿æ•´',
                'picking': 'é ˜ç”¨',
                'transfer': 'èª¿æ’¥'
            };
            return labels[type] || type || 'æœªçŸ¥';
        }

        function getLogTypeClass(type) {
            var classes = {
                'inbound': 'bg-emerald-600 text-white',
                'outbound': 'bg-red-600 text-white',
                'move': 'bg-blue-600 text-white',
                'merge': 'bg-purple-600 text-white',
                'adjust': 'bg-yellow-600 text-black',
                'picking': 'bg-orange-600 text-white',
                'transfer': 'bg-pink-600 text-white'
            };
            return classes[type] || 'bg-slate-600 text-white';
        }

        function formatQuantityChange(log) {
            var qty = log.quantity || 0;
            var change = log.quantityChange || 0;

            if (log.type === 'inbound') {
                return { text: '+' + qty, class: 'text-emerald-400' };
            } else if (log.type === 'outbound' || log.type === 'picking') {
                return { text: '-' + qty, class: 'text-red-400' };
            } else if (log.type === 'move') {
                return { text: qty.toString(), class: 'text-blue-400' };
            } else if (change > 0) {
                return { text: '+' + change, class: 'text-emerald-400' };
            } else if (change < 0) {
                return { text: change.toString(), class: 'text-red-400' };
            }
            return { text: qty.toString(), class: 'text-white' };
        }

        function formatWeightChange(log) {
            var weight = log.weight || 0;
            var change = log.weightChange || 0;

            if (weight === 0 && change === 0) {
                return { text: '-', class: 'text-slate-600' };
            }

            if (log.type === 'inbound') {
                return { text: '+' + weight + ' kg', class: 'text-emerald-400' };
            } else if (log.type === 'outbound' || log.type === 'picking') {
                return { text: '-' + weight + ' kg', class: 'text-red-400' };
            } else if (log.type === 'move') {
                return { text: weight + ' kg', class: 'text-blue-400' };
            } else if (change > 0) {
                return { text: '+' + change + ' kg', class: 'text-emerald-400' };
            } else if (change < 0) {
                return { text: change + ' kg', class: 'text-red-400' };
            }
            return { text: weight + ' kg', class: 'text-amber-400' };
        }

        function formatLocationDisplay(log) {
            if (log.type === 'move' && log.fromLocation && log.toLocation) {
                return '<span class="text-red-400">' + log.fromLocation + '</span> â†’ <span class="text-emerald-400">' + log.toLocation + '</span>';
            }
            return '<span class="text-slate-300">' + (log.locationId || log.toLocation || '-') + '</span>';
        }

        function formatTimestamp(ts) {
            if (!ts) return '-';
            try {
                var date = new Date(ts);
                var y = date.getFullYear();
                var m = String(date.getMonth() + 1).padStart(2, '0');
                var d = String(date.getDate()).padStart(2, '0');
                var h = String(date.getHours()).padStart(2, '0');
                var min = String(date.getMinutes()).padStart(2, '0');
                return y + '/' + m + '/' + d + ' ' + h + ':' + min;
            } catch (e) {
                return ts;
            }
        }

        window.exportInventoryLog = function() {
            var logs = [];
            var rows = document.querySelectorAll('#inventory-log-list tr');

            if (rows.length === 0 || rows[0].querySelector('td[colspan]')) {
                alert('æ²’æœ‰è³‡æ–™å¯åŒ¯å‡º');
                return;
            }

            var csv = '\uFEFFæ—¥æœŸæ™‚é–“,é¡å‹,å“é …,è¦æ ¼,æ•¸é‡,å„²ä½,æ‰¹è™Ÿ,å‚™è¨»\n';

            rows.forEach(function(row) {
                var cells = row.querySelectorAll('td');
                if (cells.length >= 8) {
                    var rowData = [];
                    cells.forEach(function(cell, idx) {
                        var text = cell.textContent.trim().replace(/"/g, '""');
                        rowData.push('"' + text + '"');
                    });
                    csv += rowData.join(',') + '\n';
                }
            });

            var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'åº«å­˜ç•°å‹•è¨˜éŒ„_' + new Date().toISOString().split('T')[0] + '.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };

        // ========== å“é …å‡ºè²¨åˆ†æ ==========

        window.setAnalysisDateRange = function(range) {
            var today = new Date();
            var fromDate = new Date();

            switch(range) {
                case 'week':
                    fromDate.setDate(today.getDate() - 7);
                    break;
                case 'month':
                    fromDate.setDate(today.getDate() - 30);
                    break;
                case 'quarter':
                    fromDate.setDate(today.getDate() - 90);
                    break;
            }

            document.getElementById('analysis-date-from').value = fromDate.toISOString().split('T')[0];
            document.getElementById('analysis-date-to').value = today.toISOString().split('T')[0];
            refreshProductAnalysis();
        };

        window.initProductAnalysis = function() {
            setAnalysisDateRange('month');
        };

        window.refreshProductAnalysis = async function() {
            var dateFrom = document.getElementById('analysis-date-from').value;
            var dateTo = document.getElementById('analysis-date-to').value;
            var sortBy = document.getElementById('analysis-sort').value;
            var limitCount = parseInt(document.getElementById('analysis-limit').value) || 10;

            try {
                if (!window.db || !window.collection || !window.getDocs) {
                    alert('Firebase å°šæœªåˆå§‹åŒ–');
                    return;
                }

                var logsRef = window.collection(window.db, 'inventoryLogs');
                var snapshot = await window.getDocs(logsRef);

                var filteredDocs = [];
                snapshot.forEach(function(doc) {
                    var data = doc.data();
                    var docType = data.type || '';

                    if (docType !== 'outbound' && docType !== 'picking') return;

                    var ts = data.timestamp || '';
                    if (typeof ts === 'object' && ts.toDate) {
                        ts = ts.toDate().toISOString();
                    }

                    if (dateFrom && ts < dateFrom + 'T00:00:00') return;
                    if (dateTo && ts > dateTo + 'T23:59:59') return;

                    filteredDocs.push({ id: doc.id, data: function() { return data; } });
                });

                var snapshot = { forEach: function(fn) { filteredDocs.forEach(fn); } };

                var productStats = {};
                var totalCount = 0;
                var totalQty = 0;

                snapshot.forEach(function(doc) {
                    var data = doc.data();
                    var key = (data.productName || 'æœªçŸ¥') + '|' + (data.spec || '');

                    if (!productStats[key]) {
                        productStats[key] = {
                            name: data.productName || 'æœªçŸ¥',
                            spec: data.spec || '',
                            count: 0,
                            qty: 0
                        };
                    }

                    productStats[key].count++;
                    productStats[key].qty += (data.quantity || 0);
                    totalCount++;
                    totalQty += (data.quantity || 0);
                });

                var rankingList = Object.values(productStats);
                rankingList.sort(function(a, b) {
                    return sortBy === 'count' ? (b.count - a.count) : (b.qty - a.qty);
                });

                if (limitCount < 100) {
                    rankingList = rankingList.slice(0, limitCount);
                }

                document.getElementById('pa-stat-products').textContent = Object.keys(productStats).length;
                document.getElementById('pa-stat-total-count').textContent = totalCount;
                document.getElementById('pa-stat-total-qty').textContent = totalQty.toLocaleString();
                document.getElementById('pa-stat-avg').textContent = totalCount > 0 ? Math.round(totalQty / totalCount) : 0;

                renderProductBarChart(rankingList, sortBy, totalQty);

                renderProductRanking(rankingList, totalQty);

            } catch (e) {
                console.error('åˆ†æå¤±æ•—:', e);
                alert('åˆ†æå¤±æ•—: ' + e.message);
            }
        };

        function renderProductBarChart(data, sortBy, totalQty) {
            var container = document.getElementById('pa-bar-chart');

            if (data.length === 0) {
                container.innerHTML = '<div class="text-center text-slate-500 py-16"><i class="fa-solid fa-inbox text-4xl mb-3 opacity-30"></i><p>æ­¤æœŸé–“ç„¡å‡ºè²¨è¨˜éŒ„</p></div>';
                return;
            }

            var maxValue = sortBy === 'count' ? data[0].count : data[0].qty;

            var html = '<div class="space-y-2">';
            data.slice(0, 15).forEach(function(item, idx) {
                var value = sortBy === 'count' ? item.count : item.qty;
                var percent = maxValue > 0 ? (value / maxValue * 100) : 0;
                var sharePercent = totalQty > 0 ? (item.qty / totalQty * 100) : 0;

                var barColor = idx === 0 ? 'bg-red-500' :
                               idx < 3 ? 'bg-orange-500' :
                               idx < 5 ? 'bg-yellow-500' : 'bg-blue-500';

                html += '<div class="flex items-center gap-2">';
                html += '<div class="w-6 text-right text-xs text-slate-500">' + (idx + 1) + '</div>';
                html += '<div class="w-32 truncate text-sm text-white" title="' + item.name + ' ' + item.spec + '">' + item.name + '</div>';
                html += '<div class="flex-1 bg-slate-700 rounded h-6 relative overflow-hidden">';
                html += '<div class="' + barColor + ' h-full rounded transition-all" style="width:' + percent + '%"></div>';
                html += '<span class="absolute inset-0 flex items-center justify-center text-xs font-bold text-white">' + value.toLocaleString() + '</span>';
                html += '</div>';
                html += '<div class="w-16 text-right text-xs text-slate-400">' + sharePercent.toFixed(1) + '%</div>';
                html += '</div>';
            });
            html += '</div>';

            container.innerHTML = html;
        }

        function renderProductRanking(data, totalQty) {
            var tbody = document.getElementById('pa-ranking-list');

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-slate-500 py-8">æ­¤æœŸé–“ç„¡å‡ºè²¨è¨˜éŒ„</td></tr>';
                return;
            }

            var html = '';
            data.forEach(function(item, idx) {
                var sharePercent = totalQty > 0 ? (item.qty / totalQty * 100) : 0;

                var rankClass = idx === 0 ? 'text-red-400 font-bold' :
                                idx < 3 ? 'text-orange-400 font-bold' :
                                idx < 5 ? 'text-yellow-400' : 'text-slate-400';

                var rankIcon = idx === 0 ? 'ğŸ¥‡' : idx === 1 ? 'ğŸ¥ˆ' : idx === 2 ? 'ğŸ¥‰' : (idx + 1);

                html += '<tr class="border-t border-slate-700 hover:bg-slate-700/30">';
                html += '<td class="text-center p-2 ' + rankClass + '">' + rankIcon + '</td>';
                html += '<td class="p-2 text-white font-medium">' + item.name + '</td>';
                html += '<td class="p-2 text-slate-400">' + (item.spec || '-') + '</td>';
                html += '<td class="p-2 text-right text-emerald-400 font-bold">' + item.count + '</td>';
                html += '<td class="p-2 text-right text-blue-400">' + item.qty.toLocaleString() + '</td>';
                html += '<td class="p-2 text-right text-slate-400">' + sharePercent.toFixed(1) + '%</td>';
                html += '</tr>';
            });

            tbody.innerHTML = html;
        }

        // ========== å€‰åº«ç†±åŠ›åœ– ==========

        window.setHeatmapDateRange = function(range) {
            var today = new Date();
            var fromDate = new Date();

            switch(range) {
                case 'month':
                    fromDate.setDate(today.getDate() - 30);
                    break;
                case 'quarter':
                    fromDate.setDate(today.getDate() - 90);
                    break;
            }

            document.getElementById('heatmap-date-from').value = fromDate.toISOString().split('T')[0];
            document.getElementById('heatmap-date-to').value = today.toISOString().split('T')[0];
            refreshWarehouseHeatmap();
        };

        window.initWarehouseHeatmap = function() {
            setHeatmapDateRange('month');
        };

        window.refreshWarehouseHeatmap = async function() {
            var dateFrom = document.getElementById('heatmap-date-from').value;
            var dateTo = document.getElementById('heatmap-date-to').value;
            var metric = document.getElementById('heatmap-metric').value;

            try {
                var locationStats = {};

                if (window.db && window.collection && window.getDocs) {
                    var logsRef = window.collection(window.db, 'inventoryLogs');
                    var constraints = [];

                    if (dateFrom) {
                        constraints.push(window.where('timestamp', '>=', dateFrom + 'T00:00:00'));
                    }
                    if (dateTo) {
                        constraints.push(window.where('timestamp', '<=', dateTo + 'T23:59:59'));
                    }

                    var q = constraints.length > 0 ? query(logsRef, ...constraints) : logsRef;
                    var snapshot = await window.getDocs(q);

                    snapshot.forEach(function(doc) {
                        var data = doc.data();

                        var locations = [];
                        if (data.locationId) locations.push(data.locationId);
                        if (data.fromLocation) locations.push(data.fromLocation);
                        if (data.toLocation) locations.push(data.toLocation);

                        locations.forEach(function(loc) {
                            if (!loc) return;
                            var parts = loc.split('-');
                            if (parts.length >= 3) {
                                var laneKey = parts[0] + '-' + parts[1] + '-' + parts[2];
                                if (!locationStats[laneKey]) {
                                    locationStats[laneKey] = { count: 0, inbound: 0, outbound: 0 };
                                }
                                locationStats[laneKey].count++;
                                if (data.type === 'inbound') locationStats[laneKey].inbound++;
                                if (data.type === 'outbound' || data.type === 'picking') locationStats[laneKey].outbound++;
                            }
                        });
                    });
                }

                renderZoneHeatmap('I', 'A', 8, locationStats);
                renderZoneHeatmap('I', 'B', 8, locationStats);
                renderZoneHeatmap('J', 'C', 8, locationStats);
                renderZoneHeatmap('J', 'D', 8, locationStats);
                renderZoneHeatmap('K', 'E', 22, locationStats);
                renderZoneHeatmap('K', 'F', 22, locationStats);
                renderZoneHeatmap('K', 'G', 22, locationStats);
                renderZoneHeatmap('K', 'H', 22, locationStats);

                updateHeatmapStats(locationStats);

            } catch (e) {
                console.error('ç†±åŠ›åœ–åˆ†æå¤±æ•—:', e);
            }
        };

        function renderZoneHeatmap(warehouse, zone, laneCount, stats) {
            var container = document.getElementById('heatmap-' + warehouse + '-' + zone);
            if (!container) return;

            var maxCount = 0;
            for (var i = 1; i <= laneCount; i++) {
                var colStr = i < 10 ? '0' + i : '' + i;
                var key = warehouse + '-' + zone + '-' + colStr;
                if (stats[key] && stats[key].count > maxCount) {
                    maxCount = stats[key].count;
                }
            }

            var html = '';
            for (var i = 1; i <= laneCount; i++) {
                var colStr = i < 10 ? '0' + i : '' + i;
                var key = warehouse + '-' + zone + '-' + colStr;
                var count = stats[key] ? stats[key].count : 0;

                var heatLevel = 0;
                if (count > 0) {
                    var ratio = maxCount > 0 ? count / maxCount : 0;
                    if (ratio >= 0.8) heatLevel = 4;      // é«˜é »
                    else if (ratio >= 0.5) heatLevel = 3;  // ä¸­é«˜
                    else if (ratio >= 0.2) heatLevel = 2;  // ä¸­
                    else heatLevel = 1;                    // ä½é »
                }

                var bgColor = heatLevel === 4 ? 'bg-red-600' :
                              heatLevel === 3 ? 'bg-orange-500' :
                              heatLevel === 2 ? 'bg-yellow-500' :
                              heatLevel === 1 ? 'bg-emerald-500' : 'bg-slate-600';

                var size = warehouse === 'K' ? 'w-4 h-4' : 'w-6 h-6';
                var fontSize = warehouse === 'K' ? 'text-[8px]' : 'text-[10px]';

                html += '<div class="' + size + ' ' + bgColor + ' rounded-sm flex items-center justify-center cursor-pointer hover:ring-2 hover:ring-white" ';
                html += 'title="' + key + '\nä½¿ç”¨æ¬¡æ•¸: ' + count + '">';
                if (warehouse !== 'K') {
                    html += '<span class="' + fontSize + ' text-white/80">' + colStr + '</span>';
                }
                html += '</div>';
            }

            container.innerHTML = html;
        }

        function updateHeatmapStats(stats) {
            var hot = 0, medium = 0, cold = 0, unused = 0;

            var allLanes = [];
            ['I-A', 'I-B', 'J-C', 'J-D'].forEach(function(zone) {
                for (var i = 1; i <= 8; i++) {
                    allLanes.push(zone + '-' + (i < 10 ? '0' + i : i));
                }
            });
            ['K-E', 'K-F', 'K-G', 'K-H'].forEach(function(zone) {
                for (var i = 1; i <= 22; i++) {
                    allLanes.push(zone + '-' + (i < 10 ? '0' + i : i));
                }
            });

            var maxCount = 0;
            Object.values(stats).forEach(function(s) {
                if (s.count > maxCount) maxCount = s.count;
            });

            allLanes.forEach(function(lane) {
                var count = stats[lane] ? stats[lane].count : 0;
                if (count === 0) {
                    unused++;
                } else {
                    var ratio = maxCount > 0 ? count / maxCount : 0;
                    if (ratio >= 0.5) hot++;
                    else if (ratio >= 0.2) medium++;
                    else cold++;
                }
            });

            document.getElementById('hm-stat-hot').textContent = hot;
            document.getElementById('hm-stat-medium').textContent = medium;
            document.getElementById('hm-stat-cold').textContent = cold;
            document.getElementById('hm-stat-unused').textContent = unused;
        }

        // ========== è¨‚å–®å‡ºè²¨ç³»çµ± ==========
        window.currentSelectedOrder = null;
        window.orderPickingPlan = [];

        window.openManualOrderModal = function() {
            document.getElementById('modal-manual-order').classList.remove('hidden');
            document.getElementById('manual-order-customer').value = '';
            document.getElementById('manual-order-product').value = '';
            document.getElementById('manual-order-spec').value = '';
            document.getElementById('manual-order-qty').value = '';
            document.getElementById('manual-order-carrier').value = '';
            document.getElementById('order-product-suggestions').innerHTML = '';
        };

        window.closeManualOrderModal = function() {
            document.getElementById('modal-manual-order').classList.add('hidden');
        };

        window.searchProductForOrder = function() {
            var searchInput = document.getElementById('manual-order-product').value.toLowerCase();
            var suggestionsDiv = document.getElementById('order-product-suggestions');

            if (searchInput.length < 1) {
                suggestionsDiv.innerHTML = '';
                return;
            }

            var products = {};
            window.currentPallets().forEach(function(p) {
                var key = p.productName + '|' + (p.spec || '');
                if (p.productName.toLowerCase().indexOf(searchInput) > -1) {
                    if (!products[key]) {
                        products[key] = { name: p.productName, spec: p.spec || '', totalQty: 0 };
                    }
                    products[key].totalQty += p.quantity;
                }
            });

            var html = '';
            Object.values(products).forEach(function(prod) {
                html += '<div class="p-2 bg-slate-700 hover:bg-slate-600 cursor-pointer rounded mb-1 text-sm" onclick="selectProductForOrder(\'' + prod.name + '\', \'' + prod.spec + '\')">';
                html += '<div class="text-white">' + prod.name + '</div>';
                html += '<div class="text-slate-400 text-xs">' + prod.spec + ' | åº«å­˜: ' + prod.totalQty + 'ä»¶</div>';
                html += '</div>';
            });

            suggestionsDiv.innerHTML = html || '<div class="text-slate-500 text-xs p-2">ç„¡ç¬¦åˆé …ç›®</div>';
        };

        window.selectProductForOrder = function(name, spec) {
            document.getElementById('manual-order-product').value = name;
            document.getElementById('manual-order-spec').value = spec;
            document.getElementById('order-product-suggestions').innerHTML = '';
        };

        window.createManualOrder = function() {
            var customer = document.getElementById('manual-order-customer').value;
            var product = document.getElementById('manual-order-product').value;
            var spec = document.getElementById('manual-order-spec').value;
            var qty = parseInt(document.getElementById('manual-order-qty').value) || 0;
            var carrier = document.getElementById('manual-order-carrier').value || 'è‡ªå–';

            if (!customer || !product || qty <= 0) {
                alert('è«‹å¡«å¯«å®¢æˆ¶ã€å“åå’Œæ•¸é‡');
                return;
            }

            var now = new Date();
            var orderId = 'ORD-' + now.getFullYear() + ('0'+(now.getMonth()+1)).slice(-2) + ('0'+now.getDate()).slice(-2) + '-' + ('0'+now.getHours()).slice(-2) + ('0'+now.getMinutes()).slice(-2) + ('0'+now.getSeconds()).slice(-2);

            var newOrder = {
                orderId: orderId,
                customer: customer,
                carrier: carrier,
                items: [{
                    productName: product,
                    spec: spec,
                    quantity: qty
                }],
                status: 'Pending',
                createTime: now
            };

            if (!window.manualOrders) window.manualOrders = [];
            window.manualOrders.push(newOrder);

            closeManualOrderModal();
            renderShippingListWithPicking();
            alert('âœ… è¨‚å–®å»ºç«‹æˆåŠŸ: ' + orderId);
        };

        window.renderShippingListWithPicking = function() {
            var tbody = document.getElementById('shipping-list-body');
            if (!tbody) return;

            var allOrders = (window.currentOrders ? window.currentOrders() : []).concat(window.manualOrders || []);

            if (allOrders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-slate-500 py-10">å°šç„¡è¨‚å–®ï¼Œè«‹åŒ¯å…¥æˆ–æ‰‹å‹•æ–°å¢</td></tr>';
                document.getElementById('order-count').innerText = '0';
                return;
            }

            var html = '';
            allOrders.forEach(function(order, idx) {
                var statusBadge = order.status === 'Completed' ?
                    '<span class="badge badge-green">å·²å‡ºè²¨</span>' :
                    '<span class="badge badge-yellow">å¾…è™•ç†</span>';

                var itemSummary = order.items.map(function(item) {
                    return item.productName + (item.spec ? '(' + item.spec + ')' : '');
                }).join(', ');

                var totalQty = order.items.reduce(function(sum, item) { return sum + (item.quantity || 0); }, 0);

                html += '<tr class="border-b border-slate-700 hover:bg-slate-800 cursor-pointer" onclick="selectOrderForPicking(' + idx + ')">';
                html += '<td class="p-2"><span class="badge badge-blue">' + (order.carrier || '-') + '</span></td>';
                html += '<td class="p-2 text-blue-400 font-mono text-xs">' + order.orderId + '</td>';
                html += '<td class="p-2 text-white">' + order.customer + '</td>';
                html += '<td class="p-2 text-slate-300 text-xs">' + itemSummary.substring(0, 20) + (itemSummary.length > 20 ? '...' : '') + '</td>';
                html += '<td class="p-2 text-yellow-400 font-bold">' + totalQty + '</td>';
                html += '<td class="p-2">' + statusBadge + '</td>';
                html += '<td class="p-2 text-right">';
                if (order.status !== 'Completed') {
                    html += '<button onclick="event.stopPropagation(); selectOrderForPicking(' + idx + ')" class="text-blue-400 hover:text-blue-300 text-xs mr-2"><i class="fa-solid fa-route"></i> æ€è²¨</button>';
                }
                html += '</td>';
                html += '</tr>';
            });

            tbody.innerHTML = html;
            document.getElementById('order-count').innerText = allOrders.filter(function(o) { return o.status !== 'Completed'; }).length;
        };

        window.selectOrderForPicking = function(idx) {
            var allOrders = (window.currentOrders ? window.currentOrders() : []).concat(window.manualOrders || []);
            var order = allOrders[idx];

            if (!order) return;

            window.currentSelectedOrder = order;
            window.currentSelectedOrderIdx = idx;

            calculateOrderPicking(order);
        };

        function calculateOrderPicking(order) {
            var detailDiv = document.getElementById('order-picking-detail');
            var actionsDiv = document.getElementById('order-picking-actions');

            var html = '<div class="mb-4 p-3 bg-slate-800 rounded border border-slate-600">';
            html += '<div class="text-white font-bold">' + order.orderId + '</div>';
            html += '<div class="text-slate-400 text-sm">å®¢æˆ¶: ' + order.customer + ' | ç‰©æµ: ' + (order.carrier || 'è‡ªå–') + '</div>';
            html += '</div>';

            var allPlans = [];

            order.items.forEach(function(item, itemIdx) {
                html += '<div class="mb-4 p-3 bg-slate-800/50 rounded border border-slate-700">';
                html += '<div class="flex justify-between items-center mb-2">';
                html += '<div class="text-white font-bold">' + item.productName + ' <span class="text-slate-400 text-sm">' + (item.spec || '') + '</span></div>';
                html += '<div class="text-yellow-400 font-bold">éœ€æ±‚: ' + item.quantity + ' ä»¶</div>';
                html += '</div>';

                var plan = calculateItemPickingPlan(item.productName, item.spec || '', item.quantity);
                allPlans.push({ item: item, plan: plan });

                if (plan.length === 0) {
                    html += '<div class="text-red-400 text-sm p-2 bg-red-900/30 rounded">âŒ åº«å­˜ä¸è¶³æˆ–ç„¡æ­¤å“é …</div>';
                } else {
                    html += '<table class="w-full text-xs">';
                    html += '<thead><tr class="text-slate-500"><th class="text-left p-1">å„²ä½</th><th class="text-right p-1">å–ç”¨</th><th class="text-center p-1">æ–¹å¼</th><th class="text-left p-1">æ•ˆæœŸ</th></tr></thead>';
                    html += '<tbody>';

                    plan.forEach(function(p) {
                        var typeLabel = p.pickType === 'full' ? '<span class="text-green-400">æ•´æ¿</span>' : '<span class="text-yellow-400">æ‹†æ¿</span>';
                        html += '<tr class="border-t border-slate-700">';
                        html += '<td class="p-1 text-blue-400 font-mono">' + p.locationId + '</td>';
                        html += '<td class="p-1 text-right text-white font-bold">' + p.pickQty + '</td>';
                        html += '<td class="p-1 text-center">' + typeLabel + '</td>';
                        html += '<td class="p-1 text-slate-400">' + (p.expDate || '-') + '</td>';
                        html += '</tr>';
                    });

                    html += '</tbody></table>';
                }

                html += '</div>';
            });

            window.orderPickingPlan = allPlans;

            detailDiv.innerHTML = html;
            actionsDiv.classList.remove('hidden');
        }

        function calculateItemPickingPlan(productName, spec, requiredQty) {
            var candidates = [];
            window.currentPallets().forEach(function(p) {
                if (p.productName === productName && (p.spec || '') === spec && p.quantity > 0) {
                    var parsed = parseLocationId(p.locationId);
                    var floor = parsed ? parseInt(parsed.level) || 1 : 1;

                    candidates.push({
                        palletId: p.palletId,
                        locationId: p.locationId,
                        quantity: p.quantity,
                        expDate: p.expDate || p.expiryDate || '9999-12-31',
                        floor: floor,
                        batchNo: p.batchNo || ''
                    });
                }
            });

            if (candidates.length === 0) return [];

            candidates.sort(function(a, b) {
                if (a.expDate !== b.expDate) return a.expDate < b.expDate ? -1 : 1;
                return a.floor - b.floor;
            });

            var plan = [];
            var remaining = requiredQty;

            for (var i = 0; i < candidates.length && remaining > 0; i++) {
                var c = candidates[i];
                var pickQty = Math.min(c.quantity, remaining);
                var pickType = pickQty === c.quantity ? 'full' : 'split';

                plan.push({
                    palletId: c.palletId,
                    locationId: c.locationId,
                    quantity: c.quantity,
                    pickQty: pickQty,
                    expDate: c.expDate,
                    batchNo: c.batchNo,
                    pickType: pickType,
                    remaining: c.quantity - pickQty
                });

                remaining -= pickQty;
            }

            return plan;
        }

        window.confirmOrderPicking = async function() {
            if (!window.currentSelectedOrder || !window.orderPickingPlan) {
                alert('è«‹å…ˆé¸æ“‡è¨‚å–®');
                return;
            }

            var hasError = window.orderPickingPlan.some(function(p) { return p.plan.length === 0; });
            if (hasError) {
                alert('éƒ¨åˆ†å“é …åº«å­˜ä¸è¶³ï¼Œç„¡æ³•å®Œæˆå‡ºè²¨');
                return;
            }

            if (!confirm('ç¢ºèªå®Œæˆæ­¤è¨‚å–®å‡ºè²¨ï¼Ÿ\n\nè¨‚å–®: ' + window.currentSelectedOrder.orderId + '\nå®¢æˆ¶: ' + window.currentSelectedOrder.customer)) {
                return;
            }

            try {
                var batch = window.writeBatch(window.db);
                var logPromises = [];

                window.orderPickingPlan.forEach(function(itemPlan) {
                    itemPlan.plan.forEach(function(p) {
                        var pallet = window.currentPallets().find(function(pp) {
                            return pp.palletId === p.palletId || pp.id === p.palletId;
                        });

                        if (pallet) {
                            if (p.pickType === 'full') {
                                batch.delete(window.doc(window.db, 'pallets', pallet.id));
                            } else {
                                batch.update(window.doc(window.db, 'pallets', pallet.id), {
                                    quantity: p.remaining
                                });
                            }

                            logPromises.push(window.logInventoryChange({
                                type: 'outbound',
                                productName: pallet.productName,
                                spec: pallet.spec || '',
                                quantity: p.pickQty,
                                quantityChange: -p.pickQty,
                                locationId: pallet.locationId,
                                batchNo: pallet.batchNo || '',
                                palletId: pallet.palletId,
                                expDate: pallet.expDate || pallet.expiryDate,
                                note: 'è¨‚å–®å‡ºè²¨ - ' + window.currentSelectedOrder.customer,
                                orderId: window.currentSelectedOrder.orderId
                            }));
                        }
                    });
                });

                await batch.commit();

                await Promise.all(logPromises);

                window.currentSelectedOrder.status = 'Completed';

                alert('âœ… å‡ºè²¨å®Œæˆï¼');

                window.currentSelectedOrder = null;
                window.orderPickingPlan = [];
                document.getElementById('order-picking-detail').innerHTML = '<div class="text-center text-slate-500 py-20"><i class="fa-solid fa-check-circle text-4xl mb-4 text-green-500"></i><div>å‡ºè²¨å®Œæˆ</div></div>';
                document.getElementById('order-picking-actions').classList.add('hidden');

                renderShippingListWithPicking();

            } catch (e) {
                alert('âŒ å‡ºè²¨å¤±æ•—: ' + e.message);
            }
        };

        window.printOrderPickingSlip = function() {
            if (!window.currentSelectedOrder || !window.orderPickingPlan) {
                alert('è«‹å…ˆé¸æ“‡è¨‚å–®');
                return;
            }

            var order = window.currentSelectedOrder;
            var html = '<div style="border:3px solid #000;padding:20px;font-family:Microsoft JhengHei,Arial;">';
            html += '<div style="background:#333;color:white;padding:15px;margin:-20px -20px 20px -20px;text-align:center;">';
            html += '<div style="font-size:28px;font-weight:bold;">å‡ºè²¨æ€è²¨å–®</div>';
            html += '<div style="font-size:14px;margin-top:5px;">å–®è™Ÿ: ' + order.orderId + '</div>';
            html += '</div>';

            html += '<div style="display:flex;justify-content:space-between;margin-bottom:15px;padding:10px;background:#f5f5f5;">';
            html += '<div><b>å®¢æˆ¶:</b> ' + order.customer + '</div>';
            html += '<div><b>ç‰©æµ:</b> ' + (order.carrier || 'è‡ªå–') + '</div>';
            html += '<div><b>æ—¥æœŸ:</b> ' + new Date().toLocaleDateString() + '</div>';
            html += '</div>';

            window.orderPickingPlan.forEach(function(itemPlan, idx) {
                html += '<div style="margin-bottom:15px;border:1px solid #ccc;padding:10px;">';
                html += '<div style="font-weight:bold;margin-bottom:10px;">' + (idx+1) + '. ' + itemPlan.item.productName + ' ' + (itemPlan.item.spec || '') + ' - éœ€æ±‚: ' + itemPlan.item.quantity + 'ä»¶</div>';

                html += '<table style="width:100%;border-collapse:collapse;">';
                html += '<thead><tr style="background:#eee;"><th style="padding:5px;border:1px solid #ccc;">å„²ä½</th><th style="padding:5px;border:1px solid #ccc;">å–ç”¨</th><th style="padding:5px;border:1px solid #ccc;">æ–¹å¼</th><th style="padding:5px;border:1px solid #ccc;">æ•ˆæœŸ</th></tr></thead>';
                html += '<tbody>';

                itemPlan.plan.forEach(function(p) {
                    html += '<tr>';
                    html += '<td style="padding:5px;border:1px solid #ccc;text-align:center;font-weight:bold;">' + p.locationId + '</td>';
                    html += '<td style="padding:5px;border:1px solid #ccc;text-align:center;font-size:18px;font-weight:bold;">' + p.pickQty + '</td>';
                    html += '<td style="padding:5px;border:1px solid #ccc;text-align:center;">' + (p.pickType === 'full' ? 'æ•´æ¿' : 'æ‹†æ¿') + '</td>';
                    html += '<td style="padding:5px;border:1px solid #ccc;text-align:center;">' + (p.expDate || '-') + '</td>';
                    html += '</tr>';
                });

                html += '</tbody></table></div>';
            });

            html += '<div style="display:flex;justify-content:space-around;padding-top:20px;border-top:2px solid #000;margin-top:20px;">';
            html += '<div style="text-align:center;"><div style="border-bottom:1px solid #000;width:100px;height:40px;"></div><div style="font-size:12px;margin-top:5px;">æ€è²¨äººå“¡</div></div>';
            html += '<div style="text-align:center;"><div style="border-bottom:1px solid #000;width:100px;height:40px;"></div><div style="font-size:12px;margin-top:5px;">è¦†æ ¸äººå“¡</div></div>';
            html += '</div></div>';

            openPrintPreview(html, 'å‡ºè²¨æ€è²¨å–® - ' + order.orderId, 900, 800);
        };

        // ========== æ¿è™Ÿç•°å‹•ç³»çµ± ==========
        window.currentMergeMode = 'move';

        window.setMergeMode = function(mode) {
            window.currentMergeMode = mode;

            var btnMove = document.getElementById('btn-mode-move');
            var btnMerge = document.getElementById('btn-mode-merge');
            var panelMove = document.getElementById('panel-move');
            var panelMerge = document.getElementById('panel-merge');

            if (mode === 'move') {
                btnMove.className = 'flex-1 py-3 bg-blue-600 text-white rounded-lg font-bold text-lg border-2 border-blue-400';
                btnMerge.className = 'flex-1 py-3 bg-slate-800 text-slate-400 rounded-lg font-bold text-lg border-2 border-slate-600';
                panelMove.classList.remove('hidden');
                panelMove.classList.add('flex');
                panelMerge.classList.add('hidden');
                panelMerge.classList.remove('flex');
            } else {
                btnMove.className = 'flex-1 py-3 bg-slate-800 text-slate-400 rounded-lg font-bold text-lg border-2 border-slate-600';
                btnMerge.className = 'flex-1 py-3 bg-purple-600 text-white rounded-lg font-bold text-lg border-2 border-purple-400';
                panelMove.classList.add('hidden');
                panelMove.classList.remove('flex');
                panelMerge.classList.remove('hidden');
                panelMerge.classList.add('flex');
            }
        };

        document.addEventListener('DOMContentLoaded', function() {
            var movePalletInput = document.getElementById('move-pallet-id');
            if (movePalletInput) {
                movePalletInput.addEventListener('change', function() {
                    showPalletInfo('move-pallet-id', 'move-pallet-info');
                });
            }

            var mergeKeepInput = document.getElementById('merge-keep-id');
            if (mergeKeepInput) {
                mergeKeepInput.addEventListener('change', function() {
                    showPalletInfo('merge-keep-id', 'merge-keep-info');
                });
            }

            var mergeRemoveInput = document.getElementById('merge-remove-id');
            if (mergeRemoveInput) {
                mergeRemoveInput.addEventListener('change', function() {
                    showPalletInfo('merge-remove-id', 'merge-remove-info');
                });
            }
        });

        window.showPalletInfo = function(inputId, infoId) {
            var palletId = document.getElementById(inputId).value;
            var infoDiv = document.getElementById(infoId);

            if (!palletId) {
                infoDiv.innerHTML = '';
                return;
            }

            var pallet = window.currentPallets().find(function(p) {
                return p.palletId === palletId || p.id === palletId;
            });

            if (!pallet) {
                infoDiv.innerHTML = '<div class="text-red-400">âŒ æ‰¾ä¸åˆ°æ­¤æ£§æ¿</div>';
                return;
            }

            infoDiv.innerHTML = '<div class="text-white font-bold">' + pallet.productName + '</div>' +
                '<div class="text-slate-400">è¦æ ¼: ' + (pallet.spec || '-') + '</div>' +
                '<div class="text-yellow-400 font-bold">æ•¸é‡: ' + pallet.quantity + ' ä»¶</div>' +
                '<div class="text-slate-400">å„²ä½: ' + pallet.locationId + '</div>' +
                '<div class="text-slate-500 text-xs">æ‰¹è™Ÿ: ' + (pallet.batchNo || '-') + '</div>';
        };

        window.lookupPalletByDocNo = function(docNo, target) {
            if (!docNo) return;

            docNo = docNo.trim().toUpperCase();

            var pallet = window.currentPallets().find(function(p) {
                return p.palletId === docNo || p.palletId === docNo.toUpperCase();
            });

            var infoEl;
            if (target === 'move') {
                infoEl = document.getElementById('move-pallet-info');
            } else if (target === 'keep') {
                infoEl = document.getElementById('merge-keep-info');
            } else if (target === 'remove') {
                infoEl = document.getElementById('merge-remove-info');
            }

            if (!infoEl) return;

            if (!pallet) {
                infoEl.innerHTML = '<div class="text-red-400"><i class="fa-solid fa-times-circle mr-1"></i>æ‰¾ä¸åˆ°æ­¤å…¥åº«å–®è™Ÿçš„åº«å­˜</div>' +
                    '<div class="text-slate-500 text-xs mt-2">è«‹ç¢ºèªæ¢ç¢¼æ˜¯å¦æ­£ç¢º</div>';
                return;
            }

            var companyClass = pallet.company === 'å…«æ–¹' ? 'bg-purple-900/50 text-purple-300' : 'bg-blue-900/50 text-blue-300';
            var companyLabel = pallet.company ? '<span class="px-2 py-0.5 rounded text-xs ' + companyClass + '">' + pallet.company + '</span>' : '';

            infoEl.innerHTML =
                '<div class="text-emerald-400 mb-2"><i class="fa-solid fa-check-circle mr-1"></i>å·²æ‰¾åˆ° ' + companyLabel + '</div>' +
                '<div class="text-white font-bold text-lg">' + pallet.productName + '</div>' +
                '<div class="text-slate-300">' + (pallet.spec || '-') + '</div>' +
                '<div class="text-yellow-400 font-bold text-xl mt-1">' + pallet.quantity + ' ä»¶</div>' +
                '<div class="text-slate-400 mt-1"><i class="fa-solid fa-location-dot mr-1"></i>' + pallet.locationId + '</div>' +
                '<div class="text-slate-500 text-xs mt-1">æ‰¹è™Ÿ: ' + (pallet.batchNo || '-') + ' | æ•ˆæœŸ: ' + (pallet.expDate || pallet.expiryDate || '-') + '</div>';

            if (target === 'move') {
                window._movePalletData = pallet;
            } else if (target === 'keep') {
                window._keepPalletData = pallet;
            } else if (target === 'remove') {
                window._removePalletData = pallet;
            }
        };

        // ========== ç¾å ´æƒæä½œæ¥­ç³»çµ± ==========
        window._fieldData = {
            inbound: { location: null, pallet: null },
            outbound: { pallet: null, stock: 0 },
            move: { pallet: null, oldLoc: null },
            merge: { less: null, more: null }
        };

        window.setFieldMode = function(mode) {
            var modes = ['inbound', 'outbound', 'move', 'merge'];
            var colors = { inbound: 'emerald', outbound: 'orange', move: 'blue', merge: 'purple' };

            modes.forEach(function(m) {
                var btn = document.getElementById('btn-field-' + m);
                var panel = document.getElementById('panel-field-' + m);
                if (m === mode) {
                    btn.className = 'py-4 bg-' + colors[m] + '-600 text-white rounded-lg font-bold text-lg border-2 border-' + colors[m] + '-400';
                    panel.classList.remove('hidden');
                    panel.classList.add('flex');
                } else {
                    btn.className = 'py-4 bg-slate-800 text-slate-400 rounded-lg font-bold text-lg border-2 border-slate-600';
                    panel.classList.add('hidden');
                    panel.classList.remove('flex');
                }
            });
        };

        // ===== å…¥åº«ä½œæ¥­ =====
        window.fieldInboundStep1 = function() {
            var loc = document.getElementById('field-in-location').value.trim().toUpperCase();
            if (!loc) return;

            window._fieldData.inbound.location = loc;
            document.getElementById('field-in-step1-status').innerHTML = '<span class="text-emerald-400">âœ… ' + loc + '</span>';

            document.getElementById('field-in-step2-panel').classList.remove('opacity-50');
            document.getElementById('field-in-pallet').disabled = false;
            document.getElementById('field-in-pallet').focus();

            document.getElementById('field-in-result').innerHTML = '<div class="text-center"><div class="text-emerald-400 font-bold text-lg mb-1">å„²ä½ï¼š' + loc + '</div><div class="text-slate-400">è«‹æƒææ£§æ¿æ’å–®å®Œæˆç¶å®š</div></div>';
        };

        window.fieldInboundStep2 = async function() {
            var palletId = document.getElementById('field-in-pallet').value.trim().toUpperCase();
            if (!palletId) return;

            var loc = window._fieldData.inbound.location;
            if (!loc) {
                alert('è«‹å…ˆæƒæå„²ä½');
                return;
            }

            var pallet = window.currentPallets().find(function(p) {
                return p.palletId === palletId || p.id === palletId;
            });

            if (!pallet) {
                document.getElementById('field-in-step2-status').innerHTML = '<span class="text-red-400">âŒ æ‰¾ä¸åˆ°</span>';
                document.getElementById('field-in-result').innerHTML = '<div class="text-center text-red-400"><i class="fa-solid fa-times-circle text-3xl mb-2"></i><div>æ‰¾ä¸åˆ°æ­¤æ£§æ¿ï¼š' + palletId + '</div></div>';
                return;
            }

            try {
                await window.updateDoc(window.doc(window.db, "pallets", pallet.id), { locationId: loc });

                await window.addDoc(window.collection(window.db, 'inventoryLogs'), {
                    type: 'inbound',
                    productName: pallet.productName,
                    spec: pallet.spec || '',
                    quantity: pallet.quantity,
                    quantityChange: pallet.quantity,
                    locationId: loc,
                    batchNo: pallet.batchNo || '',
                    palletId: palletId,
                    note: 'ç¾å ´æƒæå…¥åº«',
                    operator: window.getOperatorName ? window.getOperatorName() : 'field',
                    timestamp: new Date()
                });

                document.getElementById('field-in-step2-status').innerHTML = '<span class="text-emerald-400">âœ… å·²ç¶å®š</span>';
                document.getElementById('field-in-result').innerHTML =
                    '<div class="text-center">' +
                    '<div class="text-emerald-400 text-4xl mb-3"><i class="fa-solid fa-check-circle"></i></div>' +
                    '<div class="text-white font-bold text-xl">' + pallet.productName + '</div>' +
                    '<div class="text-slate-400">' + (pallet.spec || '') + '</div>' +
                    '<div class="text-yellow-400 font-bold text-2xl mt-2">' + pallet.quantity + ' ä»¶</div>' +
                    '<div class="mt-3 pt-3 border-t border-slate-700">' +
                    '<span class="text-emerald-400 font-bold">âœ… å·²ç¶å®šè‡³ ' + loc + '</span>' +
                    '</div></div>';

                if (window.playSuccessSound) window.playSuccessSound();

                setTimeout(function() {
                    if (confirm('å…¥åº«æˆåŠŸï¼\n\næ˜¯å¦ç¹¼çºŒä¸‹ä¸€ç­†ï¼Ÿ')) {
                        resetFieldInbound();
                    }
                }, 500);

            } catch (err) {
                console.error(err);
                alert('å…¥åº«å¤±æ•—ï¼š' + err.message);
            }
        };

        window.resetFieldInbound = function() {
            window._fieldData.inbound = { location: null, pallet: null };
            document.getElementById('field-in-location').value = '';
            document.getElementById('field-in-pallet').value = '';
            document.getElementById('field-in-pallet').disabled = true;
            document.getElementById('field-in-step1-status').innerHTML = 'â³ ç­‰å¾…æƒæ';
            document.getElementById('field-in-step2-status').innerHTML = 'â³ ç­‰å¾…æƒæ';
            document.getElementById('field-in-step2-panel').classList.add('opacity-50');
            document.getElementById('field-in-result').innerHTML = '<div class="text-slate-500 text-center"><i class="fa-solid fa-qrcode text-4xl mb-2 opacity-30"></i><div>è«‹å…ˆæƒæå„²ä½æ¢ç¢¼</div></div>';
            document.getElementById('field-in-location').focus();
        };

        // ===== å‡ºåº«ä½œæ¥­ =====
        window.fieldOutboundStep1 = function() {
            var palletId = document.getElementById('field-out-pallet').value.trim().toUpperCase();
            if (!palletId) return;

            var pallet = window.currentPallets().find(function(p) {
                return p.palletId === palletId || p.id === palletId;
            });

            if (!pallet) {
                document.getElementById('field-out-step1-status').innerHTML = '<span class="text-red-400">âŒ æ‰¾ä¸åˆ°</span>';
                document.getElementById('field-out-info').classList.add('hidden');
                return;
            }

            window._fieldData.outbound.pallet = pallet;
            window._fieldData.outbound.stock = pallet.quantity;

            document.getElementById('field-out-step1-status').innerHTML = '<span class="text-emerald-400">âœ… æ‰¾åˆ°</span>';
            document.getElementById('field-out-product').innerText = pallet.productName;
            document.getElementById('field-out-spec').innerText = pallet.spec || '-';
            document.getElementById('field-out-stock').innerText = pallet.quantity;
            document.getElementById('field-out-loc').innerText = pallet.locationId;
            document.getElementById('field-out-info').classList.remove('hidden');

            document.getElementById('field-out-step2-panel').classList.remove('opacity-50');
            document.getElementById('field-out-qty').disabled = false;
            document.getElementById('btn-out-all').disabled = false;
            document.getElementById('btn-field-out-confirm').disabled = false;
            document.getElementById('field-out-qty').focus();
        };

        window.fieldOutboundAll = function() {
            var stock = window._fieldData.outbound.stock;
            document.getElementById('field-out-qty').value = stock;
        };

        window.executeFieldOutbound = async function() {
            var pallet = window._fieldData.outbound.pallet;
            if (!pallet) {
                alert('è«‹å…ˆæƒææ£§æ¿');
                return;
            }

            var qty = parseInt(document.getElementById('field-out-qty').value) || 0;
            if (qty <= 0) {
                alert('è«‹è¼¸å…¥å‡ºåº«æ•¸é‡');
                return;
            }

            if (qty > pallet.quantity) {
                alert('å‡ºåº«æ•¸é‡ä¸èƒ½è¶…éåº«å­˜ ' + pallet.quantity + ' ä»¶');
                return;
            }

            var newQty = pallet.quantity - qty;

            try {
                if (newQty === 0) {
                    await window.deleteDoc(window.doc(window.db, "pallets", pallet.id));
                } else {
                    await window.updateDoc(window.doc(window.db, "pallets", pallet.id), { quantity: newQty });
                }

                await window.addDoc(window.collection(window.db, 'inventoryLogs'), {
                    type: 'outbound',
                    productName: pallet.productName,
                    spec: pallet.spec || '',
                    quantity: qty,
                    quantityChange: -qty,
                    locationId: pallet.locationId,
                    batchNo: pallet.batchNo || '',
                    palletId: pallet.palletId,
                    note: 'ç¾å ´æƒæå‡ºåº«',
                    operator: window.getOperatorName ? window.getOperatorName() : 'field',
                    timestamp: new Date()
                });

                alert('âœ… å‡ºåº«æˆåŠŸï¼\n\n' + pallet.productName + '\nå‡ºåº«ï¼š' + qty + ' ä»¶\n' + (newQty > 0 ? 'å‰©é¤˜ï¼š' + newQty + ' ä»¶' : 'ï¼ˆå·²æ¸…ç©ºï¼‰'));
                resetFieldOutbound();

            } catch (err) {
                console.error(err);
                alert('å‡ºåº«å¤±æ•—ï¼š' + err.message);
            }
        };

        window.resetFieldOutbound = function() {
            window._fieldData.outbound = { pallet: null, stock: 0 };
            document.getElementById('field-out-pallet').value = '';
            document.getElementById('field-out-qty').value = '';
            document.getElementById('field-out-qty').disabled = true;
            document.getElementById('btn-out-all').disabled = true;
            document.getElementById('btn-field-out-confirm').disabled = true;
            document.getElementById('field-out-step1-status').innerHTML = 'â³ ç­‰å¾…æƒæ';
            document.getElementById('field-out-info').classList.add('hidden');
            document.getElementById('field-out-step2-panel').classList.add('opacity-50');
            document.getElementById('field-out-pallet').focus();
        };

        // ===== ç§»æ¿ä½œæ¥­ =====
        window.fieldMoveStep1 = function() {
            var palletId = document.getElementById('field-move-pallet').value.trim().toUpperCase();
            if (!palletId) return;

            var pallet = window.currentPallets().find(function(p) {
                return p.palletId === palletId || p.id === palletId;
            });

            if (!pallet) {
                document.getElementById('field-move-step1-status').innerHTML = '<span class="text-red-400">âŒ æ‰¾ä¸åˆ°</span>';
                document.getElementById('field-move-info').classList.add('hidden');
                return;
            }

            window._fieldData.move.pallet = pallet;
            window._fieldData.move.oldLoc = pallet.locationId;

            document.getElementById('field-move-step1-status').innerHTML = '<span class="text-emerald-400">âœ… æ‰¾åˆ°</span>';
            document.getElementById('field-move-product').innerText = pallet.productName;
            document.getElementById('field-move-spec').innerText = (pallet.spec || '-') + ' | ' + pallet.quantity + ' ä»¶';
            document.getElementById('field-move-old-loc').innerText = pallet.locationId;
            document.getElementById('field-move-info').classList.remove('hidden');

            document.getElementById('field-move-step2-panel').classList.remove('opacity-50');
            document.getElementById('field-move-new-loc').disabled = false;
            document.getElementById('field-move-new-loc').focus();
        };

        window.fieldMoveStep2 = async function() {
            var newLoc = document.getElementById('field-move-new-loc').value.trim().toUpperCase();
            if (!newLoc) return;

            var pallet = window._fieldData.move.pallet;
            if (!pallet) {
                alert('è«‹å…ˆæƒææ£§æ¿');
                return;
            }

            var oldLoc = window._fieldData.move.oldLoc;

            try {
                await window.updateDoc(window.doc(window.db, "pallets", pallet.id), { locationId: newLoc });

                await window.addDoc(window.collection(window.db, 'inventoryLogs'), {
                    type: 'move',
                    productName: pallet.productName,
                    spec: pallet.spec || '',
                    quantity: pallet.quantity,
                    quantityChange: 0,
                    locationId: newLoc,
                    fromLocation: oldLoc,
                    batchNo: pallet.batchNo || '',
                    palletId: pallet.palletId,
                    note: 'ç¾å ´æƒæç§»æ¿ï¼š' + oldLoc + ' â†’ ' + newLoc,
                    operator: window.getOperatorName ? window.getOperatorName() : 'field',
                    timestamp: new Date()
                });

                document.getElementById('field-move-step2-status').innerHTML = '<span class="text-emerald-400">âœ… å®Œæˆ</span>';
                document.getElementById('field-move-result').classList.remove('hidden');
                document.getElementById('field-move-result').innerHTML =
                    '<div class="text-center w-full">' +
                    '<div class="text-emerald-400 text-3xl mb-2"><i class="fa-solid fa-check-circle"></i></div>' +
                    '<div class="text-white font-bold">' + pallet.productName + '</div>' +
                    '<div class="flex items-center justify-center gap-3 mt-2">' +
                    '<span class="text-slate-400 line-through">' + oldLoc + '</span>' +
                    '<i class="fa-solid fa-arrow-right text-emerald-400"></i>' +
                    '<span class="text-emerald-400 font-bold text-xl">' + newLoc + '</span>' +
                    '</div></div>';

                setTimeout(function() {
                    if (confirm('ç§»æ¿æˆåŠŸï¼\n\næ˜¯å¦ç¹¼çºŒä¸‹ä¸€ç­†ï¼Ÿ')) {
                        resetFieldMove();
                    }
                }, 500);

            } catch (err) {
                console.error(err);
                alert('ç§»æ¿å¤±æ•—ï¼š' + err.message);
            }
        };

        window.resetFieldMove = function() {
            window._fieldData.move = { pallet: null, oldLoc: null };
            document.getElementById('field-move-pallet').value = '';
            document.getElementById('field-move-new-loc').value = '';
            document.getElementById('field-move-new-loc').disabled = true;
            document.getElementById('field-move-step1-status').innerHTML = 'â³ ç­‰å¾…æƒæ';
            document.getElementById('field-move-step2-status').innerHTML = 'â³ ç­‰å¾…æƒæ';
            document.getElementById('field-move-step2-panel').classList.add('opacity-50');
            document.getElementById('field-move-info').classList.add('hidden');
            document.getElementById('field-move-result').classList.add('hidden');
            document.getElementById('field-move-pallet').focus();
        };

        // ===== ä½µæ¿ä½œæ¥­ =====
        window.fieldMergeStep1 = function() {
            var palletId = document.getElementById('field-merge-less').value.trim().toUpperCase();
            if (!palletId) return;

            var pallet = window.currentPallets().find(function(p) {
                return p.palletId === palletId || p.id === palletId;
            });

            if (!pallet) {
                document.getElementById('field-merge-step1-status').innerHTML = '<span class="text-red-400">âŒ æ‰¾ä¸åˆ°</span>';
                document.getElementById('field-merge-less-info').classList.add('hidden');
                return;
            }

            window._fieldData.merge.less = pallet;

            document.getElementById('field-merge-step1-status').innerHTML = '<span class="text-emerald-400">âœ… ' + pallet.quantity + 'ä»¶</span>';
            document.getElementById('field-merge-less-name').innerText = pallet.productName;
            document.getElementById('field-merge-less-qty').innerText = pallet.quantity;
            document.getElementById('field-merge-less-info').classList.remove('hidden');

            document.getElementById('field-merge-step2-panel').classList.remove('opacity-50');
            document.getElementById('field-merge-more').disabled = false;
            document.getElementById('field-merge-more').focus();
        };

        window.fieldMergeStep2 = function() {
            var palletId = document.getElementById('field-merge-more').value.trim().toUpperCase();
            if (!palletId) return;

            var pallet = window.currentPallets().find(function(p) {
                return p.palletId === palletId || p.id === palletId;
            });

            if (!pallet) {
                document.getElementById('field-merge-step2-status').innerHTML = '<span class="text-red-400">âŒ æ‰¾ä¸åˆ°</span>';
                document.getElementById('field-merge-more-info').classList.add('hidden');
                return;
            }

            var less = window._fieldData.merge.less;

            if (less.productName !== pallet.productName) {
                alert('âš ï¸ å“åä¸åŒï¼\n\nå°‘çš„ï¼š' + less.productName + '\nå¤šçš„ï¼š' + pallet.productName + '\n\nç„¡æ³•åˆä½µä¸åŒå“é …');
                document.getElementById('field-merge-more').value = '';
                return;
            }

            window._fieldData.merge.more = pallet;

            var total = less.quantity + pallet.quantity;

            document.getElementById('field-merge-step2-status').innerHTML = '<span class="text-emerald-400">âœ… ' + pallet.quantity + 'ä»¶</span>';
            document.getElementById('field-merge-more-name').innerText = pallet.productName;
            document.getElementById('field-merge-more-qty').innerText = pallet.quantity;
            document.getElementById('field-merge-more-info').classList.remove('hidden');

            document.getElementById('field-merge-total').innerText = total;
            document.getElementById('field-merge-less-qty2').innerText = less.quantity;
            document.getElementById('field-merge-more-qty2').innerText = pallet.quantity;
            document.getElementById('field-merge-total2').innerText = total;
            document.getElementById('field-merge-preview').classList.remove('hidden');
            document.getElementById('btn-field-merge-confirm').disabled = false;
        };

        window.executeFieldMerge = async function() {
            var less = window._fieldData.merge.less;
            var more = window._fieldData.merge.more;

            if (!less || !more) {
                alert('è«‹å…ˆå®Œæˆæƒæ');
                return;
            }

            var total = less.quantity + more.quantity;

            try {
                var batch = window.writeBatch(window.db);

                batch.update(window.doc(window.db, "pallets", more.id), { quantity: total });

                batch.delete(window.doc(window.db, "pallets", less.id));

                await batch.commit();

                await window.addDoc(window.collection(window.db, 'inventoryLogs'), {
                    type: 'merge',
                    productName: more.productName,
                    spec: more.spec || '',
                    quantity: total,
                    quantityChange: 0,
                    locationId: more.locationId,
                    batchNo: more.batchNo || '',
                    palletId: more.palletId,
                    note: 'ç¾å ´æƒæä½µæ¿ï¼š' + less.palletId + '(' + less.quantity + ') â†’ ' + more.palletId + '(' + more.quantity + ') = ' + total,
                    operator: window.getOperatorName ? window.getOperatorName() : 'field',
                    timestamp: new Date()
                });

                alert('âœ… ä½µæ¿æˆåŠŸï¼\n\n' + more.productName + '\nåˆä½µå¾Œæ•¸é‡ï¼š' + total + ' ä»¶\nä¿ç•™æ¿ï¼š' + more.palletId + '\nåˆªé™¤æ¿ï¼š' + less.palletId);
                resetFieldMerge();

            } catch (err) {
                console.error(err);
                alert('ä½µæ¿å¤±æ•—ï¼š' + err.message);
            }
        };

        window.resetFieldMerge = function() {
            window._fieldData.merge = { less: null, more: null };
            document.getElementById('field-merge-less').value = '';
            document.getElementById('field-merge-more').value = '';
            document.getElementById('field-merge-more').disabled = true;
            document.getElementById('field-merge-step1-status').innerHTML = 'â³ ç­‰å¾…æƒæ';
            document.getElementById('field-merge-step2-status').innerHTML = 'â³ ç­‰å¾…æƒæ';
            document.getElementById('field-merge-step2-panel').classList.add('opacity-50');
            document.getElementById('field-merge-less-info').classList.add('hidden');
            document.getElementById('field-merge-more-info').classList.add('hidden');
            document.getElementById('field-merge-preview').classList.add('hidden');
            document.getElementById('btn-field-merge-confirm').disabled = true;
            document.getElementById('field-merge-less').focus();
        };

        // ========== å‚™æ¡ˆæŸ¥è©¢åŠŸèƒ½ ==========
        window._currentFallbackTarget = null; // 'keep' or 'remove'

        window.openMoveFallback = function() {
            document.getElementById('panel-move-fallback').classList.remove('hidden');
            document.getElementById('fallback-move-loc').value = '';
            document.getElementById('fallback-move-search').value = '';
            document.getElementById('fallback-move-list').innerHTML = '<div class="text-slate-500 text-center py-4">è¼¸å…¥å„²ä½æˆ–å“åæœå°‹</div>';
        };

        window.closeMoveFallback = function() {
            document.getElementById('panel-move-fallback').classList.add('hidden');
        };

        window.openMergeFallback = function(target) {
            window._currentFallbackTarget = target;
            document.getElementById('merge-fallback-target').innerText = target === 'keep' ? 'ï¼ˆé¸æ“‡ä¿ç•™ï¼‰' : 'ï¼ˆé¸æ“‡ç§»å…¥ï¼‰';
            document.getElementById('panel-merge-fallback').classList.remove('hidden');
            document.getElementById('fallback-merge-loc').value = '';
            document.getElementById('fallback-merge-search').value = '';
            document.getElementById('fallback-merge-list').innerHTML = '<div class="text-slate-500 text-center py-4">è¼¸å…¥å„²ä½æˆ–å“åæœå°‹</div>';
        };

        window.closeMergeFallback = function() {
            document.getElementById('panel-merge-fallback').classList.add('hidden');
        };

        window.searchPalletsByLocation = function(loc, mode) {
            if (!loc) return;
            loc = loc.trim().toUpperCase();

            var pallets = window.currentPallets().filter(function(p) {
                return p.locationId && p.locationId.toUpperCase() === loc;
            });

            renderFallbackList(pallets, mode);
        };

        window.searchPalletsByName = function(keyword, mode) {
            if (!keyword || keyword.length < 1) return;
            keyword = keyword.toLowerCase();

            var pallets = window.currentPallets().filter(function(p) {
                return p.productName && p.productName.toLowerCase().includes(keyword);
            });

            pallets = pallets.slice(0, 20);
            renderFallbackList(pallets, mode);
        };

        function renderFallbackList(pallets, mode) {
            var listId = mode === 'move' ? 'fallback-move-list' : 'fallback-merge-list';
            var listEl = document.getElementById(listId);

            if (pallets.length === 0) {
                listEl.innerHTML = '<div class="text-slate-500 text-center py-4">æ‰¾ä¸åˆ°åº«å­˜</div>';
                return;
            }

            var html = '';
            pallets.forEach(function(p, idx) {
                html += '<div class="flex items-center justify-between p-2 hover:bg-slate-800 rounded cursor-pointer border-b border-slate-700" onclick="selectFallbackPallet(\'' + mode + '\', ' + idx + ')" data-pallet-id="' + p.palletId + '">';
                html += '<div class="flex-1">';
                html += '<div class="text-white font-bold">' + p.productName + ' <span class="text-slate-400 font-normal">' + (p.spec || '') + '</span></div>';
                html += '<div class="text-xs text-slate-500">æ‰¹è™Ÿ: ' + (p.batchNo || '-') + ' | æ•ˆæœŸ: ' + (p.expDate || p.expiryDate || '-') + '</div>';
                html += '</div>';
                html += '<div class="text-right">';
                html += '<div class="text-yellow-400 font-bold">' + p.quantity + ' ä»¶</div>';
                html += '<div class="text-xs text-slate-400">' + p.locationId + '</div>';
                html += '</div>';
                html += '</div>';
            });

            listEl.innerHTML = html;

            if (mode === 'move') {
                window._fallbackMovePallets = pallets;
            } else {
                window._fallbackMergePallets = pallets;
            }
        }

        window.selectFallbackPallet = function(mode, idx) {
            var pallet;
            if (mode === 'move') {
                pallet = window._fallbackMovePallets[idx];
                if (pallet) {
                    window._movePalletData = pallet;
                    document.getElementById('move-pallet-id').value = pallet.palletId;

                    document.getElementById('move-pallet-info').innerHTML =
                        '<div class="text-emerald-400 mb-2"><i class="fa-solid fa-check-circle mr-1"></i>å·²é¸æ“‡ï¼ˆå‚™æ¡ˆï¼‰</div>' +
                        '<div class="text-white font-bold text-lg">' + pallet.productName + '</div>' +
                        '<div class="text-slate-300">' + (pallet.spec || '-') + '</div>' +
                        '<div class="text-yellow-400 font-bold text-xl mt-1">' + pallet.quantity + ' ä»¶</div>' +
                        '<div class="text-slate-400 mt-1"><i class="fa-solid fa-location-dot mr-1"></i>' + pallet.locationId + '</div>' +
                        '<div class="text-slate-500 text-xs mt-1">æ‰¹è™Ÿ: ' + (pallet.batchNo || '-') + '</div>';

                    closeMoveFallback();
                }
            } else {
                pallet = window._fallbackMergePallets[idx];
                if (pallet) {
                    var target = window._currentFallbackTarget;

                    if (target === 'keep') {
                        window._keepPalletData = pallet;
                        document.getElementById('merge-keep-id').value = pallet.palletId;
                        document.getElementById('merge-keep-info').innerHTML =
                            '<div class="text-emerald-400 mb-2"><i class="fa-solid fa-check-circle mr-1"></i>å·²é¸æ“‡ï¼ˆå‚™æ¡ˆï¼‰</div>' +
                            '<div class="text-white font-bold text-lg">' + pallet.productName + '</div>' +
                            '<div class="text-slate-300">' + (pallet.spec || '-') + '</div>' +
                            '<div class="text-yellow-400 font-bold text-xl mt-1">' + pallet.quantity + ' ä»¶</div>' +
                            '<div class="text-slate-400 mt-1"><i class="fa-solid fa-location-dot mr-1"></i>' + pallet.locationId + '</div>';
                    } else {
                        window._removePalletData = pallet;
                        document.getElementById('merge-remove-id').value = pallet.palletId;
                        document.getElementById('merge-remove-info').innerHTML =
                            '<div class="text-emerald-400 mb-2"><i class="fa-solid fa-check-circle mr-1"></i>å·²é¸æ“‡ï¼ˆå‚™æ¡ˆï¼‰</div>' +
                            '<div class="text-white font-bold text-lg">' + pallet.productName + '</div>' +
                            '<div class="text-slate-300">' + (pallet.spec || '-') + '</div>' +
                            '<div class="text-yellow-400 font-bold text-xl mt-1">' + pallet.quantity + ' ä»¶</div>' +
                            '<div class="text-slate-400 mt-1"><i class="fa-solid fa-location-dot mr-1"></i>' + pallet.locationId + '</div>';
                    }

                    closeMergeFallback();
                }
            }
        };

        window.executePalletMove = async function() {
            var palletId = document.getElementById('move-pallet-id').value.trim();
            var targetLoc = document.getElementById('move-target-loc').value.trim().toUpperCase();

            if (!palletId) {
                alert('è«‹æƒææˆ–è¼¸å…¥å…¥åº«å–®è™Ÿ');
                return;
            }
            if (!targetLoc) {
                alert('è«‹è¼¸å…¥ç›®æ¨™å„²ä½');
                return;
            }

            var pallet = window._movePalletData;
            var pallets = window.currentPallets();

            if (!pallet) {
                pallet = pallets.find(function(p) {
                    return p.palletId === palletId || p.palletId === palletId.toUpperCase() ||
                           p.palletId && p.palletId.toLowerCase() === palletId.toLowerCase();
                });
            }

            if (!pallet) {
                alert('æ‰¾ä¸åˆ°æ­¤å…¥åº«å–®è™Ÿçš„åº«å­˜\n\nè«‹ç¢ºèªæ¢ç¢¼æ˜¯å¦æ­£ç¢ºï¼Œæˆ–ä½¿ç”¨æŸ¥è©¢åŠŸèƒ½');
                return;
            }

            var oldLoc = pallet.locationId;

            if (oldLoc === targetLoc) {
                alert('ç›®æ¨™å„²ä½èˆ‡ç›®å‰å„²ä½ç›¸åŒ');
                return;
            }

            if (!confirm('ç¢ºèªç§»å‹•ï¼Ÿ\n\n' +
                'ğŸ“¦ ' + pallet.productName + ' ' + (pallet.spec || '') + '\n' +
                'æ•¸é‡: ' + pallet.quantity + ' ä»¶' + (pallet.totalWeight > 0 ? ' / ' + pallet.totalWeight + ' kg' : '') + '\n' +
                'æ‰¹è™Ÿ: ' + (pallet.batchNo || '-') + '\n\n' +
                'ğŸ“ ' + oldLoc + ' â†’ ' + targetLoc)) {
                return;
            }

            try {
                var idx = pallets.findIndex(function(p) { return p.palletId === pallet.palletId; });
                if (idx >= 0) {
                    pallets[idx].locationId = targetLoc;
                    pallets[idx].movedAt = new Date().toISOString();
                    pallets[idx].movedBy = window.currentUser ? window.currentUser.email : 'admin';
                }

                if (window.db && window.updateDoc && pallet.id) {
                    await window.updateDoc(window.doc(window.db, 'pallets', pallet.id), {
                        locationId: targetLoc,
                        movedAt: new Date().toISOString(),
                        movedBy: window.currentUser ? window.currentUser.email : 'admin'
                    });
                }

                await window.logInventoryChange({
                    type: 'move',
                    company: pallet.company || '',
                    productName: pallet.productName,
                    spec: pallet.spec || '',
                    quantity: pallet.quantity,
                    weight: pallet.totalWeight || 0,
                    fromLocation: oldLoc,
                    toLocation: targetLoc,
                    batchNo: pallet.batchNo || '',
                    palletId: pallet.palletId,
                    note: 'ç§»ä½: ' + oldLoc + ' â†’ ' + targetLoc
                });

                alert('âœ… ç§»å‹•æˆåŠŸï¼\n\n' + oldLoc + ' â†’ ' + targetLoc);

                document.getElementById('move-pallet-id').value = '';
                document.getElementById('move-target-loc').value = '';
                document.getElementById('move-pallet-info').innerHTML = '<div class="text-slate-500 text-center py-2"><i class="fa-solid fa-barcode mr-2"></i>ç­‰å¾…æƒæ...</div>';
                window._movePalletData = null;

                if (typeof renderInventoryTable === 'function') renderInventoryTable();

            } catch (e) {
                alert('âŒ ç§»å‹•å¤±æ•—: ' + e.message);
            }
        };

        window.executePalletMerge = async function() {
            var keepId = document.getElementById('merge-keep-id').value.trim();
            var removeId = document.getElementById('merge-remove-id').value.trim();

            if (!keepId) {
                alert('è«‹æƒææˆ–è¼¸å…¥ä¿ç•™è²¨ç‰©çš„æ¢ç¢¼');
                return;
            }
            if (!removeId) {
                alert('è«‹æƒææˆ–è¼¸å…¥è¦åˆä½µè²¨ç‰©çš„æ¢ç¢¼');
                return;
            }
            if (keepId.toUpperCase() === removeId.toUpperCase()) {
                alert('ä¿ç•™å’Œç§»å…¥ä¸èƒ½æ˜¯åŒä¸€ç­†');
                return;
            }

            var pallets = window.currentPallets();

            var keepPallet = window._keepPalletData;
            if (!keepPallet) {
                keepPallet = pallets.find(function(p) {
                    return p.palletId === keepId || p.palletId === keepId.toUpperCase() ||
                           p.palletId && p.palletId.toLowerCase() === keepId.toLowerCase();
                });
            }

            var removePallet = window._removePalletData;
            if (!removePallet) {
                removePallet = pallets.find(function(p) {
                    return p.palletId === removeId || p.palletId === removeId.toUpperCase() ||
                           p.palletId && p.palletId.toLowerCase() === removeId.toLowerCase();
                });
            }

            if (!keepPallet) {
                alert('æ‰¾ä¸åˆ°ä¿ç•™è²¨ç‰©çš„åº«å­˜\n\nè«‹ç¢ºèªæ¢ç¢¼æ˜¯å¦æ­£ç¢ºï¼Œæˆ–ä½¿ç”¨æŸ¥è©¢åŠŸèƒ½');
                return;
            }
            if (!removePallet) {
                alert('æ‰¾ä¸åˆ°è¦åˆä½µè²¨ç‰©çš„åº«å­˜\n\nè«‹ç¢ºèªæ¢ç¢¼æ˜¯å¦æ­£ç¢ºï¼Œæˆ–ä½¿ç”¨æŸ¥è©¢åŠŸèƒ½');
                return;
            }

            if (keepPallet.productName !== removePallet.productName) {
                if (!confirm('âš ï¸ è­¦å‘Šï¼šå…©æ‰¹è²¨ç‰©å“åä¸åŒï¼\n\n' +
                    'ä¿ç•™: ' + keepPallet.productName + '\n' +
                    'ç§»å…¥: ' + removePallet.productName + '\n\n' +
                    'ç¢ºå®šè¦ç¹¼çºŒåˆä½µå—ï¼Ÿ')) {
                    return;
                }
            }

            var newQty = (keepPallet.quantity || 0) + (removePallet.quantity || 0);
            var newWeight = (keepPallet.totalWeight || 0) + (removePallet.totalWeight || 0);
            newWeight = Math.round(newWeight * 10) / 10; // å››æ¨äº”å…¥åˆ°å°æ•¸ä¸€ä½

            var newUnitWeight = newQty > 0 && newWeight > 0 ? Math.round(newWeight / newQty * 100) / 100 : (keepPallet.unitWeight || 0);

            var confirmMsg = 'ç¢ºèªåˆä½µï¼Ÿ\n\n' +
                'ã€ä¿ç•™ã€‘\n' +
                '  ğŸ“¦ ' + keepPallet.productName + ' ' + (keepPallet.spec || '') + '\n' +
                '  æ•¸é‡: ' + keepPallet.quantity + ' ä»¶' + (keepPallet.totalWeight > 0 ? ' / ' + keepPallet.totalWeight + ' kg' : '') + '\n' +
                '  å„²ä½: ' + keepPallet.locationId + '\n\n' +
                'ã€ç§»å…¥ä¸¦åˆªé™¤ã€‘\n' +
                '  ğŸ“¦ ' + removePallet.productName + ' ' + (removePallet.spec || '') + '\n' +
                '  æ•¸é‡: ' + removePallet.quantity + ' ä»¶' + (removePallet.totalWeight > 0 ? ' / ' + removePallet.totalWeight + ' kg' : '') + '\n' +
                '  å„²ä½: ' + removePallet.locationId + '\n\n' +
                'âœ… åˆä½µå¾Œ: ' + newQty + ' ä»¶';
            if (newWeight > 0) {
                confirmMsg += ' / ' + newWeight + ' kg';
            }

            if (!confirm(confirmMsg)) {
                return;
            }

            try {
                var keepIdx = pallets.findIndex(function(p) { return p.palletId === keepPallet.palletId; });
                var removeIdx = pallets.findIndex(function(p) { return p.palletId === removePallet.palletId; });

                if (keepIdx >= 0) {
                    pallets[keepIdx].quantity = newQty;
                    pallets[keepIdx].totalWeight = newWeight;
                    pallets[keepIdx].unitWeight = newUnitWeight;
                    pallets[keepIdx].mergedAt = new Date().toISOString();
                    pallets[keepIdx].mergedBy = window.currentUser ? window.currentUser.email : 'admin';
                }

                if (removeIdx >= 0) {
                    pallets.splice(removeIdx, 1);
                }

                if (window.db && window.writeBatch && keepPallet.id && removePallet.id) {
                    var batch = window.writeBatch(window.db);
                    batch.update(window.doc(window.db, 'pallets', keepPallet.id), {
                        quantity: newQty,
                        totalWeight: newWeight,
                        unitWeight: newUnitWeight,
                        mergedAt: new Date().toISOString(),
                        mergedBy: window.currentUser ? window.currentUser.email : 'admin'
                    });
                    batch.delete(window.doc(window.db, 'pallets', removePallet.id));
                    await batch.commit();
                }

                var mergeNote = 'åˆä½µ: ' + removePallet.palletId + '(' + removePallet.quantity + 'ä»¶';
                if (removePallet.totalWeight > 0) mergeNote += '/' + removePallet.totalWeight + 'kg';
                mergeNote += ') â†’ ' + keepPallet.palletId;

                await window.logInventoryChange({
                    type: 'merge',
                    company: keepPallet.company || '',
                    productName: keepPallet.productName,
                    spec: keepPallet.spec || '',
                    quantity: newQty,
                    weight: newWeight,
                    quantityChange: removePallet.quantity,
                    weightChange: removePallet.totalWeight || 0,
                    locationId: keepPallet.locationId,
                    fromLocation: removePallet.locationId,
                    toLocation: keepPallet.locationId,
                    batchNo: keepPallet.batchNo || '',
                    palletId: keepPallet.palletId,
                    note: mergeNote
                });

                var successMsg = 'âœ… åˆä½µæˆåŠŸï¼\n\næ–°æ•¸é‡: ' + newQty + ' ä»¶';
                if (newWeight > 0) successMsg += ' / ' + newWeight + ' kg';
                alert(successMsg);

                document.getElementById('merge-keep-id').value = '';
                document.getElementById('merge-remove-id').value = '';
                document.getElementById('merge-keep-info').innerHTML = '<div class="text-slate-500 text-center py-1"><i class="fa-solid fa-barcode mr-1"></i>ç­‰å¾…æƒæ...</div>';
                document.getElementById('merge-remove-info').innerHTML = '<div class="text-slate-500 text-center py-1"><i class="fa-solid fa-barcode mr-1"></i>ç­‰å¾…æƒæ...</div>';
                window._keepPalletData = null;
                window._removePalletData = null;

                if (typeof renderInventoryTable === 'function') renderInventoryTable();

            } catch (e) {
                alert('âŒ åˆä½µå¤±æ•—: ' + e.message);
            }
        };

        // ========== å·¥å–®çœ‹æ¿åŠŸèƒ½ ==========
        
        var boardRefreshTimer = null;
        
        // åˆ·æ–°å·¥å–®çœ‹æ¿
        window.refreshWorkBoard = function() {
            // æ›´æ–°æ™‚é–“
            var now = new Date();
            document.getElementById('board-update-time').textContent = 
                'æ›´æ–°æ™‚é–“ï¼š' + now.toLocaleTimeString('zh-TW');
            
            // çµ±è¨ˆæ•¸æ“š
            var pendingCount = 0;
            var waveCount = 0;
            var transferCount = 0;
            var moveCount = 0;
            var urgentCount = 0;
            
            // 1. å¾…å…¥åº«å·¥å–®
            var pendingHtml = '';
            var pendingInbounds = window.pendingInbounds || [];
            pendingCount = pendingInbounds.length;
            
            pendingInbounds.forEach(function(order, idx) {
                if (idx >= 10) return; // æœ€å¤šé¡¯ç¤º 10 ç­†
                var isUrgent = order.priority === 'urgent';
                if (isUrgent) urgentCount++;
                
                var timeStr = order.createdAt ? new Date(order.createdAt).toLocaleTimeString('zh-TW', {hour: '2-digit', minute: '2-digit'}) : '';
                
                pendingHtml += '<div class="bg-slate-800 rounded-lg p-3 border-l-4 ' + 
                    (isUrgent ? 'border-red-500 animate-pulse' : 'border-yellow-500') + '">';
                pendingHtml += '<div class="flex justify-between items-start">';
                pendingHtml += '<div class="text-lg font-bold text-white truncate flex-1">' + (order.productName || '-') + '</div>';
                pendingHtml += '<div class="text-2xl font-bold ' + (isUrgent ? 'text-red-400' : 'text-yellow-400') + '">' + (order.quantity || 0) + ' ä»¶</div>';
                pendingHtml += '</div>';
                pendingHtml += '<div class="flex justify-between items-center mt-2 text-sm">';
                pendingHtml += '<span class="text-slate-400">' + (order.spec || '-') + '</span>';
                pendingHtml += '<span class="text-emerald-400 font-bold text-lg">' + (order.locationId || 'å¾…æŒ‡å®š') + '</span>';
                pendingHtml += '</div>';
                if (timeStr) {
                    pendingHtml += '<div class="text-xs text-slate-500 mt-1"><i class="fa-solid fa-clock mr-1"></i>' + timeStr + '</div>';
                }
                pendingHtml += '</div>';
            });
            
            if (pendingCount === 0) {
                pendingHtml = '<div class="text-center text-slate-500 py-8"><i class="fa-solid fa-check-circle text-4xl mb-2 block text-emerald-500"></i>ç„¡å¾…å…¥åº«å·¥å–®</div>';
            }
            document.getElementById('board-pending-list').innerHTML = pendingHtml;
            
            // 2. æ€è²¨å·¥å–®ï¼ˆæ³¢æ¬¡ï¼‰- ä¿®æ­£æ•¸æ“šä¾†æº
            var waveHtml = '';
            var waves = (window._waveData && window._waveData.waves) ? window._waveData.waves : (window.waveData || []);
            var activeWaves = waves.filter(function(w) { 
                return w.status === 'picking' || w.status === 'pending'; 
            });
            waveCount = activeWaves.length;
            
            activeWaves.forEach(function(wave, idx) {
                if (idx >= 10) return;
                var progress = wave.pickedOrders ? Math.round(wave.pickedOrders / wave.totalOrders * 100) : 0;
                var isUrgent = wave.priority === 'urgent';
                if (isUrgent) urgentCount++;
                
                waveHtml += '<div class="bg-slate-800 rounded-lg p-3 border-l-4 ' + 
                    (isUrgent ? 'border-red-500 animate-pulse' : 'border-orange-500') + '">';
                waveHtml += '<div class="flex justify-between items-start">';
                waveHtml += '<div class="text-lg font-bold text-white">' + (wave.waveNo || wave.id) + '</div>';
                waveHtml += '<div class="text-sm px-2 py-0.5 rounded ' + 
                    (wave.status === 'picking' ? 'bg-orange-600' : 'bg-slate-600') + ' text-white">' + 
                    (wave.status === 'picking' ? 'æ€è²¨ä¸­' : 'å¾…è™•ç†') + '</div>';
                waveHtml += '</div>';
                waveHtml += '<div class="mt-2">';
                waveHtml += '<div class="flex justify-between text-sm mb-1">';
                waveHtml += '<span class="text-slate-400">é€²åº¦</span>';
                waveHtml += '<span class="text-orange-400 font-bold">' + (wave.pickedOrders || 0) + '/' + (wave.totalOrders || 0) + '</span>';
                waveHtml += '</div>';
                waveHtml += '<div class="w-full bg-slate-700 rounded-full h-2">';
                waveHtml += '<div class="bg-orange-500 h-2 rounded-full" style="width:' + progress + '%"></div>';
                waveHtml += '</div>';
                waveHtml += '</div>';
                waveHtml += '</div>';
            });
            
            if (waveCount === 0) {
                waveHtml = '<div class="text-center text-slate-500 py-8"><i class="fa-solid fa-check-circle text-4xl mb-2 block text-emerald-500"></i>ç„¡é€²è¡Œä¸­æ€è²¨</div>';
            }
            document.getElementById('board-wave-list').innerHTML = waveHtml;
            
            // 3. èª¿æ’¥/ç§»ä½å·¥å–®
            var transferHtml = '';
            var transferList = window.transferList || [];
            var pendingTransfers = transferList.filter(function(t) { return t.status !== 'completed'; });
            transferCount = pendingTransfers.length;
            
            pendingTransfers.forEach(function(item, idx) {
                if (idx >= 10) return;
                transferHtml += '<div class="bg-slate-800 rounded-lg p-3 border-l-4 border-purple-500">';
                transferHtml += '<div class="text-lg font-bold text-white truncate">' + (item.productName || '-') + '</div>';
                transferHtml += '<div class="flex justify-between items-center mt-2">';
                transferHtml += '<div class="text-sm">';
                transferHtml += '<span class="text-cyan-400">' + (item.fromWarehouse || item.from || '-') + '</span>';
                transferHtml += '<i class="fa-solid fa-arrow-right mx-2 text-slate-500"></i>';
                transferHtml += '<span class="text-emerald-400">' + (item.toWarehouse || item.to || '-') + '</span>';
                transferHtml += '</div>';
                transferHtml += '<div class="text-xl font-bold text-purple-400">' + (item.quantity || 0) + ' ä»¶</div>';
                transferHtml += '</div>';
                transferHtml += '</div>';
            });
            
            // ç§»ä½å·¥å–®ï¼ˆå¾å¾…ç§»ä½ä½‡åˆ—ï¼‰
            var moveList = window.pendingMoves || [];
            moveCount = moveList.length;
            
            moveList.forEach(function(item, idx) {
                if (idx >= 5) return;
                transferHtml += '<div class="bg-slate-800 rounded-lg p-3 border-l-4 border-cyan-500">';
                transferHtml += '<div class="flex justify-between items-start">';
                transferHtml += '<div class="text-lg font-bold text-white truncate flex-1">' + (item.productName || '-') + '</div>';
                transferHtml += '<span class="text-xs bg-cyan-600 px-2 py-0.5 rounded text-white">ç§»ä½</span>';
                transferHtml += '</div>';
                transferHtml += '<div class="flex justify-between items-center mt-2">';
                transferHtml += '<div class="text-sm">';
                transferHtml += '<span class="text-slate-400">' + (item.from || '-') + '</span>';
                transferHtml += '<i class="fa-solid fa-arrow-right mx-2 text-slate-500"></i>';
                transferHtml += '<span class="text-emerald-400">' + (item.to || '-') + '</span>';
                transferHtml += '</div>';
                transferHtml += '</div>';
                transferHtml += '</div>';
            });
            
            if (transferCount === 0 && moveCount === 0) {
                transferHtml = '<div class="text-center text-slate-500 py-8"><i class="fa-solid fa-check-circle text-4xl mb-2 block text-emerald-500"></i>ç„¡å¾…è™•ç†èª¿æ’¥</div>';
            }
            document.getElementById('board-transfer-list').innerHTML = transferHtml;
            
            // æ›´æ–°çµ±è¨ˆæ•¸å­—
            document.getElementById('board-pending-count').textContent = pendingCount;
            document.getElementById('board-pending-badge').textContent = pendingCount;
            document.getElementById('board-wave-count').textContent = waveCount;
            document.getElementById('board-wave-badge').textContent = waveCount;
            document.getElementById('board-transfer-count').textContent = transferCount;
            document.getElementById('board-transfer-badge').textContent = transferCount + moveCount;
            document.getElementById('board-move-count').textContent = moveCount;
            document.getElementById('board-urgent-count').textContent = urgentCount;
            
            // å¦‚æœæœ‰ç·Šæ€¥å·¥å–®ï¼Œé–ƒçˆæ¨™é¡Œ
            var titleEl = document.querySelector('#view-work-board h1');
            if (urgentCount > 0 && titleEl) {
                titleEl.classList.add('animate-pulse');
            } else if (titleEl) {
                titleEl.classList.remove('animate-pulse');
            }
        };
        
        // è¨­å®šè‡ªå‹•åˆ·æ–°é–“éš”
        window.setBoardRefreshInterval = function() {
            var interval = parseInt(document.getElementById('board-refresh-interval').value) * 1000;
            
            // æ¸…é™¤ç¾æœ‰è¨ˆæ™‚å™¨
            if (boardRefreshTimer) {
                clearInterval(boardRefreshTimer);
                boardRefreshTimer = null;
            }
            
            // è¨­å®šæ–°è¨ˆæ™‚å™¨
            if (interval > 0) {
                boardRefreshTimer = setInterval(refreshWorkBoard, interval);
            }
        };
        
        // å…¨è¢å¹•åˆ‡æ›
        window.toggleBoardFullscreen = function() {
            var elem = document.getElementById('view-work-board');
            if (!document.fullscreenElement) {
                if (elem.requestFullscreen) {
                    elem.requestFullscreen();
                } else if (elem.webkitRequestFullscreen) {
                    elem.webkitRequestFullscreen();
                } else if (elem.msRequestFullscreen) {
                    elem.msRequestFullscreen();
                }
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        };
        
        // é–‹å•Ÿé›»è¦–æŠ•æ”¾è¦–çª—
        window.openTVBoard = function() {
            var pendingInbounds = window.pendingInbounds || [];
            var waves = (window._waveData && window._waveData.waves) ? window._waveData.waves : [];
            var activeWaves = waves.filter(function(w) { return w.status === 'picking' || w.status === 'pending'; });
            var transferList = window.transferList || [];
            var pendingTransfers = transferList.filter(function(t) { return t.status !== 'completed'; });
            
            var html = '<!DOCTYPE html><html><head><meta charset="UTF-8">';
            html += '<title>å·¥å–®çœ‹æ¿ - é›»è¦–æŠ•æ”¾</title>';
            html += '<script src="https://cdn.tailwindcss.com"><\/script>';
            html += '<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">';
            html += '<style>body{background:#0f172a;margin:0;padding:20px;font-family:system-ui,-apple-system,sans-serif;}</style>';
            html += '</head><body>';
            
            // æ¨™é¡Œåˆ—
            html += '<div class="flex justify-between items-center mb-6">';
            html += '<h1 class="text-4xl font-bold text-white"><i class="fa-solid fa-clipboard-list mr-4 text-yellow-400"></i>å·¥å–®çœ‹æ¿</h1>';
            html += '<div class="flex items-center gap-4">';
            html += '<span id="tv-time" class="text-2xl text-slate-400"></span>';
            html += '<span class="text-xl text-slate-500">è‡ªå‹•åˆ·æ–°: 30ç§’</span>';
            html += '</div></div>';
            
            // çµ±è¨ˆå¡ç‰‡
            html += '<div class="grid grid-cols-4 gap-6 mb-6">';
            html += '<div class="bg-gradient-to-br from-yellow-600 to-yellow-700 rounded-2xl p-6 text-center">';
            html += '<div class="text-6xl font-bold text-white">' + pendingInbounds.length + '</div>';
            html += '<div class="text-yellow-200 text-2xl mt-2">å¾…å…¥åº«</div></div>';
            html += '<div class="bg-gradient-to-br from-orange-600 to-orange-700 rounded-2xl p-6 text-center">';
            html += '<div class="text-6xl font-bold text-white">' + activeWaves.length + '</div>';
            html += '<div class="text-orange-200 text-2xl mt-2">æ€è²¨ä¸­</div></div>';
            html += '<div class="bg-gradient-to-br from-purple-600 to-purple-700 rounded-2xl p-6 text-center">';
            html += '<div class="text-6xl font-bold text-white">' + pendingTransfers.length + '</div>';
            html += '<div class="text-purple-200 text-2xl mt-2">å¾…èª¿æ’¥</div></div>';
            html += '<div class="bg-gradient-to-br from-emerald-600 to-emerald-700 rounded-2xl p-6 text-center">';
            html += '<div class="text-6xl font-bold text-white">' + (pendingInbounds.length + activeWaves.length + pendingTransfers.length) + '</div>';
            html += '<div class="text-emerald-200 text-2xl mt-2">ç¸½å·¥å–®</div></div>';
            html += '</div>';
            
            // å·¥å–®åˆ—è¡¨
            html += '<div class="grid grid-cols-3 gap-6" style="height:calc(100vh - 280px)">';
            
            // å…¥åº«å·¥å–®
            html += '<div class="bg-slate-900 rounded-2xl border-4 border-yellow-500 flex flex-col overflow-hidden">';
            html += '<div class="bg-yellow-600 px-6 py-4"><span class="text-2xl font-bold text-white"><i class="fa-solid fa-arrow-down mr-3"></i>å¾…å…¥åº«</span></div>';
            html += '<div class="flex-1 overflow-y-auto p-4 space-y-3">';
            if (pendingInbounds.length === 0) {
                html += '<div class="text-center text-slate-500 py-12"><i class="fa-solid fa-check-circle text-6xl mb-4 block text-emerald-500"></i><span class="text-2xl">ç„¡å¾…å…¥åº«å·¥å–®</span></div>';
            } else {
                pendingInbounds.slice(0, 8).forEach(function(order) {
                    html += '<div class="bg-slate-800 rounded-xl p-4 border-l-4 border-yellow-500">';
                    html += '<div class="flex justify-between items-start">';
                    html += '<div class="text-xl font-bold text-white truncate flex-1">' + (order.productName || '-') + '</div>';
                    html += '<div class="text-3xl font-bold text-yellow-400">' + (order.quantity || 0) + ' ä»¶</div>';
                    html += '</div>';
                    html += '<div class="flex justify-between items-center mt-3">';
                    html += '<span class="text-lg text-slate-400">' + (order.spec || '-') + '</span>';
                    html += '<span class="text-xl text-emerald-400 font-bold bg-emerald-900/50 px-3 py-1 rounded">' + (order.locationId || 'å¾…æŒ‡å®š') + '</span>';
                    html += '</div></div>';
                });
            }
            html += '</div></div>';
            
            // æ€è²¨å·¥å–®
            html += '<div class="bg-slate-900 rounded-2xl border-4 border-orange-500 flex flex-col overflow-hidden">';
            html += '<div class="bg-orange-600 px-6 py-4"><span class="text-2xl font-bold text-white"><i class="fa-solid fa-dolly mr-3"></i>æ€è²¨ä¸­</span></div>';
            html += '<div class="flex-1 overflow-y-auto p-4 space-y-3">';
            if (activeWaves.length === 0) {
                html += '<div class="text-center text-slate-500 py-12"><i class="fa-solid fa-check-circle text-6xl mb-4 block text-emerald-500"></i><span class="text-2xl">ç„¡é€²è¡Œä¸­æ€è²¨</span></div>';
            } else {
                activeWaves.slice(0, 8).forEach(function(wave) {
                    var progress = wave.pickedOrders ? Math.round(wave.pickedOrders / wave.totalOrders * 100) : 0;
                    html += '<div class="bg-slate-800 rounded-xl p-4 border-l-4 border-orange-500">';
                    html += '<div class="flex justify-between items-center">';
                    html += '<div class="text-xl font-bold text-white">' + (wave.waveNo || wave.id) + '</div>';
                    html += '<div class="text-lg px-3 py-1 rounded ' + (wave.status === 'picking' ? 'bg-orange-600' : 'bg-slate-600') + ' text-white">' + (wave.status === 'picking' ? 'æ€è²¨ä¸­' : 'å¾…è™•ç†') + '</div>';
                    html += '</div>';
                    html += '<div class="mt-3">';
                    html += '<div class="flex justify-between text-lg mb-2">';
                    html += '<span class="text-slate-400">é€²åº¦</span>';
                    html += '<span class="text-orange-400 font-bold">' + (wave.pickedOrders || 0) + '/' + (wave.totalOrders || 0) + '</span>';
                    html += '</div>';
                    html += '<div class="w-full bg-slate-700 rounded-full h-4">';
                    html += '<div class="bg-orange-500 h-4 rounded-full" style="width:' + progress + '%"></div>';
                    html += '</div></div></div>';
                });
            }
            html += '</div></div>';
            
            // èª¿æ’¥å·¥å–®
            html += '<div class="bg-slate-900 rounded-2xl border-4 border-purple-500 flex flex-col overflow-hidden">';
            html += '<div class="bg-purple-600 px-6 py-4"><span class="text-2xl font-bold text-white"><i class="fa-solid fa-right-left mr-3"></i>èª¿æ’¥/ç§»ä½</span></div>';
            html += '<div class="flex-1 overflow-y-auto p-4 space-y-3">';
            if (pendingTransfers.length === 0) {
                html += '<div class="text-center text-slate-500 py-12"><i class="fa-solid fa-check-circle text-6xl mb-4 block text-emerald-500"></i><span class="text-2xl">ç„¡å¾…è™•ç†èª¿æ’¥</span></div>';
            } else {
                pendingTransfers.slice(0, 8).forEach(function(item) {
                    html += '<div class="bg-slate-800 rounded-xl p-4 border-l-4 border-purple-500">';
                    html += '<div class="text-xl font-bold text-white truncate">' + (item.productName || '-') + '</div>';
                    html += '<div class="flex justify-between items-center mt-3">';
                    html += '<div class="text-lg">';
                    html += '<span class="text-cyan-400">' + (item.fromWarehouse || item.from || '-') + '</span>';
                    html += '<i class="fa-solid fa-arrow-right mx-3 text-slate-500"></i>';
                    html += '<span class="text-emerald-400">' + (item.toWarehouse || item.to || '-') + '</span>';
                    html += '</div>';
                    html += '<div class="text-2xl font-bold text-purple-400">' + (item.quantity || 0) + ' ä»¶</div>';
                    html += '</div></div>';
                });
            }
            html += '</div></div>';
            
            html += '</div>';
            
            // è‡ªå‹•åˆ·æ–°è…³æœ¬
            html += '<script>';
            html += 'function updateTime(){document.getElementById("tv-time").textContent=new Date().toLocaleTimeString("zh-TW");}';
            html += 'updateTime();setInterval(updateTime,1000);';
            html += 'setTimeout(function(){location.reload();},30000);';
            html += '<\/script>';
            
            html += '</body></html>';
            
            var tvWindow = window.open('', 'tvboard', 'width=1920,height=1080');
            tvWindow.document.write(html);
            tvWindow.document.close();
        };
        
        // ========== å“é …é¸æ“‡ Modal åŠŸèƒ½ ==========
        
        // é–‹å•Ÿå“é …é¸æ“‡è¦–çª—
        window.openProductSelectModal = function(mode) {
            document.getElementById('product-select-mode').value = mode;
            document.getElementById('product-select-search').value = '';
            document.getElementById('product-select-category').value = '';
            document.getElementById('modal-product-select').classList.remove('hidden');
            
            // è¼‰å…¥å“é …åˆ—è¡¨
            renderProductSelectList();
            
            // èšç„¦æœå°‹æ¡†
            setTimeout(function() {
                document.getElementById('product-select-search').focus();
            }, 100);
        };
        
        // é—œé–‰å“é …é¸æ“‡è¦–çª—
        window.closeProductSelectModal = function() {
            document.getElementById('modal-product-select').classList.add('hidden');
        };
        
        // æ¸²æŸ“å“é …åˆ—è¡¨
        window.renderProductSelectList = function() {
            var keyword = (document.getElementById('product-select-search').value || '').trim().toLowerCase();
            var category = document.getElementById('product-select-category').value;
            var data = window.productMasterData || [];
            
            // éæ¿¾
            var filtered = data.filter(function(p) {
                var matchKeyword = !keyword || 
                    (p.code || '').toLowerCase().includes(keyword) ||
                    (p.name || '').toLowerCase().includes(keyword) ||
                    (p.spec || '').toLowerCase().includes(keyword);
                var matchCategory = !category || p.category === category;
                return matchKeyword && matchCategory;
            });
            
            // æ›´æ–°çµ±è¨ˆ
            document.getElementById('product-select-count').textContent = filtered.length;
            
            // æ¸²æŸ“åˆ—è¡¨
            var html = '';
            filtered.forEach(function(p) {
                var categoryColor = {
                    'æˆå“': 'bg-blue-600',
                    'åŸæ–™': 'bg-emerald-600',
                    'åŠæˆå“': 'bg-yellow-600',
                    'åŒ…æ': 'bg-purple-600'
                }[p.category] || 'bg-slate-600';
                
                html += '<tr class="hover:bg-slate-700 cursor-pointer" onclick="selectProductFromModal(\'' +
                        (p.code || '').replace(/'/g, "\\'") + '\', \'' +
                        (p.name || '').replace(/'/g, "\\'") + '\', \'' +
                        (p.spec || '').replace(/'/g, "\\'") + '\', ' +
                        (p.palletCapacity || 40) + ', ' +
                        (p.shelfLife || 24) + ')">';
                html += '<td class="p-2 text-cyan-400 font-mono text-xs">' + (p.code || '-') + '</td>';
                html += '<td class="p-2 text-white font-bold">' + (p.name || '') + '</td>';
                html += '<td class="p-2 text-slate-300 text-xs">' + (p.spec || '-') + '</td>';
                html += '<td class="p-2 text-center text-yellow-400 font-bold">' + (p.palletCapacity || 40) + '</td>';
                html += '<td class="p-2 text-center"><span class="px-1.5 py-0.5 rounded text-white text-xs ' + categoryColor + '">' + (p.category || 'æˆå“') + '</span></td>';
                html += '<td class="p-2 text-center"><button class="px-2 py-1 bg-emerald-600 hover:bg-emerald-500 text-white rounded text-xs font-bold"><i class="fa-solid fa-check"></i></button></td>';
                html += '</tr>';
            });
            
            if (filtered.length === 0) {
                html = '<tr><td colspan="6" class="p-8 text-center text-slate-400"><i class="fa-solid fa-box-open text-3xl mb-2 block"></i>ç„¡åŒ¹é…å“é …<br><span class="text-xs">è«‹å…ˆåœ¨å“é …ä¸»æª”ä¸­æ–°å¢å“é …</span></td></tr>';
            }
            
            document.getElementById('product-select-list').innerHTML = html;
        };
        
        // éæ¿¾å“é …åˆ—è¡¨ï¼ˆæœå°‹æ™‚è§¸ç™¼ï¼‰
        window.filterProductSelectList = function() {
            renderProductSelectList();
        };
        
        // å¾ Modal é¸æ“‡å“é …
        window.selectProductFromModal = function(code, name, spec, palletCapacity, shelfLife) {
            var mode = document.getElementById('product-select-mode').value;
            
            if (mode === 'inbound') {
                // æ™ºèƒ½å…¥åº«
                document.getElementById('in-product-code').value = code;
                document.getElementById('in-name').value = name;
                document.getElementById('in-spec').value = spec;
                updateLivePreview();
                updateInboundProgress();
                autoTriggerSmartSuggest();
            } else if (mode === 'container') {
                // è²¨æ«ƒå…¥åº«
                document.getElementById('pre-product-code').value = code;
                document.getElementById('pre-name').value = name;
                document.getElementById('pre-spec').value = spec;
                if (document.getElementById('pre-per-pallet')) {
                    document.getElementById('pre-per-pallet').value = palletCapacity;
                }
                if (document.getElementById('pre-per-pallet-var')) {
                    document.getElementById('pre-per-pallet-var').value = palletCapacity;
                }
            }
            
            // é—œé–‰è¦–çª—
            closeProductSelectModal();
        };

        // ========== æ™ºèƒ½å…¥åº«å»ºè­°ç³»çµ± ==========
        var smartSuggestTimer = null;
        window.autoTriggerSmartSuggest = function() {
            var name = document.getElementById('in-name').value.trim();

            if (smartSuggestTimer) {
                clearTimeout(smartSuggestTimer);
            }

            if (!name) {
                document.getElementById('smart-suggest-panel').classList.add('hidden');
                return;
            }

            smartSuggestTimer = setTimeout(function() {
                calculateSmartSuggest();
            }, 500);
        };

        window.calculateSmartSuggest = function() {
            var targetName = document.getElementById('in-name').value;
            var targetSpec = document.getElementById('in-spec').value || '';
            var targetBatch = document.getElementById('in-batch').value || '';
            var targetExp = document.getElementById('in-exp').value || '';

            if (!targetName) {
                if (arguments.length === 0 || arguments[0] !== 'auto') {
                    alert('è«‹å…ˆè¼¸å…¥å“å');
                }
                return;
            }

            var inventory = window.currentInventory ? window.currentInventory() : [];

            var lanes = {};
            var allZones = ['I-A', 'I-B', 'J-C', 'J-D', 'K-E', 'K-F', 'K-G', 'K-H'];

            allZones.forEach(function(zone) {
                var laneCount = zone.startsWith('K-') ? 22 : 8;
                for (var i = 1; i <= laneCount; i++) {
                    var laneKey = zone + '-' + (i < 10 ? '0' + i : i);
                    lanes[laneKey] = {
                        zone: zone,
                        row: i,
                        laneKey: laneKey,
                        totalQty: 0,
                        palletCount: 0,
                        capacity: 20,
                        items: [],
                        hasSameName: false,
                        hasSameSpec: false,
                        hasSameBatch: false,
                        hasSameExp: false,
                        expDates: []
                    };
                }
            });

            inventory.forEach(function(item) {
                if (!item.locationId || item.locationId.startsWith('V-') || item.locationId.startsWith('O-')) return;

                var parsed = parseLocationId(item.locationId);
                if (!parsed) return;

                var laneKey = parsed.laneKey;
                if (!lanes[laneKey]) return;

                lanes[laneKey].totalQty += (item.quantity || 0);
                lanes[laneKey].palletCount++;
                lanes[laneKey].items.push(item);

                if (item.productName === targetName) {
                    lanes[laneKey].hasSameName = true;
                    if ((item.spec || '') === targetSpec) {
                        lanes[laneKey].hasSameSpec = true;
                    }
                    if (targetBatch && (item.batchNo || '') === targetBatch) {
                        lanes[laneKey].hasSameBatch = true;
                    }
                    var itemExp = item.expDate || item.expiryDate || '';
                    if (itemExp) lanes[laneKey].expDates.push(itemExp);
                    if (targetExp && itemExp === targetExp) {
                        lanes[laneKey].hasSameExp = true;
                    }
                }
            });

            var suggestions = [];

            Object.keys(lanes).forEach(function(laneKey) {
                var lane = lanes[laneKey];
                var available = lane.capacity - lane.palletCount;

                if (available <= 0) return; // å·²æ»¿ï¼Œè·³é

                var score = 0;
                var reasons = [];
                var stars = 0;

                if (lane.hasSameBatch && lane.hasSameSpec && lane.hasSameName) {
                    score += 1000;
                    stars = 3;
                    reasons.push('åŒå“+åŒè¦+åŒæ‰¹è™Ÿ');

                    if (lane.hasSameExp) {
                        score += 100;
                        reasons.push('åŒæ•ˆæœŸ');
                    }
                } else if (lane.hasSameSpec && lane.hasSameName) {
                    score += 500;
                    stars = 2;
                    reasons.push('åŒå“+åŒè¦æ ¼');

                    if (lane.hasSameExp) {
                        score += 100;
                        reasons.push('åŒæ•ˆæœŸ');
                    }
                } else if (lane.hasSameName) {
                    score += 200;
                    stars = 1;
                    reasons.push('åŒå“å');
                } else if (lane.hasSameSpec) {
                    score += 150;
                    stars = 1;
                    reasons.push('åŒè¦æ ¼');
                }

                if (lane.hasSameName) {
                    score += lane.palletCount * 10;
                    if (lane.palletCount >= 3) {
                        reasons.push('é›†ä¸­åº¦é«˜(' + lane.palletCount + 'æ¿)');
                    }
                }

                if (available <= 5 && lane.hasSameName) {
                    score += 50;
                    reasons.push('å³å°‡å¡«æ»¿');
                }

                if (lane.palletCount === 0) {
                    score += 10;
                    stars = 0;
                    reasons.push('ç©ºå··é“');
                }

                if (score > 0 || lane.palletCount === 0) {
                    var levelUsage = { '3F': 0, '2F': 0, '1F': 0 };
                    var levelCapacity = { '3F': 8, '2F': 5, '1F': 16 }; // æ›´æ–°å®¹é‡

                    lane.items.forEach(function(item) {
                        var parsed = parseLocationId(item.locationId);
                        if (parsed && parsed.level && levelUsage[parsed.level] !== undefined) {
                            levelUsage[parsed.level]++;
                        }
                    });

                    var emptyLevel = null;
                    var emptyCount = 0;

                    ['3F', '2F', '1F'].forEach(function(lvl) {
                        if (!emptyLevel && levelUsage[lvl] < levelCapacity[lvl]) {
                            emptyLevel = lvl;
                            emptyCount = levelCapacity[lvl] - levelUsage[lvl];
                        }
                    });

                    if (emptyLevel) {
                        var fullLocationId = laneKey + '-' + emptyLevel;

                        suggestions.push({
                            laneKey: laneKey,
                            fullLocationId: fullLocationId,
                            level: emptyLevel,
                            zone: lane.zone,
                            row: lane.row,
                            score: score,
                            stars: stars,
                            reasons: reasons,
                            available: available,
                            levelAvailable: emptyCount,
                            palletCount: lane.palletCount,
                            totalQty: lane.totalQty,
                            expDates: lane.expDates
                        });
                    }
                }
            });

            suggestions.sort(function(a, b) {
                return b.score - a.score;
            });

            suggestions = suggestions.slice(0, 3);

            renderSmartSuggestions(suggestions, targetName, targetSpec);
        };

        function renderSmartSuggestions(suggestions, targetName, targetSpec) {
            var panel = document.getElementById('smart-suggest-panel');
            var list = document.getElementById('smart-suggest-list');

            if (suggestions.length === 0) {
                list.innerHTML = '<div class="text-slate-400 text-sm text-center py-4">ç„¡ç¬¦åˆæ¢ä»¶çš„å»ºè­°å„²ä½</div>';
                panel.classList.remove('hidden');
                return;
            }

            var html = '';

            html += '<div class="flex gap-2">';
            suggestions.forEach(function(s, idx) {
                var starsHtml = '';
                for (var i = 0; i < s.stars; i++) {
                    starsHtml += '<i class="fa-solid fa-star text-yellow-400 text-xs"></i>';
                }
                for (var i = s.stars; i < 3; i++) {
                    starsHtml += '<i class="fa-regular fa-star text-slate-600 text-xs"></i>';
                }

                var bgClass = idx === 0 ? 'bg-yellow-900/50 border-yellow-500' : 'bg-slate-800 border-slate-600';
                var rankLabel = idx === 0 ? 'ğŸ¥‡' : (idx === 1 ? 'ğŸ¥ˆ' : 'ğŸ¥‰');

                html += '<div class="' + bgClass + ' border rounded-lg p-2 cursor-pointer hover:bg-slate-700 transition flex-1 min-w-0" onclick="selectSmartSuggestDirect(\'' + s.fullLocationId + '\')">';
                html += '<div class="flex items-center gap-1 mb-1">';
                html += '<span>' + rankLabel + '</span>';
                html += '<span class="text-white font-bold font-mono">' + s.fullLocationId + '</span>';
                html += '<span>' + starsHtml + '</span>';
                html += '</div>';
                html += '<div class="text-xs text-emerald-400 truncate">' + s.reasons[0] + '</div>';
                html += '<div class="text-xs text-slate-500">' + s.level + 'å±¤ç©º' + s.levelAvailable + 'ä½</div>';
                html += '</div>';
            });
            html += '</div>';

            list.innerHTML = html;
            panel.classList.remove('hidden');
        }

        window.selectSmartSuggestDirect = function(fullLocationId) {
            document.getElementById('in-loc').value = fullLocationId;
            document.getElementById('smart-suggest-panel').classList.add('hidden');
        };

        window.selectSmartSuggest = function(laneKey) {
            var parts = laneKey.split('-');
            var zone = parts[0] + '-' + parts[1];
            var row = parseInt(parts[2]);

            openLevelSelector(zone, row);

            document.getElementById('smart-suggest-panel').classList.add('hidden');
        };

        window.hideSmartSuggest = function() {
            document.getElementById('smart-suggest-panel').classList.add('hidden');
        };

        // ========== æ€è²¨ç³»çµ± ==========
        window.pickingSelectedProduct = { fg: null, rm: null };
        window.pickingPlan = { fg: [], rm: [] };
        window.rmCheckedItems = [];

        window.searchProductForPicking = function(mode) {
            var searchInput = document.getElementById(mode + '-pick-name').value.toLowerCase();
            var suggestionsDiv = document.getElementById(mode + '-product-suggestions');

            if (searchInput.length < 1) {
                suggestionsDiv.innerHTML = '';
                return;
            }

            var selectedCompany = mode === 'rm' ? (window.rmCompany || 'å´‡æ–‡') : (window.waveCompany || 'å´‡æ–‡');

            var products = {};
            window.currentPallets().forEach(function(p) {
                if (p.company && p.company !== selectedCompany) return;

                var key = p.productName + '|' + (p.spec || '');
                if (p.productName.toLowerCase().indexOf(searchInput) > -1) {
                    if (!products[key]) {
                        products[key] = { name: p.productName, spec: p.spec || '', totalQty: 0, palletCount: 0 };
                    }
                    products[key].totalQty += p.quantity;
                    products[key].palletCount++;
                }
            });

            var html = '';
            Object.values(products).forEach(function(prod) {
                html += '<div class="p-2 bg-slate-800 hover:bg-slate-700 cursor-pointer rounded mb-1 text-sm" onclick="selectProductForPicking(\'' + mode + '\', \'' + prod.name + '\', \'' + prod.spec + '\')">';
                html += '<div class="text-white font-bold">' + prod.name + '</div>';
                html += '<div class="text-slate-400 text-xs">' + prod.spec + ' | åº«å­˜: ' + prod.totalQty + 'ä»¶ / ' + prod.palletCount + 'æ¿</div>';
                html += '</div>';
            });

            suggestionsDiv.innerHTML = html || '<div class="text-slate-500 text-sm p-2">ç„¡ç¬¦åˆé …ç›®</div>';
        };

        window.selectProductForPicking = function(mode, name, spec) {
            document.getElementById(mode + '-pick-name').value = name;
            document.getElementById(mode + '-pick-spec').value = spec;
            document.getElementById(mode + '-product-suggestions').innerHTML = '';
            window.pickingSelectedProduct[mode] = { name: name, spec: spec };
        };

        window.calculatePickingPlan = function(mode) {
            var product = window.pickingSelectedProduct[mode];
            var requiredQty = parseInt(document.getElementById(mode + '-pick-qty').value) || 0;

            if (!product || !product.name) {
                alert('è«‹å…ˆé¸æ“‡å“å');
                return;
            }
            if (requiredQty <= 0) {
                alert('è«‹è¼¸å…¥éœ€æ±‚æ•¸é‡');
                return;
            }

            var selectedCompany = mode === 'rm' ? (window.rmCompany || 'å´‡æ–‡') : (window.waveCompany || 'å´‡æ–‡');

            var candidates = [];
            window.currentPallets().forEach(function(p) {
                if (p.company && p.company !== selectedCompany) return;

                if (p.productName === product.name && (p.spec || '') === product.spec && p.quantity > 0) {
                    var parsed = parseLocationId(p.locationId);
                    var lane = parsed ? parsed.laneKey : '';
                    var sameProductInLane = window.currentPallets().filter(function(pp) {
                        var ppParsed = parseLocationId(pp.locationId);
                        return pp.productName === product.name &&
                               (pp.spec || '') === product.spec &&
                               ppParsed && ppParsed.laneKey === lane;
                    }).length;

                    var floor = parsed ? parseInt(parsed.level) || 1 : 1;

                    candidates.push({
                        palletId: p.palletId,
                        locationId: p.locationId,
                        quantity: p.quantity,
                        totalWeight: p.totalWeight || 0,
                        expDate: p.expDate || p.expiryDate || '9999-12-31',
                        inboundDate: p.inboundDate ? (p.inboundDate.toDate ? p.inboundDate.toDate() : new Date(p.inboundDate)) : new Date(),
                        isIsolated: sameProductInLane === 1,
                        floor: floor,
                        lane: lane,
                        batchNo: p.batchNo || ''
                    });
                }
            });

            if (candidates.length === 0) {
                alert('åº«å­˜ä¸è¶³æˆ–ç„¡æ­¤å“é …');
                return;
            }

            var totalStock = candidates.reduce(function(sum, c) { return sum + c.quantity; }, 0);
            if (totalStock < requiredQty) {
                alert('åº«å­˜ä¸è¶³ï¼éœ€æ±‚: ' + requiredQty + ' ä»¶ï¼Œåº«å­˜: ' + totalStock + ' ä»¶');
                return;
            }

            candidates.sort(function(a, b) {
                if (a.expDate !== b.expDate) return a.expDate < b.expDate ? -1 : 1;
                if (a.isIsolated !== b.isIsolated) return a.isIsolated ? -1 : 1;
                if (a.floor !== b.floor) return a.floor - b.floor;
                var aDiff = Math.abs(a.quantity - requiredQty);
                var bDiff = Math.abs(b.quantity - requiredQty);
                return aDiff - bDiff;
            });

            var plan = [];
            var remaining = requiredQty;

            for (var i = 0; i < candidates.length && remaining > 0; i++) {
                var c = candidates[i];
                if (c.quantity === remaining) {
                    plan.push({
                        palletId: c.palletId,
                        locationId: c.locationId,
                        quantity: c.quantity,
                        totalWeight: c.totalWeight,
                        pickQty: c.quantity,
                        pickWeight: c.totalWeight,
                        expDate: c.expDate,
                        batchNo: c.batchNo,
                        isIsolated: c.isIsolated,
                        pickType: 'full',
                        remaining: 0,
                        remainingWeight: 0
                    });
                    remaining = 0;
                    candidates.splice(i, 1);
                    break;
                }
            }

            for (var i = 0; i < candidates.length && remaining > 0; i++) {
                var c = candidates[i];
                var pickQty = Math.min(c.quantity, remaining);
                var pickType = pickQty === c.quantity ? 'full' : 'split';
                var weightRatio = c.quantity > 0 ? (pickQty / c.quantity) : 0;
                var pickWeight = c.totalWeight > 0 ? Math.round(c.totalWeight * weightRatio * 10) / 10 : 0;

                plan.push({
                    palletId: c.palletId,
                    locationId: c.locationId,
                    quantity: c.quantity,
                    totalWeight: c.totalWeight,
                    pickQty: pickQty,
                    pickWeight: pickWeight,
                    expDate: c.expDate,
                    batchNo: c.batchNo,
                    isIsolated: c.isIsolated,
                    pickType: pickType,
                    remaining: c.quantity - pickQty,
                    remainingWeight: c.totalWeight > 0 ? Math.round((c.totalWeight - pickWeight) * 10) / 10 : 0
                });

                remaining -= pickQty;
            }

            window.pickingPlan[mode] = plan;

            renderPickingResult(mode, plan, requiredQty);
        };

        function renderPickingResult(mode, plan, requiredQty) {
            var resultDiv = document.getElementById(mode + '-picking-result');
            var summaryDiv = document.getElementById(mode + '-picking-summary');

            var html = '<table class="w-full text-sm">';
            html += '<thead><tr class="text-slate-400 text-xs border-b border-slate-700">';
            if (mode === 'rm') html += '<th class="p-2 text-left">å‹¾é¸</th>';
            html += '<th class="p-2 text-left">é †åº</th>';
            html += '<th class="p-2 text-left">å„²ä½</th>';
            html += '<th class="p-2 text-right">åº«å­˜</th>';
            html += '<th class="p-2 text-right">å–ç”¨</th>';
            html += '<th class="p-2 text-center">æ–¹å¼</th>';
            html += '<th class="p-2 text-left">æ•ˆæœŸ</th>';
            html += '<th class="p-2 text-left">æ‰¹è™Ÿ</th>';
            html += '<th class="p-2 text-left">ç‹€æ…‹</th>';
            html += '</tr></thead><tbody>';

            var fullCount = 0, splitCount = 0, clearCount = 0, totalPick = 0, totalWeight = 0;

            plan.forEach(function(item, idx) {
                var typeLabel = item.pickType === 'full' ?
                    '<span class="badge badge-green">æ•´æ¿</span>' :
                    '<span class="badge badge-yellow">æ‹†æ¿</span>';
                var isolatedLabel = item.isIsolated ? '<span class="badge badge-red ml-1">å­¤ç«‹</span>' : '';

                if (item.pickType === 'full') fullCount++;
                else splitCount++;
                if (item.remaining === 0) clearCount++;
                totalPick += item.pickQty;
                totalWeight += item.pickWeight || 0;

                var stockDisplay = item.quantity + '';
                if (item.totalWeight > 0) {
                    stockDisplay += '<span class="text-amber-400 text-xs ml-1">/' + item.totalWeight + 'kg</span>';
                }

                var pickDisplay = item.pickQty + '';
                if (item.pickWeight > 0) {
                    pickDisplay += '<span class="text-amber-400 text-xs ml-1">/' + item.pickWeight + 'kg</span>';
                }

                html += '<tr class="border-b border-slate-800 hover:bg-slate-800">';
                if (mode === 'rm') {
                    html += '<td class="p-2"><input type="checkbox" class="rm-pick-checkbox w-5 h-5" data-idx="' + idx + '" data-qty="' + item.pickQty + '" data-weight="' + (item.pickWeight || 0) + '" onchange="updateRmSelection()" checked></td>';
                }
                html += '<td class="p-2 text-white font-bold">' + (idx + 1) + '</td>';
                html += '<td class="p-2 text-blue-400 font-mono font-bold">' + item.locationId + '</td>';
                html += '<td class="p-2 text-right text-slate-400">' + stockDisplay + '</td>';
                html += '<td class="p-2 text-right text-yellow-400 font-bold text-lg">' + pickDisplay + '</td>';
                html += '<td class="p-2 text-center">' + typeLabel + '</td>';
                html += '<td class="p-2 text-slate-300">' + (item.expDate || '-') + '</td>';
                html += '<td class="p-2 text-slate-400 text-xs">' + (item.batchNo || '-') + '</td>';
                html += '<td class="p-2">' + isolatedLabel;
                if (item.remaining > 0) {
                    var remainDisplay = 'é¤˜' + item.remaining;
                    if (item.remainingWeight > 0) {
                        remainDisplay += '/' + item.remainingWeight + 'kg';
                    }
                    html += '<span class="text-xs text-slate-500 ml-1">' + remainDisplay + '</span>';
                }
                html += '</td>';
                html += '</tr>';
            });

            html += '</tbody></table>';
            resultDiv.innerHTML = html;

            summaryDiv.classList.remove('hidden');
            var totalDisplay = totalPick + ' ä»¶';
            if (totalWeight > 0) {
                totalDisplay += ' / ' + Math.round(totalWeight * 10) / 10 + ' kg';
            }
            document.getElementById(mode + '-total-pick') && (document.getElementById(mode + '-total-pick').innerText = totalDisplay);
            document.getElementById(mode + '-full-pallet') && (document.getElementById(mode + '-full-pallet').innerText = fullCount + ' æ¿');
            document.getElementById(mode + '-split-pallet') && (document.getElementById(mode + '-split-pallet').innerText = splitCount + ' æ¿');
            document.getElementById(mode + '-clear-slots') && (document.getElementById(mode + '-clear-slots').innerText = clearCount + ' å€‹');

            if (mode === 'rm') {
                document.getElementById('rm-selected-qty').innerText = totalDisplay;
                document.getElementById('rm-required-qty').innerText = requiredQty + ' ä»¶';
            }
        }

        window.updateRmSelection = function() {
            var checkboxes = document.querySelectorAll('.rm-pick-checkbox');
            var total = 0;
            var totalWeight = 0;
            checkboxes.forEach(function(cb) {
                if (cb.checked) {
                    total += parseInt(cb.dataset.qty) || 0;
                    totalWeight += parseFloat(cb.dataset.weight) || 0;
                }
            });
            var display = total + ' ä»¶';
            if (totalWeight > 0) {
                display += ' / ' + Math.round(totalWeight * 10) / 10 + ' kg';
            }
            document.getElementById('rm-selected-qty').innerText = display;
        };

        window.confirmRmPicking = function() {
            var checkboxes = document.querySelectorAll('.rm-pick-checkbox:checked');
            if (checkboxes.length === 0) {
                alert('è«‹è‡³å°‘å‹¾é¸ä¸€å€‹å„²ä½');
                return;
            }

            var plan = window.pickingPlan.rm;
            var product = window.pickingSelectedProduct.rm;

            var html = '';
            var totalQty = 0;

            checkboxes.forEach(function(cb, index) {
                var idx = parseInt(cb.dataset.idx);
                var item = plan[idx];
                totalQty += item.pickQty;

                html += '<div class="bg-slate-800 rounded-lg p-3 border border-slate-700" data-idx="' + idx + '">';
                html += '<div class="flex justify-between items-start mb-3">';
                html += '<div>';
                html += '<div class="text-white font-bold">' + (product ? product.name : item.productName) + '</div>';
                html += '<div class="text-slate-400 text-sm">' + (product ? product.spec : (item.spec || '-')) + '</div>';
                html += '</div>';
                html += '<div class="text-right">';
                html += '<div class="text-slate-400 text-xs">å„²ä½</div>';
                html += '<div class="text-cyan-400 font-mono font-bold">' + item.locationId + '</div>';
                html += '</div>';
                html += '</div>';

                html += '<div class="grid grid-cols-4 gap-2 mb-3">';
                html += '<div class="bg-slate-900 rounded p-2 text-center">';
                html += '<div class="text-slate-500 text-xs">æ£§æ¿åº«å­˜</div>';
                html += '<div class="text-white font-bold">' + item.quantity + ' ä»¶</div>';
                if (item.totalWeight > 0) {
                    html += '<div class="text-amber-400 text-xs">' + item.totalWeight + ' kg</div>';
                }
                html += '</div>';
                html += '<div class="bg-slate-900 rounded p-2 text-center">';
                html += '<div class="text-slate-500 text-xs">æ‰¹è™Ÿ</div>';
                html += '<div class="text-white text-sm">' + (item.batchNo || '-') + '</div>';
                html += '</div>';
                html += '<div class="bg-slate-900 rounded p-2 text-center">';
                html += '<div class="text-slate-500 text-xs">æ•ˆæœŸ</div>';
                html += '<div class="text-white text-sm">' + (item.expDate || '-') + '</div>';
                html += '</div>';
                html += '<div class="bg-slate-900 rounded p-2 text-center">';
                html += '<div class="text-slate-500 text-xs">æ¯ä»¶å‡é‡</div>';
                var avgWeight = (item.totalWeight > 0 && item.quantity > 0) ? Math.round(item.totalWeight / item.quantity * 10) / 10 : 0;
                html += '<div class="text-slate-400 text-sm">' + (avgWeight > 0 ? avgWeight + ' kg' : '-') + '</div>';
                html += '</div>';
                html += '</div>';

                html += '<div class="bg-cyan-900/30 border border-cyan-600/50 rounded-lg p-3">';
                html += '<div class="text-cyan-400 text-sm font-bold mb-2"><i class="fa-solid fa-hand-pointer mr-1"></i>å¯¦éš›é ˜ç”¨';
                if (item.totalWeight > 0) {
                    html += ' <span class="text-amber-400 font-normal text-xs">ï¼ˆä¸å®šé‡åŸæ–™å¯å¡«é‡é‡ï¼‰</span>';
                }
                html += '</div>';

                html += '<div class="flex flex-wrap items-center gap-3">';

                html += '<label class="flex items-center gap-2 cursor-pointer">';
                html += '<input type="radio" name="pick-type-' + idx + '" value="full" class="rm-pick-type" data-idx="' + idx + '" data-qty="' + item.quantity + '" data-weight="' + item.totalWeight + '" ' + (item.pickType === 'full' ? 'checked' : '') + ' onchange="updateRmConfirmQty(' + idx + ', \'full\')">';
                html += '<span class="text-white">æ•´æ¿</span>';
                html += '</label>';

                html += '<label class="flex items-center gap-2 cursor-pointer">';
                html += '<input type="radio" name="pick-type-' + idx + '" value="partial" class="rm-pick-type" data-idx="' + idx + '" ' + (item.pickType !== 'full' ? 'checked' : '') + ' onchange="updateRmConfirmQty(' + idx + ', \'partial\')">';
                html += '<span class="text-white">éƒ¨åˆ†é ˜ç”¨</span>';
                html += '</label>';

                html += '<span class="text-slate-600">|</span>';

                html += '<div class="flex items-center gap-1">';
                html += '<input type="number" id="rm-partial-qty-' + idx + '" class="scan-input w-20 text-center font-bold" value="' + item.pickQty + '" min="1" max="' + item.quantity + '" ' + (item.pickType === 'full' ? 'disabled' : '') + ' onchange="updateRmConfirmFromQty(' + idx + ')">';
                html += '<span class="text-slate-400 text-sm">ä»¶</span>';
                html += '</div>';

                if (item.totalWeight > 0) {
                    html += '<span class="text-slate-500">æˆ–</span>';
                    html += '<div class="flex items-center gap-1">';
                    html += '<input type="number" id="rm-partial-weight-' + idx + '" class="scan-input w-24 text-center font-bold border-amber-600/50" value="' + (item.pickWeight || 0) + '" min="0.1" max="' + item.totalWeight + '" step="0.1" ' + (item.pickType === 'full' ? 'disabled' : '') + ' onchange="updateRmConfirmFromWeight(' + idx + ')">';
                    html += '<span class="text-amber-400 text-sm">kg</span>';
                    html += '</div>';
                }

                html += '</div>';

                html += '<div class="mt-2 text-sm" id="rm-remaining-hint-' + idx + '">';
                if (item.pickType === 'full') {
                    html += '<span class="text-green-400"><i class="fa-solid fa-check-circle mr-1"></i>æ•´æ¿å‡ºåº«ï¼Œå„²ä½æ¸…ç©º</span>';
                } else {
                    var remainHint = 'å‰©é¤˜ ' + item.remaining + ' ä»¶';
                    if (item.totalWeight > 0 && item.remainingWeight > 0) {
                        remainHint += ' / ' + item.remainingWeight + ' kg';
                    }
                    html += '<span class="text-yellow-400"><i class="fa-solid fa-info-circle mr-1"></i>' + remainHint + ' ä¿ç•™åœ¨åŸå„²ä½</span>';
                }
                html += '</div>';

                html += '</div>';
                html += '</div>';
            });

            document.getElementById('rm-confirm-list').innerHTML = html;
            document.getElementById('rm-confirm-total').innerText = totalQty + ' ä»¶';

            var dept = document.getElementById('rm-pick-dept').value || '';
            document.getElementById('rm-confirm-purpose').value = dept;

            document.getElementById('modal-rm-confirm').classList.remove('hidden');
        };

        window.closeRmConfirmModal = function() {
            document.getElementById('modal-rm-confirm').classList.add('hidden');
        };

        window.updateRmConfirmFromQty = function(idx) {
            var plan = window.pickingPlan.rm;
            var item = plan[idx];
            var qtyInput = document.getElementById('rm-partial-qty-' + idx);
            var weightInput = document.getElementById('rm-partial-weight-' + idx);
            var qty = parseInt(qtyInput.value) || 0;

            if (weightInput && item.totalWeight > 0 && item.quantity > 0) {
                var avgWeight = item.totalWeight / item.quantity;
                weightInput.value = Math.round(qty * avgWeight * 10) / 10;
            }

            updateRmConfirmHint(idx);
            updateRmConfirmTotal();
        };

        window.updateRmConfirmFromWeight = function(idx) {
            var plan = window.pickingPlan.rm;
            var item = plan[idx];
            var qtyInput = document.getElementById('rm-partial-qty-' + idx);
            var weightInput = document.getElementById('rm-partial-weight-' + idx);
            var weight = parseFloat(weightInput.value) || 0;

            if (item.totalWeight > 0 && item.quantity > 0) {
                var avgWeight = item.totalWeight / item.quantity;
                var estimatedQty = Math.round(weight / avgWeight);
                qtyInput.value = Math.min(estimatedQty, item.quantity);
            }

            updateRmConfirmHint(idx);
            updateRmConfirmTotal();
        };

        window.updateRmConfirmHint = function(idx) {
            var plan = window.pickingPlan.rm;
            var item = plan[idx];
            var hintDiv = document.getElementById('rm-remaining-hint-' + idx);
            var qtyInput = document.getElementById('rm-partial-qty-' + idx);
            var weightInput = document.getElementById('rm-partial-weight-' + idx);

            var pickQty = parseInt(qtyInput.value) || 0;
            var remainQty = item.quantity - pickQty;

            var hint = 'å‰©é¤˜ ' + remainQty + ' ä»¶';
            if (item.totalWeight > 0 && weightInput) {
                var pickWeight = parseFloat(weightInput.value) || 0;
                var remainWeight = Math.round((item.totalWeight - pickWeight) * 10) / 10;
                hint += ' / ' + remainWeight + ' kg';
            }

            if (remainQty <= 0) {
                hintDiv.innerHTML = '<span class="text-green-400"><i class="fa-solid fa-check-circle mr-1"></i>å…¨éƒ¨é ˜ç”¨ï¼Œå„²ä½æ¸…ç©º</span>';
            } else {
                hintDiv.innerHTML = '<span class="text-yellow-400"><i class="fa-solid fa-info-circle mr-1"></i>' + hint + ' ä¿ç•™åœ¨åŸå„²ä½</span>';
            }
        };

        window.updateRmConfirmQty = function(idx, type) {
            var qtyInput = document.getElementById('rm-partial-qty-' + idx);
            var weightInput = document.getElementById('rm-partial-weight-' + idx);
            var hintDiv = document.getElementById('rm-remaining-hint-' + idx);
            var plan = window.pickingPlan.rm;
            var item = plan[idx];

            if (type === 'full') {
                qtyInput.disabled = true;
                qtyInput.value = item.quantity;
                if (weightInput) {
                    weightInput.disabled = true;
                    weightInput.value = item.totalWeight;
                }
                hintDiv.innerHTML = '<span class="text-green-400"><i class="fa-solid fa-check-circle mr-1"></i>æ•´æ¿å‡ºåº«ï¼Œå„²ä½æ¸…ç©º</span>';
            } else {
                qtyInput.disabled = false;
                if (weightInput) {
                    weightInput.disabled = false;
                }
                qtyInput.focus();
                updateRmConfirmHint(idx);
            }

            updateRmConfirmTotal();
        };

        window.updateRmConfirmTotal = function() {
            var total = 0;
            var totalWeight = 0;
            var plan = window.pickingPlan.rm;

            document.querySelectorAll('.rm-pick-type:checked').forEach(function(radio) {
                var idx = parseInt(radio.dataset.idx);
                if (radio.value === 'full') {
                    total += plan[idx].quantity;
                } else {
                    var qtyInput = document.getElementById('rm-partial-qty-' + idx);
                    total += parseInt(qtyInput.value) || 0;
                }

                var qtyInput = document.getElementById('rm-partial-qty-' + idx);
                var hintDiv = document.getElementById('rm-remaining-hint-' + idx);
                var item = plan[idx];

                if (radio.value === 'full') {
                    hintDiv.innerHTML = '<span class="text-green-400"><i class="fa-solid fa-check-circle mr-1"></i>æ•´æ¿å‡ºåº«ï¼Œå„²ä½æ¸…ç©º</span>';
                } else {
                    var remaining = item.quantity - (parseInt(qtyInput.value) || 0);
                    if (remaining < 0) remaining = 0;
                    var remainHint = 'å‰©é¤˜ ' + remaining + ' ä»¶';
                    var weightInput = document.getElementById('rm-partial-weight-' + idx);
                    if (weightInput && item.totalWeight > 0) {
                        var remainWeight = Math.round((item.totalWeight - (parseFloat(weightInput.value) || 0)) * 10) / 10;
                        remainHint += ' / ' + remainWeight + ' kg';
                    }
                    hintDiv.innerHTML = '<span class="text-yellow-400"><i class="fa-solid fa-info-circle mr-1"></i>' + remainHint + ' ä¿ç•™åœ¨åŸå„²ä½</span>';
                }

                var weightInput = document.getElementById('rm-partial-weight-' + idx);
                if (weightInput) {
                    if (radio.value === 'full') {
                        totalWeight += plan[idx].totalWeight || 0;
                    } else {
                        totalWeight += parseFloat(weightInput.value) || 0;
                    }
                }
            });

            var totalDisplay = total + ' ä»¶';
            if (totalWeight > 0) {
                totalDisplay += ' / ' + Math.round(totalWeight * 10) / 10 + ' kg';
            }
            document.getElementById('rm-confirm-total').innerText = totalDisplay;
        };

        window.executeRmPicking = async function() {
            var user = document.getElementById('rm-confirm-user').value.trim();
            var purpose = document.getElementById('rm-confirm-purpose').value.trim();

            if (!user) {
                alert('è«‹è¼¸å…¥é ˜ç”¨äºº');
                document.getElementById('rm-confirm-user').focus();
                return;
            }

            var plan = window.pickingPlan.rm;
            var product = window.pickingSelectedProduct.rm;
            var pickItems = [];

            document.querySelectorAll('.rm-pick-type:checked').forEach(function(radio) {
                var idx = parseInt(radio.dataset.idx);
                var item = plan[idx];
                var actualQty, actualWeight = 0;

                if (radio.value === 'full') {
                    actualQty = item.quantity;
                    actualWeight = item.totalWeight || 0;
                } else {
                    actualQty = parseInt(document.getElementById('rm-partial-qty-' + idx).value) || 0;
                    var weightInput = document.getElementById('rm-partial-weight-' + idx);
                    if (weightInput) {
                        actualWeight = parseFloat(weightInput.value) || 0;
                    }
                }

                if (actualQty > 0 && actualQty <= item.quantity) {
                    pickItems.push({
                        palletId: item.palletId,
                        locationId: item.locationId,
                        originalQty: item.quantity,
                        originalWeight: item.totalWeight || 0,
                        pickQty: actualQty,
                        pickWeight: actualWeight,
                        remaining: item.quantity - actualQty,
                        remainingWeight: (item.totalWeight || 0) - actualWeight,
                        batchNo: item.batchNo,
                        expDate: item.expDate,
                        pickType: actualQty === item.quantity ? 'full' : 'partial'
                    });
                }
            });

            if (pickItems.length === 0) {
                alert('æ²’æœ‰æœ‰æ•ˆçš„é ˜ç”¨é …ç›®');
                return;
            }

            var totalPick = pickItems.reduce(function(sum, p) { return sum + p.pickQty; }, 0);
            var totalWeight = pickItems.reduce(function(sum, p) { return sum + (p.pickWeight || 0); }, 0);

            var confirmMsg = 'ç¢ºèªé ˜ç”¨ ' + totalPick + ' ä»¶';
            if (totalWeight > 0) {
                confirmMsg += ' / ' + Math.round(totalWeight * 10) / 10 + ' kg';
            }
            confirmMsg += 'ï¼Ÿ\n\né ˜ç”¨äººï¼š' + user + '\nç”¨é€”ï¼š' + (purpose || '-');

            if (!confirm(confirmMsg)) return;

            try {
                var batch = window.writeBatch(window.db);
                var logPromises = [];

                pickItems.forEach(function(item) {
                    var ref = window.doc(window.db, 'pallets', item.palletId);

                    if (item.pickType === 'full') {
                        batch.delete(ref);
                    } else {
                        var updateData = { quantity: item.remaining };
                        if (item.originalWeight > 0) {
                            updateData.totalWeight = Math.round(item.remainingWeight * 10) / 10;
                        }
                        batch.update(ref, updateData);
                    }

                    var noteText = 'åŸæ–™é ˜ç”¨ - é ˜ç”¨äººï¼š' + user;
                    if (purpose) noteText += 'ï¼Œç”¨é€”ï¼š' + purpose;
                    if (item.pickWeight > 0) noteText += ' (' + item.pickWeight + 'kg)';

                    logPromises.push(window.logInventoryChange({
                        type: 'picking',
                        productName: product ? product.name : '',
                        spec: product ? product.spec : '',
                        quantity: item.pickQty,
                        weight: item.pickWeight || 0,
                        quantityChange: -item.pickQty,
                        weightChange: -(item.pickWeight || 0),
                        locationId: item.locationId,
                        batchNo: item.batchNo || '',
                        palletId: item.palletId,
                        expDate: item.expDate,
                        note: noteText
                    }));
                });

                await batch.commit();
                await Promise.all(logPromises);

                closeRmConfirmModal();

                var resultMsg = 'âœ… é ˜æ–™å‡ºåº«å®Œæˆï¼\n\né ˜ç”¨äººï¼š' + user + '\nç¸½è¨ˆï¼š' + totalPick + ' ä»¶';
                if (totalWeight > 0) {
                    resultMsg += ' / ' + Math.round(totalWeight * 10) / 10 + ' kg';
                }
                alert(resultMsg);

                window.pickingPlan.rm = [];
                var resultHtml = '<div class="text-center text-slate-500 py-20"><i class="fa-solid fa-check-circle text-4xl mb-4 text-green-500"></i><div class="text-lg mb-2">é ˜æ–™å®Œæˆ</div><div class="text-sm">é ˜ç”¨äººï¼š' + user + ' ï½œ ç¸½è¨ˆï¼š' + totalPick + ' ä»¶';
                if (totalWeight > 0) {
                    resultHtml += ' / ' + Math.round(totalWeight * 10) / 10 + ' kg';
                }
                resultHtml += '</div></div>';
                document.getElementById('rm-picking-result').innerHTML = resultHtml;
                document.getElementById('rm-picking-summary').classList.add('hidden');

                document.getElementById('rm-pick-name').value = '';
                document.getElementById('rm-pick-spec').value = '';
                document.getElementById('rm-pick-qty').value = '';
                document.getElementById('rm-pick-dept').value = '';

            } catch (err) {
                console.error('é ˜æ–™å‡ºåº«å¤±æ•—:', err);
                alert('âŒ é ˜æ–™å‡ºåº«å¤±æ•—ï¼š' + err.message);
            }
        };

        window.printPickingSlip = function(mode) {
            var plan = window.pickingPlan[mode];
            if (!plan || plan.length === 0) {
                alert('è«‹å…ˆè¨ˆç®—æ€è²¨æ–¹æ¡ˆ');
                return;
            }

            var product = window.pickingSelectedProduct[mode];
            var requiredQty = document.getElementById(mode + '-pick-qty').value;
            var customer = document.getElementById(mode + '-pick-customer') ? document.getElementById(mode + '-pick-customer').value : '';
            var dept = document.getElementById(mode + '-pick-dept') ? document.getElementById(mode + '-pick-dept').value : '';

            var now = new Date();
            var slipNo = (mode === 'fg' ? 'PK' : 'RM') + '-' + now.getFullYear() + ('0'+(now.getMonth()+1)).slice(-2) + ('0'+now.getDate()).slice(-2) + '-' + ('0'+now.getHours()).slice(-2) + ('0'+now.getMinutes()).slice(-2);

            var title = mode === 'fg' ? 'æˆå“æ€è²¨å–®' : 'åŸæ–™é ˜ç”¨å»ºè­°å–®';
            var color = mode === 'fg' ? '#7c3aed' : '#0891b2';

            var html = '<div style="border:3px solid #000;padding:20px;font-family:Microsoft JhengHei,Arial;">';
            html += '<div style="background:' + color + ';color:white;padding:15px;margin:-20px -20px 20px -20px;text-align:center;">';
            html += '<div style="font-size:28px;font-weight:bold;">' + title + '</div>';
            html += '<div style="font-size:14px;margin-top:5px;">å–®è™Ÿ: ' + slipNo + '</div>';
            html += '</div>';

            html += '<div style="display:flex;justify-content:space-between;margin-bottom:15px;padding:10px;background:#f5f5f5;">';
            html += '<div><b>å“å:</b> ' + product.name + '</div>';
            html += '<div><b>è¦æ ¼:</b> ' + product.spec + '</div>';
            html += '<div><b>éœ€æ±‚:</b> <span style="font-size:24px;color:red;font-weight:bold;">' + requiredQty + '</span> ä»¶</div>';
            html += '</div>';

            if (customer || dept) {
                html += '<div style="margin-bottom:15px;"><b>' + (mode === 'fg' ? 'å®¢æˆ¶' : 'é ˜ç”¨å–®ä½') + ':</b> ' + (customer || dept) + '</div>';
            }

            html += '<table style="width:100%;border-collapse:collapse;margin-bottom:20px;">';
            html += '<thead><tr style="background:#333;color:white;">';
            if (mode === 'rm') html += '<th style="padding:10px;border:1px solid #000;">ç¢ºèª</th>';
            html += '<th style="padding:10px;border:1px solid #000;">é †åº</th>';
            html += '<th style="padding:10px;border:1px solid #000;">å„²ä½</th>';
            html += '<th style="padding:10px;border:1px solid #000;">å–ç”¨æ•¸é‡</th>';
            html += '<th style="padding:10px;border:1px solid #000;">æ–¹å¼</th>';
            html += '<th style="padding:10px;border:1px solid #000;">æ•ˆæœŸ</th>';
            html += '<th style="padding:10px;border:1px solid #000;">æ‰¹è™Ÿ</th>';
            html += '<th style="padding:10px;border:1px solid #000;">é¤˜æ–™</th>';
            html += '</tr></thead><tbody>';

            plan.forEach(function(item, idx) {
                html += '<tr>';
                if (mode === 'rm') html += '<td style="padding:10px;border:1px solid #ccc;text-align:center;font-size:24px;">â˜</td>';
                html += '<td style="padding:10px;border:1px solid #ccc;text-align:center;font-weight:bold;">' + (idx + 1) + '</td>';
                html += '<td style="padding:10px;border:1px solid #ccc;text-align:center;font-size:20px;font-weight:bold;">' + item.locationId + '</td>';
                html += '<td style="padding:10px;border:1px solid #ccc;text-align:center;font-size:28px;font-weight:bold;color:red;">' + item.pickQty + '</td>';
                html += '<td style="padding:10px;border:1px solid #ccc;text-align:center;">' + (item.pickType === 'full' ? 'æ•´æ¿' : 'æ‹†æ¿') + '</td>';
                html += '<td style="padding:10px;border:1px solid #ccc;text-align:center;">' + (item.expDate || '-') + '</td>';
                html += '<td style="padding:10px;border:1px solid #ccc;text-align:center;">' + (item.batchNo || '-') + '</td>';
                html += '<td style="padding:10px;border:1px solid #ccc;text-align:center;">' + (item.remaining > 0 ? item.remaining + 'ä»¶' : '-') + '</td>';
                html += '</tr>';
            });

            html += '</tbody></table>';

            if (mode === 'rm') {
                html += '<div style="background:#fff3cd;border:2px solid #ffc107;padding:15px;margin-bottom:20px;">';
                html += '<div style="font-weight:bold;color:#856404;">âš ï¸ å€‰ç®¡ç¾å ´ç¢ºèªäº‹é …ï¼š</div>';
                html += '<div style="margin-top:10px;color:#856404;">';
                html += 'â€¢ æ£§æ¿ç‹€æ…‹æ˜¯å¦å®Œå¥½<br>';
                html += 'â€¢ å †ç–Šæ˜¯å¦å¹³æ•´å¯å–<br>';
                html += 'â€¢ ç¢ºèªå¾Œè«‹æ‰“å‹¾ â˜‘ï¸<br>';
                html += 'â€¢ å¦‚æœ‰èª¿æ•´è«‹è¨»è¨˜';
                html += '</div></div>';
            }

            html += '<div style="display:flex;justify-content:space-around;padding-top:20px;border-top:2px solid #000;">';
            html += '<div style="text-align:center;"><div style="border-bottom:1px solid #000;width:120px;height:50px;"></div><div style="font-size:12px;color:#666;margin-top:5px;">è£½å–®äººå“¡</div></div>';
            html += '<div style="text-align:center;"><div style="border-bottom:1px solid #000;width:120px;height:50px;"></div><div style="font-size:12px;color:#666;margin-top:5px;">å€‰ç®¡ç¢ºèª</div></div>';
            html += '<div style="text-align:center;"><div style="border-bottom:1px solid #000;width:120px;height:50px;"></div><div style="font-size:12px;color:#666;margin-top:5px;">å †é«˜æ©Ÿæ‰‹</div></div>';
            html += '</div>';

            html += '</div>';

            openPrintPreview(html, title + ' - ' + slipNo, 900, 800);
        };

        // ========== å¤–éƒ¨å€‰åº«ç®¡ç†åŠŸèƒ½ ==========

        window.externalStock = [];
        window.transferList = [];

        var extWhNames = {
            'EXT-TP': 'å°åŒ—å€‰',
            'EXT-TC': 'å°ä¸­å€‰',
            'EXT-KH': 'é«˜é›„å€‰',
            'STORE': 'é–€å¸‚'
        };

        window.loadExternalStock = async function() {
            try {
                var snapshot = await window.getDocs(window.collection(window.db, 'externalStock'));
                window.externalStock = [];
                snapshot.forEach(function(doc) {
                    window.externalStock.push({ id: doc.id, ...doc.data() });
                });
                updateExternalSummary();
                renderExternalStock();
            } catch(e) {
                console.error('è¼‰å…¥å¤–å€‰åº«å­˜å¤±æ•—:', e);
            }
        };

        function updateExternalSummary() {
            var summary = { 'EXT-TP': { qty: 0, items: 0 }, 'EXT-TC': { qty: 0, items: 0 }, 'EXT-KH': { qty: 0, items: 0 }, 'STORE': { qty: 0, items: 0 } };

            window.externalStock.forEach(function(s) {
                if (summary[s.warehouseId]) {
                    summary[s.warehouseId].qty += (s.quantity || 0);
                    summary[s.warehouseId].items++;
                }
            });

            document.getElementById('ext-tp-count').innerText = summary['EXT-TP'].qty;
            document.getElementById('ext-tp-items').innerText = summary['EXT-TP'].items;
            document.getElementById('ext-tc-count').innerText = summary['EXT-TC'].qty;
            document.getElementById('ext-tc-items').innerText = summary['EXT-TC'].items;
            document.getElementById('ext-kh-count').innerText = summary['EXT-KH'].qty;
            document.getElementById('ext-kh-items').innerText = summary['EXT-KH'].items;
            document.getElementById('ext-store-count').innerText = summary['STORE'].qty;
            document.getElementById('ext-store-items').innerText = summary['STORE'].items;
        }

        window.extCompanyFilter = 'all';

        window.setExtCompany = function(company) {
            window.extCompanyFilter = company;

            document.getElementById('btn-ext-all').className = company === 'all'
                ? 'px-3 py-1.5 rounded text-xs font-bold bg-slate-600 text-white'
                : 'px-3 py-1.5 rounded text-xs font-bold bg-slate-700 text-slate-300 hover:bg-slate-600';
            document.getElementById('btn-ext-cw').className = company === 'å´‡æ–‡'
                ? 'px-3 py-1.5 rounded text-xs font-bold bg-blue-600 text-white'
                : 'px-3 py-1.5 rounded text-xs font-bold bg-slate-700 text-slate-300 hover:bg-slate-600';
            document.getElementById('btn-ext-bf').className = company === 'å…«æ–¹'
                ? 'px-3 py-1.5 rounded text-xs font-bold bg-purple-600 text-white'
                : 'px-3 py-1.5 rounded text-xs font-bold bg-slate-700 text-slate-300 hover:bg-slate-600';

            updateExtWarehouseFilter();

            renderExternalStock();
        };

        function updateExtWarehouseFilter() {
            var company = window.extCompanyFilter;
            var filterSelect = document.getElementById('ext-wh-filter');
            var adjSelect = document.getElementById('ext-adj-wh');

            var html = '<option value="">å…¨éƒ¨å¤–å€‰</option>';
            var adjHtml = '<option value="">é¸æ“‡å€‰åº«</option>';

            window.warehousesData.forEach(function(w) {
                if (w.type === 'external' && w.active) {
                    if (company === 'all' || w.company === company) {
                        var label = w.company + ' - ' + w.name;
                        html += '<option value="' + w.code + '">' + label + '</option>';
                        adjHtml += '<option value="' + w.code + '">' + label + '</option>';
                    }
                }
            });

            if (filterSelect) filterSelect.innerHTML = html;
            if (adjSelect) adjSelect.innerHTML = adjHtml;
        }

        function renderExternalStock(filter) {
            var tbody = document.getElementById('external-stock-list');
            var companyFilter = window.extCompanyFilter || 'all';
            var data = window.externalStock;

            if (companyFilter !== 'all') {
                data = data.filter(function(s) { return s.company === companyFilter; });
            }

            if (filter) {
                data = data.filter(function(s) { return s.warehouseId === filter; });
            }

            var countEl = document.getElementById('ext-stock-count');
            if (countEl) countEl.innerText = data.length + ' ç­†';

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-slate-500 py-10">ç„¡åº«å­˜è³‡æ–™</td></tr>';
                return;
            }

            var getWhName = function(code) {
                var wh = window.warehousesData.find(function(w) { return w.code === code; });
                return wh ? wh.name : code;
            };

            var html = '';
            data.forEach(function(s) {
                var whName = getWhName(s.warehouseId);
                var expClass = '';
                if (s.expDate) {
                    var exp = new Date(s.expDate);
                    var now = new Date();
                    var days = Math.floor((exp - now) / 86400000);
                    if (days < 0) expClass = 'text-red-400 font-bold';
                    else if (days < 30) expClass = 'text-orange-400';
                    else if (days < 90) expClass = 'text-yellow-400';
                }

                var companyClass = s.company === 'å…«æ–¹' ? 'bg-purple-900/50 text-purple-300' : 'bg-blue-900/50 text-blue-300';

                html += '<tr class="border-b border-slate-700 hover:bg-slate-800">';
                html += '<td class="p-2"><span class="px-1.5 py-0.5 rounded text-xs ' + companyClass + '">' + (s.company || '-') + '</span></td>';
                html += '<td class="p-2"><span class="px-2 py-1 rounded text-xs bg-slate-700">' + whName + '</span></td>';
                html += '<td class="p-2 text-white font-bold">' + (s.productName || '-') + '</td>';
                html += '<td class="p-2 text-slate-400">' + (s.spec || '-') + '</td>';
                html += '<td class="p-2 text-slate-400">' + (s.batchNo || '-') + '</td>';
                html += '<td class="p-2 text-right text-yellow-400 font-bold">' + (s.quantity || 0) + '</td>';
                html += '<td class="p-2 ' + expClass + '">' + (s.expDate || '-') + '</td>';
                html += '<td class="p-2 text-center">';
                html += '<button onclick="deleteExternalStock(\'' + s.id + '\')" class="bg-red-600 hover:bg-red-500 text-white text-xs px-2 py-1 rounded" title="åˆªé™¤"><i class="fa-solid fa-trash"></i></button>';
                html += '</td>';
                html += '</tr>';
            });

            tbody.innerHTML = html;
        }

        window.filterExternalWarehouse = function(wh) {
            document.getElementById('ext-wh-filter').value = wh || '';
            renderExternalStock(wh);
        };

        window.submitExternalAdjust = async function() {
            var companyRadio = document.querySelector('input[name="ext-adj-company"]:checked');
            var company = companyRadio ? companyRadio.value : 'å´‡æ–‡';
            var wh = document.getElementById('ext-adj-wh').value;
            var name = document.getElementById('ext-adj-name').value.trim();
            var spec = document.getElementById('ext-adj-spec').value.trim();
            var batch = document.getElementById('ext-adj-batch').value.trim();
            var exp = document.getElementById('ext-adj-exp').value;
            var qty = parseInt(document.getElementById('ext-adj-qty').value) || 0;
            var reason = document.getElementById('ext-adj-reason').value;

            if (!wh) { alert('è«‹é¸æ“‡å€‰åº«'); return; }
            if (!name) { alert('è«‹è¼¸å…¥å“å'); return; }
            if (!exp) { alert('âš ï¸ æ•ˆæœŸç‚ºå¿…å¡«æ¬„ä½ï¼Œè«‹è¼¸å…¥æ•ˆæœŸ'); return; }
            if (!batch) {
                if (!confirm('âš ï¸ æ‰¹è™Ÿæœªå¡«å¯«\n\nè‡ªå®¶ç”Ÿç”¢ã€é€²å£ã€å¤§å®—åŸæ–™æ‡‰å¡«å¯«æ‰¹è™Ÿã€‚\n\nç¢ºå®šä¸å¡«å¯«æ‰¹è™Ÿå—ï¼Ÿ')) {
                    return;
                }
            }
            if (qty === 0) { alert('è«‹è¼¸å…¥èª¿æ•´æ•¸é‡'); return; }

            try {
                var existing = window.externalStock.find(function(s) {
                    return s.warehouseId === wh && s.productName === name && s.batchNo === batch && s.company === company;
                });

                if (existing) {
                    var newQty = existing.quantity + qty;
                    if (newQty < 0) newQty = 0;

                    if (newQty === 0) {
                        await window.deleteDoc(window.doc(window.db, 'externalStock', existing.id));
                    } else {
                        await window.updateDoc(window.doc(window.db, 'externalStock', existing.id), {
                            quantity: newQty,
                            updatedAt: new Date().toISOString()
                        });
                    }
                } else {
                    if (qty < 0) { alert('ç„¡æ­¤åº«å­˜ï¼Œç„¡æ³•æ‰£æ¸›'); return; }

                    await window.addDoc(window.collection(window.db, 'externalStock'), {
                        company: company,
                        warehouseId: wh,
                        productName: name,
                        spec: spec,
                        batchNo: batch,
                        expDate: exp,
                        quantity: qty,
                        reason: reason,
                        createdAt: new Date().toISOString()
                    });
                }

                alert('âœ… èª¿æ•´æˆåŠŸï¼');

                document.getElementById('ext-adj-name').value = '';
                document.getElementById('ext-adj-spec').value = '';
                document.getElementById('ext-adj-batch').value = '';
                document.getElementById('ext-adj-exp').value = '';
                document.getElementById('ext-adj-qty').value = '';

                loadExternalStock();
            } catch(e) {
                alert('âŒ èª¿æ•´å¤±æ•—ï¼š' + e.message);
            }
        };

        window.deleteExternalStock = async function(id) {
            if (!confirm('ç¢ºå®šåˆªé™¤æ­¤ç­†åº«å­˜ï¼Ÿ')) return;

            try {
                await window.deleteDoc(window.doc(window.db, 'externalStock', id));
                alert('âœ… å·²åˆªé™¤');
                loadExternalStock();
            } catch(e) {
                alert('âŒ åˆªé™¤å¤±æ•—ï¼š' + e.message);
            }
        };

        window.exportExternalStock = function() {
            if (window.externalStock.length === 0) {
                alert('ç„¡è³‡æ–™å¯åŒ¯å‡º');
                return;
            }

            var csv = 'å€‰åº«,å“å,è¦æ ¼,æ‰¹è™Ÿ,æ•¸é‡,é¡å‹,ç®±å®¹kg,ç¸½é‡é‡kg,æ•ˆæœŸ\n';
            window.externalStock.forEach(function(s) {
                var productType = s.productType === 'variable' ? 'ä¸å®šé‡' : 'å®šé‡';
                csv += [
                    extWhNames[s.warehouseId] || s.warehouseId,
                    s.productName,
                    s.spec,
                    s.batchNo,
                    s.quantity,
                    productType,
                    s.unitWeight || '',
                    s.totalWeight || '',
                    s.expDate
                ].join(',') + '\n';
            });

            var blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8' });
            var a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'å¤–å€‰åº«å­˜_' + new Date().toISOString().split('T')[0] + '.csv';
            a.click();
        };

        window.handleExternalImport = function(event) {
            var file = event.target.files[0];
            if (!file) return;

            alert('ğŸ“¥ æª”æ¡ˆå·²é¸æ“‡ï¼š' + file.name + '\n\næ­¤åŠŸèƒ½éœ€è¦é€²ä¸€æ­¥é–‹ç™¼ Excel è§£æã€‚\nç›®å‰è«‹ä½¿ç”¨ã€Œåº«å­˜èª¿æ•´ã€æ‰‹å‹•è¼¸å…¥å°å¸³ã€‚');
            event.target.value = '';
        };

        // ========== å…¥åº«å–®å»ºç«‹ã€åˆ—å°ã€ç¢ºèªæµç¨‹ ==========

        window.pendingInbounds = [];

        var inboundTypeNames = {
            'Raw': 'æ¡è³¼é€²è²¨',
            'FG': 'ç”¢ç·šæˆå“',
            'WIP': 'ç”¢ç·šåŠæˆå“',
            'Return': 'é¤˜æ–™é€€åº«'
        };

        window.createInboundOrder = async function() {
            var loc = document.getElementById('in-loc').value;
            var name = document.getElementById('in-name').value.trim();
            var spec = document.getElementById('in-spec').value.trim();
            var batch = document.getElementById('in-batch').value.trim();
            var exp = document.getElementById('in-exp').value;
            var vendor = document.getElementById('in-vendor').value.trim();
            var category = document.getElementById('in-category').value || 'Raw';

            var productType = 'fixed';
            var radio = document.querySelector('input[name="in-product-type"]:checked');
            if (radio) {
                productType = radio.value;
            }

            var qty, unitWeight, totalWeight;

            if (productType === 'fixed') {
                qty = parseInt(document.getElementById('in-qty').value) || 0;
                unitWeight = parseFloat(document.getElementById('in-unit-weight').value) || 0;
                totalWeight = qty * unitWeight;
            } else {
                var qtyVarEl = document.getElementById('in-qty-var');
                var weightEl = document.getElementById('in-weight');
                qty = qtyVarEl ? (parseInt(qtyVarEl.value) || 0) : 0;
                totalWeight = weightEl ? (parseFloat(weightEl.value) || 0) : 0;
                unitWeight = qty > 0 ? Math.round(totalWeight / qty * 100) / 100 : 0;
            }

            var warehouseId = document.getElementById('in-warehouse').value;
            var isExternal = isExternalWarehouse(warehouseId);

            if (!isExternal && !loc) { alert('è«‹é¸æ“‡å„²ä½'); return null; }
            if (!name) { alert('è«‹è¼¸å…¥å“å'); return null; }
            if (!exp) { alert('âš ï¸ æ•ˆæœŸç‚ºå¿…å¡«æ¬„ä½'); return null; }
            if (qty <= 0) { alert('è«‹è¼¸å…¥æœ‰æ•ˆæ•¸é‡'); return null; }
            if (productType === 'variable' && totalWeight <= 0) { alert('âŒ ä¸å®šé‡å“è«‹å¡«å¯«ç¸½é‡é‡'); return null; }

            // ========== æ•ˆæœŸæª¢æŸ¥è­¦ç¤º ==========
            var expiryCheck = checkExpiryStatus(name, spec, exp);
            if (expiryCheck.status === 'expired') {
                alert('âŒ ç„¡æ³•å…¥åº«ï¼\n\næ­¤å•†å“å·²éæœŸï¼ˆ' + exp + 'ï¼‰\n\nè«‹é€€å›ä¾›æ‡‰å•†æˆ–é€²è¡Œå ±å»¢è™•ç†');
                return null;
            } else if (expiryCheck.status === 'critical') {
                var result = await showExpiryApprovalModal(expiryCheck);
                if (result === 'reject') {
                    alert('âŒ å·²æ‹’æ”¶æ­¤å³æœŸå“');
                    return null;
                } else if (result === 'cancel') {
                    return null;
                }
                // result === 'approve' ç¹¼çºŒåŸ·è¡Œï¼Œä½†æ¨™è¨˜éœ€è¦ä¸»ç®¡æ ¸å‡†
            } else if (expiryCheck.status === 'warning') {
                if (!confirm('âš ï¸ æ•ˆæœŸè­¦ç¤º\n\n' + expiryCheck.message + '\n\nå‰©é¤˜å¤©æ•¸ï¼š' + expiryCheck.remainingDays + ' å¤©\n\nç¢ºå®šè¦å…æ”¶æ­¤æ‰¹è²¨ç‰©å—ï¼Ÿ')) {
                    return null;
                }
            }

            if (!batch) {
                if (!confirm('âš ï¸ æ‰¹è™Ÿæœªå¡«å¯«\n\nè‡ªå®¶ç”Ÿç”¢ã€é€²å£ã€å¤§å®—åŸæ–™æ‡‰å¡«å¯«æ‰¹è™Ÿã€‚\n\nç¢ºå®šä¸å¡«å¯«æ‰¹è™Ÿå—ï¼Ÿ')) {
                    return null;
                }
            }

            var now = new Date();
            var docNo = 'IN-' + now.getFullYear() + ('0'+(now.getMonth()+1)).slice(-2) + ('0'+now.getDate()).slice(-2) + '-' + ('0'+now.getHours()).slice(-2) + ('0'+now.getMinutes()).slice(-2) + ('0'+now.getSeconds()).slice(-2);

            var needsApproval = (category === 'Raw');

            var needsExpiryApproval = (expiryCheck.status === 'critical');

            var order = {
                docNo: docNo,
                type: category,
                typeName: inboundTypeNames[category] || category,
                isExternal: isExternal,
                warehouseId: warehouseId,
                warehouseName: getWarehouseDisplayName(warehouseId),
                locationId: isExternal ? null : loc,
                productName: name,
                spec: spec,
                batchNo: batch,
                expDate: exp,
                quantity: qty,
                productType: productType,
                unitWeight: unitWeight,
                totalWeight: totalWeight,
                vendor: vendor,
                status: 'pending', // å…¨éƒ¨éƒ½æ˜¯å¾…åŸ·è¡Œ
                needsApproval: needsApproval, // æ¨™è¨˜æ˜¯å¦éœ€è¦å¯©æ ¸
                approvalStatus: needsApproval ? 'pending' : 'not_required', // pending=å¾…å¯©æ ¸, approved=å·²å¯©æ ¸, not_required=ä¸éœ€å¯©æ ¸
                expiryWarning: expiryCheck.status !== 'ok' ? expiryCheck.status : null, // æ•ˆæœŸè­¦ç¤ºç‹€æ…‹
                expiryNote: expiryCheck.status !== 'ok' ? expiryCheck.message : null, // æ•ˆæœŸè­¦ç¤ºè¨Šæ¯
                createdBy: window.currentUser ? window.currentUser.email : 'admin',
                createdAt: now.toISOString()
            };

            try {
                var docRef = await window.addDoc(window.collection(window.db, 'inboundOrders'), order);
                order.id = docRef.id;

                var expiryWarningText = '';
                if (expiryCheck.status === 'critical') {
                    expiryWarningText = '\n\nğŸ”´ å³æœŸå“å·²ç”³è«‹ä¸»ç®¡æ ¸å‡†';
                } else if (expiryCheck.status === 'warning') {
                    expiryWarningText = '\n\nâš ï¸ æ•ˆæœŸè¼ƒçŸ­ï¼Œå·²è¨˜éŒ„';
                }

                await window.publishInboundTask(order);

                var locationInfo = isExternal ? ('å€‰åº«ï¼š' + order.warehouseName) : ('å„²ä½ï¼š' + loc);

                if (isExternal) {
                    await createExternalStock(order);
                    alert('âœ… å¤–å€‰å…¥åº«æˆåŠŸï¼\nå–®è™Ÿï¼š' + docNo + '\n' + locationInfo + expiryWarningText);
                } else if (needsApproval) {
                    alert('âœ… å…¥åº«å–®å»ºç«‹æˆåŠŸï¼\nå–®è™Ÿï¼š' + docNo + '\n' + locationInfo + expiryWarningText + '\n\nâš ï¸ æ¡è³¼é€²è²¨å·²é€šçŸ¥è²¡å‹™å¯©æ ¸\nğŸ“± å †é«˜æ©Ÿæ‰‹æ©Ÿå·²æ”¶åˆ°ä»»å‹™é€šçŸ¥');
                } else {
                    alert('âœ… å…¥åº«å–®å»ºç«‹æˆåŠŸï¼\nå–®è™Ÿï¼š' + docNo + '\n' + locationInfo + expiryWarningText + '\n\nğŸ“± å †é«˜æ©Ÿæ‰‹æ©Ÿå·²æ”¶åˆ°ä»»å‹™é€šçŸ¥');
                }

                clearInboundForm();
                updatePendingInboundCount();
                updateApprovalCount();

                return order;
            } catch(e) {
                alert('âŒ å»ºç«‹å¤±æ•—ï¼š' + e.message);
                return null;
            }
        };

        // ========== æ•ˆæœŸæª¢æŸ¥å‡½æ•¸ ==========
        window.checkExpiryStatus = function(productName, spec, expDateStr) {
            if (!expDateStr) return { status: 'ok', message: '' };

            var today = new Date();
            today.setHours(0, 0, 0, 0);
            var expDate = new Date(expDateStr);
            expDate.setHours(0, 0, 0, 0);

            var remainingDays = Math.ceil((expDate - today) / (1000 * 60 * 60 * 24));

            if (remainingDays <= 0) {
                return {
                    status: 'expired',
                    message: 'âŒ æ­¤å•†å“å·²éæœŸï¼',
                    remainingDays: remainingDays
                };
            }

            var productConfig = window.getProductPalletCapacity ? window.getProductPalletCapacity(productName, spec) : null;
            var productMaster = window.productMasterData ? window.productMasterData.find(function(p) {
                return p.name === productName && (p.spec || '') === (spec || '');
            }) : null;

            var shelfLifeMonths = productMaster ? productMaster.shelfLife : 0;

            var warningDays, criticalDays;

            if (shelfLifeMonths > 0) {
                var totalDays = shelfLifeMonths * 30; // ç²—ä¼°ä¸€å€‹æœˆ30å¤©
                warningDays = Math.floor(totalDays / 2);   // 1/2 ä¿å­˜æœŸé™
                criticalDays = Math.floor(totalDays / 6);  // 1/6 ä¿å­˜æœŸé™
            } else {
                warningDays = 90;   // å‰©é¤˜ < 90 å¤©è­¦ç¤º
                criticalDays = 30;  // å‰©é¤˜ < 30 å¤©éœ€æ ¸å‡†
            }

            if (remainingDays <= criticalDays) {
                return {
                    status: 'critical',
                    message: 'ğŸ”´ å³æœŸå“è­¦å‘Šï¼\n\næ•ˆæœŸå‰©é¤˜ ' + remainingDays + ' å¤©' +
                             (shelfLifeMonths > 0 ? '\nï¼ˆä½æ–¼ä¿å­˜æœŸé™ ' + shelfLifeMonths + ' å€‹æœˆçš„ 1/6ï¼‰' : '\nï¼ˆä½æ–¼ ' + criticalDays + ' å¤©ï¼‰') +
                             '\n\næ­¤å•†å“éœ€è¦ä¸»ç®¡æ ¸å‡†æ‰èƒ½å…¥åº«',
                    remainingDays: remainingDays,
                    threshold: criticalDays,
                    shelfLifeMonths: shelfLifeMonths
                };
            } else if (remainingDays <= warningDays) {
                return {
                    status: 'warning',
                    message: 'âš ï¸ æ•ˆæœŸè¼ƒçŸ­è­¦å‘Š\n\næ•ˆæœŸå‰©é¤˜ ' + remainingDays + ' å¤©' +
                             (shelfLifeMonths > 0 ? '\nï¼ˆä½æ–¼ä¿å­˜æœŸé™ ' + shelfLifeMonths + ' å€‹æœˆçš„ 1/2ï¼‰' : '\nï¼ˆä½æ–¼ ' + warningDays + ' å¤©ï¼‰'),
                    remainingDays: remainingDays,
                    threshold: warningDays,
                    shelfLifeMonths: shelfLifeMonths
                };
            }

            return { status: 'ok', message: '', remainingDays: remainingDays };
        };

        window.showExpiryApprovalModal = function(expiryCheck) {
            return new Promise(function(resolve) {
                var modal = document.createElement('div');
                modal.className = 'fixed inset-0 z-50 flex items-center justify-center';
                modal.innerHTML =
                    '<div class="absolute inset-0 bg-black/80" onclick="this.parentElement.remove()"></div>' +
                    '<div class="relative bg-slate-900 border-2 border-red-500 rounded-lg p-6 max-w-md shadow-2xl">' +
                        '<div class="text-center mb-4">' +
                            '<div class="text-6xl mb-3">ğŸš¨</div>' +
                            '<h3 class="text-xl font-bold text-red-400">å³æœŸå“è­¦å‘Š</h3>' +
                        '</div>' +
                        '<div class="bg-red-900/30 border border-red-600 rounded p-4 mb-4">' +
                            '<div class="text-white whitespace-pre-line">' + expiryCheck.message + '</div>' +
                        '</div>' +
                        '<div class="text-sm text-slate-400 mb-4 text-center">' +
                            'æ­¤å•†å“æ•ˆæœŸéçŸ­ï¼Œéœ€è¦ä¸»ç®¡æ ¸å‡†æ‰èƒ½å…¥åº«ã€‚<br>è«‹é¸æ“‡è™•ç†æ–¹å¼ï¼š' +
                        '</div>' +
                        '<div class="flex gap-3">' +
                            '<button onclick="this.closest(\'.fixed\').dataset.result=\'reject\';this.closest(\'.fixed\').remove()" class="flex-1 py-3 bg-red-600 hover:bg-red-500 text-white rounded-lg font-bold">' +
                                '<i class="fa-solid fa-ban mr-2"></i>æ‹’æ”¶' +
                            '</button>' +
                            '<button onclick="this.closest(\'.fixed\').dataset.result=\'approve\';this.closest(\'.fixed\').remove()" class="flex-1 py-3 bg-yellow-600 hover:bg-yellow-500 text-white rounded-lg font-bold">' +
                                '<i class="fa-solid fa-clipboard-check mr-2"></i>ç”³è«‹æ ¸å‡†' +
                            '</button>' +
                        '</div>' +
                        '<button onclick="this.closest(\'.fixed\').dataset.result=\'cancel\';this.closest(\'.fixed\').remove()" class="w-full mt-3 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg text-sm">' +
                            'å–æ¶ˆ' +
                        '</button>' +
                    '</div>';

                document.body.appendChild(modal);

                var observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        mutation.removedNodes.forEach(function(node) {
                            if (node === modal) {
                                observer.disconnect();
                                resolve(modal.dataset.result || 'cancel');
                            }
                        });
                    });
                });
                observer.observe(document.body, { childList: true });
            });
        };

        window.createAndPrintInbound = async function() {
            var order = await createInboundOrder();
            if (order) {
                printInboundSlip(order);
            }
        };

        window.printInboundSlip = function(order) {
            var html = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>æ£§æ¿æ’å–® - ' + order.productName + '</title>';
            html += '<style>';
            html += '@page { size: A4 landscape; margin: 0; }';
            html += '* { margin: 0; padding: 0; box-sizing: border-box; }';
            html += 'body { font-family: Microsoft JhengHei, Arial, sans-serif; background: #fff; }';
            html += '.label-page { width: 297mm; height: 210mm; padding: 3mm; box-sizing: border-box; overflow: hidden; }';
            html += '.label-content { height: 100%; border: 3px solid #000; display: flex; flex-direction: column; overflow: hidden; }';
            // ç¬¬ä¸€åˆ—ï¼šQR code 8x8cm + å“å144px (å›ºå®šé«˜åº¦80mm)
            html += '.row-1 { height: 80mm; min-height: 80mm; max-height: 80mm; display: flex; align-items: center; border-bottom: 3px solid #000; padding: 0 8mm; overflow: hidden; }';
            html += '.qr-container { width: 80mm; height: 76mm; flex-shrink: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; }';
            html += '.qr-box { width: 68mm; height: 68mm; }';
            html += '.qr-box svg { width: 100% !important; height: 100% !important; }';
            html += '.qr-label { font-size: 11px; color: #666; margin-top: 1mm; text-align: center; white-space: nowrap; }';
            html += '.product-name { flex: 1; font-size: 144px; font-weight: 900; text-align: center; line-height: 1; overflow: hidden; display: flex; align-items: center; justify-content: center; }';
            // ç¬¬äºŒåˆ—ï¼šè¦æ ¼è‡ªå‹•ç¸®æ”¾ (å›ºå®šé«˜åº¦35mm)
            html += '.row-2 { height: 35mm; min-height: 35mm; max-height: 35mm; display: flex; align-items: center; justify-content: center; border-bottom: 3px solid #000; overflow: hidden; padding: 0 5mm; }';
            html += '.product-spec { font-weight: 700; color: #333; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }';
            // ç¬¬ä¸‰åˆ—ï¼šæ•¸é‡ã€æ‰¹è™Ÿã€æ•ˆæœŸ60px (å›ºå®šé«˜åº¦45mmï¼Œä¸æŠ˜è¡Œ)
            html += '.row-3 { height: 45mm; min-height: 45mm; max-height: 45mm; display: flex; border-bottom: 2px solid #000; }';
            html += '.info-cell { flex: 1; text-align: center; padding: 2mm; border-right: 1px solid #ccc; display: flex; flex-direction: column; justify-content: center; overflow: hidden; }';
            html += '.info-cell:last-child { border-right: none; }';
            html += '.info-label { font-size: 12px; color: #666; margin-bottom: 1mm; }';
            html += '.info-value { font-size: 60px; font-weight: 900; line-height: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }';
            html += '.info-value.qty-val { color: #dc2626; }';
            // ç¬¬å››åˆ—ï¼šå„²ä½36px + å» å•†36px (å‰©é¤˜ç©ºé–“)
            html += '.row-4 { flex: 1; display: flex; align-items: center; padding: 2mm 8mm; min-height: 30mm; }';
            html += '.location-box { background: #000; color: #fff; font-size: 36px; font-weight: 900; padding: 3mm 10mm; margin-right: 10mm; white-space: nowrap; }';
            html += '.vendor-box { font-size: 36px; font-weight: 700; color: #333; flex: 1; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }';
            html += '.no-print { text-align: center; padding: 20px; }';
            html += '.no-print button { padding: 15px 40px; font-size: 18px; border: none; cursor: pointer; font-weight: bold; margin: 0 10px; border-radius: 8px; }';
            html += '.btn-print { background: #059669; color: white; }';
            html += '.btn-close { background: #666; color: white; }';
            html += '@media print { .no-print { display: none !important; } }';
            html += '</style>';
            html += '</head><body>';

            // æ ¹æ“šè¦æ ¼æ–‡å­—é•·åº¦å‹•æ…‹èª¿æ•´å­—é«”å¤§å° 100/80/60/45/36
            var specText = order.spec || '-';
            var specFontSize = 100;
            if (specText.length > 10) specFontSize = 80;
            if (specText.length > 15) specFontSize = 60;
            if (specText.length > 25) specFontSize = 45;
            if (specText.length > 35) specFontSize = 36;

            html += '<div class="label-page"><div class="label-content">';

            // ç¬¬ä¸€åˆ—ï¼šQR code + å“å
            html += '<div class="row-1">';
            html += '<div class="qr-container"><div id="qrcode" class="qr-box"></div><div class="qr-label">' + order.docNo + '</div></div>';
            html += '<div class="product-name">' + order.productName + '</div>';
            html += '</div>';

            // ç¬¬äºŒåˆ—ï¼šè¦æ ¼ (è‡ªå‹•ç¸®æ”¾å­—é«”)
            html += '<div class="row-2"><div class="product-spec" style="font-size:' + specFontSize + 'px;">' + specText + '</div></div>';

            // ç¬¬ä¸‰åˆ—ï¼šæ•¸é‡ã€æ‰¹è™Ÿã€æ•ˆæœŸ
            html += '<div class="row-3">';
            html += '<div class="info-cell"><div class="info-label">æ•¸é‡</div><div class="info-value qty-val">' + order.quantity + '</div></div>';
            html += '<div class="info-cell"><div class="info-label">æ‰¹è™Ÿ</div><div class="info-value">' + (order.batchNo || '-') + '</div></div>';
            html += '<div class="info-cell"><div class="info-label">æ•ˆæœŸ</div><div class="info-value">' + (order.expDate || '-') + '</div></div>';
            html += '</div>';

            // ç¬¬å››åˆ—ï¼šå„²ä½ã€å» å•†
            html += '<div class="row-4">';
            html += '<div class="location-box">' + (order.locationId || 'å¾…åˆ†é…') + '</div>';
            html += '<div class="vendor-box">' + (order.vendor || '-') + '</div>';
            html += '</div>';

            html += '</div></div>';

            html += '<div class="no-print">';
            html += '<button class="btn-print" onclick="window.print()">ğŸ–¨ï¸ åˆ—å°æ’å–®</button>';
            html += '<button class="btn-close" onclick="window.close()">é—œé–‰</button>';
            html += '</div>';

            html += '<script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"><\/script>';
            html += '<script>window.onload = function() {';
            html += 'try { var qr = qrcode(0, "M"); qr.addData("' + order.docNo + '"); qr.make(); document.getElementById("qrcode").innerHTML = qr.createSvgTag(0, 0); } catch(e) { console.error(e); }';
            html += '};<\/script>';
            html += '</body></html>';

            var printWindow = window.open('', '_blank', 'width=1100,height=800');
            printWindow.document.write(html);
            printWindow.document.close();
        };

        function clearInboundForm() {
            var el;
            el = document.getElementById('in-vendor'); if(el) el.value = '';
            el = document.getElementById('in-name'); if(el) el.value = '';
            el = document.getElementById('in-spec'); if(el) el.value = '';
            el = document.getElementById('in-qty'); if(el) el.value = '';
            el = document.getElementById('in-batch'); if(el) el.value = '';
            el = document.getElementById('in-exp'); if(el) el.value = '';
            el = document.getElementById('in-loc'); if(el) el.value = '';
            el = document.getElementById('location-status'); if(el) el.innerHTML = '<span class="text-slate-500">ç­‰å¾…é¸æ“‡å„²ä½</span>';
            updateLivePreview();
        }

        window.directInbound = async function() {
            var loc = document.getElementById('in-loc').value;
            var name = document.getElementById('in-name').value;
            var qty = document.getElementById('in-qty').value;
            var exp = document.getElementById('in-exp').value;

            if (!loc) { alert('âŒ è«‹å…ˆæŒ‡å®šå„²ä½'); return; }
            if (!name) { alert('âŒ è«‹å¡«å¯«å“å'); return; }
            if (!qty) { alert('âŒ è«‹å¡«å¯«æ•¸é‡'); return; }
            if (!exp) { alert('âŒ è«‹å¡«å¯«æ•ˆæœŸ'); return; }

            if (!confirm('ç¢ºå®šç›´æ¥å…¥åº«åˆ° ' + loc + 'ï¼Ÿ\n\nå“åï¼š' + name + '\næ•¸é‡ï¼š' + qty)) return;

            var spec = document.getElementById('in-spec').value || '';
            var batchNo = document.getElementById('in-batch').value || '';
            var vendor = document.getElementById('in-vendor').value || '';
            var qtyNum = parseInt(qty);

            try {
                var now = new Date();
                var docNo = 'IN-' + now.getFullYear() + ('0'+(now.getMonth()+1)).slice(-2) + ('0'+now.getDate()).slice(-2) + '-' + ('0'+now.getHours()).slice(-2) + ('0'+now.getMinutes()).slice(-2) + ('0'+now.getSeconds()).slice(-2);

                await window.addDoc(window.collection(window.db, 'pallets'), {
                    palletId: docNo,
                    productName: name,
                    spec: spec,
                    batchNo: batchNo,
                    expDate: exp,
                    expiryDate: exp,
                    quantity: qtyNum,
                    locationId: loc,
                    vendor: vendor,
                    category: document.getElementById('in-category').value || 'Raw',
                    source: 'DirectInbound',
                    createdAt: now.toISOString()
                });

                var categoryNames = { 'Raw': 'æ¡è³¼é€²è²¨', 'FG': 'ç”¢ç·šæˆå“', 'WIP': 'ç”¢ç·šåŠæˆå“', 'Return': 'é¤˜æ–™é€€åº«' };
                var categoryName = categoryNames[document.getElementById('in-category').value] || 'å…¥åº«';
                await window.logInventoryChange({
                    type: 'inbound',
                    productName: name,
                    spec: spec,
                    quantity: qtyNum,
                    quantityChange: qtyNum,
                    locationId: loc,
                    batchNo: batchNo,
                    palletId: docNo,
                    expDate: exp,
                    note: categoryName + (vendor ? ' - ' + vendor : '')
                });

                alert('âœ… å…¥åº«æˆåŠŸï¼\n\nå„²ä½ï¼š' + loc + '\nå“åï¼š' + name);
                clearInboundForm();
            } catch(e) {
                alert('âŒ å…¥åº«å¤±æ•—ï¼š' + e.message);
            }
        };

        window.showPendingInbounds = function() {
            document.getElementById('pending-inbound-modal').classList.remove('hidden');
            loadPendingInbounds();
        };

        window.closePendingInbounds = function() {
            document.getElementById('pending-inbound-modal').classList.add('hidden');
        };

        async function loadPendingInbounds() {
            var tbody = document.getElementById('pending-inbound-list');
            if (!tbody) return;

            if (!window.db || !window.collection || !window.query || !window.getDocs) {
                tbody.innerHTML = '<tr><td colspan="10" class="text-center text-slate-500 py-10">Firebase å°šæœªåˆå§‹åŒ–</td></tr>';
                return;
            }

            try {
                var q = window.query(window.collection(window.db, 'inboundOrders'), window.where('status', '==', 'pending'));
                var snapshot = await window.getDocs(q);

                window.pendingInbounds = [];
                snapshot.forEach(function(doc) {
                    window.pendingInbounds.push({ id: doc.id, ...doc.data() });
                });

                window.pendingInbounds.sort(function(a, b) {
                    return new Date(b.createdAt) - new Date(a.createdAt);
                });

                if (window.pendingInbounds.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="10" class="text-center text-slate-500 py-10">ç„¡å¾…åŸ·è¡Œå…¥åº«å–®</td></tr>';
                    return;
                }

                var html = '';
                window.pendingInbounds.forEach(function(order, idx) {
                    var expClass = '';
                    if (order.expDate) {
                        var exp = new Date(order.expDate);
                        var now = new Date();
                        var days = Math.floor((exp - now) / 86400000);
                        if (days < 0) expClass = 'text-red-400';
                        else if (days < 30) expClass = 'text-orange-400';
                        else if (days < 90) expClass = 'text-yellow-400';
                    }

                    html += '<tr class="border-b border-slate-700 hover:bg-slate-800">';
                    html += '<td class="p-2"><input type="checkbox" class="inbound-checkbox" data-idx="' + idx + '"></td>';
                    html += '<td class="p-2 text-blue-400 font-mono text-xs">' + order.docNo + '</td>';
                    html += '<td class="p-2"><span class="px-2 py-1 rounded text-xs bg-slate-700">' + order.typeName + '</span></td>';
                    html += '<td class="p-2 text-emerald-400 font-bold text-lg">' + order.locationId + '</td>';
                    html += '<td class="p-2 text-white font-bold">' + order.productName + '</td>';
                    html += '<td class="p-2 text-slate-400">' + (order.batchNo || '-') + '</td>';
                    html += '<td class="p-2 ' + expClass + '">' + order.expDate + '</td>';
                    html += '<td class="p-2 text-right text-yellow-400 font-bold">' + order.quantity + '</td>';
                    html += '<td class="p-2 text-slate-500 text-xs">' + new Date(order.createdAt).toLocaleString() + '</td>';
                    html += '<td class="p-2 text-center">';
                    html += '<button onclick="reprintInbound(' + idx + ')" class="text-blue-400 hover:text-blue-300 mr-2" title="é‡å°"><i class="fa-solid fa-print"></i></button>';
                    html += '<button onclick="confirmSingleInbound(' + idx + ')" class="text-emerald-400 hover:text-emerald-300" title="ç¢ºèªå…¥å¸³"><i class="fa-solid fa-check"></i></button>';
                    html += '</td>';
                    html += '</tr>';
                });

                tbody.innerHTML = html;
                updatePendingInboundCount();
            } catch(e) {
                console.error('è¼‰å…¥å¾…åŸ·è¡Œå…¥åº«å–®å¤±æ•—:', e);
                tbody.innerHTML = '<tr><td colspan="10" class="text-center text-red-400 py-10">è¼‰å…¥å¤±æ•—</td></tr>';
            }
        }

        async function updatePendingInboundCount() {
            try {
                if (!window.db || !window.collection || !window.query || !window.getDocs) {
                    console.log('Firebase å°šæœªåˆå§‹åŒ–ï¼Œè·³éæ›´æ–°å¾…åŸ·è¡Œæ•¸é‡');
                    return;
                }
                var q = window.query(window.collection(window.db, 'inboundOrders'), window.where('status', '==', 'pending'));
                var snapshot = await window.getDocs(q);
                var count = snapshot.size;
                var el = document.getElementById('pending-inbound-count');
                if (el) el.innerText = count;
            } catch(e) {
                console.error('æ›´æ–°å¾…åŸ·è¡Œæ•¸é‡å¤±æ•—:', e);
            }
        }

        // ========== å¯©æ ¸æµç¨‹ç›¸é—œå‡½æ•¸ ==========

        window.updateApprovalCount = async function() {
            try {
                if (!window.db || !window.collection || !window.query || !window.getDocs) {
                    console.log('Firebase å°šæœªåˆå§‹åŒ–ï¼Œè·³éæ›´æ–°å¾…å¯©æ ¸æ•¸é‡');
                    return;
                }
                var q = window.query(window.collection(window.db, 'inboundOrders'), window.where('approvalStatus', '==', 'pending'));
                var snapshot = await window.getDocs(q);
                var count = snapshot.size;
                var el = document.getElementById('approval-count');
                if (el) el.innerText = count;
            } catch(e) {
                console.error('æ›´æ–°å¾…å¯©æ ¸æ•¸é‡å¤±æ•—:', e);
            }
        };

        window.approvalList = [];
        window.loadApprovalList = async function() {
            var tbody = document.getElementById('approval-list-body');
            if (!tbody) return;

            if (!window.db || !window.collection || !window.query || !window.getDocs) {
                tbody.innerHTML = '<tr><td colspan="12" class="text-center text-slate-500 py-10">Firebase å°šæœªåˆå§‹åŒ–</td></tr>';
                return;
            }

            tbody.innerHTML = '<tr><td colspan="12" class="text-center text-slate-500 py-10"><i class="fa-solid fa-spinner fa-spin mr-2"></i>è¼‰å…¥ä¸­...</td></tr>';

            try {
                var filter = document.getElementById('approval-status-filter').value;
                var search = (document.getElementById('approval-search').value || '').toLowerCase();

                var snapshot;
                if (filter === 'all') {
                    var q = window.query(window.collection(window.db, 'inboundOrders'), window.where('needsApproval', '==', true));
                    snapshot = await window.getDocs(q);
                } else {
                    var q = window.query(window.collection(window.db, 'inboundOrders'), window.where('approvalStatus', '==', filter));
                    snapshot = await window.getDocs(q);
                }

                window.approvalList = [];
                snapshot.forEach(function(doc) {
                    var data = { id: doc.id, ...doc.data() };
                    if (!search || data.productName.toLowerCase().includes(search) || data.docNo.toLowerCase().includes(search)) {
                        window.approvalList.push(data);
                    }
                });

                window.approvalList.sort(function(a, b) {
                    return new Date(b.createdAt) - new Date(a.createdAt);
                });

                renderApprovalList();
            } catch(e) {
                console.error('è¼‰å…¥å¯©æ ¸åˆ—è¡¨å¤±æ•—:', e);
                tbody.innerHTML = '<tr><td colspan="12" class="text-center text-red-400 py-10">è¼‰å…¥å¤±æ•—</td></tr>';
            }
        };

        function renderApprovalList() {
            var tbody = document.getElementById('approval-list-body');
            if (!tbody) return;

            if (window.approvalList.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12" class="text-center text-slate-500 py-10">ç„¡è³‡æ–™</td></tr>';
                return;
            }

            var html = '';
            window.approvalList.forEach(function(order, idx) {
                var statusBadge = '';
                var approvalBadge = '';

                if (order.status === 'pending') {
                    statusBadge = '<span class="badge badge-blue">å¾…åŸ·è¡Œ</span>';
                } else if (order.status === 'completed') {
                    statusBadge = '<span class="badge badge-green">å·²å…¥åº«</span>';
                }

                if (order.approvalStatus === 'pending') {
                    approvalBadge = '<span class="badge badge-yellow ml-1">å¾…å¯©æ ¸</span>';
                } else if (order.approvalStatus === 'approved') {
                    approvalBadge = '<span class="badge badge-green ml-1">å·²å¯©æ ¸</span>';
                } else if (order.approvalStatus === 'rejected') {
                    approvalBadge = '<span class="badge badge-red ml-1">å·²é§å›</span>';
                }

                var actions = '';
                if (order.approvalStatus === 'pending') {
                    actions = '<button onclick="approveInbound(' + idx + ')" class="text-emerald-400 hover:text-emerald-300 mr-2" title="å¯©æ ¸é€šé"><i class="fa-solid fa-check"></i></button>';
                    actions += '<button onclick="openRejectModal(' + idx + ')" class="text-red-400 hover:text-red-300" title="é§å›"><i class="fa-solid fa-times"></i></button>';
                } else if (order.approvalStatus === 'rejected') {
                    actions = '<button onclick="openEditInboundModal(' + idx + ')" class="text-blue-400 hover:text-blue-300" title="ä¿®æ”¹é‡é€"><i class="fa-solid fa-edit"></i></button>';
                } else if (order.approvalStatus === 'approved') {
                    actions = '<span class="text-slate-500 text-xs">å·²å®Œæˆ</span>';
                }

                html += '<tr class="border-b border-slate-700 hover:bg-slate-800">';
                html += '<td class="p-3 text-blue-400 font-mono text-xs">' + order.docNo + '</td>';
                html += '<td class="p-3 text-white font-bold">' + order.productName + '</td>';
                html += '<td class="p-3">' + (order.spec || '-') + '</td>';
                html += '<td class="p-3">' + (order.batchNo || '-') + '</td>';
                html += '<td class="p-3">' + (order.expDate || '-') + '</td>';
                html += '<td class="p-3 text-right text-yellow-400 font-bold">' + order.quantity + '</td>';
                html += '<td class="p-3 text-emerald-400">' + order.locationId + '</td>';
                html += '<td class="p-3">' + (order.vendor || '-') + '</td>';
                html += '<td class="p-3 text-slate-400 text-xs">' + (order.createdBy || '-') + '</td>';
                html += '<td class="p-3 text-slate-500 text-xs">' + new Date(order.createdAt).toLocaleString() + '</td>';
                html += '<td class="p-3 text-center">' + statusBadge + approvalBadge + '</td>';
                html += '<td class="p-3 text-center">' + actions + '</td>';
                html += '</tr>';

                if (order.approvalStatus === 'rejected' && order.rejectReason) {
                    html += '<tr class="bg-red-900/20"><td colspan="12" class="p-2 text-sm">';
                    html += '<span class="text-red-400 mr-2"><i class="fa-solid fa-exclamation-triangle mr-1"></i>é§å›åŸå› ï¼š</span>';
                    html += '<span class="text-white">' + order.rejectReason + '</span>';
                    html += '</td></tr>';
                }
            });

            tbody.innerHTML = html;
        }

        window.filterApprovalList = function() {
            loadApprovalList();
        };

        window.refreshApprovalList = function() {
            loadApprovalList();
            updateApprovalCount();
        };

        window.approveInbound = async function(idx) {
            var order = window.approvalList[idx];
            if (!order) return;

            if (!confirm('ç¢ºå®šå¯©æ ¸é€šéæ­¤å…¥åº«å–®ï¼Ÿ\n\nå–®è™Ÿï¼š' + order.docNo + '\nå“åï¼š' + order.productName + '\næ•¸é‡ï¼š' + order.quantity)) {
                return;
            }

            try {
                await window.updateDoc(window.doc(window.db, 'inboundOrders', order.id), {
                    approvalStatus: 'approved',
                    approvedBy: window.currentUser ? window.currentUser.email : 'admin',
                    approvedAt: new Date().toISOString()
                });

                alert('âœ… å¯©æ ¸é€šéï¼');
                loadApprovalList();
                updateApprovalCount();
            } catch(e) {
                alert('âŒ å¯©æ ¸å¤±æ•—ï¼š' + e.message);
            }
        };

        window.openRejectModal = function(idx) {
            var order = window.approvalList[idx];
            if (!order) return;

            document.getElementById('reject-order-id').value = order.id;
            document.getElementById('reject-reason').value = '';
            document.getElementById('reject-modal').classList.remove('hidden');
        };

        window.closeRejectModal = function() {
            document.getElementById('reject-modal').classList.add('hidden');
        };

        window.confirmReject = async function() {
            var orderId = document.getElementById('reject-order-id').value;
            var reason = document.getElementById('reject-reason').value.trim();

            if (!reason) {
                alert('è«‹è¼¸å…¥é§å›åŸå› ');
                return;
            }

            try {
                await window.updateDoc(window.doc(window.db, 'inboundOrders', orderId), {
                    approvalStatus: 'rejected',
                    rejectReason: reason,
                    rejectedBy: window.currentUser ? window.currentUser.email : 'admin',
                    rejectedAt: new Date().toISOString()
                });

                alert('âœ… å·²é§å›ï¼å€‰ç®¡å°‡æ”¶åˆ°é€šçŸ¥é€²è¡Œä¿®æ”¹');
                closeRejectModal();
                loadApprovalList();
                updateApprovalCount();
            } catch(e) {
                alert('âŒ é§å›å¤±æ•—ï¼š' + e.message);
            }
        };

        window.openEditInboundModal = function(idx) {
            var order = window.approvalList[idx];
            if (!order) return;

            document.getElementById('edit-order-id').value = order.id;
            document.getElementById('edit-reject-reason').innerText = order.rejectReason || '';
            document.getElementById('edit-name').value = order.productName || '';
            document.getElementById('edit-spec').value = order.spec || '';
            document.getElementById('edit-qty').value = order.quantity || '';
            document.getElementById('edit-batch').value = order.batchNo || '';
            document.getElementById('edit-exp').value = order.expDate || '';
            document.getElementById('edit-loc').value = order.locationId || '';
            document.getElementById('edit-vendor').value = order.vendor || '';

            document.getElementById('edit-inbound-modal').classList.remove('hidden');
        };

        window.closeEditInboundModal = function() {
            document.getElementById('edit-inbound-modal').classList.add('hidden');
        };

        window.submitEditAndReapprove = async function() {
            var orderId = document.getElementById('edit-order-id').value;
            var name = document.getElementById('edit-name').value.trim();
            var qty = parseInt(document.getElementById('edit-qty').value) || 0;
            var exp = document.getElementById('edit-exp').value;

            if (!name) { alert('è«‹è¼¸å…¥å“å'); return; }
            if (qty <= 0) { alert('è«‹è¼¸å…¥æœ‰æ•ˆæ•¸é‡'); return; }
            if (!exp) { alert('è«‹è¼¸å…¥æ•ˆæœŸ'); return; }

            try {
                await window.updateDoc(window.doc(window.db, 'inboundOrders', orderId), {
                    productName: name,
                    spec: document.getElementById('edit-spec').value.trim(),
                    quantity: qty,
                    batchNo: document.getElementById('edit-batch').value.trim(),
                    expDate: exp,
                    locationId: document.getElementById('edit-loc').value.trim(),
                    vendor: document.getElementById('edit-vendor').value.trim(),
                    status: 'pending_approval',
                    resubmittedAt: new Date().toISOString()
                });

                alert('âœ… å·²ä¿®æ”¹ä¸¦é‡æ–°é€å¯©ï¼');
                closeEditInboundModal();
                loadApprovalList();
                updateApprovalCount();
            } catch(e) {
                alert('âŒ ä¿®æ”¹å¤±æ•—ï¼š' + e.message);
            }
        };

        // ========== å¯©æ ¸æµç¨‹ç›¸é—œå‡½æ•¸çµæŸ ==========

        window.reprintInbound = function(idx) {
            var order = window.pendingInbounds[idx];
            if (order) {
                printInboundSlip(order);
            }
        };

        window.confirmSingleInbound = async function(idx) {
            var order = window.pendingInbounds[idx];
            if (!order) return;

            if (!confirm('ç¢ºèªæ­¤å…¥åº«å–®å·²å®Œæˆï¼Ÿ\n\nå„²ä½ï¼š' + order.locationId + '\nå“åï¼š' + order.productName + '\næ•¸é‡ï¼š' + order.quantity + '\n\nç¢ºèªå¾Œå°‡æ­£å¼å…¥å¸³')) {
                return;
            }

            await executeInbound(order);
        };

        window.toggleSelectAllInbound = function() {
            var selectAll = document.getElementById('select-all-inbound').checked;
            document.querySelectorAll('.inbound-checkbox').forEach(function(cb) {
                cb.checked = selectAll;
            });
        };

        window.printSelectedInbounds = function() {
            var checkboxes = document.querySelectorAll('.inbound-checkbox:checked');
            if (checkboxes.length === 0) {
                alert('è«‹å‹¾é¸è¦åˆ—å°çš„å…¥åº«å–®');
                return;
            }

            var orders = [];
            checkboxes.forEach(function(cb) {
                var idx = parseInt(cb.dataset.idx);
                var order = window.pendingInbounds[idx];
                if (order) {
                    orders.push(order);
                }
            });

            printInboundList(orders);
        };

        window.printInboundList = function(orders) {
            var html = '<style>';
            html += '.header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 8px; border-bottom: 2px solid #000; margin-bottom: 10px; }';
            html += '.title { font-size: 28px; font-weight: bold; }';
            html += '.meta { font-size: 14px; color: #666; }';
            html += 'table { width: 100%; border-collapse: collapse; }';
            html += 'th { background: #222; color: white; padding: 10px 12px; font-size: 14px; text-align: left; white-space: nowrap; }';
            html += 'th.c { text-align: center; }';
            html += 'td { padding: 10px; border-bottom: 1px solid #ccc; font-size: 14px; font-weight: bold; white-space: nowrap; vertical-align: middle; }';
            html += 'tr:nth-child(even) { background: #f8f8f8; }';
            html += '.col-chk { width: 40px; text-align: center; }';
            html += '.col-loc { font-size: 16px; font-weight: 900; background: #eee !important; text-align: center; }';
            html += '.col-name { font-size: 16px; }';
            html += '.col-spec { font-size: 14px; color: #333; }';
            html += '.col-qty { font-size: 16px; color: #c00; text-align: center; }';
            html += '.col-batch { font-size: 12px; font-weight: normal; color: #666; }';
            html += '.col-exp { font-size: 12px; font-weight: normal; color: #666; }';
            html += '.chk { width: 18px; height: 18px; border: 2px solid #000; display: inline-block; }';
            html += '.sign-row { margin-top: 20px; display: flex; gap: 60px; justify-content: center; }';
            html += '.sign-item { display: flex; align-items: center; gap: 10px; font-size: 14px; }';
            html += '.sign-line { border-bottom: 1px solid #000; width: 100px; height: 25px; }';
            html += '</style>';

            html += '<div class="header">';
            html += '<div class="title">å…¥åº«åŸ·è¡Œæ¸…å–®</div>';
            html += '<div class="meta">' + new Date().toLocaleString() + 'ã€€å…± ' + orders.length + ' ç­†</div>';
            html += '</div>';

            html += '<table><thead><tr>';
            html += '<th class="c">âœ“</th>';
            html += '<th class="c">å„²ä½</th>';
            html += '<th>å“å</th>';
            html += '<th>è¦æ ¼</th>';
            html += '<th class="c">æ•¸é‡</th>';
            html += '<th>æ‰¹è™Ÿ</th>';
            html += '<th>æ•ˆæœŸ</th>';
            html += '</tr></thead><tbody>';

            orders.forEach(function(order) {
                html += '<tr>';
                html += '<td class="col-chk"><div class="chk"></div></td>';
                html += '<td class="col-loc">' + order.locationId + '</td>';
                html += '<td class="col-name">' + order.productName + '</td>';
                html += '<td class="col-spec">' + (order.spec || '-') + '</td>';
                html += '<td class="col-qty">' + order.quantity + '</td>';
                html += '<td class="col-batch">' + (order.batchNo || '-') + '</td>';
                html += '<td class="col-exp">' + (order.expDate || '-') + '</td>';
                html += '</tr>';
            });

            html += '</tbody></table>';

            html += '<div class="sign-row">';
            html += '<div class="sign-item">åŸ·è¡Œï¼š<div class="sign-line"></div></div>';
            html += '<div class="sign-item">æ™‚é–“ï¼š<div class="sign-line"></div></div>';
            html += '<div class="sign-item">ç¢ºèªï¼š<div class="sign-line"></div></div>';
            html += '</div>';

            openPrintPreview(html, 'å…¥åº«åŸ·è¡Œæ¸…å–®', 1000, 800);
        };

        window.confirmSelectedInbounds = async function() {
            var checkboxes = document.querySelectorAll('.inbound-checkbox:checked');
            if (checkboxes.length === 0) {
                alert('è«‹å‹¾é¸è¦ç¢ºèªçš„å…¥åº«å–®');
                return;
            }

            if (!confirm('ç¢ºèªå°‡ ' + checkboxes.length + ' ç­†å…¥åº«å–®å…¥å¸³ï¼Ÿ')) {
                return;
            }

            var success = 0;
            var fail = 0;

            for (var i = 0; i < checkboxes.length; i++) {
                var cb = checkboxes[i];
                var idx = parseInt(cb.dataset.idx);
                var order = window.pendingInbounds[idx];

                if (order) {
                    var result = await executeInbound(order, true);
                    if (result) success++;
                    else fail++;
                }
            }

            alert('âœ… æ‰¹æ¬¡å…¥å¸³å®Œæˆ\næˆåŠŸï¼š' + success + ' ç­†\nå¤±æ•—ï¼š' + fail + ' ç­†');
            loadPendingInbounds();
        };

        async function executeInbound(order, silent) {
            try {
                await window.addDoc(window.collection(window.db, 'pallets'), {
                    palletId: order.docNo,
                    productName: order.productName,
                    spec: order.spec || '',
                    batchNo: order.batchNo || '',
                    expDate: order.expDate,
                    expiryDate: order.expDate,
                    quantity: order.quantity,
                    locationId: order.locationId,
                    category: order.type,
                    vendor: order.vendor || '',
                    source: 'Inbound',
                    inboundDate: new Date().toISOString(),
                    createdAt: new Date().toISOString(),
                    status: 'Available'
                });

                await window.logInventoryChange({
                    type: 'inbound',
                    productName: order.productName,
                    spec: order.spec || '',
                    quantity: order.quantity,
                    quantityChange: order.quantity,
                    locationId: order.locationId,
                    batchNo: order.batchNo || '',
                    palletId: order.docNo,
                    expDate: order.expDate,
                    note: 'å…¥åº« - ' + (order.vendor || ''),
                    orderId: order.id
                });

                await window.updateDoc(window.doc(window.db, 'inboundOrders', order.id), {
                    status: 'completed',
                    completedAt: new Date().toISOString(),
                    completedBy: window.currentUser ? window.currentUser.email : 'admin'
                });

                if (!silent) {
                    alert('âœ… å…¥å¸³æˆåŠŸï¼\n\nå„²ä½ï¼š' + order.locationId + '\nå“åï¼š' + order.productName);
                    loadPendingInbounds();
                }

                return true;
            } catch(e) {
                if (!silent) {
                    alert('âŒ å…¥å¸³å¤±æ•—ï¼š' + e.message);
                }
                return false;
            }
        }

        window.publishInboundTask = async function(order) {
            try {
                await window.addDoc(window.collection(window.db, 'inboundTasks'), {
                    orderNo: order.docNo,
                    palletId: order.docNo,
                    productName: order.productName,
                    spec: order.spec || '',
                    batchNo: order.batchNo || '',
                    quantity: order.quantity,
                    locationId: order.locationId,
                    status: 'pending',
                    createdAt: new Date().toISOString(),
                    createdBy: window.getOperatorName ? window.getOperatorName() : 'system'
                });
                return true;
            } catch (err) {
                console.error('ç™¼å¸ƒå…¥åº«ä»»å‹™å¤±æ•—:', err);
                return false;
            }
        };

        setTimeout(function() { updatePendingInboundCount(); }, 2000);

        window.validateLocationInput = function() {
            var input = document.getElementById('in-loc');
            var value = input.value.trim().toUpperCase();
            input.value = value;

            var valid = /^[IJK]-[A-H]-\d{2}-[123]F$/.test(value);

            if (value && valid) {
                input.classList.remove('border-red-500');
                input.classList.add('border-emerald-500/50');
                updateLivePreview();
            } else if (value && !valid) {
                input.classList.remove('border-emerald-500/50');
                input.classList.add('border-red-500');
            }
        };

        // ========== å€‰åº«èª¿æ’¥åŠŸèƒ½ï¼ˆæ–°ç‰ˆï¼‰==========

        window.transferState = {
            company: 'å´‡æ–‡',      // ç›®å‰é¸æ“‡çš„å…¬å¸
            mode: 'in',           // èª¿æ’¥æ¨¡å¼: 'in'=èª¿æ’¥å…¥åº«, 'out'=èª¿æ’¥å‡ºåº«, 'ext'=å¤–åº«èª¿æ’¥
            selectedItem: null,   // é¸ä¸­çš„å“é …
            locationItems: []     // å„²ä½åˆ—è¡¨ï¼ˆèª¿æ’¥å‡ºåº«ç”¨ï¼‰
        };

        window.setTransferCompany = function(company) {
            window.transferState.company = company;

            document.getElementById('btn-transfer-cw').className = company === 'å´‡æ–‡'
                ? 'px-3 py-1.5 rounded font-bold text-xs bg-blue-600 text-white'
                : 'px-3 py-1.5 rounded font-bold text-xs bg-slate-700 text-slate-300 hover:bg-slate-600';
            document.getElementById('btn-transfer-bf').className = company === 'å…«æ–¹'
                ? 'px-3 py-1.5 rounded font-bold text-xs bg-blue-600 text-white'
                : 'px-3 py-1.5 rounded font-bold text-xs bg-slate-700 text-slate-300 hover:bg-slate-600';

            updateTransferWarehouseOptions();
            clearTransferForm();
        };

        window.setTransferMode = function(mode) {
            window.transferState.mode = mode;

            var modes = ['in', 'out', 'ext'];
            var colors = { 'in': 'bg-emerald-600', 'out': 'bg-orange-600', 'ext': 'bg-purple-600' };
            modes.forEach(function(m) {
                var btn = document.getElementById('btn-mode-' + m);
                btn.className = m === mode
                    ? 'px-3 py-1.5 rounded font-bold text-xs ' + colors[m] + ' text-white'
                    : 'px-3 py-1.5 rounded font-bold text-xs bg-slate-700 text-slate-300 hover:bg-slate-600';
            });

            var titleEl = document.getElementById('transfer-form-title');
            var descEl = document.getElementById('transfer-mode-desc');
            var sourceLabelEl = document.getElementById('transfer-source-label');
            var targetDiv = document.getElementById('transfer-target-div');
            var locationDiv = document.getElementById('transfer-location-div');
            var inOptionsDiv = document.getElementById('transfer-in-options');

            if (mode === 'in') {
                titleEl.innerHTML = '<i class="fa-solid fa-truck-arrow-right mr-2 text-emerald-400"></i>èª¿æ’¥å…¥åº«ï¼ˆå¤–å€‰â†’æœ¬å€‰ï¼‰';
                descEl.innerHTML = '<span class="text-emerald-400"><i class="fa-solid fa-info-circle mr-1"></i>å¤–å€‰ â†’ å¾…åŸ·è¡Œå·¥å–® æˆ– æš«å­˜å€</span>';
                sourceLabelEl.textContent = 'ä¾†æºå¤–å€‰ *';
                targetDiv.style.display = 'none';
                locationDiv.style.display = 'none';
                if (inOptionsDiv) inOptionsDiv.style.display = 'block';
            } else if (mode === 'out') {
                titleEl.innerHTML = '<i class="fa-solid fa-truck-arrow-right mr-2 text-orange-400"></i>èª¿æ’¥å‡ºåº«ï¼ˆæœ¬å€‰â†’å¤–å€‰ï¼‰';
                descEl.innerHTML = '<span class="text-orange-400"><i class="fa-solid fa-info-circle mr-1"></i>æœ¬å€‰å„²ä½ â†’ å‡ºè²¨æš«å­˜å€ â†’ å¤–å€‰</span>';
                sourceLabelEl.textContent = 'ç›®æ¨™å¤–å€‰ *';
                targetDiv.style.display = 'none';
                locationDiv.style.display = 'block';
                if (inOptionsDiv) inOptionsDiv.style.display = 'none';
            } else {
                titleEl.innerHTML = '<i class="fa-solid fa-arrows-left-right mr-2 text-purple-400"></i>å¤–åº«èª¿æ’¥ï¼ˆå¤–å€‰â†’å¤–å€‰ï¼‰';
                descEl.innerHTML = '<span class="text-purple-400"><i class="fa-solid fa-info-circle mr-1"></i>å¤–å€‰ä¹‹é–“ç›´æ¥èª¿æ’¥ï¼ˆæ•¸é‡å¢æ¸›ï¼‰</span>';
                sourceLabelEl.textContent = 'ä¾†æºå¤–å€‰ *';
                targetDiv.style.display = 'block';
                locationDiv.style.display = 'none';
                if (inOptionsDiv) inOptionsDiv.style.display = 'none';
            }

            updateTransferWarehouseOptions();
            clearTransferForm();
        };

        function updateTransferWarehouseOptions() {
            var company = window.transferState.company;
            var mode = window.transferState.mode;
            var sourceSelect = document.getElementById('transfer-source');
            var targetSelect = document.getElementById('transfer-target');

            var warehouses = window.warehousesData.filter(function(w) {
                return w.company === company && w.active !== false;
            }).sort(function(a, b) { return (a.sortOrder || 99) - (b.sortOrder || 99); });

            var sourceHtml = '<option value="">é¸æ“‡å¤–å€‰</option>';
            warehouses.forEach(function(w) {
                var icon = w.icon === 'store' ? 'ğŸª' : 'ğŸ¢';
                sourceHtml += '<option value="' + w.code + '">' + icon + ' ' + w.name + '</option>';
            });
            sourceSelect.innerHTML = sourceHtml;

            if (mode === 'ext') {
                var targetHtml = '<option value="">é¸æ“‡å¤–å€‰</option>';
                warehouses.forEach(function(w) {
                    var icon = w.icon === 'store' ? 'ğŸª' : 'ğŸ¢';
                    targetHtml += '<option value="' + w.code + '">' + icon + ' ' + w.name + '</option>';
                });
                targetSelect.innerHTML = targetHtml;
            }
        }

        window.onTransferSourceChange = function() {
            clearTransferForm();
        };

        window.onTransferLocationChange = function() {
            var locId = document.getElementById('transfer-location').value;
            if (!locId) {
                document.getElementById('transfer-available').innerText = '0';
                return;
            }

            var item = window.transferState.locationItems.find(function(i) { return i.locationId === locId; });
            if (item) {
                document.getElementById('transfer-available').innerText = item.quantity;
                window.transferState.selectedItem = item;
            }
        };

        function clearTransferForm() {
            document.getElementById('transfer-product').value = '';
            document.getElementById('transfer-spec').value = '';
            document.getElementById('transfer-batch').value = '';
            document.getElementById('transfer-exp').value = '';
            document.getElementById('transfer-available').innerText = '0';
            document.getElementById('transfer-qty').value = '';
            document.getElementById('transfer-product-list').innerHTML = '';
            document.getElementById('transfer-location').innerHTML = '<option value="">é¸æ“‡å„²ä½</option>';
            window.transferState.selectedItem = null;
            window.transferState.locationItems = [];
        }

        window.searchTransferProduct = function() {
            var mode = window.transferState.mode;
            var company = window.transferState.company;
            var keyword = document.getElementById('transfer-product').value.trim().toLowerCase();
            var listDiv = document.getElementById('transfer-product-list');

            if (keyword.length < 1) { listDiv.innerHTML = ''; return; }

            var source = [];

            if (mode === 'out') {
                source = window.inventory.filter(function(p) {
                    return p.company === company && p.productName && p.productName.toLowerCase().includes(keyword);
                });

                var grouped = {};
                source.forEach(function(p) {
                    var key = p.productName + '|' + (p.spec || '') + '|' + (p.batchNo || '');
                    if (!grouped[key]) {
                        grouped[key] = {
                            productName: p.productName,
                            spec: p.spec || '',
                            batchNo: p.batchNo || '',
                            expiryDate: p.expiryDate || '',
                            totalQty: 0,
                            items: []
                        };
                    }
                    grouped[key].totalQty += (p.quantity || 0);
                    grouped[key].items.push(p);
                });
                source = Object.values(grouped);

            } else {
                var warehouseId = document.getElementById('transfer-source').value;
                if (!warehouseId) {
                    listDiv.innerHTML = '<div class="text-slate-500 text-xs p-2">è«‹å…ˆé¸æ“‡å¤–å€‰</div>';
                    return;
                }

                source = window.externalStock.filter(function(s) {
                    return s.warehouseId === warehouseId && s.company === company &&
                           s.productName && s.productName.toLowerCase().includes(keyword);
                });
            }

            if (source.length === 0) {
                listDiv.innerHTML = '<div class="text-slate-500 text-xs p-2">ç„¡ç¬¦åˆé …ç›®</div>';
                return;
            }

            var html = '';
            source.slice(0, 10).forEach(function(s, idx) {
                var qty = mode === 'out' ? s.totalQty : s.quantity;
                html += '<div class="p-2 hover:bg-slate-700 cursor-pointer text-sm border-b border-slate-700" onclick="selectTransferProduct(' + idx + ')">';
                html += '<div class="text-white font-bold">' + s.productName + '</div>';
                html += '<div class="text-xs text-slate-400">' + (s.spec || '-') + ' | æ‰¹è™Ÿï¼š' + (s.batchNo || '-') + ' | æ•¸é‡ï¼š<span class="text-yellow-400">' + qty + '</span></div>';
                html += '</div>';
            });

            listDiv.innerHTML = html;
            window._transferSearchResults = source.slice(0, 10);
        };

        window.selectTransferProduct = function(idx) {
            var item = window._transferSearchResults[idx];
            var mode = window.transferState.mode;

            document.getElementById('transfer-product').value = item.productName;
            document.getElementById('transfer-spec').value = item.spec || '';
            document.getElementById('transfer-batch').value = item.batchNo || '';
            document.getElementById('transfer-exp').value = item.expiryDate || item.expDate || '';
            document.getElementById('transfer-product-list').innerHTML = '';

            if (mode === 'out') {
                var locationSelect = document.getElementById('transfer-location');
                var html = '<option value="">é¸æ“‡å„²ä½</option>';

                item.items.forEach(function(p) {
                    html += '<option value="' + p.locationId + '">' + p.locationId + ' (æ•¸é‡: ' + p.quantity + ')</option>';
                });

                locationSelect.innerHTML = html;
                window.transferState.locationItems = item.items;
                document.getElementById('transfer-available').innerText = '0';
                window.transferState.selectedItem = null;
            } else {
                document.getElementById('transfer-available').innerText = item.quantity;
                window.transferState.selectedItem = item;
            }
        };

        window.addTransferItem = function() {
            var mode = window.transferState.mode;
            var company = window.transferState.company;
            var source = document.getElementById('transfer-source').value;
            var target = document.getElementById('transfer-target').value;
            var product = document.getElementById('transfer-product').value.trim();
            var spec = document.getElementById('transfer-spec').value;
            var batch = document.getElementById('transfer-batch').value;
            var exp = document.getElementById('transfer-exp').value;
            var qty = parseInt(document.getElementById('transfer-qty').value) || 0;
            var location = document.getElementById('transfer-location').value;

            if (mode === 'in') {
                if (!source) { alert('è«‹é¸æ“‡ä¾†æºå¤–å€‰'); return; }
            } else if (mode === 'out') {
                if (!source) { alert('è«‹é¸æ“‡ç›®æ¨™å¤–å€‰'); return; }
                if (!location) { alert('è«‹é¸æ“‡ä¾†æºå„²ä½'); return; }
            } else {
                if (!source) { alert('è«‹é¸æ“‡ä¾†æºå¤–å€‰'); return; }
                if (!target) { alert('è«‹é¸æ“‡ç›®æ¨™å¤–å€‰'); return; }
                if (source === target) { alert('ä¾†æºå’Œç›®æ¨™ä¸èƒ½ç›¸åŒ'); return; }
            }

            if (!product) { alert('è«‹é¸æ“‡ç”¢å“'); return; }
            if (qty <= 0) { alert('è«‹è¼¸å…¥æœ‰æ•ˆæ•¸é‡'); return; }

            var available = parseInt(document.getElementById('transfer-available').innerText) || 0;
            if (qty > available) { alert('èª¿æ’¥æ•¸é‡ä¸èƒ½è¶…éå¯ç”¨æ•¸é‡ (' + available + ')'); return; }

            var getWhName = function(code) {
                var wh = window.warehousesData.find(function(w) { return w.code === code; });
                return wh ? wh.name : code;
            };

            var transferItem = {
                mode: mode,
                company: company,
                productName: product,
                spec: spec,
                batchNo: batch,
                expDate: exp,
                quantity: qty,
                sourceItem: window.transferState.selectedItem
            };

            if (mode === 'in') {
                transferItem.fromWh = source;
                transferItem.fromName = getWhName(source);
                transferItem.toWh = 'TEMP-IN';
                transferItem.toName = 'é€²è²¨æš«å­˜å€';
            } else if (mode === 'out') {
                transferItem.fromWh = location;
                transferItem.fromName = location;
                transferItem.toWh = source;  // source åœ¨æ­¤æ¨¡å¼æ˜¯ç›®æ¨™å¤–å€‰
                transferItem.toName = getWhName(source);
                transferItem.tempLocation = 'TEMP-OUT';
            } else {
                transferItem.fromWh = source;
                transferItem.fromName = getWhName(source);
                transferItem.toWh = target;
                transferItem.toName = getWhName(target);
            }

            window.transferList.push(transferItem);
            renderTransferList();

            document.getElementById('transfer-product').value = '';
            document.getElementById('transfer-spec').value = '';
            document.getElementById('transfer-batch').value = '';
            document.getElementById('transfer-exp').value = '';
            document.getElementById('transfer-available').innerText = '0';
            document.getElementById('transfer-qty').value = '';
            document.getElementById('transfer-location').innerHTML = '<option value="">é¸æ“‡å„²ä½</option>';
            window.transferState.selectedItem = null;
        };

        function renderTransferList() {
            var tbody = document.getElementById('transfer-list');

            if (window.transferList.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-slate-500 py-10">å°šæœªåŠ å…¥èª¿æ’¥å“é …</td></tr>';
                document.getElementById('btn-execute-transfer').disabled = true;
                return;
            }

            var html = '';
            window.transferList.forEach(function(t, idx) {
                var expClass = '';
                if (t.expDate) {
                    var exp = new Date(t.expDate);
                    var now = new Date();
                    var days = Math.floor((exp - now) / 86400000);
                    if (days < 0) expClass = 'text-red-400';
                    else if (days < 30) expClass = 'text-orange-400';
                    else if (days < 90) expClass = 'text-yellow-400';
                }

                var modeLabel = t.mode === 'in' ? '<span class="text-emerald-400 text-xs">å…¥åº«</span>'
                              : t.mode === 'out' ? '<span class="text-orange-400 text-xs">å‡ºåº«</span>'
                              : '<span class="text-purple-400 text-xs">å¤–èª¿</span>';

                html += '<tr class="border-b border-slate-700">';
                html += '<td class="p-2"><div class="text-white font-bold">' + t.productName + '</div>' + modeLabel + '</td>';
                html += '<td class="p-2 text-slate-400">' + (t.spec || '-') + '</td>';
                html += '<td class="p-2 text-slate-400">' + (t.batchNo || '-') + '</td>';
                html += '<td class="p-2 ' + expClass + '">' + (t.expDate || '-') + '</td>';
                html += '<td class="p-2"><span class="px-2 py-1 rounded text-xs bg-blue-900 text-blue-300">' + t.fromName + '</span></td>';
                html += '<td class="p-2"><span class="px-2 py-1 rounded text-xs bg-emerald-900 text-emerald-300">' + t.toName + '</span></td>';
                html += '<td class="p-2 text-right text-yellow-400 font-bold">' + t.quantity + '</td>';
                html += '<td class="p-2 text-center"><button onclick="removeTransferItem(' + idx + ')" class="text-red-400 hover:text-red-300"><i class="fa-solid fa-times"></i></button></td>';
                html += '</tr>';
            });

            tbody.innerHTML = html;
            document.getElementById('btn-execute-transfer').disabled = false;
        }

        window.removeTransferItem = function(idx) {
            window.transferList.splice(idx, 1);
            renderTransferList();
        };

        window.clearTransferList = function() {
            window.transferList = [];
            renderTransferList();
        };

        window.executeTransfer = async function() {
            if (window.transferList.length === 0) { alert('èª¿æ’¥æ¸…å–®ç‚ºç©º'); return; }

            var transferInMethod = 'pending'; // é è¨­ç”¢ç”Ÿå¾…åŸ·è¡Œå·¥å–®
            var methodRadio = document.querySelector('input[name="transfer-in-method"]:checked');
            if (methodRadio) transferInMethod = methodRadio.value;

            var confirmMsg = 'ç¢ºèªåŸ·è¡Œ ' + window.transferList.length + ' ç­†èª¿æ’¥ï¼Ÿ';
            if (window.transferList[0] && window.transferList[0].mode === 'in') {
                if (transferInMethod === 'pending') {
                    confirmMsg += '\n\nğŸ“‹ è™•ç†æ–¹å¼ï¼šç”¢ç”Ÿå¾…åŸ·è¡Œå·¥å–®\nï¼ˆå°‡æ¨é€åˆ°æ™ºèƒ½å…¥åº«ä¸­å¿ƒï¼‰';
                } else {
                    confirmMsg += '\n\nğŸ“¦ è™•ç†æ–¹å¼ï¼šç›´æ¥å…¥æš«å­˜å€\nï¼ˆTEMP-INï¼Œéœ€æ‰‹å‹•ç§»ä½ï¼‰';
                }
            }

            if (!confirm(confirmMsg)) return;

            try {
                var logPromises = [];
                var pendingCount = 0;
                var tempCount = 0;

                for (var i = 0; i < window.transferList.length; i++) {
                    var t = window.transferList[i];

                    if (t.mode === 'in') {
                        // ========== èª¿æ’¥å…¥åº« ==========
                        var extItem = window.externalStock.find(function(s) {
                            return s.warehouseId === t.fromWh && s.productName === t.productName &&
                                   s.batchNo === t.batchNo && s.company === t.company;
                        });
                        if (extItem) {
                            var newQty = extItem.quantity - t.quantity;
                            var extRef = window.doc(window.db, 'externalStock', extItem.id);
                            if (newQty <= 0) {
                                await window.deleteDoc(extRef);
                            } else {
                                await window.updateDoc(extRef, { quantity: newQty });
                            }
                        }

                        if (transferInMethod === 'pending') {
                            // ===== æ–¹å¼Aï¼šç”¢ç”Ÿå¾…åŸ·è¡Œå·¥å–® =====
                            var orderNo = 'TRI-' + Date.now() + '-' + i;
                            await window.addDoc(window.collection(window.db, 'inboundOrders'), {
                                docNo: orderNo,          // å–®æ“šç·¨è™Ÿ
                                orderNo: orderNo,
                                productName: t.productName,
                                spec: t.spec || '',
                                batchNo: t.batchNo || '',
                                expDate: t.expDate || '',
                                expiryDate: t.expDate || '',
                                quantity: t.quantity,
                                company: t.company,
                                category: 'Transfer',    // èª¿æ’¥å…¥åº«é¡å‹
                                typeName: 'èª¿æ’¥å…¥åº«',    // é¡å‹åç¨±
                                locationId: 'å¾…æŒ‡å®š',    // å¾…é¸æ“‡å„²ä½
                                vendor: t.fromName,      // ä¾†æºå€‰åº«ç•¶ä½œå» å•†
                                status: 'pending',
                                source: 'èª¿æ’¥å…¥åº«',
                                sourceWarehouse: t.fromWh,
                                sourceWarehouseName: t.fromName,
                                createdAt: new Date().toISOString()
                            });
                            pendingCount++;

                            logPromises.push(window.logInventoryChange({
                                type: 'transfer-in',
                                productName: t.productName,
                                spec: t.spec || '',
                                quantity: t.quantity,
                                fromLocation: t.fromWh,
                                toLocation: 'å¾…åŸ·è¡Œå·¥å–®',
                                batchNo: t.batchNo || '',
                                company: t.company,
                                note: 'èª¿æ’¥å…¥åº«(å·¥å–®): ' + t.fromName + ' â†’ å¾…å…¥åº«'
                            }));

                        } else {
                            // ===== æ–¹å¼Bï¼šç›´æ¥å…¥æš«å­˜å€ =====
                            await window.addDoc(window.collection(window.db, 'pallets'), {
                                palletId: 'TRI-' + Date.now() + '-' + i,
                                productName: t.productName,
                                spec: t.spec || '',
                                batchNo: t.batchNo || '',
                                expiryDate: t.expDate || '',
                                quantity: t.quantity,
                                totalWeight: 0,
                                locationId: 'TEMP-IN',
                                company: t.company,
                                source: 'èª¿æ’¥å…¥åº«',
                                sourceWarehouse: t.fromName,
                                createdAt: new Date().toISOString()
                            });
                            tempCount++;

                            logPromises.push(window.logInventoryChange({
                                type: 'transfer-in',
                                productName: t.productName,
                                spec: t.spec || '',
                                quantity: t.quantity,
                                fromLocation: t.fromWh,
                                toLocation: 'TEMP-IN',
                                batchNo: t.batchNo || '',
                                company: t.company,
                                note: 'èª¿æ’¥å…¥åº«: ' + t.fromName + ' â†’ é€²è²¨æš«å­˜å€'
                            }));
                        }

                    } else if (t.mode === 'out') {
                        // ========== èª¿æ’¥å‡ºåº«ï¼ˆæœ¬å€‰å„²ä½â†’å‡ºè²¨æš«å­˜å€â†’å¤–å€‰ï¼‰==========
                        var srcItem = t.sourceItem;
                        if (srcItem && srcItem.id) {
                            var newQty = srcItem.quantity - t.quantity;
                            var srcRef = window.doc(window.db, 'pallets', srcItem.id);
                            if (newQty <= 0) {
                                await window.deleteDoc(srcRef);
                            } else {
                                await window.updateDoc(srcRef, { quantity: newQty });
                            }
                        }

                        await window.addDoc(window.collection(window.db, 'pallets'), {
                            palletId: 'TRO-' + Date.now() + '-' + i,
                            productName: t.productName,
                            spec: t.spec || '',
                            batchNo: t.batchNo || '',
                            expiryDate: t.expDate || '',
                            quantity: t.quantity,
                            totalWeight: 0,
                            locationId: 'TEMP-OUT',
                            company: t.company,
                            source: 'èª¿æ’¥å‡ºåº«',
                            targetWarehouse: t.toName,
                            targetWarehouseId: t.toWh,
                            createdAt: new Date().toISOString()
                        });

                        var existExt = window.externalStock.find(function(s) {
                            return s.warehouseId === t.toWh && s.productName === t.productName &&
                                   s.batchNo === t.batchNo && s.company === t.company;
                        });
                        if (existExt) {
                            var extRef = window.doc(window.db, 'externalStock', existExt.id);
                            await window.updateDoc(extRef, { quantity: existExt.quantity + t.quantity });
                        } else {
                            await window.addDoc(window.collection(window.db, 'externalStock'), {
                                warehouseId: t.toWh,
                                productName: t.productName,
                                spec: t.spec || '',
                                batchNo: t.batchNo || '',
                                expDate: t.expDate || '',
                                quantity: t.quantity,
                                company: t.company,
                                source: 'èª¿æ’¥å‡ºåº«',
                                createdAt: new Date().toISOString()
                            });
                        }

                        logPromises.push(window.logInventoryChange({
                            type: 'transfer-out',
                            productName: t.productName,
                            spec: t.spec || '',
                            quantity: t.quantity,
                            fromLocation: t.fromWh,
                            toLocation: t.toWh,
                            batchNo: t.batchNo || '',
                            company: t.company,
                            note: 'èª¿æ’¥å‡ºåº«: ' + t.fromName + ' â†’ ' + t.toName
                        }));

                    } else {
                        // ========== å¤–åº«èª¿æ’¥ï¼ˆå¤–å€‰â†’å¤–å€‰ï¼‰==========
                        var srcExt = window.externalStock.find(function(s) {
                            return s.warehouseId === t.fromWh && s.productName === t.productName &&
                                   s.batchNo === t.batchNo && s.company === t.company;
                        });
                        if (srcExt) {
                            var newQty = srcExt.quantity - t.quantity;
                            var srcRef = window.doc(window.db, 'externalStock', srcExt.id);
                            if (newQty <= 0) {
                                await window.deleteDoc(srcRef);
                            } else {
                                await window.updateDoc(srcRef, { quantity: newQty });
                            }
                        }

                        var dstExt = window.externalStock.find(function(s) {
                            return s.warehouseId === t.toWh && s.productName === t.productName &&
                                   s.batchNo === t.batchNo && s.company === t.company;
                        });
                        if (dstExt) {
                            var dstRef = window.doc(window.db, 'externalStock', dstExt.id);
                            await window.updateDoc(dstRef, { quantity: dstExt.quantity + t.quantity });
                        } else {
                            await window.addDoc(window.collection(window.db, 'externalStock'), {
                                warehouseId: t.toWh,
                                productName: t.productName,
                                spec: t.spec || '',
                                batchNo: t.batchNo || '',
                                expDate: t.expDate || '',
                                quantity: t.quantity,
                                company: t.company,
                                source: 'å¤–åº«èª¿æ’¥',
                                createdAt: new Date().toISOString()
                            });
                        }

                        logPromises.push(window.logInventoryChange({
                            type: 'transfer-ext',
                            productName: t.productName,
                            spec: t.spec || '',
                            quantity: t.quantity,
                            fromLocation: t.fromWh,
                            toLocation: t.toWh,
                            batchNo: t.batchNo || '',
                            company: t.company,
                            note: 'å¤–åº«èª¿æ’¥: ' + t.fromName + ' â†’ ' + t.toName
                        }));
                    }
                }

                await Promise.all(logPromises);

                var successMsg = 'âœ… èª¿æ’¥å®Œæˆï¼å…± ' + window.transferList.length + ' ç­†';
                if (pendingCount > 0) {
                    successMsg += '\nğŸ“‹ ' + pendingCount + ' ç­†å·²åŠ å…¥å¾…åŸ·è¡Œå·¥å–®';
                    showNotification('âœ… èª¿æ’¥å®Œæˆï¼' + pendingCount + ' ç­†å·²åŠ å…¥å¾…åŸ·è¡Œå·¥å–®ï¼Œè«‹è‡³æ™ºèƒ½å…¥åº«ä¸­å¿ƒè™•ç†', 'success');
                } else if (tempCount > 0) {
                    successMsg += '\nğŸ“¦ ' + tempCount + ' ç­†å·²å…¥é€²è²¨æš«å­˜å€';
                    showNotification('âœ… èª¿æ’¥å®Œæˆï¼' + tempCount + ' ç­†å·²å…¥æš«å­˜å€(TEMP-IN)ï¼Œè«‹ç§»ä½ä¸Šæ¶', 'success');
                } else {
                    showNotification('âœ… èª¿æ’¥å®Œæˆï¼å…± ' + window.transferList.length + ' ç­†', 'success');
                }

                window.transferList = [];
                renderTransferList();

                await loadExternalStock();
                if (typeof fetchInventory === 'function') fetchInventory();

                if (pendingCount > 0 && typeof loadPendingInbounds === 'function') {
                    loadPendingInbounds();
                }

            } catch(e) {
                console.error('èª¿æ’¥å¤±æ•—:', e);
                alert('âŒ èª¿æ’¥å¤±æ•—ï¼š' + e.message);
            }
        };

        window.initTransferPage = function() {
            setTransferCompany('å´‡æ–‡');
            setTransferMode('in');
        };

        // ========== æ¬Šé™ç®¡ç†ç³»çµ±ï¼ˆFirebase ç‰ˆï¼‰==========

        window.showToast = function(message, duration) {
            duration = duration || 3000;
            var toast = document.createElement('div');
            toast.style.cssText = 'position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:#1e293b;border:1px solid #334155;color:#e2e8f0;padding:12px 24px;border-radius:8px;z-index:10000;font-size:14px;box-shadow:0 4px 12px rgba(0,0,0,0.3);animation:fadeIn 0.3s ease;';
            toast.innerHTML = message;
            document.body.appendChild(toast);
            setTimeout(function() {
                toast.style.animation = 'fadeOut 0.3s ease';
                setTimeout(function() { toast.remove(); }, 300);
            }, duration);
        };

        // ========== æ¨™ç±¤åˆ—å°åŠŸèƒ½ ==========
        var selectedLocZone = '';
        var reprintPalletData = null;
        var reprintHistory = [];

        window.selectLocZone = function(zone) {
            selectedLocZone = zone;
            document.querySelectorAll('.loc-zone-btn').forEach(function(btn) {
                btn.classList.remove('ring-2', 'ring-white');
            });
            document.querySelector('.loc-zone-btn[data-zone="' + zone + '"]').classList.add('ring-2', 'ring-white');
            updateLocPrintPreview();
        };

        function updateLocPrintPreview() {
            var countEl = document.getElementById('loc-print-count');
            var previewEl = document.getElementById('loc-print-preview');

            if (!selectedLocZone) {
                if (previewEl) previewEl.innerHTML = '<span class="text-slate-500">è«‹é¸æ“‡å€‰åº«å€åŸŸ</span>';
                if (countEl) countEl.textContent = '0 å¼µ';
                return;
            }

            var startRow = parseInt(document.getElementById('loc-row-start').value) || 1;
            var endRow = parseInt(document.getElementById('loc-row-end').value) || 22;
            var floors = [];
            if (document.getElementById('loc-floor-1f').checked) floors.push('1F');
            if (document.getElementById('loc-floor-2f').checked) floors.push('2F');
            if (document.getElementById('loc-floor-3f').checked) floors.push('3F');

            var count = (endRow - startRow + 1) * floors.length;

            if (countEl) countEl.textContent = count + ' å¼µ';

            var preview = '<div class="flex items-center gap-3">';
            preview += '<span class="text-lg font-bold text-blue-400">' + selectedLocZone + '</span>';
            preview += '<span class="text-slate-400">æ’ ' + startRow.toString().padStart(2, '0') + '-' + endRow.toString().padStart(2, '0') + '</span>';
            preview += '<span class="text-slate-400">' + floors.join('/') + '</span>';
            preview += '</div>';
            preview += '<div class="text-xs text-slate-500 mt-1">ç¯„ä¾‹ï¼š' + selectedLocZone + '-' + startRow.toString().padStart(2, '0') + '-' + floors[0] + '</div>';

            if (previewEl) previewEl.innerHTML = preview;
        }

        document.addEventListener('DOMContentLoaded', function() {
            var rowStart = document.getElementById('loc-row-start');
            var rowEnd = document.getElementById('loc-row-end');
            if (rowStart) rowStart.addEventListener('change', updateLocPrintPreview);
            if (rowEnd) rowEnd.addEventListener('change', updateLocPrintPreview);
            ['loc-floor-1f', 'loc-floor-2f', 'loc-floor-3f'].forEach(function(id) {
                var el = document.getElementById(id);
                if (el) el.addEventListener('change', updateLocPrintPreview);
            });
        });

        window.printLocationLabels = function() {
            if (!selectedLocZone) {
                alert('è«‹å…ˆé¸æ“‡å€‰åº«å€åŸŸ');
                return;
            }

            var startRow = parseInt(document.getElementById('loc-row-start').value) || 1;
            var endRow = parseInt(document.getElementById('loc-row-end').value) || 22;
            var floors = [];
            if (document.getElementById('loc-floor-1f').checked) floors.push('1F');
            if (document.getElementById('loc-floor-2f').checked) floors.push('2F');
            if (document.getElementById('loc-floor-3f').checked) floors.push('3F');

            if (floors.length === 0) {
                alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹æ¨“å±¤');
                return;
            }

            var labels = [];
            for (var row = startRow; row <= endRow; row++) {
                floors.forEach(function(floor) {
                    var rowStr = row.toString().padStart(2, '0');
                    labels.push({
                        locationId: selectedLocZone + '-' + rowStr + '-' + floor,
                        zone: selectedLocZone,
                        row: rowStr,
                        floor: floor
                    });
                });
            }

            var html = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>å„²ä½æ¢ç¢¼</title>';
            html += '<style>';
            html += '@page { size: 60mm 40mm; margin: 0; }';
            html += '* { margin: 0; padding: 0; box-sizing: border-box; }';
            html += 'body { font-family: Microsoft JhengHei, Arial, sans-serif; }';
            html += '.label { width: 60mm; height: 40mm; padding: 3mm; page-break-after: always; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 1px dashed #ccc; }';
            html += '.label:last-child { page-break-after: auto; }';
            html += '.loc-text { font-size: 24px; font-weight: 900; margin-bottom: 2mm; letter-spacing: 1px; }';
            html += '.qr-box { margin: 2mm 0; }';
            html += '.no-print { text-align: center; padding: 20px; }';
            html += '.no-print button { padding: 15px 40px; font-size: 18px; border: none; cursor: pointer; font-weight: bold; margin: 0 10px; border-radius: 8px; }';
            html += '.btn-print { background: #3b82f6; color: white; }';
            html += '.btn-close { background: #666; color: white; }';
            html += '@media print { .no-print { display: none !important; } }';
            html += '</style>';
            html += '<script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"><\/script>';
            html += '</head><body>';

            labels.forEach(function(label, idx) {
                html += '<div class="label">';
                html += '<div class="loc-text">' + label.locationId + '</div>';
                html += '<div class="qr-box" id="qr-' + idx + '"></div>';
                html += '</div>';
            });

            html += '<div class="no-print">';
            html += '<button class="btn-print" onclick="window.print()">ğŸ–¨ï¸ åˆ—å°å…¨éƒ¨ ' + labels.length + ' å¼µ</button>';
            html += '<button class="btn-close" onclick="window.close()">é—œé–‰</button>';
            html += '</div>';

            html += '<script>window.onload = function() {';
            labels.forEach(function(label, idx) {
                html += 'try { var qr = qrcode(0, "M"); qr.addData("' + label.locationId + '"); qr.make(); document.getElementById("qr-' + idx + '").innerHTML = qr.createSvgTag(3, 0); } catch(e) {}';
            });
            html += '};<\/script>';
            html += '</body></html>';

            var printWindow = window.open('', '_blank', 'width=600,height=800');
            printWindow.document.write(html);
            printWindow.document.close();
        };

        window.searchPalletForReprint = async function() {
            var palletId = document.getElementById('reprint-pallet-id').value.trim().toUpperCase();
            if (!palletId) {
                showToast('è«‹è¼¸å…¥æ£§æ¿ç·¨è™Ÿ');
                return;
            }

            var infoDiv = document.getElementById('reprint-pallet-info');
            infoDiv.innerHTML = '<div class="text-center py-4"><i class="fa-solid fa-spinner fa-spin text-2xl text-blue-400"></i><div class="text-slate-400 mt-2">æœå°‹ä¸­...</div></div>';

            var pallet = (window.pallets || []).find(function(p) {
                return p.palletId === palletId || p.id === palletId;
            });

            if (!pallet && window.db) {
                try {
                    var docRef = window.doc(window.db, 'pallets', palletId);
                    var docSnap = await window.getDoc(docRef);
                    if (docSnap.exists()) {
                        pallet = { id: docSnap.id, ...docSnap.data() };
                    }
                } catch(e) {
                    console.log('Firebase æœå°‹å¤±æ•—:', e);
                }
            }

            if (!pallet) {
                infoDiv.innerHTML = '<div class="text-center py-8"><i class="fa-solid fa-times-circle text-4xl text-red-400 mb-2"></i><div class="text-red-400">æ‰¾ä¸åˆ°æ­¤æ£§æ¿</div><div class="text-slate-500 text-sm mt-1">' + palletId + '</div></div>';
                document.getElementById('btn-reprint-pallet').disabled = true;
                reprintPalletData = null;
                return;
            }

            reprintPalletData = pallet;

            var html = '<div class="space-y-3">';
            html += '<div class="flex justify-between"><span class="text-slate-400">æ£§æ¿ç·¨è™Ÿ</span><span class="text-white font-mono font-bold">' + (pallet.palletId || pallet.id) + '</span></div>';
            html += '<div class="flex justify-between"><span class="text-slate-400">å“å</span><span class="text-white font-bold text-lg">' + pallet.productName + '</span></div>';
            html += '<div class="flex justify-between"><span class="text-slate-400">è¦æ ¼</span><span class="text-white">' + (pallet.spec || '-') + '</span></div>';
            html += '<div class="flex justify-between"><span class="text-slate-400">æ‰¹è™Ÿ</span><span class="text-white">' + (pallet.batchNo || '-') + '</span></div>';
            html += '<div class="flex justify-between"><span class="text-slate-400">æ•¸é‡</span><span class="text-yellow-400 font-bold text-xl">' + pallet.quantity + ' ä»¶</span></div>';
            html += '<div class="flex justify-between"><span class="text-slate-400">å„²ä½</span><span class="text-blue-400 font-bold">' + (pallet.locationId || 'å¾…åˆ†é…') + '</span></div>';
            if (pallet.expDate) {
                html += '<div class="flex justify-between"><span class="text-slate-400">æ•ˆæœŸ</span><span class="text-white">' + pallet.expDate + '</span></div>';
            }
            html += '</div>';

            infoDiv.innerHTML = html;
            document.getElementById('btn-reprint-pallet').disabled = false;
        };

        window.reprintPalletLabel = function() {
            if (!reprintPalletData) {
                showToast('è«‹å…ˆæœå°‹æ£§æ¿');
                return;
            }

            var pallet = reprintPalletData;

            var html = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>æ£§æ¿æ’å–® - ' + pallet.productName + '</title>';
            html += '<style>';
            html += '@page { size: A4 landscape; margin: 0; }';
            html += '* { margin: 0; padding: 0; box-sizing: border-box; }';
            html += 'body { font-family: Microsoft JhengHei, Arial, sans-serif; background: #fff; }';
            html += '.label-page { width: 297mm; height: 210mm; padding: 5mm; box-sizing: border-box; }';
            html += '.label-content { height: 100%; border: 3px solid #000; display: flex; flex-direction: column; }';
            html += '.row-1 { flex: 2; display: flex; align-items: center; border-bottom: 3px solid #000; padding: 0 8mm; }';
            html += '.product-name { font-size: 144px; font-weight: 900; text-align: center; line-height: 1; flex: 1; }';
            html += '.row-2 { flex: 1; display: flex; align-items: center; justify-content: center; border-bottom: 3px solid #000; }';
            html += '.product-spec { font-size: 100px; font-weight: 700; color: #333; text-align: center; }';
            html += '.row-3 { display: flex; border-bottom: 2px solid #000; }';
            html += '.info-cell { text-align: center; padding: 4mm 2mm; border-right: 1px solid #ccc; }';
            html += '.info-cell:last-child { border-right: none; }';
            html += '.info-cell.batch { flex: 1.2; }';
            html += '.info-cell.expiry { flex: 1.5; }';
            html += '.info-cell.qty { flex: 1; }';
            html += '.info-cell.vendor { flex: 1.2; }';
            html += '.info-label { font-size: 14px; color: #666; margin-bottom: 2mm; }';
            html += '.info-value { font-size: 48px; font-weight: 900; }';
            html += '.info-value.qty-val { font-size: 100px; color: #dc2626; }';
            html += '.info-value.vendor-val { font-size: 100px; }';
            html += '.row-4 { display: flex; align-items: center; padding: 5mm 8mm; }';
            html += '.location-box { background: #000; color: #fff; font-size: 64px; font-weight: 900; padding: 5mm 12mm; min-width: 200px; text-align: center; }';
            html += '.no-print { text-align: center; padding: 20px; }';
            html += '.no-print button { padding: 15px 40px; font-size: 18px; border: none; cursor: pointer; font-weight: bold; margin: 0 10px; border-radius: 8px; }';
            html += '.btn-print { background: #059669; color: white; }';
            html += '.btn-close { background: #666; color: white; }';
            html += '.reprint-badge { position: absolute; top: 10mm; right: 10mm; background: #ef4444; color: white; padding: 2mm 5mm; font-size: 14px; font-weight: bold; border-radius: 4px; }';
            html += '@media print { .no-print { display: none !important; } }';
            html += '</style>';
            html += '<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"><\/script>';
            html += '</head><body>';

            html += '<div class="label-page" style="position:relative;"><div class="label-content">';
            html += '<div class="reprint-badge">é‡å°</div>';

            html += '<div class="row-1">';
            html += '<div id="qrcode" style="width:200px;height:200px;flex-shrink:0;margin-right:15mm;"></div>';
            html += '<div class="product-name">' + pallet.productName + '</div>';
            html += '</div>';

            html += '<div class="row-2"><div class="product-spec">' + (pallet.spec || '-') + '</div></div>';

            html += '<div class="row-3">';
            html += '<div class="info-cell batch"><div class="info-label">æ‰¹è™Ÿ</div><div class="info-value">' + (pallet.batchNo || '-') + '</div></div>';
            html += '<div class="info-cell expiry"><div class="info-label">æ•ˆæœŸ</div><div class="info-value">' + (pallet.expDate || '-') + '</div></div>';
            html += '<div class="info-cell qty"><div class="info-label">æ•¸é‡</div><div class="info-value qty-val">' + pallet.quantity + '</div></div>';
            html += '<div class="info-cell vendor"><div class="info-label">å» å•†</div><div class="info-value vendor-val">' + (pallet.vendor || '-') + '</div></div>';
            html += '</div>';

            html += '<div class="row-4">';
            html += '<div class="location-box">' + (pallet.locationId || 'å¾…åˆ†é…') + '</div>';
            html += '<div style="flex:1;display:flex;align-items:center;justify-content:center;">';
            html += '<svg id="barcode"></svg>';
            html += '</div>';
            html += '</div>';

            html += '</div></div>';

            html += '<div class="no-print">';
            html += '<button class="btn-print" onclick="window.print()">ğŸ–¨ï¸ åˆ—å°</button>';
            html += '<button class="btn-close" onclick="window.close()">é—œé–‰</button>';
            html += '</div>';

            var barcode = pallet.palletId || pallet.id;
            html += '<script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"><\/script>';
            html += '<script>window.onload = function() {';
            html += 'try { var qr = qrcode(0, "L"); qr.addData("' + barcode + '"); qr.make(); document.getElementById("qrcode").innerHTML = qr.createSvgTag(8, 0); } catch(e) {}';
            html += 'try { JsBarcode("#barcode", "' + barcode + '", {format:"CODE128",height:60,width:1.5,displayValue:true,fontSize:14,margin:5}); } catch(e) {}';
            html += '};<\/script>';
            html += '</body></html>';

            var printWindow = window.open('', '_blank', 'width=1100,height=800');
            printWindow.document.write(html);
            printWindow.document.close();

            reprintHistory.unshift({
                palletId: barcode,
                productName: pallet.productName,
                time: new Date().toLocaleTimeString()
            });
            if (reprintHistory.length > 5) reprintHistory.pop();
            updateReprintHistory();

            showToast('âœ… å·²é–‹å•Ÿåˆ—å°è¦–çª—');
        };

        function updateReprintHistory() {
            var container = document.getElementById('reprint-history');
            if (!container) return;

            if (reprintHistory.length === 0) {
                container.innerHTML = '<div class="text-slate-600 text-sm">å°šç„¡é‡å°è¨˜éŒ„</div>';
                return;
            }

            container.innerHTML = reprintHistory.map(function(item) {
                return '<div class="flex justify-between items-center text-sm bg-slate-800 rounded px-3 py-2">' +
                    '<span class="text-white">' + item.productName + '</span>' +
                    '<span class="text-slate-400 text-xs">' + item.time + '</span>' +
                    '</div>';
            }).join('');
        }

        window.ROLES = {
            admin: { name: 'ç®¡ç†å“¡', color: 'red', icon: 'crown', level: 100, permissions: ['all'] },
            finance: { name: 'è²¡å‹™äººå“¡', color: 'emerald', icon: 'calculator', level: 85, permissions: ['approve', 'report', 'rental', 'consignment', 'inventory', 'analysis'] },
            supervisor: { name: 'å€‰ç®¡ä¸»ç®¡', color: 'purple', icon: 'user-tie', level: 80, permissions: ['inbound', 'outbound', 'move', 'merge', 'stocktake', 'report', 'approve', 'inventory', 'dispatch', 'analysis'] },
            sales: { name: 'æ¥­å‹™äººå“¡', color: 'cyan', icon: 'briefcase', level: 70, permissions: ['inventory', 'report', 'consignment', 'rental', 'analysis'] },
            operator: { name: 'å€‰ç®¡äººå“¡', color: 'blue', icon: 'user', level: 60, permissions: ['inbound', 'outbound', 'move', 'merge', 'stocktake', 'inventory', 'report'] },
            forklift: { name: 'å †é«˜æ©Ÿæ‰‹', color: 'orange', icon: 'truck', level: 40, permissions: ['move', 'merge', 'dispatch', 'inventory'] },
            readonly: { name: 'åªè®€', color: 'slate', icon: 'eye', level: 10, permissions: ['inventory'] },
            custom: { name: 'è‡ªè¨‚æ¬Šé™', color: 'amber', icon: 'sliders', level: 50, permissions: [] }
        };

        window.PERMISSION_IDS = ['inbound', 'approve', 'inventory', 'move', 'merge', 'stocktake', 'outbound', 'dispatch', 'consignment', 'rental', 'report', 'analysis', 'users', 'settings'];

        window.applyRoleTemplate = function() {
            var role = document.getElementById('edit-user-role').value;
            var roleConfig = window.ROLES[role];

            if (!roleConfig) return;

            clearAllPermissions();

            if (roleConfig.permissions.includes('all')) {
                selectAllPermissions();
                return;
            }

            roleConfig.permissions.forEach(function(perm) {
                var checkbox = document.getElementById('perm-' + perm);
                if (checkbox) checkbox.checked = true;
            });
        };

        window.selectAllPermissions = function() {
            document.querySelectorAll('.perm-checkbox').forEach(function(cb) {
                cb.checked = true;
            });
        };

        window.clearAllPermissions = function() {
            document.querySelectorAll('.perm-checkbox').forEach(function(cb) {
                cb.checked = false;
            });
        };

        window.getSelectedPermissions = function() {
            var permissions = [];
            document.querySelectorAll('.perm-checkbox:checked').forEach(function(cb) {
                var permId = cb.id.replace('perm-', '');
                permissions.push(permId);
            });
            return permissions;
        };

        window.setPermissionCheckboxes = function(permissions) {
            clearAllPermissions();
            if (!permissions || !Array.isArray(permissions)) return;

            if (permissions.includes('all')) {
                selectAllPermissions();
                return;
            }

            permissions.forEach(function(perm) {
                var checkbox = document.getElementById('perm-' + perm);
                if (checkbox) checkbox.checked = true;
            });
        };

        window.currentUser = null;

        window.usersData = [];

        // ========== Firebase ä½¿ç”¨è€…æ“ä½œ ==========

        window.loadUsersFromFirebase = async function() {
            try {
                var snapshot = await window.getDocs(window.collection(window.db, 'users'));
                window.usersData = [];
                snapshot.forEach(function(doc) {
                    window.usersData.push({ id: doc.id, ...doc.data() });
                });

                if (window.usersData.length === 0) {
                    await createDefaultAdmin();
                }

                return window.usersData;
            } catch (e) {
                console.error('è¼‰å…¥ä½¿ç”¨è€…å¤±æ•—:', e);
                window.usersData = JSON.parse(localStorage.getItem('wms_users') || '[]');
                if (window.usersData.length === 0) {
                    window.usersData = [
                        { id: 'admin@bafang.com', email: 'admin@bafang.com', name: 'ç³»çµ±ç®¡ç†å“¡', role: 'admin', dept: 'è³‡è¨Šéƒ¨', active: true, createdAt: new Date().toISOString() }
                    ];
                    localStorage.setItem('wms_users', JSON.stringify(window.usersData));
                }
                return window.usersData;
            }
        };

        async function createDefaultAdmin() {
            var defaultAdmin = {
                email: 'admin@bafang.com',
                name: 'ç³»çµ±ç®¡ç†å“¡',
                role: 'admin',
                dept: 'è³‡è¨Šéƒ¨',
                active: true,
                createdAt: new Date().toISOString()
            };

            try {
                await window.setDoc(window.doc(window.db, 'users', 'admin@bafang.com'), defaultAdmin);
                window.usersData.push({ id: 'admin@bafang.com', ...defaultAdmin });
                console.log('é è¨­ç®¡ç†å“¡å·²å»ºç«‹');
            } catch (e) {
                console.error('å»ºç«‹é è¨­ç®¡ç†å“¡å¤±æ•—:', e);
            }
        }

        window.getUserByEmail = function(email) {
            return window.usersData.find(function(u) { return u.email === email || u.id === email; });
        };

        window.setCurrentUser = async function(email) {
            if (window.usersData.length === 0) {
                await loadUsersFromFirebase();
            }

            var user = getUserByEmail(email);

            if (!user) {
                user = {
                    id: email,
                    email: email,
                    name: email.split('@')[0],
                    role: 'admin',
                    dept: '',
                    active: true,
                    createdAt: new Date().toISOString()
                };

                try {
                    await window.setDoc(window.doc(window.db, 'users', email), user);
                    window.usersData.push(user);
                } catch (e) {
                    console.error('å»ºç«‹ä½¿ç”¨è€…å¤±æ•—:', e);
                    window.usersData.push(user);
                }
            }

            window.currentUser = user;

            var nameEl = document.getElementById('current-user-name');
            var badgeEl = document.getElementById('current-user-role-badge');

            if (nameEl) nameEl.innerText = user.name || user.email;
            if (badgeEl) {
                var role = window.ROLES[user.role] || window.ROLES.operator;
                badgeEl.innerText = role.name;
                badgeEl.className = 'text-xs px-2 py-0.5 rounded-full bg-' + role.color + '-600/30 text-' + role.color + '-400';
            }

            try {
                await window.updateDoc(window.doc(window.db, 'users', email), {
                    lastLogin: new Date().toISOString()
                });
                user.lastLogin = new Date().toISOString();
            } catch (e) {
                console.log('æ›´æ–°ç™»å…¥æ™‚é–“å¤±æ•—:', e);
            }

            applyPermissions();

            return user;
        };

        window.hasPermission = function(requiredLevel) {
            if (!window.currentUser) return false;
            var userRole = window.ROLES[window.currentUser.role] || window.ROLES.readonly;
            return userRole.level >= requiredLevel;
        };

        window.canAccess = function(feature) {
            if (!window.currentUser) return false;

            var userRole = window.ROLES[window.currentUser.role] || window.ROLES.readonly;

            if (userRole.permissions.includes('all')) return true;

            if (window.currentUser.customPermissions && Array.isArray(window.currentUser.customPermissions)) {
                return window.currentUser.customPermissions.includes(feature);
            }

            return userRole.permissions.includes(feature);
        };

        window.getUserPermissions = function(user) {
            if (!user) return [];

            var userRole = window.ROLES[user.role] || window.ROLES.readonly;

            if (userRole.permissions.includes('all')) return ['all'];

            if (user.customPermissions && Array.isArray(user.customPermissions)) {
                return user.customPermissions;
            }

            return userRole.permissions;
        };

        function applyPermissions() {
            var user = window.currentUser;
            if (!user) return;

            var role = window.ROLES[user.role] || window.ROLES.readonly;
            var level = role.level;

            if (level <= 10) {
                document.querySelectorAll('.requires-write').forEach(function(el) {
                    el.style.display = 'none';
                });
            }

            if (level < 80) {
                var userMgmtNav = document.querySelector('[onclick*="user-management"]');
                if (userMgmtNav) userMgmtNav.style.display = 'none';
            }

            if (user.role === 'forklift') {
            }
        }

        // ========== ä½¿ç”¨è€… CRUD æ“ä½œ ==========

        window.openAddUserModal = function() {
            if (!hasPermission(100)) {
                showToast('âŒ æ‚¨æ²’æœ‰æ¬Šé™åŸ·è¡Œæ­¤æ“ä½œ');
                return;
            }

            document.getElementById('modal-user-title').innerHTML = '<i class="fa-solid fa-user-plus mr-2"></i>æ–°å¢ä½¿ç”¨è€…';
            document.getElementById('edit-user-id').value = '';
            document.getElementById('edit-user-email').value = '';
            document.getElementById('edit-user-email').readOnly = false;
            document.getElementById('edit-user-name').value = '';
            document.getElementById('edit-user-role').value = 'operator';
            document.getElementById('edit-user-dept').value = '';
            document.getElementById('edit-user-password').value = '';
            document.getElementById('edit-user-password2').value = '';
            document.getElementById('edit-user-active').checked = true;
            document.getElementById('password-fields').style.display = 'block';

            applyRoleTemplate();

            document.getElementById('modal-user-edit').classList.remove('hidden');
        };

        window.editUser = function(email) {
            if (!hasPermission(100)) {
                showToast('âŒ æ‚¨æ²’æœ‰æ¬Šé™åŸ·è¡Œæ­¤æ“ä½œ');
                return;
            }

            var user = getUserByEmail(email);
            if (!user) return;

            document.getElementById('modal-user-title').innerHTML = '<i class="fa-solid fa-user-pen mr-2"></i>ç·¨è¼¯ä½¿ç”¨è€…';
            document.getElementById('edit-user-id').value = email;
            document.getElementById('edit-user-email').value = user.email;
            document.getElementById('edit-user-email').readOnly = true;
            document.getElementById('edit-user-name').value = user.name || '';
            document.getElementById('edit-user-role').value = user.role || 'operator';
            document.getElementById('edit-user-dept').value = user.dept || '';
            document.getElementById('edit-user-password').value = '';
            document.getElementById('edit-user-password2').value = '';
            document.getElementById('edit-user-active').checked = user.active !== false;
            document.getElementById('password-fields').style.display = 'none'; // ç·¨è¼¯æ™‚éš±è—å¯†ç¢¼

            if (user.customPermissions && Array.isArray(user.customPermissions)) {
                document.getElementById('edit-user-role').value = 'custom';
                setPermissionCheckboxes(user.customPermissions);
            } else {
                applyRoleTemplate();
            }

            document.getElementById('modal-user-edit').classList.remove('hidden');
        };

        window.closeUserModal = function() {
            document.getElementById('modal-user-edit').classList.add('hidden');
        };

        window.saveUser = async function() {
            var id = document.getElementById('edit-user-id').value;
            var email = document.getElementById('edit-user-email').value.trim().toLowerCase();
            var name = document.getElementById('edit-user-name').value.trim();
            var role = document.getElementById('edit-user-role').value;
            var dept = document.getElementById('edit-user-dept').value.trim();
            var active = document.getElementById('edit-user-active').checked;
            var password = document.getElementById('edit-user-password').value;
            var password2 = document.getElementById('edit-user-password2').value;

            if (!email || !name) {
                showToast('âŒ è«‹å¡«å¯« Email å’Œå§“å');
                return;
            }

            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                showToast('âŒ Email æ ¼å¼ä¸æ­£ç¢º');
                return;
            }

            try {
                if (!id) {
                    if (!password || password.length < 6) {
                        showToast('âŒ å¯†ç¢¼è‡³å°‘éœ€è¦6ä½');
                        return;
                    }
                    if (password !== password2) {
                        showToast('âŒ å…©æ¬¡å¯†ç¢¼ä¸ä¸€è‡´');
                        return;
                    }

                    if (getUserByEmail(email)) {
                        showToast('âŒ æ­¤ Email å·²å­˜åœ¨æ–¼ç³»çµ±ä¸­');
                        return;
                    }

                    showToast('â³ æ­£åœ¨å»ºç«‹ä½¿ç”¨è€…å¸³è™Ÿ...');

                    var authCreated = false;
                    var authUid = null;
                    try {
                        var userCredential = await window.createUserWithEmailAndPassword(window.secondaryAuth, email, password);
                        authUid = userCredential.user.uid;
                        authCreated = true;
                        console.log('Firebase Auth å¸³è™Ÿå·²å»ºç«‹ï¼ŒUID:', authUid);

                        try {
                            await window.secondaryAuth.signOut();
                        } catch (signOutErr) {
                            console.log('SecondaryAuth signOut:', signOutErr);
                        }
                    } catch (authErr) {
                        console.log('å»ºç«‹ Auth å¸³è™Ÿå¤±æ•—:', authErr.code, authErr.message);
                        if (authErr.code === 'auth/email-already-in-use') {
                            authCreated = true;
                            showToast('â„¹ï¸ æ­¤ Email å·²æœ‰ Auth å¸³è™Ÿï¼Œå°‡å»ºç«‹ç³»çµ±ä½¿ç”¨è€…è³‡æ–™');
                        } else if (authErr.code === 'auth/weak-password') {
                            showToast('âŒ å¯†ç¢¼å¼·åº¦ä¸è¶³ï¼Œè«‹ä½¿ç”¨è‡³å°‘6ä½å¯†ç¢¼');
                            return;
                        } else if (authErr.code === 'auth/invalid-email') {
                            showToast('âŒ Email æ ¼å¼ä¸æ­£ç¢º');
                            return;
                        } else if (authErr.code === 'auth/operation-not-allowed') {
                            showToast('âŒ Firebase å°šæœªå•Ÿç”¨ Email/Password ç™»å…¥æ–¹å¼');
                            return;
                        } else {
                            console.warn('Auth å»ºç«‹è­¦å‘Š:', authErr);
                        }
                    }

                    var customPermissions = getSelectedPermissions();

                    var newUser = {
                        email: email,
                        name: name,
                        role: role,
                        dept: dept,
                        active: active,
                        authCreated: authCreated,
                        authUid: authUid || null,
                        customPermissions: customPermissions,
                        createdAt: new Date().toISOString(),
                        createdBy: window.currentUser ? window.currentUser.email : 'system'
                    };

                    await window.setDoc(window.doc(window.db, 'users', email), newUser);
                    window.usersData.push({ id: email, ...newUser });

                    console.log('ä½¿ç”¨è€…æ“ä½œè¨˜éŒ„: create_user', email, 'æ–°å¢ä½¿ç”¨è€… - ' + name + ' (' + role + ')', 'æ¬Šé™:', customPermissions);

                    if (authCreated) {
                        showToast('âœ… ä½¿ç”¨è€… ' + name + ' å·²å»ºç«‹å®Œæˆï¼å¯ç«‹å³ç™»å…¥ç³»çµ±');
                    } else {
                        showToast('âš ï¸ ä½¿ç”¨è€…è³‡æ–™å·²å»ºç«‹ï¼Œä½†ç™»å…¥å¸³è™Ÿå»ºç«‹å¤±æ•—');
                        setTimeout(function() {
                            alert('ğŸ“‹ ä½¿ç”¨è€…è³‡æ–™å·²å»ºç«‹ï¼\n\nä½† Firebase Auth å¸³è™Ÿå»ºç«‹å¤±æ•—ã€‚\n\nè«‹åˆ° Firebase Console > Authentication > Users\né»æ“Šã€ŒAdd userã€æ‰‹å‹•å»ºç«‹ï¼š\n\nâ€¢ Email: ' + email + '\nâ€¢ Password: ï¼ˆæ‚¨è¨­å®šçš„å¯†ç¢¼ï¼‰\n\næˆ–è¯ç¹«ç³»çµ±ç®¡ç†å“¡å”åŠ©è™•ç†ã€‚');
                        }, 500);
                    }

                } else {
                    var customPermissions = getSelectedPermissions();

                    var updateData = {
                        name: name,
                        role: role,
                        dept: dept,
                        active: active,
                        customPermissions: customPermissions,
                        updatedAt: new Date().toISOString(),
                        updatedBy: window.currentUser ? window.currentUser.email : 'system'
                    };

                    await window.updateDoc(window.doc(window.db, 'users', id), updateData);

                    var user = getUserByEmail(id);
                    if (user) {
                        Object.assign(user, updateData);
                    }

                    showToast('âœ… ä½¿ç”¨è€… ' + name + ' å·²æ›´æ–°');
                }

                closeUserModal();
                loadUserList();

            } catch (e) {
                console.error('å„²å­˜ä½¿ç”¨è€…å¤±æ•—:', e);
                showToast('âŒ å„²å­˜å¤±æ•—: ' + e.message);
            }
        };

        window.deleteUser = async function(email) {
            if (!hasPermission(100)) {
                showToast('âŒ æ‚¨æ²’æœ‰æ¬Šé™åŸ·è¡Œæ­¤æ“ä½œ');
                return;
            }

            if (email === 'admin@bafang.com') {
                showToast('âŒ ç„¡æ³•åˆªé™¤ç³»çµ±ç®¡ç†å“¡å¸³è™Ÿ');
                return;
            }

            if (!confirm('ç¢ºå®šè¦åˆªé™¤ä½¿ç”¨è€… ' + email + 'ï¼Ÿ\n\næ³¨æ„ï¼šé€™åªæœƒåˆªé™¤ä½¿ç”¨è€…è³‡æ–™ï¼ŒFirebase Auth å¸³è™Ÿéœ€è¦å¦å¤–åœ¨ Console åˆªé™¤ã€‚')) return;

            try {
                await window.deleteDoc(window.doc(window.db, 'users', email));
                window.usersData = window.usersData.filter(function(u) { return u.email !== email && u.id !== email; });
                loadUserList();
                showToast('âœ… ä½¿ç”¨è€…å·²åˆªé™¤');
            } catch (e) {
                console.error('åˆªé™¤ä½¿ç”¨è€…å¤±æ•—:', e);
                showToast('âŒ åˆªé™¤å¤±æ•—: ' + e.message);
            }
        };

        window.toggleUserStatus = async function(email) {
            if (!hasPermission(100)) {
                showToast('âŒ æ‚¨æ²’æœ‰æ¬Šé™åŸ·è¡Œæ­¤æ“ä½œ');
                return;
            }

            var user = getUserByEmail(email);
            if (!user) return;

            var newStatus = !user.active;

            try {
                await window.updateDoc(window.doc(window.db, 'users', email), {
                    active: newStatus,
                    updatedAt: new Date().toISOString()
                });

                user.active = newStatus;
                loadUserList();
                showToast(newStatus ? 'âœ… ä½¿ç”¨è€…å·²å•Ÿç”¨' : 'âš ï¸ ä½¿ç”¨è€…å·²åœç”¨');
            } catch (e) {
                console.error('æ›´æ–°ç‹€æ…‹å¤±æ•—:', e);
                showToast('âŒ æ›´æ–°å¤±æ•—: ' + e.message);
            }
        };

        window.loadUserList = async function() {
            var tbody = document.getElementById('user-list-body');
            if (!tbody) return;

            tbody.innerHTML = '<tr><td colspan="8" class="text-center text-slate-500 py-8"><i class="fa-solid fa-spinner fa-spin mr-2"></i>è¼‰å…¥ä¸­...</td></tr>';

            await loadUsersFromFirebase();

            if (window.usersData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-slate-500 py-8">å°šç„¡ä½¿ç”¨è€…è³‡æ–™</td></tr>';
                updateUserStats();
                return;
            }

            var sortedUsers = window.usersData.slice().sort(function(a, b) {
                var levelA = (window.ROLES[a.role] || window.ROLES.readonly).level;
                var levelB = (window.ROLES[b.role] || window.ROLES.readonly).level;
                if (levelB !== levelA) return levelB - levelA;
                return (a.name || '').localeCompare(b.name || '');
            });

            var html = '';
            sortedUsers.forEach(function(user) {
                var role = window.ROLES[user.role] || window.ROLES.operator;
                var statusBadge = user.active !== false
                    ? '<span class="badge badge-green cursor-pointer" onclick="toggleUserStatus(\'' + user.email + '\')">å•Ÿç”¨</span>'
                    : '<span class="badge badge-red cursor-pointer" onclick="toggleUserStatus(\'' + user.email + '\')">åœç”¨</span>';
                var canLogin = user.authCreated || user.lastLogin;
                var authBadge = canLogin
                    ? '<span class="text-emerald-400 text-[10px]" title="å¯ç™»å…¥"><i class="fa-solid fa-check-circle"></i></span>'
                    : '<span class="text-yellow-400 text-[10px]" title="å°šæœªå»ºç«‹ç™»å…¥å¸³è™Ÿ"><i class="fa-solid fa-exclamation-triangle"></i></span>';
                var lastLogin = user.lastLogin
                    ? new Date(user.lastLogin).toLocaleString('zh-TW')
                    : '<span class="text-slate-600">å¾æœªç™»å…¥</span>';
                var createdAt = user.createdAt
                    ? new Date(user.createdAt).toLocaleDateString('zh-TW')
                    : '-';

                var userPerms = getUserPermissions(user);
                var permBadge = '';
                if (userPerms.includes('all')) {
                    permBadge = '<span class="text-amber-400 text-[10px] ml-1" title="å…¨éƒ¨æ¬Šé™"><i class="fa-solid fa-star"></i></span>';
                } else if (user.customPermissions && user.customPermissions.length > 0) {
                    permBadge = '<span class="text-amber-400 text-[10px] ml-1" title="è‡ªè¨‚ ' + user.customPermissions.length + ' é …æ¬Šé™"><i class="fa-solid fa-sliders"></i> ' + user.customPermissions.length + '</span>';
                }

                html += '<tr class="hover:bg-slate-800/50 border-b border-slate-700/50">';
                html += '<td class="p-3"><span class="text-cyan-400">' + user.email + '</span> ' + authBadge + '</td>';
                html += '<td class="p-3 font-bold text-white">' + (user.name || '-') + '</td>';
                html += '<td class="p-3"><span class="badge badge-' + role.color + '"><i class="fa-solid fa-' + role.icon + ' mr-1"></i>' + role.name + '</span>' + permBadge + '</td>';
                html += '<td class="p-3 text-slate-400">' + (user.dept || '-') + '</td>';
                html += '<td class="p-3 text-center">' + statusBadge + '</td>';
                html += '<td class="p-3 text-slate-400 text-xs">' + lastLogin + '</td>';
                html += '<td class="p-3 text-slate-400 text-xs">' + createdAt + '</td>';
                html += '<td class="p-3 text-center">';
                html += '<button onclick="editUser(\'' + user.email + '\')" class="bg-blue-600 hover:bg-blue-500 text-white text-xs px-2 py-1 rounded mr-1" title="ç·¨è¼¯"><i class="fa-solid fa-pen"></i></button>';
                html += '<button onclick="resetUserPassword(\'' + user.email + '\')" class="bg-amber-600 hover:bg-amber-500 text-white text-xs px-2 py-1 rounded mr-1" title="é‡è¨­å¯†ç¢¼"><i class="fa-solid fa-key"></i></button>';
                if (user.email !== 'admin@bafang.com') {
                    html += '<button onclick="deleteUser(\'' + user.email + '\')" class="bg-red-600 hover:bg-red-500 text-white text-xs px-2 py-1 rounded" title="åˆªé™¤"><i class="fa-solid fa-trash"></i></button>';
                }
                html += '</td>';
                html += '</tr>';
            });

            tbody.innerHTML = html;

            updateUserStats();

            document.getElementById('user-count').innerText = 'å…± ' + window.usersData.length + ' ä½ä½¿ç”¨è€…';
        };

        function updateUserStats() {
            var stats = { admin: 0, finance: 0, supervisor: 0, sales: 0, operator: 0, forklift: 0, readonly: 0 };
            window.usersData.forEach(function(u) {
                if (stats.hasOwnProperty(u.role)) {
                    stats[u.role]++;
                } else {
                    stats.operator++;
                }
            });

            Object.keys(stats).forEach(function(role) {
                var el = document.getElementById('stat-' + role);
                if (el) el.innerText = stats[role];
            });
        }

        window.resetUserPassword = async function(email) {
            if (!confirm('ç¢ºå®šè¦ç™¼é€å¯†ç¢¼é‡è¨­éƒµä»¶çµ¦ ' + email + 'ï¼Ÿ')) return;

            try {
                await window.sendPasswordResetEmail(window.auth, email);
                showToast('âœ… å¯†ç¢¼é‡è¨­éƒµä»¶å·²ç™¼é€è‡³ ' + email);
            } catch (e) {
                console.error('ç™¼é€å¯†ç¢¼é‡è¨­éƒµä»¶å¤±æ•—:', e);
                if (e.code === 'auth/user-not-found') {
                    showToast('âš ï¸ æ­¤ Email å°šæœªå»ºç«‹ Firebase Auth å¸³è™Ÿ');
                } else {
                    showToast('âŒ ç™¼é€å¤±æ•—: ' + e.message);
                }
            }
        };

        window.filterUserList = function() {
            var searchText = (document.getElementById('user-search').value || '').toLowerCase();
            var roleFilter = document.getElementById('user-role-filter').value;
            var statusFilter = document.getElementById('user-status-filter').value;

            var tbody = document.getElementById('user-list-body');
            if (!tbody) return;

            var filteredUsers = window.usersData.filter(function(user) {
                if (searchText) {
                    var matchEmail = (user.email || '').toLowerCase().includes(searchText);
                    var matchName = (user.name || '').toLowerCase().includes(searchText);
                    if (!matchEmail && !matchName) return false;
                }

                if (roleFilter && user.role !== roleFilter) return false;

                if (statusFilter === 'active' && user.active === false) return false;
                if (statusFilter === 'inactive' && user.active !== false) return false;

                return true;
            });

            filteredUsers.sort(function(a, b) {
                var levelA = (window.ROLES[a.role] || window.ROLES.readonly).level;
                var levelB = (window.ROLES[b.role] || window.ROLES.readonly).level;
                if (levelB !== levelA) return levelB - levelA;
                return (a.name || '').localeCompare(b.name || '');
            });

            if (filteredUsers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-slate-500 py-8">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„ä½¿ç”¨è€…</td></tr>';
                document.getElementById('user-count').innerText = 'å…± 0 ä½ä½¿ç”¨è€…';
                return;
            }

            var html = '';
            filteredUsers.forEach(function(user) {
                var role = window.ROLES[user.role] || window.ROLES.operator;
                var statusBadge = user.active !== false
                    ? '<span class="badge badge-green cursor-pointer" onclick="toggleUserStatus(\'' + user.email + '\')">å•Ÿç”¨</span>'
                    : '<span class="badge badge-red cursor-pointer" onclick="toggleUserStatus(\'' + user.email + '\')">åœç”¨</span>';
                var canLogin = user.authCreated || user.lastLogin;
                var authBadge = canLogin
                    ? '<span class="text-emerald-400 text-[10px]" title="å¯ç™»å…¥"><i class="fa-solid fa-check-circle"></i></span>'
                    : '<span class="text-yellow-400 text-[10px]" title="å°šæœªå»ºç«‹ç™»å…¥å¸³è™Ÿ"><i class="fa-solid fa-exclamation-triangle"></i></span>';
                var lastLogin = user.lastLogin
                    ? new Date(user.lastLogin).toLocaleString('zh-TW')
                    : '<span class="text-slate-600">å¾æœªç™»å…¥</span>';
                var createdAt = user.createdAt
                    ? new Date(user.createdAt).toLocaleDateString('zh-TW')
                    : '-';

                var userPerms = getUserPermissions(user);
                var permBadge = '';
                if (userPerms.includes('all')) {
                    permBadge = '<span class="text-amber-400 text-[10px] ml-1" title="å…¨éƒ¨æ¬Šé™"><i class="fa-solid fa-star"></i></span>';
                } else if (user.customPermissions && user.customPermissions.length > 0) {
                    permBadge = '<span class="text-amber-400 text-[10px] ml-1" title="è‡ªè¨‚ ' + user.customPermissions.length + ' é …æ¬Šé™"><i class="fa-solid fa-sliders"></i> ' + user.customPermissions.length + '</span>';
                }

                html += '<tr class="hover:bg-slate-800/50 border-b border-slate-700/50">';
                html += '<td class="p-3"><span class="text-cyan-400">' + user.email + '</span> ' + authBadge + '</td>';
                html += '<td class="p-3 font-bold text-white">' + (user.name || '-') + '</td>';
                html += '<td class="p-3"><span class="badge badge-' + role.color + '"><i class="fa-solid fa-' + role.icon + ' mr-1"></i>' + role.name + '</span>' + permBadge + '</td>';
                html += '<td class="p-3 text-slate-400">' + (user.dept || '-') + '</td>';
                html += '<td class="p-3 text-center">' + statusBadge + '</td>';
                html += '<td class="p-3 text-slate-400 text-xs">' + lastLogin + '</td>';
                html += '<td class="p-3 text-slate-400 text-xs">' + createdAt + '</td>';
                html += '<td class="p-3 text-center">';
                html += '<button onclick="editUser(\'' + user.email + '\')" class="bg-blue-600 hover:bg-blue-500 text-white text-xs px-2 py-1 rounded mr-1" title="ç·¨è¼¯"><i class="fa-solid fa-pen"></i></button>';
                html += '<button onclick="resetUserPassword(\'' + user.email + '\')" class="bg-amber-600 hover:bg-amber-500 text-white text-xs px-2 py-1 rounded mr-1" title="é‡è¨­å¯†ç¢¼"><i class="fa-solid fa-key"></i></button>';
                if (user.email !== 'admin@bafang.com') {
                    html += '<button onclick="deleteUser(\'' + user.email + '\')" class="bg-red-600 hover:bg-red-500 text-white text-xs px-2 py-1 rounded" title="åˆªé™¤"><i class="fa-solid fa-trash"></i></button>';
                }
                html += '</td>';
                html += '</tr>';
            });

            tbody.innerHTML = html;
            document.getElementById('user-count').innerText = 'å…± ' + filteredUsers.length + ' ä½ä½¿ç”¨è€…';
        };

        window.getOperatorName = function() {
            if (window.currentUser) {
                return window.currentUser.name || window.currentUser.email;
            }
            return 'æœªçŸ¥';
        };

        window.getOperatorEmail = function() {
            if (window.currentUser) {
                return window.currentUser.email;
            }
            return 'unknown';
        };

        window.exportUserList = function() {
            if (window.usersData.length === 0) {
                showToast('âŒ æ²’æœ‰ä½¿ç”¨è€…è³‡æ–™å¯åŒ¯å‡º');
                return;
            }

            var data = window.usersData.map(function(u) {
                var role = window.ROLES[u.role] || window.ROLES.readonly;
                return {
                    'Email': u.email,
                    'å§“å': u.name || '',
                    'è§’è‰²': role.name,
                    'éƒ¨é–€': u.dept || '',
                    'ç‹€æ…‹': u.active !== false ? 'å•Ÿç”¨' : 'åœç”¨',
                    'æœ€å¾Œç™»å…¥': u.lastLogin ? new Date(u.lastLogin).toLocaleString('zh-TW') : '-',
                    'å»ºç«‹æ™‚é–“': u.createdAt ? new Date(u.createdAt).toLocaleString('zh-TW') : '-'
                };
            });

            var ws = XLSX.utils.json_to_sheet(data);
            var wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'ä½¿ç”¨è€…æ¸…å–®');
            XLSX.writeFile(wb, 'ä½¿ç”¨è€…æ¸…å–®_' + new Date().toISOString().slice(0,10) + '.xlsx');

            showToast('âœ… åŒ¯å‡ºæˆåŠŸ');
        };

        // ========== å¤–å€‰åº«å­˜æ“ä½œå‡½æ•¸ ==========

        window.createExternalStock = async function(order) {
            try {
                var stockData = {
                    warehouseId: order.warehouseId,
                    warehouseName: order.warehouseName,
                    productName: order.productName,
                    spec: order.spec || '',
                    batchNo: order.batchNo || '',
                    expiryDate: order.expDate,
                    quantity: order.quantity,
                    vendor: order.vendor || '',
                    inboundDocNo: order.docNo,
                    createdAt: new Date().toISOString(),
                    createdBy: window.currentUser ? window.currentUser.email : 'system',
                    updatedAt: new Date().toISOString()
                };

                await window.addDoc(window.collection(window.db, 'externalStock'), stockData);

                await window.addDoc(window.collection(window.db, 'inventoryLogs'), {
                    type: 'external_inbound',
                    warehouseId: order.warehouseId,
                    warehouseName: order.warehouseName,
                    productName: order.productName,
                    spec: order.spec,
                    batchNo: order.batchNo,
                    quantity: order.quantity,
                    quantityChange: order.quantity,
                    note: order.warehouseName + 'å…¥åº«',
                    operator: window.currentUser ? window.currentUser.email : 'system',
                    timestamp: new Date()
                });

                console.log('å¤–å€‰åº«å­˜å·²å»ºç«‹:', stockData);
                return true;
            } catch (e) {
                console.error('å»ºç«‹å¤–å€‰åº«å­˜å¤±æ•—:', e);
                return false;
            }
        };

        window.externalOutbound = async function(stockId, outQty, note) {
            try {
                var stockRef = window.doc(window.db, 'externalStock', stockId);
                var stockDoc = await window.getDoc(stockRef);

                if (!stockDoc.exists()) {
                    showToast('âŒ æ‰¾ä¸åˆ°æ­¤åº«å­˜è¨˜éŒ„');
                    return false;
                }

                var stock = stockDoc.data();
                var currentQty = stock.quantity || 0;

                if (outQty > currentQty) {
                    showToast('âŒ å‡ºåº«æ•¸é‡è¶…éåº«å­˜');
                    return false;
                }

                var newQty = currentQty - outQty;

                if (newQty <= 0) {
                    await window.deleteDoc(stockRef);
                } else {
                    await window.updateDoc(stockRef, {
                        quantity: newQty,
                        updatedAt: new Date().toISOString()
                    });
                }

                await window.addDoc(window.collection(window.db, 'inventoryLogs'), {
                    type: 'external_outbound',
                    warehouseId: stock.warehouseId,
                    warehouseName: stock.warehouseName,
                    productName: stock.productName,
                    spec: stock.spec,
                    batchNo: stock.batchNo,
                    quantity: outQty,
                    quantityChange: -outQty,
                    remainingQty: newQty,
                    note: note || (stock.warehouseName + 'å‡ºåº«'),
                    operator: window.currentUser ? window.currentUser.email : 'system',
                    timestamp: new Date()
                });

                showToast('âœ… å¤–å€‰å‡ºåº«æˆåŠŸ');
                return true;
            } catch (e) {
                console.error('å¤–å€‰å‡ºåº«å¤±æ•—:', e);
                showToast('âŒ å‡ºåº«å¤±æ•—: ' + e.message);
                return false;
            }
        };

        window.transferToMainWarehouse = async function(stockId, transferQty, targetLocation) {
            try {
                var stockRef = window.doc(window.db, 'externalStock', stockId);
                var stockDoc = await window.getDoc(stockRef);

                if (!stockDoc.exists()) {
                    showToast('âŒ æ‰¾ä¸åˆ°æ­¤åº«å­˜è¨˜éŒ„');
                    return false;
                }

                var stock = stockDoc.data();
                var currentQty = stock.quantity || 0;

                if (transferQty > currentQty) {
                    showToast('âŒ èª¿æ’¥æ•¸é‡è¶…éåº«å­˜');
                    return false;
                }

                var newQty = currentQty - transferQty;
                if (newQty <= 0) {
                    await window.deleteDoc(stockRef);
                } else {
                    await window.updateDoc(stockRef, {
                        quantity: newQty,
                        updatedAt: new Date().toISOString()
                    });
                }

                var now = new Date();
                var palletId = 'PL-' + (stock.batchNo || 'TR') + '-' + now.getTime().toString(36).toUpperCase();

                var palletData = {
                    palletId: palletId,
                    productName: stock.productName,
                    spec: stock.spec || '',
                    batchNo: stock.batchNo || '',
                    expiryDate: stock.expiryDate ? new Date(stock.expiryDate) : null,
                    quantity: transferQty,
                    locationId: targetLocation,
                    vendor: stock.vendor || '',
                    category: 'Transfer',
                    status: 'Active',
                    sourceWarehouse: stock.warehouseId,
                    inboundDate: now,
                    createdAt: now
                };

                await window.addDoc(window.collection(window.db, 'pallets'), palletData);

                await window.addDoc(window.collection(window.db, 'inventoryLogs'), {
                    type: 'transfer_in',
                    fromWarehouse: stock.warehouseId,
                    fromWarehouseName: stock.warehouseName,
                    toLocation: targetLocation,
                    productName: stock.productName,
                    spec: stock.spec,
                    batchNo: stock.batchNo,
                    quantity: transferQty,
                    quantityChange: transferQty,
                    palletId: palletId,
                    note: 'å¾' + stock.warehouseName + 'èª¿å…¥',
                    operator: window.currentUser ? window.currentUser.email : 'system',
                    timestamp: new Date()
                });

                showToast('âœ… èª¿æ’¥æˆåŠŸï¼Œå·²å…¥åº«è‡³ ' + targetLocation);
                return true;
            } catch (e) {
                console.error('èª¿æ’¥å¤±æ•—:', e);
                showToast('âŒ èª¿æ’¥å¤±æ•—: ' + e.message);
                return false;
            }
        };

        // ========== å€‰åº«ç®¡ç† Modal æ“ä½œ ==========

        window.openWarehouseManager = function() {
            renderWarehouseManagerList();
            document.getElementById('modal-warehouse-manager').classList.remove('hidden');
        };

        window.closeWarehouseManager = function() {
            document.getElementById('modal-warehouse-manager').classList.add('hidden');
            updateWarehouseDropdown();
        };

        function renderWarehouseManagerList() {
            var cwList = document.getElementById('cw-warehouse-list');
            var bfList = document.getElementById('bf-warehouse-list');
            var virtualList = document.getElementById('virtual-warehouse-list');

            if (!cwList || !bfList) return;

            var cwWarehouses = window.warehousesData.filter(function(w) {
                return w.company === 'å´‡æ–‡';
            }).sort(function(a, b) { return (a.sortOrder || 99) - (b.sortOrder || 99); });

            cwList.innerHTML = cwWarehouses.map(function(w) {
                var icon = w.icon === 'store' ? 'store' : 'building';
                var statusClass = w.active !== false ? 'text-emerald-400' : 'text-red-400';
                var statusText = w.active !== false ? 'å•Ÿç”¨' : 'åœç”¨';
                return '<div class="flex items-center justify-between py-2 px-3 bg-slate-700/50 rounded">' +
                    '<span class="text-white"><i class="fa-solid fa-' + icon + ' mr-2 text-cyan-400"></i>å´‡æ–‡_' + w.name + '</span>' +
                    '<div class="flex items-center gap-2">' +
                    '<span class="text-xs ' + statusClass + '">' + statusText + '</span>' +
                    '<button onclick="toggleWarehouseStatus(\'' + w.id + '\')" class="text-yellow-400 hover:text-yellow-300 text-sm px-2" title="åˆ‡æ›ç‹€æ…‹"><i class="fa-solid fa-power-off"></i></button>' +
                    '<button onclick="editWarehouse(\'' + w.id + '\')" class="text-blue-400 hover:text-blue-300 text-sm px-2" title="ç·¨è¼¯"><i class="fa-solid fa-pen"></i></button>' +
                    '</div></div>';
            }).join('');

            var bfWarehouses = window.warehousesData.filter(function(w) {
                return w.company === 'å…«æ–¹';
            }).sort(function(a, b) { return (a.sortOrder || 99) - (b.sortOrder || 99); });

            bfList.innerHTML = bfWarehouses.map(function(w) {
                var icon = w.icon === 'store' ? 'store' : 'building';
                var statusClass = w.active !== false ? 'text-emerald-400' : 'text-red-400';
                var statusText = w.active !== false ? 'å•Ÿç”¨' : 'åœç”¨';
                return '<div class="flex items-center justify-between py-2 px-3 bg-slate-700/50 rounded">' +
                    '<span class="text-white"><i class="fa-solid fa-' + icon + ' mr-2 text-orange-400"></i>å…«æ–¹_' + w.name + '</span>' +
                    '<div class="flex items-center gap-2">' +
                    '<span class="text-xs ' + statusClass + '">' + statusText + '</span>' +
                    '<button onclick="toggleWarehouseStatus(\'' + w.id + '\')" class="text-yellow-400 hover:text-yellow-300 text-sm px-2" title="åˆ‡æ›ç‹€æ…‹"><i class="fa-solid fa-power-off"></i></button>' +
                    '<button onclick="editWarehouse(\'' + w.id + '\')" class="text-blue-400 hover:text-blue-300 text-sm px-2" title="ç·¨è¼¯"><i class="fa-solid fa-pen"></i></button>' +
                    '</div></div>';
            }).join('');

            var virtualWarehouses = window.warehousesData.filter(function(w) {
                return w.type === 'virtual';
            });

            virtualList.innerHTML = virtualWarehouses.map(function(w) {
                var statusClass = w.active !== false ? 'text-emerald-400' : 'text-red-400';
                var statusText = w.active !== false ? 'å•Ÿç”¨' : 'åœç”¨';
                return '<div class="flex items-center justify-between py-2 px-3 bg-slate-700/50 rounded">' +
                    '<span class="text-white"><i class="fa-solid fa-folder mr-2 text-blue-400"></i>' + w.name + '</span>' +
                    '<div class="flex items-center gap-2">' +
                    '<span class="text-xs ' + statusClass + '">' + statusText + '</span>' +
                    '<button onclick="toggleWarehouseStatus(\'' + w.id + '\')" class="text-yellow-400 hover:text-yellow-300 text-sm px-2" title="åˆ‡æ›ç‹€æ…‹"><i class="fa-solid fa-power-off"></i></button>' +
                    '<button onclick="editWarehouse(\'' + w.id + '\')" class="text-blue-400 hover:text-blue-300 text-sm px-2" title="ç·¨è¼¯"><i class="fa-solid fa-pen"></i></button>' +
                    '</div></div>';
            }).join('');
        }

        window.openAddWarehouseModal = function(type) {
            document.getElementById('edit-warehouse-id').value = '';
            document.getElementById('warehouse-type').value = type;
            document.getElementById('warehouse-name').value = '';
            document.getElementById('warehouse-company').value = 'å´‡æ–‡';

            if (type === 'external') {
                document.getElementById('add-warehouse-title').innerHTML = '<i class="fa-solid fa-plus mr-2"></i>æ–°å¢å¤–å€‰';
                document.getElementById('company-select-row').style.display = 'block';
                document.getElementById('warehouse-preview').style.display = 'block';
            } else {
                document.getElementById('add-warehouse-title').innerHTML = '<i class="fa-solid fa-plus mr-2"></i>æ–°å¢è™›æ“¬å€‰';
                document.getElementById('company-select-row').style.display = 'none';
                document.getElementById('warehouse-preview').style.display = 'none';
            }

            updateWarehousePreview();
            document.getElementById('modal-add-warehouse').classList.remove('hidden');
        };

        window.closeAddWarehouseModal = function() {
            document.getElementById('modal-add-warehouse').classList.add('hidden');
        };

        window.updateWarehousePreview = function() {
            var type = document.getElementById('warehouse-type').value;
            var company = document.getElementById('warehouse-company').value;
            var name = document.getElementById('warehouse-name').value;

            var previewEl = document.getElementById('warehouse-preview-text');
            if (type === 'external') {
                previewEl.textContent = company + '_' + (name || '');
            } else {
                previewEl.textContent = name || '';
            }
        };

        window.saveWarehouse = async function() {
            var id = document.getElementById('edit-warehouse-id').value;
            var type = document.getElementById('warehouse-type').value;
            var company = document.getElementById('warehouse-company').value;
            var name = document.getElementById('warehouse-name').value.trim();

            if (!name) {
                showToast('âŒ è«‹è¼¸å…¥å€‰åº«åç¨±');
                return;
            }

            try {
                if (id) {
                    await window.updateDoc(window.doc(window.db, 'warehouses', id), {
                        name: name,
                        company: type === 'external' ? company : null,
                        updatedAt: new Date().toISOString()
                    });
                    showToast('âœ… å€‰åº«å·²æ›´æ–°');
                } else {
                    var code = type === 'external'
                        ? (company === 'å´‡æ–‡' ? 'CW-' : 'BF-') + Date.now().toString(36).toUpperCase()
                        : 'VT-' + Date.now().toString(36).toUpperCase();

                    await window.addDoc(window.collection(window.db, 'warehouses'), {
                        code: code,
                        name: name,
                        company: type === 'external' ? company : null,
                        type: type,
                        icon: type === 'external' ? 'building' : 'folder',
                        active: true,
                        sortOrder: 99,
                        createdAt: new Date().toISOString()
                    });
                    showToast('âœ… å€‰åº«å·²æ–°å¢');
                }

                closeAddWarehouseModal();
                await loadWarehouses();
                renderWarehouseManagerList();

            } catch(e) {
                console.error('å„²å­˜å€‰åº«å¤±æ•—:', e);
                showToast('âŒ å„²å­˜å¤±æ•—: ' + e.message);
            }
        };

        window.editWarehouse = function(id) {
            var wh = window.warehousesData.find(function(w) { return w.id === id; });
            if (!wh) return;

            document.getElementById('edit-warehouse-id').value = id;
            document.getElementById('warehouse-type').value = wh.type || 'external';
            document.getElementById('warehouse-name').value = wh.name;
            document.getElementById('warehouse-company').value = wh.company || 'å´‡æ–‡';

            if (wh.type === 'virtual') {
                document.getElementById('add-warehouse-title').innerHTML = '<i class="fa-solid fa-pen mr-2"></i>ç·¨è¼¯è™›æ“¬å€‰';
                document.getElementById('company-select-row').style.display = 'none';
                document.getElementById('warehouse-preview').style.display = 'none';
            } else {
                document.getElementById('add-warehouse-title').innerHTML = '<i class="fa-solid fa-pen mr-2"></i>ç·¨è¼¯å¤–å€‰';
                document.getElementById('company-select-row').style.display = 'block';
                document.getElementById('warehouse-preview').style.display = 'block';
            }

            updateWarehousePreview();
            document.getElementById('modal-add-warehouse').classList.remove('hidden');
        };

        window.toggleWarehouseStatus = async function(id) {
            var wh = window.warehousesData.find(function(w) { return w.id === id; });
            if (!wh) return;

            var newStatus = wh.active === false ? true : false;
            var action = newStatus ? 'å•Ÿç”¨' : 'åœç”¨';

            if (!confirm('ç¢ºå®šè¦' + action + 'ã€Œ' + (wh.company ? wh.company + '_' : '') + wh.name + 'ã€å—ï¼Ÿ')) return;

            try {
                await window.updateDoc(window.doc(window.db, 'warehouses', id), {
                    active: newStatus,
                    updatedAt: new Date().toISOString()
                });

                wh.active = newStatus;
                renderWarehouseManagerList();
                updateWarehouseDropdown();
                showToast('âœ… å€‰åº«å·²' + action);

            } catch(e) {
                console.error('åˆ‡æ›ç‹€æ…‹å¤±æ•—:', e);
                showToast('âŒ æ“ä½œå¤±æ•—: ' + e.message);
            }
        };

        // ========== å¤–å€‰å‡ºåº« Modal æ“ä½œ ==========

        window.openExternalOutboundModal = function(id) {
            var stock = window.externalStock.find(function(s) { return s.id === id; });
            if (!stock) return;

            document.getElementById('ext-out-id').value = id;
            document.getElementById('ext-out-name').innerText = stock.productName;
            document.getElementById('ext-out-batch').innerText = stock.batchNo || '-';
            document.getElementById('ext-out-stock').innerText = stock.quantity || 0;
            document.getElementById('ext-out-qty').value = '';
            document.getElementById('ext-out-note').value = '';

            document.getElementById('modal-ext-outbound').classList.remove('hidden');
        };

        window.closeExtOutboundModal = function() {
            document.getElementById('modal-ext-outbound').classList.add('hidden');
        };

        window.confirmExtOutbound = async function() {
            var id = document.getElementById('ext-out-id').value;
            var qty = parseInt(document.getElementById('ext-out-qty').value) || 0;
            var note = document.getElementById('ext-out-note').value.trim();

            if (qty <= 0) {
                showToast('âŒ è«‹è¼¸å…¥æœ‰æ•ˆæ•¸é‡');
                return;
            }

            var result = await externalOutbound(id, qty, note);
            if (result) {
                closeExtOutboundModal();
                loadExternalStock();
            }
        };

        // ========== èª¿æ’¥åˆ°æœ¬å€‰ Modal æ“ä½œ ==========

        window.openTransferModal = function(id) {
            var stock = window.externalStock.find(function(s) { return s.id === id; });
            if (!stock) return;

            var whName = window.EXTERNAL_WAREHOUSES[stock.warehouseId]?.name || stock.warehouseId;

            document.getElementById('transfer-id').value = id;
            document.getElementById('transfer-name').innerText = stock.productName;
            document.getElementById('transfer-from').innerText = whName;
            document.getElementById('transfer-batch').innerText = stock.batchNo || '-';
            document.getElementById('transfer-exp').innerText = stock.expiryDate || stock.expDate || '-';
            document.getElementById('transfer-stock').innerText = stock.quantity || 0;
            document.getElementById('transfer-qty').value = '';
            document.getElementById('transfer-loc').value = '';

            document.getElementById('modal-transfer').classList.remove('hidden');
        };

        window.closeTransferModal = function() {
            document.getElementById('modal-transfer').classList.add('hidden');
        };

        window.confirmTransfer = async function() {
            var id = document.getElementById('transfer-id').value;
            var qty = parseInt(document.getElementById('transfer-qty').value) || 0;
            var loc = document.getElementById('transfer-loc').value.trim().toUpperCase();

            if (qty <= 0) {
                showToast('âŒ è«‹è¼¸å…¥æœ‰æ•ˆæ•¸é‡');
                return;
            }

            if (!loc) {
                showToast('âŒ è«‹è¼¸å…¥ç›®æ¨™å„²ä½');
                return;
            }

            if (!/^[A-H]-\d{2}-\d{2}$/.test(loc)) {
                showToast('âŒ å„²ä½æ ¼å¼ä¸æ­£ç¢ºï¼ˆä¾‹ï¼šA-01-01ï¼‰');
                return;
            }

            var result = await transferToMainWarehouse(id, qty, loc);
            if (result) {
                closeTransferModal();
                loadExternalStock();
                loadInventoryData(); // é‡æ–°è¼‰å…¥æœ¬å€‰åº«å­˜
            }
        };

        // ========== æ•ˆæœŸç®¡ç†ç³»çµ± ==========

        window.expirySettings = {
            soonDays: parseInt(localStorage.getItem('wms_expiry_soon_days') || '90')
        };

        window.saveExpirySettings = function() {
            var days = parseInt(document.getElementById('expiry-days-setting').value) || 90;
            window.expirySettings.soonDays = days;
            localStorage.setItem('wms_expiry_soon_days', days.toString());
        };

        window.loadExpirySettings = function() {
            var select = document.getElementById('expiry-days-setting');
            if (select) {
                select.value = window.expirySettings.soonDays.toString();
            }
        };

        window._expiryReportData = [];
        window._expiryCurrentFilter = 'all';

        function calculateDaysRemaining(expiryDate) {
            if (!expiryDate) return null;
            var today = new Date();
            today.setHours(0, 0, 0, 0);
            var expDate = new Date(expiryDate);
            expDate.setHours(0, 0, 0, 0);
            var diff = expDate - today;
            return Math.ceil(diff / (1000 * 60 * 60 * 24));
        }

        function getExpiryStatus(daysRemaining) {
            if (daysRemaining === null) return { status: 'unknown', label: 'æœªçŸ¥', color: 'slate', icon: 'question' };
            if (daysRemaining < 0) return { status: 'expired', label: 'å·²éæœŸ', color: 'red', icon: 'skull-crossbones' };
            if (daysRemaining <= 7) return { status: '7days', label: '7å¤©å…§', color: 'orange', icon: 'triangle-exclamation' };
            if (daysRemaining <= 30) return { status: '30days', label: '30å¤©å…§', color: 'yellow', icon: 'clock' };
            if (daysRemaining <= window.expirySettings.soonDays) return { status: 'soon', label: 'å³æœŸå“', color: 'cyan', icon: 'hourglass-half' };
            return { status: 'normal', label: 'æ­£å¸¸', color: 'emerald', icon: 'check-circle' };
        }

        window.refreshExpiryReport = function() {
            loadExpirySettings();

            var pallets = window.currentPallets ? window.currentPallets() : [];
            var reportData = [];

            var stats = {
                expired: { count: 0, qty: 0 },
                '7days': { count: 0, qty: 0 },
                '30days': { count: 0, qty: 0 },
                soon: { count: 0, qty: 0 },
                normal: { count: 0, qty: 0 }
            };

            pallets.forEach(function(p) {
                var expDate = p.expiryDate || p.expDate;
                var daysRemaining = calculateDaysRemaining(expDate);
                var status = getExpiryStatus(daysRemaining);
                var qty = parseInt(p.quantity) || 0;

                reportData.push({
                    palletId: p.palletId,
                    productName: p.productName,
                    spec: p.spec || '',
                    locationId: p.locationId,
                    quantity: qty,
                    expiryDate: expDate || '',
                    daysRemaining: daysRemaining,
                    status: status,
                    batchNo: p.batchNo || ''
                });

                if (status.status === 'expired') {
                    stats.expired.count++;
                    stats.expired.qty += qty;
                } else if (status.status === '7days') {
                    stats['7days'].count++;
                    stats['7days'].qty += qty;
                } else if (status.status === '30days') {
                    stats['30days'].count++;
                    stats['30days'].qty += qty;
                } else if (status.status === 'soon') {
                    stats.soon.count++;
                    stats.soon.qty += qty;
                } else if (status.status === 'normal') {
                    stats.normal.count++;
                    stats.normal.qty += qty;
                }
            });

            reportData.sort(function(a, b) {
                if (a.daysRemaining === null && b.daysRemaining === null) return 0;
                if (a.daysRemaining === null) return 1;
                if (b.daysRemaining === null) return -1;
                return a.daysRemaining - b.daysRemaining;
            });

            window._expiryReportData = reportData;

            document.getElementById('expiry-stat-expired').innerText = stats.expired.count;
            document.getElementById('expiry-stat-expired-qty').innerText = stats.expired.qty.toLocaleString() + ' ä»¶';
            document.getElementById('expiry-stat-7days').innerText = stats['7days'].count;
            document.getElementById('expiry-stat-7days-qty').innerText = stats['7days'].qty.toLocaleString() + ' ä»¶';
            document.getElementById('expiry-stat-30days').innerText = stats['30days'].count;
            document.getElementById('expiry-stat-30days-qty').innerText = stats['30days'].qty.toLocaleString() + ' ä»¶';
            document.getElementById('expiry-stat-soon').innerText = stats.soon.count;
            document.getElementById('expiry-stat-soon-qty').innerText = stats.soon.qty.toLocaleString() + ' ä»¶';
            document.getElementById('expiry-stat-normal').innerText = stats.normal.count;
            document.getElementById('expiry-stat-normal-qty').innerText = stats.normal.qty.toLocaleString() + ' ä»¶';

            renderExpiryTable();
        };

        window.filterExpiryReport = function(filter) {
            window._expiryCurrentFilter = filter;

            document.querySelectorAll('.expiry-filter-btn').forEach(function(btn) {
                if (btn.dataset.filter === filter) {
                    btn.className = 'expiry-filter-btn active bg-slate-700 text-white px-4 py-2 rounded-lg text-sm font-bold';
                } else {
                    btn.className = 'expiry-filter-btn bg-slate-800 text-slate-400 px-4 py-2 rounded-lg text-sm font-bold';
                }
            });

            renderExpiryTable();
        };

        window.filterExpiryBySearch = function() {
            renderExpiryTable();
        };

        function renderExpiryTable() {
            var tbody = document.getElementById('expiry-table-body');
            if (!tbody) return;

            var data = window._expiryReportData;
            var filter = window._expiryCurrentFilter;
            var search = (document.getElementById('expiry-search').value || '').toLowerCase();

            var filtered = data.filter(function(item) {
                if (filter !== 'all' && item.status.status !== filter) return false;
                if (search && item.productName.toLowerCase().indexOf(search) === -1) return false;
                return true;
            });

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center text-slate-500 py-8">ç„¡ç¬¦åˆæ¢ä»¶çš„è³‡æ–™</td></tr>';
                return;
            }

            var html = '';
            filtered.forEach(function(item) {
                var statusColor = item.status.color;
                var daysText = item.daysRemaining === null ? '-' :
                    (item.daysRemaining < 0 ? 'å·²éæœŸ ' + Math.abs(item.daysRemaining) + ' å¤©' : item.daysRemaining + ' å¤©');

                html += '<tr class="hover:bg-slate-800/50">';
                html += '<td class="p-3"><span class="badge badge-' + statusColor + '"><i class="fa-solid fa-' + item.status.icon + ' mr-1"></i>' + item.status.label + '</span></td>';
                html += '<td class="p-3 font-bold text-white">' + item.productName + '</td>';
                html += '<td class="p-3 text-slate-400">' + (item.spec || '-') + '</td>';
                html += '<td class="p-3 font-mono text-cyan-400">' + item.locationId + '</td>';
                html += '<td class="p-3 text-right font-bold">' + item.quantity.toLocaleString() + '</td>';
                html += '<td class="p-3 text-' + statusColor + '-400 font-bold">' + (item.expiryDate || '-') + '</td>';
                html += '<td class="p-3 text-' + statusColor + '-400 font-bold">' + daysText + '</td>';
                html += '<td class="p-3 text-slate-400">' + (item.batchNo || '-') + '</td>';
                html += '<td class="p-3 text-center">';
                if (item.status.status === 'expired') {
                    html += '<button onclick="initiateScrap(\'' + item.palletId + '\')" class="bg-red-600 hover:bg-red-500 text-white text-xs px-2 py-1 rounded">å ±å»¢</button>';
                } else {
                    html += '<button onclick="viewPalletDetail(\'' + item.palletId + '\')" class="bg-slate-700 hover:bg-slate-600 text-white text-xs px-2 py-1 rounded">æŸ¥çœ‹</button>';
                }
                html += '</td>';
                html += '</tr>';
            });

            tbody.innerHTML = html;
        }

        window.initiateScrap = async function(palletId) {
            if (!confirm('ç¢ºå®šè¦å°‡æ­¤æ¿è™Ÿæ¨™è¨˜ç‚ºå ±å»¢ï¼Ÿ\n\næ¿è™Ÿï¼š' + palletId)) return;

            var reason = prompt('è«‹è¼¸å…¥å ±å»¢åŸå› ï¼š', 'éæœŸå ±å»¢');
            if (reason === null) return;

            try {
                var pallets = window.currentPallets ? window.currentPallets() : [];
                var pallet = pallets.find(function(p) { return p.palletId === palletId; });

                if (!pallet) {
                    alert('æ‰¾ä¸åˆ°æ­¤æ¿è™Ÿ');
                    return;
                }

                await window.logInventoryChange({
                    type: 'scrap',
                    productName: pallet.productName,
                    spec: pallet.spec || '',
                    quantity: pallet.quantity,
                    quantityChange: -pallet.quantity,
                    locationId: pallet.locationId,
                    palletId: palletId,
                    batchNo: pallet.batchNo || '',
                    note: 'å ±å»¢ï¼š' + reason
                });

                var q = window.query(window.collection(window.db, 'pallets'), window.where('palletId', '==', palletId));
                var snap = await window.getDocs(q);
                if (!snap.empty) {
                    await window.deleteDoc(snap.docs[0].ref);
                }

                alert('âœ… å ±å»¢å®Œæˆ');
                loadInventory();
                refreshExpiryReport();

            } catch (err) {
                console.error('å ±å»¢å¤±æ•—:', err);
                alert('âŒ å ±å»¢å¤±æ•—ï¼š' + err.message);
            }
        };

        window.viewPalletDetail = function(palletId) {
            var pallets = window.currentPallets ? window.currentPallets() : [];
            var pallet = pallets.find(function(p) { return p.palletId === palletId; });

            if (!pallet) {
                alert('æ‰¾ä¸åˆ°æ­¤æ¿è™Ÿ');
                return;
            }

            var info = 'æ¿è™Ÿï¼š' + pallet.palletId + '\n';
            info += 'å“åï¼š' + pallet.productName + '\n';
            info += 'è¦æ ¼ï¼š' + (pallet.spec || '-') + '\n';
            info += 'æ•¸é‡ï¼š' + pallet.quantity + '\n';
            info += 'å„²ä½ï¼š' + pallet.locationId + '\n';
            info += 'æ•ˆæœŸï¼š' + (pallet.expiryDate || pallet.expDate || '-') + '\n';
            info += 'æ‰¹è™Ÿï¼š' + (pallet.batchNo || '-');

            alert(info);
        };

        window.printExpiryReport = function() {
            var data = window._expiryReportData;
            var filter = window._expiryCurrentFilter;
            var search = (document.getElementById('expiry-search').value || '').toLowerCase();

            var filtered = data.filter(function(item) {
                if (filter !== 'all' && item.status.status !== filter) return false;
                if (search && item.productName.toLowerCase().indexOf(search) === -1) return false;
                return true;
            });

            var filterNames = {
                'all': 'å…¨éƒ¨',
                'expired': 'å·²éæœŸ',
                '7days': '7å¤©å…§åˆ°æœŸ',
                '30days': '30å¤©å…§åˆ°æœŸ',
                'soon': 'å³æœŸå“ï¼ˆ' + window.expirySettings.soonDays + 'å¤©å…§ï¼‰',
                'normal': 'æ•ˆæœŸæ­£å¸¸'
            };

            var html = '<style>';
            html += 'body { font-family: "Microsoft JhengHei", sans-serif; }';
            html += '.header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 15px; }';
            html += '.header h1 { font-size: 20px; margin: 0; }';
            html += '.header .meta { font-size: 12px; color: #666; margin-top: 5px; }';
            html += 'table { width: 100%; border-collapse: collapse; font-size: 11px; }';
            html += 'th { background: #333; color: white; padding: 8px; text-align: left; }';
            html += 'td { padding: 6px 8px; border-bottom: 1px solid #ddd; }';
            html += 'tr:nth-child(even) { background: #f5f5f5; }';
            html += '.status-expired { color: #dc2626; font-weight: bold; }';
            html += '.status-7days { color: #ea580c; font-weight: bold; }';
            html += '.status-30days { color: #ca8a04; font-weight: bold; }';
            html += '.status-soon { color: #0891b2; font-weight: bold; }';
            html += '.status-normal { color: #16a34a; }';
            html += '.summary { margin-top: 20px; padding: 10px; background: #f5f5f5; border-radius: 4px; }';
            html += '</style>';

            html += '<div class="header">';
            html += '<h1>æ•ˆæœŸç®¡ç†å ±è¡¨</h1>';
            html += '<div class="meta">ç¯©é¸æ¢ä»¶ï¼š' + filterNames[filter] + ' | ç”¢ç”Ÿæ™‚é–“ï¼š' + new Date().toLocaleString('zh-TW') + '</div>';
            html += '</div>';

            html += '<table>';
            html += '<thead><tr>';
            html += '<th>ç‹€æ…‹</th><th>å“å</th><th>è¦æ ¼</th><th>å„²ä½</th><th>æ•¸é‡</th><th>æ•ˆæœŸ</th><th>å‰©é¤˜å¤©æ•¸</th><th>æ‰¹è™Ÿ</th>';
            html += '</tr></thead><tbody>';

            var totalQty = 0;
            filtered.forEach(function(item) {
                var daysText = item.daysRemaining === null ? '-' :
                    (item.daysRemaining < 0 ? 'å·²éæœŸ ' + Math.abs(item.daysRemaining) + ' å¤©' : item.daysRemaining + ' å¤©');

                html += '<tr>';
                html += '<td class="status-' + item.status.status + '">' + item.status.label + '</td>';
                html += '<td>' + item.productName + '</td>';
                html += '<td>' + (item.spec || '-') + '</td>';
                html += '<td>' + item.locationId + '</td>';
                html += '<td style="text-align:right">' + item.quantity.toLocaleString() + '</td>';
                html += '<td>' + (item.expiryDate || '-') + '</td>';
                html += '<td class="status-' + item.status.status + '">' + daysText + '</td>';
                html += '<td>' + (item.batchNo || '-') + '</td>';
                html += '</tr>';

                totalQty += item.quantity;
            });

            html += '</tbody></table>';

            html += '<div class="summary">';
            html += '<strong>çµ±è¨ˆï¼š</strong>å…± ' + filtered.length + ' æ¿ / ' + totalQty.toLocaleString() + ' ä»¶';
            html += '</div>';

            openPrintPreview(html, 'æ•ˆæœŸç®¡ç†å ±è¡¨', 1000, 800);
        };

        window.checkExpiryAlert = function() {
            var pallets = window.currentPallets ? window.currentPallets() : [];
            var expired = [];
            var urgent = []; // 7å¤©å…§

            pallets.forEach(function(p) {
                var expDate = p.expiryDate || p.expDate;
                var days = calculateDaysRemaining(expDate);
                if (days !== null) {
                    if (days < 0) {
                        expired.push(p);
                    } else if (days <= 7) {
                        urgent.push(p);
                    }
                }
            });

            if (expired.length > 0 || urgent.length > 0) {
                var msg = 'âš ï¸ æ•ˆæœŸè­¦ç¤º âš ï¸\n\n';
                if (expired.length > 0) {
                    msg += 'âŒ å·²éæœŸï¼š' + expired.length + ' æ¿\n';
                }
                if (urgent.length > 0) {
                    msg += 'â° 7å¤©å…§åˆ°æœŸï¼š' + urgent.length + ' æ¿\n';
                }
                msg += '\nè«‹è‡³ã€Œæ•ˆæœŸç®¡ç†ã€æŸ¥çœ‹è©³æƒ…ã€‚';

                setTimeout(function() {
                    alert(msg);
                }, 2000);
            }
        };

        // ========== å“é …ä¸»æª”ç®¡ç† ==========

        window.productMasterData = [];

        window.loadProductMasterFromFirebase = async function() {
            try {
                if (!window.db || !window.collection || !window.getDocs) {
                    console.log('Firebase å°šæœªåˆå§‹åŒ–ï¼Œä½¿ç”¨ localStorage');
                    window.productMasterData = JSON.parse(localStorage.getItem('wms_product_master') || '[]');
                    loadProductMasterList();
                    return;
                }

                var snapshot = await window.getDocs(window.collection(window.db, 'productMaster'));
                window.productMasterData = [];
                snapshot.forEach(function(doc) {
                    window.productMasterData.push({ id: doc.id, ...doc.data() });
                });

                console.log('å“é …ä¸»æª”å·²è¼‰å…¥:', window.productMasterData.length, 'ç­†');
                loadProductMasterList();
            } catch(e) {
                console.error('è¼‰å…¥å“é …ä¸»æª”å¤±æ•—:', e);
                window.productMasterData = JSON.parse(localStorage.getItem('wms_product_master') || '[]');
                loadProductMasterList();
            }
        };

        window.loadProductMasterList = function() {
            var tbody = document.getElementById('product-master-list');
            if (!tbody) return;

            var data = window.productMasterData;
            var search = (document.getElementById('pm-search')?.value || '').toLowerCase();

            if (search) {
                data = data.filter(function(p) {
                    return (p.code || '').toLowerCase().includes(search) ||
                           (p.name || '').toLowerCase().includes(search) ||
                           (p.spec || '').toLowerCase().includes(search);
                });
            }

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-slate-500 py-10">ç„¡å“é …è³‡æ–™ï¼Œè«‹æ–°å¢æˆ–å¾åº«å­˜åŒ¯å…¥</td></tr>';
                document.getElementById('pm-total-count').innerText = '0';
                return;
            }

            var html = '';
            data.forEach(function(p, idx) {
                var docId = p.id || idx;
                
                // è¨ˆé‡æ–¹å¼
                var weightType = p.weightType || 'fixed';
                var weightBadge = weightType === 'variable' 
                    ? '<span class="px-1.5 py-0.5 rounded text-[10px] bg-amber-600/30 text-amber-400">ä¸å®šé‡</span>'
                    : '<span class="px-1.5 py-0.5 rounded text-[10px] bg-blue-600/30 text-blue-400">å®šé‡</span>';
                
                // ç®±å®¹
                var unitWeight = p.unitWeight || 0;
                var unitWeightText = unitWeight > 0 ? unitWeight + '<span class="text-slate-500 text-[10px]">kg</span>' : '<span class="text-slate-600">-</span>';
                
                // å…¥åº«é¡å‹
                var inboundType = p.inboundType || 'Raw';
                var inboundTypeMap = { 'Raw': 'æ¡è³¼', 'FG': 'æˆå“', 'WIP': 'åŠæˆå“', 'Return': 'é€€åº«' };
                var inboundTypeColors = { 'Raw': 'emerald', 'FG': 'blue', 'WIP': 'yellow', 'Return': 'orange' };
                var itColor = inboundTypeColors[inboundType] || 'slate';
                var inboundBadge = '<span class="px-1.5 py-0.5 rounded text-[10px] bg-' + itColor + '-600/30 text-' + itColor + '-400">' + (inboundTypeMap[inboundType] || inboundType) + '</span>';

                html += '<tr class="border-b border-slate-700 hover:bg-slate-800">';
                html += '<td class="p-2 text-cyan-400 font-mono text-xs">' + (p.code || '-') + '</td>';
                html += '<td class="p-2 text-white font-bold">' + p.name + '</td>';
                html += '<td class="p-2 text-yellow-400 text-sm">' + (p.spec || '-') + '</td>';
                html += '<td class="p-2 text-center">' + weightBadge + '</td>';
                html += '<td class="p-2 text-center text-sm">' + unitWeightText + '</td>';
                html += '<td class="p-2 text-center"><span class="text-cyan-400 font-bold">' + (p.palletCapacity || '-') + '</span></td>';
                html += '<td class="p-2 text-center">' + inboundBadge + '</td>';
                html += '<td class="p-2 text-center">';
                html += '<button onclick="editProductMaster(\'' + docId + '\')" class="text-blue-400 hover:bg-blue-500/20 rounded px-2 py-1 mr-1"><i class="fa-solid fa-edit"></i></button>';
                html += '<button onclick="deleteProductMaster(\'' + docId + '\')" class="text-red-400 hover:bg-red-500/20 rounded px-2 py-1"><i class="fa-solid fa-trash"></i></button>';
                html += '</td>';
                html += '</tr>';
            });

            tbody.innerHTML = html;
            document.getElementById('pm-total-count').innerText = data.length;
        };

        window.filterProductMaster = function() {
            loadProductMasterList();
        };

        window.saveProductMaster = async function() {
            var code = document.getElementById('pm-code').value.trim();
            var name = document.getElementById('pm-name').value.trim();
            var spec = document.getElementById('pm-spec').value.trim();
            var palletCapacity = parseInt(document.getElementById('pm-pallet-capacity').value) || 0;
            var partialThreshold = parseInt(document.getElementById('pm-partial-threshold').value) || 50;
            var shelfLife = parseInt(document.getElementById('pm-shelf-life').value) || 24;
            var category = document.getElementById('pm-category').value;
            var note = document.getElementById('pm-note').value.trim();
            var editId = document.getElementById('pm-edit-id').value;
            
            // æ–°å¢æ¬„ä½
            var weightTypeRadio = document.querySelector('input[name="pm-weight-type"]:checked');
            var weightType = weightTypeRadio ? weightTypeRadio.value : 'fixed';
            var inboundTypeRadio = document.querySelector('input[name="pm-inbound-type"]:checked');
            var inboundType = inboundTypeRadio ? inboundTypeRadio.value : 'Raw';
            var unitWeight = parseFloat(document.getElementById('pm-unit-weight').value) || 0;

            if (!name) {
                alert('è«‹è¼¸å…¥å“å');
                return;
            }

            var item = {
                code: code,
                name: name,
                spec: spec,
                palletCapacity: palletCapacity,
                partialThreshold: partialThreshold,
                shelfLife: shelfLife,
                category: category,
                note: note,
                weightType: weightType,
                inboundType: inboundType,
                unitWeight: unitWeight,
                updatedAt: new Date().toISOString()
            };

            try {
                if (editId) {
                    if (window.db && window.updateDoc) {
                        await window.updateDoc(window.doc(window.db, 'productMaster', editId), item);
                    }
                    var idx = window.productMasterData.findIndex(function(p) { return p.id === editId; });
                    if (idx >= 0) {
                        window.productMasterData[idx] = { id: editId, ...item };
                    }
                    alert('âœ… å“é …å·²æ›´æ–°');
                } else {
                    var exists = window.productMasterData.find(function(p) {
                        return p.name === name && p.spec === spec;
                    });

                    if (exists) {
                        if (!confirm('å“é …ã€Œ' + name + ' ' + spec + 'ã€å·²å­˜åœ¨ï¼Œæ˜¯å¦è¦†è“‹ï¼Ÿ')) {
                            return;
                        }
                        if (window.db && window.updateDoc && exists.id) {
                            await window.updateDoc(window.doc(window.db, 'productMaster', exists.id), item);
                        }
                        var existIdx = window.productMasterData.findIndex(function(p) { return p.id === exists.id; });
                        if (existIdx >= 0) {
                            window.productMasterData[existIdx] = { id: exists.id, ...item };
                        }
                    } else {
                        if (window.db && window.addDoc) {
                            var docRef = await window.addDoc(window.collection(window.db, 'productMaster'), item);
                            window.productMasterData.push({ id: docRef.id, ...item });
                        } else {
                            window.productMasterData.push(item);
                        }
                    }
                    alert('âœ… å“é …å·²å„²å­˜');
                }

                localStorage.setItem('wms_product_master', JSON.stringify(window.productMasterData));

                clearProductMasterForm();
                loadProductMasterList();
            } catch(e) {
                console.error('å„²å­˜å“é …å¤±æ•—:', e);
                alert('âŒ å„²å­˜å¤±æ•—ï¼š' + e.message);
            }
        };

        window.editProductMaster = function(docId) {
            var item = window.productMasterData.find(function(p) { return p.id === docId; });
            if (!item) {
                item = window.productMasterData[parseInt(docId)];
            }
            if (!item) return;

            document.getElementById('pm-code').value = item.code || '';
            document.getElementById('pm-name').value = item.name || '';
            document.getElementById('pm-spec').value = item.spec || '';
            document.getElementById('pm-pallet-capacity').value = item.palletCapacity || '';
            document.getElementById('pm-partial-threshold').value = item.partialThreshold || 50;
            document.getElementById('pm-shelf-life').value = item.shelfLife || '';
            document.getElementById('pm-category').value = item.category || 'æˆå“';
            document.getElementById('pm-note').value = item.note || '';
            document.getElementById('pm-edit-id').value = item.id || docId;
            
            // æ–°å¢æ¬„ä½
            document.getElementById('pm-unit-weight').value = item.unitWeight || '';
            var weightType = item.weightType || 'fixed';
            var wtRadio = document.querySelector('input[name="pm-weight-type"][value="' + weightType + '"]');
            if (wtRadio) wtRadio.checked = true;
            var inboundType = item.inboundType || 'Raw';
            var itRadio = document.querySelector('input[name="pm-inbound-type"][value="' + inboundType + '"]');
            if (itRadio) itRadio.checked = true;
        };

        window.deleteProductMaster = async function(docId) {
            var item = window.productMasterData.find(function(p) { return p.id === docId; });
            if (!item) {
                item = window.productMasterData[parseInt(docId)];
            }
            if (!item) return;

            if (!confirm('ç¢ºå®šåˆªé™¤å“é …ã€Œ' + item.name + ' ' + (item.spec || '') + 'ã€ï¼Ÿ')) {
                return;
            }

            try {
                if (window.db && window.deleteDoc && item.id) {
                    await window.deleteDoc(window.doc(window.db, 'productMaster', item.id));
                }

                var idx = window.productMasterData.findIndex(function(p) { return p.id === item.id; });
                if (idx >= 0) {
                    window.productMasterData.splice(idx, 1);
                }

                localStorage.setItem('wms_product_master', JSON.stringify(window.productMasterData));

                loadProductMasterList();
                alert('âœ… å“é …å·²åˆªé™¤');
            } catch(e) {
                console.error('åˆªé™¤å“é …å¤±æ•—:', e);
                alert('âŒ åˆªé™¤å¤±æ•—ï¼š' + e.message);
            }
        };

        window.clearAllProductMaster = async function() {
            var count = window.productMasterData.length;
            if (count === 0) {
                alert('å“é …ä¸»æª”å·²ç¶“æ˜¯ç©ºçš„');
                return;
            }

            if (!confirm('âš ï¸ ç¢ºå®šè¦æ¸…ç©ºå…¨éƒ¨ ' + count + ' ç­†å“é …ä¸»æª”ï¼Ÿ\n\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) {
                return;
            }

            if (!confirm('ğŸš¨ å†æ¬¡ç¢ºèªï¼šåˆªé™¤å…¨éƒ¨ ' + count + ' ç­†è³‡æ–™ï¼Ÿ')) {
                return;
            }

            try {
                if (window.db && window.deleteDoc) {
                    for (var i = 0; i < window.productMasterData.length; i++) {
                        var item = window.productMasterData[i];
                        if (item.id) {
                            try {
                                await window.deleteDoc(window.doc(window.db, 'productMaster', item.id));
                            } catch(e) {
                                console.error('åˆªé™¤å¤±æ•—:', item.name, e);
                            }
                        }
                    }
                }

                window.productMasterData = [];
                localStorage.setItem('wms_product_master', '[]');

                loadProductMasterList();
                alert('âœ… å·²æ¸…ç©º ' + count + ' ç­†å“é …ä¸»æª”');
            } catch(e) {
                console.error('æ¸…ç©ºå“é …ä¸»æª”å¤±æ•—:', e);
                alert('âŒ æ¸…ç©ºå¤±æ•—ï¼š' + e.message);
            }
        };

        window.clearProductMasterForm = function() {
            document.getElementById('pm-code').value = '';
            document.getElementById('pm-name').value = '';
            document.getElementById('pm-spec').value = '';
            document.getElementById('pm-pallet-capacity').value = '';
            document.getElementById('pm-partial-threshold').value = '50';
            document.getElementById('pm-shelf-life').value = '24';
            document.getElementById('pm-category').value = 'æˆå“';
            document.getElementById('pm-note').value = '';
            document.getElementById('pm-edit-id').value = '';
            
            // é‡ç½®æ–°æ¬„ä½
            document.getElementById('pm-unit-weight').value = '';
            var fixedRadio = document.querySelector('input[name="pm-weight-type"][value="fixed"]');
            if (fixedRadio) fixedRadio.checked = true;
            var rawRadio = document.querySelector('input[name="pm-inbound-type"][value="Raw"]');
            if (rawRadio) rawRadio.checked = true;
        };

        window.clearAllProductMaster = async function() {
            var count = window.productMasterData.length;
            if (count === 0) {
                alert('å“é …ä¸»æª”å·²ç¶“æ˜¯ç©ºçš„');
                return;
            }

            if (!confirm('âš ï¸ ç¢ºå®šè¦æ¸…ç©ºå…¨éƒ¨ ' + count + ' ç­†å“é …ä¸»æª”å—ï¼Ÿ\n\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) {
                return;
            }

            if (!confirm('âš ï¸ å†æ¬¡ç¢ºèªï¼šåˆªé™¤å…¨éƒ¨ ' + count + ' ç­†è³‡æ–™ï¼Ÿ')) {
                return;
            }

            try {
                if (window.db && window.deleteDoc) {
                    for (var i = 0; i < window.productMasterData.length; i++) {
                        var item = window.productMasterData[i];
                        if (item.id) {
                            try {
                                await window.deleteDoc(window.doc(window.db, 'productMaster', item.id));
                            } catch(e) {
                                console.error('åˆªé™¤å“é …å¤±æ•—:', item.name, e);
                            }
                        }
                    }
                }

                window.productMasterData = [];
                localStorage.setItem('wms_product_master', '[]');

                loadProductMasterList();

                alert('âœ… å·²æ¸…ç©ºå…¨éƒ¨å“é …ä¸»æª”ï¼ˆå…± ' + count + ' ç­†ï¼‰');
            } catch(e) {
                console.error('æ¸…ç©ºå“é …ä¸»æª”å¤±æ•—:', e);
                alert('âŒ æ¸…ç©ºå¤±æ•—ï¼š' + e.message);
            }
        };

        window.autoImportFromInventory = async function() {
            var pallets = window.currentPallets();
            if (!pallets || pallets.length === 0) {
                alert('ç›®å‰æ²’æœ‰åº«å­˜è³‡æ–™');
                return;
            }

            var products = {};
            pallets.forEach(function(p) {
                var key = p.productName + '|' + (p.spec || '');
                if (!products[key] && p.productName) {
                    products[key] = {
                        name: p.productName,
                        spec: p.spec || ''
                    };
                }
            });

            var productList = Object.values(products);

            var existingKeys = {};
            window.productMasterData.forEach(function(p) {
                existingKeys[p.name + '|' + (p.spec || '')] = true;
            });

            var newProducts = productList.filter(function(p) {
                return !existingKeys[p.name + '|' + (p.spec || '')];
            });

            if (newProducts.length === 0) {
                alert('æ‰€æœ‰å“é …éƒ½å·²åœ¨ä¸»æª”ä¸­');
                return;
            }

            if (!confirm('ç™¼ç¾ ' + newProducts.length + ' å€‹æ–°å“é …ï¼Œæ˜¯å¦åŒ¯å…¥ï¼Ÿ\n\nåŒ¯å…¥å¾Œè«‹æ‰‹å‹•è¨­å®šå„å“é …çš„æ¿å®¹é‡')) {
                return;
            }

            try {
                for (var i = 0; i < newProducts.length; i++) {
                    var p = newProducts[i];
                    var item = {
                        name: p.name,
                        spec: p.spec,
                        palletCapacity: 40, // é è¨­å€¼
                        partialThreshold: 50,
                        shelfLife: 24, // é è¨­ 2 å¹´
                        category: 'æˆå“',
                        note: 'è‡ªå‹•åŒ¯å…¥',
                        updatedAt: new Date().toISOString()
                    };

                    if (window.db && window.addDoc) {
                        var docRef = await window.addDoc(window.collection(window.db, 'productMaster'), item);
                        window.productMasterData.push({ id: docRef.id, ...item });
                    } else {
                        window.productMasterData.push(item);
                    }
                }

                localStorage.setItem('wms_product_master', JSON.stringify(window.productMasterData));

                loadProductMasterList();
                alert('âœ… å·²åŒ¯å…¥ ' + newProducts.length + ' å€‹å“é …\n\nè«‹ç·¨è¼¯è¨­å®šæ­£ç¢ºçš„æ¿å®¹é‡');
            } catch(e) {
                console.error('åŒ¯å…¥å“é …å¤±æ•—:', e);
                alert('âŒ åŒ¯å…¥å¤±æ•—ï¼š' + e.message);
            }
        };

        window.getProductPalletCapacity = function(productName, spec) {
            var item = window.productMasterData.find(function(p) {
                return p.name === productName && (p.spec || '') === (spec || '');
            });
            if (item) {
                return {
                    palletCapacity: item.palletCapacity,
                    partialThreshold: item.partialThreshold || 50
                };
            }
            return null; // æ²’è¨­å®šï¼Œä½¿ç”¨æ–¹æ¡ˆ D
        };

        // ========== å“é …ä¸»æª” Excel åŒ¯å…¥åŠŸèƒ½ ==========

        window.pmImportData = [];

        window.showProductMasterImport = function() {
            document.getElementById('modal-pm-import').classList.remove('hidden');
            document.getElementById('pm-import-step1').classList.remove('hidden');
            document.getElementById('pm-import-step2').classList.add('hidden');
            document.getElementById('pm-import-step3').classList.add('hidden');
            document.getElementById('pm-import-file').value = '';
            document.getElementById('pm-import-btn').disabled = true;
            window.pmImportData = [];
        };

        window.closeProductMasterImport = function() {
            document.getElementById('modal-pm-import').classList.add('hidden');
            window.pmImportData = [];
        };

        window.downloadProductMasterTemplate = function() {
            var template = [
                ['å“è™Ÿ', 'å“å', 'è¦æ ¼', 'æ¿å®¹é‡', 'ä¿å­˜æœŸ(æœˆ)', 'é¡åˆ¥', 'å‚™è¨»'],
                ['A001', 'å†·å‡è¦ä»', '300/400', '40', '24', 'æˆå“', 'ç¯„ä¾‹è³‡æ–™'],
                ['A002', 'å†·å‡é­šç‰‡', '500g', '40', '18', 'æˆå“', ''],
                ['B001', 'ç™½è¦åŸæ–™', '10kg', '40', '24', 'åŸæ–™', '']
            ];

            var ws = XLSX.utils.aoa_to_sheet(template);

            ws['!cols'] = [
                { wch: 15 },  // å“è™Ÿ
                { wch: 20 },  // å“å
                { wch: 15 },  // è¦æ ¼
                { wch: 10 },  // æ¿å®¹é‡
                { wch: 12 },  // ä¿å­˜æœŸ
                { wch: 10 },  // é¡åˆ¥
                { wch: 20 }   // å‚™è¨»
            ];

            var wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'å“é …ä¸»æª”');
            XLSX.writeFile(wb, 'å“é …ä¸»æª”ç¯„æœ¬.xlsx');

            alert('âœ… ç¯„æœ¬å·²ä¸‹è¼‰');
        };

        window.exportProductMaster = function() {
            if (!window.productMasterData || window.productMasterData.length === 0) {
                alert('ç›®å‰æ²’æœ‰å“é …è³‡æ–™');
                return;
            }

            var data = [['å“è™Ÿ', 'å“å', 'è¦æ ¼', 'æ¿å®¹é‡', 'ä¿å­˜æœŸ(æœˆ)', 'é¡åˆ¥', 'å‚™è¨»']];

            window.productMasterData.forEach(function(p) {
                data.push([
                    p.code || '',
                    p.name || '',
                    p.spec || '',
                    p.palletCapacity || '',
                    p.shelfLife || '',
                    p.category || 'æˆå“',
                    p.note || ''
                ]);
            });

            var ws = XLSX.utils.aoa_to_sheet(data);
            ws['!cols'] = [
                { wch: 15 }, { wch: 20 }, { wch: 15 },
                { wch: 10 }, { wch: 12 }, { wch: 10 }, { wch: 20 }
            ];

            var wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'å“é …ä¸»æª”');
            XLSX.writeFile(wb, 'å“é …ä¸»æª”_' + new Date().toISOString().slice(0,10) + '.xlsx');

            alert('âœ… å·²åŒ¯å‡º ' + window.productMasterData.length + ' ç­†');
        };

        window.previewProductMasterImport = function() {
            var fileInput = document.getElementById('pm-import-file');
            var file = fileInput.files[0];
            if (!file) return;

            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    var data = new Uint8Array(e.target.result);
                    var workbook = XLSX.read(data, { type: 'array' });
                    var sheetName = workbook.SheetNames[0];
                    var sheet = workbook.Sheets[sheetName];
                    var jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });

                    if (jsonData.length < 2) {
                        alert('æª”æ¡ˆæ²’æœ‰è³‡æ–™æˆ–æ ¼å¼éŒ¯èª¤');
                        return;
                    }

                    var headerRowIndex = 0;
                    for (var h = 0; h < Math.min(10, jsonData.length); h++) {
                        var row = jsonData[h];
                        if (!row) continue;
                        var rowStr = row.join('|').toLowerCase();
                        if ((rowStr.includes('å“è™Ÿ') || rowStr.includes('å“å')) &&
                            !rowStr.includes('è£½è¡¨') && !rowStr.includes('è³‡æ–™æ—¥æœŸ')) {
                            headerRowIndex = h;
                            break;
                        }
                    }

                    var headers = jsonData[headerRowIndex].map(function(h) { return String(h || '').trim(); });
                    var colMap = {};

                    var fieldMappings = {
                        'code': ['å“è™Ÿ', 'ç·¨è™Ÿ', 'code', 'ç”¢å“ç·¨è™Ÿ', 'å“é …ç·¨è™Ÿ', 'è²¨è™Ÿ'],
                        'name': ['å“å', 'ç”¢å“åç¨±', 'å“é …åç¨±', 'å•†å“åç¨±'],
                        'spec': ['è¦æ ¼', 'spec', 'è¦æ ¼èªªæ˜', 'ç”¢å“è¦æ ¼'],
                        'palletCapacity': ['æ¿å®¹é‡', 'æ¯æ¿ä»¶æ•¸', 'æ¿å®¹é‡(ä»¶)', 'palletCapacity'],
                        'shelfLife': ['ä¿å­˜æœŸ', 'ä¿å­˜æœŸé™', 'ä¿å­˜æœˆæ•¸', 'ä¿å­˜æœŸ(æœˆ)', 'shelfLife'],
                        'category': ['é¡åˆ¥', 'åˆ†é¡', 'category', 'ç”¢å“é¡åˆ¥'],
                        'note': ['å‚™è¨»', 'èªªæ˜', 'note', 'å‚™è€ƒ']
                    };

                    var excludeHeaders = ['åº«åˆ¥åç¨±', 'åº«åˆ¥', 'å€‰åº«', 'å–®ä½', 'æ•¸é‡', 'åº«å­˜æ•¸é‡', 'åŒ…è£æ•¸é‡'];

                    headers.forEach(function(h, idx) {
                        if (excludeHeaders.some(function(ex) { return h.includes(ex); })) {
                            return;
                        }

                        for (var field in fieldMappings) {
                            if (colMap[field] !== undefined) continue;

                            if (fieldMappings[field].some(function(n) {
                                return h === n || h.toLowerCase() === n.toLowerCase();
                            })) {
                                colMap[field] = idx;
                                break;
                            }
                        }
                    });

                    console.log('æ¬„ä½å°æ‡‰çµæœ:', colMap);
                    console.log('æ¨™é¡Œè¡Œ:', headers);

                    if (colMap.name === undefined && colMap.code === undefined) {
                        alert('æ‰¾ä¸åˆ°ã€Œå“è™Ÿã€æˆ–ã€Œå“åã€æ¬„ä½ï¼Œè«‹ç¢ºèª Excel æ ¼å¼\n\nè­˜åˆ¥åˆ°çš„æ¨™é¡Œ: ' + headers.join(', '));
                        return;
                    }

                    var importItems = [];
                    var seenCodes = {};  // ç”¨æ–¼å»é‡è¤‡
                    var newCount = 0, updateCount = 0, errorCount = 0, skipDupCount = 0;

                    var existingByCode = {};
                    var existingByNameSpec = {};
                    window.productMasterData.forEach(function(p) {
                        if (p.code) existingByCode[p.code] = p;
                        existingByNameSpec[p.name + '|' + (p.spec || '')] = p;
                    });

                    for (var i = headerRowIndex + 1; i < jsonData.length; i++) {
                        var row = jsonData[i];
                        if (!row || row.length === 0) continue;

                        var code = colMap.code !== undefined ? String(row[colMap.code] || '').trim() : '';
                        var name = colMap.name !== undefined ? String(row[colMap.name] || '').trim() : '';
                        var spec = colMap.spec !== undefined ? String(row[colMap.spec] || '').trim() : '';
                        var palletCapacity = colMap.palletCapacity !== undefined ? parseInt(row[colMap.palletCapacity]) || 0 : 0;
                        var shelfLife = colMap.shelfLife !== undefined ? parseInt(row[colMap.shelfLife]) || 0 : 0;
                        var category = colMap.category !== undefined ? String(row[colMap.category] || '').trim() : '';
                        var note = colMap.note !== undefined ? String(row[colMap.note] || '').trim() : '';

                        if (!name && !code) continue;
                        if (code && (code.includes('è£½è¡¨æ—¥æœŸ') || code.includes('è³‡æ–™æ—¥æœŸ') || code === 'å“è™Ÿ')) continue;
                        if (name && (name.includes('å°è¨ˆ') || name.includes('åˆè¨ˆ'))) continue;

                        if (!name && code) name = code;

                        var dupKey = code || (name + '|' + spec);
                        if (seenCodes[dupKey]) {
                            skipDupCount++;
                            continue;
                        }
                        seenCodes[dupKey] = true;

                        if (!category || !['æˆå“', 'åŸæ–™', 'åŠæˆå“', 'åŒ…æ'].includes(category)) {
                            if (name.includes('åŸæ–™') || name.includes('åŸ') && name.includes('æ–™')) {
                                category = 'åŸæ–™';
                            } else if (name.includes('åŠæˆå“')) {
                                category = 'åŠæˆå“';
                            } else if (name.includes('åŒ…æ') || name.includes('ç´™ç®±') || name.includes('è† å¸¶') || name.includes('æ¨™ç±¤')) {
                                category = 'åŒ…æ';
                            } else {
                                category = 'æˆå“';
                            }
                        }

                        var status = 'new';
                        var existingItem = null;
                        var error = '';

                        if (code && existingByCode[code]) {
                            existingItem = existingByCode[code];
                            status = 'update';
                        } else if (existingByNameSpec[name + '|' + spec]) {
                            existingItem = existingByNameSpec[name + '|' + spec];
                            status = 'update';
                        }

                        if (!palletCapacity || palletCapacity < 1) {
                            if (existingItem && existingItem.palletCapacity) {
                                palletCapacity = existingItem.palletCapacity;
                            } else {
                                palletCapacity = 40;
                                note = (note ? note + ' | ' : '') + 'æ¿å®¹é‡å¾…è¨­å®š';
                            }
                        }

                        if (!shelfLife || shelfLife < 1) {
                            if (existingItem && existingItem.shelfLife) {
                                shelfLife = existingItem.shelfLife;
                            } else {
                                shelfLife = 24;
                            }
                        }

                        var item = {
                            code: code,
                            name: name,
                            spec: spec,
                            palletCapacity: palletCapacity,
                            shelfLife: shelfLife,
                            category: category,
                            note: note,
                            status: status,
                            error: error,
                            existingId: existingItem ? existingItem.id : null
                        };

                        importItems.push(item);

                        if (status === 'new') newCount++;
                        else if (status === 'update') updateCount++;
                        else if (status === 'error') errorCount++;
                    }

                    if (importItems.length === 0) {
                        alert('æ²’æœ‰æœ‰æ•ˆçš„è³‡æ–™å¯åŒ¯å…¥');
                        return;
                    }

                    window.pmImportData = importItems;

                    document.getElementById('pm-import-new-count').textContent = newCount;
                    document.getElementById('pm-import-update-count').textContent = updateCount;
                    document.getElementById('pm-import-error-count').textContent = errorCount;
                    document.getElementById('pm-import-skip-count').textContent = skipDupCount;

                    if (skipDupCount > 0) {
                        console.log('å·²è‡ªå‹•éæ¿¾ ' + skipDupCount + ' ç­†é‡è¤‡å“è™Ÿ');
                    }

                    var tbody = document.getElementById('pm-import-preview-body');
                    var html = '';

                    importItems.forEach(function(item, idx) {
                        var statusBadge = '';
                        var rowClass = '';

                        if (item.status === 'new') {
                            statusBadge = '<span class="px-2 py-0.5 bg-emerald-600 text-white text-xs rounded">æ–°å¢</span>';
                            rowClass = 'bg-emerald-900/20';
                        } else if (item.status === 'update') {
                            statusBadge = '<span class="px-2 py-0.5 bg-yellow-600 text-white text-xs rounded">æ›´æ–°</span>';
                            rowClass = 'bg-yellow-900/20';
                        } else {
                            statusBadge = '<span class="px-2 py-0.5 bg-red-600 text-white text-xs rounded" title="' + item.error + '">éŒ¯èª¤</span>';
                            rowClass = 'bg-red-900/20';
                        }

                        html += '<tr class="border-b border-slate-700 ' + rowClass + '">';
                        html += '<td class="p-2">' + statusBadge + '</td>';
                        html += '<td class="p-2 text-slate-300">' + (item.code || '-') + '</td>';
                        html += '<td class="p-2 text-white font-bold">' + item.name + '</td>';
                        html += '<td class="p-2 text-slate-400">' + (item.spec || '-') + '</td>';
                        html += '<td class="p-2 text-center text-yellow-400">' + (item.palletCapacity || '-') + '</td>';
                        html += '<td class="p-2 text-center text-cyan-400">' + (item.shelfLife || '-') + '</td>';
                        html += '<td class="p-2"><span class="badge badge-blue text-xs">' + item.category + '</span></td>';
                        html += '<td class="p-2 text-slate-500 text-xs">' + (item.note || '-') + '</td>';
                        html += '</tr>';
                    });

                    tbody.innerHTML = html;

                    document.getElementById('pm-import-step2').classList.remove('hidden');
                    document.getElementById('pm-import-btn').disabled = false;

                } catch(e) {
                    console.error('è§£æ Excel å¤±æ•—:', e);
                    alert('è§£ææª”æ¡ˆå¤±æ•—ï¼š' + e.message);
                }
            };

            reader.readAsArrayBuffer(file);
        };

        window.executeProductMasterImport = async function() {
            if (!window.pmImportData || window.pmImportData.length === 0) {
                alert('æ²’æœ‰è³‡æ–™å¯åŒ¯å…¥');
                return;
            }

            var updateExisting = document.getElementById('pm-import-update-existing').checked;
            var skipErrors = document.getElementById('pm-import-skip-errors').checked;

            var successCount = 0;
            var skipCount = 0;
            var errorItems = [];

            try {
                for (var i = 0; i < window.pmImportData.length; i++) {
                    var item = window.pmImportData[i];

                    if (item.status === 'error') {
                        if (skipErrors) {
                            skipCount++;
                            continue;
                        } else {
                            errorItems.push(item.name + ': ' + item.error);
                            continue;
                        }
                    }

                    if (item.status === 'update' && !updateExisting) {
                        skipCount++;
                        continue;
                    }

                    var data = {
                        code: item.code || '',
                        name: item.name,
                        spec: item.spec || '',
                        palletCapacity: item.palletCapacity,
                        partialThreshold: 50,
                        shelfLife: item.shelfLife || 24,
                        category: item.category || 'æˆå“',
                        note: item.note || '',
                        updatedAt: new Date().toISOString()
                    };

                    try {
                        if (item.status === 'update' && item.existingId) {
                            if (window.db && window.updateDoc) {
                                await window.updateDoc(window.doc(window.db, 'productMaster', item.existingId), data);
                            }
                            var idx = window.productMasterData.findIndex(function(p) { return p.id === item.existingId; });
                            if (idx >= 0) {
                                window.productMasterData[idx] = { id: item.existingId, ...data };
                            }
                        } else {
                            if (window.db && window.addDoc) {
                                var docRef = await window.addDoc(window.collection(window.db, 'productMaster'), data);
                                window.productMasterData.push({ id: docRef.id, ...data });
                            } else {
                                window.productMasterData.push(data);
                            }
                        }
                        successCount++;
                    } catch(e) {
                        console.error('åŒ¯å…¥é …ç›®å¤±æ•—:', item.name, e);
                        errorItems.push(item.name + ': ' + e.message);
                    }
                }

                localStorage.setItem('wms_product_master', JSON.stringify(window.productMasterData));

                var firebaseStatus = (window.db && window.addDoc) ? 'å·²åŒæ­¥è‡³ Firebase â˜ï¸' : 'åƒ…å„²å­˜æœ¬æ©Ÿ';
                var resultHtml = '<div class="space-y-3">';
                resultHtml += '<div class="flex items-center gap-3 text-emerald-400"><i class="fa-solid fa-check-circle text-2xl"></i><span class="text-xl font-bold">åŒ¯å…¥å®Œæˆ</span></div>';
                resultHtml += '<div class="text-sm text-cyan-400 mt-1"><i class="fa-solid fa-cloud mr-1"></i>' + firebaseStatus + '</div>';
                resultHtml += '<div class="grid grid-cols-3 gap-4 mt-4">';
                resultHtml += '<div class="bg-emerald-900/30 p-3 rounded-lg text-center"><div class="text-2xl font-bold text-emerald-400">' + successCount + '</div><div class="text-sm text-slate-400">æˆåŠŸåŒ¯å…¥</div></div>';
                resultHtml += '<div class="bg-yellow-900/30 p-3 rounded-lg text-center"><div class="text-2xl font-bold text-yellow-400">' + skipCount + '</div><div class="text-sm text-slate-400">ç•¥é</div></div>';
                resultHtml += '<div class="bg-red-900/30 p-3 rounded-lg text-center"><div class="text-2xl font-bold text-red-400">' + errorItems.length + '</div><div class="text-sm text-slate-400">å¤±æ•—</div></div>';
                resultHtml += '</div>';

                if (errorItems.length > 0) {
                    resultHtml += '<div class="mt-3 p-3 bg-red-900/30 rounded-lg"><div class="text-red-400 font-bold mb-2">å¤±æ•—é …ç›®ï¼š</div><ul class="text-sm text-red-300 list-disc list-inside">';
                    errorItems.forEach(function(err) {
                        resultHtml += '<li>' + err + '</li>';
                    });
                    resultHtml += '</ul></div>';
                }

                resultHtml += '</div>';

                document.getElementById('pm-import-result').innerHTML = resultHtml;
                document.getElementById('pm-import-step2').classList.add('hidden');
                document.getElementById('pm-import-step3').classList.remove('hidden');
                document.getElementById('pm-import-btn').disabled = true;

                loadProductMasterList();

            } catch(e) {
                console.error('åŒ¯å…¥å¤±æ•—:', e);
                alert('åŒ¯å…¥å¤±æ•—ï¼š' + e.message);
            }
        };

        setTimeout(function() { loadExternalStock(); }, 2000);

        setTimeout(function() { loadProductMasterFromFirebase(); }, 1500);

        setTimeout(function() { loadRentalSettingsFromFirebase(); }, 1800);

        setTimeout(function() { loadConsignmentsFromFirebase(); }, 2200);

        setInboundMode('Raw');
        switchTab('visual-map', null);
    </script>

        <script>
        // ========== è¨‚å–®ç®¡ç†ç³»çµ± (å‡ç´šç‰ˆ) ==========

const LOGISTICS_KEYWORDS = {
    'å…¨æ—¥ç‰©æµ': ['å…¨æ—¥ç‰©æµ', 'å…¨æ—¥'],
    'åˆé †è²¨é‹': ['åˆé †è²¨é‹', 'åˆé †'],
    'å¤§æ¦®è²¨é‹': ['å¤§æ¦®'],
    'è£•éµ¬ç‰©æµ': ['è£•éµ¬ç‰©æµ', 'è£•éµ¬'],
    'é»‘è²“å®…æ€¥ä¾¿': ['é»‘è²“'],
    'æ–°ç«¹ç‰©æµ': ['æ–°ç«¹ç‰©æµ', 'æ–°ç«¹'],
    'å´‡æ–‡è‡ªé€': ['å´‡æ–‡å¸æ©Ÿ', 'å´‡æ–‡'],
    'ç§‘æŠ€ç‰©æµ': ['ç§‘æŠ€'],
    'é˜¿èª ': ['é˜¿èª '],
    'æ–‡ç”Ÿ': ['æ–‡ç”Ÿ'],
    'é‡‘æ±çŸ³': ['é‡‘æ±çŸ³'],
    'å¥§æ—': ['å¥§æ—'],
    'è‡ªå–': ['è‡ªå–']
};

function parseLogistics(remark) {
    if (!remark) return 'æœªæŒ‡å®š';
    remark = String(remark);

    for (const [logistics, keywords] of Object.entries(LOGISTICS_KEYWORDS)) {
        for (const keyword of keywords) {
            if (remark.includes(keyword)) {
                return logistics;
            }
        }
    }
    return 'æœªæŒ‡å®š';
}

window.isFeeItem = function(productName) {
    if (!productName) return true;
    var feeKeywords = ['é‹è²»', 'è²»ç”¨', 'ä»£æ”¶', 'ä»£å¢Š', 'æ‰‹çºŒè²»', 'æœå‹™è²»', 'ä»£ä»˜', 'å…¶ä»–è²»ç”¨'];
    return feeKeywords.some(function(kw) { return productName.includes(kw); });
};

window.isPackagingItem = function(productName) {
    if (!productName) return false;
    var packagingKeywords = ['ä¿åŠ›é¾', 'ä¿éº—é¾', 'åŒ…æ', 'ç´™ç®±', 'å†°è¢‹', 'å†°å¡Š', 'ä¿éº—é¾ç®±', 'ä¿åŠ›é¾ç®±'];
    return packagingKeywords.some(function(kw) { return productName.includes(kw); });
};

window.isChilledItem = function(productName) {
    if (!productName) return false;
    var chilledKeywords = ['ç¾æµç™½ä»', 'å†·è—'];
    return chilledKeywords.some(function(kw) { return productName.includes(kw); });
};

window.isExcludedFromPickingList = function(productName) {
    return window.isFeeItem(productName) || window.isPackagingItem(productName) || window.isChilledItem(productName);
};

window.isExcludedFromSortingLabel = function(productName) {
    return window.isFeeItem(productName) || window.isChilledItem(productName);
};

window.isExcludedFromQtyCount = function(productName) {
    return window.isFeeItem(productName) || window.isPackagingItem(productName) || window.isChilledItem(productName);
};

window.isNonProductItem = window.isExcludedFromSortingLabel;

window.parseBoxPerPackage = function(productName) {
    if (!productName) return 0;

    var patterns = [
        /\*(\d+)ç›’/,      // *8ç›’
        /\*(\d+)å…¥/,      // *12å…¥
        /\*(\d+)åŒ…/,      // *6åŒ…
        /\*(\d+)è¢‹/,      // *10è¢‹
        /x(\d+)ç›’/i,      // x8ç›’
        /x(\d+)å…¥/i,      // x12å…¥
        /(\d+)ç›’\/ä»¶/,    // 8ç›’/ä»¶
        /(\d+)å…¥\/ä»¶/     // 12å…¥/ä»¶
    ];

    for (var i = 0; i < patterns.length; i++) {
        var match = productName.match(patterns[i]);
        if (match && match[1]) {
            return parseInt(match[1]);
        }
    }

    return 0;  // ç„¡æ³•è§£ææ™‚è¿”å›0ï¼Œä½¿ç”¨åŸå§‹é‚è¼¯
};

function parseBoxPerPackage(productName) {
    return window.parseBoxPerPackage(productName);
}

window._orderData = {
    orders: [],  // æ‰€æœ‰è¨‚å–®
    lastImportTime: null
};

async function loadOrdersFromFirebase() {
    try {
        const snap = await window.getDocs(window.collection(window.db, 'salesOrders'));
        window._orderData.orders = [];
        snap.forEach(doc => {
            window._orderData.orders.push({ id: doc.id, ...doc.data() });
        });
        console.log('è¼‰å…¥è¨‚å–®:', window._orderData.orders.length, 'ç­†');
        renderOrderList();
    } catch (err) {
        console.error('è¼‰å…¥è¨‚å–®å¤±æ•—:', err);
    }
}

function renderOrderList() {
    const pendingOrders = window._orderData.orders.filter(o => o.status === 'pending');
    const statEl = document.getElementById('wave-stat-orders');
    if (statEl) {
        statEl.innerText = pendingOrders.length;
    }
    console.log('è¨‚å–®åˆ—è¡¨æ›´æ–°:', pendingOrders.length, 'ç­†å¾…å‡ºè²¨');
}

// ========== è¨‚å–®ç•°å‹•åµæ¸¬åŠŸèƒ½ ==========

function detectOrderChanges(existingOrder, newOrder) {
    var changes = [];
    var existingItems = existingOrder.items || [];
    var newItems = newOrder.items || [];

    var existingMap = {};
    existingItems.forEach(function(item) {
        var key = item.productName + '|||' + (item.spec || '');
        existingMap[key] = item;
    });

    var newMap = {};
    newItems.forEach(function(item) {
        var key = item.productName + '|||' + (item.spec || '');
        newMap[key] = item;
    });

    Object.keys(newMap).forEach(function(key) {
        var newItem = newMap[key];
        var existingItem = existingMap[key];

        if (!existingItem) {
            changes.push({
                type: 'add',
                icon: 'â•',
                productName: newItem.productName,
                spec: newItem.spec || '',
                oldQty: 0,
                newQty: newItem.packageQty || newItem.quantity || 0,
                diff: '+' + (newItem.packageQty || newItem.quantity || 0)
            });
        } else {
            var oldQty = existingItem.packageQty || existingItem.quantity || 0;
            var newQty = newItem.packageQty || newItem.quantity || 0;

            if (oldQty !== newQty) {
                var diff = newQty - oldQty;
                changes.push({
                    type: diff > 0 ? 'increase' : 'decrease',
                    icon: diff > 0 ? 'â¬†ï¸' : 'â¬‡ï¸',
                    productName: newItem.productName,
                    spec: newItem.spec || '',
                    oldQty: oldQty,
                    newQty: newQty,
                    diff: (diff > 0 ? '+' : '') + diff
                });
            }
        }
    });

    Object.keys(existingMap).forEach(function(key) {
        if (!newMap[key]) {
            var existingItem = existingMap[key];
            changes.push({
                type: 'remove',
                icon: 'â–',
                productName: existingItem.productName,
                spec: existingItem.spec || '',
                oldQty: existingItem.packageQty || existingItem.quantity || 0,
                newQty: 0,
                diff: '-' + (existingItem.packageQty || existingItem.quantity || 0)
            });
        }
    });

    return changes;
}

function showOrderChangesAlert(orderChanges) {
    if (!orderChanges || orderChanges.length === 0) return;

    var modal = document.createElement('div');
    modal.id = 'modal-order-changes';
    modal.className = 'fixed inset-0 z-[100] bg-black/90 flex items-center justify-center';

    var inWaveChanges = orderChanges.filter(function(o) { return o.waveNo; });
    var pendingChanges = orderChanges.filter(function(o) { return !o.waveNo; });

    var changesHtml = '';

    if (inWaveChanges.length > 0) {
        changesHtml += '<div class="mb-4">';
        changesHtml += '<div class="text-red-400 font-bold mb-2"><i class="fa-solid fa-triangle-exclamation mr-2"></i>ä»¥ä¸‹è¨‚å–®å·²åœ¨æ³¢æ¬¡ä¸­ï¼Œè«‹æ›´æ–°æ€è²¨å–®ï¼</div>';
        changesHtml += '<div class="space-y-2 max-h-[200px] overflow-auto">';

        inWaveChanges.forEach(function(order) {
            var changesText = order.changes.map(function(c) {
                return c.icon + ' ' + c.productName + ': ' + c.oldQty + 'â†’' + c.newQty + ' (' + c.diff + ')';
            }).join('<br>');

            changesHtml += '<div class="bg-red-900/30 border border-red-600 rounded p-3">';
            changesHtml += '<div class="flex justify-between"><span class="text-white font-bold">' + order.customer + '</span>';
            changesHtml += '<span class="text-red-400 text-sm">æ³¢æ¬¡: ' + order.waveNo + '</span></div>';
            changesHtml += '<div class="text-xs text-slate-400">' + order.orderNo + '</div>';
            changesHtml += '<div class="text-sm text-yellow-300 mt-2">' + changesText + '</div></div>';
        });

        changesHtml += '</div></div>';
    }

    if (pendingChanges.length > 0) {
        changesHtml += '<div class="mb-4">';
        changesHtml += '<div class="text-yellow-400 font-bold mb-2"><i class="fa-solid fa-info-circle mr-2"></i>ä»¥ä¸‹å¾…è™•ç†è¨‚å–®æœ‰ç•°å‹•</div>';
        changesHtml += '<div class="space-y-2 max-h-[150px] overflow-auto">';

        pendingChanges.forEach(function(order) {
            var changesText = order.changes.map(function(c) { return c.icon + ' ' + c.productName + ': ' + c.diff; }).join(', ');
            changesHtml += '<div class="bg-yellow-900/30 border border-yellow-600 rounded p-2 text-sm">';
            changesHtml += '<span class="text-white">' + order.customer + '</span>';
            changesHtml += '<span class="text-yellow-300 ml-2">' + changesText + '</span></div>';
        });

        changesHtml += '</div></div>';
    }

    var buttonHtml = '';
    if (inWaveChanges.length > 0) {
        buttonHtml = '<button onclick="updateChangedWaves()" class="flex-1 py-2 bg-red-600 hover:bg-red-500 text-white rounded-lg font-bold animate-pulse"><i class="fa-solid fa-print mr-2"></i>æ›´æ–°ä¸¦åˆ—å°æ–°æ€è²¨å–®</button>';
    }

    modal.innerHTML = '<div class="bg-slate-900 border border-slate-600 rounded-xl w-[600px] max-h-[80vh] shadow-2xl">' +
        '<div class="bg-gradient-to-r from-red-900 to-orange-900 p-4 rounded-t-xl border-b border-slate-700">' +
        '<h3 class="text-white font-bold text-lg"><i class="fa-solid fa-triangle-exclamation mr-2 text-red-400 animate-pulse"></i>âš ï¸ è¨‚å–®ç•°å‹•è­¦ç¤º</h3>' +
        '<p class="text-orange-200 text-sm mt-1">åµæ¸¬åˆ° ' + orderChanges.length + ' ç­†è¨‚å–®æœ‰å“é …æˆ–æ•¸é‡ç•°å‹•</p></div>' +
        '<div class="p-4 overflow-auto max-h-[50vh]">' + changesHtml + '</div>' +
        '<div class="p-4 border-t border-slate-700 flex gap-3">' + buttonHtml +
        '<button onclick="closeOrderChangesModal()" class="flex-1 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg">çŸ¥é“äº†</button>' +
        '</div></div>';

    document.body.appendChild(modal);
}

window.closeOrderChangesModal = function() {
    var modal = document.getElementById('modal-order-changes');
    if (modal) modal.remove();
};

window.updateChangedWaves = async function() {
    var changedWaves = (window._waveData.waves || []).filter(function(w) { return w.hasOrderChanges; });

    if (changedWaves.length === 0) {
        alert('æ²’æœ‰éœ€è¦æ›´æ–°çš„æ³¢æ¬¡');
        closeOrderChangesModal();
        return;
    }

    if (!confirm('âš ï¸ å°‡æ›´æ–° ' + changedWaves.length + ' å€‹æ³¢æ¬¡çš„æ€è²¨æ¸…å–®\n\næ›´æ–°å¾Œå°‡ã€è‡ªå‹•åˆ—å°ã€‘æ–°çš„æ€è²¨å–®\nè«‹æº–å‚™å¥½å°è¡¨æ©Ÿï¼\n\nç¢ºå®šç¹¼çºŒå—ï¼Ÿ')) {
        return;
    }

    var progressDiv = document.createElement('div');
    progressDiv.id = 'update-wave-progress';
    progressDiv.className = 'fixed inset-0 bg-black/90 flex items-center justify-center z-[200]';
    progressDiv.innerHTML = '<div class="bg-slate-800 rounded-xl p-8 text-center">' +
        '<i class="fa-solid fa-sync fa-spin text-5xl text-orange-400 mb-4"></i>' +
        '<div class="text-white text-xl font-bold" id="update-progress-text">æ›´æ–°æ€è²¨å–®ä¸­...</div>' +
        '<div class="text-slate-400 text-sm mt-2" id="update-progress-detail"></div></div>';
    document.body.appendChild(progressDiv);

    var updatedWaveNos = [];

    for (var i = 0; i < changedWaves.length; i++) {
        var wave = changedWaves[i];

        document.getElementById('update-progress-text').innerText = 'æ›´æ–° ' + wave.waveNo + '...';
        document.getElementById('update-progress-detail').innerText = (i + 1) + ' / ' + changedWaves.length;

        var summary = {};
        var totalQty = 0;
        var updatedOrders = [];

        for (var j = 0; j < (wave.orders || []).length; j++) {
            var orderRef = wave.orders[j];
            var latestOrder = window._orderData.orders.find(function(o) { return o.orderNo === orderRef.orderNo; });

            if (latestOrder) {
                updatedOrders.push({
                    orderNo: latestOrder.orderNo,
                    customer: latestOrder.customer,
                    address: latestOrder.address,
                    logistics: latestOrder.logistics,
                    items: latestOrder.items
                });

                (latestOrder.items || []).forEach(function(item) {
                    var key = item.productName + '|||' + (item.spec || '');
                    if (!summary[key]) {
                        var oldItem = (wave.summary || []).find(function(s) {
                            return s.productName === item.productName && (s.spec || '') === (item.spec || '');
                        });
                        summary[key] = {
                            productName: item.productName,
                            spec: item.spec || '',
                            unit: item.packageUnit || 'ä»¶',
                            totalQty: 0,
                            prevQty: oldItem ? oldItem.totalQty : 0,  // è¨˜éŒ„èˆŠç‰ˆæ•¸é‡
                            orders: []
                        };
                    }
                    var pkgQty = item.packageQty || 1;
                    summary[key].totalQty += pkgQty;
                    summary[key].orders.push({ orderNo: latestOrder.orderNo, customer: latestOrder.customer, quantity: pkgQty });
                    totalQty += pkgQty;
                });
            }
        }

        wave.orders = updatedOrders;
        wave.summary = Object.values(summary);
        wave.itemCount = Object.keys(summary).length;
        wave.totalQty = totalQty;
        wave.hasOrderChanges = false;
        wave.changedOrders = [];
        wave.updatedAt = new Date().toISOString();
        wave.reprintRequired = true;  // æ¨™è¨˜éœ€è¦é‡å°

        if (wave.id) {
            try {
                await window.updateDoc(window.doc(window.db, 'waves', wave.id), {
                    orders: wave.orders, summary: wave.summary, itemCount: wave.itemCount,
                    totalQty: wave.totalQty, hasOrderChanges: false, changedOrders: [],
                    updatedAt: wave.updatedAt, reprintRequired: true
                });
            } catch (err) { console.error('æ›´æ–°æ³¢æ¬¡å¤±æ•—:', err); }
        }

        updatedWaveNos.push(wave.waveNo);

        await new Promise(function(resolve) { setTimeout(resolve, 100); });
    }

    document.getElementById('update-progress-text').innerText = 'æº–å‚™åˆ—å°æ€è²¨å–®...';
    document.getElementById('update-progress-detail').innerText = '';

    await new Promise(function(resolve) { setTimeout(resolve, 500); });

    printUpdatedPickingLists(changedWaves);

    document.getElementById('update-wave-progress').remove();

    saveWaves();
    refreshWaveList();
    closeOrderChangesModal();

    showUpdateCompleteAlert(updatedWaveNos);
};

function printUpdatedPickingLists(waves, changeDetails) {
    var printWindow = window.open('', '_blank', 'width=900,height=700');

    var html = '<!DOCTYPE html><html><head><title>ğŸ“‹ æ›´æ–°ç‰ˆæ€è²¨å–®</title>' +
        '<style>' +
        'body { font-family: "Microsoft JhengHei", sans-serif; font-size: 12px; }' +
        '.wave-section { page-break-after: always; margin-bottom: 20px; }' +
        '.wave-section:last-child { page-break-after: auto; }' +
        '.update-banner { background: #dc2626; color: white; padding: 8px 15px; font-size: 14px; font-weight: bold; margin-bottom: 10px; }' +
        '.header { text-align: center; margin-bottom: 15px; border-bottom: 2px solid #333; padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }' +
        '.header h2 { margin: 0; font-size: 20px; }' +
        '.version { background: #374151; color: white; padding: 4px 12px; border-radius: 4px; font-weight: bold; }' +
        '.info-row { display: flex; gap: 15px; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px dashed #ccc; }' +
        '.info-item { flex: 1; }' +
        '.info-label { font-size: 11px; color: #666; }' +
        '.info-value { font-size: 15px; font-weight: bold; }' +
        'table { width: 100%; border-collapse: collapse; }' +
        'th, td { border: 1px solid #333; padding: 6px; text-align: left; }' +
        'th { background: #374151; color: white; font-size: 11px; }' +
        '.loc { font-weight: bold; font-size: 13px; color: #1e40af; }' +
        '.qty { text-align: center; font-weight: bold; font-size: 16px; color: #c00; }' +
        '.check { width: 30px; text-align: center; }' +
        '.change-add { color: #16a34a; font-weight: bold; }' +
        '.change-sub { color: #dc2626; font-weight: bold; }' +
        '.floor-1f { background: #dbeafe; }' +
        '.floor-2f { background: #fef3c7; }' +
        '.floor-3f { background: #fee2e2; }' +
        '.timestamp { text-align: right; font-size: 10px; color: #666; margin-top: 10px; }' +
        '</style></head><body>';

    waves.forEach(function(wave) {
        var now = new Date().toLocaleString('zh-TW');
        var version = (wave.printVersion || 0) + 1;
        wave.printVersion = version;

        html += '<div class="wave-section">';

        html += '<div class="update-banner">âš ï¸ ã€æ›´æ–°ç‰ˆã€‘è«‹ä½œå»¢èˆŠç‰ˆæ€è²¨å–®</div>';

        html += '<div class="header">';
        html += '<div><h2>æ€è²¨å–®</h2><h3 style="margin:5px 0 0 0">' + wave.waveNo + '</h3></div>';
        html += '<span class="version">ç‰ˆæ¬¡ V' + version + '</span>';
        html += '</div>';

        html += '<div class="info-row">' +
            '<div class="info-item"><div class="info-label">ç‰©æµå•†</div><div class="info-value">' + wave.logistics + '</div></div>' +
            '<div class="info-item"><div class="info-label">è¨‚å–®æ•¸</div><div class="info-value">' + (wave.orders || []).length + ' ç­†</div></div>' +
            '<div class="info-item"><div class="info-label">å“é …æ•¸</div><div class="info-value">' + wave.itemCount + ' é …</div></div>' +
            '<div class="info-item"><div class="info-label">ç¸½ä»¶æ•¸</div><div class="info-value" style="color:#dc2626;">' + wave.totalQty + ' ä»¶</div></div>' +
            '</div>';

        var summaryWithLoc = (wave.summary || []).filter(function(item) {
            return !window.isExcludedFromPickingList(item.productName);
        }).map(function(item) {
            var invInfo = findProductInventoryInfo(item.productName, item.spec);
            return {
                productName: item.productName,
                spec: item.spec || '-',
                unit: item.unit || 'ä»¶',
                totalQty: item.totalQty,
                prevQty: item.prevQty || item.totalQty,
                location: invInfo.location,
                batchNo: invInfo.batchNo,
                expiryDate: invInfo.expiryDate,
                floor: invInfo.floor
            };
        });

        summaryWithLoc.sort(function(a, b) {
            if (b.totalQty !== a.totalQty) return b.totalQty - a.totalQty;
            return a.floor - b.floor;
        });

        html += '<table>';
        html += '<tr><th class="check">âœ“</th><th style="width:70px">å„²ä½</th><th style="width:100px">å“å</th><th>è¦æ ¼</th><th style="width:80px">æ‰¹è™Ÿ</th><th style="width:80px">æ•ˆæœŸ</th><th style="width:50px" class="qty">æ•¸é‡</th><th style="width:35px">å–®ä½</th><th style="width:50px">ç•°å‹•</th></tr>';

        summaryWithLoc.forEach(function(item) {
            var floorClass = item.floor === 1 ? 'floor-1f' : (item.floor === 2 ? 'floor-2f' : (item.floor === 3 ? 'floor-3f' : ''));
            var diff = item.totalQty - item.prevQty;
            var changeHtml = '-';
            if (diff > 0) {
                changeHtml = '<span class="change-add">+' + diff + '</span>';
            } else if (diff < 0) {
                changeHtml = '<span class="change-sub">' + diff + '</span>';
            }

            html += '<tr class="' + floorClass + '">';
            html += '<td class="check">â˜</td>';
            html += '<td class="loc">' + item.location + '</td>';
            html += '<td>' + item.productName + '</td>';
            html += '<td>' + item.spec + '</td>';
            html += '<td style="font-size:11px">' + item.batchNo + '</td>';
            html += '<td style="font-size:11px">' + item.expiryDate + '</td>';
            html += '<td class="qty">' + item.totalQty + '</td>';
            html += '<td>' + item.unit + '</td>';
            html += '<td style="text-align:center">' + changeHtml + '</td>';
            html += '</tr>';
        });

        html += '</table>';
        html += '<div class="timestamp">ç‰ˆæ¬¡ V' + version + ' | åˆ—å°æ—¥æœŸï¼š' + now + '</div>';
        html += '</div>';
    });

    html += '<script>window.onload = function() { window.print(); }<\/script></body></html>';

    printWindow.document.write(html);
    printWindow.document.close();
}

function findProductLocation(productName, spec) {
    var pallets = window._inventoryData && window._inventoryData.pallets ? window._inventoryData.pallets : [];
    for (var i = 0; i < pallets.length; i++) {
        var p = pallets[i];
        if (p.productName === productName && (p.spec || '') === (spec || '')) {
            return p.locationId || '-';
        }
    }
    return '-';
}

function findProductInventoryInfo(productName, spec) {
    var pallets = window._inventoryData && window._inventoryData.pallets ? window._inventoryData.pallets : [];
    var result = { location: '-', batchNo: '-', expiryDate: '-', floor: 9 };

    for (var i = 0; i < pallets.length; i++) {
        var p = pallets[i];
        if (p.productName === productName && (p.spec || '') === (spec || '')) {
            result.location = p.locationId || '-';
            result.batchNo = p.batchNo || '-';

            if (p.expiryDate) {
                var d = new Date(p.expiryDate);
                if (!isNaN(d.getTime())) {
                    result.expiryDate = d.getFullYear() + '/' +
                        String(d.getMonth() + 1).padStart(2, '0') + '/' +
                        String(d.getDate()).padStart(2, '0');
                }
            }

            result.floor = getFloorFromLocation(result.location);
            break;
        }
    }

    return result;
}

function getFloorFromLocation(loc) {
    if (!loc || loc === '-') return 9; // ç„¡å„²ä½æ’æœ€å¾Œ
    if (loc.includes('1F') || loc.startsWith('A-') || loc.startsWith('B-')) return 1;
    if (loc.includes('2F') || loc.startsWith('C-') || loc.startsWith('D-')) return 2;
    if (loc.includes('3F') || loc.startsWith('E-') || loc.startsWith('F-')) return 3;
    var parts = loc.split('-');
    if (parts.length >= 3) {
        var level = parseInt(parts[2]);
        if (level >= 1 && level <= 3) return level;
    }
    return 1;
}

function showUpdateCompleteAlert(waveNos) {
    var alertDiv = document.createElement('div');
    alertDiv.id = 'update-complete-alert';
    alertDiv.className = 'fixed inset-0 bg-black/90 flex items-center justify-center z-[200]';

    var waveList = waveNos.map(function(no) { return 'â€¢ ' + no; }).join('<br>');

    alertDiv.innerHTML = '<div class="bg-gradient-to-b from-red-900 to-red-800 border-4 border-red-500 rounded-2xl p-8 max-w-lg text-center shadow-2xl animate-pulse">' +
        '<div class="text-6xl mb-4">âš ï¸</div>' +
        '<h2 class="text-white text-2xl font-bold mb-4">æ€è²¨å–®å·²æ›´æ–°ï¼</h2>' +
        '<div class="bg-red-950/50 rounded-lg p-4 mb-4">' +
        '<p class="text-red-200 mb-2">ä»¥ä¸‹æ³¢æ¬¡çš„æ€è²¨å–®å·²é‡æ–°åˆ—å°ï¼š</p>' +
        '<div class="text-white font-mono text-lg">' + waveList + '</div>' +
        '</div>' +
        '<div class="bg-yellow-500/20 border border-yellow-500 rounded-lg p-3 mb-6">' +
        '<p class="text-yellow-300 font-bold"><i class="fa-solid fa-triangle-exclamation mr-2"></i>è«‹ç«‹å³ä½œå»¢èˆŠç‰ˆæ€è²¨å–®ï¼</p>' +
        '</div>' +
        '<button onclick="document.getElementById(\'update-complete-alert\').remove()" ' +
        'class="bg-white text-red-700 px-8 py-3 rounded-lg font-bold text-lg hover:bg-red-100 transition">' +
        'æˆ‘çŸ¥é“äº†ï¼Œå·²ä½œå»¢èˆŠç‰ˆ' +
        '</button>' +
        '</div>';

    document.body.appendChild(alertDiv);

    try {
        var audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdH2Onp2ckYuIfHZxaGRdX2Rqc32GjpKSj4qFf3p1cm9tamhnaGlrb3R5f4WKjY6OjImFgX57eHZ1dXV2d3l7foCDhYaHh4eFhIKAf358e3p5eXl5ent8fX5/gIGBgYGAgH9+fX18fHx8fHx9fX5+fn9/gICAgICAf39/fn59fX19fX19fn5+fn9/f39/f39/f39+fn5+fn5+fn5+fn5+f39/f39/f39/f39+fn5+fn5+fn5+fn5+fn5/f39/f39/f38=');
        audio.play();
    } catch (e) {}
}

window.importERPExcel = async function(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = async function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

            const dataRows = rows.slice(5);

            const COL = {
                DATE: 0,        // éŠ·è²¨æ—¥æœŸ
                ORDER_NO: 1,    // éŠ·è²¨å–®è™Ÿ
                CUST_CODE: 2,   // å®¢æˆ¶ä»£è™Ÿ
                CUST_NAME: 3,   // å®¢æˆ¶å…¨å
                PRODUCT: 4,     // å“å
                SPEC: 5,        // è¦æ ¼
                PKG_QTY: 6,     // åŒ…è£æ•¸é‡
                PKG_UNIT: 7,    // åŒ…è£å–®ä½
                QTY: 8,         // éŠ·è²¨æ•¸é‡
                UNIT: 9,        // å–®ä½
                PRICE: 10,      // å–®åƒ¹
                REMARK: 11,     // å‚™è¨» (ç‰©æµå•†)
                BATCH: 12,      // æ‰¹è™Ÿ
                ADDR1: 13,      // é€è²¨åœ°å€ä¸€
                ADDR2: 14       // é€è²¨åœ°å€äºŒ
            };

            const orderMap = new Map();
            let lastOrderNo = null;
            let lastLogistics = null;

            for (const row of dataRows) {
                if (!row[COL.PRODUCT]) continue;
                if (String(row[COL.DATE]).includes('å°è¨ˆ') || String(row[COL.DATE]).includes('åˆè¨ˆ')) continue;

                let orderNo = row[COL.ORDER_NO] ? String(row[COL.ORDER_NO]).trim() : lastOrderNo;
                let logistics = parseLogistics(row[COL.REMARK]);

                if (logistics === 'æœªæŒ‡å®š' && lastLogistics) {
                    logistics = lastLogistics;
                }

                if (row[COL.ORDER_NO]) {
                    lastOrderNo = orderNo;
                    lastLogistics = logistics;
                }

                const orderKey = orderNo + '|||' + logistics;

                if (!orderMap.has(orderKey)) {
                    orderMap.set(orderKey, {
                        orderNo: orderNo,
                        orderDate: row[COL.DATE] ? String(row[COL.DATE]).trim() : '',
                        customerCode: row[COL.CUST_CODE] ? String(row[COL.CUST_CODE]).trim() : '',
                        customer: row[COL.CUST_NAME] ? String(row[COL.CUST_NAME]).trim() : '',
                        logistics: logistics,
                        address: row[COL.ADDR1] ? String(row[COL.ADDR1]).trim() : '',
                        address2: row[COL.ADDR2] ? String(row[COL.ADDR2]).trim() : '',
                        remark: row[COL.REMARK] ? String(row[COL.REMARK]).trim() : '',
                        status: 'pending',
                        items: [],
                        createdAt: new Date().toISOString(),
                        importedAt: new Date().toISOString()
                    });
                }

                let currentOrder = orderMap.get(orderKey);

                if (row[COL.PRODUCT]) {
                    var productName = String(row[COL.PRODUCT]).trim();

                    // === éæ¿¾ä¸éœ€è¦çš„é …ç›® ===

                    var headerKeywords = ['å“å', 'è¦æ ¼', 'åŒ…è£æ•¸é‡', 'åŒ…è£å–®ä½', 'éŠ·è²¨æ•¸é‡', 'å–®ä½', 'å–®åƒ¹', 'å‚™è¨»', 'æ‰¹è™Ÿ', 'é€è²¨åœ°å€'];
                    var isHeader = headerKeywords.some(function(kw) { return productName === kw || productName.includes(kw + ' '); });
                    if (isHeader) continue;

                    var feeKeywords = ['é‹è²»', 'è²»ç”¨', 'ä¿åŠ›é¾', 'ä¿éº—é¾', 'ä»£æ”¶', 'ä»£å¢Š', 'æ‰‹çºŒè²»', 'æœå‹™è²»', 'åŒ…æ', 'ç´™ç®±è²»', 'å†°è¢‹', 'å†°å¡Š'];
                    var isFee = feeKeywords.some(function(kw) { return productName.includes(kw); });
                    if (isFee) continue;

                    var qty = parseInt(row[COL.QTY]) || 0;
                    if (!productName || qty <= 0) continue;

                    // === æ­£å¸¸å“é …è™•ç† ===

                    var boxPerPkg = parseBoxPerPackage(productName);
                    var pkgQty = boxPerPkg > 0 ? Math.ceil(qty / boxPerPkg) : (parseInt(row[COL.PKG_QTY]) || qty);

                    currentOrder.items.push({
                        productName: productName,
                        spec: row[COL.SPEC] ? String(row[COL.SPEC]).trim() : '',
                        quantity: qty,                    // æœ€å°å–®ä½æ•¸é‡ï¼ˆç›’ï¼‰
                        unit: row[COL.UNIT] ? String(row[COL.UNIT]).trim() : '',
                        packageQty: pkgQty,               // ä»¶æ•¸
                        packageUnit: 'ä»¶',                // å›ºå®šç‚ºä»¶
                        boxPerPackage: boxPerPkg,         // æ¯ä»¶ç›’æ•¸
                        batchNo: row[COL.BATCH] ? String(row[COL.BATCH]).trim() : '',
                        price: parseFloat(row[COL.PRICE]) || 0
                    });
                }
            }

            const orders = Array.from(orderMap.values());

            console.log('è§£æè¨‚å–®:', orders.length, 'ç­†');

            let savedCount = 0;
            let skipCount = 0;
            let modifiedCount = 0;
            var orderChanges = [];

            for (const order of orders) {
                const existing = window._orderData.orders.find(o => o.orderNo === order.orderNo);
                if (existing) {
                    var changes = detectOrderChanges(existing, order);
                    if (changes.length > 0) {
                        orderChanges.push({
                            orderNo: order.orderNo,
                            customer: order.customer,
                            waveNo: existing.waveNo,
                            changes: changes
                        });

                        existing.items = order.items;
                        existing.modifiedAt = new Date().toISOString();
                        existing.hasChanges = true;

                        if (existing.waveNo) {
                            var wave = window._waveData.waves.find(function(w) { return w.waveNo === existing.waveNo; });
                            if (wave) {
                                wave.hasOrderChanges = true;
                                wave.changedOrders = wave.changedOrders || [];
                                if (wave.changedOrders.indexOf(order.orderNo) === -1) {
                                    wave.changedOrders.push(order.orderNo);
                                }
                            }
                        }

                        if (existing.id) {
                            try {
                                await window.updateDoc(window.doc(window.db, 'salesOrders', existing.id), {
                                    items: order.items,
                                    modifiedAt: existing.modifiedAt,
                                    hasChanges: true
                                });
                            } catch (err) { console.error('æ›´æ–°è¨‚å–®å¤±æ•—:', err); }
                        }
                        modifiedCount++;
                    } else {
                        skipCount++;
                    }
                    continue;
                }

                try {
                    await window.addDoc(window.collection(window.db, 'salesOrders'), order);
                    window._orderData.orders.push(order);
                    savedCount++;
                } catch (err) {
                    console.error('å„²å­˜è¨‚å–®å¤±æ•—:', order.orderNo, err);
                }
            }

            window._orderData.lastImportTime = new Date().toISOString();

            if (modifiedCount > 0) {
                showOrderChangesAlert(orderChanges);
            }

            renderOrderList();
            refreshWaveList();

            if (savedCount > 0) {
                var pendingOrders = window._orderData.orders.filter(function(o) {
                    return o.status === 'pending' && !o.waveNo;
                });

                var autoCreate = confirm(
                    'âœ… åŒ¯å…¥å®Œæˆï¼\n\n' +
                    'æ–°å¢ï¼š' + savedCount + ' ç­†\n' +
                    (modifiedCount > 0 ? 'âš ï¸ ç•°å‹•ï¼š' + modifiedCount + ' ç­†\n' : '') +
                    'ç•¥éï¼ˆç„¡è®Šæ›´ï¼‰ï¼š' + skipCount + ' ç­†\n' +
                    'å¾…å»ºæ³¢æ¬¡ï¼š' + pendingOrders.length + ' ç­†\n\n' +
                    'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n' +
                    'æ˜¯å¦è¦è‡ªå‹•ä¾ç‰©æµå•†å»ºç«‹æ³¢æ¬¡ï¼Ÿ\n' +
                    'ï¼ˆç³»çµ±å°‡ä¾ 13 ç¨®ç‰©æµå•†è‡ªå‹•åˆ†çµ„å»ºç«‹ï¼‰'
                );

                if (autoCreate) {
                    await autoCreateWavesByLogistics();
                }
            } else {
                var resultMsg = 'âœ… åŒ¯å…¥å®Œæˆï¼\n\n' +
                      'æ–°å¢ï¼š' + savedCount + ' ç­†\n';
                if (modifiedCount > 0) {
                    resultMsg += 'âš ï¸ ç•°å‹•ï¼š' + modifiedCount + ' ç­†\n';
                }
                resultMsg += 'ç•¥éï¼ˆç„¡è®Šæ›´ï¼‰ï¼š' + skipCount + ' ç­†\n' +
                      'ç¸½è¨‚å–®æ•¸ï¼š' + window._orderData.orders.length + ' ç­†';
                alert(resultMsg);
            }

        } catch (err) {
            console.error('åŒ¯å…¥å¤±æ•—:', err);
            alert('âŒ åŒ¯å…¥å¤±æ•—ï¼š' + err.message);
        }
    };

    reader.readAsArrayBuffer(file);
    event.target.value = '';
};

function renderWaveOrderList(orders) {
    const tbody = document.getElementById('wave-orders-body');
    if (!tbody) return;

    if (!orders || orders.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-slate-500 py-8">æ²’æœ‰å¾…å‡ºè²¨çš„è¨‚å–®</td></tr>';
        return;
    }

    let html = '';
    orders.forEach(order => {
        const items = order.items || [];
        items.forEach((item, idx) => {
            const rowClass = idx === 0 ? 'border-t border-slate-600' : '';
            html += `<tr class="hover:bg-slate-800/50 ${rowClass}">`;

            if (idx === 0) {
                html += `<td class="p-2" rowspan="${items.length}">
                    <input type="checkbox" class="wave-order-check" data-order-id="${order.id}" data-order-no="${order.orderNo}">
                </td>`;
                html += `<td class="p-2 text-cyan-400 font-mono text-xs" rowspan="${items.length}">${order.orderNo}</td>`;
                html += `<td class="p-2 text-white" rowspan="${items.length}">${order.customer}</td>`;
                html += `<td class="p-2" rowspan="${items.length}">
                    <span class="px-2 py-1 rounded text-xs ${getLogisticsColor(order.logistics)}">${order.logistics}</span>
                </td>`;
            }

            html += `<td class="p-2 text-slate-300">${item.productName} ${item.spec || ''}</td>`;
            html += `<td class="p-2 text-right text-yellow-400 font-bold">${item.quantity}</td>`;
            html += `<td class="p-2 text-slate-400 text-xs">${order.orderDate || ''}</td>`;
            html += '</tr>';
        });
    });

    tbody.innerHTML = html;

    document.querySelectorAll('.wave-order-check').forEach(cb => {
        cb.addEventListener('change', updateWaveSelectedCount);
    });
}

function getLogisticsColor(logistics) {
    const colors = {
        'å…¨æ—¥ç‰©æµ': 'bg-blue-600',
        'åˆé †è²¨é‹': 'bg-green-600',
        'å¤§æ¦®è²¨é‹': 'bg-orange-600',
        'è£•éµ¬ç‰©æµ': 'bg-purple-600',
        'é»‘è²“å®…æ€¥ä¾¿': 'bg-yellow-600 text-black',
        'æ–°ç«¹ç‰©æµ': 'bg-red-600',
        'å´‡æ–‡è‡ªé€': 'bg-cyan-600',
        'ç§‘æŠ€ç‰©æµ': 'bg-indigo-600',
        'é˜¿èª ': 'bg-pink-600',
        'æ–‡ç”Ÿ': 'bg-teal-600',
        'é‡‘æ±çŸ³': 'bg-amber-600',
        'å¥§æ—': 'bg-lime-600',
        'è‡ªå–': 'bg-slate-600',
        'æœªæŒ‡å®š': 'bg-slate-700'
    };
    return colors[logistics] || 'bg-slate-600';
}

window.autoCreateWavesByLogistics = async function() {
    var pendingOrders = window._orderData.orders.filter(function(o) {
        return o.status === 'pending' && !o.waveNo;
    });

    if (pendingOrders.length === 0) {
        alert('æ²’æœ‰å¾…è™•ç†çš„è¨‚å–®');
        return;
    }

    var logisticsGroups = {};
    pendingOrders.forEach(function(order) {
        var logistics = order.logistics || 'æœªæŒ‡å®šç‰©æµ';
        if (!logisticsGroups[logistics]) {
            logisticsGroups[logistics] = [];
        }
        logisticsGroups[logistics].push(order);
    });

    var logisticsCount = Object.keys(logisticsGroups).length;

    var previewText = 'å°‡å»ºç«‹ ' + logisticsCount + ' å€‹æ³¢æ¬¡ï¼š\n\n';
    Object.keys(logisticsGroups).forEach(function(logistics) {
        var orders = logisticsGroups[logistics];
        var totalQty = 0;
        orders.forEach(function(o) {
            (o.items || []).forEach(function(item) {
                var qty = item.quantity || 0;
                var boxPerPkg = parseBoxPerPackage(item.productName);
                var pkgQty = (boxPerPkg > 0 && qty > 0) ? Math.ceil(qty / boxPerPkg) : (item.packageQty || 1);
                totalQty += pkgQty;
            });
        });
        previewText += 'â€¢ ' + logistics + 'ï¼š' + orders.length + ' å–® / ' + totalQty + ' ä»¶\n';
    });

    if (!confirm(previewText + '\nç¢ºå®šå»ºç«‹å—ï¼Ÿ')) {
        return;
    }

    var progressDiv = document.createElement('div');
    progressDiv.id = 'auto-wave-progress';
    progressDiv.className = 'fixed inset-0 bg-black/80 flex items-center justify-center z-[200]';
    progressDiv.innerHTML = '<div class="bg-slate-800 rounded-xl p-8 text-center">' +
        '<i class="fa-solid fa-spinner fa-spin text-4xl text-blue-400 mb-4"></i>' +
        '<div class="text-white text-lg" id="progress-text">å»ºç«‹æ³¢æ¬¡ä¸­...</div>' +
        '<div class="text-slate-400 text-sm mt-2" id="progress-detail"></div></div>';
    document.body.appendChild(progressDiv);

    var createdWaves = [];
    var totalOrders = 0;
    var totalItems = 0;
    var idx = 0;
    var logisticsKeys = Object.keys(logisticsGroups);

    for (var i = 0; i < logisticsKeys.length; i++) {
        var logistics = logisticsKeys[i];
        var orders = logisticsGroups[logistics];

        document.getElementById('progress-text').innerText = 'å»ºç«‹ ' + logistics + ' æ³¢æ¬¡...';
        document.getElementById('progress-detail').innerText = (i + 1) + ' / ' + logisticsKeys.length;

        var summary = {};
        var waveTotalQty = 0;

        orders.forEach(function(order) {
            (order.items || []).forEach(function(item) {
                var key = item.productName + '|||' + (item.spec || '');

                var qty = item.quantity || 0;
                var boxPerPkg = parseBoxPerPackage(item.productName);
                var pkgQty = (boxPerPkg > 0 && qty > 0) ? Math.ceil(qty / boxPerPkg) : (item.packageQty || 1);

                if (!summary[key]) {
                    summary[key] = {
                        productName: item.productName,
                        spec: item.spec || '',
                        unit: 'ä»¶',                      // å›ºå®šä½¿ç”¨ä»¶
                        smallUnit: item.unit || '',      // æœ€å°å–®ä½
                        totalQty: 0,                     // ä»¶æ•¸
                        totalSmallQty: 0,                // æœ€å°å–®ä½æ•¸é‡
                        orders: []
                    };
                }
                summary[key].totalQty += pkgQty;
                summary[key].totalSmallQty += qty;
                summary[key].orders.push({
                    orderNo: order.orderNo,
                    customer: order.customer,
                    quantity: pkgQty
                });
                waveTotalQty += pkgQty;
            });
        });

        var summaryList = Object.values(summary);

        var waveNo = generateWaveNo();
        var wave = {
            waveNo: waveNo,
            logistics: logistics,
            status: 'pending',
            orders: orders.map(function(o) {
                return {
                    orderNo: o.orderNo,
                    orderId: o.id,
                    customer: o.customer,
                    address: o.address,
                    logistics: o.logistics,
                    items: o.items
                };
            }),
            summary: summaryList,
            orderCount: orders.length,
            itemCount: summaryList.length,
            totalQty: waveTotalQty,
            createdAt: new Date().toISOString(),
            autoCreated: true
        };

        try {
            var docRef = await window.addDoc(window.collection(window.db, 'waves'), wave);
            wave.id = docRef.id;
        } catch (err) {
            console.error('å»ºç«‹æ³¢æ¬¡å¤±æ•—:', logistics, err);
        }

        window._waveData.waves.push(wave);
        createdWaves.push({ waveNo: waveNo, logistics: logistics, orderCount: orders.length, totalQty: waveTotalQty });

        for (var j = 0; j < orders.length; j++) {
            var order = orders[j];
            order.status = 'inWave';
            order.waveNo = waveNo;

            if (order.id) {
                try {
                    await window.updateDoc(window.doc(window.db, 'salesOrders', order.id), {
                        status: 'inWave',
                        waveNo: waveNo
                    });
                } catch (err) {
                    console.error('æ›´æ–°è¨‚å–®å¤±æ•—:', order.orderNo, err);
                }
            }
        }

        totalOrders += orders.length;
        totalItems += waveTotalQty;

        await new Promise(function(resolve) { setTimeout(resolve, 100); });
    }

    document.getElementById('auto-wave-progress').remove();

    saveWaves();
    refreshWaveList();

    var resultText = 'âœ… è‡ªå‹•å»ºç«‹å®Œæˆï¼\n\n' +
        'å»ºç«‹æ³¢æ¬¡ï¼š' + createdWaves.length + ' å€‹\n' +
        'ç¸½è¨‚å–®æ•¸ï¼š' + totalOrders + ' ç­†\n' +
        'ç¸½ä»¶æ•¸ï¼š' + totalItems + ' ä»¶\n\n' +
        'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n';

    createdWaves.forEach(function(w) {
        resultText += 'â€¢ ' + w.waveNo + ' (' + w.logistics + ')ï¼š' + w.orderCount + 'å–® ' + w.totalQty + 'ä»¶\n';
    });

    alert(resultText);
};

window.createWave = async function() {
    const checked = document.querySelectorAll('.wave-order-check:checked');
    if (checked.length === 0) {
        alert('è«‹é¸æ“‡è‡³å°‘ä¸€ç­†è¨‚å–®');
        return;
    }

    const selectedOrderNos = new Set();
    checked.forEach(cb => selectedOrderNos.add(cb.dataset.orderNo));

    const selectedOrders = window._orderData.orders.filter(o => selectedOrderNos.has(o.orderNo));

    const logisticsSet = new Set();
    selectedOrders.forEach(o => logisticsSet.add(o.logistics || 'æœªæŒ‡å®š'));
    const logisticsStr = Array.from(logisticsSet).join(', ');

    const summary = {};
    let totalQty = 0;
    let totalSmallQty = 0;

    selectedOrders.forEach(order => {
        (order.items || []).forEach(item => {
            const key = `${item.productName}|||${item.spec || ''}`;
            if (!summary[key]) {
                summary[key] = {
                    productName: item.productName,
                    spec: item.spec || '',
                    unit: item.packageUnit || 'ä»¶',     // åŒ…è£å–®ä½
                    smallUnit: item.unit || '',         // æœ€å°å–®ä½
                    totalQty: 0,                        // åŒ…è£æ•¸é‡
                    totalSmallQty: 0,                   // æœ€å°å–®ä½æ•¸é‡
                    orders: []  // è¨˜éŒ„å“ªäº›è¨‚å–®éœ€è¦é€™å€‹å“é …
                };
            }
            const pkgQty = item.packageQty || 1;
            summary[key].totalQty += pkgQty;
            summary[key].totalSmallQty += item.quantity || 0;
            summary[key].orders.push({
                orderNo: order.orderNo,
                orderId: order.id,
                customer: order.customer,
                quantity: pkgQty  // ä½¿ç”¨åŒ…è£æ•¸é‡
            });
            totalQty += pkgQty;
            totalSmallQty += item.quantity || 0;
        });
    });

    const summaryList = Object.values(summary);

    const wave = {
        waveNo: generateWaveNo(),
        logistics: logisticsStr,
        status: 'pending',
        orders: selectedOrders.map(o => ({
            id: o.id,
            orderNo: o.orderNo,
            customer: o.customer,
            logistics: o.logistics,
            address: o.address,
            items: o.items
        })),
        summary: summaryList,  // å½™ç¸½æ€è²¨æ¸…å–®
        orderCount: selectedOrders.length,
        itemCount: summaryList.length,
        totalQty: totalQty,            // åŒ…è£æ•¸é‡
        totalSmallQty: totalSmallQty,  // æœ€å°å–®ä½æ•¸é‡
        createdAt: new Date().toISOString(),
        createdBy: window.getOperatorName ? window.getOperatorName() : 'system'
    };

    try {
        const docRef = await window.addDoc(window.collection(window.db, 'waves'), wave);
        wave.id = docRef.id;

        for (const order of selectedOrders) {
            if (order.id) {
                await window.updateDoc(window.doc(window.db, 'salesOrders', order.id), {
                    status: 'inWave',
                    waveNo: wave.waveNo
                });
            }
        }

    } catch (err) {
        console.error('å„²å­˜æ³¢æ¬¡å¤±æ•—:', err);
    }

    window._waveData.waves.push(wave);
    saveWaves();

    closeCreateWaveModal();
    refreshWaveList();

    alert('âœ… æ³¢æ¬¡ ' + wave.waveNo + ' å»ºç«‹æˆåŠŸï¼\n\n' +
          'è¨‚å–®æ•¸ï¼š' + selectedOrders.length + ' ç­†\n' +
          'å“é …æ•¸ï¼š' + summaryList.length + ' é …\n' +
          'ç¸½ä»¶æ•¸ï¼š' + totalQty + ' ä»¶\n\n' +
          'ğŸ“± æ‰‹æ©Ÿç‰ˆå·²åŒæ­¥');
};

window.openWaveExecute = function(waveNo) {
    const wave = window._waveData.waves.find(w => w.waveNo === waveNo);
    if (!wave) {
        alert('æ‰¾ä¸åˆ°æ³¢æ¬¡ ' + waveNo);
        return;
    }

    if (wave.status === 'pending') {
        wave.status = 'picking';
        wave.startedAt = new Date().toISOString();
        saveWaves();

        if (wave.id) {
            window.updateDoc(window.doc(window.db, 'waves', wave.id), {
                status: 'picking',
                startedAt: wave.startedAt
            }).catch(err => console.error('æ›´æ–°æ³¢æ¬¡ç‹€æ…‹å¤±æ•—:', err));
        }
    }

    window._waveData.currentWave = wave;
    window._waveData.pickingList = [];
    window._waveData.completedItems = wave.completedItems || [];

    document.getElementById('wave-exec-no').innerText = wave.waveNo;
    document.getElementById('wave-exec-logistics').innerText = 'ç‰©æµå•†ï¼š' + wave.logistics;

    generatePickingListV2(wave);

    document.getElementById('modal-wave-execute').classList.remove('hidden');

    setTimeout(function() {
        document.getElementById('wave-scan-input').focus();
    }, 100);
};

function generatePickingListV2(wave) {
    const pickingList = [];
    const pallets = window.currentPallets ? window.currentPallets() : [];

    (wave.summary || []).forEach(item => {
        let needed = item.totalQty;
        const productName = item.productName;
        const spec = item.spec || '';

        const matchingPallets = pallets.filter(p => {
            const pName = p.productName || '';
            const pSpec = p.spec || '';
            return pName === productName && (spec === '' || pSpec.includes(spec) || spec.includes(pSpec));
        }).sort((a, b) => {
            const dateA = a.expDate || '9999-12-31';
            const dateB = b.expDate || '9999-12-31';
            return dateA.localeCompare(dateB);
        });

        matchingPallets.forEach(pallet => {
            if (needed <= 0) return;

            const available = parseInt(pallet.quantity) || 0;
            const pick = Math.min(available, needed);

            if (pick > 0) {
                pickingList.push({
                    id: pallet.palletId + '-' + item.productName,
                    palletId: pallet.palletId,
                    locationId: pallet.locationId,
                    productName: pallet.productName,
                    spec: pallet.spec || '',
                    batchNo: pallet.batchNo || '',
                    expDate: pallet.expDate || '',
                    pickQty: pick,
                    availableQty: available,
                    orders: item.orders,  // éœ€è¦é€™å€‹å“é …çš„è¨‚å–®åˆ—è¡¨
                    completed: false
                });
                needed -= pick;
            }
        });

        if (needed > 0) {
            pickingList.push({
                id: 'shortage-' + item.productName,
                palletId: '-',
                locationId: 'âš ï¸ åº«å­˜ä¸è¶³',
                productName: item.productName,
                spec: item.spec || '',
                batchNo: '',
                pickQty: needed,
                availableQty: 0,
                orders: item.orders,
                completed: false,
                shortage: true
            });
        }
    });

    (wave.completedItems || []).forEach(itemId => {
        const item = pickingList.find(p => p.id === itemId);
        if (item) item.completed = true;
    });

    pickingList.sort(function(a, b) {
        if (a.shortage && !b.shortage) return 1;
        if (!a.shortage && b.shortage) return -1;

        var parseLocation = function(loc) {
            if (!loc) return { warehouse: 9, zone: 'Z', row: 99, col: 99 };
            var parts = loc.split('-');
            var zone = (parts[0] || 'Z').toUpperCase();
            var warehouse = 9;
            if (zone === 'A' || zone === 'B') warehouse = 1;
            else if (zone === 'C' || zone === 'D') warehouse = 2;
            return {
                warehouse: warehouse,
                zone: zone,
                row: parseInt(parts[1]) || 99,
                col: parseInt(parts[2]) || 99
            };
        };

        var locA = parseLocation(a.locationId);
        var locB = parseLocation(b.locationId);

        if (locA.warehouse !== locB.warehouse) return locA.warehouse - locB.warehouse;
        if (locA.zone !== locB.zone) return locA.zone.localeCompare(locB.zone);
        if (locA.row !== locB.row) return locA.row - locB.row;
        return locA.col - locB.col;
    });

    window._waveData.pickingList = pickingList;
    renderPickingListV2();
    updateWaveProgress();
}

function renderPickingListV2() {
    const tbody = document.getElementById('wave-picking-list');
    if (!tbody) return;

    const list = window._waveData.pickingList;

    if (list.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-slate-500 py-8">æ²’æœ‰æ€è²¨é …ç›®</td></tr>';
        return;
    }

    let html = '';
    list.forEach(item => {
        const statusIcon = item.completed ?
            '<i class="fa-solid fa-check-circle text-green-500 text-lg"></i>' :
            (item.shortage ?
                '<i class="fa-solid fa-exclamation-triangle text-red-500 text-lg"></i>' :
                '<i class="fa-regular fa-circle text-slate-500 text-lg"></i>');

        const rowClass = item.completed ? 'bg-green-900/20' : (item.shortage ? 'bg-red-900/20' : '');
        const textClass = item.completed ? 'line-through text-slate-500' : '';

        const orderInfo = (item.orders || []).slice(0, 3).map(o =>
            `${o.customer}(${o.quantity})`
        ).join(', ');
        const moreOrders = (item.orders || []).length > 3 ? '...' : '';

        let qtyDisplay = `<span class="text-yellow-400 font-bold text-lg">${item.pickQty}</span>`;
        if (item.totalWeight && item.totalWeight > 0) {
            const pickWeight = item.availableQty > 0 ? Math.round(item.pickQty / item.availableQty * item.totalWeight * 10) / 10 : 0;
            if (pickWeight > 0) {
                qtyDisplay += `<span class="text-amber-400 text-xs ml-1">/${pickWeight}kg</span>`;
            }
        }

        html += `<tr class="hover:bg-slate-800/50 border-b border-slate-700/50 ${rowClass}">`;
        html += `<td class="p-2 text-center">${statusIcon}</td>`;
        html += `<td class="p-2 ${textClass}"><span class="text-cyan-400 font-mono">${item.locationId}</span></td>`;
        html += `<td class="p-2 ${textClass}"><span class="text-purple-400 font-mono text-xs">${item.palletId}</span></td>`;
        html += `<td class="p-2 ${textClass} text-white">${item.productName}</td>`;
        html += `<td class="p-2 ${textClass} text-slate-400 text-xs">${item.spec}</td>`;
        html += `<td class="p-2 text-right ${textClass}">
            ${qtyDisplay}
            ${!item.shortage ? `<span class="text-slate-500 text-xs ml-1">/ ${item.availableQty}</span>` : ''}
        </td>`;
        html += `<td class="p-2 ${textClass} text-xs text-slate-400">${item.batchNo || '-'}</td>`;
        html += `<td class="p-2 ${textClass} text-xs text-slate-500" title="${(item.orders || []).map(o => o.customer).join(', ')}">${orderInfo}${moreOrders}</td>`;
        html += '</tr>';
    });

    tbody.innerHTML = html;
}

function updateWaveProgress() {
    const list = window._waveData.pickingList;
    const completed = list.filter(i => i.completed).length;
    const total = list.filter(i => !i.shortage).length;

    document.getElementById('wave-exec-progress').innerText = completed + '/' + total;
}

window.confirmWaveScan = async function() {
    const input = document.getElementById('wave-scan-input');
    const result = document.getElementById('wave-scan-result');
    const scanned = input.value.trim().toUpperCase();

    if (!scanned) return;

    const list = window._waveData.pickingList;

    const found = list.find(i => !i.completed && !i.shortage &&
        (i.palletId === scanned || i.palletId.toUpperCase() === scanned ||
         i.locationId === scanned || i.locationId.toUpperCase() === scanned));

    if (!found) {
        result.className = 'mt-2 text-sm p-2 rounded bg-red-900/50 text-red-300';
        result.innerText = 'âŒ æ‰¾ä¸åˆ°åŒ¹é…é …ç›®ï¼š' + scanned;
        result.classList.remove('hidden');
        input.select();
        return;
    }

    found.completed = true;

    const wave = window._waveData.currentWave;
    if (!wave.completedItems) wave.completedItems = [];
    wave.completedItems.push(found.id);

    if (wave.id) {
        try {
            await window.updateDoc(window.doc(window.db, 'waves', wave.id), {
                completedItems: wave.completedItems,
                status: 'picking'
            });
        } catch (err) {
            console.error('æ›´æ–°é€²åº¦å¤±æ•—:', err);
        }
    }

    saveWaves();

    result.className = 'mt-2 text-sm p-2 rounded bg-green-900/50 text-green-300';
    result.innerText = 'âœ… ' + found.locationId + ' â†’ ' + found.productName + ' x ' + found.pickQty;
    result.classList.remove('hidden');

    renderPickingListV2();
    updateWaveProgress();

    input.value = '';
    input.focus();
};

window.printSortingLabels = function() {
    const wave = window._waveData.currentWave;
    if (!wave || !wave.orders) {
        alert('æ²’æœ‰è¨‚å–®è³‡æ–™');
        return;
    }

    const printWindow = window.open('', '_blank', 'width=1100,height=800');
    let labelsHtml = '';

    wave.orders.forEach(order => {
        let totalPkg = 0;
        const itemsHtml = (order.items || []).filter(item => {
            return !window.isExcludedFromSortingLabel(item.productName);
        }).map(item => {
            const qty = item.quantity || 0;
            const boxPerPkg = window.parseBoxPerPackage ? window.parseBoxPerPackage(item.productName) : 0;
            const pkgQty = (boxPerPkg > 0 && qty > 0) ? Math.ceil(qty / boxPerPkg) : (item.packageQty || 1);
            const isPackaging = window.isPackagingItem(item.productName);
            if (!isPackaging) {
                totalPkg += pkgQty;
            }
            const qtyText = isPackaging ? '(åŒ…æ)' : pkgQty + ' ä»¶';
            return `<div class="item">${item.productName} ${item.spec || ''} <strong>${qtyText}</strong></div>`;
        }).join('');

        labelsHtml += `
            <div class="label">
                <div class="logistics">${order.logistics || wave.logistics}</div>
                <div class="order-no">ğŸ“¦ ${order.orderNo}</div>
                <div class="customer">ğŸ‘¤ ${order.customer}</div>
                <div class="total">å…± ${totalPkg} ä»¶</div>
                <div class="items">${itemsHtml}</div>
                ${order.address ? `<div class="address">ğŸ“ ${order.address}</div>` : ''}
            </div>
        `;
    });

    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>åˆ†è²¨æ¨™ç±¤ - ${wave.waveNo}</title>
            <style>
                body { font-family: 'Microsoft JhengHei', sans-serif; }
                .label {
                    border: 2px solid #333;
                    padding: 15px;
                    margin: 10px;
                    page-break-inside: avoid;
                    width: 300px;
                    display: inline-block;
                    vertical-align: top;
                }
                .logistics {
                    background: #333;
                    color: white;
                    padding: 5px 10px;
                    font-weight: bold;
                    margin: -15px -15px 10px -15px;
                }
                .order-no { font-size: 14px; color: #666; margin-bottom: 5px; }
                .customer { font-size: 20px; font-weight: bold; margin-bottom: 10px; }
                .items { border-top: 1px dashed #ccc; padding-top: 10px; }
                .item { margin: 5px 0; }
                .total {
                    background: #dc2626;
                    color: white;
                    padding: 8px;
                    text-align: center;
                    font-size: 20px;
                    font-weight: bold;
                    margin: 10px 0;
                    border-radius: 4px;
                }
                .address {
                    font-size: 12px;
                    color: #666;
                    margin-top: 10px;
                    border-top: 1px dashed #ccc;
                    padding-top: 10px;
                }
                @media print {
                    .label { break-inside: avoid; }
                }
            </style>
        </head>
        <body>
            ${labelsHtml}
        </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();
};

window.completeWave = async function() {
    const wave = window._waveData.currentWave;
    const list = window._waveData.pickingList;

    const completed = list.filter(i => i.completed).length;
    const total = list.filter(i => !i.shortage).length;

    if (completed === 0) {
        alert('å°šæœªæ€è²¨ä»»ä½•é …ç›®');
        return;
    }

    if (completed < total) {
        if (!confirm(`å°šæœ‰ ${total - completed} é …æœªå®Œæˆï¼Œç¢ºå®šè¦çµæŸæ³¢æ¬¡å—ï¼Ÿ`)) {
            return;
        }
    }

    if (!confirm(`ç¢ºå®šå®Œæˆæ³¢æ¬¡ ${wave.waveNo}ï¼Ÿ\n\nå·²æ€ï¼š${completed}/${total} é …`)) {
        return;
    }

    wave.status = 'done';
    wave.completedAt = new Date().toISOString();

    const pallets = window.currentPallets ? window.currentPallets() : [];

    for (const item of list.filter(i => i.completed)) {
        const pallet = pallets.find(p => p.palletId === item.palletId);
        if (pallet && pallet.id) {
            const newQty = Math.max(0, (parseInt(pallet.quantity) || 0) - item.pickQty);

            try {
                await window.updateDoc(window.doc(window.db, 'pallets', pallet.id), {
                    quantity: newQty
                });

                if (window.logInventoryChange) {
                    await window.logInventoryChange({
                        type: 'outbound',
                        productName: item.productName,
                        spec: item.spec,
                        quantity: item.pickQty,
                        quantityChange: -item.pickQty,
                        locationId: item.locationId,
                        batchNo: item.batchNo,
                        palletId: item.palletId,
                        note: 'æ³¢æ¬¡æ€è²¨ ' + wave.waveNo
                    });
                }
            } catch (err) {
                console.error('æ‰£æ¸›åº«å­˜å¤±æ•—:', item.palletId, err);
            }
        }
    }

    for (const order of wave.orders || []) {
        if (order.id) {
            try {
                await window.updateDoc(window.doc(window.db, 'salesOrders', order.id), {
                    status: 'shipped',
                    shippedAt: new Date().toISOString(),
                    waveNo: wave.waveNo
                });
            } catch (err) {
                console.error('æ›´æ–°è¨‚å–®ç‹€æ…‹å¤±æ•—:', order.orderNo, err);
            }
        }
    }

    if (wave.id) {
        try {
            await window.updateDoc(window.doc(window.db, 'waves', wave.id), {
                status: 'done',
                completedAt: wave.completedAt
            });
        } catch (err) {
            console.error('æ›´æ–°æ³¢æ¬¡ç‹€æ…‹å¤±æ•—:', err);
        }
    }

    saveWaves();

    alert('âœ… æ³¢æ¬¡ ' + wave.waveNo + ' å·²å®Œæˆï¼');

    closeWaveExecuteModal();
    refreshWaveList();
};

window.closeWaveExecuteModal = function() {
    document.getElementById('modal-wave-execute').classList.add('hidden');
    refreshWaveList();
};

document.addEventListener('DOMContentLoaded', function() {
    if (window.db) {
        loadOrdersFromFirebase();
        loadWarehouses();
    }
});

console.log('âœ… æ³¢æ¬¡ç†è²¨å‡ç´šç‰ˆè¼‰å…¥å®Œæˆ');

// ========== å ±è¡¨ä¸­å¿ƒåŠŸèƒ½ ==========

window._reportData = { currentType: null, currentData: [], dateFrom: null, dateTo: null };

function initReportDates() {
    var today = new Date().toISOString().split('T')[0];
    var fromEl = document.getElementById('report-date-from');
    var toEl = document.getElementById('report-date-to');
    if (fromEl) fromEl.value = today;
    if (toEl) toEl.value = today;
}

window.setQuickDateRange = function() {
    var range = document.getElementById('report-quick-date').value;
    var today = new Date();
    var from, to;

    if (range === 'today') {
        from = to = today;
    } else if (range === 'yesterday') {
        from = to = new Date(today.getTime() - 24 * 60 * 60 * 1000);
    } else if (range === 'week') {
        var day = today.getDay();
        from = new Date(today.getTime() - day * 24 * 60 * 60 * 1000);
        to = today;
    } else if (range === 'month') {
        from = new Date(today.getFullYear(), today.getMonth(), 1);
        to = today;
    } else if (range === 'lastmonth') {
        from = new Date(today.getFullYear(), today.getMonth() - 1, 1);
        to = new Date(today.getFullYear(), today.getMonth(), 0);
    } else {
        return;
    }

    document.getElementById('report-date-from').value = from.toISOString().split('T')[0];
    document.getElementById('report-date-to').value = to.toISOString().split('T')[0];
};

window.generateReport = function(reportType) {
    var dateFrom = document.getElementById('report-date-from').value;
    var dateTo = document.getElementById('report-date-to').value;

    if (!dateFrom || !dateTo) {
        alert('è«‹é¸æ“‡æ—¥æœŸå€é–“');
        return;
    }

    window._reportData.currentType = reportType;
    window._reportData.dateFrom = dateFrom;
    window._reportData.dateTo = dateTo;

    var preview = document.getElementById('report-preview-area');
    preview.innerHTML = '<div class="text-center py-10"><i class="fa-solid fa-spinner fa-spin text-4xl text-blue-400"></i><div class="mt-4 text-slate-400">ç”¢ç”Ÿå ±è¡¨ä¸­...</div></div>';

    setTimeout(function() {
        if (reportType === 'shipping-logistics') generateShippingByLogistics(dateFrom, dateTo);
        else if (reportType === 'shipping-customer') generateShippingByCustomer(dateFrom, dateTo);
        else if (reportType === 'shipping-product') generateShippingByProduct(dateFrom, dateTo);
        else if (reportType === 'inventory-summary') generateInventorySummary();
        else if (reportType === 'inventory-expiry') generateExpiryReport();
        else if (reportType === 'wave-summary') generateWaveSummary(dateFrom, dateTo);
        else if (reportType === 'wave-efficiency') generateWaveEfficiency(dateFrom, dateTo);
        else if (reportType === 'order-status') generateOrderStatus(dateFrom, dateTo);
        else if (reportType === 'pending-orders') generatePendingOrders();
        else preview.innerHTML = '<div class="text-center text-red-400 py-10">æœªçŸ¥çš„å ±è¡¨é¡å‹</div>';
    }, 200);
};

function generateShippingByLogistics(dateFrom, dateTo) {
    var waves = (window._waveData.waves || []).filter(function(w) {
        if (w.status !== 'done') return false;
        var date = (w.completedAt || w.createdAt || '').split('T')[0];
        return date >= dateFrom && date <= dateTo;
    });

    var stats = {};
    waves.forEach(function(w) {
        var logistics = w.logistics || 'æœªæŒ‡å®š';
        if (!stats[logistics]) stats[logistics] = { waveCount: 0, orderCount: 0, totalQty: 0 };
        stats[logistics].waveCount++;
        stats[logistics].orderCount += (w.orders || []).length;
        stats[logistics].totalQty += w.totalQty || 0;
    });

    var data = Object.keys(stats).map(function(logistics) {
        var s = stats[logistics];
        return { 'ç‰©æµå•†': logistics, 'æ³¢æ¬¡æ•¸': s.waveCount, 'è¨‚å–®æ•¸': s.orderCount, 'ç¸½ä»¶æ•¸': s.totalQty };
    });

    window._reportData.currentData = data;
    renderReportTable('å‡ºè²¨çµ±è¨ˆ - ä¾ç‰©æµå•†', ['ç‰©æµå•†', 'æ³¢æ¬¡æ•¸', 'è¨‚å–®æ•¸', 'ç¸½ä»¶æ•¸'], data);
}

function generateShippingByCustomer(dateFrom, dateTo) {
    var waves = (window._waveData.waves || []).filter(function(w) {
        if (w.status !== 'done') return false;
        var date = (w.completedAt || w.createdAt || '').split('T')[0];
        return date >= dateFrom && date <= dateTo;
    });

    var stats = {};
    waves.forEach(function(w) {
        (w.orders || []).forEach(function(order) {
            var customer = order.customer || 'æœªçŸ¥';
            if (!stats[customer]) stats[customer] = { orderCount: 0, totalQty: 0 };
            stats[customer].orderCount++;
            (order.items || []).forEach(function(item) {
                stats[customer].totalQty += item.packageQty || item.quantity || 0;
            });
        });
    });

    var data = Object.keys(stats).map(function(customer) {
        var s = stats[customer];
        return { 'å®¢æˆ¶': customer, 'è¨‚å–®æ•¸': s.orderCount, 'ç¸½ä»¶æ•¸': s.totalQty };
    }).sort(function(a, b) { return b['ç¸½ä»¶æ•¸'] - a['ç¸½ä»¶æ•¸']; });

    window._reportData.currentData = data;
    renderReportTable('å‡ºè²¨çµ±è¨ˆ - ä¾å®¢æˆ¶', ['å®¢æˆ¶', 'è¨‚å–®æ•¸', 'ç¸½ä»¶æ•¸'], data);
}

function generateShippingByProduct(dateFrom, dateTo) {
    var waves = (window._waveData.waves || []).filter(function(w) {
        if (w.status !== 'done') return false;
        var date = (w.completedAt || w.createdAt || '').split('T')[0];
        return date >= dateFrom && date <= dateTo;
    });

    var stats = {};
    waves.forEach(function(w) {
        (w.orders || []).forEach(function(order) {
            (order.items || []).forEach(function(item) {
                var key = item.productName + '|||' + (item.spec || '');
                if (!stats[key]) stats[key] = { productName: item.productName, spec: item.spec || '', count: 0, totalQty: 0 };
                stats[key].count++;
                stats[key].totalQty += item.packageQty || item.quantity || 0;
            });
        });
    });

    var data = Object.values(stats).map(function(s) {
        return { 'å“å': s.productName, 'è¦æ ¼': s.spec, 'å‡ºè²¨æ¬¡æ•¸': s.count, 'ç¸½ä»¶æ•¸': s.totalQty };
    }).sort(function(a, b) { return b['ç¸½ä»¶æ•¸'] - a['ç¸½ä»¶æ•¸']; });

    window._reportData.currentData = data;
    renderReportTable('å‡ºè²¨çµ±è¨ˆ - ä¾ç”¢å“', ['å“å', 'è¦æ ¼', 'å‡ºè²¨æ¬¡æ•¸', 'ç¸½ä»¶æ•¸'], data);
}

function generateInventorySummary() {
    var pallets = window.currentPallets ? window.currentPallets() : [];

    var stats = {};
    pallets.forEach(function(p) {
        var key = p.productName + '|||' + (p.spec || '');
        if (!stats[key]) stats[key] = { productName: p.productName, spec: p.spec || '', totalQty: 0, palletCount: 0 };
        stats[key].totalQty += parseInt(p.quantity) || 0;
        stats[key].palletCount++;
    });

    var data = Object.values(stats).map(function(s) {
        return { 'å“å': s.productName, 'è¦æ ¼': s.spec, 'ç¸½æ•¸é‡': s.totalQty, 'æ¿æ•¸': s.palletCount };
    }).sort(function(a, b) { return b['ç¸½æ•¸é‡'] - a['ç¸½æ•¸é‡']; });

    window._reportData.currentData = data;
    window._reportData.dateFrom = '-';
    window._reportData.dateTo = '-';
    renderReportTable('åº«å­˜å½™ç¸½', ['å“å', 'è¦æ ¼', 'ç¸½æ•¸é‡', 'æ¿æ•¸'], data);
}

function generateExpiryReport() {
    var pallets = window.currentPallets ? window.currentPallets() : [];
    var today = new Date();

    var data = pallets.filter(function(p) { return p.expDate; }).map(function(p) {
        var expDate = new Date(p.expDate);
        var daysLeft = Math.ceil((expDate - today) / (24 * 60 * 60 * 1000));
        var status = daysLeft <= 0 ? 'å·²éæœŸ' : daysLeft <= 30 ? '30å¤©å…§' : daysLeft <= 60 ? '60å¤©å…§' : 'æ­£å¸¸';
        return { 'å“å': p.productName, 'è¦æ ¼': p.spec || '', 'æ•ˆæœŸ': p.expDate, 'å‰©é¤˜å¤©æ•¸': daysLeft, 'ç‹€æ…‹': status, 'æ•¸é‡': p.quantity };
    }).filter(function(p) { return p['å‰©é¤˜å¤©æ•¸'] <= 60; }).sort(function(a, b) { return a['å‰©é¤˜å¤©æ•¸'] - b['å‰©é¤˜å¤©æ•¸']; });

    window._reportData.currentData = data;
    window._reportData.dateFrom = '-';
    window._reportData.dateTo = '-';
    renderReportTable('æ•ˆæœŸé è­¦å ±è¡¨', ['å“å', 'è¦æ ¼', 'æ•ˆæœŸ', 'å‰©é¤˜å¤©æ•¸', 'ç‹€æ…‹', 'æ•¸é‡'], data);
}

function generateWaveSummary(dateFrom, dateTo) {
    var waves = (window._waveData.waves || []).filter(function(w) {
        var date = (w.createdAt || '').split('T')[0];
        return date >= dateFrom && date <= dateTo;
    });

    var statusMap = { pending: 'å¾…æ€è²¨', picking: 'æ€è²¨ä¸­', sorting: 'å¾…åˆ†è²¨', done: 'å·²å‡ºè²¨' };

    var data = waves.map(function(w) {
        var duration = '-';
        if (w.completedAt && w.createdAt) {
            duration = Math.round((new Date(w.completedAt) - new Date(w.createdAt)) / 60000) + ' åˆ†é˜';
        }
        return {
            'æ³¢æ¬¡ç·¨è™Ÿ': w.waveNo,
            'ç‰©æµå•†': w.logistics,
            'ç‹€æ…‹': statusMap[w.status] || w.status,
            'è¨‚å–®æ•¸': (w.orders || []).length,
            'ç¸½ä»¶æ•¸': w.totalQty || 0,
            'å»ºç«‹æ™‚é–“': new Date(w.createdAt).toLocaleString('zh-TW'),
            'è€—æ™‚': duration
        };
    });

    window._reportData.currentData = data;
    renderReportTable('æ³¢æ¬¡çµ±è¨ˆ', ['æ³¢æ¬¡ç·¨è™Ÿ', 'ç‰©æµå•†', 'ç‹€æ…‹', 'è¨‚å–®æ•¸', 'ç¸½ä»¶æ•¸', 'å»ºç«‹æ™‚é–“', 'è€—æ™‚'], data);
}

function generateWaveEfficiency(dateFrom, dateTo) {
    var waves = (window._waveData.waves || []).filter(function(w) {
        if (w.status !== 'done') return false;
        var date = (w.completedAt || '').split('T')[0];
        return date >= dateFrom && date <= dateTo;
    });

    var data = waves.map(function(w) {
        var minutes = w.completedAt && w.createdAt ? Math.round((new Date(w.completedAt) - new Date(w.createdAt)) / 60000) : 0;
        var efficiency = minutes > 0 ? ((w.totalQty || 0) / minutes).toFixed(1) : '-';
        return { 'æ³¢æ¬¡ç·¨è™Ÿ': w.waveNo, 'ç‰©æµå•†': w.logistics, 'ç¸½ä»¶æ•¸': w.totalQty || 0, 'è€—æ™‚åˆ†é˜': minutes, 'æ•ˆç‡': efficiency + ' ä»¶/åˆ†' };
    });

    window._reportData.currentData = data;
    renderReportTable('æ€è²¨æ•ˆç‡åˆ†æ', ['æ³¢æ¬¡ç·¨è™Ÿ', 'ç‰©æµå•†', 'ç¸½ä»¶æ•¸', 'è€—æ™‚åˆ†é˜', 'æ•ˆç‡'], data);
}

function renderReportTable(title, columns, data) {
    var preview = document.getElementById('report-preview-area');
    var titleHint = document.getElementById('report-title-hint');
    if (titleHint) titleHint.innerText = '- ' + title;

    if (data.length === 0) {
        preview.innerHTML = '<div class="h-full flex flex-col items-center justify-center text-slate-500"><i class="fa-solid fa-inbox text-6xl mb-4 opacity-50"></i><div class="text-lg">æŸ¥ç„¡è³‡æ–™</div><div class="text-sm text-slate-600 mt-2">è«‹èª¿æ•´æŸ¥è©¢æ¢ä»¶å¾Œé‡è©¦</div></div>';
        return;
    }

    var html = '<div class="mb-4 pb-3 border-b border-slate-700"><h3 class="text-white text-xl font-bold">' + title + '</h3>' +
        '<p class="text-slate-400 text-sm mt-1"><i class="fa-solid fa-calendar mr-1"></i>' + window._reportData.dateFrom + ' ~ ' + window._reportData.dateTo + ' <span class="mx-2">|</span> <i class="fa-solid fa-database mr-1"></i>å…± ' + data.length + ' ç­†è³‡æ–™</p></div>' +
        '<table class="w-full text-sm"><thead class="bg-slate-700/80 sticky top-0"><tr>';

    columns.forEach(function(col) { html += '<th class="p-2 text-left text-slate-300">' + col + '</th>'; });
    html += '</tr></thead><tbody>';

    data.forEach(function(row, idx) {
        var bgClass = idx % 2 === 0 ? 'bg-slate-800/30' : '';
        html += '<tr class="' + bgClass + ' hover:bg-slate-700/50 border-b border-slate-700/50">';
        columns.forEach(function(col) {
            var value = row[col] !== undefined ? row[col] : '';
            var cellClass = typeof value === 'number' ? 'text-right text-yellow-400' : 'text-slate-300';
            if (col === 'ç‹€æ…‹' && value === 'å·²éæœŸ') cellClass = 'text-red-400 font-bold';
            html += '<td class="p-2 ' + cellClass + '">' + value + '</td>';
        });
        html += '</tr>';
    });

    html += '</tbody></table>';
    preview.innerHTML = html;
}

window.exportReportExcel = function() {
    var data = window._reportData.currentData;
    if (!data || data.length === 0) {
        alert('æ²’æœ‰è³‡æ–™å¯åŒ¯å‡º');
        return;
    }

    var ws = XLSX.utils.json_to_sheet(data);
    var wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'å ±è¡¨');

    var fileName = (window._reportData.currentType || 'report') + '_' +
                   window._reportData.dateFrom + '_' +
                   window._reportData.dateTo + '.xlsx';

    XLSX.writeFile(wb, fileName);
};

window.printReport = function() {
    var preview = document.getElementById('report-preview-area');
    if (!preview.innerHTML.includes('<table')) {
        alert('æ²’æœ‰å ±è¡¨å¯åˆ—å°');
        return;
    }

    var printWindow = window.open('', '_blank', 'width=1100,height=800');
    printWindow.document.write('<!DOCTYPE html><html><head><title>å ±è¡¨åˆ—å°</title>' +
        '<style>body{font-family:"Microsoft JhengHei",sans-serif;padding:20px}' +
        'h3{margin-bottom:5px}p{color:#666;margin-bottom:15px}' +
        'table{width:100%;border-collapse:collapse;font-size:12px}' +
        'th,td{border:1px solid #333;padding:6px;text-align:left}' +
        'th{background:#f0f0f0}tr:nth-child(even){background:#f9f9f9}</style></head>' +
        '<body>' + preview.innerHTML + '<script>window.print();<\/script></body></html>');
    printWindow.document.close();
};

window.generateTodayReport = function() {
    var today = new Date().toISOString().split('T')[0];
    document.getElementById('report-date-from').value = today;
    document.getElementById('report-date-to').value = today;
    generateReport('shipping-logistics');
};

function generateOrderStatus(dateFrom, dateTo) {
    var orders = window._orderData.orders || [];

    var stats = { pending: 0, inWave: 0, shipped: 0, confirmed: 0 };
    orders.forEach(function(o) {
        var status = o.status || 'pending';
        if (stats[status] !== undefined) stats[status]++;
        else if (o.waveNo && status !== 'shipped') stats.inWave++;
    });

    var total = orders.length || 1;
    var data = [
        { 'ç‹€æ…‹': 'å¾…è™•ç†', 'æ•¸é‡': stats.pending, 'ä½”æ¯”': (stats.pending / total * 100).toFixed(1) + '%' },
        { 'ç‹€æ…‹': 'å·²å»ºæ³¢æ¬¡', 'æ•¸é‡': stats.inWave, 'ä½”æ¯”': (stats.inWave / total * 100).toFixed(1) + '%' },
        { 'ç‹€æ…‹': 'å·²å‡ºè²¨', 'æ•¸é‡': stats.shipped, 'ä½”æ¯”': (stats.shipped / total * 100).toFixed(1) + '%' },
        { 'ç‹€æ…‹': 'å·²ç¢ºèª', 'æ•¸é‡': stats.confirmed, 'ä½”æ¯”': (stats.confirmed / total * 100).toFixed(1) + '%' }
    ];

    window._reportData.currentData = data;
    window._reportData.dateFrom = '-';
    window._reportData.dateTo = '-';
    renderReportTable('è¨‚å–®ç‹€æ…‹çµ±è¨ˆ', ['ç‹€æ…‹', 'æ•¸é‡', 'ä½”æ¯”'], data);
}

function generatePendingOrders() {
    var orders = (window._orderData.orders || []).filter(function(o) {
        return o.status === 'pending' && !o.waveNo;
    });

    var data = orders.map(function(o) {
        var itemCount = (o.items || []).length;
        var totalQty = (o.items || []).reduce(function(sum, item) {
            return sum + (item.packageQty || item.quantity || 0);
        }, 0);
        return {
            'è¨‚å–®ç·¨è™Ÿ': o.orderNo,
            'å®¢æˆ¶': o.customer,
            'ç‰©æµå•†': o.logistics || '-',
            'å“é …æ•¸': itemCount,
            'ç¸½ä»¶æ•¸': totalQty,
            'è¨‚å–®æ—¥æœŸ': o.orderDate || '-'
        };
    });

    window._reportData.currentData = data;
    window._reportData.dateFrom = '-';
    window._reportData.dateTo = '-';
    renderReportTable('å¾…è™•ç†è¨‚å–®', ['è¨‚å–®ç·¨è™Ÿ', 'å®¢æˆ¶', 'ç‰©æµå•†', 'å“é …æ•¸', 'ç¸½ä»¶æ•¸', 'è¨‚å–®æ—¥æœŸ'], data);
}

window.generateLowStockReport = function() {
    var pallets = window.currentPallets ? window.currentPallets() : [];

    var stats = {};
    pallets.forEach(function(p) {
        var key = p.productName + '|||' + (p.spec || '');
        if (!stats[key]) stats[key] = { productName: p.productName, spec: p.spec || '', totalQty: 0 };
        stats[key].totalQty += parseInt(p.quantity) || 0;
    });

    var data = Object.values(stats).filter(function(s) { return s.totalQty < 50; }).map(function(s) {
        return { 'å“å': s.productName, 'è¦æ ¼': s.spec, 'åº«å­˜æ•¸é‡': s.totalQty, 'ç‹€æ…‹': s.totalQty < 10 ? 'âš ï¸ ç·Šæ€¥' : 'âš¡ åä½' };
    }).sort(function(a, b) { return a['åº«å­˜æ•¸é‡'] - b['åº«å­˜æ•¸é‡']; });

    window._reportData.currentData = data;
    window._reportData.currentType = 'low-stock';
    window._reportData.dateFrom = '-';
    window._reportData.dateTo = '-';

    if (data.length === 0) {
        document.getElementById('report-preview-area').innerHTML =
            '<div class="text-center text-green-400 py-20"><i class="fa-solid fa-check-circle text-6xl mb-4"></i><div class="text-lg">å¤ªæ£’äº†ï¼ç›®å‰æ²’æœ‰ä½åº«å­˜å“é …</div></div>';
        return;
    }

    renderReportTable('ä½åº«å­˜è­¦å ±', ['å“å', 'è¦æ ¼', 'åº«å­˜æ•¸é‡', 'ç‹€æ…‹'], data);
};

setTimeout(initReportDates, 500);

// ============================================================
// ============================================================

const VIRTUAL_LOCATION_CONFIG = {
    'TEMP-IN': { name: 'é€²è²¨æš«å­˜å€', color: 'emerald', icon: 'fa-truck-loading' },
    'TEMP-OUT': { name: 'å‡ºè²¨æš«å­˜å€', color: 'orange', icon: 'fa-truck' },
    'A00': { name: 'Aå€è²¨æ¶å‰ç«¯', color: 'blue', icon: 'fa-location-dot' },
    'A99': { name: 'Aå€è²¨æ¶æœ«ç«¯', color: 'blue', icon: 'fa-location-dot' },
    'B00': { name: 'Bå€è²¨æ¶å‰ç«¯', color: 'indigo', icon: 'fa-location-dot' },
    'B99': { name: 'Bå€è²¨æ¶æœ«ç«¯', color: 'indigo', icon: 'fa-location-dot' },
    'C00': { name: 'Cå€è²¨æ¶å‰ç«¯', color: 'purple', icon: 'fa-location-dot' },
    'C99': { name: 'Cå€è²¨æ¶æœ«ç«¯', color: 'purple', icon: 'fa-location-dot' },
    'D00': { name: 'Då€è²¨æ¶å‰ç«¯', color: 'pink', icon: 'fa-location-dot' },
    'D99': { name: 'Då€è²¨æ¶æœ«ç«¯', color: 'pink', icon: 'fa-location-dot' },
    'OTHER': { name: 'å…¶ä»–ä½ç½®', color: 'slate', icon: 'fa-box' }
};

const VIRTUAL_LOCATIONS = Object.keys(VIRTUAL_LOCATION_CONFIG);

async function loadVirtualLocationCounts() {
    try {
        const snapshot = await window.getDocs(window.collection(window.db, 'pallets'));

        const counts = {};
        VIRTUAL_LOCATIONS.forEach(loc => counts[loc] = 0);

        window.virtualLocationInventory = {};
        VIRTUAL_LOCATIONS.forEach(loc => window.virtualLocationInventory[loc] = []);

        snapshot.forEach(doc => {
            const data = doc.data();
            const status = (data.status || '').toLowerCase();
            const excludeStatus = ['shipped', 'outbound', 'deleted', 'cancelled', 'removed'];
            if (excludeStatus.includes(status)) return;

            if (!data.quantity || data.quantity <= 0) return;

            data.id = doc.id;
            let locId = data.locationId || '';

            const locIdUpper = locId.toUpperCase().trim();

            if (VIRTUAL_LOCATION_CONFIG[locIdUpper]) {
                counts[locIdUpper]++;
                window.virtualLocationInventory[locIdUpper].push(data);
            } else if (VIRTUAL_LOCATION_CONFIG[locId]) {
                counts[locId]++;
                window.virtualLocationInventory[locId].push(data);
            }
        });

        Object.keys(counts).forEach(locId => {
            const el = document.getElementById(`vl-count-${locId}`);
            if (el) {
                el.textContent = counts[locId];
                const card = el.closest('.virtual-loc-card');
                if (card) {
                    if (counts[locId] > 0) {
                        card.classList.add('ring-2', 'ring-offset-2', 'ring-offset-slate-900');
                        if (locId === 'TEMP-IN') card.classList.add('ring-emerald-500');
                        else if (locId === 'TEMP-OUT') card.classList.add('ring-orange-500');
                        else card.classList.add('ring-white/30');
                    } else {
                        card.classList.remove('ring-2', 'ring-offset-2', 'ring-offset-slate-900',
                                              'ring-emerald-500', 'ring-orange-500', 'ring-white/30');
                    }
                }
            }
        });

        console.log('âœ… è™›æ“¬å„²ä½æ•¸é‡å·²æ›´æ–°', counts);
    } catch (err) {
        console.error('è¼‰å…¥è™›æ“¬å„²ä½æ•¸é‡éŒ¯èª¤:', err);
    }
}

function showVirtualLocTooltip(e, locationId) {
    const config = VIRTUAL_LOCATION_CONFIG[locationId];
    if (!config) return;

    const tooltip = document.getElementById('hover-tooltip');
    const title = document.getElementById('tooltip-title');
    const badge = document.getElementById('tooltip-badge');
    const body = document.getElementById('tooltip-body');
    if (!tooltip) return;

    const items = window.virtualLocationInventory ? window.virtualLocationInventory[locationId] || [] : [];

    title.textContent = config.name + ' (' + locationId + ')';
    badge.textContent = items.length + ' æ¿';
    badge.style.background = items.length > 5 ? 'rgba(239,68,68,0.5)' : items.length > 0 ? 'rgba(59,130,246,0.5)' : 'rgba(100,116,139,0.5)';

    body.innerHTML = renderVirtualLocTooltipContent(items, locationId);

    tooltip.classList.remove('hidden');
    moveHoverTooltip(e);
}

function renderVirtualLocTooltipContent(items, locationId) {
    let html = '<div class="tooltip-summary">';
    html += '<div class="tooltip-stat ' + (items.length > 0 ? '' : 'empty') + '"><div class="tooltip-stat-value">' + items.length + '</div><div class="tooltip-stat-label">å·²å­˜æ”¾</div></div>';
    html += '<div class="tooltip-stat empty"><div class="tooltip-stat-value">âˆ</div><div class="tooltip-stat-label">å®¹é‡</div></div>';
    html += '</div>';

    if (items.length > 0) {
        html += '<table class="w-full text-xs">';
        html += '<thead><tr class="text-slate-400 border-b border-slate-700">';
        html += '<th class="p-1.5 text-left">å„²ä½</th>';
        html += '<th class="p-1.5 text-left">æ£§æ¿ç·¨è™Ÿ</th>';
        html += '<th class="p-1.5 text-left">å…¬å¸</th>';
        html += '<th class="p-1.5 text-left">å“å</th>';
        html += '<th class="p-1.5 text-left">è¦æ ¼</th>';
        html += '<th class="p-1.5 text-right">æ•¸é‡</th>';
        html += '<th class="p-1.5 text-left">æ•ˆæœŸ</th>';
        html += '<th class="p-1.5 text-left">å…¥åº«æ—¥</th>';
        html += '</tr></thead><tbody>';

        items.forEach(item => {
            const companyClass = item.company === 'å´‡æ–‡' ? 'bg-blue-600' : 'bg-emerald-600';

            let expiryStr = '-';
            if (item.expiryDate) {
                const expDate = item.expiryDate.toDate ? item.expiryDate.toDate() : new Date(item.expiryDate);
                expiryStr = expDate.toLocaleDateString('zh-TW');
                const daysLeft = Math.ceil((expDate - new Date()) / (1000 * 60 * 60 * 24));
                if (daysLeft < 0) {
                    expiryStr = '<span class="text-red-400">' + expiryStr + '</span>';
                } else if (daysLeft <= 30) {
                    expiryStr = '<span class="text-orange-400">' + expiryStr + '</span>';
                }
            }

            let inboundStr = '-';
            if (item.createdAt) {
                const inDate = item.createdAt.toDate ? item.createdAt.toDate() : new Date(item.createdAt);
                inboundStr = inDate.toLocaleDateString('zh-TW');
            }

            html += '<tr class="border-b border-slate-800 hover:bg-slate-800/50">';
            html += '<td class="p-1.5 font-mono text-[10px] text-emerald-400 font-bold">' + (item.locationId || locationId) + '</td>';
            html += '<td class="p-1.5 font-mono text-[10px] text-slate-400">' + (item.palletId || '-') + '</td>';
            html += '<td class="p-1.5"><span class="px-1 py-0.5 rounded text-[10px] ' + companyClass + '">' + (item.company || '-') + '</span></td>';
            html += '<td class="p-1.5 text-white">' + (item.productName || '-') + '</td>';
            html += '<td class="p-1.5 text-slate-400 text-[10px]">' + (item.spec || '-') + '</td>';
            html += '<td class="p-1.5 text-right font-bold text-white">' + (item.quantity || 0) + '</td>';
            html += '<td class="p-1.5">' + expiryStr + '</td>';
            html += '<td class="p-1.5 text-slate-400">' + inboundStr + '</td>';
            html += '</tr>';
        });

        html += '</tbody></table>';
    } else {
        html += '<div class="text-center text-slate-500 py-4">æ­¤æš«å­˜å€ç›®å‰æ²’æœ‰åº«å­˜</div>';
    }

    return html;
}

function selectVirtualLocation(locationId) {
    const locInput = document.getElementById('in-loc');
    if (locInput) {
        locInput.value = locationId;
        validateLocationInput();
        if (typeof updateInboundProgress === 'function') {
            updateInboundProgress();
        }
        if (typeof updateLivePreview === 'function') {
            updateLivePreview();
        }
        showNotification(`å·²é¸æ“‡è™›æ“¬å„²ä½ï¼š${VIRTUAL_LOCATION_CONFIG[locationId]?.name || locationId}`, 'success');
    }
}

const originalRefreshVisualMap = typeof refreshVisualMap === 'function' ? refreshVisualMap : null;
if (originalRefreshVisualMap) {
    const newRefreshVisualMap = async function() {
        await originalRefreshVisualMap();
        await loadVirtualLocationCounts();
    };
    window.refreshVisualMap = newRefreshVisualMap;
}

setTimeout(() => {
    if (window.db) {
        loadVirtualLocationCounts();
    }
}, 2000);

console.log('ğŸ“ è™›æ“¬å„²ä½ç›£æ§åŠŸèƒ½å·²è¼‰å…¥');

// ============================================================
// ============================================================

let importPreviewData = [];
let importStats = { total: 0, valid: 0, invalid: 0, duplicate: 0 };

function downloadImportTemplate() {
    const templateData = [
        ['å„²ä½*', 'å…¬å¸*', 'å“è™Ÿ*', 'å“å*', 'è¦æ ¼', 'æ•¸é‡*', 'å–®ä½', 'æ‰¹è™Ÿ', 'æ•ˆæœŸ'],
        ['JA-01-2F', 'å´‡æ–‡', 'BC16118T', 'ç†Ÿç™½è¦', '16/20*1.1KG*8ç›’*å‚³é®®', 30, 'ç®±', '20241201', '2025/06/30'],
        ['JA-01-2F', 'å…«æ–¹', 'BC21118T', 'ç†Ÿç™½è¦', '21/25*1.1KG*8ç›’*å‚³é®®', 25, 'ç®±', '20241215', '2025/07/15'],
        ['A99', 'å´‡æ–‡', 'A5021212', '502ç™½ä»', '100/200*12KG', 10, 'ç®±', '20241220', '2025/08/01'],
        ['TEMP-IN', 'å…«æ–¹', 'BW450802', 'ç”Ÿç™½è¦', '40/50*850G*12ç›’*å—ç¾', 50, 'ç®±', '20241225', '2025/09/01'],
    ];

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(templateData);
    ws['!cols'] = [
        { wch: 15 }, { wch: 8 }, { wch: 15 }, { wch: 18 }, { wch: 30 },
        { wch: 10 }, { wch: 8 }, { wch: 12 }, { wch: 12 }
    ];
    XLSX.utils.book_append_sheet(wb, ws, 'åº«å­˜åŒ¯å…¥');

    const instructionData = [
        ['æ¬„ä½', 'å¿…å¡«', 'èªªæ˜', 'ç¯„ä¾‹'],
        ['å„²ä½', 'æ˜¯', 'å¯¦éš›å„²ä½æˆ–è™›æ“¬å„²ä½', 'JA-01-2Fã€A99ã€TEMP-IN'],
        ['å…¬å¸', 'æ˜¯', 'å´‡æ–‡ æˆ– å…«æ–¹', 'å´‡æ–‡'],
        ['å“è™Ÿ', 'æ˜¯', 'ERP å“è™Ÿ', 'BC16118T'],
        ['å“å', 'æ˜¯', 'ç”¢å“åç¨±', 'ç†Ÿç™½è¦'],
        ['è¦æ ¼', 'å¦', 'ç”¢å“è¦æ ¼', '16/20*1.1KG*8ç›’'],
        ['æ•¸é‡', 'æ˜¯', 'åº«å­˜æ•¸é‡', '30'],
        ['å–®ä½', 'å¦', 'è¨ˆé‡å–®ä½', 'ç®±'],
        ['æ‰¹è™Ÿ', 'å¦', 'ç”Ÿç”¢æ‰¹è™Ÿ', '20241201'],
        ['æ•ˆæœŸ', 'å¦', 'æœ‰æ•ˆæœŸé™', '2025/06/30'],
        ['', '', '', ''],
        ['ã€è™›æ“¬å„²ä½èªªæ˜ã€‘', '', '', ''],
        ['A00~D00', '', 'è²¨æ¶å‰ç«¯æš«æ”¾å€', ''],
        ['A99~D99', '', 'è²¨æ¶æœ«ç«¯æš«æ”¾å€', ''],
        ['TEMP-IN', '', 'é€²è²¨æš«å­˜å€', ''],
        ['TEMP-OUT', '', 'å‡ºè²¨æš«å­˜å€', ''],
        ['OTHER', '', 'å…¶ä»–ä½ç½®', ''],
    ];
    const ws2 = XLSX.utils.aoa_to_sheet(instructionData);
    ws2['!cols'] = [{ wch: 15 }, { wch: 8 }, { wch: 35 }, { wch: 25 }];
    XLSX.utils.book_append_sheet(wb, ws2, 'æ¬„ä½èªªæ˜');

    XLSX.writeFile(wb, 'åº«å­˜åŒ¯å…¥ç¯„æœ¬.xlsx');
    showNotification('âœ… å·²ä¸‹è¼‰åŒ¯å…¥ç¯„æœ¬', 'success');
}

function handleImportDragOver(e) {
    e.preventDefault();
    e.currentTarget.classList.add('border-amber-500', 'bg-amber-900/20');
}

function handleImportDragLeave(e) {
    e.currentTarget.classList.remove('border-amber-500', 'bg-amber-900/20');
}

function handleImportDrop(e) {
    e.preventDefault();
    e.currentTarget.classList.remove('border-amber-500', 'bg-amber-900/20');
    const files = e.dataTransfer.files;
    if (files.length > 0) processImportFile(files[0]);
}

function handleImportFileSelect(e) {
    const file = e.target.files[0];
    if (file) processImportFile(file);
    e.target.value = '';
}

async function processImportFile(file) {
    if (!file.name.match(/\.(xlsx|xls)$/i)) {
        showNotification('âŒ è«‹ä¸Šå‚³ Excel æª”æ¡ˆ', 'error');
        return;
    }

    showNotification('ğŸ“– æ­£åœ¨è®€å–æª”æ¡ˆ...', 'info');

    const reader = new FileReader();
    reader.onload = async function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(firstSheet, { defval: '' });

            if (jsonData.length === 0) {
                showNotification('âŒ Excel æª”æ¡ˆæ²’æœ‰è³‡æ–™', 'error');
                return;
            }

            await validateAndPreviewData(jsonData);
        } catch (err) {
            console.error('è®€å– Excel éŒ¯èª¤:', err);
            showNotification('âŒ è®€å–æª”æ¡ˆå¤±æ•—ï¼š' + err.message, 'error');
        }
    };
    reader.readAsArrayBuffer(file);
}

async function validateAndPreviewData(jsonData) {
    importPreviewData = [];
    importStats = { total: 0, valid: 0, invalid: 0, duplicate: 0 };

    const existingLocations = new Set();
    const existingPallets = new Set();

    try {
        const locSnap = await db.collection('locations').get();
        locSnap.forEach(doc => existingLocations.add(doc.id));

        const palletSnap = await db.collection('pallets').get();
        palletSnap.forEach(doc => {
            const d = doc.data();
            existingPallets.add(`${d.locationId}|${d.productName}|${d.spec || ''}|${d.quantity}`);
        });
    } catch (err) {
        console.error('è¼‰å…¥ç¾æœ‰è³‡æ–™éŒ¯èª¤:', err);
    }

    const fieldMappings = {
        location: ['å„²ä½', 'å„²ä½*', 'location', 'Location'],
        company: ['å…¬å¸', 'å…¬å¸*', 'company', 'Company'],
        productId: ['å“è™Ÿ', 'å“è™Ÿ*', 'productId', 'SKU'],
        productName: ['å“å', 'å“å*', 'productName', 'åç¨±'],
        spec: ['è¦æ ¼', 'spec', 'Spec'],
        quantity: ['æ•¸é‡', 'æ•¸é‡*', 'quantity', 'QTY'],
        unit: ['å–®ä½', 'unit', 'Unit'],
        batchNo: ['æ‰¹è™Ÿ', 'batchNo', 'batch'],
        expiryDate: ['æ•ˆæœŸ', 'expiryDate', 'æœ‰æ•ˆæœŸé™']
    };

    function findField(row, fieldNames) {
        for (const name of fieldNames) {
            if (row.hasOwnProperty(name) && row[name] !== '') return row[name];
        }
        return '';
    }

    jsonData.forEach((row, index) => {
        const record = {
            rowNum: index + 2,
            location: String(findField(row, fieldMappings.location)).trim(),
            company: String(findField(row, fieldMappings.company)).trim(),
            productId: String(findField(row, fieldMappings.productId)).trim(),
            productName: String(findField(row, fieldMappings.productName)).trim(),
            spec: String(findField(row, fieldMappings.spec)).trim(),
            quantity: parseFloat(findField(row, fieldMappings.quantity)) || 0,
            unit: String(findField(row, fieldMappings.unit)).trim() || 'ä»¶',
            batchNo: String(findField(row, fieldMappings.batchNo)).trim(),
            expiryDate: String(findField(row, fieldMappings.expiryDate)).trim(),
            errors: [],
            status: 'valid'
        };

        if (!record.location) record.errors.push('å„²ä½å¿…å¡«');
        if (!record.company) record.errors.push('å…¬å¸å¿…å¡«');
        else if (!['å´‡æ–‡', 'å…«æ–¹'].includes(record.company)) record.errors.push('å…¬å¸é ˆç‚ºã€Œå´‡æ–‡ã€æˆ–ã€Œå…«æ–¹ã€');
        if (!record.productId && !record.productName) record.errors.push('å“è™Ÿæˆ–å“åè‡³å°‘å¡«ä¸€å€‹');
        if (!record.quantity || record.quantity <= 0) record.errors.push('æ•¸é‡é ˆå¤§æ–¼0');

        const isVirtualLocation = VIRTUAL_LOCATIONS.includes(record.location);
        const locationExists = existingLocations.has(record.location);
        if (!isVirtualLocation && !locationExists) {
            const createLocation = document.getElementById('import-opt-create-location')?.checked ?? true;
            if (createLocation) record.newLocation = true;
            else record.errors.push('å„²ä½ä¸å­˜åœ¨');
        }

        const duplicateKey = `${record.location}|${record.productName}|${record.spec}|${record.quantity}`;
        if (existingPallets.has(duplicateKey)) {
            record.isDuplicate = true;
            const skipDuplicate = document.getElementById('import-opt-skip-duplicate')?.checked ?? true;
            if (skipDuplicate) record.status = 'duplicate';
        }

        if (record.errors.length > 0) {
            record.status = 'invalid';
            importStats.invalid++;
        } else if (record.status === 'duplicate') {
            importStats.duplicate++;
        } else {
            importStats.valid++;
        }

        importStats.total++;
        importPreviewData.push(record);
    });

    renderImportPreview();

    document.getElementById('import-total').textContent = importStats.total;
    document.getElementById('import-valid').textContent = importStats.valid;
    document.getElementById('import-invalid').textContent = importStats.invalid;
    document.getElementById('import-duplicate').textContent = importStats.duplicate;
    document.getElementById('import-stats').textContent = `å·²è¼‰å…¥ ${importStats.total} ç­†ï¼Œ${importStats.valid} ç­†å¯åŒ¯å…¥`;

    const btnImport = document.getElementById('btn-execute-import');
    if (btnImport) btnImport.disabled = importStats.valid === 0;

    showNotification(`âœ… å·²è¼‰å…¥ ${importStats.total} ç­†è³‡æ–™`, 'success');
}

function renderImportPreview() {
    const tbody = document.getElementById('import-preview-body');
    if (!tbody) return;

    if (importPreviewData.length === 0) {
        tbody.innerHTML = `<tr><td colspan="11" class="text-center text-slate-500 py-10">
            <i class="fa-solid fa-file-excel text-4xl text-slate-600 mb-3 block"></i>
            <p>è«‹ä¸Šå‚³ Excel æª”æ¡ˆ</p>
        </td></tr>`;
        return;
    }

    let html = '';
    importPreviewData.forEach((record) => {
        const statusIcon = record.status === 'valid'
            ? '<span class="text-emerald-400">âœ“</span>'
            : record.status === 'duplicate'
                ? '<span class="text-yellow-400">âš </span>'
                : '<span class="text-red-400">âœ—</span>';

        const rowClass = record.status === 'invalid'
            ? 'bg-red-900/20' : record.status === 'duplicate' ? 'bg-yellow-900/20' : '';

        const errorTooltip = record.errors.length > 0 ? `title="${record.errors.join(', ')}"` : '';
        const newLocationBadge = record.newLocation ? '<span class="ml-1 text-[10px] px-1 bg-blue-600 rounded">æ–°</span>' : '';

        html += `
            <tr class="${rowClass}" ${errorTooltip}>
                <td class="text-center text-slate-500">${record.rowNum}</td>
                <td class="text-center">${statusIcon}</td>
                <td class="font-mono">${record.location}${newLocationBadge}</td>
                <td><span class="px-1.5 py-0.5 rounded text-xs ${record.company === 'å´‡æ–‡' ? 'bg-blue-600' : 'bg-emerald-600'}">${record.company}</span></td>
                <td class="font-mono text-xs">${record.productId}</td>
                <td>${record.productName}</td>
                <td class="text-xs text-slate-400">${record.spec}</td>
                <td class="text-right font-bold">${record.quantity}</td>
                <td class="text-slate-400">${record.unit}</td>
                <td class="font-mono text-xs">${record.batchNo}</td>
                <td class="text-xs">${record.expiryDate}</td>
            </tr>
        `;
    });

    tbody.innerHTML = html;
}

async function executeImport() {
    const validRecords = importPreviewData.filter(r => r.status === 'valid');

    if (validRecords.length === 0) {
        showNotification('âŒ æ²’æœ‰å¯åŒ¯å…¥çš„è³‡æ–™', 'error');
        return;
    }

    if (!confirm(`ç¢ºå®šè¦åŒ¯å…¥ ${validRecords.length} ç­†è³‡æ–™å—ï¼Ÿ\n\næ­¤æ“ä½œæœƒæ–°å¢æ£§æ¿åˆ°åº«å­˜ä¸­ã€‚`)) return;

    const btnImport = document.getElementById('btn-execute-import');
    if (btnImport) {
        btnImport.disabled = true;
        btnImport.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-1"></i>åŒ¯å…¥ä¸­...';
    }

    let successCount = 0;
    const batch = db.batch();
    const newLocations = new Set();
    const timestamp = firebase.firestore.FieldValue.serverTimestamp();

    try {
        for (const record of validRecords) {
            if (record.newLocation && !newLocations.has(record.location)) {
                const isVirtual = VIRTUAL_LOCATIONS.includes(record.location);
                const locRef = db.collection('locations').doc(record.location);
                batch.set(locRef, {
                    locationId: record.location,
                    zone: record.location.charAt(0),
                    type: isVirtual ? 'virtual' : 'standard',
                    status: 'available',
                    capacity: isVirtual ? 99 : 2,
                    currentLoad: 0,
                    createdAt: timestamp,
                    note: isVirtual ? 'è™›æ“¬å„²ä½' : 'åŒ¯å…¥æ™‚è‡ªå‹•å»ºç«‹'
                });
                newLocations.add(record.location);
            }

            const palletId = 'P' + Date.now().toString(36).toUpperCase() + Math.random().toString(36).substring(2, 6).toUpperCase();
            const palletRef = db.collection('pallets').doc(palletId);

            let expiryDate = null;
            if (record.expiryDate) {
                const dateParts = record.expiryDate.replace(/\//g, '-').split('-');
                if (dateParts.length === 3) {
                    expiryDate = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]);
                }
            }

            batch.set(palletRef, {
                palletId: palletId,
                company: record.company,
                productId: record.productId,
                productName: record.productName,
                spec: record.spec,
                quantity: record.quantity,
                unit: record.unit,
                locationId: record.location,
                batchNo: record.batchNo,
                expiryDate: expiryDate ? firebase.firestore.Timestamp.fromDate(expiryDate) : null,
                status: 'stored',
                createdAt: timestamp,
                source: 'excel-import'
            });

            const logRef = db.collection('inventoryLogs').doc();
            batch.set(logRef, {
                type: 'import',
                palletId: palletId,
                company: record.company,
                productId: record.productId,
                productName: record.productName,
                quantity: record.quantity,
                locationId: record.location,
                operator: window.currentUser?.email || 'system',
                remark: 'Excel æ‰¹æ¬¡åŒ¯å…¥',
                createdAt: timestamp
            });

            successCount++;
        }

        await batch.commit();
        showNotification(`âœ… æˆåŠŸåŒ¯å…¥ ${successCount} ç­†è³‡æ–™`, 'success');

        importPreviewData = [];
        renderImportPreview();
        document.getElementById('import-total').textContent = '0';
        document.getElementById('import-valid').textContent = '0';
        document.getElementById('import-invalid').textContent = '0';
        document.getElementById('import-duplicate').textContent = '0';
        document.getElementById('import-stats').textContent = 'åŒ¯å…¥å®Œæˆï¼';

        if (typeof refreshVisualMap === 'function') refreshVisualMap();
        loadVirtualLocationCounts();

    } catch (err) {
        console.error('åŒ¯å…¥éŒ¯èª¤:', err);
        showNotification('âŒ åŒ¯å…¥å¤±æ•—ï¼š' + err.message, 'error');
    } finally {
        if (btnImport) {
            btnImport.disabled = false;
            btnImport.innerHTML = '<i class="fa-solid fa-database mr-1"></i>åŸ·è¡ŒåŒ¯å…¥';
        }
    }
}

console.log('ğŸ“¥ åº«å­˜åŒ¯å…¥åŠŸèƒ½å·²è¼‰å…¥');

// ========== å€‰ç§Ÿç®¡ç†æ¨¡çµ„ ==========

window.rentalSettings = {
    chargeOwnStock: {
        chungwen: false,
        bafang: false,
        effectiveDate: null
    },
    storageRate: {
        bafang: 22,
        chungwen: {
            tier1Max: 300,
            tier1Rate: 22,
            tier2Rate: 20
        }
    },
    handlingFee: {
        inbound: 200,
        outbound: 0
    },
    tempZone: {
        freeHours: 4
    },
    settlement: {
        settleDay: 25,
        freeUntilDay: 25
    }
};

window.consignmentData = [];

window.loadRentalSettingsFromFirebase = async function() {
    try {
        if (!window.db || !window.getDoc) {
            console.log('Firebase å°šæœªåˆå§‹åŒ–ï¼Œä½¿ç”¨ localStorage');
            var stored = localStorage.getItem('wms_rental_settings');
            if (stored) window.rentalSettings = JSON.parse(stored);
            loadRentalSettingsUI();
            return;
        }

        var docRef = window.doc(window.db, 'settings', 'rentalSettings');
        var docSnap = await window.getDoc(docRef);

        if (docSnap.exists()) {
            window.rentalSettings = docSnap.data();
            console.log('å€‰ç§Ÿè¨­å®šå·²å¾ Firebase è¼‰å…¥');
        }

        localStorage.setItem('wms_rental_settings', JSON.stringify(window.rentalSettings));

        loadRentalSettingsUI();
    } catch(e) {
        console.error('è¼‰å…¥å€‰ç§Ÿè¨­å®šå¤±æ•—:', e);
        var stored = localStorage.getItem('wms_rental_settings');
        if (stored) window.rentalSettings = JSON.parse(stored);
        loadRentalSettingsUI();
    }
};

window.loadConsignmentsFromFirebase = async function() {
    try {
        if (!window.db || !window.getDocs) {
            console.log('Firebase å°šæœªåˆå§‹åŒ–ï¼Œä½¿ç”¨ localStorage');
            window.consignmentData = JSON.parse(localStorage.getItem('wms_consignments') || '[]');
            loadConsignmentList();
            return;
        }

        var snapshot = await window.getDocs(window.collection(window.db, 'consignments'));
        window.consignmentData = [];
        snapshot.forEach(function(doc) {
            window.consignmentData.push({ id: doc.id, ...doc.data() });
        });

        console.log('å¯„å€‰è³‡æ–™å·²è¼‰å…¥:', window.consignmentData.length, 'ç­†');

        localStorage.setItem('wms_consignments', JSON.stringify(window.consignmentData));

        loadConsignmentList();
    } catch(e) {
        console.error('è¼‰å…¥å¯„å€‰è³‡æ–™å¤±æ•—:', e);
        window.consignmentData = JSON.parse(localStorage.getItem('wms_consignments') || '[]');
        loadConsignmentList();
    }
};

window.saveRentalSettingsToFirebase = async function() {
    try {
        if (window.db && window.setDoc) {
            var docRef = window.doc(window.db, 'settings', 'rentalSettings');
            await window.setDoc(docRef, window.rentalSettings);
            console.log('å€‰ç§Ÿè¨­å®šå·²å„²å­˜åˆ° Firebase');
        }
        localStorage.setItem('wms_rental_settings', JSON.stringify(window.rentalSettings));
    } catch(e) {
        console.error('å„²å­˜å€‰ç§Ÿè¨­å®šå¤±æ•—:', e);
        localStorage.setItem('wms_rental_settings', JSON.stringify(window.rentalSettings));
    }
};

window.saveConsignmentToFirebase = async function(consignment) {
    try {
        if (window.db && window.addDoc) {
            var docRef = await window.addDoc(window.collection(window.db, 'consignments'), consignment);
            consignment.id = docRef.id;
            console.log('å¯„å€‰è³‡æ–™å·²å„²å­˜åˆ° Firebase');
        }
        window.consignmentData.push(consignment);
        localStorage.setItem('wms_consignments', JSON.stringify(window.consignmentData));
        return consignment;
    } catch(e) {
        console.error('å„²å­˜å¯„å€‰è³‡æ–™å¤±æ•—:', e);
        window.consignmentData.push(consignment);
        localStorage.setItem('wms_consignments', JSON.stringify(window.consignmentData));
        return consignment;
    }
};

window.updateConsignmentInFirebase = async function(id, data) {
    try {
        if (window.db && window.updateDoc) {
            await window.updateDoc(window.doc(window.db, 'consignments', id), data);
        }
        var idx = window.consignmentData.findIndex(function(c) { return c.id === id; });
        if (idx >= 0) {
            Object.assign(window.consignmentData[idx], data);
        }
        localStorage.setItem('wms_consignments', JSON.stringify(window.consignmentData));
    } catch(e) {
        console.error('æ›´æ–°å¯„å€‰è³‡æ–™å¤±æ•—:', e);
    }
};

window.deleteConsignmentFromFirebase = async function(id) {
    try {
        if (window.db && window.deleteDoc) {
            await window.deleteDoc(window.doc(window.db, 'consignments', id));
        }
        window.consignmentData = window.consignmentData.filter(function(c) { return c.id !== id; });
        localStorage.setItem('wms_consignments', JSON.stringify(window.consignmentData));
    } catch(e) {
        console.error('åˆªé™¤å¯„å€‰è³‡æ–™å¤±æ•—:', e);
    }
};

window.updateRentalSettings = function() {
    window.rentalSettings.chargeOwnStock.chungwen = document.querySelector('input[name="charge-cw"]:checked')?.value === 'yes';
    window.rentalSettings.chargeOwnStock.bafang = document.querySelector('input[name="charge-bf"]:checked')?.value === 'yes';
    window.rentalSettings.chargeOwnStock.effectiveDate = document.getElementById('charge-effective-date')?.value || null;

    window.rentalSettings.storageRate.bafang = parseInt(document.getElementById('rate-bf-normal')?.value) || 22;
    window.rentalSettings.storageRate.chungwen.tier1Max = parseInt(document.getElementById('rate-cw-tier1-max')?.value) || 300;
    window.rentalSettings.storageRate.chungwen.tier1Rate = parseInt(document.getElementById('rate-cw-tier1')?.value) || 22;
    window.rentalSettings.storageRate.chungwen.tier2Rate = parseInt(document.getElementById('rate-cw-tier2')?.value) || 20;

    window.rentalSettings.handlingFee.inbound = parseInt(document.getElementById('fee-inbound')?.value) || 200;
    window.rentalSettings.handlingFee.outbound = parseInt(document.getElementById('fee-outbound')?.value) || 0;

    window.rentalSettings.tempZone.freeHours = parseInt(document.getElementById('temp-free-hours')?.value) || 4;

    window.rentalSettings.settlement.settleDay = parseInt(document.getElementById('settle-day')?.value) || 25;
    window.rentalSettings.settlement.freeUntilDay = parseInt(document.getElementById('free-until-day')?.value) || 25;
};

window.saveRentalSettings = async function() {
    updateRentalSettings();
    await saveRentalSettingsToFirebase();
    showNotification('âœ… è²»ç‡è¨­å®šå·²å„²å­˜', 'success');
};

window.loadRentalSettingsUI = function() {
    const s = window.rentalSettings;

    const cwRadio = document.querySelector(`input[name="charge-cw"][value="${s.chargeOwnStock.chungwen ? 'yes' : 'no'}"]`);
    if (cwRadio) cwRadio.checked = true;
    const bfRadio = document.querySelector(`input[name="charge-bf"][value="${s.chargeOwnStock.bafang ? 'yes' : 'no'}"]`);
    if (bfRadio) bfRadio.checked = true;
    if (document.getElementById('charge-effective-date')) {
        document.getElementById('charge-effective-date').value = s.chargeOwnStock.effectiveDate || '';
    }

    if (document.getElementById('rate-bf-normal')) document.getElementById('rate-bf-normal').value = s.storageRate.bafang;
    if (document.getElementById('rate-cw-tier1-max')) document.getElementById('rate-cw-tier1-max').value = s.storageRate.chungwen.tier1Max;
    if (document.getElementById('rate-cw-tier1')) document.getElementById('rate-cw-tier1').value = s.storageRate.chungwen.tier1Rate;
    if (document.getElementById('rate-cw-tier2')) document.getElementById('rate-cw-tier2').value = s.storageRate.chungwen.tier2Rate;

    if (document.getElementById('fee-inbound')) document.getElementById('fee-inbound').value = s.handlingFee.inbound;
    if (document.getElementById('fee-outbound')) document.getElementById('fee-outbound').value = s.handlingFee.outbound;

    if (document.getElementById('temp-free-hours')) document.getElementById('temp-free-hours').value = s.tempZone.freeHours;

    if (document.getElementById('settle-day')) document.getElementById('settle-day').value = s.settlement.settleDay;
    if (document.getElementById('free-until-day')) document.getElementById('free-until-day').value = s.settlement.freeUntilDay;
};

window.getStorageRate = function(company, palletCount) {
    const s = window.rentalSettings.storageRate;
    if (company === 'å…«æ–¹') {
        return s.bafang;
    } else {
        if (palletCount > s.chungwen.tier1Max) {
            return s.chungwen.tier2Rate;
        }
        return s.chungwen.tier1Rate;
    }
};

window.getConsignmentRate = function(company, palletCount, unitsPerPallet) {
    const ratePerPallet = getStorageRate(company, palletCount);
    return ratePerPallet / unitsPerPallet;
};

window.openNewConsignmentModal = async function() {
    const today = new Date();
    const freeUntilDay = window.rentalSettings.settlement.freeUntilDay;
    let freeUntil = new Date(today.getFullYear(), today.getMonth(), freeUntilDay);
    if (today.getDate() > freeUntilDay) {
        freeUntil = new Date(today.getFullYear(), today.getMonth() + 1, freeUntilDay);
    }
    const freeUntilStr = freeUntil.toISOString().split('T')[0];
    const todayStr = today.toISOString().split('T')[0];

    const consignWarehouseOptions = getConsignWarehouseOptions();

    const content = `
        <div class="flex gap-4" style="height: 520px;">
            <!-- å·¦å´ï¼šåŸºæœ¬è³‡è¨Š + å·²é¸å“é … -->
            <div class="w-72 flex flex-col">
                <!-- åŸºæœ¬è³‡è¨Š -->
                <div class="bg-slate-800 rounded-lg p-3 mb-3">
                    <div class="text-sm text-amber-400 font-bold mb-2"><i class="fa-solid fa-user mr-1"></i>å®¢æˆ¶è³‡è¨Š</div>
                    <div class="space-y-2">
                        <div>
                            <input type="text" id="consign-customer" class="scan-input w-full" placeholder="è¼¸å…¥å®¢æˆ¶åç¨±..." oninput="onConsignCustomerInput()">
                        </div>
                        <div>
                            <label class="text-[10px] text-slate-500">å¯„åº«å€‰</label>
                            <div class="flex gap-1">
                                <select id="consign-target-warehouse" class="scan-input flex-1 text-sm">
                                    <option value="">-- é¸æ“‡ --</option>
                                    ${consignWarehouseOptions}
                                </select>
                                <button onclick="addNewConsignWarehouse()" class="px-2 bg-slate-700 hover:bg-slate-600 text-white rounded text-xs" title="æ–°å¢">
                                    <i class="fa-solid fa-plus"></i>
                                </button>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="text-[10px] text-slate-500">å¯„å€‰æ—¥</label>
                                <input type="date" id="consign-date" class="scan-input text-sm py-1" value="${todayStr}">
                            </div>
                            <div>
                                <label class="text-[10px] text-slate-500">å…è²»è‡³</label>
                                <input type="date" id="consign-free-until" class="scan-input text-sm py-1" value="${freeUntilStr}">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å·²é¸æ“‡å“é … -->
                <div class="bg-slate-800 rounded-lg p-3 flex-1 flex flex-col">
                    <div class="flex justify-between items-center mb-2">
                        <div class="text-sm text-emerald-400 font-bold"><i class="fa-solid fa-cart-shopping mr-1"></i>å·²é¸æ“‡</div>
                        <div class="text-xs text-slate-500" id="consign-selected-summary">0 å“é …</div>
                    </div>
                    <div id="consign-selected-list" class="flex-1 overflow-y-auto space-y-1">
                        <div class="text-slate-500 text-sm text-center py-8">
                            <i class="fa-solid fa-arrow-right text-2xl mb-2 block opacity-30"></i>
                            å¾å³å´é¸æ“‡å“é …
                        </div>
                    </div>
                    <div class="border-t border-slate-700 pt-2 mt-2">
                        <div class="flex justify-between text-sm">
                            <span class="text-slate-400">åˆè¨ˆ</span>
                            <span class="text-white font-bold" id="consign-total-qty">0 ä»¶</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³å´ï¼šåº«å­˜æ¸…å–® -->
            <div class="flex-1 flex flex-col bg-slate-800 rounded-lg p-3">
                <!-- æœå°‹åˆ— + ç¢ºèªæŒ‰éˆ• -->
                <div class="flex gap-2 mb-2">
                    <div class="relative flex-1">
                        <i class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-500"></i>
                        <input type="text" id="consign-search-input" class="scan-input w-full pl-9" placeholder="æœå°‹å“åã€è¦æ ¼ã€æ‰¹è™Ÿ..." oninput="filterConsignInventory()">
                    </div>
                    <select id="consign-warehouse-filter" class="scan-input w-36" onchange="filterConsignInventory()">
                        <option value="">å…¨éƒ¨å€‰åº«</option>
                    </select>
                    <button onclick="saveConsignmentFromSelection()" class="px-6 py-2 bg-amber-600 hover:bg-amber-500 text-white rounded-lg font-bold whitespace-nowrap">
                        <i class="fa-solid fa-check mr-1"></i>ç¢ºèªå¯„å€‰
                    </button>
                </div>

                <!-- åº«å­˜è¡¨æ ¼ -->
                <div class="flex-1 overflow-y-auto" id="consign-inventory-container">
                    <div class="text-slate-500 text-center py-10">
                        <i class="fa-solid fa-spinner fa-spin text-2xl mb-2 block"></i>
                        è¼‰å…¥åº«å­˜ä¸­...
                    </div>
                </div>

                <div class="text-[10px] text-slate-500 mt-2 text-center">
                    ğŸ’¡ è¼¸å…¥æ•¸é‡å¾ŒæŒ‰ Enter æˆ–é»æ“Š + åŠ å…¥
                </div>
            </div>
        </div>
    `;

    WMS.createModal('consignment-modal', {
        title: 'æ–°å¢å®¢æˆ¶å¯„å€‰',
        icon: 'fa-solid fa-box-archive text-amber-400',
        content: content,
        width: '900px'
    });

    window.consignSelectedItems = [];

    await loadConsignInventoryList();
};

window.warehouseConfig = {
    internal: [
        'å´‡æ–‡_æˆå“', 'å´‡æ–‡_åŸæ–™', 'å´‡æ–‡_ç™½è¦', 'å´‡æ–‡_åŠæˆå“åº«', 'å´‡æ–‡_é€€è²¨åº«',
        'å…«æ–¹_æˆå“', 'å…«æ–¹_åŸæ–™', 'å…«æ–¹_ç™½è¦'
    ],
    external: [
        'å´‡æ–‡_æ´½é€š', 'å´‡æ–‡_æœ‰èˆˆ', 'å´‡æ–‡_å“é †', 'å´‡æ–‡_å¯Œå´', 'å´‡æ–‡_æ™¯å±±1è™Ÿ', 'å´‡æ–‡_æ™¯å±±2è™Ÿ',
        'å…«æ–¹_æ´½é€š', 'å…«æ–¹_æœ‰èˆˆ', 'å…«æ–¹_å“é †', 'å…«æ–¹_å¯Œå´', 'å…«æ–¹_æ™¯å±±1è™Ÿ',
        'å¼µæ˜¥æ¢…_æœ‰èˆˆ', 'å¼µæ˜¥æ¢…_åŸæ–™', 'å¼µæ˜¥æ¢…_æ™¯å±±1è™Ÿ',
        'å®¢æˆ¶ä»£å·¥å€‰', 'è²¨å“æš«å­˜åº«'
    ],
    consign: [
        '(æƒ æ•)å®¢æˆ¶å¯„åº«å€‰', 'å´‡æ–‡(æƒ -å¸ƒè¢‹)å®¢æˆ¶å¯„åº«å€‰', 'å´‡æ–‡(æ¥­å‹™)å®¢æˆ¶å¯„åº«å€‰',
        'å´‡æ–‡_å¯„åº«å€‰', 'PCHOMEå¯„å€‰'
    ]
};

function getConsignWarehouseOptions() {
    const config = window.warehouseConfig;
    let html = '';
    config.consign.forEach(w => {
        html += `<option value="${w}">${w}</option>`;
    });
    return html;
}

window.consignSelectedItems = [];

window.consignInventoryData = [];

window.onConsignCustomerInput = function() {
    const customer = document.getElementById('consign-customer')?.value.trim();
    const targetSelect = document.getElementById('consign-target-warehouse');

    if (!customer || !targetSelect) return;

    const config = window.warehouseConfig;
    const matching = config.consign.find(w => w.includes(customer));

    if (matching) {
        targetSelect.value = matching;
    }
};

window.addNewConsignWarehouse = function() {
    const customer = document.getElementById('consign-customer')?.value.trim();
    const name = prompt('è«‹è¼¸å…¥æ–°å¯„åº«å€‰åç¨±ï¼š', customer ? `(${customer})å®¢æˆ¶å¯„åº«å€‰` : '');

    if (!name) return;

    window.warehouseConfig.consign.push(name);

    const targetSelect = document.getElementById('consign-target-warehouse');
    if (targetSelect) {
        const option = document.createElement('option');
        option.value = name;
        option.textContent = name;
        targetSelect.appendChild(option);
        targetSelect.value = name;
    }

    showNotification(`âœ… å·²æ–°å¢å¯„åº«å€‰ï¼š${name}`, 'success');
};

async function loadConsignInventoryList() {
    const container = document.getElementById('consign-inventory-container');
    const warehouseFilter = document.getElementById('consign-warehouse-filter');

    try {
        const inventory = window.currentInventory ? window.currentInventory() : [];

        const validItems = inventory.filter(p => {
            if (!p.productName) return false;
            if (p.quantity <= 0) return false;
            const status = (p.status || '').toLowerCase();
            if (status === 'shipped' || status === 'outbound' || status === 'deleted') return false;
            return true;
        });

        const consignedMap = {};
        window.consignmentData.forEach(c => {
            if (c.status !== 'active') return;
            const key = `${c.productName}|${c.spec}|${c.batchNo}`;
            consignedMap[key] = (consignedMap[key] || 0) + c.remainingQty;
        });

        validItems.forEach(item => {
            const key = `${item.productName}|${item.spec}|${item.batchNo}`;
            const consigned = consignedMap[key] || 0;
            item.consigned = consigned;
            item.available = Math.max(0, item.quantity - consigned);

            const warehouse = item.warehouse || item.company || '';
            item.warehouseName = warehouse;
            item.isInternal = window.warehouseConfig.internal.some(w => warehouse.includes(w) || w.includes(warehouse));
        });

        window.consignInventoryData = validItems;

        const warehouses = new Set();
        validItems.forEach(item => {
            if (item.warehouseName) warehouses.add(item.warehouseName);
        });

        let filterHtml = '<option value="">å…¨éƒ¨å€‰åº«</option>';
        Array.from(warehouses).sort().forEach(w => {
            filterHtml += `<option value="${w}">${w}</option>`;
        });
        warehouseFilter.innerHTML = filterHtml;

        renderConsignInventory(validItems);

    } catch (err) {
        console.error('è¼‰å…¥åº«å­˜å¤±æ•—:', err);
        container.innerHTML = '<div class="text-red-400 text-center py-10">è¼‰å…¥å¤±æ•—</div>';
    }
}

function renderConsignInventory(items) {
    const container = document.getElementById('consign-inventory-container');

    if (items.length === 0) {
        container.innerHTML = '<div class="text-slate-500 text-center py-10">ç„¡ç¬¦åˆæ¢ä»¶çš„åº«å­˜</div>';
        return;
    }

    const groupedByWarehouse = {};
    items.forEach(item => {
        const wh = item.warehouseName || 'æœªåˆ†é¡';
        if (!groupedByWarehouse[wh]) groupedByWarehouse[wh] = [];
        groupedByWarehouse[wh].push(item);
    });

    let html = '';

    Object.keys(groupedByWarehouse).sort().forEach(warehouse => {
        const warehouseItems = groupedByWarehouse[warehouse];
        const isInternal = warehouseItems[0]?.isInternal;
        const whClass = isInternal ? 'bg-blue-600' : 'bg-purple-600';
        const whIcon = isInternal ? 'fa-warehouse' : 'fa-building';

        html += `
            <div class="mb-3">
                <div class="flex items-center gap-2 mb-1 sticky top-0 bg-slate-800 py-1 z-10">
                    <span class="px-2 py-0.5 ${whClass} rounded text-[10px]"><i class="fa-solid ${whIcon} mr-1"></i>${warehouse}</span>
                    <span class="text-[10px] text-slate-500">${warehouseItems.length} é …</span>
                </div>
                <div class="space-y-1">
        `;

        warehouseItems.forEach((item, idx) => {
            const itemId = `inv-${warehouse.replace(/[^a-zA-Z0-9]/g, '')}-${idx}`;
            const isSelected = window.consignSelectedItems.some(s =>
                s.palletId === (item.palletId || item.id) && s.batchNo === item.batchNo
            );
            const availableClass = item.available > 0 ? 'text-emerald-400' : 'text-red-400';
            const rowClass = isSelected ? 'bg-emerald-900/40 border-emerald-500' : 'bg-slate-700/50 border-slate-600';
            const disabled = item.available <= 0;

            html += `
                <div class="flex items-center gap-2 p-2 rounded border ${rowClass} ${disabled ? 'opacity-50' : 'hover:bg-slate-700'}" id="row-${itemId}">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2">
                            <span class="text-white font-medium truncate">${item.productName}</span>
                            <span class="text-slate-400 text-xs">${item.spec || ''}</span>
                        </div>
                        <div class="flex items-center gap-3 text-[10px] text-slate-500 mt-0.5">
                            <span><i class="fa-solid fa-barcode mr-1"></i>${item.batchNo || '-'}</span>
                            ${item.locationId ? `<span><i class="fa-solid fa-location-dot mr-1"></i>${item.locationId}</span>` : ''}
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-white text-sm">${item.quantity}<span class="text-slate-500 text-[10px] ml-0.5">ä»¶</span></div>
                        ${item.consigned > 0 ? `<div class="text-amber-400 text-[10px]">å·²å¯„${item.consigned}</div>` : ''}
                    </div>
                    <div class="text-right w-14">
                        <div class="${availableClass} font-bold">${item.available}</div>
                        <div class="text-[10px] text-slate-500">å¯å¯„</div>
                    </div>
                    <div class="flex items-center gap-1">
                        <input type="number"
                            id="qty-${itemId}"
                            class="scan-input w-16 py-1 text-center text-sm ${disabled ? 'opacity-50' : ''}"
                            min="1"
                            max="${item.available}"
                            placeholder="æ•¸é‡"
                            ${disabled ? 'disabled' : ''}
                            onkeydown="if(event.key==='Enter'){addConsignItem('${itemId}', this, ${JSON.stringify(item).replace(/"/g, '&quot;')})}"
                        >
                        <button
                            onclick="addConsignItem('${itemId}', document.getElementById('qty-${itemId}'), ${JSON.stringify(item).replace(/"/g, '&quot;')})"
                            class="px-2 py-1 ${disabled ? 'bg-slate-700 text-slate-500' : 'bg-emerald-600 hover:bg-emerald-500 text-white'} rounded"
                            ${disabled ? 'disabled' : ''}
                        >
                            <i class="fa-solid fa-plus"></i>
                        </button>
                    </div>
                </div>
            `;
        });

        html += '</div></div>';
    });

    container.innerHTML = html;
}

window.filterConsignInventory = function() {
    const searchText = (document.getElementById('consign-search-input')?.value || '').toLowerCase();
    const warehouseFilter = document.getElementById('consign-warehouse-filter')?.value || '';

    let filtered = window.consignInventoryData;

    if (warehouseFilter) {
        filtered = filtered.filter(item => item.warehouseName === warehouseFilter);
    }

    if (searchText) {
        filtered = filtered.filter(item =>
            (item.productName || '').toLowerCase().includes(searchText) ||
            (item.spec || '').toLowerCase().includes(searchText) ||
            (item.batchNo || '').toLowerCase().includes(searchText) ||
            (item.locationId || '').toLowerCase().includes(searchText)
        );
    }

    renderConsignInventory(filtered);
};

window.addConsignItem = function(itemId, qtyInput, itemData) {
    const qty = parseInt(qtyInput?.value) || 0;

    if (qty <= 0) {
        qtyInput?.focus();
        return;
    }

    if (qty > itemData.available) {
        alert(`æ•¸é‡ä¸èƒ½è¶…éå¯å¯„æ•¸é‡ ${itemData.available}`);
        return;
    }

    const existingIdx = window.consignSelectedItems.findIndex(s =>
        s.palletId === (itemData.palletId || itemData.id) && s.batchNo === itemData.batchNo
    );

    if (existingIdx >= 0) {
        window.consignSelectedItems[existingIdx].qty = qty;
    } else {
        window.consignSelectedItems.push({
            palletId: itemData.palletId || itemData.id,
            productName: itemData.productName,
            spec: itemData.spec,
            batchNo: itemData.batchNo,
            locationId: itemData.locationId,
            warehouseName: itemData.warehouseName,
            isInternal: itemData.isInternal,
            stock: itemData.quantity,
            available: itemData.available,
            qty: qty
        });
    }

    if (qtyInput) qtyInput.value = '';

    updateConsignSelectedList();

    const row = document.getElementById(`row-${itemId}`);
    if (row) {
        row.classList.remove('bg-slate-700/50', 'border-slate-600');
        row.classList.add('bg-emerald-900/40', 'border-emerald-500');
    }
};

function updateConsignSelectedList() {
    const listDiv = document.getElementById('consign-selected-list');
    const summaryDiv = document.getElementById('consign-selected-summary');
    const totalDiv = document.getElementById('consign-total-qty');

    const items = window.consignSelectedItems;

    if (items.length === 0) {
        listDiv.innerHTML = `
            <div class="text-slate-500 text-sm text-center py-8">
                <i class="fa-solid fa-arrow-right text-2xl mb-2 block opacity-30"></i>
                å¾å³å´é¸æ“‡å“é …
            </div>
        `;
        summaryDiv.textContent = '0 å“é …';
        totalDiv.textContent = '0 ä»¶';
        return;
    }

    let html = '';
    let totalQty = 0;

    items.forEach((item, idx) => {
        totalQty += item.qty;
        const whClass = item.isInternal ? 'text-blue-400' : 'text-purple-400';

        html += `
            <div class="flex items-center gap-2 p-2 bg-slate-700/50 rounded group">
                <div class="flex-1 min-w-0">
                    <div class="text-white text-sm truncate">${item.productName}</div>
                    <div class="text-[10px] text-slate-500">${item.spec || ''} | ${item.batchNo || '-'}</div>
                    <div class="text-[10px] ${whClass}">${item.warehouseName}</div>
                </div>
                <div class="text-right">
                    <input type="number"
                        class="scan-input w-14 py-0.5 text-center text-sm"
                        value="${item.qty}"
                        min="1"
                        max="${item.available}"
                        onchange="updateConsignItemQty(${idx}, this.value)"
                    >
                </div>
                <button onclick="removeConsignItem(${idx})" class="opacity-0 group-hover:opacity-100 text-red-400 hover:text-red-300 px-1">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
        `;
    });

    listDiv.innerHTML = html;
    summaryDiv.textContent = `${items.length} å“é …`;
    totalDiv.textContent = `${totalQty.toLocaleString()} ä»¶`;
}

window.updateConsignItemQty = function(idx, value) {
    const qty = parseInt(value) || 0;
    const item = window.consignSelectedItems[idx];

    if (!item) return;

    if (qty <= 0) {
        removeConsignItem(idx);
        return;
    }

    if (qty > item.available) {
        alert(`æ•¸é‡ä¸èƒ½è¶…éå¯å¯„æ•¸é‡ ${item.available}`);
        return;
    }

    item.qty = qty;
    updateConsignSelectedList();
};

window.removeConsignItem = function(idx) {
    window.consignSelectedItems.splice(idx, 1);
    updateConsignSelectedList();
    filterConsignInventory(); // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°æ¨™è¨˜
};

window.saveConsignmentFromSelection = async function() {
    const customer = document.getElementById('consign-customer')?.value.trim();
    const targetWarehouse = document.getElementById('consign-target-warehouse')?.value;
    const consignDate = document.getElementById('consign-date')?.value;
    const freeUntil = document.getElementById('consign-free-until')?.value;

    if (!customer) { alert('è«‹è¼¸å…¥å®¢æˆ¶åç¨±'); return; }
    if (!targetWarehouse) { alert('è«‹é¸æ“‡å¯„åº«å€‰'); return; }
    if (window.consignSelectedItems.length === 0) { alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹å“é …'); return; }

    const freeUntilDate = new Date(freeUntil);
    const chargeStartDate = new Date(freeUntilDate);
    chargeStartDate.setDate(chargeStartDate.getDate() + 1);
    const chargeStartStr = chargeStartDate.toISOString().split('T')[0];

    const timestamp = Date.now();

    try {
        for (let i = 0; i < window.consignSelectedItems.length; i++) {
            const item = window.consignSelectedItems[i];

            const productMaster = window.productMasterData?.find(p =>
                p.name === item.productName && (p.spec === item.spec || (!p.spec && !item.spec))
            );

            const unitsPerPallet = productMaster?.palletCapacity || 60;
            const ratePerUnit = getConsignmentRate('å´‡æ–‡', 1, unitsPerPallet);

            const consignment = {
                source: item.isInternal ? 'internal' : 'external',
                sourceWarehouse: item.warehouseName,
                targetWarehouse: targetWarehouse,
                productName: item.productName,
                spec: item.spec,
                batchNo: item.batchNo,
                customer: customer,
                originalQty: item.qty,
                remainingQty: item.qty,
                consignmentDate: consignDate,
                freeUntil: freeUntil,
                chargeStartDate: chargeStartStr,
                unitsPerPallet: unitsPerPallet,
                ratePerUnit: ratePerUnit,
                note: '',
                pickups: [],
                status: 'active',
                createdAt: new Date().toISOString(),
                sourceLocations: item.isInternal && item.locationId ? [{
                    palletId: item.palletId,
                    locationId: item.locationId,
                    batchNo: item.batchNo,
                    qty: item.qty
                }] : null
            };

            await window.saveConsignmentToFirebase(consignment);
        }

        WMS.closeModal('consignment-modal');

        const totalQty = window.consignSelectedItems.reduce((sum, item) => sum + item.qty, 0);
        showNotification(`âœ… å·²æ–°å¢ ${window.consignSelectedItems.length} ç­†å¯„å€‰ï¼š${customer}ï¼Œå…± ${totalQty} ä»¶`, 'success');

        setTimeout(() => loadConsignmentList(), 50);
    } catch(e) {
        console.error('å„²å­˜å¯„å€‰å¤±æ•—:', e);
        alert('âŒ å„²å­˜å¤±æ•—ï¼š' + e.message);
    }
};

window.getLocationConsignments = function(locationId) {
    const consignments = [];

    window.consignmentData.forEach(c => {
        if (c.source !== 'internal') return;
        if (c.status !== 'active') return;
        if (!c.sourceLocations) return;

        c.sourceLocations.forEach(loc => {
            if (loc.locationId === locationId) {
                consignments.push({
                    customer: c.customer,
                    productName: c.productName,
                    spec: c.spec,
                    qty: loc.qty
                });
            }
        });
    });

    return consignments;
};

window.loadConsignmentList = function() {
    const tbody = document.getElementById('consignment-list');
    if (!tbody) return;

    const statusFilter = document.getElementById('consign-status-filter')?.value || 'all';
    const sourceFilter = document.getElementById('consign-source-filter')?.value || 'all';
    const searchText = (document.getElementById('consign-search')?.value || '').toLowerCase();

    let data = [...window.consignmentData]; // è¤‡è£½é™£åˆ—é¿å…æ’åºå½±éŸ¿åŸè³‡æ–™

    data.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

    const today = new Date();
    const todayStr = today.toISOString().split('T')[0];

    if (statusFilter === 'free') {
        data = data.filter(c => c.status === 'active' && c.freeUntil >= todayStr);
    } else if (statusFilter === 'charging') {
        data = data.filter(c => c.status === 'active' && c.freeUntil < todayStr);
    } else if (statusFilter === 'completed') {
        data = data.filter(c => c.status === 'completed');
    }

    if (sourceFilter === 'internal') {
        data = data.filter(c => c.source !== 'external');
    } else if (sourceFilter === 'external') {
        data = data.filter(c => c.source === 'external');
    }

    if (searchText) {
        data = data.filter(c =>
            (c.customer || '').toLowerCase().includes(searchText) ||
            (c.productName || '').toLowerCase().includes(searchText) ||
            (c.batchNo || '').toLowerCase().includes(searchText) ||
            (c.sourceWarehouse || '').toLowerCase().includes(searchText) ||
            (c.targetWarehouse || '').toLowerCase().includes(searchText)
        );
    }

    let freeCount = 0, chargingCount = 0, expiringCount = 0, totalUnits = 0, totalRent = 0;
    const thisMonth = today.getMonth();

    window.consignmentData.forEach(c => {
        if (c.status !== 'active') return;
        totalUnits += c.remainingQty;

        if (c.freeUntil >= todayStr) {
            freeCount++;
        } else {
            chargingCount++;
            const chargeStart = new Date(c.chargeStartDate);
            const daysDiff = Math.max(0, Math.floor((today - chargeStart) / (1000 * 60 * 60 * 24)));
            totalRent += c.remainingQty * c.ratePerUnit * daysDiff;
        }

        const freeUntilDate = new Date(c.freeUntil);
        if (freeUntilDate.getMonth() === thisMonth) {
            expiringCount++;
        }
    });

    const el = (id) => document.getElementById(id);
    if (el('consign-free-count')) el('consign-free-count').textContent = freeCount;
    if (el('consign-charging-count')) el('consign-charging-count').textContent = chargingCount;
    if (el('consign-expiring-count')) el('consign-expiring-count').textContent = expiringCount;
    if (el('consign-total-units')) el('consign-total-units').textContent = totalUnits.toLocaleString();
    if (el('consign-total-rent')) el('consign-total-rent').textContent = '$' + Math.round(totalRent).toLocaleString();

    if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="12" class="text-center text-slate-500 py-10">å°šç„¡å¯„å€‰è³‡æ–™</td></tr>';
        return;
    }

    let html = '';
    data.forEach(c => {
        const isFree = c.freeUntil >= todayStr;
        const statusBadge = c.status === 'completed'
            ? '<span class="badge badge-slate">å·²çµæ¸…</span>'
            : isFree
                ? '<span class="badge badge-green">å…è²»æœŸ</span>'
                : '<span class="badge badge-yellow">è¨ˆè²»ä¸­</span>';

        const sourceWarehouse = c.sourceWarehouse || (c.source === 'external' ? 'å¤–å€‰' : 'å…§å€‰');
        const isInternal = c.source !== 'external';
        const sourceClass = isInternal ? 'text-blue-400' : 'text-purple-400';

        const targetWarehouse = c.targetWarehouse || '-';

        let chargeDays = 0;
        let accumulatedRent = 0;
        if (!isFree && c.status === 'active') {
            const chargeStart = new Date(c.chargeStartDate);
            chargeDays = Math.max(0, Math.floor((today - chargeStart) / (1000 * 60 * 60 * 24)));
            accumulatedRent = c.remainingQty * c.ratePerUnit * chargeDays;
        }

        html += `
            <tr class="border-b border-slate-700 hover:bg-slate-800">
                <td class="p-2 text-xs ${sourceClass}">${sourceWarehouse}</td>
                <td class="p-2 text-xs text-amber-400">${targetWarehouse}</td>
                <td class="p-2 font-bold text-white">${c.customer}</td>
                <td class="p-2 text-white text-sm">${c.productName}<span class="text-slate-500 text-xs ml-1">${c.spec || ''}</span></td>
                <td class="p-2 text-slate-400 text-xs font-mono">${c.batchNo || '-'}</td>
                <td class="p-2 text-right text-slate-400">${c.originalQty}</td>
                <td class="p-2 text-right font-bold text-white">${c.remainingQty}</td>
                <td class="p-2 text-xs ${isFree ? 'text-emerald-400' : 'text-orange-400'}">${c.freeUntil}</td>
                <td class="p-2 text-right text-slate-400">${chargeDays}</td>
                <td class="p-2 text-right font-bold text-yellow-400">$${Math.round(accumulatedRent).toLocaleString()}</td>
                <td class="p-2">${statusBadge}</td>
                <td class="p-2 text-center">
                    ${c.status === 'active' ? `
                        <button onclick="openPickupModal('${c.id}')" class="text-blue-400 hover:bg-blue-500/20 rounded px-2 py-1 mr-1" title="æè²¨">
                            <i class="fa-solid fa-truck-ramp-box"></i>
                        </button>
                        <button onclick="deleteConsignment('${c.id}')" class="text-red-400 hover:bg-red-500/20 rounded px-2 py-1" title="åˆªé™¤">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    ` : '-'}
                </td>
            </tr>
        `;
    });

    tbody.innerHTML = html;
};

window.filterConsignments = function() {
    loadConsignmentList();
};

window.openPickupModal = function(consignmentId) {
    const c = window.consignmentData.find(item => item.id === consignmentId);
    if (!c) return;

    const todayStr = new Date().toISOString().split('T')[0];

    const content = `
        <div class="space-y-4">
            <div class="bg-slate-800 rounded-lg p-3">
                <div class="text-white font-bold">${c.customer}</div>
                <div class="text-sm text-slate-400">${c.productName} | ${c.spec || '-'}</div>
                <div class="text-sm text-slate-400">å‰©é¤˜ï¼š<span class="text-emerald-400 font-bold">${c.remainingQty}</span> ä»¶</div>
            </div>
            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="text-sm text-slate-400 mb-1 block">æè²¨æ—¥æœŸ</label>
                    <input type="date" id="pickup-date" class="scan-input" value="${todayStr}">
                </div>
                <div>
                    <label class="text-sm text-slate-400 mb-1 block">æè²¨ä»¶æ•¸ *</label>
                    <input type="number" id="pickup-qty" class="scan-input" placeholder="${c.remainingQty}" min="1" max="${c.remainingQty}">
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="savePickup('${consignmentId}')" class="flex-1 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-bold">
                    <i class="fa-solid fa-truck-ramp-box mr-1"></i>ç¢ºèªæè²¨
                </button>
                <button onclick="WMS.closeModal('pickup-modal')" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg">
                    å–æ¶ˆ
                </button>
            </div>
        </div>
    `;

    WMS.createModal('pickup-modal', {
        title: 'å®¢æˆ¶æè²¨',
        icon: 'fa-solid fa-truck-ramp-box text-blue-400',
        content: content,
        width: '400px'
    });
};

window.savePickup = async function(consignmentId) {
    const pickupDate = document.getElementById('pickup-date')?.value;
    const pickupQty = parseInt(document.getElementById('pickup-qty')?.value) || 0;

    const c = window.consignmentData.find(item => item.id === consignmentId);
    if (!c) return;

    if (pickupQty <= 0) {
        alert('è«‹è¼¸å…¥æè²¨ä»¶æ•¸');
        return;
    }
    if (pickupQty > c.remainingQty) {
        alert(`æè²¨ä»¶æ•¸ä¸èƒ½è¶…éå‰©é¤˜ ${c.remainingQty} ä»¶`);
        return;
    }

    c.pickups.push({
        date: pickupDate,
        qty: pickupQty
    });

    c.remainingQty -= pickupQty;

    if (c.remainingQty <= 0) {
        c.status = 'completed';
        c.completedAt = new Date().toISOString();
    }

    try {
        await window.updateConsignmentInFirebase(consignmentId, {
            pickups: c.pickups,
            remainingQty: c.remainingQty,
            status: c.status,
            completedAt: c.completedAt || null
        });

        WMS.closeModal('pickup-modal');
        showNotification(`âœ… å·²æè²¨ ${pickupQty} ä»¶`, 'success');
        loadConsignmentList();
    } catch(e) {
        console.error('æè²¨å„²å­˜å¤±æ•—:', e);
        alert('âŒ å„²å­˜å¤±æ•—ï¼š' + e.message);
    }
};

window.deleteConsignment = async function(consignmentId) {
    if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å¯„å€‰è¨˜éŒ„å—ï¼Ÿ')) return;

    try {
        await window.deleteConsignmentFromFirebase(consignmentId);
        showNotification('âœ… å·²åˆªé™¤å¯„å€‰è¨˜éŒ„', 'success');
        loadConsignmentList();
    } catch(e) {
        console.error('åˆªé™¤å¤±æ•—:', e);
        alert('âŒ åˆªé™¤å¤±æ•—ï¼š' + e.message);
    }
};

window.loadRentalReport = function() {
    const monthInput = document.getElementById('rental-month');
    if (!monthInput || !monthInput.value) return;

    const [year, month] = monthInput.value.split('-').map(Number);
    const settleDay = window.rentalSettings.settlement.settleDay;

    const startDate = new Date(year, month - 2, settleDay + 1);
    const endDate = new Date(year, month - 1, settleDay);

    // TODO: å¯¦éš›è¨ˆç®—å€‰ç§Ÿï¼ˆéœ€è¦æ­·å²åº«å­˜å¿«ç…§ï¼‰

    document.getElementById('own-stock-rental-body').innerHTML = `
        <tr class="border-b border-slate-700">
            <td class="p-2 text-white font-bold">å´‡æ–‡</td>
            <td class="p-2 text-right">-</td>
            <td class="p-2 text-right">-</td>
            <td class="p-2 text-right text-blue-400">-</td>
        </tr>
        <tr class="border-b border-slate-700">
            <td class="p-2 text-white font-bold">å…«æ–¹</td>
            <td class="p-2 text-right">-</td>
            <td class="p-2 text-right">-</td>
            <td class="p-2 text-right text-blue-400">-</td>
        </tr>
    `;

    const customerTotals = {};

    window.consignmentData.forEach(c => {
        const chargeStart = new Date(c.chargeStartDate);

        let previousQty = c.originalQty;
        let previousDate = chargeStart;

        c.pickups.forEach(p => {
            const pickupDate = new Date(p.date);
            // TODO: ç²¾ç¢ºè¨ˆç®—æ¯æ®µæœŸé–“çš„è²»ç”¨
        });

        if (c.status === 'active' && c.freeUntil < endDate.toISOString().split('T')[0]) {
            const effectiveStart = new Date(Math.max(chargeStart, startDate));
            const effectiveEnd = new Date(Math.min(new Date(), endDate));
            const days = Math.max(0, Math.floor((effectiveEnd - effectiveStart) / (1000 * 60 * 60 * 24)));
            const rent = c.remainingQty * c.ratePerUnit * days;

            if (!customerTotals[c.customer]) {
                customerTotals[c.customer] = { units: 0, unitDays: 0, rent: 0 };
            }
            customerTotals[c.customer].units += c.remainingQty;
            customerTotals[c.customer].unitDays += c.remainingQty * days;
            customerTotals[c.customer].rent += rent;
        }
    });

    let consignHtml = '';
    let totalConsignRent = 0;

    Object.entries(customerTotals).forEach(([customer, data]) => {
        consignHtml += `
            <tr class="border-b border-slate-700">
                <td class="p-2 text-white font-bold">${customer}</td>
                <td class="p-2 text-right">${data.units.toLocaleString()}</td>
                <td class="p-2 text-right">${data.unitDays.toLocaleString()}</td>
                <td class="p-2 text-right text-amber-400">$${Math.round(data.rent).toLocaleString()}</td>
            </tr>
        `;
        totalConsignRent += data.rent;
    });

    if (!consignHtml) {
        consignHtml = '<tr><td colspan="4" class="text-center text-slate-500 py-6">æœ¬æœˆç„¡å®¢æˆ¶å¯„å€‰è²»ç”¨</td></tr>';
    }

    document.getElementById('consign-rental-body').innerHTML = consignHtml;
    document.getElementById('consign-total').textContent = '$' + Math.round(totalConsignRent).toLocaleString();
    document.getElementById('monthly-total').textContent = '$' + Math.round(totalConsignRent).toLocaleString();
};

window.generateMonthlyBill = function() {
    const monthInput = document.getElementById('rental-month');
    if (!monthInput || !monthInput.value) {
        alert('è«‹å…ˆé¸æ“‡æœˆä»½');
        return;
    }

    // TODO: ç”¢ç”Ÿ Excel å¸³å–®
    showNotification('ğŸ“„ å¸³å–®ç”¢ç”ŸåŠŸèƒ½é–‹ç™¼ä¸­', 'info');
};

window.exportConsignments = function() {
    if (window.consignmentData.length === 0) {
        alert('æ²’æœ‰è³‡æ–™å¯åŒ¯å‡º');
        return;
    }

    const data = window.consignmentData.map(c => ({
        'å®¢æˆ¶': c.customer,
        'å“å': c.productName,
        'è¦æ ¼': c.spec || '',
        'åŸå§‹æ•¸é‡': c.originalQty,
        'å‰©é¤˜æ•¸é‡': c.remainingQty,
        'å¯„å€‰æ—¥æœŸ': c.consignmentDate,
        'å…è²»æˆªæ­¢': c.freeUntil,
        'è²»ç‡(å…ƒ/ä»¶/å¤©)': c.ratePerUnit?.toFixed(4) || '',
        'ç‹€æ…‹': c.status === 'completed' ? 'å·²çµæ¸…' : 'é€²è¡Œä¸­',
        'å‚™è¨»': c.note || ''
    }));

    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'å¯„å€‰æ¸…å–®');
    XLSX.writeFile(wb, `å¯„å€‰æ¸…å–®_${new Date().toISOString().split('T')[0]}.xlsx`);

    showNotification('âœ… å·²åŒ¯å‡ºå¯„å€‰æ¸…å–®', 'success');
};

const originalSwitchTab = window.switchTab;
window.switchTab = function(viewId, event) {
    originalSwitchTab(viewId, event);

    if (viewId === 'consignment') {
        loadConsignmentList();
    } else if (viewId === 'rental-settings') {
        loadRentalSettingsUI();
    } else if (viewId === 'rental-report') {
        const monthInput = document.getElementById('rental-month');
        if (monthInput && !monthInput.value) {
            const today = new Date();
            monthInput.value = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
        }
    } else if (viewId === 'transfer') {
        if (window.initTransferPage) {
            window.initTransferPage();
        }
    }
};

console.log('ğŸ’° å€‰ç§Ÿç®¡ç†æ¨¡çµ„å·²è¼‰å…¥');

</script>


<!-- ========== WMS V56.0 å‡ç´šè£œä¸ - æ™ºèƒ½å…¥åº«+å¤šç­†æ¨¡å¼ ========== -->
<script>
(function() {
    'use strict';
    
    console.log('ğŸš€ WMS V56.0 å‡ç´šè£œä¸è¼‰å…¥ä¸­...');

    // ========== å…¨åŸŸè®Šæ•¸ ==========
    window.batchInboundList = []; // å¤šç­†å…¥åº«æ¸…å–®
    
    // ========== 1. æ™ºèƒ½å…¥åº«æ ¸å¿ƒé‚è¼¯ ==========
    
    window.toggleAdvancedOptions = function() {
        var options = document.getElementById('advanced-options');
        var icon = document.getElementById('advanced-icon');
        if (!options) return;
        if (options.classList.contains('hidden')) {
            options.classList.remove('hidden');
            if (icon) { icon.classList.remove('fa-chevron-down'); icon.classList.add('fa-chevron-up'); }
        } else {
            options.classList.add('hidden');
            if (icon) { icon.classList.remove('fa-chevron-up'); icon.classList.add('fa-chevron-down'); }
        }
    };
    
    window.smartInbound = async function(mode) {
        var formData = getInboundFormData();
        if (!formData) return;
        
        // å…ˆé©—è­‰åŸºæœ¬è³‡æ–™
        if (!formData.productName) { alert('âŒ è«‹é¸æ“‡å“é …'); return; }
        if (!formData.quantity || formData.quantity <= 0) { alert('âŒ è«‹å¡«å¯«æ•¸é‡'); return; }
        if (!formData.expDate) { alert('âŒ è«‹å¡«å¯«æ•ˆæœŸ'); return; }
        if (formData.productType === 'variable' && (!formData.totalWeight || formData.totalWeight <= 0)) {
            alert('âŒ ä¸å®šé‡å“è«‹å¡«å¯«ç¸½é‡é‡');
            return;
        }
        
        // æœ¬å€‰å…¥åº«æ™‚æª¢æŸ¥å„²ä½
        if (!formData.isExternal && mode !== 'external') {
            if (!formData.locationId || formData.locationId.trim() === '') {
                alert('âŒ è«‹é¸æ“‡å„²ä½');
                // èšç„¦åˆ°å„²ä½è¼¸å…¥æ¡†
                var locInput = document.getElementById('in-loc');
                if (locInput) {
                    locInput.focus();
                    locInput.classList.add('animate-pulse');
                    setTimeout(function() { locInput.classList.remove('animate-pulse'); }, 2000);
                }
                // è‡ªå‹•è§¸ç™¼æ™ºèƒ½å»ºè­°
                if (typeof calculateSmartSuggest === 'function') {
                    calculateSmartSuggest();
                }
                return;
            }
        }
        
        if (formData.isExternal || mode === 'external') {
            await executeExternalInbound(formData, formData.warehouseId);
        } else if (mode === 'print') {
            await executeMainInboundWithPrint(formData);
        } else if (mode === 'direct') {
            await executeMainInboundDirect(formData);
        }
    };
    
    function getInboundFormData() {
        var name = document.getElementById('in-name').value;
        var spec = document.getElementById('in-spec').value || '';
        var batchNo = document.getElementById('in-batch').value || '';
        var vendor = document.getElementById('in-vendor').value || '';
        var exp = document.getElementById('in-exp').value;
        var category = document.getElementById('in-category') ? document.getElementById('in-category').value : 'Raw';
        
        var warehouseSelect = document.getElementById('in-warehouse');
        var warehouseId = warehouseSelect ? warehouseSelect.value : 'MAIN';
        var mainWarehouses = ['MAIN', 'MAIN-CONSIGN', 'MAIN-RESERVE', 'MANAGE', ''];
        var isExternal = warehouseId && mainWarehouses.indexOf(warehouseId) === -1;
        
        var locationId = '';
        if (isExternal) {
            locationId = warehouseId;
        } else {
            var locEl = document.getElementById('in-loc');
            locationId = locEl ? locEl.value : '';
        }
        
        var company = 'å´‡æ–‡';
        var companyRadio = document.querySelector('input[name="in-company"]:checked');
        if (companyRadio) company = companyRadio.value;
        
        var productType = 'fixed';
        var typeRadio = document.querySelector('input[name="in-product-type"]:checked');
        if (typeRadio) productType = typeRadio.value;
        
        var quantity = 0, totalWeight = 0, unitWeight = 0;
        
        if (productType === 'variable') {
            quantity = parseInt(document.getElementById('in-qty-var')?.value) || 0;
            totalWeight = parseFloat(document.getElementById('in-weight')?.value) || 0;
        } else {
            quantity = parseInt(document.getElementById('in-qty')?.value) || 0;
            unitWeight = parseFloat(document.getElementById('in-unit-weight')?.value) || 0;
            if (unitWeight > 0 && quantity > 0) totalWeight = quantity * unitWeight;
        }
        
        return { company, productName: name, spec, batchNo, vendor, expDate: exp, locationId, warehouseId, isExternal, category, productType, quantity, totalWeight, unitWeight };
    }
    
    function validateInboundData(data, isExternal) {
        if (!data.productName) return { valid: false, error: 'è«‹å¡«å¯«å“å' };
        if (!data.quantity || data.quantity <= 0) return { valid: false, error: 'è«‹å¡«å¯«æ•¸é‡' };
        if (!data.expDate) return { valid: false, error: 'è«‹å¡«å¯«æ•ˆæœŸ' };
        if (!isExternal && !data.locationId) return { valid: false, error: 'è«‹é¸æ“‡å„²ä½' };
        if (data.productType === 'variable' && (!data.totalWeight || data.totalWeight <= 0)) return { valid: false, error: 'ä¸å®šé‡å“è«‹å¡«å¯«ç¸½é‡é‡' };
        return { valid: true };
    }
    
    async function executeExternalInbound(data, warehouseId) {
        var whName = getWarehouseName(warehouseId);
        if (!confirm('ç¢ºå®šå…¥åº«åˆ°å¤–å€‰ï¼Ÿ\n\nå€‰åº«ï¼š' + whName + '\nå“åï¼š' + data.productName + '\næ•¸é‡ï¼š' + data.quantity)) return;
        
        try {
            var existing = (window.externalStock || []).find(s => s.warehouseId === warehouseId && s.productName === data.productName && s.batchNo === data.batchNo && s.company === data.company);
            
            if (existing) {
                await window.updateDoc(window.doc(window.db, 'externalStock', existing.id), { quantity: existing.quantity + data.quantity, totalWeight: (existing.totalWeight || 0) + data.totalWeight, updatedAt: new Date().toISOString() });
            } else {
                await window.addDoc(window.collection(window.db, 'externalStock'), { company: data.company, warehouseId, productName: data.productName, spec: data.spec, batchNo: data.batchNo, expDate: data.expDate, quantity: data.quantity, totalWeight: data.totalWeight, vendor: data.vendor, productType: data.productType, createdAt: new Date().toISOString() });
            }
            
            if (typeof window.logInventoryChange === 'function') {
                await window.logInventoryChange({ type: 'inbound', company: data.company, productName: data.productName, spec: data.spec, quantity: data.quantity, totalWeight: data.totalWeight, quantityChange: data.quantity, locationId: warehouseId, batchNo: data.batchNo, note: 'å¤–å€‰å…¥åº« - ' + whName });
            }
            
            alert('âœ… å¤–å€‰å…¥åº«æˆåŠŸï¼\n\nå€‰åº«ï¼š' + whName + '\nå“åï¼š' + data.productName + '\næ•¸é‡ï¼š' + data.quantity);
            if (typeof clearInboundForm === 'function') clearInboundForm();
            if (typeof loadExternalStock === 'function') loadExternalStock();
        } catch (e) { alert('âŒ å…¥åº«å¤±æ•—ï¼š' + e.message); }
    }
    
    async function executeMainInboundDirect(data) {
        if (!confirm('ç¢ºå®šå…¥åº«åˆ° ' + data.locationId + 'ï¼Ÿ\n\nå“åï¼š' + data.productName + '\næ•¸é‡ï¼š' + data.quantity)) return;
        
        try {
            var now = new Date();
            var docNo = 'IN-' + now.getFullYear() + ('0'+(now.getMonth()+1)).slice(-2) + ('0'+now.getDate()).slice(-2) + '-' + ('0'+now.getHours()).slice(-2) + ('0'+now.getMinutes()).slice(-2) + ('0'+now.getSeconds()).slice(-2) + '-' + Math.random().toString(36).substr(2, 4).toUpperCase();
            
            await window.addDoc(window.collection(window.db, 'pallets'), { palletId: docNo, company: data.company, productName: data.productName, spec: data.spec, batchNo: data.batchNo, expDate: data.expDate, expiryDate: data.expDate, quantity: data.quantity, totalWeight: data.totalWeight, unitWeight: data.unitWeight, locationId: data.locationId, vendor: data.vendor, category: data.category, productType: data.productType, source: 'SmartInbound', createdAt: now.toISOString() });
            
            if (typeof window.logInventoryChange === 'function') {
                await window.logInventoryChange({ type: 'inbound', company: data.company, productName: data.productName, spec: data.spec, quantity: data.quantity, totalWeight: data.totalWeight, quantityChange: data.quantity, locationId: data.locationId, batchNo: data.batchNo, palletId: docNo, expDate: data.expDate, note: 'å…¥åº«' });
            }
            
            alert('âœ… å…¥åº«æˆåŠŸï¼\n\nå„²ä½ï¼š' + data.locationId + '\nå“åï¼š' + data.productName + '\næ•¸é‡ï¼š' + data.quantity);
            if (typeof clearInboundForm === 'function') clearInboundForm();
        } catch (e) { alert('âŒ å…¥åº«å¤±æ•—ï¼š' + e.message); }
    }
    
    async function executeMainInboundWithPrint(data) {
        if (!confirm('ç¢ºå®šå…¥åº«ä¸¦åˆ—å°æ£§æ¿æ’å–®ï¼Ÿ\n\nå„²ä½ï¼š' + data.locationId + '\nå“åï¼š' + data.productName + '\næ•¸é‡ï¼š' + data.quantity)) return;
        
        try {
            var now = new Date();
            var docNo = 'IN-' + now.getFullYear() + ('0'+(now.getMonth()+1)).slice(-2) + ('0'+now.getDate()).slice(-2) + '-' + ('0'+now.getHours()).slice(-2) + ('0'+now.getMinutes()).slice(-2) + ('0'+now.getSeconds()).slice(-2) + '-' + Math.random().toString(36).substr(2, 4).toUpperCase();
            
            await window.addDoc(window.collection(window.db, 'pallets'), { palletId: docNo, company: data.company, productName: data.productName, spec: data.spec, batchNo: data.batchNo, expDate: data.expDate, expiryDate: data.expDate, quantity: data.quantity, totalWeight: data.totalWeight, unitWeight: data.unitWeight, locationId: data.locationId, vendor: data.vendor, category: data.category, productType: data.productType, source: 'SmartInbound', createdAt: now.toISOString() });
            
            if (typeof window.logInventoryChange === 'function') {
                await window.logInventoryChange({ type: 'inbound', company: data.company, productName: data.productName, spec: data.spec, quantity: data.quantity, totalWeight: data.totalWeight, quantityChange: data.quantity, locationId: data.locationId, batchNo: data.batchNo, palletId: docNo, expDate: data.expDate, note: 'å…¥åº«' });
            }
            
            if (typeof window.printInboundSlip === 'function') {
                window.printInboundSlip({ docNo, productName: data.productName, spec: data.spec, batchNo: data.batchNo, expDate: data.expDate, quantity: data.quantity, locationId: data.locationId, vendor: data.vendor });
            }
            
            alert('âœ… å…¥åº«æˆåŠŸï¼å·²é–‹å•Ÿåˆ—å°è¦–çª—\n\nå„²ä½ï¼š' + data.locationId + '\nå“åï¼š' + data.productName);
            if (typeof clearInboundForm === 'function') clearInboundForm();
        } catch (e) { alert('âŒ å…¥åº«å¤±æ•—ï¼š' + e.message); }
    }
    
    // ========== 2. å€‰åº«åˆ‡æ› ==========
    
    var originalOnWarehouseChange = window.onWarehouseChange;
    window.onWarehouseChange = function() {
        if (typeof originalOnWarehouseChange === 'function') originalOnWarehouseChange();
        
        var warehouseSelect = document.getElementById('in-warehouse');
        var warehouseId = warehouseSelect ? warehouseSelect.value : 'MAIN';
        var mainWarehouses = ['MAIN', 'MAIN-CONSIGN', 'MAIN-RESERVE', 'MANAGE', ''];
        var isExternal = warehouseId && mainWarehouses.indexOf(warehouseId) === -1;
        
        var mainButtons = document.getElementById('main-wh-buttons');
        var externalButtons = document.getElementById('external-wh-buttons');
        var locationSection = document.getElementById('location-section');
        var externalSection = document.getElementById('external-wh-section');
        var checkLoc = document.getElementById('check-loc');
        
        if (isExternal) {
            if (mainButtons) mainButtons.classList.add('hidden');
            if (externalButtons) externalButtons.classList.remove('hidden');
            if (locationSection) locationSection.classList.add('hidden');
            if (externalSection) externalSection.classList.remove('hidden');
            if (checkLoc) checkLoc.style.display = 'none';
            
            var whName = getWarehouseName(warehouseId);
            var titleEl = document.getElementById('inbound-wh-title');
            if (titleEl) titleEl.innerHTML = '<i class="fa-solid fa-building mr-1"></i>å¤–å€‰å…¥åº«ï¼š' + whName;
        } else {
            if (mainButtons) mainButtons.classList.remove('hidden');
            if (externalButtons) externalButtons.classList.add('hidden');
            if (locationSection) locationSection.classList.remove('hidden');
            if (externalSection) externalSection.classList.add('hidden');
            if (checkLoc) checkLoc.style.display = '';
        }
        
        updateInboundButtonState();
    };
    
    function updateInboundButtonState() {
        var warehouseSelect = document.getElementById('in-warehouse');
        var warehouseId = warehouseSelect ? warehouseSelect.value : 'MAIN';
        var mainWarehouses = ['MAIN', 'MAIN-CONSIGN', 'MAIN-RESERVE', 'MANAGE', ''];
        var isExternal = warehouseId && mainWarehouses.indexOf(warehouseId) === -1;
        
        var name = document.getElementById('in-name')?.value;
        var exp = document.getElementById('in-exp')?.value;
        
        var productType = document.querySelector('input[name="in-product-type"]:checked')?.value || 'fixed';
        var qty = productType === 'variable' ? (parseInt(document.getElementById('in-qty-var')?.value) || 0) : (parseInt(document.getElementById('in-qty')?.value) || 0);
        
        // åªæª¢æŸ¥åŸºæœ¬è³‡æ–™ï¼ˆå“åã€æ•ˆæœŸã€æ•¸é‡ï¼‰ï¼Œå„²ä½æ”¹ç‚ºæäº¤æ™‚æª¢æŸ¥
        var hasBasicData = name && exp && qty > 0;
        
        var btnPrint = document.getElementById('btn-inbound-print');
        var btnDirect = document.getElementById('btn-inbound-direct');
        if (btnPrint) btnPrint.disabled = !hasBasicData;
        if (btnDirect) btnDirect.disabled = !hasBasicData;
        
        var btnExternal = document.getElementById('btn-inbound-external');
        if (btnExternal) btnExternal.disabled = !hasBasicData;
        
        // æ›´æ–°å„²ä½æª¢æŸ¥ç‹€æ…‹é¡¯ç¤ºï¼ˆè¦–è¦ºæç¤ºï¼Œä½†ä¸é˜»æ­¢æŒ‰éˆ•ï¼‰
        var loc = document.getElementById('in-loc')?.value;
        var checkLoc = document.getElementById('check-loc');
        if (checkLoc && !isExternal) {
            var hasLocation = loc && loc.trim() !== '';
            var icon = checkLoc.querySelector('i');
            var text = checkLoc.querySelector('span');
            if (hasLocation) {
                if (icon) icon.className = 'fa-solid fa-check-circle text-emerald-400 text-[6px]';
                if (text) { text.className = 'text-emerald-400'; text.textContent = 'å„²ä½ âœ“'; }
            } else {
                if (icon) icon.className = 'fa-solid fa-circle text-orange-400 text-[6px]';
                if (text) { text.className = 'text-orange-400'; text.textContent = 'å„²ä½ï¼ˆå¾…é¸ï¼‰'; }
            }
        }
    }
    
    var originalUpdateInboundProgress = window.updateInboundProgress;
    window.updateInboundProgress = function() {
        if (typeof originalUpdateInboundProgress === 'function') originalUpdateInboundProgress();
        updateInboundButtonState();
    };
    
    // ========== 3. å“é …ä¸»æª”æ•´åˆ ==========
    
    // æ›´å¤šé¸é …åˆ‡æ›
    window.toggleInboundMoreOptions = function() {
        var panel = document.getElementById('more-options-panel');
        var icon = document.getElementById('more-options-icon');
        var text = document.getElementById('more-options-text');
        if (!panel) return;
        
        if (panel.classList.contains('hidden')) {
            panel.classList.remove('hidden');
            if (icon) { icon.classList.remove('fa-chevron-down'); icon.classList.add('fa-chevron-up'); }
            if (text) text.textContent = 'æ”¶åˆé¸é …';
        } else {
            panel.classList.add('hidden');
            if (icon) { icon.classList.remove('fa-chevron-up'); icon.classList.add('fa-chevron-down'); }
            if (text) text.textContent = 'æ›´å¤šé¸é …';
        }
    };
    
    // æ›´æ–°è¦æ ¼é¡¯ç¤ºæ–‡å­—
    window.updateSpecDisplayText = function() {
        var specEl = document.getElementById('in-spec');
        var displayRow = document.getElementById('spec-display-row');
        var displayText = document.getElementById('spec-display-text');
        
        if (specEl && displayText) {
            var spec = specEl.value;
            displayText.textContent = spec || '-';
            if (displayRow) {
                if (spec) displayRow.classList.remove('hidden');
                else displayRow.classList.add('hidden');
            }
        }
    };
    
    // è¨­å®šå“é …é¡å‹ï¼ˆå®šé‡/ä¸å®šé‡ï¼‰ä¸¦æ›´æ–° UI
    function setProductType(type) {
        var fixedFields = document.getElementById('fixed-weight-fields');
        var variableFields = document.getElementById('variable-weight-fields');
        var typeBadge = document.getElementById('product-type-badge');
        var badgeLabel = document.getElementById('type-badge-label');
        var unitWeightOption = document.getElementById('unit-weight-option');
        
        // è¨­å®š radio
        var fixedRadio = document.querySelector('input[name="in-product-type"][value="fixed"]');
        var variableRadio = document.querySelector('input[name="in-product-type"][value="variable"]');
        
        if (type === 'variable') {
            // ä¸å®šé‡å“
            if (fixedRadio) fixedRadio.checked = false;
            if (variableRadio) variableRadio.checked = true;
            if (fixedFields) fixedFields.classList.add('hidden');
            if (variableFields) variableFields.classList.remove('hidden');
            if (badgeLabel) {
                badgeLabel.textContent = 'âš–ï¸ ä¸å®šé‡å“';
                badgeLabel.className = 'px-2 py-1 rounded text-xs font-bold bg-amber-600/20 text-amber-400 border border-amber-500/30';
            }
            if (unitWeightOption) unitWeightOption.classList.add('hidden');
        } else {
            // å®šé‡å“ï¼ˆé è¨­ï¼‰
            if (fixedRadio) fixedRadio.checked = true;
            if (variableRadio) variableRadio.checked = false;
            if (fixedFields) fixedFields.classList.remove('hidden');
            if (variableFields) variableFields.classList.add('hidden');
            if (badgeLabel) {
                badgeLabel.textContent = 'ğŸ“¦ å®šé‡å“';
                badgeLabel.className = 'px-2 py-1 rounded text-xs font-bold bg-blue-600/20 text-blue-400 border border-blue-500/30';
            }
            if (unitWeightOption) unitWeightOption.classList.remove('hidden');
        }
        
        // é¡¯ç¤ºé¡å‹æ¨™ç±¤
        if (typeBadge) typeBadge.classList.remove('hidden');
        
        // å‘¼å«åŸæœ¬çš„ toggleProductTypeï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if (typeof window.originalToggleProductType === 'function') {
            window.originalToggleProductType(type);
        }
    }
    
    // ä¿å­˜åŸæœ¬çš„ toggleProductType
    window.originalToggleProductType = window.toggleProductType;
    window.toggleProductType = setProductType;
    
    var originalFillProductFromMaster = window.fillProductFromMaster;
    window.fillProductFromMaster = function(product) {
        var nameEl = document.getElementById('in-name');
        var specEl = document.getElementById('in-spec');
        var codeEl = document.getElementById('in-product-code');
        
        if (nameEl) nameEl.value = product.name || product.productName || '';
        if (specEl) specEl.value = product.spec || '';
        if (codeEl) codeEl.value = product.code || product.id || '';
        
        // æ›´æ–°è¦æ ¼é¡¯ç¤º
        updateSpecDisplayText();
        
        // è‡ªå‹•åˆ¤æ–·å®šé‡/ä¸å®šé‡
        var isVariable = product.productType === 'variable' || product.isVariable === true || product.weightType === 'variable';
        setProductType(isVariable ? 'variable' : 'fixed');
        
        // è‡ªå‹•å¡«å…¥ç®±å®¹
        if (product.unitWeight) {
            var unitWeightEl = document.getElementById('in-unit-weight');
            if (unitWeightEl) unitWeightEl.value = product.unitWeight;
        }
        
        // è‡ªå‹•è¨­å®šå…¥åº«é¡å‹
        if (product.category) {
            var categoryMap = { 'RAW': 'Raw', 'FG': 'FG', 'WIP': 'WIP', 'raw': 'Raw', 'fg': 'FG', 'wip': 'WIP' };
            var category = categoryMap[product.category] || product.category;
            var categoryEl = document.getElementById('in-category');
            if (categoryEl) categoryEl.value = category;
            
            // æ›´æ–°å…¥åº«é¡å‹æŒ‰éˆ•æ¨£å¼
            if (typeof selectInboundType === 'function') {
                selectInboundType(category);
            }
        }
        
        if (typeof updateLivePreview === 'function') updateLivePreview();
        if (typeof updateInboundProgress === 'function') updateInboundProgress();
        
        // è‡ªå‹•è·³åˆ°æ‰¹è™Ÿæ¬„ä½
        setTimeout(function() { var batchEl = document.getElementById('in-batch'); if (batchEl) batchEl.focus(); }, 100);
    };
    
    // ========== 4. å…¬å¸åˆ¥ç¯©é¸å¤–å€‰ ==========
    
    function updateWarehouseOptions() {
        var companyRadio = document.querySelector('input[name="in-company"]:checked');
        var company = companyRadio ? companyRadio.value : 'å´‡æ–‡';
        
        var optgroupCW = document.getElementById('optgroup-cw');
        var optgroupBF = document.getElementById('optgroup-bf');
        if (!optgroupCW || !optgroupBF) return;
        
        if (company === 'å´‡æ–‡') {
            optgroupCW.style.display = '';
            optgroupBF.style.display = 'none';
        } else {
            optgroupCW.style.display = 'none';
            optgroupBF.style.display = '';
        }
        
        var warehouseSelect = document.getElementById('in-warehouse');
        if (warehouseSelect) {
            var selectedOption = warehouseSelect.selectedOptions[0];
            var parent = selectedOption ? selectedOption.parentElement : null;
            if ((company === 'å´‡æ–‡' && parent === optgroupBF) || (company === 'å…«æ–¹' && parent === optgroupCW)) {
                warehouseSelect.value = 'MAIN';
                if (typeof onWarehouseChange === 'function') onWarehouseChange();
            }
        }
    }
    
    document.addEventListener('change', function(e) { if (e.target.name === 'in-company') updateWarehouseOptions(); });
    
    // ========== 5. æ•ˆæœŸè¼¸å…¥å„ªåŒ– ==========
    
    function initExpiryDateInput() {
        var expInput = document.getElementById('in-exp');
        if (!expInput || expInput.dataset.enhanced === 'true') return;
        
        var newInput = document.createElement('input');
        newInput.type = 'text';
        newInput.id = 'in-exp';
        newInput.className = expInput.className;
        newInput.placeholder = 'YYYY/MM/DD';
        newInput.maxLength = 10;
        newInput.dataset.enhanced = 'true';
        
        newInput.addEventListener('input', function(e) {
            var value = e.target.value.replace(/\D/g, '');
            var formatted = '';
            if (value.length >= 4) {
                formatted = value.substring(0, 4);
                if (value.length > 4) { formatted += '/' + value.substring(4, 6); if (value.length > 6) formatted += '/' + value.substring(6, 8); }
            } else { formatted = value; }
            e.target.value = formatted;
            if (typeof updateLivePreview === 'function') updateLivePreview();
            if (typeof updateInboundProgress === 'function') updateInboundProgress();
        });
        
        if (expInput.parentNode) expInput.parentNode.replaceChild(newInput, expInput);
    }
    
    // ========== 6. åº«å­˜ç·¨è¼¯ ==========
    
    window.editPallet = async function(id) {
        var item = (window.currentInventory || []).find(p => p.id === id);
        if (!item) { alert('æ‰¾ä¸åˆ°æ­¤ç­†è³‡æ–™'); return; }
        
        var expVal = '';
        if (item.expiryDate) { var ed = item.expiryDate.toDate ? item.expiryDate.toDate() : new Date(item.expiryDate); expVal = ed.getFullYear() + '-' + String(ed.getMonth()+1).padStart(2,'0') + '-' + String(ed.getDate()).padStart(2,'0'); }
        
        var modalHtml = '<div id="edit-pallet-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-[9999]"><div class="bg-slate-800 rounded-xl p-6 w-[500px] max-h-[90vh] overflow-auto border border-slate-600"><h3 class="text-xl font-bold text-white mb-4"><i class="fa-solid fa-edit text-blue-400 mr-2"></i>ç·¨è¼¯åº«å­˜</h3><div class="space-y-3"><div class="grid grid-cols-2 gap-3"><div><label class="text-slate-400 text-xs">å…¬å¸</label><select id="edit-company" class="w-full p-2 bg-slate-700 border border-slate-600 rounded text-white"><option value="å´‡æ–‡"' + (item.company === 'å´‡æ–‡' ? ' selected' : '') + '>å´‡æ–‡</option><option value="å…«æ–¹"' + (item.company === 'å…«æ–¹' ? ' selected' : '') + '>å…«æ–¹</option></select></div><div><label class="text-slate-400 text-xs">å„²ä½</label><input type="text" id="edit-location" value="' + (item.locationId || '') + '" class="w-full p-2 bg-slate-700 border border-slate-600 rounded text-white"></div></div><div><label class="text-slate-400 text-xs">å“å</label><input type="text" id="edit-name" value="' + (item.productName || '') + '" class="w-full p-2 bg-slate-700 border border-slate-600 rounded text-white"></div><div><label class="text-slate-400 text-xs">è¦æ ¼</label><input type="text" id="edit-spec" value="' + (item.spec || '') + '" class="w-full p-2 bg-slate-700 border border-slate-600 rounded text-white"></div><div class="grid grid-cols-2 gap-3"><div><label class="text-slate-400 text-xs">æ‰¹è™Ÿ</label><input type="text" id="edit-batch" value="' + (item.batchNo || '') + '" class="w-full p-2 bg-slate-700 border border-slate-600 rounded text-white"></div><div><label class="text-slate-400 text-xs">æ•¸é‡</label><input type="number" id="edit-qty" value="' + (item.quantity || 0) + '" class="w-full p-2 bg-slate-700 border border-slate-600 rounded text-white"></div></div><div class="grid grid-cols-2 gap-3"><div><label class="text-slate-400 text-xs">é‡é‡ (kg)</label><input type="number" step="0.01" id="edit-weight" value="' + (item.totalWeight || 0) + '" class="w-full p-2 bg-slate-700 border border-slate-600 rounded text-white"></div><div><label class="text-slate-400 text-xs">æ•ˆæœŸ</label><input type="date" id="edit-expiry" value="' + expVal + '" class="w-full p-2 bg-slate-700 border border-slate-600 rounded text-white"></div></div></div><div class="flex gap-3 mt-6"><button onclick="document.getElementById(\'edit-pallet-modal\').remove()" class="flex-1 py-2 bg-slate-600 hover:bg-slate-500 text-white rounded-lg">å–æ¶ˆ</button><button onclick="savePalletEdit(\'' + id + '\')" class="flex-1 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-bold">å„²å­˜ä¿®æ”¹</button></div></div></div>';
        document.body.insertAdjacentHTML('beforeend', modalHtml);
    };
    
    window.savePalletEdit = async function(id) {
        var updateData = { company: document.getElementById('edit-company').value, locationId: document.getElementById('edit-location').value, productName: document.getElementById('edit-name').value, spec: document.getElementById('edit-spec').value, batchNo: document.getElementById('edit-batch').value, quantity: parseInt(document.getElementById('edit-qty').value) || 0, totalWeight: parseFloat(document.getElementById('edit-weight').value) || 0, updatedAt: new Date().toISOString() };
        if (!updateData.productName) { alert('å“åä¸èƒ½ç‚ºç©º'); return; }
        if (!updateData.locationId) { alert('å„²ä½ä¸èƒ½ç‚ºç©º'); return; }
        var expiryStr = document.getElementById('edit-expiry').value;
        if (expiryStr) updateData.expiryDate = new Date(expiryStr);
        try { await window.updateDoc(window.doc(window.db, 'pallets', id), updateData); document.getElementById('edit-pallet-modal').remove(); alert('âœ… æ›´æ–°æˆåŠŸ'); } catch (e) { alert('âŒ æ›´æ–°å¤±æ•—ï¼š' + e.message); }
    };
    
    // ========== 7. å¤–å€‰åº«å­˜é¡¯ç¤º ==========
    
    function getWarehouseName(code) {
        if (!code) return 'æœ¬å€‰';
        var wh = (window.warehousesData || []).find(w => w.code === code);
        return wh ? wh.company + '_' + wh.name : code;
    }
    
    function checkAndRenderExternal() {
        var tbody = document.getElementById('inventory-list-body');
        if (!tbody) return;
        tbody.querySelectorAll('tr[data-type="external"]').forEach(row => row.remove());
        var externalStock = window.externalStock || [];
        if (externalStock.length === 0) return;
        
        externalStock.forEach(function(item) {
            var expClass = 'text-slate-400';
            if (item.expDate) { var days = Math.floor((new Date(item.expDate) - new Date()) / 86400000); if (days < 0) expClass = 'text-red-500 font-bold'; else if (days < 30) expClass = 'text-orange-400'; else if (days < 90) expClass = 'text-yellow-400'; }
            var companyClass = item.company === 'å…«æ–¹' ? 'bg-purple-900/50 text-purple-300' : 'bg-blue-900/50 text-blue-300';
            var row = document.createElement('tr');
            row.className = 'border-b border-slate-700 hover:bg-slate-800 bg-teal-900/20';
            row.setAttribute('data-company', item.company || '');
            row.setAttribute('data-type', 'external');
            row.innerHTML = '<td class="p-2"><span class="px-1.5 py-0.5 rounded text-xs ' + companyClass + '">' + (item.company || 'å´‡æ–‡') + '</span></td><td class="text-white p-2">' + (item.productName || '-') + '</td><td class="text-yellow-400 p-2">' + (item.spec || '-') + '</td><td class="text-slate-400 font-mono p-2">' + (item.batchNo || '-') + '</td><td class="text-right text-white p-2">' + (item.quantity || 0) + '</td><td class="text-right p-2">' + (item.totalWeight ? '<span class="text-amber-400">' + item.totalWeight + ' kg</span>' : '-') + '</td><td class="p-2 text-teal-400 font-mono"><span class="bg-teal-800/50 px-1.5 py-0.5 rounded text-xs mr-1">å¤–</span>' + getWarehouseName(item.warehouseId) + '</td><td class="p-2 ' + expClass + '">' + (item.expDate || '-') + '</td><td class="p-2 text-right"><button onclick="editExternalStock(\'' + item.id + '\')" class="text-blue-400 hover:text-blue-300 mr-2"><i class="fa-solid fa-edit"></i></button><button onclick="deleteExternalStock(\'' + item.id + '\')" class="text-red-500 hover:bg-red-500/20 rounded px-2"><i class="fa-solid fa-trash"></i></button></td>';
            tbody.appendChild(row);
        });
    }
    
    window.editExternalStock = async function(id) {
        var item = (window.externalStock || []).find(s => s.id === id);
        if (!item) { alert('æ‰¾ä¸åˆ°æ­¤ç­†è³‡æ–™'); return; }
        var newQty = prompt('ç·¨è¼¯æ•¸é‡\n\nå€‰åº«ï¼š' + getWarehouseName(item.warehouseId) + '\nå“åï¼š' + item.productName + '\nç›®å‰æ•¸é‡ï¼š' + item.quantity, item.quantity);
        if (newQty === null) return;
        var qty = parseInt(newQty);
        if (isNaN(qty) || qty < 0) { alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„æ•¸é‡'); return; }
        try {
            if (qty === 0) { if (!confirm('æ•¸é‡ç‚º 0ï¼Œæ˜¯å¦åˆªé™¤æ­¤ç­†è³‡æ–™ï¼Ÿ')) return; await window.deleteDoc(window.doc(window.db, 'externalStock', id)); }
            else { await window.updateDoc(window.doc(window.db, 'externalStock', id), { quantity: qty, updatedAt: new Date().toISOString() }); }
            alert('âœ… æ›´æ–°æˆåŠŸ');
            setTimeout(checkAndRenderExternal, 500);
        } catch (e) { alert('âŒ æ›´æ–°å¤±æ•—ï¼š' + e.message); }
    };
    
    window.deleteExternalStock = async function(id) {
        var item = (window.externalStock || []).find(s => s.id === id);
        if (!item) { alert('æ‰¾ä¸åˆ°æ­¤ç­†è³‡æ–™'); return; }
        if (!confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ\n\nå€‰åº«ï¼š' + getWarehouseName(item.warehouseId) + '\nå“åï¼š' + item.productName + '\næ•¸é‡ï¼š' + item.quantity)) return;
        try { await window.deleteDoc(window.doc(window.db, 'externalStock', id)); alert('âœ… å·²åˆªé™¤'); setTimeout(checkAndRenderExternal, 500); } catch (e) { alert('âŒ åˆªé™¤å¤±æ•—ï¼š' + e.message); }
    };
    
    var originalLoadExternalStock = window.loadExternalStock;
    if (typeof originalLoadExternalStock === 'function') { window.loadExternalStock = function() { originalLoadExternalStock(); setTimeout(checkAndRenderExternal, 500); }; }
    setInterval(function() { var tbody = document.getElementById('inventory-list-body'); if (tbody && window.externalStock && window.externalStock.length > 0 && !tbody.querySelector('tr[data-type="external"]')) checkAndRenderExternal(); }, 2000);
    
    // ========== 8. åˆå§‹åŒ– ==========
    
    function init() {
        initExpiryDateInput();
        updateWarehouseOptions();
        setTimeout(function() { if (typeof onWarehouseChange === 'function') onWarehouseChange(); }, 1000);
    }
    
    if (document.readyState === 'loading') { document.addEventListener('DOMContentLoaded', init); }
    else { setTimeout(init, 500); }
    
    console.log('âœ… WMS V56.0 å‡ç´šè£œä¸è¼‰å…¥å®Œæˆ');
    console.log('ğŸ“‹ æ›´æ–°å…§å®¹ï¼š');
    console.log('   - æ™ºèƒ½å…¥åº«æµç¨‹å„ªåŒ–');
    console.log('   - å“é …ä¸»æª”æ•´åˆï¼ˆè‡ªå‹•åˆ¤æ–·å®šé‡/ä¸å®šé‡ï¼‰');
    console.log('   - å…¬å¸åˆ¥ç¯©é¸å¤–å€‰');
    console.log('   - æ•ˆæœŸè¼¸å…¥å„ªåŒ–');

})();
</script>
</body>
</html>
