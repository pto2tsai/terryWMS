<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WMS å…¨åŠŸèƒ½æ——è‰¦ç‰ˆ (V29.0 Final Complete)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    
    <style>
        body { font-family: 'Inter', 'Microsoft JhengHei', sans-serif; background-color: #0f172a; color: #cbd5e1; font-size: 14px; user-select: none; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        
        .nav-item { display: flex; align-items: center; padding: 12px 16px; color: #94a3b8; cursor: pointer; transition: 0.2s; border-left: 4px solid transparent; font-size: 14px; }
        .nav-item:hover { background-color: #1e293b; color: white; }
        .nav-item.active { background-color: #1e293b; color: #38bdf8; border-left-color: #38bdf8; background: linear-gradient(90deg, rgba(56,189,248,0.1) 0%, rgba(30,41,59,0) 100%); font-weight: bold; }
        .nav-group { font-size: 12px; font-weight: bold; color: #64748b; padding: 18px 16px 6px; text-transform: uppercase; letter-spacing: 0.05em; }
        
        .glass-panel { background: #1e293b; border: 1px solid #334155; border-radius: 8px; }
        .scan-input { background: #0f172a; border: 2px solid #334155; color: white; border-radius: 6px; padding: 8px 12px; font-family: monospace; letter-spacing: 0.5px; width: 100%; transition: 0.3s; height: 36px; font-size: 14px; }
        .scan-input:focus { border-color: #3b82f6; box-shadow: 0 0 10px rgba(59, 130, 246, 0.3); outline: none; }
        .scan-input[readonly] { background: #1e293b; color: #94a3b8; cursor: not-allowed; }

        .badge { padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; }
        .badge-green { background: rgba(16, 185, 129, 0.2); color: #34d399; border: 1px solid rgba(16, 185, 129, 0.3); }
        .badge-purple { background: rgba(168, 85, 247, 0.2); color: #c084fc; border: 1px solid rgba(168, 85, 247, 0.3); }
        .badge-yellow { background: rgba(234, 179, 8, 0.2); color: #facc15; border: 1px solid rgba(234, 179, 8, 0.3); }
        .badge-orange { background: rgba(249, 115, 22, 0.2); color: #fb923c; border: 1px solid rgba(249, 115, 22, 0.3); }
        .badge-blue { background: rgba(59, 130, 246, 0.2); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.3); }
        .badge-red { background: rgba(239, 68, 68, 0.2); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.3); }

        .dense-table th { position: sticky; top: 0; background: #0f172a; z-index: 10; padding: 10px 14px; border-bottom: 2px solid #334155; text-align: left; font-size: 13px; color: #94a3b8; }
        .dense-table td { padding: 10px 14px; border-bottom: 1px solid #1e293b; white-space: nowrap; font-size: 14px; }
        .dense-table tr:hover { background-color: #334155; cursor: pointer; }
        .dense-table tbody tr:nth-child(even) { background-color: rgba(30, 41, 59, 0.3); }

        /* åœ°åœ–æ¨£å¼ */
        .map-layout { display: grid; grid-template-columns: 1fr 1fr 500px; gap: 15px; height: 100%; overflow: hidden; }
        .warehouse-col { background: #1e293b; border: 1px solid #475569; border-radius: 12px; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; }
        .col-title { font-size: 16px; font-weight: bold; text-align: center; color: white; margin-bottom: 15px; border-bottom: 2px solid #334155; padding-bottom: 8px; position: sticky; top: 0; background: #1e293b; z-index: 5; }
        .rack-lanes-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .rack-lane { height: 55px; background: #0f172a; border: 2px solid #475569; border-radius: 6px; cursor: pointer; position: relative; transition: all 0.2s; }
        .rack-lane:hover { border-color: #60a5fa; z-index: 10; transform: scale(1.02); }
        .rack-lane.active { border-color: #facc15; box-shadow: 0 0 0 2px rgba(250, 204, 21, 0.4); background: #334155; }
        .lane-full-locked { background: repeating-linear-gradient(45deg, #1f2937, #1f2937 10px, #374151 10px, #374151 20px); border-color: #ef4444; opacity: 0.6; cursor: not-allowed !important; }
        .lane-fill-bar { position: absolute; bottom: 0; left: 0; right: 0; transition: height 0.3s; opacity: 0.7; }
        .lane-suggest-gold { background: rgba(234, 179, 8, 0.15); border: 2px solid #eab308; box-shadow: 0 0 10px rgba(234, 179, 8, 0.5); animation: pulse-gold 1.5s infinite; }
        @keyframes pulse-gold { 0% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0.4); } 70% { box-shadow: 0 0 0 8px rgba(234, 179, 8, 0); } 100% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0); } }

        .level-card { background: #0f172a; border: 1px solid #334155; border-radius: 8px; margin-bottom: 10px; padding: 8px; position: relative; }
        .level-header { display: flex; justify-content: space-between; font-size: 13px; color: #cbd5e1; margin-bottom: 6px; font-weight: 800; border-bottom: 1px dashed #334155; padding-bottom: 4px; }
        .level-track { display: flex; gap: 4px; background: rgba(0,0,0,0.3); padding: 5px; border-radius: 6px; min-height: 55px; align-items: center; justify-content: flex-end; flex-wrap: wrap; }
        .pallet-box { width: 23%; height: 48px; border-radius: 4px; font-size: 11px; font-weight: bold; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: help; box-shadow: 0 2px 4px rgba(0,0,0,0.4); line-height: 1.2; text-align: center; overflow: hidden; padding: 2px; color: rgba(255,255,255,1); border: 1px solid rgba(255,255,255,0.1); }
        .pallet-box.loose { width: 48%; }
        .bg-fg { background: #7c3aed; border: 1px solid #8b5cf6; } .bg-raw { background: #059669; border: 1px solid #10b981; } .bg-wip { background: #ca8a04; border: 1px solid #eab308; }
        .pallet-empty { background: transparent; border: 2px dashed #475569; color: #475569; font-size: 12px; }
        .cap-bar-bg { width: 80px; height: 6px; background: #334155; border-radius: 3px; overflow: hidden; }
        .cap-bar-fill { height: 100%; transition: width 0.3s; }

        /* V25 æƒ…å¢ƒæŒ‰éˆ• */
        .mode-btn { padding: 8px; border-radius: 8px; border: 1px solid #475569; text-align: center; cursor: pointer; transition: 0.2s; color: #94a3b8; background: #1e293b; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 65px; }
        .mode-btn:hover { background: #334155; color: white; }
        .mode-btn i { font-size: 20px; margin-bottom: 4px; }
        .mode-btn.active-raw { background: #064e3b; border-color: #10b981; color: #34d399; font-weight: bold; box-shadow: 0 0 10px rgba(16, 185, 129, 0.3); }
        .mode-btn.active-fg { background: #4c1d95; border-color: #a855f7; color: #d8b4fe; font-weight: bold; box-shadow: 0 0 10px rgba(168, 85, 247, 0.3); }
        .mode-btn.active-wip { background: #451a03; border-color: #eab308; color: #fde047; font-weight: bold; box-shadow: 0 0 10px rgba(234, 179, 8, 0.3); }
        .mode-btn.active-ret { background: #431407; border-color: #fb923c; color: #fdba74; font-weight: bold; box-shadow: 0 0 10px rgba(251, 146, 60, 0.3); }
        
        .tab-btn { padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: bold; color: #64748b; background: #1e293b; border: 1px solid #334155; transition: 0.2s; font-size: 13px; }
        .tab-btn.active { background: #2563eb; color: white; border-color: #3b82f6; }
        .virtual-card { background: #334155; padding: 12px; border-radius: 6px; cursor: pointer; border: 1px solid transparent; text-align: center; }
        .virtual-card:hover { border-color: #38bdf8; background: #475569; }
        .move-box { width: 45%; height: 300px; background: #1e293b; border: 3px dashed #475569; border-radius: 16px; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: 0.3s; }
        .move-box.active { border-color: #38bdf8; background: #0f172a; border-style: solid; box-shadow: 0 0 20px rgba(56, 189, 248, 0.2); }
        .field-group.hidden { display: none; }
        .cat-btn { padding: 8px; border: 1px solid #475569; border-radius: 6px; text-align: center; cursor: pointer; transition: 0.2s; color: #94a3b8; font-size: 12px; flex: 1; }
        .cat-btn.active-raw { background: #065f46; border-color: #10b981; color: #34d399; font-weight: bold; }
        .cat-btn.active-fg { background: #581c87; border-color: #a855f7; color: #d8b4fe; font-weight: bold; }
        .cat-btn.active-wip { background: #713f12; border-color: #eab308; color: #fde047; font-weight: bold; }

        @media print { body * { visibility: hidden; } #print-area, #print-area * { visibility: visible; } #print-area { position: absolute; left: 0; top: 0; width: 100%; } .print-page { page-break-after: always; width: 100mm; height: 150mm; border: 2px solid black; padding: 10px; margin: 0 auto; color: black !important; background: white !important; display: flex; flex-direction: column; } }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <div id="view-login" class="fixed inset-0 z-50 bg-slate-900 flex flex-col items-center justify-center p-6">
        <div class="w-full max-w-sm space-y-4 text-center">
            <h1 class="text-4xl font-black text-white mb-6 tracking-tighter">Terry <span class="text-blue-500">WMS V29</span></h1>
            <input type="email" id="login-email" value="admin@bafang.com" class="scan-input text-center text-lg" placeholder="Email">
            <input type="password" id="login-pwd" value="123456" class="scan-input text-center text-lg" placeholder="å¯†ç¢¼">
            <button onclick="loginSystem()" id="btn-login" class="w-full py-4 bg-blue-600 hover:bg-blue-500 text-white rounded font-bold shadow-lg text-lg">ç™»å…¥ç³»çµ±</button>
        </div>
    </div>

    <div id="modal-level-select" class="fixed inset-0 z-40 bg-black/80 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-slate-900 border border-slate-700 p-8 rounded-2xl w-96 shadow-2xl">
            <div id="loc-select-physical" class="hidden">
                <h3 class="text-xl font-bold text-white mb-2 text-center">é¸æ“‡å…¥åº«å±¤æ•¸</h3>
                <p class="text-sm text-slate-400 mb-6 text-center font-mono" id="modal-lane-title">I-A ç¬¬ 1 è¡Œ</p>
                <div class="space-y-3">
                    <button onclick="selectLevel('3F')" class="w-full py-3 bg-slate-800 hover:bg-blue-600 border border-slate-600 rounded text-white text-base font-bold transition">3F (æ¨™æº–å±¤)</button>
                    <button onclick="selectLevel('2F')" class="w-full py-3 bg-slate-800 hover:bg-blue-600 border border-slate-600 rounded text-white text-base font-bold transition">2F (æ¨™æº–å±¤)</button>
                    <button onclick="selectLevel('1F')" class="w-full py-4 bg-slate-800 hover:bg-yellow-600 border border-yellow-500/50 rounded text-white text-base font-bold transition relative">1F (æŒ‘é«˜å±¤) <span class="absolute top-2 right-3 text-xs text-yellow-400 bg-yellow-900/50 px-1 rounded">æ•£è²¨å€</span></button>
                </div>
            </div>
            <div id="loc-select-virtual" class="hidden">
                <h3 class="text-xl font-bold text-white mb-4 text-center">é¸æ“‡è™›æ“¬å€‰åº«</h3>
                <div class="grid grid-cols-2 gap-3 mb-4" id="virtual-grid"></div>
                <div class="border-t border-slate-700 pt-4"><input type="text" id="new-virtual-name" class="scan-input text-sm mb-2" placeholder="æ–°è™›æ“¬åº«åç¨±..."><button onclick="addNewVirtualLoc()" class="w-full py-2 bg-emerald-600 hover:bg-emerald-500 rounded text-white text-sm font-bold">æ–°å¢è‡ªè¨‚åº«</button></div>
            </div>
            <button onclick="closeLocModal()" class="mt-6 w-full text-slate-500 text-sm hover:text-white">å–æ¶ˆ</button>
        </div>
    </div>

    <aside class="w-60 bg-slate-900 border-r border-slate-800 flex flex-col shrink-0 z-20">
        <div class="h-16 flex items-center px-6 border-b border-slate-800">
            <i class="fa-solid fa-cube text-blue-500 text-2xl mr-3"></i><span class="font-black text-xl text-white tracking-wide">TERRY WMS</span>
        </div>
        <nav class="flex-1 overflow-y-auto py-2">
            <div class="nav-group">æ ¸å¿ƒç›£æ§</div>
            <div class="nav-item active" onclick="switchTab('visual-map')"><i class="fa-solid fa-map-location-dot w-6 text-center mr-2"></i> æ•¸ä½å€‰åº«</div>
            <div class="nav-item" onclick="switchTab('dashboard')"><i class="fa-solid fa-chart-pie w-6 text-center mr-2"></i> æˆ°æƒ…åˆ†æ</div>

            <div class="nav-group">å…¥åº«èˆ‡ç”Ÿç”¢</div>
            <div class="nav-item" onclick="switchTab('unified-inbound')"><i class="fa-solid fa-bolt w-6 text-center mr-2"></i> æ™ºèƒ½å…¥åº«ä¸­å¿ƒ</div>
            <div class="nav-item" onclick="switchTab('pre-inbound')"><i class="fa-solid fa-print w-6 text-center mr-2"></i> é ç´„å…¥åº«/æ¨™ç±¤</div>

            <div class="nav-group">åº«å…§ä½œæ¥­</div>
            <div class="nav-item" onclick="switchTab('inventory-query')"><i class="fa-solid fa-magnifying-glass w-6 text-center mr-2"></i> åº«å­˜ç¶œåˆæŸ¥è©¢</div>
            <div class="nav-item" onclick="switchTab('move')"><i class="fa-solid fa-arrow-right-arrow-left w-6 text-center mr-2"></i> å„²ä½ç§»å‹•</div>
            <div class="nav-item" onclick="switchTab('merge')"><i class="fa-solid fa-layer-group w-6 text-center mr-2"></i> æ¿è™Ÿåˆä½µ</div>
            <div class="nav-item" onclick="switchTab('stocktake')"><i class="fa-solid fa-clipboard-check w-6 text-center mr-2"></i> åº«å­˜ç›¤é»</div>

            <div class="nav-group">å‡ºåº«ç‰©æµ</div>
            <div class="nav-item" onclick="switchTab('shipping')"><i class="fa-solid fa-truck-ramp-box w-6 text-center mr-2"></i> è¨‚å–®ç†è²¨</div>
        </nav>
    </aside>

    <main class="flex-1 flex flex-col min-w-0 bg-slate-900">
        <header class="h-16 border-b border-slate-800 flex items-center justify-between px-6 bg-slate-900 shrink-0">
            <h2 class="text-xl font-bold text-white" id="page-title">æ•¸ä½å€‰åº«ç›£æ§</h2>
            <div class="flex gap-3 items-center">
                <span class="px-3 py-1 bg-slate-800 rounded text-xs text-slate-400 border border-slate-700">Admin</span>
                <button onclick="logoutSystem()" class="hover:text-white text-sm"><i class="fa-solid fa-power-off"></i></button>
            </div>
        </header>

        <div class="flex-1 overflow-hidden relative">
            
            <div id="view-visual-map" class="view-panel h-full flex flex-col">
                <div class="h-10 bg-slate-800/50 border-b border-slate-800 flex items-center px-4 gap-6 text-xs text-slate-400 shrink-0">
                    <div class="flex items-center gap-2"><div class="w-3 h-3 bg-raw rounded-sm"></div> åŸæ–™</div>
                    <div class="flex items-center gap-2"><div class="w-3 h-3 bg-fg rounded-sm"></div> æˆå“</div>
                    <div class="flex items-center gap-2"><div class="w-3 h-3 bg-wip rounded-sm"></div> åŠæˆå“</div>
                    <span class="ml-auto text-emerald-400"><i class="fa-solid fa-computer-mouse mr-1"></i>æ»‘é¼ é è¦½ï¼Œé»æ“Šé–å®š</span>
                </div>
                <div class="map-layout p-4">
                    <div class="warehouse-col">
                        <div class="col-title text-blue-400 border-blue-500/30">I åº« (åŸæ–™/é¤˜æ–™)</div>
                        <div class="text-xs text-slate-500 mb-2 mt-2 font-bold">A å€ (Zone A)</div><div class="rack-lanes-grid" id="grid-I-A"></div>
                        <div class="text-xs text-slate-500 mb-2 mt-6 font-bold">B å€ (Zone B)</div><div class="rack-lanes-grid" id="grid-I-B"></div>
                    </div>
                    <div class="warehouse-col">
                        <div class="col-title text-purple-400 border-purple-500/30">J åº« (æˆå“/åŠæˆå“)</div>
                        <div class="text-xs text-slate-500 mb-2 mt-2 font-bold">C å€ (Zone C)</div><div class="rack-lanes-grid" id="grid-J-C"></div>
                        <div class="text-xs text-slate-500 mb-2 mt-6 font-bold">D å€ (Zone D)</div><div class="rack-lanes-grid" id="grid-J-D"></div>
                    </div>
                    <div class="rack-detail-panel" id="detail-panel">
                        <div class="h-full flex flex-col items-center justify-center text-slate-500 opacity-50"><i class="fa-solid fa-layer-group text-6xl mb-4"></i><p>é»æ“Šå·¦å´è»Œé“</p></div>
                    </div>
                </div>
            </div>

            <div id="view-dashboard" class="view-panel h-full hidden flex flex-col p-6 overflow-y-auto">
                <div class="grid grid-cols-4 gap-6 mb-6">
                    <div class="glass-panel p-5 border-l-4 border-blue-500"><div class="text-slate-400 text-xs">ç¸½åº«å­˜ (æ¿)</div><div class="text-3xl font-bold text-white mt-1" id="kpi-total-pallets">0</div></div>
                    <div class="glass-panel p-5 border-l-4 border-purple-500"><div class="text-slate-400 text-xs">æˆå“åº«å­˜ (æ¿)</div><div class="text-3xl font-bold text-white mt-1" id="kpi-fg-count">0</div></div>
                    <div class="glass-panel p-5 border-l-4 border-orange-500"><div class="text-slate-400 text-xs">é¤˜æ–™åº«å­˜ (æ¿)</div><div class="text-3xl font-bold text-white mt-1" id="kpi-return-count">0</div></div>
                    <div class="glass-panel p-5 border-l-4 border-red-500"><div class="text-slate-400 text-xs">æ•ˆæœŸè­¦ç¤º</div><div class="text-3xl font-bold text-white mt-1">0</div></div>
                </div>
                <div class="glass-panel p-5 h-64 w-1/2"><h3 class="font-bold text-white mb-4">åº«å­˜çµæ§‹</h3><canvas id="stockChart"></canvas></div>
            </div>

            <div id="view-unified-inbound" class="view-panel h-full hidden flex flex-col p-6">
                <div class="w-full flex h-full gap-6">
                    <div class="w-1/3 flex flex-col overflow-y-auto pr-2">
                        <div class="grid grid-cols-4 gap-2 mb-6">
                            <div onclick="setInboundMode('Raw')" id="btn-mode-raw" class="mode-btn active-raw"><i class="fa-solid fa-truck-field"></i><span class="text-[10px]">æ¡è³¼é€²è²¨</span></div>
                            <div onclick="setInboundMode('FG')" id="btn-mode-fg" class="mode-btn"><i class="fa-solid fa-boxes-packing"></i><span class="text-[10px]">ç”¢ç·šæˆå“</span></div>
                            <div onclick="setInboundMode('WIP')" id="btn-mode-wip" class="mode-btn"><i class="fa-solid fa-basket-shopping"></i><span class="text-[10px]">ç”¢ç·šåŠæˆå“</span></div>
                            <div onclick="setInboundMode('Return')" id="btn-mode-ret" class="mode-btn"><i class="fa-solid fa-rotate-left"></i><span class="text-[10px]">é¤˜æ–™é€€åº«</span></div>
                            <input type="hidden" id="in-category" value="Raw">
                        </div>

                        <div class="glass-panel p-4 mb-4 border border-emerald-500" id="scan-panel">
                            <div class="flex justify-between text-xs text-blue-400 font-bold mb-1"><span id="step1-label">STEP 1. è­˜åˆ¥è²¨ç‰©</span><span id="return-hint" class="hidden text-orange-400">è«‹æƒæèˆŠæ¨™ç±¤</span></div>
                            <div class="flex gap-2"><input type="text" id="in-barcode" class="scan-input text-lg font-bold w-full" placeholder="æƒææ¢ç¢¼..." autofocus onkeydown="handleUnifiedScan(event)"><button onclick="generateInternalBarcode()" id="btn-auto-code" class="bg-slate-700 text-white px-3 rounded text-xs border border-slate-600 whitespace-nowrap"><i class="fa-solid fa-magic mr-1"></i>è³¦ç¢¼</button></div>
                        </div>

                        <div class="flex items-center justify-between bg-slate-800 p-2 rounded border border-slate-700 mb-4"><span class="text-xs text-white font-bold"><i class="fa-solid fa-lock text-blue-400 mr-2"></i>é€£çºŒå…¥åº« (é–å®šè³‡æ–™)</span><input type="checkbox" id="lock-mode" class="w-4 h-4"></div>

                        <div class="space-y-3 flex-1">
                            <div id="field-wo" class="field-group hidden"><label class="text-xs text-slate-400">å·¥å–®è™Ÿ (Work Order)</label><input type="text" id="in-wo" class="scan-input border-purple-500/50" placeholder="æƒæå·¥å–®"></div>
                            <div id="field-parent-info" class="field-group hidden bg-orange-900/20 p-2 rounded border border-orange-500/30"><label class="text-xs text-orange-400">ç¹¼æ‰¿è‡ª (Original)</label><input type="text" id="in-parent-id" class="scan-input bg-transparent border-none text-xs" readonly></div>
                            <div><label class="text-xs text-slate-400">å“å (Product)</label><input type="text" id="in-name" class="scan-input bg-slate-900" placeholder="æƒç¢¼æˆ–è¼¸å…¥"></div>
                            <div class="grid grid-cols-2 gap-2"><div><label class="text-xs text-slate-400">è¦æ ¼ (Spec) *</label><input type="text" id="in-spec" class="scan-input text-yellow-400 font-bold"></div><div><label class="text-xs text-slate-400" id="lbl-qty">æ•¸é‡ (ç®±)</label><input type="number" id="in-qty" class="scan-input text-white font-bold"></div></div>
                            <div id="field-weight" class="field-group hidden"><label class="text-xs text-yellow-500 font-bold">å¯¦é‡ (KG) *</label><input type="number" id="in-weight" class="scan-input text-xl font-bold text-center" placeholder="0.0"></div>
                            <div class="grid grid-cols-2 gap-2"><div><label class="text-xs text-slate-400">æ‰¹è™Ÿ (Batch)</label><input type="text" id="in-batch" class="scan-input"></div><div><label class="text-xs text-slate-400">æ•ˆæœŸ (Expiry)</label><input type="date" id="in-exp" class="scan-input"></div></div>
                            <div class="pt-2 border-t border-slate-700"><div class="flex justify-between items-center mb-1"><label class="text-xs text-blue-400 font-bold">STEP 2. é¸æ“‡å„²ä½</label><button onclick="openVirtualSelector()" class="text-[10px] bg-slate-700 px-2 py-0.5 rounded text-white border border-slate-600">åˆ‡æ›è™›æ“¬åº«</button></div><input type="text" id="in-loc" class="scan-input pl-10 text-xl font-bold text-emerald-400 bg-slate-900 border-emerald-500/50 text-center" placeholder="é»æ“Šå³å´åœ°åœ–" readonly></div>
                        </div>

                        <div class="flex gap-2 mt-4">
                            <button onclick="confirmUnifiedInbound()" id="btn-submit" class="flex-1 py-3 bg-emerald-600 hover:bg-emerald-500 text-white rounded font-bold shadow-lg text-lg transition">ç¢ºèªå…¥åº«</button>
                            <button onclick="batchGenerate()" class="px-4 bg-orange-600 hover:bg-orange-500 text-white rounded font-bold shadow-lg" title="æ‰¹é‡ç”¢ç”Ÿ"><i class="fa-solid fa-layer-group"></i></button>
                        </div>
                    </div>
                    <div class="flex-1 bg-slate-900 p-4 flex flex-col relative">
                        <div class="absolute top-2 right-4 bg-slate-800/80 p-2 rounded border border-slate-700 text-xs text-slate-300 flex gap-4 backdrop-blur z-10"><div class="flex items-center gap-1"><i class="fa-solid fa-star text-yellow-400"></i> æ¨è–¦</div><div class="flex items-center gap-1"><div class="w-3 h-3 border border-emerald-500"></div> ç©ºä½</div></div>
                        <div class="map-overview" id="inbound-map-area"><div class="warehouse-building"><div class="text-blue-400 font-bold mb-2">I åº«</div><div class="zone-header">A å€</div><div class="zone-block"><div class="rack-lanes-grid" id="grid-I-A-map"></div></div><div class="zone-header bg-slate-600 border-slate-500 mt-2">B å€</div><div class="zone-block"><div class="rack-lanes-grid" id="grid-I-B-map"></div></div></div><div class="warehouse-building"><div class="text-purple-400 font-bold mb-2">J åº«</div><div class="zone-header bg-purple-600 border-purple-500">C å€</div><div class="zone-block"><div class="rack-lanes-grid" id="grid-J-C-map"></div></div><div class="zone-header bg-pink-600 border-pink-500 mt-2">D å€</div><div class="zone-block"><div class="rack-lanes-grid" id="grid-J-D-map"></div></div></div></div>
                    </div>
                </div>
            </div>

            <div id="view-pre-inbound" class="view-panel h-full hidden flex p-6 gap-6">
                <div class="w-1/3 glass-panel p-6 flex flex-col overflow-y-auto">
                    <h3 class="text-white font-bold mb-3 border-b border-slate-700 pb-2 text-sm">1. æ‰¹æ¬¡é ç´„</h3>
                    <div class="mb-4 bg-slate-800 p-3 rounded border border-slate-700"><div class="flex justify-between items-center mb-1"><span class="text-xs text-blue-400 font-bold">Excel åŒ¯å…¥</span><button onclick="downloadTemplate('pre')" class="text-[10px] text-slate-400 underline">ä¸‹è¼‰ç¯„æœ¬</button></div><input type="file" id="preInboundExcel" accept=".xlsx" class="hidden" onchange="handlePreInboundImport(event)"><button onclick="document.getElementById('preInboundExcel').click()" class="w-full py-2 bg-emerald-600 hover:bg-emerald-500 text-white rounded text-xs font-bold">ä¸Šå‚³ Excel</button></div>
                    <h3 class="text-white font-bold mb-3 border-b border-slate-700 pb-2 text-sm">2. æ‰‹å‹•é ç´„</h3>
                    <div class="space-y-3"><input type="text" id="pre-name" class="scan-input" placeholder="å“å"><input type="text" id="pre-spec" class="scan-input" placeholder="è¦æ ¼"><input type="text" id="pre-batch" class="scan-input" placeholder="æ‰¹è™Ÿ"><input type="date" id="pre-exp" class="scan-input"><div class="grid grid-cols-2 gap-2"><input type="number" id="pre-per-pallet" class="scan-input text-center" value="50" placeholder="æ¯æ¿æ•¸"><input type="number" id="pre-count" class="scan-input text-center font-bold text-white" value="1" placeholder="ç¸½æ¿æ•¸"></div><button onclick="generatePlan()" class="w-full py-2 bg-blue-600 hover:bg-blue-500 text-white rounded font-bold shadow-lg mt-2 text-xs">ç”Ÿæˆ</button></div>
                </div>
                <div class="flex-1 glass-panel p-6 flex flex-col"><div class="flex justify-between items-center mb-3"><h3 class="text-white font-bold text-sm">æ¨™ç±¤é è¦½</h3><button onclick="printLabels()" id="btn-print" class="bg-slate-700 text-slate-500 px-3 py-1 rounded text-xs font-bold cursor-not-allowed" disabled>åˆ—å°æ’å–®</button></div><div id="preview-area" class="flex-1 overflow-y-auto grid grid-cols-2 gap-2 content-start"></div></div>
            </div>

            <div id="view-inventory-query" class="view-panel h-full hidden flex flex-col p-6">
                <div class="flex gap-2 mb-4 items-center">
                    <div class="relative flex-1 max-w-md"><i class="fa-solid fa-search absolute left-3 top-2.5 text-slate-500"></i><input type="text" id="global-search" class="scan-input pl-9" placeholder="è¬ç”¨æœå°‹ (å“å/è¦æ ¼/æ‰¹è™Ÿ/å„²ä½/å» å•†...)" oninput="filterInventory()"></div>
                    <button onclick="document.getElementById('stockImportInput').click()" class="bg-orange-600 text-white px-3 py-1.5 rounded text-xs font-bold hover:bg-orange-500 ml-auto flex items-center gap-2"><i class="fa-solid fa-file-import"></i> æœŸåˆåŒ¯å…¥</button>
                    <button onclick="downloadTemplate('stock')" class="text-slate-400 text-xs hover:text-white underline">ç¯„æœ¬</button>
                    <input type="file" id="stockImportInput" accept=".xlsx" class="hidden" onchange="handleStockImport(event)">
                </div>
                <div class="glass-panel flex-1 overflow-auto"><table class="w-full dense-table"><thead><tr><th>ID</th><th>å“å</th><th>è¦æ ¼</th><th>æ‰¹è™Ÿ</th><th>æ•¸é‡</th><th>ä½ç½®</th><th>æ“ä½œ</th></tr></thead><tbody id="inventory-list-body"></tbody></table></div>
            </div>

            <div id="view-shipping" class="view-panel h-full hidden flex flex-col">
                <div class="h-16 border-b border-slate-800 flex items-center px-6 gap-4 bg-slate-900/50">
                    <input type="file" id="excelInput" accept=".xlsx" class="hidden" onchange="handleExcelImport(event)"><button onclick="document.getElementById('excelInput').click()" class="bg-emerald-600 text-white px-3 py-1.5 rounded text-xs font-bold hover:bg-emerald-500 shadow-lg flex items-center"><i class="fa-solid fa-file-excel mr-2"></i>åŒ¯å…¥è¨‚å–®</button><button onclick="downloadTemplate('order')" class="text-slate-400 text-xs hover:text-white underline">ç¯„æœ¬</button>
                    <div class="flex items-center gap-2 border-l border-slate-700 pl-4"><label class="text-xs text-slate-400">ç‰©æµ:</label><select id="filter-carrier" class="bg-slate-800 border border-slate-700 text-white text-xs rounded px-2 py-1.5 focus:border-blue-500 outline-none" onchange="filterShippingList()"><option value="ALL">å…¨éƒ¨</option></select></div>
                    <div class="text-xs text-slate-400 ml-auto">å¾…å‡ºè²¨: <span class="text-white font-bold" id="order-count">0</span> å–®</div>
                </div>
                <div class="flex-1 overflow-auto p-4"><table class="w-full dense-table text-left"><thead><tr><th>ç‰©æµ</th><th>å–®è™Ÿ</th><th>å®¢æˆ¶</th><th>å“é …(è¦æ ¼)</th><th>ç‹€æ…‹</th><th class="text-right">æ“ä½œ</th></tr></thead><tbody id="shipping-list-body"></tbody></table></div>
            </div>

            <div id="view-move" class="view-panel h-full hidden p-6"><div class="move-container"><div id="move-source" class="move-box active"><div class="text-red-400 font-bold mb-4 text-xl">STEP 1. ä¾†æº (FROM)</div><i class="fa-solid fa-box-open text-6xl text-slate-600 mb-4"></i><input type="text" class="scan-input w-2/3 text-center" placeholder="æƒæè²¨ç‰©"></div><i class="fa-solid fa-arrow-right arrow-icon"></i><div id="move-target" class="move-box opacity-50"><div class="text-emerald-400 font-bold mb-4 text-xl">STEP 2. ç›®çš„ (TO)</div><i class="fa-solid fa-location-dot text-6xl text-slate-600 mb-4"></i><input type="text" class="scan-input w-2/3 text-center" placeholder="æƒæå„²ä½" disabled></div></div></div>
            <div id="view-merge" class="view-panel h-full hidden p-6"><div class="move-container"><div class="move-box active"><div class="text-blue-400 font-bold mb-4 text-xl">ä¿ç•™æ£§æ¿ (åº•åº§)</div><i class="fa-solid fa-layer-group text-6xl mb-4 text-purple-500/50"></i><input type="text" class="scan-input w-2/3 text-center" placeholder="æƒæ"></div><i class="fa-solid fa-plus arrow-icon"></i><div class="move-box"><div class="text-slate-400 font-bold mb-4 text-xl">ç§»å…¥æ£§æ¿ (æ¸…ç©º)</div><input type="text" class="scan-input w-2/3 text-center" placeholder="æƒæ"></div></div></div>
            <div id="view-stocktake" class="view-panel h-full hidden p-6"><div class="flex justify-between items-center mb-6"><h3 class="text-white font-bold">ç›¤é»ä»»å‹™</h3><button class="px-4 py-2 bg-blue-600 text-white rounded text-sm font-bold shadow-lg">å»ºç«‹ç›¤é»å–®</button></div><div class="glass-panel p-5 border border-slate-600 relative opacity-50"><div class="text-center py-10 text-slate-500">å°šç„¡ä»»å‹™</div></div></div>

        </div>
    </main>

    <div id="print-area" class="hidden"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, query, where, onSnapshot, writeBatch, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = { apiKey: "AIzaSyBEWzyRMJQirGbh28ANkE6aN42GzUBuw2s", authDomain: "terrywms-2345f.firebaseapp.com", projectId: "terrywms-2345f", storageBucket: "terrywms-2345f.firebasestorage.app", messagingSenderId: "75589714942", appId: "1:75589714942:web:3a7f723c3d1449df78f6af" };
        const app = initializeApp(firebaseConfig); const db = getFirestore(app); const auth = getAuth(app);
        window.db = db; window.collection = collection; window.addDoc = addDoc; window.doc = doc; window.updateDoc = updateDoc; window.deleteDoc = deleteDoc; window.writeBatch = writeBatch; window.getDocs = getDocs; window.query = query; window.where = where; window.onSnapshot = onSnapshot;

        onAuthStateChanged(auth, (user) => { if (user) { document.getElementById('view-login').classList.add('hidden'); initAllListeners(); } else { document.getElementById('view-login').classList.remove('hidden'); } });
        window.loginSystem = async () => { await signInWithEmailAndPassword(auth, document.getElementById('login-email').value, document.getElementById('login-pwd').value); }
        window.logoutSystem = () => { signOut(auth); location.reload(); }

        let currentInventory = []; let currentOrders = [];
        function initAllListeners() {
            onSnapshot(collection(db, "pallets"), (snapshot) => {
                currentInventory = [];
                const tbody = document.getElementById('inventory-list-body');
                if(tbody) tbody.innerHTML = '';
                let stats = { total:0, fg:0, ret:0, virt:0, chart:{raw:0, fg:0, wip:0} };
                
                snapshot.forEach(d => {
                    const data = d.data();
                    if(data.quantity > 0 || data.totalWeight > 0) {
                        currentInventory.push(data);
                        stats.total++;
                        if(data.category === 'FG') { stats.fg++; stats.chart.fg++; } else if(data.category === 'WIP') { stats.chart.wip++; } else { stats.chart.raw++; }
                        if(data.source === 'Factory_Return') stats.ret++;
                        if(data.locationId && data.locationId.startsWith('V-')) stats.virt++;
                        let badge = '<span class="badge badge-green">åŸæ–™</span>';
                        if(data.category === 'FG') badge = '<span class="badge badge-purple">æˆå“</span>';
                        if(data.category === 'WIP') badge = '<span class="badge badge-yellow">åŠæˆå“</span>';
                        if(data.source === 'Factory_Return') badge = '<span class="badge badge-orange">é¤˜æ–™</span>';
                        if(tbody) tbody.innerHTML += `<tr class="border-b border-slate-700 hover:bg-slate-800"><td class="font-mono text-blue-400 p-2">${d.id}</td><td class="text-white p-2">${data.productName}</td><td class="text-yellow-400 p-2">${data.spec||'-'}</td><td class="text-slate-400 font-mono p-2">${data.batchNo}</td><td class="text-right text-white p-2">${data.quantity||'-'}</td><td class="p-2">${data.locationId}</td><td class="p-2 text-right"><button onclick="deletePallet('${d.id}')" class="text-red-500 hover:bg-red-500/20 rounded px-2"><i class="fa-solid fa-trash"></i></button></td></tr>`;
                    }
                });
                if(document.getElementById('kpi-total-pallets')) { document.getElementById('kpi-total-pallets').innerText = stats.total; document.getElementById('kpi-fg-count').innerText = stats.fg; document.getElementById('kpi-return-count').innerText = stats.ret; document.getElementById('kpi-virtual-count').innerText = stats.virt; updateChart(stats.chart); }
                renderAllMaps();
            });
            onSnapshot(collection(db, "shippingOrders"), (snapshot) => {
                currentOrders = []; snapshot.forEach(d => currentOrders.push(d.data())); renderShippingList();
            });
        }
        let myChart = null;
        function updateChart(data) {
            const ctx = document.getElementById('stockChart'); if(!ctx) return;
            if(myChart) { myChart.data.datasets[0].data = [data.raw, data.fg, data.wip]; myChart.update(); }
            else { myChart = new Chart(ctx, { type: 'doughnut', data: { labels: ['åŸæ–™', 'æˆå“', 'åŠæˆå“'], datasets: [{ data: [data.raw, data.fg, data.wip], backgroundColor: ['#10b981', '#a855f7', '#facc15'], borderWidth: 0 }] }, options: { responsive: true, plugins: { legend: { position: 'right', labels: { color: 'white' } } } } }); }
        }
        window.currentInventory = () => currentInventory; window.currentOrders = () => currentOrders;
    </script>

    <script>
        function switchTab(viewId) {
            document.querySelectorAll('.view-panel').forEach(el => el.classList.add('hidden'));
            document.getElementById('view-' + viewId).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');
            document.getElementById('page-title').innerText = event.currentTarget.innerText;
            if(viewId === 'visual-map') { renderAllMaps(); window.currentViewingLane = null; }
        }
        function renderAllMaps() { 
            renderMapUI('grid-I-A'); renderMapUI('grid-I-B'); renderMapUI('grid-J-C'); renderMapUI('grid-J-D'); 
            renderMapUI('grid-I-A-map'); renderMapUI('grid-I-B-map'); renderMapUI('grid-J-C-map'); renderMapUI('grid-J-D-map'); 
            if(window.currentViewingLane) showLaneDetail(window.currentViewingLane.zone, window.currentViewingLane.row); 
        }

        const mapConfig = { 'grid-I-A':8, 'grid-I-B':8, 'grid-J-C':8, 'grid-J-D':8, 'grid-I-A-map':8, 'grid-I-B-map':8, 'grid-J-C-map':8, 'grid-J-D-map':8 };
        let lockedLane = null;
        const LANE_CAPACITY = 4;

        function renderMapUI(gridId) {
            const container = document.getElementById(gridId); if(!container) return; container.innerHTML = '';
            const parts = gridId.replace('grid-', '').replace('-map', '').split('-'); const zoneKey = `${parts[0]}-${parts[1]}`;
            const inventory = window.currentInventory ? window.currentInventory() : [];
            const laneStatus = {};
            inventory.forEach(item => { if(item.locationId.startsWith('V-')) return; const p = item.locationId.split('-'); if(p.length >= 3 && `${p[0]}-${p[1]}` === zoneKey) { const lane = parseInt(p[2]); if(!laneStatus[lane]) laneStatus[lane] = { count: 0, products: new Set() }; laneStatus[lane].count++; laneStatus[lane].products.add(item.productName); } });
            
            for(let i=1; i<=8; i++) {
                const status = laneStatus[i] || { count: 0 };
                const fillPercent = Math.min((status.count / LANE_CAPACITY) * 100, 100);
                let cls = '';
                if (status.count >= LANE_CAPACITY) cls += ' lane-full-locked'; 
                if (lockedLane && lockedLane.zone === zoneKey && lockedLane.row === i) cls += ' border-yellow-400 shadow-[0_0_10px_rgba(250,204,21,0.5)] z-20';
                const targetName = document.getElementById('in-name') ? document.getElementById('in-name').value : '';
                if(targetName && status.products && status.products.has(targetName) && fillPercent < 100) cls += ' lane-suggest-gold';
                
                const div = document.createElement('div'); div.className = `rack-lane ${cls}`; div.innerHTML = `<span class="absolute top-1 left-1 text-[10px] text-slate-400 font-mono">${i}</span><div class="lane-fill-bar" style="height:${fillPercent}%; background:${fillPercent>=100?'#ef4444':'#3b82f6'}"></div>${cls.includes('gold')?'<i class="fa-solid fa-star text-yellow-400 absolute top-1/2 left-1/2 -translate-x-1/2"></i>':''}`;
                
                const isInbound = !document.getElementById('view-unified-inbound').classList.contains('hidden');
                if(isInbound) {
                    div.onclick = () => { if(status.count >= LANE_CAPACITY) { alert("ğŸ›‘ å„²ä½å·²æ»¿ (4/4)ï¼"); return; } openLevelSelector(zoneKey, i); };
                } else { 
                    div.onmouseenter = () => { if(!lockedLane) showLaneDetail(zoneKey, i); }; 
                    div.onclick = () => { if(lockedLane && lockedLane.zone === zoneKey && lockedLane.row === i) { lockedLane = null; div.classList.remove('locked'); } else { lockedLane = {zone: zoneKey, row: i}; showLaneDetail(zoneKey, i); renderAllMaps(); } }; 
                }
                container.appendChild(div);
            }
        }

        window.currentViewingLane = null;
        function showLaneDetail(zone, row) {
            window.currentViewingLane = { zone, row };
            const inventory = window.currentInventory(); const lanePrefix = `${zone}-${row < 10 ? '0'+row : row}`; const items = inventory.filter(d => d.locationId.startsWith(lanePrefix));
            const levels = { '3F': [], '2F': [], '1F': [] }; items.forEach(d => { const layer = d.locationId.split('-').pop(); if(levels[layer]) levels[layer].push(d); });
            const cap3F = 4 - levels['3F'].length; const cap2F = 4 - levels['2F'].length;
            const panel = document.getElementById('detail-panel'); if(!panel) return;
            
            // V28 Fix: Layout & Font Size
            panel.innerHTML = `
                <div class="p-3 border-b border-slate-700 bg-slate-800/50 flex justify-between items-center"><h3 class="text-sm font-bold text-white">${zone} ç¬¬ ${row} è¡Œ</h3><div class="flex gap-2"><span class="badge ${cap2F+cap3F > 0 ? 'badge-green' : 'badge-red'}">ç©ºä½: ${Math.max(0, 8-(levels['2F'].length+levels['3F'].length))}</span><button onclick="clearLane('${zone}', ${row})" class="text-[9px] bg-red-900/50 text-red-300 px-2 rounded border border-red-800">æ¸…ç©º</button></div></div>
                <div class="p-2 border-b border-slate-700 overflow-y-auto" style="height: 180px;">${renderVisualLevel('3F', levels['3F'], 4)}${renderVisualLevel('2F', levels['2F'], 4)}${renderVisualLevel('1F', levels['1F'], 99, true)}</div>
                <div class="flex-1 flex flex-col min-h-0 bg-slate-900 p-2"><div class="text-[11px] text-slate-400 font-bold mb-1">åº«å­˜è©³æƒ…</div><div class="flex-1 overflow-auto"><table class="w-full dense-table text-left"><thead><tr><th>å±¤</th><th>å“å</th><th>è¦æ ¼</th><th>æ‰¹è™Ÿ</th><th class="text-right">é‡</th></tr></thead><tbody>${items.length === 0 ? `<div class="col-span-5 text-center text-slate-500 py-4">ç„¡åº«å­˜</div>` : ''}${items.map(d => `<tr class="hover:bg-slate-800 transition"><td class="font-bold text-slate-500">${d.locationId.split('-').pop()}</td><td class="text-white">${d.productName}</td><td class="text-yellow-400">${d.spec||'-'}</td><td class="font-mono text-xs text-slate-400">${d.batchNo}</td><td class="text-right font-bold text-slate-300">${d.quantity}</td></tr>`).join('')}</tbody></table></div></div>`;
        }
        function renderVisualLevel(layer, items, cap, isHigh) {
            let boxes = ''; items.forEach(item => { let bg = 'bg-raw'; if(item.category==='FG') bg='bg-fg'; if(item.category==='WIP') bg='bg-wip'; boxes += `<div class="pallet-box ${bg} ${isHigh?'loose':''}" title="${item.productName} ${item.spec}"><div class="truncate px-1 w-full">${item.productName}</div><div>${item.quantity}</div></div>`; });
            if(!isHigh) for(let i=0; i<(cap-items.length); i++) boxes += `<div class="pallet-box pallet-empty"></div>`;
            return `<div class="level-card"><div class="level-header"><span class="${isHigh?'text-yellow-500':'text-slate-300'}">${layer}</span><span>${items.length}/${isHigh?'âˆ':cap}</span></div><div class="level-track ${isHigh?'flex-wrap h-auto':''}">${boxes}</div></div>`;
        }

        let currentLane = null;
        function openLevelSelector(zone, row) { currentLane = { zone, row }; document.getElementById('modal-lane-title').innerText = `${zone} ç¬¬ ${row} è¡Œ`; document.getElementById('loc-select-physical').classList.remove('hidden'); document.getElementById('loc-select-virtual').classList.add('hidden'); document.getElementById('modal-level-select').classList.remove('hidden'); }
        function closeLocModal() { document.getElementById('modal-level-select').classList.add('hidden'); }
        function selectLevel(level) { if(!currentLane) return; const rowStr = currentLane.row < 10 ? '0'+currentLane.row : currentLane.row; document.getElementById('in-loc').value = `${currentLane.zone}-${rowStr}-${level}`; closeLocModal(); }

        const virtualLocations = [{id:'V-SALES',name:'æ¥­å‹™ä¿ç•™'},{id:'V-TEMP',name:'è‡¨æ™‚æš«å­˜'},{id:'V-QC',name:'å“ç®¡ç•™ç½®'}];
        function openVirtualSelector() { document.getElementById('virtual-grid').innerHTML = virtualLocations.map(v=>`<div class="virtual-card" onclick="selectVirtualLoc('${v.id}')"><div class="font-bold text-white text-sm">${v.name}</div><div class="text-[10px] text-slate-400 mt-1">${v.id}</div></div>`).join(''); document.getElementById('loc-select-physical').classList.add('hidden'); document.getElementById('loc-select-virtual').classList.remove('hidden'); document.getElementById('modal-level-select').classList.remove('hidden'); }
        function addNewVirtualLoc() { const name = document.getElementById('new-virtual-name').value; if(name) { virtualLocations.push({id:`V-CUSTOM-${Date.now().toString().slice(-4)}`, name}); openVirtualSelector(); } }
        function selectVirtualLoc(id) { document.getElementById('in-loc').value = id; closeLocModal(); }
        function setCategory(cat) { 
            document.querySelectorAll('.border-emerald-600, .border-slate-600').forEach(el => { if(el.id.startsWith('cat-')) el.className = "border border-slate-600 text-slate-400 text-center rounded text-[10px] py-1"; });
            const activeEl = document.getElementById('cat-'+cat);
            if(cat==='Raw') activeEl.className = "border border-emerald-600 bg-emerald-900/30 text-emerald-400 text-center rounded text-[10px] py-1 font-bold";
            if(cat==='FG') activeEl.className = "border border-purple-600 bg-purple-900/30 text-purple-400 text-center rounded text-[10px] py-1 font-bold";
            if(cat==='WIP') activeEl.className = "border border-yellow-600 bg-yellow-900/30 text-yellow-400 text-center rounded text-[10px] py-1 font-bold";
            document.getElementById('in-category').value = cat; 
        }

        function focusNext(e, nextId) { if(e.key === 'Enter') { if(nextId==='confirm-btn') confirmUnifiedInbound(); else document.getElementById(nextId).focus(); } }
        
        async function batchGenerate() {
            const count = prompt("æ‰¹é‡ç”¢ç”Ÿå¹¾æ¿ï¼Ÿ", "10"); if(!count) return;
            const name = document.getElementById('in-name').value;
            if(!name) { alert("è«‹å…ˆå¡«å¯«å“å"); return; }
            const batch = window.writeBatch(window.db);
            const now = new Date();
            for(let i=0; i<parseInt(count); i++) {
                const ref = window.doc(window.collection(window.db, "pallets"));
                batch.set(ref, { palletId: "INT-"+now.getTime()+"-"+i, productName: name, spec: document.getElementById('in-spec').value, batchNo: document.getElementById('in-batch').value, quantity: parseInt(document.getElementById('in-qty').value), locationId: "TEMP-ZONE", status: "Available", inboundDate: now });
            }
            await batch.commit(); alert("æ‰¹é‡ç”¢ç”ŸæˆåŠŸï¼");
        }

        async function handleUnifiedScan(e) {
            if(e.key === 'Enter') {
                const barcode = e.target.value.trim();
                const mode = document.getElementById('in-category').value;
                if (mode === 'Return') {
                    try {
                        const q = window.query(window.collection(window.db, "pallets"), window.where("palletId", "==", barcode));
                        const snap = await window.getDocs(q);
                        if(!snap.empty) {
                            const data = snap.docs[0].data();
                            document.getElementById('in-parent-id').value = data.palletId;
                            document.getElementById('in-name').value = data.productName + " (é¤˜æ–™)";
                            document.getElementById('in-spec').value = data.spec;
                            document.getElementById('in-batch').value = data.batchNo; document.getElementById('in-batch').readOnly = true;
                            document.getElementById('in-exp').value = data.expiryDate; document.getElementById('in-exp').readOnly = true;
                            document.getElementById('in-barcode').value = "RET-" + Date.now();
                            document.getElementById('in-qty').focus();
                            alert("ğŸ“¦ è®€å–åŸæ–™æˆåŠŸï¼");
                        } else { alert("âŒ æŸ¥ç„¡æ­¤æ¨™ç±¤"); }
                    } catch(err) { console.error(err); }
                } else {
                    try {
                        const snap = await window.getDocs(window.query(window.collection(window.db, "pallets"), window.where("palletId", "==", barcode)));
                        if(!snap.empty) {
                            const data = snap.docs[0].data();
                            document.getElementById('in-name').value = data.productName;
                            document.getElementById('in-spec').value = data.spec||"";
                            document.getElementById('in-batch').value = data.batchNo;
                            document.getElementById('in-qty').value = data.quantity;
                            document.getElementById('in-exp').value = data.expiryDate;
                            alert("ğŸ“¦ æƒæåˆ°èˆŠè²¨ï¼");
                        } else { document.getElementById('in-name').focus(); if(!document.getElementById('in-batch').value) document.getElementById('in-batch').value = "B"+new Date().toISOString().slice(0,10).replace(/-/g,""); }
                        renderMapUI('grid-I-A-map'); 
                    } catch(err) { console.error(err); }
                }
            }
        }
        
        function generateInternalBarcode() { document.getElementById('in-barcode').value = "INT-"+Date.now(); document.getElementById('in-name').focus(); }
        
        async function confirmUnifiedInbound() {
             const loc = document.getElementById('in-loc').value;
             if(!loc) { alert("âŒ è«‹å…ˆé¸å„²ä½"); return; }
             try {
                await window.addDoc(window.collection(window.db, "pallets"), {
                    palletId: document.getElementById('in-barcode').value,
                    productName: document.getElementById('in-name').value,
                    spec: document.getElementById('in-spec').value,
                    batchNo: document.getElementById('in-batch').value,
                    expiryDate: document.getElementById('in-exp').value,
                    quantity: parseInt(document.getElementById('in-qty').value),
                    locationId: loc,
                    category: document.getElementById('in-category').value,
                    inboundDate: new Date(), status: "Available",
                    workOrder: document.getElementById('in-wo').value || '',
                    totalWeight: parseFloat(document.getElementById('in-weight').value) || 0,
                    source: document.getElementById('in-parent-id').value ? 'Factory_Return' : 'Inbound'
                });
                alert("âœ… å…¥åº«æˆåŠŸï¼");
                if(!document.getElementById('lock-mode').checked) { document.getElementById('in-barcode').value = ''; document.getElementById('in-loc').value = ''; }
             } catch(e) { alert("éŒ¯èª¤: "+e.message); }
        }

        function setInboundMode(mode) {
            document.querySelectorAll('.mode-btn').forEach(el => el.className = "mode-btn");
            const activeBtn = document.getElementById('btn-mode-' + mode.toLowerCase());
            let colorTheme = '';
            if(mode === 'Raw') { activeBtn.className = "mode-btn active-raw"; colorTheme = 'border-emerald-500'; }
            if(mode === 'FG') { activeBtn.className = "mode-btn active-fg"; colorTheme = 'border-purple-500'; }
            if(mode === 'WIP') { activeBtn.className = "mode-btn active-wip"; colorTheme = 'border-yellow-500'; }
            if(mode === 'Return') { activeBtn.className = "mode-btn active-ret"; colorTheme = 'border-orange-500'; }
            document.getElementById('in-category').value = mode;
            document.getElementById('scan-panel').className = `glass-panel p-4 mb-4 border-2 ${colorTheme}`;
            document.getElementById('field-wo').classList.toggle('hidden', mode === 'Raw' || mode === 'Return'); 
            document.getElementById('field-weight').classList.toggle('hidden', mode !== 'WIP'); 
            document.getElementById('field-parent-info').classList.toggle('hidden', mode !== 'Return'); 
            document.getElementById('btn-auto-code').classList.toggle('hidden', mode === 'Return'); 
            const qtyLbl = document.getElementById('lbl-qty'); if(mode === 'WIP') qtyLbl.innerText = "ç±ƒæ•¸/ä»¶æ•¸"; else qtyLbl.innerText = "æ•¸é‡ (ç®±)";
            if(mode === 'Return') { document.getElementById('step1-label').innerText = "STEP 1. æƒæèˆŠæ¨™ç±¤"; document.getElementById('in-barcode').placeholder = "æƒæåŸæ–™æ¨™ç±¤ä»¥ç¹¼æ‰¿..."; } else { document.getElementById('step1-label').innerText = "STEP 1. è­˜åˆ¥è²¨ç‰©"; document.getElementById('in-barcode').placeholder = "æƒææ¢ç¢¼..."; }
            const btn = document.getElementById('btn-submit'); btn.className = `w-full mt-4 py-3 text-white rounded font-bold shadow-lg transition ${mode==='Raw'?'bg-emerald-600':mode==='FG'?'bg-purple-600':mode==='WIP'?'bg-yellow-600':'bg-orange-600'}`;
        }

        // V12 è¨‚å–®åŒ¯å…¥
        function handleExcelImport(e) { const file = e.target.files[0]; const reader = new FileReader(); reader.onload = function(evt) { const wb = XLSX.read(evt.target.result, {type:'array'}); const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]); processOrders(json); }; reader.readAsArrayBuffer(file); e.target.value = ''; }
        async function processOrders(json) { const batch = window.writeBatch(window.db); const orders = {}; json.forEach(row => { const oid = row['å–®è™Ÿ']||row['OrderNo']; if(!oid) return; if(!orders[oid]) orders[oid] = { orderId:oid, customer:row['å®¢æˆ¶']||'Unknown', carrier:row['ç‰©æµ']||'è‡ªå–', status:'Pending', items:[] }; orders[oid].items.push({ productId:row['å“è™Ÿ'], productName:row['å“å'], qty:row['æ•¸é‡'], spec:row['è¦æ ¼']||'' }); }); Object.values(orders).forEach(o => batch.set(window.doc(window.db, "shippingOrders", o.orderId), o)); await batch.commit(); alert("è¨‚å–®åŒ¯å…¥æˆåŠŸï¼"); }
        function renderShippingList() { const tbody = document.getElementById('shipping-list-body'); const filter = document.getElementById('filter-carrier').value; const carriers = new Set(); tbody.innerHTML = ''; window.currentOrders().forEach(o => { carriers.add(o.carrier); if(filter !== 'ALL' && o.carrier !== filter) return; let badge = 'bg-slate-700 text-slate-300'; if(o.carrier.includes('é»‘è²“')) badge = 'bg-black text-white border border-slate-600'; tbody.innerHTML += `<tr class="border-b border-slate-700 hover:bg-slate-800"><td class="p-3"><span class="px-2 py-1 rounded text-[10px] ${badge}">${o.carrier}</span></td><td class="font-mono text-white p-3 font-bold">${o.orderId}</td><td class="p-3">${o.customer}</td><td class="p-3 text-slate-400 text-xs">${o.items.map(i=>i.productName+'('+i.spec+')').join(', ').substring(0,30)}...</td><td class="p-3"><span class="badge ${o.status==='Shipped'?'badge-green':'badge-blue'}">${o.status}</span></td><td class="p-3 text-right"><button class="text-slate-400 hover:text-white"><i class="fa-solid fa-box-open"></i></button></td></tr>`; }); const select = document.getElementById('filter-carrier'); if(select.options.length <= 1) carriers.forEach(c => { const opt = document.createElement('option'); opt.value = c; opt.innerText = c; select.appendChild(opt); }); }
        function filterShippingList() { renderShippingList(); }
        function handleStockImport(e) { const file = e.target.files[0]; const reader = new FileReader(); reader.onload = function(evt) { const wb = XLSX.read(evt.target.result, {type:'array'}); const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]); if(confirm(`åŒ¯å…¥ ${json.length} ç­†ï¼Ÿ`)) { const batch = window.writeBatch(window.db); json.forEach((r,i) => { const ref = window.doc(window.collection(window.db, "pallets")); batch.set(ref, { palletId:r['æ¢ç¢¼']||`OLD-${i}`, productName:r['å“å'], spec:r['è¦æ ¼']||'', quantity:r['æ•¸é‡'], locationId:"INIT-STAGE", status:"Available", inboundDate:new Date(), source:"Opening" }); }); batch.commit().then(() => alert("é–‹å¸³æˆåŠŸ")); } }; reader.readAsArrayBuffer(file); e.target.value = ''; }
        function handlePreInboundImport(e) { const file = e.target.files[0]; const reader = new FileReader(); reader.onload = function(evt) { const wb = XLSX.read(evt.target.result, {type:'array'}); const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]); if(confirm(`åŒ¯å…¥ ${json.length} ç­†ï¼Ÿ`)) { const batch = window.writeBatch(window.db); json.forEach((r,i) => { const pid = `PRE-${Date.now()}-${i}`; batch.set(window.doc(window.collection(window.db, "pallets"), pid), { palletId:pid, productName:r['å“å'], spec:r['è¦æ ¼']||'', batchNo:r['æ‰¹è™Ÿ']||'', quantity:r['æ•¸é‡'], locationId:"VIRTUAL-DOCK", status:"Planned", inboundDate:new Date() }); }); batch.commit().then(() => alert("åŒ¯å…¥æˆåŠŸ")); } }; reader.readAsArrayBuffer(file); }
        function generatePlan() { 
            const count = document.getElementById('pre-count').value; const name = document.getElementById('pre-name').value; const spec = document.getElementById('pre-spec').value; const batch = document.getElementById('pre-batch').value;
            const area = document.getElementById('preview-area'); area.innerHTML = '';
            document.getElementById('btn-print').disabled = false; document.getElementById('btn-print').classList.remove('cursor-not-allowed', 'bg-slate-700'); document.getElementById('btn-print').classList.add('bg-blue-600', 'text-white');
            for(let i=1; i<=count; i++) { const code = `PRE-${batch}-${i}`; area.innerHTML += `<div class="bg-white p-3 rounded text-black text-xs border border-slate-300"><div class="font-bold text-sm">${name}</div><div>è¦æ ¼: ${spec}</div><div>æ‰¹è™Ÿ: ${batch}</div><svg id="bc-${i}" class="w-full h-10 mt-1"></svg></div>`; setTimeout(() => JsBarcode(`#bc-${i}`, code, {format:"CODE128", height:30, displayValue:true}), 100); }
        }
        function printLabels() { window.print(); }
        
        window.deletePallet = async function(id) { if(confirm("ç¢ºå®šåˆªé™¤æ­¤åº«å­˜ï¼Ÿ")) await window.deleteDoc(window.doc(window.db, "pallets", id)); }
        window.clearLane = async function(zone, row) { if(!confirm(`âš ï¸ è­¦å‘Šï¼šç¢ºå®šæ¸…ç©º [${zone} ç¬¬ ${row} è¡Œ]ï¼Ÿ`)) return; const q = window.query(window.collection(window.db, "pallets"), window.where("locationId", ">=", `${zone}-${row < 10 ? '0'+row : row}`), window.where("locationId", "<=", `${zone}-${row < 10 ? '0'+row : row}\uf8ff`)); const snap = await window.getDocs(q); const batch = window.writeBatch(window.db); snap.forEach(doc => batch.delete(doc.ref)); await batch.commit(); alert("å··é“å·²æ¸…ç©º"); }

        // V23 è¬ç”¨æœå°‹ & ç¯„æœ¬
        function filterInventory() {
            const term = document.getElementById('global-search').value.toLowerCase();
            document.querySelectorAll('#inventory-list-body tr').forEach(row => { row.style.display = row.innerText.toLowerCase().includes(term) ? '' : 'none'; });
        }
        function downloadTemplate(type) {
            let data = [];
            if(type==='stock') data = [{å“å:'é­·é­š', æ•¸é‡:50, è¦æ ¼:'300/400', æ‰¹è™Ÿ:'B123', æœ‰æ•ˆæ—¥æœŸ:'2025-12-01'}];
            if(type==='pre') data = [{å“å:'é®­é­š', æ•¸é‡:20, è¦æ ¼:'åˆ‡ç‰‡', æ‰¹è™Ÿ:'B456', æœ‰æ•ˆæ—¥æœŸ:'2025-11-01', é è¨ˆæ¿æ•¸:5, æ¯æ¿æ•¸é‡:50}];
            if(type==='order') data = [{å–®è™Ÿ:'DO-001', å®¢æˆ¶:'æµ·éœ¸ç‹', ç‰©æµ:'é»‘è²“', å“å:'é­·é­š', è¦æ ¼:'300/400', æ•¸é‡:10}];
            const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Template"); XLSX.writeFile(wb, `${type}_template.xlsx`);
        }

        switchTab('dashboard');
    </script>
</body>
</html>